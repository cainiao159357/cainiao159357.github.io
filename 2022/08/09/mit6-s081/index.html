<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="å‰è¨€åœ¨å­¦ä¹ äº†ä¸€æ®µæ—¶é—´çš„kernelpwnåï¼Œå‘ç°è‡ªå·±å¯¹äºæ“ä½œç³»ç»Ÿç†è§£çš„è¿˜æ˜¯ååˆ†æµ…è–„ï¼Œé‚æƒ³æµ…æµ…æ·±å…¥å­¦ä¹ ä¸€ä¸‹ï¼Œç„¶åä»a3å¤§ä½¬å¾—çŸ¥mitçš„æ“ä½œç³»ç»Ÿè¯¾ç¨‹ååˆ†ä¹‹å¥½ä¾¿ä¸‹å®šå†³å¿ƒè·Ÿç€è¿‡ä¸€éï¼Œæœ¬æ¥æ˜¯æƒ³å­¦ä¹ mit6.828çš„ï¼Œä½†ä¸ç®¡æ•™æè¿˜æ˜¯è§†é¢‘å…¨æ˜¯æ´‹æ–‡ï¼Œè€Œæˆ‘çš„æ´‹æ–‡èƒ½åŠ›ç€å®æœ‰é™ï¼Œå¹¸å¥½æˆ‘æ‰¾è§äº†mit6.s081ç‰ˆï¼Œä¹Ÿåœ¨ç½‘ä¸Šæ‰¾è§äº†ç¿»è¯‘ç‰ˆï¼Œè¿˜æœ‰è¯¸å¤šåšå®¢å¯ä»¥ç­”ç–‘ï¼Œæ„Ÿè§‰å¯è¡Œï¼Œé‚£å°±å¼€å¹²ï¼ å‡†å¤‡gitè¯¾ç¨‹ä½¿ç”¨çš„æ˜¯gitè¿›è¡Œä»£ç ç®¡ç†å’Œ">
<meta property="og:type" content="article">
<meta property="og:title" content="mit6.s081">
<meta property="og:url" content="http://example.com/2022/08/09/mit6-s081/index.html">
<meta property="og:site_name" content="study">
<meta property="og:description" content="å‰è¨€åœ¨å­¦ä¹ äº†ä¸€æ®µæ—¶é—´çš„kernelpwnåï¼Œå‘ç°è‡ªå·±å¯¹äºæ“ä½œç³»ç»Ÿç†è§£çš„è¿˜æ˜¯ååˆ†æµ…è–„ï¼Œé‚æƒ³æµ…æµ…æ·±å…¥å­¦ä¹ ä¸€ä¸‹ï¼Œç„¶åä»a3å¤§ä½¬å¾—çŸ¥mitçš„æ“ä½œç³»ç»Ÿè¯¾ç¨‹ååˆ†ä¹‹å¥½ä¾¿ä¸‹å®šå†³å¿ƒè·Ÿç€è¿‡ä¸€éï¼Œæœ¬æ¥æ˜¯æƒ³å­¦ä¹ mit6.828çš„ï¼Œä½†ä¸ç®¡æ•™æè¿˜æ˜¯è§†é¢‘å…¨æ˜¯æ´‹æ–‡ï¼Œè€Œæˆ‘çš„æ´‹æ–‡èƒ½åŠ›ç€å®æœ‰é™ï¼Œå¹¸å¥½æˆ‘æ‰¾è§äº†mit6.s081ç‰ˆï¼Œä¹Ÿåœ¨ç½‘ä¸Šæ‰¾è§äº†ç¿»è¯‘ç‰ˆï¼Œè¿˜æœ‰è¯¸å¤šåšå®¢å¯ä»¥ç­”ç–‘ï¼Œæ„Ÿè§‰å¯è¡Œï¼Œé‚£å°±å¼€å¹²ï¼ å‡†å¤‡gitè¯¾ç¨‹ä½¿ç”¨çš„æ˜¯gitè¿›è¡Œä»£ç ç®¡ç†å’Œ">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="c:/Users/å¼ é¹/AppData/Roaming/Typora/typora-user-images/image-20220806173357404.png">
<meta property="og:image" content="c:/Users/å¼ é¹/AppData/Roaming/Typora/typora-user-images/image-20220807185230278.png">
<meta property="og:image" content="http://xv6.dgs.zone/tranlate_books/book-riscv-rev1/images/c2/p2.png">
<meta property="article:published_time" content="2022-08-09T14:58:21.000Z">
<meta property="article:modified_time" content="2022-08-12T05:49:59.502Z">
<meta property="article:author" content="rootzhang">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="c:/Users/å¼ é¹/AppData/Roaming/Typora/typora-user-images/image-20220806173357404.png">

<link rel="canonical" href="http://example.com/2022/08/09/mit6-s081/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>mit6.s081 | study</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">study</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/09/mit6-s081/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          mit6.s081
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-08-09 22:58:21" itemprop="dateCreated datePublished" datetime="2022-08-09T22:58:21+08:00">2022-08-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-08-12 13:49:59" itemprop="dateModified" datetime="2022-08-12T13:49:59+08:00">2022-08-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨å­¦ä¹ äº†ä¸€æ®µæ—¶é—´çš„kernelpwnåï¼Œå‘ç°è‡ªå·±å¯¹äºæ“ä½œç³»ç»Ÿç†è§£çš„è¿˜æ˜¯ååˆ†æµ…è–„ï¼Œé‚æƒ³æµ…æµ…æ·±å…¥å­¦ä¹ ä¸€ä¸‹ï¼Œç„¶åä»a3å¤§ä½¬å¾—çŸ¥mitçš„æ“ä½œç³»ç»Ÿè¯¾ç¨‹ååˆ†ä¹‹å¥½ä¾¿ä¸‹å®šå†³å¿ƒè·Ÿç€è¿‡ä¸€éï¼Œæœ¬æ¥æ˜¯æƒ³å­¦ä¹ mit6.828çš„ï¼Œä½†ä¸ç®¡æ•™æè¿˜æ˜¯è§†é¢‘å…¨æ˜¯æ´‹æ–‡ï¼Œè€Œæˆ‘çš„æ´‹æ–‡èƒ½åŠ›ç€å®æœ‰é™ï¼Œå¹¸å¥½æˆ‘æ‰¾è§äº†mit6.s081ç‰ˆï¼Œä¹Ÿåœ¨ç½‘ä¸Šæ‰¾è§äº†ç¿»è¯‘ç‰ˆï¼Œè¿˜æœ‰è¯¸å¤šåšå®¢å¯ä»¥ç­”ç–‘ï¼Œæ„Ÿè§‰å¯è¡Œï¼Œé‚£å°±å¼€å¹²ï¼</p>
<h2 id="å‡†å¤‡"><a href="#å‡†å¤‡" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h2><h3 id="git"><a href="#git" class="headerlink" title="git"></a>git</h3><p>è¯¾ç¨‹ä½¿ç”¨çš„æ˜¯gitè¿›è¡Œä»£ç ç®¡ç†å’Œç‰ˆæœ¬æ§åˆ¶çš„ï¼Œå¯ç¬‘æˆ‘åˆ°ç›®å‰ä¸ºæ­¢åªç†Ÿæ‚‰<code>git close</code>,æ‰€ä»¥å†å¼€å§‹ä¹‹å‰å¾—äº†è§£ä¸€ä¸‹gitçš„å‘½ä»¤ã€‚</p>
<p>çœ‹äº†å‡ ä¸ªå°æ—¶ï¼Œå¤§æ¦‚èƒ½ä½¿ç”¨äº†ã€‚</p>
<h3 id="RSIC-VæŒ‡ä»¤é›†"><a href="#RSIC-VæŒ‡ä»¤é›†" class="headerlink" title="RSIC-VæŒ‡ä»¤é›†"></a>RSIC-VæŒ‡ä»¤é›†</h3><p>â€¦â€¦æ­¤å¤„çœç•¥å¥½å¤šå­—</p>
<h3 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h3><p>æˆ‘ä½¿ç”¨çš„æ˜¯æœ€æ–°çš„ubuntu22,å…¶å®å®Œå…¨ä¸ç”¨æœä»€ä¹ˆæ­å»ºç¯å¢ƒæ•™ç¨‹çš„ï¼Œè¯¾ç¨‹çš„ç½‘é¡µå·²ç»éå¸¸æ¸…æ¥šäº†ï¼ˆä»–æ¨èçš„æ˜¯ubuntu20.4ï¼‰ï¼ŒæŒ‰ç…§å®ƒæ‰€è¿°ä¸€æ­¥ä¸€æ­¥æ¥å°±å¥½äº†ï¼Œå¯æƒœæˆ‘æ„è¯†åˆ°è¿™ä¸€ç‚¹çš„æ—¶å€™å·²ç»æµªè´¹äº†ä¸€ä¸¤ä¸ªå°æ—¶äº†</p>
<p>å‡†å¤‡å®Œç¯å¢ƒæœ€æ¿€åŠ¨äººå¿ƒçš„å°±æ˜¯å®éªŒè°ƒè¯•ç¯å¢ƒè§£äº†ï¼Œè°ƒè¯•æˆ‘å‚è€ƒçš„æ˜¯è¿™ç¯‡æ–‡ç« <a target="_blank" rel="noopener" href="https://xistor.github.io/post/6.s081/xv6-gdb/">qemu xv6 ä½¿ç”¨GDBè°ƒè¯• - xistorâ€™s notes</a></p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220806173357404.png" alt="image-20220806173357404"></p>
<p>æˆ‘åœ¨lsä¸Šä¸‹äº†æ–­ç‚¹ï¼Œå¯è§æˆåŠŸæˆªä½äº†ã€‚</p>
<p>ä»è¿™ç¯‡æ–‡ç« ä¸­äº†è§£åˆ°äº†å…³äº<del>/.gdbinitæ–‡ä»¶çš„ä½¿ç”¨ï¼Œå¯ä»¥å‘è¿™ä¸ªæ–‡ä»¶ä¸­å†™å…¥gdbå‘½ä»¤ï¼Œå½“gdbæ‰§è¡Œçš„æ—¶å€™ä¼šåœ¨å½“å‰ç”¨æˆ·çš„ä¸»ç›®å½•ä¸‹å¯»æ‰¾<code>.gdbinit</code>æ–‡ä»¶ç„¶åæ‰§è¡Œå…¶ä¸­çš„å‘½ä»¤ï¼Œå½“ä½ æƒ³è¦gdbæ‰§è¡Œä¸åœ¨å½“å‰ç”¨æˆ·çš„ä¸»ç›®å½•ä¸‹çš„<code>.gdbinit</code>çš„æ—¶å€™ï¼Œå¯ä»¥åœ¨`</del>/.gdbinit<code>æ–‡ä»¶ä¸­å¯¼å…¥ï¼Œä¾‹å¦‚</code>add-auto-load-safe-path /home/x/xv6-labs-2021/.gdbinit<code>,è¿™æ ·åšçš„è¯è°ƒè¯•çš„æ—¶å€™å°±éå¸¸æ–¹ä¾¿äº†ï¼Œåªéœ€è¦é”®å…¥</code>gdb-multiarch`å°±å¯ä»¥ç›´æ¥è®¾ç½®æ¶æ„å¹¶è¿æ¥qemuäº†ã€‚</p>
<h2 id="Lecture"><a href="#Lecture" class="headerlink" title="Lecture"></a>Lecture</h2><h4 id="Lecture1"><a href="#Lecture1" class="headerlink" title="Lecture1"></a>Lecture1</h4><p>è®²äº†ä¸€ç‚¹æ“ä½œç³»ç»Ÿå¤§ä½“ä½œç”¨ä»¥åŠç»“æ„ï¼Œç„¶åé€šè¿‡å‡ ä¸ªä¾‹å­ç¤ºèŒƒäº†ç³»ç»Ÿè°ƒç”¨ï¼Œå…¶ä¸­æ¯”è¾ƒæœ‰æ”¶è·çš„æ˜¯fork+execä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨çš„æ­é…å¯ä»¥åœ¨å­è¿›ç¨‹é‡æ–°è½½å…¥ä¸€ä¸ªæ–°ç¨‹åºï¼Œæ‰€ä»¥åŸæ¥çš„å­è¿›ç¨‹è¢«å®Œå…¨å–ä»£ï¼Œä¸€èˆ¬æƒ…å†µä¸‹execå‡½æ•°ä¸ä¼šè¿”å›ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯exec()åçš„ç¨‹åºçš„æ–‡ä»¶æè¿°ç¬¦å¹¶æ²¡æœ‰é‡ç½®ï¼Œè¿˜æ˜¯å’Œæºç¨‹åºä¸€æ ·ï¼Œåˆ©ç”¨è¿™ä¸ªç‰¹æ€§å¯ä»¥å®Œæˆä¸€äº›éªšæ“ä½œã€‚</p>
<p>æ€»ä½“æ¯”è¾ƒç®€å•ã€‚è¿™èŠ‚è¯¾æœ‰è¯¾åå®éªŒï¼Œæˆ‘çœ‹è¯¾ç¨‹ä»‹ç»å¥½åƒå¯ä»¥åœ¨æœ¬åœ°æµ‹è¯•è‡ªå·±çš„å®éªŒå¹¶æ‰“å‡ºåˆ†æ•°ï¼Œå†è¥¿ï¼Œæ˜å¤©çœ‹çœ‹æ€ä¹ˆæ•´ã€‚</p>
<h4 id="Lecture3"><a href="#Lecture3" class="headerlink" title="Lecture3"></a>Lecture3</h4><p><strong>éš”ç¦»æ€§</strong>ï¼šæ“ä½œç³»ç»Ÿæä¾›è¿›ç¨‹å’Œè¿›ç¨‹ä¹‹é—´çš„å¢™éš”ç¦»ä»¥åŠè¿›ç¨‹å’Œç¡¬ä»¶èµ„æºçš„å¼ºéš”ç¦»ï¼Œéš”ç¦»çš„æ‰‹æ®µæ˜¯è¿›è¡ŒæŠ½è±¡ï¼Œæä¾›ç³»ç»Ÿè°ƒç”¨æ¥å£ã€‚</p>
<p><strong>é˜²å¾¡æ€§</strong>ï¼šé¦–å…ˆå¾—å…·æœ‰é”™è¯¯å¤„ç†èƒ½åŠ›ï¼Œå¦‚æœç”¨æˆ·æ€è¿›ç¨‹ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™ä¼ å…¥äº†é”™è¯¯çš„å‚æ•°ï¼Œå†…æ ¸å¾—å…·æœ‰å¤„ç†è¿™ç§é”™è¯¯çš„èƒ½åŠ›ï¼Œå…¶æ¬¡æ˜¯åº”ç”¨ç¨‹åºä¸èƒ½ç ´åéš”ç¦»æ€§ï¼Œè¿™é‡Œçš„éš”ç¦»æŒ‡è¿›ç¨‹å’Œå†…æ ¸çš„éš”ç¦»ï¼Œæƒ³è¦å®ç°è¿™ç§éš”ç¦»æ€§å¾—éœ€è¦ç¡¬ä»¶æ”¯æŒï¼Œæ¯”å¦‚å†…æ ¸æ¨¡å¼å’Œç”¨æˆ·æ¨¡å¼ä»¥åŠè™šæ‹Ÿå†…å­˜ã€‚</p>
<p><strong>user/kernel</strong>:å½“cpuè¿è¡Œåœ¨kernelæ¨¡å¼ä¸­å°±ä¼šæ‹¥æœ‰æ‰§è¡Œç‰¹æƒæŒ‡ä»¤çš„æƒé™ï¼Œç‰¹æƒæŒ‡ä»¤æŒ‡ç›´æ¥æ“ä½œç¡¬ä»¶çš„æŒ‡ä»¤ï¼Œç›¸å¯¹çš„è¿è¡Œåœ¨useræ¨¡å¼åªèƒ½æ‰§è¡Œéç‰¹æƒæŒ‡ä»¤ï¼Œå½“useræ¨¡å¼ä¸‹æ‰§è¡Œç‰¹æƒæŒ‡ä»¤æ—¶cpuå¹¶ä¸ä¼šçœŸæ­£å»æ‰§è¡Œï¼Œè€Œæ˜¯ä»userè·³åˆ°kernelï¼Œå†…æ ¸è·å¾—cpuæ§åˆ¶æƒï¼Œç„¶åè®©å†…æ ¸åˆ¤æ–­useræ˜¯å¦å‡ºç°äº†é—®é¢˜æ˜¯å¦æ”¹æ€æ­»ã€‚</p>
<p><strong>user-&gt;kernel</strong>:æœ‰ä¸“é—¨çš„çš„ä¸€ä¸ªæŒ‡ä»¤å¯ä»¥ä»useråˆ°kernel,åœ¨x86ä¸‹æ˜¯syscall,åœ¨æœ¬æ¬¡è¯¾ç¨‹ä¸­çš„risc-vä¸­æ˜¯<code>ecall</code>ï¼Œç³»ç»Ÿè°ƒç”¨å·å­˜å‚¨åœ¨<code>a0</code>å¯„å­˜å™¨ä¸­ã€‚</p>
<p><strong>å®å†…æ ¸&amp;å¾®å†…æ ¸</strong>ï¼šç›¸æ¯”èµ·å®å†…æ ¸ï¼Œå¾®å†…æ ¸çš„è¯¸å¤šæœåŠ¡éƒ½è¿è¡Œåœ¨useræ¨¡å¼ï¼Œåœ¨æ™®é€šè¿›ç¨‹æƒ³è¦ä½¿ç”¨è¿™äº›æœåŠ¡çš„æ—¶å€™é€šçŸ¥å†…æ ¸ï¼Œå†…æ ¸å†é€šçŸ¥æœåŠ¡ï¼Œè¿™æ ·ä¼šå¯¼è‡´Userå’Œkernelçš„åˆ‡æ¢æ¯”è¾ƒé¢‘ç¹ã€‚</p>
<h2 id="lab"><a href="#lab" class="headerlink" title="lab"></a>lab</h2><h3 id="Lab1-Xv6-and-Unix-utilities"><a href="#Lab1-Xv6-and-Unix-utilities" class="headerlink" title="Lab1: Xv6 and Unix utilities"></a>Lab1: Xv6 and Unix utilities</h3><p>è¿™ä¸ªå®éªŒä¸»è¦æ˜¯ç†Ÿæ‚‰xv6çš„ç³»ç»Ÿè°ƒç”¨æ¥å£çš„ã€‚</p>
<h4 id="sleep"><a href="#sleep" class="headerlink" title="sleep"></a>sleep</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;user/user.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc!=<span class="number">2</span>)&#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;your parameter is not number\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(atoi(argv[<span class="number">1</span>]));</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="pingpong"><a href="#pingpong" class="headerlink" title="pingpong"></a>pingpong</h4><p>åˆ©ç”¨pipeå®Œæˆçˆ¶å­è¿›ç¨‹ä¹‹é—´åŒå‘é€šä¿¡ï¼Œåˆšå¼€å§‹æ²¡ç†è§£é€pipe,åªç”¨äº†ä¸€ä¸ªç®¡é“ï¼Œå‘ç°æ€ä¹ˆéƒ½ä¸å¯¹ï¼Œçœ‹äº†åˆ«äººçš„ä»£ç æ‰æç„¶å¤§é›¾ï¼Œpipeåªèƒ½å®Œæˆå•å‘é€šä¿¡ï¼ŒåŒå‘è‚¯å®šå¾—è¦ä¸¤ä¸ªç®¡é“å•Š,ä¸è¿‡æˆ‘é”™è¯¯é‚£ä¸€ç‰ˆéª—è¿‡äº†labæ£€æŸ¥ç¨‹åºï¼Œä¹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;user/user.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> rd 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> wt 1</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> p_to_child[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> p_to_parent[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">10</span>];</span><br><span class="line">    pipe(p_to_child);</span><br><span class="line">    pipe(p_to_parent);</span><br><span class="line">    <span class="keyword">int</span> pid=fork();</span><br><span class="line">    <span class="keyword">if</span>(pid&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;fork fail\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(pid==<span class="number">0</span>)&#123;</span><br><span class="line">        close(p_to_child[wt]);</span><br><span class="line">        close(p_to_parent[rd]);</span><br><span class="line">        <span class="keyword">int</span> ret=read(p_to_child[rd],buf,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span>(ret&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;read fail\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="number">1</span>,<span class="string">&quot;%d: received ping\n&quot;</span>,getpid());</span><br><span class="line">        ret=write(p_to_parent[wt],<span class="string">&quot;1&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span>(ret&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;write fail\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        close(p_to_child[rd]);</span><br><span class="line">        close(p_to_parent[wt]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        close(p_to_child[rd]);</span><br><span class="line">        close(p_to_parent[wt]);</span><br><span class="line">        <span class="keyword">int</span> ret=write(p_to_child[wt],<span class="string">&quot;1&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span>(ret&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;write fail\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ret=read(p_to_parent[rd],buf,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span>(ret&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;read fail\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="number">1</span>,<span class="string">&quot;%d: received pong\n&quot;</span>,getpid());</span><br><span class="line">        close(p_to_child[wt]);</span><br><span class="line">        close(p_to_parent[rd]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="primes"><a href="#primes" class="headerlink" title="primes"></a>primes</h4><p>è¿™ä¸ªç¨‹åºè¿˜æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ï¼Œè¦æ±‚åˆ©ç”¨forkå’Œç®¡é“å®Œæˆå¯¹ç´ æ•°çš„ç­›é€‰ï¼Œç†è®ºå¦‚ä¸‹</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220807185230278.png" alt="image-20220807185230278"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;user/user.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> rd 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> wt 1</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fun</span><span class="params">(<span class="keyword">int</span> p_rd,<span class="keyword">int</span> c_wt)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> first_num=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> temp=<span class="number">0</span>;</span><br><span class="line">    read(p_rd,&amp;first_num,<span class="number">4</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="number">1</span>,<span class="string">&quot;prime %d\n&quot;</span>,first_num);</span><br><span class="line">    <span class="keyword">int</span> num;</span><br><span class="line">    <span class="keyword">while</span>(read(p_rd,&amp;num,<span class="number">4</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(num%first_num!=<span class="number">0</span>)&#123;</span><br><span class="line">            temp++;</span><br><span class="line">            write(c_wt,&amp;num,<span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> temp;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> p[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> c[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    pipe(p);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">2</span>;i&lt;=<span class="number">35</span>;i++)&#123;</span><br><span class="line">        write(p[wt],&amp;i,<span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> pid=fork();</span><br><span class="line">        <span class="keyword">if</span>(pid==<span class="number">0</span>)&#123;</span><br><span class="line">            pipe(c);</span><br><span class="line">            close(p[wt]);</span><br><span class="line">            <span class="keyword">int</span> ret=fun(p[rd],c[wt]);</span><br><span class="line">            close(p[rd]);</span><br><span class="line">            <span class="keyword">if</span>(ret==<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            p[rd]=c[rd];</span><br><span class="line">            p[wt]=c[wt];</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(p[wt])&#123;</span><br><span class="line">                close(p[wt]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(p[rd])&#123;</span><br><span class="line">                close(p[rd]);</span><br><span class="line">            &#125;</span><br><span class="line">            wait(&amp;status);</span><br><span class="line">            <span class="keyword">if</span>(status==<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;wait fail\n&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="find"><a href="#find" class="headerlink" title="find"></a>find</h4><p>è¿™ä¸ªè°ƒäº†æˆ‘åŠä¸ªæ—©ä¸ŠğŸ¤¦â€â™€ï¸ï¼Œé¦–å…ˆæ˜¯ç¨‹åºé€€å‡ºæ—¶æŠ¥é”™ï¼Œæˆ‘è¯•äº†åŠå¤©æ‰å‘ç°xv6ç³»ç»Ÿçš„mainå‡½æ•°åªèƒ½ä»¥exit()é€€å‡ºï¼Œå…¶æ¬¡æ˜¯æµ‹è¯•ç¨‹åºè€æ˜¯è¿‡ä¸å»ï¼Œå¤šæ–¹è°ƒè¯•åå‘ç°è‡ªå·±çš„ä¸€å—é€»è¾‘å†™çš„æœ‰æ˜æ˜¾é—®é¢˜ï¼Œå‘œå‘œå‘œè¿™æ˜æ˜åªæ˜¯ä¸­ç­‰éš¾åº¦ï¼Œä»£ç èƒ½åŠ›è¿˜æ˜¯å¤ªèœäº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernel/stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;user/user.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernel/fs.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">find</span><span class="params">(<span class="keyword">char</span> *file_path,<span class="keyword">char</span> *res)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> <span class="title">de</span>;</span></span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="number">0</span>,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">char</span> *p;</span><br><span class="line">    memmove(buf,file_path,<span class="built_in">strlen</span>(file_path));</span><br><span class="line">    <span class="keyword">int</span> fd=open(file_path,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;open fail\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (read(fd,&amp;de,<span class="keyword">sizeof</span>(de))==<span class="keyword">sizeof</span>(de))&#123;</span><br><span class="line">        <span class="keyword">if</span>(de.inum==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(de.name,<span class="string">&quot;.&quot;</span>)||!<span class="built_in">strcmp</span>(de.name,<span class="string">&quot;..&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        p=buf+<span class="built_in">strlen</span>(buf);</span><br><span class="line">        memmove(p, de.name, DIRSIZ);</span><br><span class="line">        <span class="keyword">if</span>(stat(buf,&amp;st)&lt;<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;stat() fail filename :%s\n&quot;</span>,buf);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(st.type==T_FILE)&#123;</span><br><span class="line">            <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(de.name,res))&#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="number">1</span>,<span class="string">&quot;%s\n&quot;</span>,buf);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (st.type==T_DIR)</span><br><span class="line">        &#123;</span><br><span class="line">            p=buf+<span class="built_in">strlen</span>(buf);</span><br><span class="line">            *p=<span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">            find(buf,res);</span><br><span class="line">        &#125;</span><br><span class="line">         <span class="built_in">memset</span>(buf,<span class="number">0</span>,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">         memmove(buf,file_path,<span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line">    <span class="keyword">char</span> *p;</span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="number">0</span>,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">if</span>(argc!=<span class="number">3</span>)&#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;parameter fail\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    memmove(buf,argv[<span class="number">1</span>],DIRSIZ);</span><br><span class="line">    p=buf+<span class="built_in">strlen</span>(buf)<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span>(*p!=<span class="string">&#x27;/&#x27;</span>)&#123;</span><br><span class="line">        p++;</span><br><span class="line">        *p=<span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    find(buf,argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="xargs"><a href="#xargs" class="headerlink" title="xargs"></a>xargs</h4><p>ä¸»è¦éº»çƒ¦çš„ç‚¹åœ¨å¯¹å­—ç¬¦ä¸²çš„å¤„ç†ä¸Šï¼Œæˆ‘çœ‹åˆ«äººçš„åšå®¢åˆ©ç”¨äº†æœ‰é™è‡ªåŠ¨æœºï¼Œå˜¿å˜¿ï¼Œä¸ä¼šè¿™ä¸ªé«˜ç«¯çš„ä¸œè¥¿ï¼Œæˆ‘çš„è§£å†³åŠæ³•æ˜¯å¯¹å¾—åˆ°çš„å­—ç¬¦ä¸²è¿›è¡Œæ ‡å‡†åŒ–ï¼Œç„¶åå°±åˆ©äºåé¢çš„å­—ç¬¦ä¸²å¤„ç†äº†(æ— è„‘åšæ³•å±äº)ã€‚è¿˜æœ‰æˆ‘çš„ä»£ç èƒ½åŠ›çœŸå¾—å¼±ï¼Œè¿™ç‚¹ä»£ç èŠ±äº†æˆ‘ä¸¤ä¸ªå°æ—¶ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernel/stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;user/user.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernel/fs.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_line_length</span><span class="params">(<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> line_length=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(buf[line_length]!=<span class="string">&#x27;\n&#x27;</span>)&#123;</span><br><span class="line">        line_length++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> line_length;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">100</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> cur=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> line_num=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">if</span>(argc&lt;<span class="number">2</span>)&#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;argv fail\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> size=read(<span class="number">0</span>,buf,<span class="number">100</span>);</span><br><span class="line">    <span class="keyword">char</span> parm_buf[size+<span class="number">20</span>];</span><br><span class="line">    <span class="built_in">memset</span>(parm_buf,<span class="number">0</span>,<span class="keyword">sizeof</span>(parm_buf));</span><br><span class="line">    cur++;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;size; i++,cur++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(buf[i]==<span class="string">&#x27; &#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(buf[i]==<span class="string">&#x27;\n&#x27;</span>)&#123;</span><br><span class="line">            cur++;</span><br><span class="line">            parm_buf[cur]=<span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">            line_num++;</span><br><span class="line">            cur++;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        parm_buf[cur]=buf[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(buf[size<span class="number">-1</span>]!=<span class="string">&#x27;\n&#x27;</span>)&#123;</span><br><span class="line">        line_num++;</span><br><span class="line">    &#125;</span><br><span class="line">    cur=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;line_num;i++)&#123;</span><br><span class="line">        <span class="keyword">int</span> add_parm_num=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> temp_cur=cur;</span><br><span class="line">        <span class="keyword">for</span>(;parm_buf[temp_cur]!=<span class="string">&#x27;\n&#x27;</span>;temp_cur++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(parm_buf[temp_cur]==<span class="number">0</span>&amp;&amp;parm_buf[temp_cur+<span class="number">1</span>]!=<span class="number">0</span>&amp;&amp;parm_buf[temp_cur+<span class="number">1</span>]!=<span class="string">&#x27;\n&#x27;</span>)&#123;</span><br><span class="line">                add_parm_num++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">char</span> *parm[add_parm_num+argc];</span><br><span class="line">        <span class="built_in">memset</span>(parm,<span class="number">0</span>,<span class="keyword">sizeof</span>(parm));</span><br><span class="line">        <span class="keyword">int</span> parm_cur=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;argc;j++,parm_cur++)&#123;</span><br><span class="line">            parm[parm_cur]=argv[j];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(;parm_buf[cur]!=<span class="string">&#x27;\n&#x27;</span>;cur++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(parm_buf[cur]==<span class="number">0</span>&amp;&amp;parm_buf[cur+<span class="number">1</span>]!=<span class="number">0</span>&amp;&amp;parm_buf[cur+<span class="number">1</span>]!=<span class="string">&#x27;\n&#x27;</span>)&#123;</span><br><span class="line">                parm[parm_cur]=&amp;parm_buf[cur+<span class="number">1</span>];</span><br><span class="line">                parm_cur++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        cur++;</span><br><span class="line">        <span class="keyword">int</span> pid=fork();</span><br><span class="line">        <span class="keyword">if</span>(pid==<span class="number">0</span>)&#123;</span><br><span class="line">            exec(parm[<span class="number">0</span>],parm);</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;exec fail\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            wait(&amp;status);</span><br><span class="line">            <span class="keyword">if</span>(status==<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot; wait fail\n&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="æœ€ålabå¾—åˆ†"><a href="#æœ€ålabå¾—åˆ†" class="headerlink" title="æœ€ålabå¾—åˆ†"></a>æœ€ålabå¾—åˆ†</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Score: 100/100</span><br></pre></td></tr></table></figure>

<h4 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h4><p>åœ¨xv6æ“ä½œç³»ç»Ÿä¸Šç¼–ç¨‹å¾ˆå¥‡å¦™ä¹Ÿå¾ˆæœ‰æ„æ€ã€‚</p>
<h3 id="Lab2-system-calls"><a href="#Lab2-system-calls" class="headerlink" title="Lab2: system calls"></a>Lab2: system calls</h3><p>è¿™ä¸ªå®éªŒä¸»è¦æ˜¯ä¸ºäº†ç†è§£ç³»ç»Ÿè°ƒç”¨çš„å·¥ä½œæµç¨‹ï¼Œå¹¶ä¸ºxv6å¢åŠ ä¸€äº›æ–°çš„ç³»ç»Ÿè°ƒç”¨ã€‚</p>
<h4 id="book-read"><a href="#book-read" class="headerlink" title="book-read"></a>book-read</h4><p><strong>trap</strong>:æœ‰ä¸‰ç§æ—¶é—´å¯¼è‡´cpuæç½®æ™®é€šæŒ‡ä»¤çš„æ‰§è¡Œï¼Œå¼ºåˆ¶å°†æ§åˆ¶æƒè½¬ç§»ç»™å¤„ç†è¯¥äº‹ä»¶çš„ç‰¹æ®Šä»£ç ä¸Šï¼Œä¸€ç§æƒ…å†µæ˜¯ç³»ç»Ÿè°ƒç”¨ä½¿ç”¨<code>ecall</code>çš„æ—¶å€™ï¼Œä¸€ç§æ˜¯å¼‚å¸¸ï¼Œæ¯”å¦‚user/kernelæŒ‡ä»¤åšäº†ä¸€äº›éæ³•çš„äº‹æƒ…å¦‚é™¤é›¶ï¼Œç¬¬ä¸‰ç§æ˜¯è®¾å¤‡ä¸­æ–­ï¼Œè¿™ä¸‰ç§æƒ…å†µè¢«ç»Ÿç§°ä¸º<code>trap</code>,xv6å†…æ ¸å¤„ç†æ‰€æœ‰çš„trap.</p>
<p><strong>risc-vé™·å…¥æœºåˆ¶</strong>:risc-væ¶æ„çš„cpuéƒ½æœ‰ä¸€ç»„æ§åˆ¶å¯„å­˜å™¨ï¼Œkernelé€šè¿‡å‘è¿™äº›å¯„å­˜å™¨å†™å…¥å†…å®¹æ¥ä½¿cpuå¤„ç†trap</p>
<p>ä¸‹é¢æ˜¯é‡è¦çš„å¯„å­˜å™¨</p>
<blockquote>
<p><code>stvec</code>:å†…æ ¸åœ¨è¿™é‡Œå†™å…¥trapå¤„ç†ç¨‹åºçš„åœ°å€ï¼Œrisc-vè·³è½¬åˆ°è¿™é‡Œå¤„ç†trap</p>
<p><code>sepc</code>:å½“å‘ç”Ÿtrapæ—¶ï¼Œrisc-vä¼šä¿å­˜åŸæ¥<code>pc</code>çš„ä¿¡æ¯åˆ°<code>sepc</code>,<code>sret</code>(ä»é™·é˜±è¿”å›)æŒ‡ä»¤å°±ä¼šå°†<code>sepc</code>å¤åˆ¶åˆ°<code>pc</code>,å†…æ ¸å¯ä»¥å†™å…¥<code>sepc</code>æ¥æ§åˆ¶<code>sret</code>çš„å»å‘ã€‚</p>
<p><code>scause</code>:risc-våœ¨è¿™é‡Œé˜²æ­¢æè¿°trapåŸå› çš„æ•°å­—</p>
<p><code>sscratch</code>:å†…æ ¸åœ¨è¿™é‡Œæ”¾ç½®ä¸€ä¸ªå€¼ï¼Œè¿™ä¸ªå€¼åœ¨trapå¤„ç†ç¨‹åºä¸€å¼€å§‹å°±ä¼šæ´¾ä¸Šç”¨åœºã€‚</p>
<p><code>sstatus</code>:å…¶ä¸­çš„<code>SIE</code>ä½æ§åˆ¶è®¾å¤‡ä¸­æ–­æ˜¯å¦å¯åŠ¨ï¼Œ<code>SPP</code>ä½æŒ‡ç¤ºtrapæ˜¯æ¥è‡ªuser-modeè¿˜æ˜¯kernel-mode,å¹¶æ§åˆ¶<code>sret</code>è¿”å›çš„æ¨¡å¼</p>
</blockquote>
<p>risc-vç¡¬ä»¶å¯¹æ‰€æœ‰trap(é™¤äº†è®¡æ—¶å™¨ä¸­æ–­)æ‰§è¡Œä»¥ä¸‹æ“ä½œ</p>
<blockquote>
<ol>
<li>å¦‚æœé™·é˜±æ˜¯è®¾å¤‡ä¸­æ–­ï¼Œå¹¶ä¸”çŠ¶æ€<strong>SIE</strong>ä½è¢«æ¸…ç©ºï¼Œåˆ™ä¸æ‰§è¡Œä»¥ä¸‹ä»»ä½•æ“ä½œã€‚</li>
<li>æ¸…é™¤<strong>SIE</strong>ä»¥ç¦ç”¨ä¸­æ–­ã€‚</li>
<li>å°†<code>pc</code>å¤åˆ¶åˆ°<code>sepc</code>ã€‚</li>
<li>å°†å½“å‰æ¨¡å¼ï¼ˆç”¨æˆ·æˆ–ç®¡ç†ï¼‰ä¿å­˜åœ¨çŠ¶æ€çš„<strong>SPP</strong>ä½ä¸­ã€‚</li>
<li>è®¾ç½®<code>scause</code>ä»¥åæ˜ äº§ç”Ÿé™·é˜±çš„åŸå› ã€‚</li>
<li>å°†æ¨¡å¼è®¾ç½®ä¸ºç®¡ç†æ¨¡å¼ã€‚</li>
<li>å°†<code>stvec</code>å¤åˆ¶åˆ°<code>pc</code>ã€‚</li>
<li>åœ¨æ–°çš„<code>pc</code>ä¸Šå¼€å§‹æ‰§è¡Œã€‚</li>
</ol>
</blockquote>
<p>å¯è§cpuç¡¬ä»¶åªä¼šæ‰§è¡Œè¿™äº›æ“ä½œï¼Œå½“æ§åˆ¶æƒç»™åˆ°å†…æ ¸çš„æ—¶å€™ï¼Œå¾—è¦å†…æ ¸è‡ªå·±å®Œæˆå¯¹å†…æ ¸é¡µè¡¨çš„åˆ‡æ¢ï¼Œå¯¹å†…æ ¸æ ˆçš„åˆ‡æ¢ï¼Œç„¶åè¿›å…¥å¯¹trapçœŸæ­£å¤„ç†çš„å‡½æ•°ä¸Šï¼Œå¯¹é™¤äº†<code>pc</code>ä»¥å¤–æ‰€æœ‰å¯„å­˜å™¨çš„ä¿å­˜ã€‚</p>
<p><strong>ä»ç”¨æˆ·ç©ºé—´é™·å…¥</strong></p>
<p><img src="http://xv6.dgs.zone/tranlate_books/book-riscv-rev1/images/c2/p2.png" alt="img"></p>
<p>æ€»ä½“åˆ†ä¸ºå››æ­¥è°ƒç”¨ï¼Œ<code>uservec</code>,<code>usertrap</code>,<code>usertrapret</code>å’Œ<code>userret</code>ã€‚</p>
<p><strong>uservec</strong></p>
<p><code>uservec</code>ä»£ç å¤„äº<code>kernel/trampoline.S</code>ä¸­ï¼Œä¸€çŒœå°±æ˜¯ç”¨æ±‡ç¼–å†™çš„ï¼Œå› ä¸ºæ§åˆ¶å•ä½åˆ°äº†å¯„å­˜å™¨é‡çº§ï¼Œä½†æ˜¯æ˜¯risc-væï¼Œçœ‹ä¸å¤ªæ‡‚ã€‚å¦‚ä¸Šé¢æ‰€è¯´ï¼Œkernel-modeå¾—å®Œæˆé‚£äº›æ“ä½œæ‰å¯ä»¥è¿›å…¥å¯¹trapçœŸæ­£å¤„ç†çš„å‡½æ•°ä¸Šï¼ˆ<code>usertrap</code>ï¼‰ï¼Œè€Œè¿™äº›æ“ä½œéƒ½è¢«æ”¾ç½®åœ¨<code>uservec</code>ä¸­ï¼Œå³åˆšå¼€å§‹çš„<code>stvec</code>æŒ‡å‘äº†<code>uservec</code>,ä½†æ˜¯åˆšè¿›å…¥kernel-modeçš„æ—¶å€™<code>satp</code>å¹¶æ²¡æœ‰æŒ‡å‘<code>kernel-page</code>,è€Œæ˜¯åœ¨<code>user-page</code>ä¸­ï¼Œè¦æƒ³æ‰§è¡Œ<code>uservec</code>åˆ™å¿…é¡»åœ¨ç”¨æˆ·é¡µè¡¨ä¸­ä¹Ÿæ˜ å°„ä¸Š,åœ¨<code>uservec</code>ä¸­ä¼šåˆ‡æ¢<code>satp</code>ä»¥æŒ‡å‘å†…æ ¸é¡µè¡¨ï¼Œæ‰€ä»¥ä¸ºäº†åœ¨åˆ‡æ¢åç»§ç»­æ‰§è¡ŒæŒ‡ä»¤ï¼Œ<code>uservec</code>å¿…é¡»åœ¨å†…æ ¸é¡µè¡¨å’Œç”¨æˆ·é¡µè¡¨ä¸­æ˜ å°„ç›¸åŒçš„åœ°å€ã€‚</p>
<p>ä¸ºæ­¤xv6ä¸“é—¨è®¾ç½®äº†ä¸€ä¸ªé¡µé¢æ”¾ç½®<code>uservec</code>ä»£ç ï¼Œç„¶åæŠŠè¿™ä¸ªé¡µé¢æ˜ å°„åˆ°å†…æ ¸é¡µè¡¨å’Œæ‰€æœ‰çš„ç”¨æˆ·é¡µè¡¨ä¸­ï¼Œä¸”è™šæ‹Ÿåœ°å€å…¨éƒ¨ç›¸åŒï¼Œè¿™ä¸ªè™šæ‹Ÿåœ°å€å°±æ˜¯ä¸Šå›¾çš„<code>trampoline</code>,åœ¨user-modeæ—¶stvecå°±æŒ‡å‘äº†<code>trampoline</code>å³<code>userevc</code>ã€‚</p>
<p>åˆ°è¿™é‡Œæˆ‘è§‰å¾—ååˆ†åˆç†ï¼Œå¯èƒ½x86ä¹Ÿæ˜¯è¿™æ ·å¹²çš„ï¼Œå½“<code>userevc</code>å¯åŠ¨çš„æ—¶å€™ï¼Œæ‰€æœ‰çš„32ä¸ªå¯„å­˜å™¨éƒ½ä¿å­˜ç€åŸæ¥ä¸­æ–­ä»£ç çš„å€¼ï¼Œä¸èƒ½å¤Ÿéšæ„æ›´æ”¹ï¼Œä½†<code>userevc</code>éœ€è¦èƒ½å¤Ÿä½¿ç”¨ä¸€äº›å¯„å­˜å™¨æ‰èƒ½å®Œæˆä»–çš„åŠŸèƒ½ï¼Œrisc-vçš„<code>sscratch</code>å°±å‘æŒ¥äº†ä½œç”¨ï¼Œ<code>userevc</code>å¼€å§‹çš„æ—¶å€™é€šè¿‡æŒ‡ä»¤<code>csrrw</code>äº¤æ¢äº†<code>a0</code>å’Œ<code>sscratch</code>çš„å†…å®¹ï¼Œæ­¤æ—¶<code>a0</code>å¯„å­˜å™¨çš„å€¼å°±è¢«ä¿å­˜äº†ï¼Œ<code>uservec</code>å°±å¯ä»¥ä½¿ç”¨<code>a0</code>å¯„å­˜å™¨äº†ã€‚</p>
<p>å…·ä½“è¯¥æ€ä¹ˆä¿å­˜æ‰€æœ‰çš„å¯„å­˜å™¨çš„å€¼ï¼Œå°±ç‰µæ‰¯åˆ°äº†å¦ä¸€ä¸ªæœºåˆ¶<code>é™·é˜±å¸§</code>ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œé™·é˜±å¸§å°±æ˜¯<code>trapframe</code>,è¯¥å¸§æœ‰ä¿å­˜ç”¨æˆ·æ‰€æœ‰çš„å¯„å­˜å™¨çš„ç©ºé—´ã€‚æ­¤æ—¶<code>satp</code>è¿˜æ˜¯æŒ‡å‘äº†ç”¨æˆ·é¡µè¡¨ï¼Œæ‰€ä»¥è¦ä½¿ç”¨è¿™ä¸ªé™·é˜±å¸§è¿˜å¾—æŠŠä»–æ˜ å°„åˆ°ç”¨æˆ·é¡µè¡¨ä¸­ï¼Œ<code>sscratch</code>å°±æŒ‡å‘äº†è¿™ä¸ªé™·é˜±å¸§ï¼Œæ‰§è¡Œå®Œ<code>csrrw</code>å<code>a0</code>å¯„å­˜å™¨å°±æŒ‡å‘äº†é™·é˜±å¸§ï¼Œç„¶å<code>uservec</code>å°±åˆ©ç”¨a0æŠŠæ‰€æœ‰ç”¨æˆ·å¯„å­˜å™¨ä¿å­˜åœ¨é™·é˜±å¸§ï¼Œé™·é˜±å¸§ä¸­è¿˜åŒ…å«äº†æŒ‡å‘å½“å‰è¿›ç¨‹å†…æ ¸æ ˆçš„æŒ‡é’ˆï¼Œå½“å‰cpuçš„<code>hartid</code>,<code>usertrap</code>çš„åœ°å€ä»¥åŠå†…æ ¸é¡µè¡¨çš„åœ°å€ï¼Œ<code>uservec</code>å°±å–å¾—è¿™äº›å€¼ï¼Œå°†<code>satp</code>åˆ‡æ¢åˆ°å†…æ ¸é¡µè¡¨ï¼Œå¹¶è°ƒç”¨<code>usertrap</code>ã€‚</p>
<p><strong>usertrap</strong></p>
<p>ä¸‹é¢æ˜¯xv6 usertrapä»£ç </p>
<p>ä»£ç æ¯”è¾ƒæ¸…æ™°ï¼Œé¦–å…ˆä¼šæ£€æŸ¥ä¸Šä¸€ä¸ªæ¨¡å¼æ˜¯ä»€ä¹ˆï¼Œç„¶åè®¾ç½®<code>stvec</code>,å› ä¸ºæ­¤æ—¶cpuå·²ç»å¤„äºå†…æ ¸æ€äº†ï¼Œå½“å‘ç”Ÿtrapæ—¶å¾—æ‰§è¡Œå†…æ ¸çš„<code>kernelvec</code>è€Œä¸æ˜¯<code>suervec</code>,æ‰€ä»¥ä¼šæŠŠ<code>stvec</code>æŒ‡å‘<code>kernelvec</code>,ç„¶åä¿å­˜äº†sepcåˆ°p-&gt;trapframe-&gt;sepcä¸­é˜²æ­¢è¢«è¦†ç›–ï¼Œç„¶ååˆ¤æ–­trapçš„ç±»å‹ï¼Œå¦‚æœæ˜¯ç³»ç»Ÿè°ƒç”¨<code>syscall()</code>ä¼šå¤„ç†ï¼Œå¦‚æœæ˜¯è®¾å¤‡ä¸­æ–­ï¼Œ<code>devintr</code>ä¼šå¤„ç†ä»–ï¼Œå¦åˆ™å°±æ˜¯ä¸€ä¸ªå¼‚å¸¸ï¼Œå°±è®¾ç½®<code>p-&gt;killed=1</code>,ä»£è¡¨ä¼šè¢«æ€æ­»ï¼Œæœ€åå†…æ ¸æ£€æŸ¥è¿›ç¨‹æ˜¯å¦åº”è¯¥è¢«æ€æ­»æˆ–è€…å› ä¸ºæ—¶é’Ÿä¸­æ–­è®©å‡ºcpu,æœ€åè°ƒç”¨<code>usertrapret</code>,æµç¨‹æ¯”èµ·<code>uservec</code>å¥½ç†è§£å¤šäº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">usertrap</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> which_dev = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>((r_sstatus() &amp; SSTATUS_SPP) != <span class="number">0</span>)</span><br><span class="line">    panic(<span class="string">&quot;usertrap: not from user mode&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// send interrupts and exceptions to kerneltrap(),</span></span><br><span class="line">  <span class="comment">// since we&#x27;re now in the kernel.</span></span><br><span class="line">  w_stvec((uint64)kernelvec);</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// save user program counter.</span></span><br><span class="line">  p-&gt;trapframe-&gt;epc = r_sepc();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(r_scause() == <span class="number">8</span>)&#123;</span><br><span class="line">    <span class="comment">// system call</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(p-&gt;killed)</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sepc points to the ecall instruction,</span></span><br><span class="line">    <span class="comment">// but we want to return to the next instruction.</span></span><br><span class="line">    p-&gt;trapframe-&gt;epc += <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// an interrupt will change sstatus &amp;c registers,</span></span><br><span class="line">    <span class="comment">// so don&#x27;t enable until done with those registers.</span></span><br><span class="line">    intr_on();</span><br><span class="line"></span><br><span class="line">    syscall();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>((which_dev = devintr()) != <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="comment">// ok</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;usertrap(): unexpected scause %p pid=%d\n&quot;</span>, r_scause(), p-&gt;pid);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;            sepc=%p stval=%p\n&quot;</span>, r_sepc(), r_stval());</span><br><span class="line">    p-&gt;killed = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(p-&gt;killed)</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// give up the CPU if this is a timer interrupt.</span></span><br><span class="line">  <span class="keyword">if</span>(which_dev == <span class="number">2</span>)</span><br><span class="line">    yield();</span><br><span class="line"></span><br><span class="line">  usertrapret();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>usertrapret</strong></p>
<p>é¦–å…ˆæ˜¯è·å¾—è¿›ç¨‹çš„procç»“æ„ä½“ï¼Œç„¶åæ˜¯<code>intr_off</code>è®¾ç½®äº†sstatusçš„<code>sie</code>ä½ï¼Œç„¶åæ˜¯è®¾ç½®äº†<code>stvec</code>ï¼Œå› ä¸ºè¦è¿”å›ç”¨æˆ·æ€äº†ï¼Œæ‰€ä»¥trapå¤„ç†ç¨‹åºå˜æˆäº†<code>uservec</code>,ç„¶åæ˜¯åœ¨é™·é˜±å¸§ä¸­è®°å½•å†…æ ¸é¡µè¡¨åœ°å€ï¼Œspåœ°å€ï¼Œ<code>usertrap</code>åœ°å€ï¼Œä»¥åŠ<code>hartid</code>ã€‚ç„¶åæ˜¯è®¾ç½®sstatusçš„sspä½ï¼ŒæŠŠä¸Šä¸€ä¸ªæ¨¡å¼è®¾ç½®ä¸ºuser-mode,ç„¶åæ˜¯è®¾ç½®sepcå¾—åˆ°ç”¨æˆ·æ€é¡µè¡¨åœ°å€ï¼Œç„¶ååˆè·³å›<code>trampoline</code>ä¸­æ‰§è¡Œ<code>userret</code>,è‡³äºä¸ºä»€ä¹ˆè¦æŠŠ<code>userret</code>å‡½æ•°æ”¾ç½®åœ¨<code>trampoline</code>ä¸­ï¼Œæ˜¯å› ä¸º<code>userret</code>ä¸­ä¼šåˆ‡æ¢é¡µè¡¨ã€‚è¦æƒ³åˆ‡æ¢å®Œé¡µè¡¨è¿˜èƒ½ç»§ç»­æ‰§è¡Œ<code>userret</code>åªèƒ½æŠŠä»–æ”¾åœ¨<code>trampoline</code>ä¸­ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">usertrapret</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// we&#x27;re about to switch the destination of traps from</span></span><br><span class="line">  <span class="comment">// kerneltrap() to usertrap(), so turn off interrupts until</span></span><br><span class="line">  <span class="comment">// we&#x27;re back in user space, where usertrap() is correct.</span></span><br><span class="line">  intr_off();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// send syscalls, interrupts, and exceptions to trampoline.S</span></span><br><span class="line">  w_stvec(TRAMPOLINE + (uservec - trampoline));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set up trapframe values that uservec will need when</span></span><br><span class="line">  <span class="comment">// the process next re-enters the kernel.</span></span><br><span class="line">  p-&gt;trapframe-&gt;kernel_satp = r_satp();         <span class="comment">// kernel page table</span></span><br><span class="line">  p-&gt;trapframe-&gt;kernel_sp = p-&gt;kstack + PGSIZE; <span class="comment">// process&#x27;s kernel stack</span></span><br><span class="line">  p-&gt;trapframe-&gt;kernel_trap = (uint64)usertrap;</span><br><span class="line">  p-&gt;trapframe-&gt;kernel_hartid = r_tp();         <span class="comment">// hartid for cpuid()</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// set up the registers that trampoline.S&#x27;s sret will use</span></span><br><span class="line">  <span class="comment">// to get to user space.</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// set S Previous Privilege mode to User.</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> x = r_sstatus();</span><br><span class="line">  x &amp;= ~SSTATUS_SPP; <span class="comment">// clear SPP to 0 for user mode</span></span><br><span class="line">  x |= SSTATUS_SPIE; <span class="comment">// enable interrupts in user mode</span></span><br><span class="line">  w_sstatus(x);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set S Exception Program Counter to the saved user pc.</span></span><br><span class="line">  w_sepc(p-&gt;trapframe-&gt;epc);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// tell trampoline.S the user page table to switch to.</span></span><br><span class="line">  uint64 satp = MAKE_SATP(p-&gt;pagetable);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// jump to trampoline.S at the top of memory, which </span></span><br><span class="line">  <span class="comment">// switches to the user page table, restores user registers,</span></span><br><span class="line">  <span class="comment">// and switches to user mode with sret.</span></span><br><span class="line">  uint64 fn = TRAMPOLINE + (userret - trampoline);</span><br><span class="line">  ((<span class="keyword">void</span> (*)(uint64,uint64))fn)(TRAPFRAME, satp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>userret</strong></p>
<p>a1ä¿å­˜çš„æ˜¯ç”¨æˆ·æ€é¡µè¡¨åœ°å€ï¼Œa0ä¿å­˜çš„æ˜¯<code>trampoline</code>åœ°å€ï¼Œé¦–å…ˆåˆ‡æ¢é¡µè¡¨ï¼Œç„¶åä»é™·é˜±å¸§ä¸­æ¢å¤ç”¨æˆ·å¯„å­˜å™¨ï¼Œæœ€åè°ƒç”¨<code>sret</code>å®Œæˆå¯¹ç”¨æˆ·æ€çš„åˆ‡æ¢ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">.globl userret</span><br><span class="line">userret:</span><br><span class="line">        # userret(TRAPFRAME, pagetable)</span><br><span class="line">        # switch from kernel to user.</span><br><span class="line">        # usertrapret() calls here.</span><br><span class="line">        # a0: TRAPFRAME, in user page table.</span><br><span class="line">        # a1: user page table, for satp.</span><br><span class="line"></span><br><span class="line">        # switch to the user page table.</span><br><span class="line">        csrw satp, a1</span><br><span class="line">        sfence.vma zero, zero</span><br><span class="line"></span><br><span class="line">        # put the saved user a0 in sscratch, so we</span><br><span class="line">        # can swap it with our a0 (TRAPFRAME) in the last step.</span><br><span class="line">        ld t0, 112(a0)</span><br><span class="line">        csrw sscratch, t0</span><br><span class="line"></span><br><span class="line">        # restore all but a0 from TRAPFRAME</span><br><span class="line">        ld ra, 40(a0)</span><br><span class="line">        ld sp, 48(a0)</span><br><span class="line">        ld gp, 56(a0)</span><br><span class="line">        ld tp, 64(a0)</span><br><span class="line">        ld t0, 72(a0)</span><br><span class="line">        ld t1, 80(a0)</span><br><span class="line">        ld t2, 88(a0)</span><br><span class="line">        ld s0, 96(a0)</span><br><span class="line">        ld s1, 104(a0)</span><br><span class="line">        ld a1, 120(a0)</span><br><span class="line">        ld a2, 128(a0)</span><br><span class="line">        ld a3, 136(a0)</span><br><span class="line">        ld a4, 144(a0)</span><br><span class="line">        ld a5, 152(a0)</span><br><span class="line">        ld a6, 160(a0)</span><br><span class="line">        ld a7, 168(a0)</span><br><span class="line">        ld s2, 176(a0)</span><br><span class="line">        ld s3, 184(a0)</span><br><span class="line">        ld s4, 192(a0)</span><br><span class="line">        ld s5, 200(a0)</span><br><span class="line">        ld s6, 208(a0)</span><br><span class="line">        ld s7, 216(a0)</span><br><span class="line">        ld s8, 224(a0)</span><br><span class="line">        ld s9, 232(a0)</span><br><span class="line">        ld s10, 240(a0)</span><br><span class="line">        ld s11, 248(a0)</span><br><span class="line">        ld t3, 256(a0)</span><br><span class="line">        ld t4, 264(a0)</span><br><span class="line">        ld t5, 272(a0)</span><br><span class="line">        ld t6, 280(a0)</span><br><span class="line"></span><br><span class="line">	# restore user a0, and save TRAPFRAME in sscratch</span><br><span class="line">        csrrw a0, sscratch, a0</span><br><span class="line">        </span><br><span class="line">        # return to user mode and user pc.</span><br><span class="line">        # usertrapret() set up sstatus and sepc.</span><br><span class="line">        sret</span><br></pre></td></tr></table></figure>

<p>å€ŸåŠ©ä»ç”¨æˆ·æ€çš„é™·å…¥ç»ˆäºç†æ¸…äº†xv6çš„ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„è½¬æ¢äº†ï¼Œå—ç›ŠåŒªæµ…ã€‚</p>
<p><strong>è°ƒç”¨ç³»ç»Ÿè°ƒç”¨</strong></p>
<p><code>syscall</code>ä»£ç å¦‚ä¸‹ï¼Œä»£ç ç®€ç•¥æ¸…æ™°ï¼Œå°±ä»¥<code>exec</code>è°ƒç”¨ä½ä¾‹å­ï¼Œä¸¤ä¸ªå‚æ•°åˆ†åˆ«å­˜æ”¾åœ¨a0,å’Œa1ä¸­ï¼Œç„¶åæŠŠç³»ç»Ÿè°ƒç”¨å·æ”¾åœ¨a7ä¸­ï¼Œç³»ç»Ÿè°ƒç”¨å·å°±æ˜¯<code>syscall[]</code>çš„ä¸‹æ ‡ï¼Œå¯»æ‰¾åˆ°çš„å€¼å°±æ˜¯è¯¥ç³»ç»Ÿè°ƒç”¨çš„å¤„ç†å‡½æ•°ï¼Œ<code>exec</code>ç³»ç»Ÿè°ƒç”¨æœ€åå°±ä¼šè°ƒç”¨<code>sys_exec</code>ã€‚æ­¤æ—¶ä¼šæœ‰ä¸ªç–‘é—®ï¼Œç³»ç»Ÿè°ƒç”¨éƒ½æ˜¯æœ‰å‚æ•°çš„ï¼Œä¸ºä»€ä¹ˆæœ€åçš„<code>p-&gt;trapframe-&gt;a0 = syscalls[num]();</code>æ²¡æœ‰å‘¢ï¼Œæˆ‘å¤§æ¦‚çœ‹äº†<code>sys_exec</code>çš„ä»£ç ï¼Œå‘ç°ä»–æ˜¯ç›´æ¥ä»é™·é˜±å¸§ä¸­å–å¯„å­˜å™¨å€¼çš„ï¼Œè€Œä¸æ˜¯ä¼ å‚ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">uint64</span> <span class="params">(*syscalls[])</span><span class="params">(<span class="keyword">void</span>)</span> </span>= &#123;</span><br><span class="line">[SYS_fork]    sys_fork,</span><br><span class="line">[SYS_exit]    sys_exit,</span><br><span class="line">[SYS_wait]    sys_wait,</span><br><span class="line">[SYS_pipe]    sys_pipe,</span><br><span class="line">[SYS_read]    sys_read,</span><br><span class="line">[SYS_kill]    sys_kill,</span><br><span class="line">[SYS_exec]    sys_exec,</span><br><span class="line">[SYS_fstat]   sys_fstat,</span><br><span class="line">[SYS_chdir]   sys_chdir,</span><br><span class="line">[SYS_dup]     sys_dup,</span><br><span class="line">[SYS_getpid]  sys_getpid,</span><br><span class="line">[SYS_sbrk]    sys_sbrk,</span><br><span class="line">[SYS_sleep]   sys_sleep,</span><br><span class="line">[SYS_uptime]  sys_uptime,</span><br><span class="line">[SYS_open]    sys_open,</span><br><span class="line">[SYS_write]   sys_write,</span><br><span class="line">[SYS_mknod]   sys_mknod,</span><br><span class="line">[SYS_unlink]  sys_unlink,</span><br><span class="line">[SYS_link]    sys_link,</span><br><span class="line">[SYS_mkdir]   sys_mkdir,</span><br><span class="line">[SYS_close]   sys_close,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">syscall</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> num;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line"></span><br><span class="line">  num = p-&gt;trapframe-&gt;a7;</span><br><span class="line">  <span class="keyword">if</span>(num &gt; <span class="number">0</span> &amp;&amp; num &lt; NELEM(syscalls) &amp;&amp; syscalls[num]) &#123;</span><br><span class="line">    p-&gt;trapframe-&gt;a0 = syscalls[num]();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d %s: unknown sys call %d\n&quot;</span>,</span><br><span class="line">            p-&gt;pid, p-&gt;name, num);</span><br><span class="line">    p-&gt;trapframe-&gt;a0 = <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç³»ç»Ÿè°ƒç”¨å‚æ•°</strong></p>
<p>å¥½å®¶ä¼™ï¼Œæˆ‘åˆšæœ‰è¿™ä¸ªç–‘é—®ï¼Œä¹¦çš„ä¸‹ä¸€èŠ‚å°±è§£é‡Šè¿™ä¸ªé—®é¢˜ï¼Œç‰›å•Šã€‚</p>
<p>ç³»ç»Ÿæä¾›ä¸‰ä¸ªå‡½æ•°artint,artaddr,artfdä»é™·é˜±å¸§ä¸­æ£€ç´¢ç¬¬<code>n</code>ä¸ªç³»ç»Ÿè°ƒç”¨å‚æ•°å¹¶ä¸”ä»¥æ•´æ•°ï¼ŒæŒ‡é’ˆï¼Œæˆ–è€…æ–‡ä»¶æè¿°ç¬¦çš„å½¢å¼ä¿å­˜ï¼Œä»–ä»¬éƒ½è°ƒç”¨<code>argraw</code>æ¥æ£€ç´¢ç›¸åº”çš„ä¿å­˜çš„ç”¨æˆ·å¯„å­˜å™¨ã€‚æ¯”å¦‚<code>argstr</code>å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">argstr(<span class="keyword">int</span> n, <span class="keyword">char</span> *buf, <span class="keyword">int</span> max)</span><br><span class="line">&#123;</span><br><span class="line">  uint64 addr;</span><br><span class="line">  <span class="keyword">if</span>(argaddr(n, &amp;addr) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">return</span> fetchstr(addr, buf, max);</span><br><span class="line">&#125;</span><br><span class="line">argaddr(<span class="keyword">int</span> n, uint64 *ip)</span><br><span class="line">&#123;</span><br><span class="line">  *ip = argraw(n);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†…æ ¸è¦æƒ³è·å¾—ä¸€ä¸ªæ•´æ•°è¿˜è¡Œï¼Œä½†æ˜¯è¦æƒ³è·å¾—ç”¨æˆ·æ€çš„æŸä¸€ä¸ªå­—ç¬¦ä¸²æˆ–è€…æŸä¸€æ®µå†…å­˜çš„å€¼å°±ä¸å¥½åŠäº†ï¼Œå› ä¸ºæ­¤æ—¶å¤„äºå†…æ ¸æ€ï¼Œé¡µè¡¨æ˜¯å†…æ ¸é¡µè¡¨ï¼Œå¹¶ä¸èƒ½è®¿é—®ç”¨æˆ·æ€çš„å†…å­˜ï¼Œå¯ä»¥çœ‹çœ‹xv6æ˜¯å¦‚ä½•å®Œæˆçš„ã€‚</p>
<p><code>copyinstr</code>å‡½æ•°å°±æ˜¯å®Œæˆåœ¨å†…æ ¸æ€ä»ç”¨æˆ·æ€åˆ°å†…æ ¸æ€æ‹·è´æ•°æ®çš„å‡½æ•°ï¼Œä¼ å…¥çš„å‚æ•°æœ‰è¿›ç¨‹çš„é™·é˜±å¸§ï¼Œå†…æ ¸æ¥æ”¶åœ°å€dstå’Œç”¨æˆ·æ€åœ°å€srcvaä»¥åŠæ‹·è´é‡maxã€‚æˆ‘ç®€è¿°ä¸€ä¸‹åŸç†ï¼Œå°±æ˜¯åˆ©ç”¨ä¼ è¿›æ¥çš„ç”¨æˆ·æ€è™šæ‹Ÿåœ°å€srcvaå’Œè¿›ç¨‹çš„é™·é˜±å¸§å®Œæˆå¯¹è¿™ä¸ªè™šæ‹Ÿåœ°å€æ‰€æ˜ å°„çš„ç‰©ç†åœ°å€<code>pa0</code>çš„æŸ¥è¯¢ï¼ŒæŸ¥è¯¢è¿‡ç¨‹å°±æ˜¯åˆ©ç”¨é™·é˜±å¸§è®°å½•çš„ç”¨æˆ·æ€é¡µè¡¨ï¼Œç„¶åé€šè¿‡è¿™ä¸ªè™šæ‹Ÿåœ°å€æ‰¾åˆ°å¯¹åº”ç‰©ç†åœ°å€è¿”å›ï¼Œåœ¨å†…æ ¸æ€ä¸­ï¼Œç”±äºå†…æ ¸å°†æ‰€æœ‰ç‰©ç†RAMåœ°å€æ˜ å°„åˆ°åŒä¸€ä¸ªå†…æ ¸è™šæ‹Ÿåœ°å€ï¼Œ<code>copyinstr</code>å¯ä»¥ç›´æ¥å°†å­—ç¬¦ä¸²å­—èŠ‚ä»<code>pa0</code>å¤åˆ¶åˆ°<code>dst</code>ï¼ˆè¿™æ®µå…¶å®ä¸æ˜¯å¾ˆç†è§£ï¼Œæˆ‘ä¸ç¡®å®šè¿™ä¸ªpa0åˆ°åº•æ˜¯ä¸æ˜¯ç‰©ç†åœ°å€ï¼Œå¦‚æœæ˜¯çš„è¯<code>copyinstr</code>ç›´æ¥ä½¿ç”¨ç‰©ç†åœ°å€è¿›è¡Œcopy<code>*dst = *p</code>,é‚£å”¯ä¸€çš„è§£é‡Šå°±æ˜¯æ˜ å°„æ˜¯ç›´æ¥æ˜ å°„ï¼Œå³è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€æ˜¯ä¸€ä¸€å¯¹åº”çš„æ‰å¯ä»¥ï¼‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">copyinstr(<span class="keyword">pagetable_t</span> pagetable, <span class="keyword">char</span> *dst, uint64 srcva, uint64 max)</span><br><span class="line">&#123;</span><br><span class="line">  uint64 n, va0, pa0;</span><br><span class="line">  <span class="keyword">int</span> got_null = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span>(got_null == <span class="number">0</span> &amp;&amp; max &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    va0 = PGROUNDDOWN(srcva);</span><br><span class="line">    pa0 = walkaddr(pagetable, va0);</span><br><span class="line">    <span class="keyword">if</span>(pa0 == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    n = PGSIZE - (srcva - va0);</span><br><span class="line">    <span class="keyword">if</span>(n &gt; max)</span><br><span class="line">      n = max;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *p = (<span class="keyword">char</span> *) (pa0 + (srcva - va0));</span><br><span class="line">    <span class="keyword">while</span>(n &gt; <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="keyword">if</span>(*p == <span class="string">&#x27;\0&#x27;</span>)&#123;</span><br><span class="line">        *dst = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        got_null = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        *dst = *p;</span><br><span class="line">      &#125;</span><br><span class="line">      --n;</span><br><span class="line">      --max;</span><br><span class="line">      p++;</span><br><span class="line">      dst++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    srcva = va0 + PGSIZE;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(got_null)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡åœ¨qemuä¸‹æ‰“å°é¡µè¡¨å‘ç°ä¼¼ä¹å°±æ˜¯è¿™æ ·çš„,æ˜ å°„äº†ä¸ªå¯‚å¯ğŸ¤¦â€â™€ï¸ï¼Œåœ¨linuxç³»ç»Ÿä¸­å†…æ ¸å¥½æ­¹æ˜¯çº¿æ€§æ˜ å°„æ‰€æœ‰ç‰©ç†åŒºåŸŸï¼Œxv6ç›´æ¥ä¸€å¯¹ä¸€äº†ã€‚</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">vaddr            paddr            size             attr</span><br><span class="line">---------------- ---------------- ---------------- -------</span><br><span class="line">0000000002000000 0000000002000000 0000000000010000 rw-----</span><br><span class="line">000000000c000000 000000000c000000 0000000000001000 rw---ad</span><br><span class="line">000000000c001000 000000000c001000 0000000000001000 rw-----</span><br><span class="line">000000000c002000 000000000c002000 0000000000001000 rw---ad</span><br><span class="line">000000000c003000 000000000c003000 00000000001fe000 rw-----</span><br><span class="line">000000000c201000 000000000c201000 0000000000001000 rw---ad</span><br><span class="line">000000000c202000 000000000c202000 0000000000001000 rw-----</span><br><span class="line">000000000c203000 000000000c203000 0000000000001000 rw---ad</span><br><span class="line">000000000c204000 000000000c204000 0000000000001000 rw-----</span><br><span class="line">000000000c205000 000000000c205000 0000000000001000 rw---ad</span><br><span class="line">000000000c206000 000000000c206000 00000000001fa000 rw-----</span><br><span class="line">0000000010000000 0000000010000000 0000000000002000 rw---ad</span><br><span class="line">0000000080000000 0000000080000000 0000000000007000 r-x--a-</span><br><span class="line">0000000080007000 0000000080007000 0000000000001000 r-x----</span><br><span class="line">0000000080008000 0000000080008000 0000000000005000 rw---ad</span><br><span class="line">000000008000d000 000000008000d000 0000000000004000 rw-----</span><br><span class="line">0000000080011000 0000000080011000 0000000000011000 rw---ad</span><br><span class="line">0000000080022000 0000000080022000 0000000000001000 rw-----</span><br><span class="line">0000000080023000 0000000080023000 0000000000003000 rw---ad</span><br><span class="line">0000000080026000 0000000080026000 0000000007f35000 rw-----</span><br><span class="line">0000000087f5b000 0000000087f5b000 000000000005d000 rw---ad</span><br><span class="line">0000000087fb8000 0000000087fb8000 0000000000001000 rw---a-</span><br><span class="line">0000000087fb9000 0000000087fb9000 0000000000046000 rw-----</span><br><span class="line">0000000087fff000 0000000087fff000 0000000000001000 rw---a-</span><br><span class="line">0000003ffff7f000 0000000087f77000 000000000003e000 rw-----</span><br><span class="line">0000003fffffb000 0000000087fb5000 0000000000002000 rw---ad</span><br><span class="line">0000003ffffff000 0000000080007000 0000000000001000 r-x--a-</span><br></pre></td></tr></table></figure>

<h5 id="ä»å†…æ ¸æ€é™·å…¥"><a href="#ä»å†…æ ¸æ€é™·å…¥" class="headerlink" title="ä»å†…æ ¸æ€é™·å…¥"></a>ä»å†…æ ¸æ€é™·å…¥</h5><p>ä¹¦ä¸­æ¶‰åŠåˆ°äº†è®¡æ•°å™¨ä¸­æ–­çš„å¤„ç†åŠæ³•ï¼Œç”±äºæˆ‘ä¸æ˜¯å¾ˆç†Ÿæ‚‰è®¡æ•°å™¨ä¸­æ–­ï¼Œæ‰€ä»¥æš‚ä¸”ä¸è®¨è®ºè¿™ç§æƒ…å†µï¼Œåœ¨ç¬¬ä¸ƒç« ä¸­ä¼šç³»ç»Ÿçš„å­¦åˆ°ã€‚æˆ‘åªè®¨è®ºä¸€èˆ¬æƒ…å†µä¸‹çš„å†…æ ¸é™·å…¥ã€‚</p>
<p>å†…æ ¸å‘ç”Ÿé™·å…¥çš„è¯åªæœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€æ˜¯è®¾å¤‡ä¸­æ–­ï¼ŒäºŒæ˜¯å†…æ ¸å¼‚å¸¸ï¼Œæ­¤æ—¶æ˜¯å¤„äºå†…æ ¸æ€çš„ï¼Œ<code>stvec</code>å°±æŒ‡å‘äº†<code>kernelvec</code>,ç„¶åå¤„ç†trapä¹Ÿæ˜¯åœ¨å†…æ ¸æ€ï¼Œæ‰€ä»¥ä¸éœ€è¦åˆ‡æ¢é¡µè¡¨äº†ã€‚å¤„ç†æµç¨‹ä¸»è¦æ˜¯ä¸¤ä¸ªå‡½æ•°ï¼š<code>kernelvec</code>-&gt;<code>kerneltrap</code>-&gt;<code>kernelvec</code></p>
<p><strong>kernelvec</strong></p>
<p>æ„æ–™ä¹‹ä¸­åˆæ˜¯risc-væ±‡ç¼–æï¼Œä½†æ˜¯å¤§æ¦‚æ˜¯èƒ½çœ‹æ‡‚çš„ï¼Œkernelvecé¦–å…ˆå¾—æŠŠæ‰€æœ‰çš„å¯„å­˜å™¨å­˜æ”¾åˆ°å½“å‰å†…æ ¸æ ˆçš„æ ˆä¸Šï¼Œæ‰€ä»¥é¦–å…ˆ<code>addi sp.sp,-256</code>å°±æ˜¯<code>sp=sp+(-256)</code>ï¼Œå…ˆæå‡æ ˆçš„å®¹é‡ã€‚ç„¶åæŠŠå¯„å­˜å™¨æ”¾åœ¨è¿™256å®¹é‡çš„æ ˆé‡Œï¼Œ<code>sd ra,0(sp)</code>ç­‰äº<code>*[sp+0]=ra</code>è¿™æ ·çš„å½¢å¼å­˜å‚¨ï¼Œè‡³äºä¸ºä»€ä¹ˆè¦å­˜å‚¨æ‰€æœ‰çš„å¯„å­˜å™¨ï¼Œæ˜¯å› ä¸ºåœ¨è°ƒç”¨<code>kerneltrap</code>çš„æ—¶å€™ï¼Œä¼šå› ä¸ºæ—¶é’Ÿä¸­æ–­è€Œè®©å‡ºcpuå¯¼è‡´ä¸¢å¤±å¯„å­˜å™¨ä¿¡æ¯ï¼Œæ‰€ä»¥å¾—è®°å½•ä¸€ä¸‹ï¼Œè®°å½•å®Œå°±æ˜¯è°ƒç”¨<code>kerneltrap</code>äº†ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">        # interrupts and exceptions while in supervisor</span><br><span class="line">        # mode come here.</span><br><span class="line">        #</span><br><span class="line">        # push all registers, call kerneltrap(), restore, return.</span><br><span class="line">        #</span><br><span class="line">.globl kerneltrap</span><br><span class="line">.globl kernelvec</span><br><span class="line">.align 4</span><br><span class="line">kernelvec:</span><br><span class="line">        // make room to save registers.</span><br><span class="line">        addi sp, sp, -256</span><br><span class="line"></span><br><span class="line">        // save the registers.</span><br><span class="line">        sd ra, 0(sp)</span><br><span class="line">        sd sp, 8(sp)</span><br><span class="line">        sd gp, 16(sp)</span><br><span class="line">        sd tp, 24(sp)</span><br><span class="line">        sd t0, 32(sp)</span><br><span class="line">        sd t1, 40(sp)</span><br><span class="line">        sd t2, 48(sp)</span><br><span class="line">        sd s0, 56(sp)</span><br><span class="line">        sd s1, 64(sp)</span><br><span class="line">        sd a0, 72(sp)</span><br><span class="line">        sd a1, 80(sp)</span><br><span class="line">        sd a2, 88(sp)</span><br><span class="line">        sd a3, 96(sp)</span><br><span class="line">        sd a4, 104(sp)</span><br><span class="line">        sd a5, 112(sp)</span><br><span class="line">        sd a6, 120(sp)</span><br><span class="line">        sd a7, 128(sp)</span><br><span class="line">        sd s2, 136(sp)</span><br><span class="line">        sd s3, 144(sp)</span><br><span class="line">        sd s4, 152(sp)</span><br><span class="line">        sd s5, 160(sp)</span><br><span class="line">        sd s6, 168(sp)</span><br><span class="line">        sd s7, 176(sp)</span><br><span class="line">        sd s8, 184(sp)</span><br><span class="line">        sd s9, 192(sp)</span><br><span class="line">        sd s10, 200(sp)</span><br><span class="line">        sd s11, 208(sp)</span><br><span class="line">        sd t3, 216(sp)</span><br><span class="line">        sd t4, 224(sp)</span><br><span class="line">        sd t5, 232(sp)</span><br><span class="line">        sd t6, 240(sp)</span><br><span class="line"></span><br><span class="line">	// call the C trap handler in trap.c</span><br><span class="line">        call kerneltrap</span><br><span class="line"></span><br><span class="line">        // restore registers.</span><br><span class="line">        ld ra, 0(sp)</span><br><span class="line">        ld sp, 8(sp)</span><br><span class="line">        ld gp, 16(sp)</span><br><span class="line">        // not this, in case we moved CPUs: ld tp, 24(sp)</span><br><span class="line">        ld t0, 32(sp)</span><br><span class="line">        ld t1, 40(sp)</span><br><span class="line">        ld t2, 48(sp)</span><br><span class="line">        ld s0, 56(sp)</span><br><span class="line">        ld s1, 64(sp)</span><br><span class="line">        ld a0, 72(sp)</span><br><span class="line">        ld a1, 80(sp)</span><br><span class="line">        ld a2, 88(sp)</span><br><span class="line">        ld a3, 96(sp)</span><br><span class="line">        ld a4, 104(sp)</span><br><span class="line">        ld a5, 112(sp)</span><br><span class="line">        ld a6, 120(sp)</span><br><span class="line">        ld a7, 128(sp)</span><br><span class="line">        ld s2, 136(sp)</span><br><span class="line">        ld s3, 144(sp)</span><br><span class="line">        ld s4, 152(sp)</span><br><span class="line">        ld s5, 160(sp)</span><br><span class="line">        ld s6, 168(sp)</span><br><span class="line">        ld s7, 176(sp)</span><br><span class="line">        ld s8, 184(sp)</span><br><span class="line">        ld s9, 192(sp)</span><br><span class="line">        ld s10, 200(sp)</span><br><span class="line">        ld s11, 208(sp)</span><br><span class="line">        ld t3, 216(sp)</span><br><span class="line">        ld t4, 224(sp)</span><br><span class="line">        ld t5, 232(sp)</span><br><span class="line">        ld t6, 240(sp)</span><br><span class="line"></span><br><span class="line">        addi sp, sp, 256</span><br><span class="line"></span><br><span class="line">        // return to whatever we were doing in the kernel.</span><br><span class="line">        sret</span><br></pre></td></tr></table></figure>

<p><strong>kerneltrap</strong></p>
<p>é¦–å…ˆæ˜¯å‚¨å­˜<code>sepc</code>å’Œ<code>sstatus</code>ä¸¤ä¸ªå¯„å­˜å™¨ï¼Œå› ä¸ºå¦‚æœæœ‰æ—¶é’Ÿä¸­æ–­è€Œè°ƒç”¨<code>yield()</code>å‡½æ•°çš„æ—¶å€™ä¼šç ´åä»–ä»¬ï¼Œè¦ä½¿ç ´åäº†ä»–ä»¬trapè¿”å›çš„æ—¶å€™å°±ä¼šå‡ºé—®é¢˜ï¼Œä¿å­˜å®ŒåçœŸæ­£å¤„ç†trapï¼Œå¤„ç†å®Œä¹‹åæ¢å¤<code>sepc</code>å’Œ<code>sstatus</code>ï¼Œç„¶åè¿”å›åˆ°å‡½æ•°<code>kernelvec</code>ä¸­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> </span></span><br><span class="line"><span class="function"><span class="title">kerneltrap</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> which_dev = <span class="number">0</span>;</span><br><span class="line">  uint64 sepc = r_sepc();</span><br><span class="line">  uint64 sstatus = r_sstatus();</span><br><span class="line">  uint64 scause = r_scause();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>((sstatus &amp; SSTATUS_SPP) == <span class="number">0</span>)</span><br><span class="line">    panic(<span class="string">&quot;kerneltrap: not from supervisor mode&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(intr_get() != <span class="number">0</span>)</span><br><span class="line">    panic(<span class="string">&quot;kerneltrap: interrupts enabled&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>((which_dev = devintr()) == <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;scause %p\n&quot;</span>, scause);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;sepc=%p stval=%p\n&quot;</span>, r_sepc(), r_stval());</span><br><span class="line">    panic(<span class="string">&quot;kerneltrap&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// give up the CPU if this is a timer interrupt.</span></span><br><span class="line">  <span class="keyword">if</span>(which_dev == <span class="number">2</span> &amp;&amp; myproc() != <span class="number">0</span> &amp;&amp; myproc()-&gt;state == RUNNING)</span><br><span class="line">    yield();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// the yield() may have caused some traps to occur,</span></span><br><span class="line">  <span class="comment">// so restore trap registers for use by kernelvec.S&#x27;s sepc instruction.</span></span><br><span class="line">  w_sepc(sepc);</span><br><span class="line">  w_sstatus(sstatus);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿”å›åˆ°kernelvecä¸­å°±ä¼šç®€å•äº†ï¼Œå°±åˆ©ç”¨æ ˆä¿¡æ¯æ¢å¤é€šç”¨å¯„å­˜å™¨ï¼Œç„¶å<code>addi sp, sp, 256</code>å<code>sret</code>ç»“æŸå†…æ ¸é™·å…¥ã€‚</p>
<p>æ€»è€Œè¨€ä¹‹æ¯”ç”¨æˆ·æ€é™·å…¥è¦ç®€å•å¾ˆå¤šäº†ã€‚</p>
<h5 id="é¡µé¢é”™è¯¯å¼‚å¸¸"><a href="#é¡µé¢é”™è¯¯å¼‚å¸¸" class="headerlink" title="é¡µé¢é”™è¯¯å¼‚å¸¸"></a>é¡µé¢é”™è¯¯å¼‚å¸¸</h5><p>è¿™ä¸ªæš‚æ—¶ä¸çœ‹ï¼Œæ¶‰åŠåˆ°äº†ç¬¬ä¸‰ç« çš„çŸ¥è¯†ï¼Œæš‚æ—¶è¿˜æ²¡æœ‰å­¦ä¹ åˆ°ã€‚</p>
<h4 id="System-call-tracing"><a href="#System-call-tracing" class="headerlink" title="System call tracing"></a>System call tracing</h4><p>å°±æ˜¯å¢åŠ ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨è¿½è¸ªçš„åŠŸèƒ½ï¼Œå¯ä»¥å…ˆåˆ©ç”¨è¿™ä¸ªç³»ç»Ÿè°ƒç”¨è®¾ç½®è‡ªå·±æƒ³è¦è¿½è¸ªçš„ç³»ç»Ÿè°ƒç”¨ï¼Œç„¶åè¿™ä¸ªç¨‹åºä»¥åŠå­ç¨‹åºåœ¨è°ƒç”¨è¿™ä¸ªç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™éƒ½ä¼šæ‰“å°ç›¸åº”æ•°æ®ã€‚</p>
<p>ç¼–ç¨‹ä¸æ˜¯éš¾ç‚¹ï¼Œéš¾ç‚¹å¯èƒ½æ˜¯ç†æ¸…æ¥šç³»ç»Ÿè°ƒç”¨çš„åŸç†ä»¥åŠå¯¹åº”çš„å‡ ä¸ªcæ–‡ä»¶å°±å¥½äº†ï¼Œåªè¦é˜…è¯»è¿‡ä¹¦ç±çš„ç¬¬å››ç« é—®é¢˜å°±ä¸å¤§çš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">trace_printf_sysname</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>=</span>myproc();</span><br><span class="line">  <span class="keyword">int</span> mask=p-&gt;trace_num;</span><br><span class="line">  <span class="keyword">int</span> sys_num=p-&gt;trapframe-&gt;a7;</span><br><span class="line">  <span class="keyword">if</span>(mask&amp;(<span class="number">1</span>&lt;&lt;sys_num))&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d: syscall %s -&gt; %d\n&quot;</span>,p-&gt;pid,syscall_name[sys_num],p-&gt;trapframe-&gt;a0);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">uint64</span></span><br><span class="line"><span class="function"><span class="title">sys_trace</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> mask;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line">  <span class="keyword">if</span>(argint(<span class="number">0</span>,&amp;mask)&lt;<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  p-&gt;trace_num=mask;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Sysinfo"><a href="#Sysinfo" class="headerlink" title="Sysinfo"></a>Sysinfo</h4><p>è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ä¸ªå°±æ¯”è¾ƒéº»çƒ¦äº†ï¼Œé¦–å…ˆå¾—æŠŠç»“æ„ä½“ä»<code>struct sysinfo</code>ä»å†…æ ¸æ€æ‹·è´å›ç”¨æˆ·ç©ºé—´ï¼Œç„¶åå¾—åœ¨å†…æ ¸è·å¾—ç©ºé—²å†…å­˜é‡ï¼Œç„¶åè¿˜å¾—è·å¾—<code>stat</code>ä¸ä¸º<code>UNUSED</code>çš„è¿›ç¨‹æ•°ã€‚éƒ½æ²¡æ€ä¹ˆå¬è¿‡ï¼Œå¾—é˜…è¯»æºç æ…¢æ…¢ææ¸…æ¥šã€‚</p>
<p>ä»å†…æ ¸æ€æ‹·è´æ•°æ®ä½¿ç”¨çš„æ˜¯<code>copyout</code>å‡½æ•°,ä¹‹å‰åˆ†æè¿‡<code>copyin</code>å‡½æ•°ï¼ŒåŸç†éƒ½æ˜¯å·®ä¸å¤šçš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">copyout</span><span class="params">(<span class="keyword">pagetable_t</span> pagetable, uint64 dstva, <span class="keyword">char</span> *src, uint64 len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  uint64 n, va0, pa0;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span>(len &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    va0 = PGROUNDDOWN(dstva);</span><br><span class="line">    pa0 = walkaddr(pagetable, va0);</span><br><span class="line">    <span class="keyword">if</span>(pa0 == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    n = PGSIZE - (dstva - va0);</span><br><span class="line">    <span class="keyword">if</span>(n &gt; len)</span><br><span class="line">      n = len;</span><br><span class="line">    memmove((<span class="keyword">void</span> *)(pa0 + (dstva - va0)), src, n);</span><br><span class="line"></span><br><span class="line">    len -= n;</span><br><span class="line">    src += n;</span><br><span class="line">    dstva = va0 + PGSIZE;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è·å¾—å†…å­˜ç©ºé—²å­—èŠ‚è¯¾ä»¥é€šè¿‡é˜…è¯»<code>kmalloc.c</code>æºç å¾ˆå¥½çš„è§£å†³,åœ¨xv6ç³»ç»Ÿä¸­å®šä¹‰äº†ä¸¤ä¸ªç»“æ„ä½“æ¥ç®¡ç†ç©ºé—²é¡µé¢å…¶ä¸­é€šè¿‡<code>struct run</code>ç»„æˆä¸€ä¸ªå•å‘é“¾è¡¨æ¥é“¾æ¥æ‰€æœ‰çš„ç©ºé—²é“¾è¡¨ï¼Œç„¶åé€šè¿‡<code>struct kmem.freelist</code>æŒ‡å‘è¿™ä¸ªé“¾è¡¨çš„å¤´ç»“ç‚¹ï¼Œæ‰€ä»¥åªéœ€è¦éå†è¿™ä¸ªé“¾è¡¨å°±å¯ä»¥æ‰€æœ‰ç©ºé—²é¡µé¢äº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">run</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">lock</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">freelist</span>;</span></span><br><span class="line">&#125; kmem;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>struct proc</code>ä¸­æœ‰ä¸€ä¸ªå­—æ®µ<code>struct proc *parent</code>å¯ä»¥é€šè¿‡éå†è¿™ä¸ªå­—æ®µå®Œæˆå¯¹è¿›ç¨‹æ•°çš„ç»Ÿè®¡ï¼Œè¿™ç§ç»Ÿè®¡æ–¹å¼è‚¯å®šæœ‰é—®é¢˜ï¼Œå› ä¸ºä¸€ä¸ªè¿›ç¨‹å¯ä»¥æœ‰å¤šä¸ªå­è¿›ç¨‹ï¼Œè¿™ä¸ªåŠæ³•æ¯ä¸€å±‚è¿›ç¨‹åªèƒ½éå†ä¸€ä¸ªï¼Œä¸å…¶è¯´ç»Ÿè®¡æœ‰å¤šå°‘ä¸ªè¿›ç¨‹ï¼Œä¸å¦‚è¯´ç»Ÿè®¡æœ‰å¤šå°‘å±‚è¿›ç¨‹ï¼Œå½“ç„¶è¿™ä¹Ÿæ˜¯<code>struct proc</code>çš„è®¾è®¡é—®é¢˜ï¼Œåªèƒ½è¿™æ ·å¹²ã€‚</p>
<p>ä»£ç å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">uint64</span></span><br><span class="line"><span class="function"><span class="title">sys_sysinfo</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>=</span>myproc();</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sysinfo</span> <span class="title">info</span>;</span></span><br><span class="line">  uint64 user_info;</span><br><span class="line">  <span class="keyword">if</span>(argaddr(<span class="number">0</span>,&amp;user_info)&lt;<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;sysinfo addr get fail\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  info.freemem=countfree();</span><br><span class="line">  info.nproc=get_proc_num();</span><br><span class="line">  <span class="keyword">if</span>(copyout(p-&gt;pagetable,user_info,(<span class="keyword">char</span> *)&amp;info,<span class="keyword">sizeof</span>(info))&lt;<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> </span></span><br><span class="line"><span class="function"><span class="title">countfree</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> n=<span class="number">0</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">r</span>;</span></span><br><span class="line">  r=kmem.freelist;</span><br><span class="line">  <span class="keyword">while</span>(r)&#123;</span><br><span class="line">    <span class="comment">// printf(&quot;page_addr:%p\n&quot;,r);</span></span><br><span class="line">    n=n+<span class="number">4096</span>;</span><br><span class="line">    r=r-&gt;next;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_proc_num</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>=</span>myproc();</span><br><span class="line">  <span class="keyword">int</span> num=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span>(p-&gt;parent)&#123;</span><br><span class="line">    <span class="keyword">if</span>(p-&gt;state!=UNUSED)&#123;</span><br><span class="line">      num++;</span><br><span class="line">    &#125;</span><br><span class="line">    p=p-&gt;parent;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> num;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å¾—åˆ†"><a href="#å¾—åˆ†" class="headerlink" title="å¾—åˆ†"></a>å¾—åˆ†</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Score: 35/35</span><br></pre></td></tr></table></figure>

<h4 id="ç»“è¯­-1"><a href="#ç»“è¯­-1" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h4><p>å¯¹ç³»ç»Ÿè°ƒç”¨ç†è§£çš„æ›´æ·±äº†å§ï¼Œä¹‹å‰åªçŸ¥é“å¤§æ¦‚æ€æƒ³ï¼Œç°åœ¨ä¹ŸçŸ¥é“äº†å¦‚ä½•å®ç°çš„ï¼Œä¹Ÿå¯¹xv6çš„ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢æ›´åŠ ç†Ÿæ‚‰ï¼Œä¹Ÿæ›´åŠ äº†è§£äº†xv6çš„æºä»£ç ã€‚</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/07/26/kernelpwn-%E5%86%8D%E5%85%A5%E9%97%A8/" rel="prev" title="kernelpwn å†å…¥é—¨">
      <i class="fa fa-chevron-left"></i> kernelpwn å†å…¥é—¨
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/08/12/%E8%93%9D%E5%B8%BD%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B-Smurfs%E5%A4%8D%E7%8E%B0/" rel="next" title="è“å¸½æ¯åŠå†³èµ› Smurfså¤ç°">
      è“å¸½æ¯åŠå†³èµ› Smurfså¤ç° <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%86%E5%A4%87"><span class="nav-number">2.</span> <span class="nav-text">å‡†å¤‡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#git"><span class="nav-number">2.1.</span> <span class="nav-text">git</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RSIC-V%E6%8C%87%E4%BB%A4%E9%9B%86"><span class="nav-number">2.2.</span> <span class="nav-text">RSIC-VæŒ‡ä»¤é›†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="nav-number">2.3.</span> <span class="nav-text">ç¯å¢ƒå‡†å¤‡</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lecture"><span class="nav-number">3.</span> <span class="nav-text">Lecture</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Lecture1"><span class="nav-number">3.0.1.</span> <span class="nav-text">Lecture1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Lecture3"><span class="nav-number">3.0.2.</span> <span class="nav-text">Lecture3</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#lab"><span class="nav-number">4.</span> <span class="nav-text">lab</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Lab1-Xv6-and-Unix-utilities"><span class="nav-number">4.1.</span> <span class="nav-text">Lab1: Xv6 and Unix utilities</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#sleep"><span class="nav-number">4.1.1.</span> <span class="nav-text">sleep</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pingpong"><span class="nav-number">4.1.2.</span> <span class="nav-text">pingpong</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#primes"><span class="nav-number">4.1.3.</span> <span class="nav-text">primes</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#find"><span class="nav-number">4.1.4.</span> <span class="nav-text">find</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#xargs"><span class="nav-number">4.1.5.</span> <span class="nav-text">xargs</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%80%E5%90%8Elab%E5%BE%97%E5%88%86"><span class="nav-number">4.1.6.</span> <span class="nav-text">æœ€ålabå¾—åˆ†</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%93%E8%AF%AD"><span class="nav-number">4.1.7.</span> <span class="nav-text">ç»“è¯­</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Lab2-system-calls"><span class="nav-number">4.2.</span> <span class="nav-text">Lab2: system calls</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#book-read"><span class="nav-number">4.2.1.</span> <span class="nav-text">book-read</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BB%8E%E5%86%85%E6%A0%B8%E6%80%81%E9%99%B7%E5%85%A5"><span class="nav-number">4.2.1.1.</span> <span class="nav-text">ä»å†…æ ¸æ€é™·å…¥</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%A1%B5%E9%9D%A2%E9%94%99%E8%AF%AF%E5%BC%82%E5%B8%B8"><span class="nav-number">4.2.1.2.</span> <span class="nav-text">é¡µé¢é”™è¯¯å¼‚å¸¸</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#System-call-tracing"><span class="nav-number">4.2.2.</span> <span class="nav-text">System call tracing</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Sysinfo"><span class="nav-number">4.2.3.</span> <span class="nav-text">Sysinfo</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BE%97%E5%88%86"><span class="nav-number">4.2.4.</span> <span class="nav-text">å¾—åˆ†</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%93%E8%AF%AD-1"><span class="nav-number">4.2.5.</span> <span class="nav-text">ç»“è¯­</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">rootzhang</p>
  <div class="site-description" itemprop="description">æˆ‘çš„åšå®¢</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">37</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rootzhang</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
